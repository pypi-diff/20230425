# Comparing `tmp/ops-2.1.1.tar.gz` & `tmp/ops-2.2.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ops-2.1.1.tar", last modified: Wed Mar  1 02:19:01 2023, max compression
+gzip compressed data, was "ops-2.2.0.tar", last modified: Mon Mar 27 23:39:09 2023, max compression
```

## Comparing `ops-2.1.1.tar` & `ops-2.2.0.tar`

### file list

```diff
@@ -1,46 +1,46 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-01 02:19:01.807894 ops-2.1.1/
--rw-r--r--   0 runner    (1001) docker     (123)    11358 2023-03-01 02:18:59.000000 ops-2.1.1/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)     6977 2023-03-01 02:19:01.807894 ops-2.1.1/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     6283 2023-03-01 02:18:59.000000 ops-2.1.1/README.md
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-01 02:19:01.799894 ops-2.1.1/ops/
--rw-r--r--   0 runner    (1001) docker     (123)     2169 2023-03-01 02:18:59.000000 ops-2.1.1/ops/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-01 02:19:01.803894 ops-2.1.1/ops/_private/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-03-01 02:18:59.000000 ops-2.1.1/ops/_private/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1978 2023-03-01 02:18:59.000000 ops-2.1.1/ops/_private/timeconv.py
--rw-r--r--   0 runner    (1001) docker     (123)     1224 2023-03-01 02:18:59.000000 ops-2.1.1/ops/_private/yaml.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    54095 2023-03-01 02:18:59.000000 ops-2.1.1/ops/charm.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    53402 2023-03-01 02:18:59.000000 ops-2.1.1/ops/framework.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     4775 2023-03-01 02:18:59.000000 ops-2.1.1/ops/jujuversion.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-01 02:19:01.803894 ops-2.1.1/ops/lib/
--rw-r--r--   0 runner    (1001) docker     (123)     9839 2023-03-01 02:18:59.000000 ops-2.1.1/ops/lib/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2525 2023-03-01 02:18:59.000000 ops-2.1.1/ops/log.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    17198 2023-03-01 02:18:59.000000 ops-2.1.1/ops/main.py
--rw-r--r--   0 runner    (1001) docker     (123)   124827 2023-03-01 02:18:59.000000 ops-2.1.1/ops/model.py
--rw-r--r--   0 runner    (1001) docker     (123)    97841 2023-03-01 02:18:59.000000 ops-2.1.1/ops/pebble.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-03-01 02:18:59.000000 ops-2.1.1/ops/py.typed
--rwxr-xr-x   0 runner    (1001) docker     (123)    15197 2023-03-01 02:18:59.000000 ops-2.1.1/ops/storage.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   123645 2023-03-01 02:18:59.000000 ops-2.1.1/ops/testing.py
--rw-r--r--   0 runner    (1001) docker     (123)       46 2023-03-01 02:19:01.000000 ops-2.1.1/ops/version.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-01 02:19:01.803894 ops-2.1.1/ops.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     6977 2023-03-01 02:19:01.000000 ops-2.1.1/ops.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)      704 2023-03-01 02:19:01.000000 ops-2.1.1/ops.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-03-01 02:19:01.000000 ops-2.1.1/ops.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       34 2023-03-01 02:19:01.000000 ops-2.1.1/ops.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        4 2023-03-01 02:19:01.000000 ops-2.1.1/ops.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)      983 2023-03-01 02:18:59.000000 ops-2.1.1/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-03-01 02:19:01.807894 ops-2.1.1/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)     2917 2023-03-01 02:18:59.000000 ops-2.1.1/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-01 02:19:01.807894 ops-2.1.1/test/
--rwxr-xr-x   0 runner    (1001) docker     (123)    21881 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_charm.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    63966 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_framework.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     4710 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_helpers.py
--rw-r--r--   0 runner    (1001) docker     (123)     5124 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_infra.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     6683 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_jujuversion.py
--rw-r--r--   0 runner    (1001) docker     (123)    22453 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)     5418 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_log.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    47199 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_main.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   130287 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_model.py
--rw-r--r--   0 runner    (1001) docker     (123)   124407 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_pebble.py
--rw-r--r--   0 runner    (1001) docker     (123)     3900 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_private.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    15133 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (123)   182653 2023-03-01 02:18:59.000000 ops-2.1.1/test/test_testing.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:09.902178 ops-2.2.0/
+-rw-r--r--   0 runner    (1001) docker     (123)    11358 2023-03-27 23:39:07.000000 ops-2.2.0/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     6977 2023-03-27 23:39:09.902178 ops-2.2.0/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     6283 2023-03-27 23:39:07.000000 ops-2.2.0/README.md
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:09.898178 ops-2.2.0/ops/
+-rw-r--r--   0 runner    (1001) docker     (123)     5225 2023-03-27 23:39:07.000000 ops-2.2.0/ops/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:09.902178 ops-2.2.0/ops/_private/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:07.000000 ops-2.2.0/ops/_private/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1978 2023-03-27 23:39:07.000000 ops-2.2.0/ops/_private/timeconv.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1224 2023-03-27 23:39:07.000000 ops-2.2.0/ops/_private/yaml.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    54095 2023-03-27 23:39:07.000000 ops-2.2.0/ops/charm.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    53402 2023-03-27 23:39:07.000000 ops-2.2.0/ops/framework.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     4775 2023-03-27 23:39:07.000000 ops-2.2.0/ops/jujuversion.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:09.902178 ops-2.2.0/ops/lib/
+-rw-r--r--   0 runner    (1001) docker     (123)     9839 2023-03-27 23:39:07.000000 ops-2.2.0/ops/lib/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2525 2023-03-27 23:39:07.000000 ops-2.2.0/ops/log.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    17905 2023-03-27 23:39:07.000000 ops-2.2.0/ops/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)   124923 2023-03-27 23:39:07.000000 ops-2.2.0/ops/model.py
+-rw-r--r--   0 runner    (1001) docker     (123)    98073 2023-03-27 23:39:07.000000 ops-2.2.0/ops/pebble.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:07.000000 ops-2.2.0/ops/py.typed
+-rwxr-xr-x   0 runner    (1001) docker     (123)    15197 2023-03-27 23:39:07.000000 ops-2.2.0/ops/storage.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   128167 2023-03-27 23:39:07.000000 ops-2.2.0/ops/testing.py
+-rw-r--r--   0 runner    (1001) docker     (123)       46 2023-03-27 23:39:09.000000 ops-2.2.0/ops/version.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:09.898178 ops-2.2.0/ops.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     6977 2023-03-27 23:39:09.000000 ops-2.2.0/ops.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)      704 2023-03-27 23:39:09.000000 ops-2.2.0/ops.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-03-27 23:39:09.000000 ops-2.2.0/ops.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       34 2023-03-27 23:39:09.000000 ops-2.2.0/ops.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        4 2023-03-27 23:39:09.000000 ops-2.2.0/ops.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      983 2023-03-27 23:39:07.000000 ops-2.2.0/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-03-27 23:39:09.902178 ops-2.2.0/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)     2917 2023-03-27 23:39:07.000000 ops-2.2.0/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-27 23:39:09.902178 ops-2.2.0/test/
+-rwxr-xr-x   0 runner    (1001) docker     (123)    21858 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_charm.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    64425 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_framework.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     4658 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_helpers.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5124 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_infra.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     6782 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_jujuversion.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22453 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5418 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_log.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    46889 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_main.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   129220 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_model.py
+-rw-r--r--   0 runner    (1001) docker     (123)   125097 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_pebble.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3900 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_private.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    15155 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (123)   191348 2023-03-27 23:39:07.000000 ops-2.2.0/test/test_testing.py
```

### Comparing `ops-2.1.1/LICENSE.txt` & `ops-2.2.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/PKG-INFO` & `ops-2.2.0/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ops
-Version: 2.1.1
+Version: 2.2.0
 Summary: The Python library behind great charms
 Home-page: https://github.com/canonical/operator
 Author: The Charmcraft team at Canonical Ltd.
 Author-email: charmcraft@lists.launchpad.net
 License: Apache-2.0
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: Apache Software License
```

### Comparing `ops-2.1.1/README.md` & `ops-2.2.0/README.md`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/_private/timeconv.py` & `ops-2.2.0/ops/_private/timeconv.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/_private/yaml.py` & `ops-2.2.0/ops/_private/yaml.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/charm.py` & `ops-2.2.0/ops/charm.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/framework.py` & `ops-2.2.0/ops/framework.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/jujuversion.py` & `ops-2.2.0/ops/jujuversion.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/lib/__init__.py` & `ops-2.2.0/ops/lib/__init__.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/log.py` & `ops-2.2.0/ops/log.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/main.py` & `ops-2.2.0/ops/main.py`

 * *Files 4% similar despite different names*

```diff
@@ -8,15 +8,20 @@
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-"""Main entry point to the Operator Framework."""
+"""Main entry point to the Operator Framework.
+
+Note that this module is callable, and calls the :func:`ops.main.main` function.
+This is so that :code:`import ops` followed by :code:`ops.main(MyCharm)` works
+as expected.
+"""
 
 import logging
 import os
 import shutil
 import subprocess
 import sys
 import warnings
@@ -434,7 +439,19 @@
             framework.reemit()
 
         _emit_charm_event(charm, dispatcher.event_name)
 
         framework.commit()
     finally:
         framework.close()
+
+
+# Make this module callable and call main(), so that "import ops" and then
+# "ops.main(Charm)" works as expected now that everything is imported in
+# ops/__init__.py. Idea from https://stackoverflow.com/a/48100440/68707
+class _CallableModule(sys.modules[__name__].__class__):
+    def __call__(self, charm_class: Type[ops.charm.CharmBase],
+                 use_juju_for_storage: Optional[bool] = None):
+        return main(charm_class, use_juju_for_storage=use_juju_for_storage)
+
+
+sys.modules[__name__].__class__ = _CallableModule
```

### Comparing `ops-2.1.1/ops/model.py` & `ops-2.2.0/ops/model.py`

 * *Files 0% similar despite different names*

```diff
@@ -1253,14 +1253,15 @@
 
     Attributes:
         name: The name of the local endpoint of the relation (eg 'db')
         id: The identifier for a particular relation (integer)
         app: An :class:`Application` representing the remote application of this relation.
             For peer relations this will be the local application.
         units: A set of :class:`Unit` for units that have started and joined this relation.
+            For subordinate relations, this set will include only one unit: the principal unit.
         data: A :class:`RelationData` holding the data buckets for each entity
             of a relation. Accessed via eg Relation.data[unit]['foo']
     """
 
     def __init__(
             self, relation_name: str, relation_id: int, is_peer: bool, our_unit: Unit,
             backend: '_ModelBackend', cache: '_ModelCache'):
```

### Comparing `ops-2.1.1/ops/pebble.py` & `ops-2.2.0/ops/pebble.py`

 * *Files 0% similar despite different names*

```diff
@@ -740,14 +740,23 @@
         ]
         dct = {name: value for name, value in fields if value}
         return typing.cast('LayerDict', dct)
 
     def __repr__(self) -> str:
         return f'Layer({self.to_dict()!r})'
 
+    def __eq__(self, other: Union['LayerDict', 'Layer']) -> bool:
+        """Reports whether this layer configuration is equal to another."""
+        if isinstance(other, dict):
+            return self.to_dict() == other
+        elif isinstance(other, Layer):
+            return self.to_dict() == other.to_dict()
+        else:
+            return NotImplemented
+
     __str__ = to_yaml
 
 
 class Service:
     """Represents a service description in a Pebble configuration layer."""
 
     def __init__(self, name: str, raw: Optional['_ServiceDict'] = None):
@@ -815,23 +824,21 @@
             else:
                 setattr(self, name, value)
 
     def __repr__(self) -> str:
         return f'Service({self.to_dict()!r})'
 
     def __eq__(self, other: Union['_ServiceDict', 'Service']) -> bool:
-        """Compare this service description to another."""
+        """Reports whether this service configuration is equal to another."""
         if isinstance(other, dict):
             return self.to_dict() == other
         elif isinstance(other, Service):
             return self.to_dict() == other.to_dict()
         else:
-            raise ValueError(
-                f"Cannot compare pebble.Service to {type(other)}"
-            )
+            return NotImplemented
 
 
 class ServiceStartup(enum.Enum):
     """Enum of service startup options."""
 
     ENABLED = 'enabled'
     DISABLED = 'disabled'
@@ -934,21 +941,21 @@
         dct = {name: value for name, value in fields if value}
         return typing.cast('_CheckDict', dct)
 
     def __repr__(self) -> str:
         return f'Check({self.to_dict()!r})'
 
     def __eq__(self, other: Union['_CheckDict', 'Check']) -> bool:
-        """Compare this check configuration to another."""
-        if isinstance(other, dict):  # pyright: reportUnnecessaryComparison=false
+        """Reports whether this check configuration is equal to another."""
+        if isinstance(other, dict):
             return self.to_dict() == other
         elif isinstance(other, Check):
             return self.to_dict() == other.to_dict()
         else:
-            raise ValueError(f"Cannot compare pebble.Check to {type(other)}")
+            return NotImplemented
 
 
 class CheckLevel(enum.Enum):
     """Enum of check levels."""
 
     UNSET = ''
     ALIVE = 'alive'
```

### Comparing `ops-2.1.1/ops/storage.py` & `ops-2.2.0/ops/storage.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/ops/testing.py` & `ops-2.2.0/ops/testing.py`

 * *Files 2% similar despite different names*

```diff
@@ -15,14 +15,15 @@
 """Infrastructure to build unit tests for charms using the Operator Framework."""
 
 
 import dataclasses
 import datetime
 import fnmatch
 import inspect
+import ipaddress
 import os
 import pathlib
 import random
 import signal
 import tempfile
 import uuid
 import warnings
@@ -55,15 +56,15 @@
 from ops._private import yaml
 from ops.charm import CharmBase, CharmMeta, RelationRole
 from ops.model import RelationNotFoundError
 
 if TYPE_CHECKING:
     from typing_extensions import TypedDict
 
-    from ops.model import UnitOrApplication
+    from ops.model import UnitOrApplication, _NetworkDict
 
     ReadableBuffer = Union[bytes, str, StringIO, BytesIO, BinaryIO]
     _StringOrPath = Union[str, pathlib.PurePosixPath, pathlib.Path]
     _FileOrDir = Union['_File', '_Directory']
     _FileKwargs = TypedDict('_FileKwargs', {
         'permissions': int,
         'last_modified': datetime.datetime,
@@ -1138,14 +1139,96 @@
         This allows the harness to fall through to the built in methods that will try to
         guess at a value for planned units, based on the number of peer relations that
         have been setup in the testing harness.
 
         """
         self._backend._planned_units = None
 
+    def add_network(self, address: str, *,
+                    endpoint: Optional[str] = None,
+                    relation_id: Optional[int] = None,
+                    cidr: Optional[str] = None,
+                    interface: str = 'eth0',
+                    ingress_addresses: Optional[Iterable[str]] = None,
+                    egress_subnets: Optional[Iterable[str]] = None):
+        """Add simulated network data for the given relation endpoint (binding).
+
+        Calling this multiple times with the same (binding, relation_id)
+        combination will replace the associated network data.
+
+        Example::
+
+            # Set network info for default binding
+            harness.add_network('10.0.0.10')
+
+            # Or set network info for specific endpoint
+            harness.add_network('10.0.0.10', endpoint='db')
+
+        After either of those calls, the following will be true (in the first
+        case, the simulated network-get will fall back to the default binding)::
+
+            binding = harness.model.get_binding('db')
+            assert binding.network.bind_address == ipaddress.IPv4Address('10.0.0.10'))
+
+        Args:
+            address: Binding's IPv4 or IPv6 address.
+            endpoint: Name of relation endpoint (binding) to add network
+                data for. If not provided, add info for the default binding.
+            relation_id: Relation ID for the binding. If provided, the
+                endpoint argument must be provided and correspond. If not
+                provided, add network data for the endpoint's default binding.
+            cidr: Binding's CIDR. Defaults to "<address>/24" if address is an
+                IPv4 address, or "<address>/64" if address is IPv6 (the host
+                bits are cleared).
+            interface: Name of network interface.
+            ingress_addresses: List of ingress addresses. Defaults to [address].
+            egress_subnets: List of egress subnets. Defaults to [cidr].
+
+        Raises:
+            ModelError: If the endpoint is not a known relation name, or the
+                relation_id is incorrect or doesn't match the endpoint.
+            ValueError: If address is not an IPv4 or IPv6 address.
+        """
+        if endpoint is not None and endpoint not in self._meta.relations:
+            raise model.ModelError(f'{endpoint!r} is not a known endpoint')
+        if relation_id is not None:
+            if endpoint is None:
+                raise TypeError('endpoint must be set if relation_id is provided')
+            relation_name = self._backend._relation_names.get(relation_id)
+            if relation_name is None:
+                raise model.ModelError(
+                    f'relation_id {relation_id} has not been added; use add_relation')
+            if endpoint != relation_name:
+                raise model.ModelError(
+                    f"endpoint {endpoint!r} does not correspond to relation_id "
+                    + f"{relation_id} ({relation_name!r})")
+
+        parsed_address = ipaddress.ip_address(address)  # raises ValueError if not an IP
+        if cidr is None:
+            if isinstance(parsed_address, ipaddress.IPv4Address):
+                cidr = str(ipaddress.IPv4Network(address + '/24', strict=False))
+            else:
+                cidr = str(ipaddress.IPv6Network(address + '/64', strict=False))
+        if ingress_addresses is None:
+            ingress_addresses = [address]
+        if egress_subnets is None:
+            egress_subnets = [cidr]
+
+        data = {
+            'bind-addresses': [{
+                'interface-name': interface,
+                'addresses': [
+                    {'cidr': cidr, 'value': address},
+                ],
+            }],
+            'egress-subnets': list(egress_subnets),
+            'ingress-addresses': list(ingress_addresses),
+        }
+        self._backend._networks[endpoint, relation_id] = data
+
     def _get_backend_calls(self, reset: bool = True) -> List[Tuple[Any, ...]]:
         """Return the calls that we have made to the TestingModelBackend.
 
         This is useful mostly for testing the framework itself, so that we can assert that we
         do/don't trigger extra calls.
 
         Args:
@@ -1545,14 +1628,15 @@
         # {container_name : _TestingPebbleClient}
         self._pebble_clients: Dict[str, _TestingPebbleClient] = {}
         self._pebble_clients_can_connect: Dict[_TestingPebbleClient, bool] = {}
         self._planned_units: Optional[int] = None
         self._hook_is_running = ''
         self._secrets: List[_Secret] = []
         self._opened_ports: Set[model.OpenedPort] = set()
+        self._networks: Dict[Tuple[Optional[str], Optional[int]], _NetworkDict] = {}
 
     def _validate_relation_access(self, relation_name: str, relations: List[model.Relation]):
         """Ensures that the named relation exists/has been added.
 
         This is called whenever relation data is accessed via model.get_relation(...).
         """
         if len(relations) > 0:
@@ -1802,16 +1886,28 @@
 
     def action_log(self, message):  # type:ignore
         raise NotImplementedError(self.action_log)  # type:ignore
 
     def action_fail(self, message=''):  # type:ignore
         raise NotImplementedError(self.action_fail)  # type:ignore
 
-    def network_get(self, endpoint_name, relation_id=None):  # type:ignore
-        raise NotImplementedError(self.network_get)  # type:ignore
+    def network_get(self, endpoint_name: str, relation_id: Optional[int] = None) -> '_NetworkDict':
+        data = self._networks.get((endpoint_name, relation_id))
+        if data is not None:
+            return data
+        if relation_id is not None:
+            # Fall back to the default binding for this endpoint
+            data = self._networks.get((endpoint_name, None))
+            if data is not None:
+                return data
+        # No custom data per relation ID or binding, return the default binding
+        data = self._networks.get((None, None))
+        if data is not None:
+            return data
+        raise RelationNotFoundError
 
     def add_metrics(self, metrics, labels=None):  # type:ignore
         raise NotImplementedError(self.add_metrics)  # type:ignore
 
     @classmethod
     def log_split(cls, message, max_len=model.MAX_LOG_LINE_LEN):  # type:ignore
         raise NotImplementedError(cls.log_split)  # type:ignore
```

### Comparing `ops-2.1.1/ops.egg-info/PKG-INFO` & `ops-2.2.0/ops.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ops
-Version: 2.1.1
+Version: 2.2.0
 Summary: The Python library behind great charms
 Home-page: https://github.com/canonical/operator
 Author: The Charmcraft team at Canonical Ltd.
 Author-email: charmcraft@lists.launchpad.net
 License: Apache-2.0
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: Apache Software License
```

### Comparing `ops-2.1.1/ops.egg-info/SOURCES.txt` & `ops-2.2.0/ops.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/pyproject.toml` & `ops-2.2.0/pyproject.toml`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/setup.py` & `ops-2.2.0/setup.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/test/test_charm.py` & `ops-2.2.0/test/test_charm.py`

 * *Files 2% similar despite different names*

```diff
@@ -14,24 +14,16 @@
 import functools
 import os
 import shutil
 import tempfile
 import unittest
 from pathlib import Path
 
-from ops.charm import (
-    CharmBase,
-    CharmEvents,
-    CharmMeta,
-    ContainerMeta,
-    ContainerStorageMeta,
-    StartEvent,
-)
-from ops.framework import EventBase, EventSource, Framework
-from ops.model import Model, Storage, _ModelBackend
+import ops
+from ops.model import _ModelBackend
 from ops.storage import SQLiteStorage
 
 from .test_helpers import fake_script, fake_script_calls
 
 
 class TestCharm(unittest.TestCase):
 
@@ -44,41 +36,41 @@
         os.environ['PATH'] = os.pathsep.join([
             str(Path(__file__).parent / 'bin'),
             os.environ['PATH']])
         os.environ['JUJU_UNIT_NAME'] = 'local/0'
 
         self.tmpdir = Path(tempfile.mkdtemp())
         self.addCleanup(shutil.rmtree, str(self.tmpdir))
-        self.meta = CharmMeta()
+        self.meta = ops.CharmMeta()
 
-        class CustomEvent(EventBase):
+        class CustomEvent(ops.EventBase):
             pass
 
-        class TestCharmEvents(CharmEvents):
-            custom = EventSource(CustomEvent)
+        class TestCharmEvents(ops.CharmEvents):
+            custom = ops.EventSource(CustomEvent)
 
         # Relations events are defined dynamically and modify the class attributes.
         # We use a subclass temporarily to prevent these side effects from leaking.
-        CharmBase.on = TestCharmEvents()
+        ops.CharmBase.on = TestCharmEvents()
 
         def cleanup():
-            CharmBase.on = CharmEvents()
+            ops.CharmBase.on = ops.CharmEvents()
         self.addCleanup(cleanup)
 
     def create_framework(self):
-        model = Model(self.meta, _ModelBackend('local/0'))
+        model = ops.Model(self.meta, _ModelBackend('local/0'))
         # we can pass foo_event as event_name because we're not actually testing dispatch
-        framework = Framework(SQLiteStorage(':memory:'), self.tmpdir, self.meta,
-                              model)
+        framework = ops.Framework(SQLiteStorage(':memory:'), self.tmpdir, self.meta,
+                                  model)
         self.addCleanup(framework.close)
         return framework
 
     def test_basic(self):
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
 
             def __init__(self, *args):
                 super().__init__(*args)
 
                 self.started = False
                 framework.observe(self.on.start, self._on_start)
 
@@ -112,15 +104,15 @@
             # `events` list all events it receives
             @functools.wraps(fn)
             def wrapper(charm, evt):
                 events.append(evt)
                 fn(charm, evt)
             return wrapper
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             def __init__(self, *args):
                 super().__init__(*args)
                 framework.observe(self.on.start, self._on_start)
                 self.seen = None
 
             @dec
             def _on_start(self, event):
@@ -128,36 +120,36 @@
 
         framework = self.create_framework()
         charm = MyCharm(framework)
         charm.on.start.emit()
         # check that the event has been seen by the decorator
         self.assertEqual(1, len(events))
         # check that the event has been seen by the observer
-        self.assertIsInstance(charm.seen, StartEvent)
+        self.assertIsInstance(charm.seen, ops.StartEvent)
 
     def test_empty_action(self):
-        meta = CharmMeta.from_yaml('name: my-charm', '')
+        meta = ops.CharmMeta.from_yaml('name: my-charm', '')
         self.assertEqual(meta.actions, {})
 
     def test_helper_properties(self):
         framework = self.create_framework()
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             pass
 
         charm = MyCharm(framework)
         self.assertEqual(charm.app, framework.model.app)
         self.assertEqual(charm.unit, framework.model.unit)
         self.assertEqual(charm.meta, framework.meta)
         self.assertEqual(charm.charm_dir, framework.charm_dir)
         self.assertIs(charm.config, framework.model.config)
 
     def test_relation_events(self):
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             def __init__(self, *args):
                 super().__init__(*args)
                 self.seen = []
                 for rel in ('req1', 'req-2', 'pro1', 'pro-2', 'peer1', 'peer-2'):
                     # Hook up relation events to generic handler.
                     self.framework.observe(self.on[rel].relation_joined, self.on_any_relation)
                     self.framework.observe(self.on[rel].relation_changed, self.on_any_relation)
@@ -166,15 +158,15 @@
 
             def on_any_relation(self, event):
                 assert event.relation.name == 'req1'
                 assert event.relation.app.name == 'remote'
                 self.seen.append(type(event).__name__)
 
         # language=YAML
-        self.meta = CharmMeta.from_yaml(metadata='''
+        self.meta = ops.CharmMeta.from_yaml(metadata='''
 name: my-charm
 requires:
  req1:
    interface: req1
  req-2:
    interface: req2
 provides:
@@ -212,15 +204,15 @@
             'RelationBrokenEvent',
             'RelationBrokenEvent',
         ])
 
     def test_storage_events(self):
         this = self
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             def __init__(self, *args):
                 super().__init__(*args)
                 self.seen = []
                 self.framework.observe(self.on['stor1'].storage_attached, self._on_stor1_attach)
                 self.framework.observe(self.on['stor2'].storage_detaching, self._on_stor2_detach)
                 self.framework.observe(self.on['stor3'].storage_attached, self._on_stor3_attach)
                 self.framework.observe(self.on['stor-4'].storage_attached, self._on_stor4_attach)
@@ -235,15 +227,15 @@
             def _on_stor3_attach(self, event):
                 self.seen.append(type(event).__name__)
 
             def _on_stor4_attach(self, event):
                 self.seen.append(type(event).__name__)
 
         # language=YAML
-        self.meta = CharmMeta.from_yaml('''
+        self.meta = ops.CharmMeta.from_yaml('''
 name: my-charm
 storage:
   stor-4:
     multiple:
       range: 2-4
     type: filesystem
   stor1:
@@ -306,31 +298,31 @@
         self.assertIsNone(self.meta.storages['stor1'].multiple_range)
         self.assertEqual(self.meta.storages['stor2'].multiple_range, (2, 2))
         self.assertEqual(self.meta.storages['stor3'].multiple_range, (2, None))
         self.assertEqual(self.meta.storages['stor-4'].multiple_range, (2, 4))
 
         charm = MyCharm(self.create_framework())
 
-        charm.on['stor1'].storage_attached.emit(Storage("stor1", 0, charm.model._backend))
-        charm.on['stor2'].storage_detaching.emit(Storage("stor2", 0, charm.model._backend))
-        charm.on['stor3'].storage_attached.emit(Storage("stor3", 0, charm.model._backend))
-        charm.on['stor-4'].storage_attached.emit(Storage("stor-4", 0, charm.model._backend))
+        charm.on['stor1'].storage_attached.emit(ops.Storage("stor1", 0, charm.model._backend))
+        charm.on['stor2'].storage_detaching.emit(ops.Storage("stor2", 0, charm.model._backend))
+        charm.on['stor3'].storage_attached.emit(ops.Storage("stor3", 0, charm.model._backend))
+        charm.on['stor-4'].storage_attached.emit(ops.Storage("stor-4", 0, charm.model._backend))
         charm.on['stor-multiple-dashes'].storage_attached.emit(
-            Storage("stor-multiple-dashes", 0, charm.model._backend))
+            ops.Storage("stor-multiple-dashes", 0, charm.model._backend))
 
         self.assertEqual(charm.seen, [
             'StorageAttachedEvent',
             'StorageDetachingEvent',
             'StorageAttachedEvent',
             'StorageAttachedEvent',
         ])
 
     def test_workload_events(self):
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             def __init__(self, *args):
                 super().__init__(*args)
                 self.seen = []
                 self.count = 0
                 for workload in ('container-a', 'containerb'):
                     # Hook up relation events to generic handler.
                     self.framework.observe(
@@ -338,15 +330,15 @@
                         self.on_any_pebble_ready)
 
             def on_any_pebble_ready(self, event):
                 self.seen.append(type(event).__name__)
                 self.count += 1
 
         # language=YAML
-        self.meta = CharmMeta.from_yaml(metadata='''
+        self.meta = ops.CharmMeta.from_yaml(metadata='''
 name: my-charm
 containers:
   container-a:
   containerb:
 ''')
 
         charm = MyCharm(self.create_framework())
@@ -364,15 +356,15 @@
             'PebbleReadyEvent'
         ])
         self.assertEqual(charm.count, 2)
 
     def test_relations_meta(self):
 
         # language=YAML
-        self.meta = CharmMeta.from_yaml('''
+        self.meta = ops.CharmMeta.from_yaml('''
 name: my-charm
 requires:
   database:
     interface: mongodb
     limit: 1
     scope: container
   metrics:
@@ -386,38 +378,38 @@
         self.assertEqual(self.meta.requires['metrics'].interface_name, 'prometheus-scraping')
         self.assertIsNone(self.meta.requires['metrics'].limit)
         self.assertEqual(self.meta.requires['metrics'].scope, 'global')  # Default value
 
     def test_relations_meta_limit_type_validation(self):
         with self.assertRaisesRegex(TypeError, "limit should be an int, not <class 'str'>"):
             # language=YAML
-            self.meta = CharmMeta.from_yaml('''
+            self.meta = ops.CharmMeta.from_yaml('''
 name: my-charm
 requires:
   database:
     interface: mongodb
     limit: foobar
 ''')
 
     def test_relations_meta_scope_type_validation(self):
         with self.assertRaisesRegex(TypeError,
                                     "scope should be one of 'global', 'container'; not 'foobar'"):
             # language=YAML
-            self.meta = CharmMeta.from_yaml('''
+            self.meta = ops.CharmMeta.from_yaml('''
 name: my-charm
 requires:
   database:
     interface: mongodb
     scope: foobar
 ''')
 
     @classmethod
     def _get_action_test_meta(cls):
         # language=YAML
-        return CharmMeta.from_yaml(metadata='''
+        return ops.CharmMeta.from_yaml(metadata='''
 name: my-charm
 ''', actions='''
 foo-bar:
   description: "Foos the bar."
   params:
     foo-name:
       description: "A foo name to bar"
@@ -438,15 +430,15 @@
         fake_script(self, 'action-set', "")
         fake_script(self, 'action-log', "")
         fake_script(self, 'action-fail', "")
         self.meta = self._get_action_test_meta()
 
     def test_action_events(self):
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
 
             def __init__(self, *args):
                 super().__init__(*args)
                 framework.observe(self.on.foo_bar_action, self._on_foo_bar_action)
                 framework.observe(self.on.start_action, self._on_start_action)
 
             def _on_foo_bar_action(self, event):
@@ -478,15 +470,15 @@
         # Make sure that action events that do not match the current context are
         # not possible to emit by hand.
         with self.assertRaises(RuntimeError):
             charm.on.start_action.emit()
 
     def test_invalid_action_results(self):
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
 
             def __init__(self, *args):
                 super().__init__(*args)
                 self.res = {}
                 framework.observe(self.on.foo_bar_action, self._on_foo_bar_action)
 
             def _on_foo_bar_action(self, event):
@@ -505,15 +497,15 @@
             charm.res = bad_res
 
             with self.assertRaises(ValueError):
                 charm.on.foo_bar_action.emit()
 
     def _test_action_event_defer_fails(self, cmd_type):
 
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
 
             def __init__(self, *args):
                 super().__init__(*args)
                 framework.observe(self.on.start_action, self._on_start_action)
 
             def _on_start_action(self, event):
                 event.defer()
@@ -528,29 +520,29 @@
         with self.assertRaises(RuntimeError):
             charm.on.start_action.emit()
 
     def test_action_event_defer_fails(self):
         self._test_action_event_defer_fails('action')
 
     def test_containers(self):
-        meta = CharmMeta.from_yaml("""
+        meta = ops.CharmMeta.from_yaml("""
 name: k8s-charm
 containers:
   test1:
     k: v
   test2:
     k: v
 """)
-        self.assertIsInstance(meta.containers['test1'], ContainerMeta)
-        self.assertIsInstance(meta.containers['test2'], ContainerMeta)
+        self.assertIsInstance(meta.containers['test1'], ops.ContainerMeta)
+        self.assertIsInstance(meta.containers['test2'], ops.ContainerMeta)
         self.assertEqual(meta.containers['test1'].name, 'test1')
         self.assertEqual(meta.containers['test2'].name, 'test2')
 
     def test_containers_storage(self):
-        meta = CharmMeta.from_yaml("""
+        meta = ops.CharmMeta.from_yaml("""
 name: k8s-charm
 storage:
   data:
     type: filesystem
     location: /test/storage
   other:
     type: filesystem
@@ -559,46 +551,46 @@
   test1:
     mounts:
       - storage: data
         location: /test/storagemount
       - storage: other
         location: /test/otherdata
 """)
-        self.assertIsInstance(meta.containers['test1'], ContainerMeta)
-        self.assertIsInstance(meta.containers['test1'].mounts["data"], ContainerStorageMeta)
+        self.assertIsInstance(meta.containers['test1'], ops.ContainerMeta)
+        self.assertIsInstance(meta.containers['test1'].mounts["data"], ops.ContainerStorageMeta)
         self.assertEqual(meta.containers['test1'].mounts["data"].location, '/test/storagemount')
         self.assertEqual(meta.containers['test1'].mounts["other"].location, '/test/otherdata')
 
     def test_containers_storage_multiple_mounts(self):
-        meta = CharmMeta.from_yaml("""
+        meta = ops.CharmMeta.from_yaml("""
 name: k8s-charm
 storage:
   data:
     type: filesystem
     location: /test/storage
 containers:
   test1:
     mounts:
       - storage: data
         location: /test/storagemount
       - storage: data
         location: /test/otherdata
 """)
-        self.assertIsInstance(meta.containers['test1'], ContainerMeta)
-        self.assertIsInstance(meta.containers['test1'].mounts["data"], ContainerStorageMeta)
+        self.assertIsInstance(meta.containers['test1'], ops.ContainerMeta)
+        self.assertIsInstance(meta.containers['test1'].mounts["data"], ops.ContainerStorageMeta)
         self.assertEqual(
             meta.containers['test1'].mounts["data"].locations[0],
             '/test/storagemount')
         self.assertEqual(meta.containers['test1'].mounts["data"].locations[1], '/test/otherdata')
 
         with self.assertRaises(RuntimeError):
             meta.containers["test1"].mounts["data"].location
 
     def test_secret_events(self):
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             def __init__(self, *args):
                 super().__init__(*args)
                 self.seen = []
                 self.framework.observe(self.on.secret_changed, self.on_secret_changed)
                 self.framework.observe(self.on.secret_rotate, self.on_secret_rotate)
                 self.framework.observe(self.on.secret_remove, self.on_secret_remove)
                 self.framework.observe(self.on.secret_expired, self.on_secret_expired)
@@ -621,15 +613,15 @@
 
             def on_secret_expired(self, event):
                 assert event.secret.id == 'secret:expired'
                 assert event.secret.label == 'exp'
                 assert event.revision == 42
                 self.seen.append(type(event).__name__)
 
-        self.meta = CharmMeta.from_yaml(metadata='name: my-charm')
+        self.meta = ops.CharmMeta.from_yaml(metadata='name: my-charm')
         charm = MyCharm(self.create_framework())
 
         charm.on.secret_changed.emit('secret:changed', None)
         charm.on.secret_rotate.emit('secret:rotate', 'rot')
         charm.on.secret_remove.emit('secret:remove', 'rem', 7)
         charm.on.secret_expired.emit('secret:expired', 'exp', 42)
```

### Comparing `ops-2.1.1/test/test_framework.py` & `ops-2.2.0/test/test_framework.py`

 * *Files 4% similar despite different names*

```diff
@@ -23,33 +23,16 @@
 import tempfile
 from pathlib import Path
 from test.test_helpers import BaseTestCase, fake_script
 from unittest.mock import patch
 
 import logassert
 
-from ops import charm
-from ops.framework import (
-    _BREAKPOINT_WELCOME_MESSAGE,
-    BoundStoredState,
-    CommitEvent,
-    EventBase,
-    EventSource,
-    Framework,
-    Handle,
-    Object,
-    ObjectEvents,
-    PreCommitEvent,
-    StoredDict,
-    StoredList,
-    StoredSet,
-    StoredState,
-    StoredStateData,
-    _event_regex,
-)
+import ops
+from ops.framework import _BREAKPOINT_WELCOME_MESSAGE, _event_regex
 from ops.storage import NoSnapshotError, SQLiteStorage
 
 
 class TestFramework(BaseTestCase):
 
     def setUp(self):
         self.tmpdir = Path(tempfile.mkdtemp())
@@ -58,48 +41,48 @@
         patcher = patch('ops.storage.SQLiteStorage.DB_LOCK_TIMEOUT', datetime.timedelta(0))
         patcher.start()
         self.addCleanup(patcher.stop)
         logassert.setup(self, 'ops')
 
     def test_deprecated_init(self):
         # For 0.7, this still works, but it is deprecated.
-        framework = Framework(':memory:', None, None, None)
+        framework = ops.Framework(':memory:', None, None, None)
         self.assertLoggedWarning(
             "deprecated: Framework now takes a Storage not a path")
         self.assertIsInstance(framework._storage, SQLiteStorage)
 
     def test_handle_path(self):
         cases = [
-            (Handle(None, "root", None), "root"),
-            (Handle(None, "root", "1"), "root[1]"),
-            (Handle(Handle(None, "root", None), "child", None), "root/child"),
-            (Handle(Handle(None, "root", "1"), "child", "2"), "root[1]/child[2]"),
+            (ops.Handle(None, "root", None), "root"),
+            (ops.Handle(None, "root", "1"), "root[1]"),
+            (ops.Handle(ops.Handle(None, "root", None), "child", None), "root/child"),
+            (ops.Handle(ops.Handle(None, "root", "1"), "child", "2"), "root[1]/child[2]"),
         ]
         for handle, path in cases:
             self.assertEqual(str(handle), path)
-            self.assertEqual(Handle.from_path(path), handle)
+            self.assertEqual(ops.Handle.from_path(path), handle)
 
     def test_handle_attrs_readonly(self):
-        handle = Handle(None, 'kind', 'key')
+        handle = ops.Handle(None, 'kind', 'key')
         with self.assertRaises(AttributeError):
             handle.parent = 'foo'
         with self.assertRaises(AttributeError):
             handle.kind = 'foo'
         with self.assertRaises(AttributeError):
             handle.key = 'foo'
         with self.assertRaises(AttributeError):
             handle.path = 'foo'
 
     def test_restore_unknown(self):
         framework = self.create_framework()
 
-        class Foo(Object):
+        class Foo(ops.Object):
             pass
 
-        handle = Handle(None, "a_foo", "some_key")
+        handle = ops.Handle(None, "a_foo", "some_key")
 
         framework.register_type(Foo, None, handle.kind)
 
         try:
             framework.load_snapshot(handle)
         except NoSnapshotError as e:
             self.assertEqual(e.handle_path, str(handle))
@@ -115,15 +98,15 @@
 
             def snapshot(self):
                 return {"My N!": self.my_n}
 
             def restore(self, snapshot):
                 self.my_n = snapshot["My N!"] + 1
 
-        handle = Handle(None, "a_foo", "some_key")
+        handle = ops.Handle(None, "a_foo", "some_key")
         event = Foo(handle, 1)
 
         framework1 = self.create_framework(tmpdir=self.tmpdir)
         framework1.register_type(Foo, None, handle.kind)
         framework1.save_snapshot(event)
         framework1.commit()
         framework1.close()
@@ -147,23 +130,23 @@
         framework3.register_type(Foo, None, handle.kind)
 
         self.assertRaises(NoSnapshotError, framework3.load_snapshot, handle)
 
     def test_simple_event_observer(self):
         framework = self.create_framework()
 
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             pass
 
-        class MyNotifier(Object):
-            foo = EventSource(MyEvent)
-            bar = EventSource(MyEvent)
-            baz = EventSource(MyEvent)
+        class MyNotifier(ops.Object):
+            foo = ops.EventSource(MyEvent)
+            bar = ops.EventSource(MyEvent)
+            baz = ops.EventSource(MyEvent)
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
                 self.reprs = []
 
             def on_any(self, event):
                 self.seen.append(f"on_any:{event.handle.kind}")
@@ -189,24 +172,24 @@
         self.assertEqual(obs.reprs, [
             "<MyEvent via MyNotifier[1]/foo[1]>",
             "<MyEvent via MyNotifier[1]/bar[2]>",
         ])
 
     def test_bad_sig_observer(self):
 
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             pass
 
-        class MyNotifier(Object):
-            foo = EventSource(MyEvent)
-            bar = EventSource(MyEvent)
-            baz = EventSource(MyEvent)
-            qux = EventSource(MyEvent)
+        class MyNotifier(ops.Object):
+            foo = ops.EventSource(MyEvent)
+            bar = ops.EventSource(MyEvent)
+            baz = ops.EventSource(MyEvent)
+            qux = ops.EventSource(MyEvent)
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def _on_foo(self):
                 assert False, 'should not be reached'
 
             def _on_bar(self, event, extra):
                 assert False, 'should not be reached'
 
             def _on_baz(self, event, extra=None, *, k):
@@ -226,17 +209,17 @@
         with self.assertRaisesRegex(TypeError, "has extra required parameter"):
             framework.observe(pub.baz, obs._on_baz)
         framework.observe(pub.qux, obs._on_qux)
 
     def test_on_pre_commit_emitted(self):
         framework = self.create_framework(tmpdir=self.tmpdir)
 
-        class PreCommitObserver(Object):
+        class PreCommitObserver(ops.Object):
 
-            _stored = StoredState()
+            _stored = ops.StoredState()
 
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
                 self._stored.myinitdata = 40
 
             def on_pre_commit(self, event):
@@ -255,15 +238,15 @@
 
         framework.observe(framework.on.pre_commit, obs.on_pre_commit)
 
         framework.commit()
 
         self.assertEqual(obs._stored.myinitdata, 41)
         self.assertEqual(obs._stored.mydata, 42)
-        self.assertTrue(obs.seen, [PreCommitEvent, CommitEvent])
+        self.assertTrue(obs.seen, [ops.PreCommitEvent, ops.CommitEvent])
         framework.close()
 
         other_framework = self.create_framework(tmpdir=self.tmpdir)
 
         new_obs = PreCommitObserver(other_framework, None)
 
         self.assertEqual(obs._stored.myinitdata, 41)
@@ -271,25 +254,25 @@
 
         with self.assertRaises(AttributeError):
             new_obs._stored.myotherdata
 
     def test_defer_and_reemit(self):
         framework = self.create_framework()
 
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             pass
 
-        class MyNotifier1(Object):
-            a = EventSource(MyEvent)
-            b = EventSource(MyEvent)
+        class MyNotifier1(ops.Object):
+            a = ops.EventSource(MyEvent)
+            b = ops.EventSource(MyEvent)
 
-        class MyNotifier2(Object):
-            c = EventSource(MyEvent)
+        class MyNotifier2(ops.Object):
+            c = ops.EventSource(MyEvent)
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
                 self.done = {}
 
             def on_any(self, event):
                 self.seen.append(event.handle.kind)
@@ -308,19 +291,19 @@
         framework.observe(pub2.c, obs2.on_any)
 
         pub1.a.emit()
         pub1.b.emit()
         pub2.c.emit()
 
         # Events remain stored because they were deferred.
-        ev_a_handle = Handle(pub1, "a", "1")
+        ev_a_handle = ops.Handle(pub1, "a", "1")
         framework.load_snapshot(ev_a_handle)
-        ev_b_handle = Handle(pub1, "b", "2")
+        ev_b_handle = ops.Handle(pub1, "b", "2")
         framework.load_snapshot(ev_b_handle)
-        ev_c_handle = Handle(pub2, "c", "3")
+        ev_c_handle = ops.Handle(pub2, "c", "3")
         framework.load_snapshot(ev_c_handle)
         # make sure the objects are gone before we reemit them
         gc.collect()
 
         framework.reemit()
         obs1.done["a"] = True
         obs2.done["b"] = True
@@ -341,30 +324,30 @@
         self.assertRaises(NoSnapshotError, framework.load_snapshot, ev_a_handle)
         self.assertRaises(NoSnapshotError, framework.load_snapshot, ev_b_handle)
         self.assertRaises(NoSnapshotError, framework.load_snapshot, ev_c_handle)
 
     def test_custom_event_data(self):
         framework = self.create_framework()
 
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             def __init__(self, handle, n):
                 super().__init__(handle)
                 self.my_n = n
 
             def snapshot(self):
                 return {"My N!": self.my_n}
 
             def restore(self, snapshot):
                 super().restore(snapshot)
                 self.my_n = snapshot["My N!"] + 1
 
-        class MyNotifier(Object):
-            foo = EventSource(MyEvent)
+        class MyNotifier(ops.Object):
+            foo = ops.EventSource(MyEvent)
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
 
             def _on_foo(self, event):
                 self.seen.append(f"on_foo:{event.handle.kind}={event.my_n}")
                 event.defer()
@@ -395,24 +378,24 @@
         self.assertLoggedDebug("Re-emitting deferred event <MyEvent via MyNotifier[1]/foo[1]>.")
 
     def test_weak_observer(self):
         framework = self.create_framework()
 
         observed_events = []
 
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             pass
 
-        class MyEvents(ObjectEvents):
-            foo = EventSource(MyEvent)
+        class MyEvents(ops.ObjectEvents):
+            foo = ops.EventSource(MyEvent)
 
-        class MyNotifier(Object):
+        class MyNotifier(ops.Object):
             on = MyEvents()
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def _on_foo(self, event):
                 observed_events.append("foo")
 
         pub = MyNotifier(framework, "1")
         obs = MyObserver(framework, "2")
 
         framework.observe(pub.on.foo, obs._on_foo)
@@ -424,15 +407,15 @@
         gc.collect()
         pub.on.foo.emit()
         self.assertEqual(observed_events, ["foo"])
 
     def test_forget_and_multiple_objects(self):
         framework = self.create_framework()
 
-        class MyObject(Object):
+        class MyObject(ops.Object):
             pass
 
         o1 = MyObject(framework, "path")
         # Creating a second object at the same path should fail with RuntimeError
         with self.assertRaises(RuntimeError):
             o2 = MyObject(framework, "path")
         # Unless we _forget the object first
@@ -449,15 +432,15 @@
         framework_copy = self.create_framework()
         o_copy = MyObject(framework_copy, "path")
         self.assertEqual(o1.handle.path, o_copy.handle.path)
 
     def test_forget_and_multiple_objects_with_load_snapshot(self):
         framework = self.create_framework(tmpdir=self.tmpdir)
 
-        class MyObject(Object):
+        class MyObject(ops.Object):
             def __init__(self, parent, name):
                 super().__init__(parent, name)
                 self.value = name
 
             def snapshot(self):
                 return self.value
 
@@ -492,25 +475,25 @@
         framework_copy2.register_type(MyObject, None, MyObject.handle_kind)
         o_copy2 = framework_copy2.load_snapshot(o_handle)
         self.assertEqual(o_copy2.value, "path")
 
     def test_events_base(self):
         framework = self.create_framework()
 
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             pass
 
-        class MyEvents(ObjectEvents):
-            foo = EventSource(MyEvent)
-            bar = EventSource(MyEvent)
+        class MyEvents(ops.ObjectEvents):
+            foo = ops.EventSource(MyEvent)
+            bar = ops.EventSource(MyEvent)
 
-        class MyNotifier(Object):
+        class MyNotifier(ops.Object):
             on = MyEvents()
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
 
             def _on_foo(self, event):
                 self.seen.append(f"on_foo:{event.handle.kind}")
                 event.defer()
@@ -530,50 +513,50 @@
         pub.on.foo.emit()
 
         self.assertEqual(obs.seen, ["on_foo:foo"])
         fqn = f"{pub.on.__class__.__module__}.{pub.on.__class__.__qualname__}"
         self.assertEqual(repr(pub.on), f"<{fqn}: bar, foo>")
 
     def test_conflicting_event_attributes(self):
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             pass
 
-        event = EventSource(MyEvent)
+        event = ops.EventSource(MyEvent)
 
-        class MyEvents(ObjectEvents):
+        class MyEvents(ops.ObjectEvents):
             foo = event
 
         with self.assertRaises(RuntimeError) as cm:
-            class OtherEvents(ObjectEvents):
+            class OtherEvents(ops.ObjectEvents):
                 foo = event
         self.assertEqual(
             str(cm.exception.__cause__),
             "EventSource(MyEvent) reused as MyEvents.foo and OtherEvents.foo")
 
         with self.assertRaises(RuntimeError) as cm:
-            class MyNotifier(Object):
+            class MyNotifier(ops.Object):
                 on = MyEvents()
                 bar = event
         self.assertEqual(
             str(cm.exception.__cause__),
             "EventSource(MyEvent) reused as MyEvents.foo and MyNotifier.bar")
 
     def test_reemit_ignores_unknown_event_type(self):
         # The event type may have been gone for good, and nobody cares,
         # so this shouldn't be an error scenario.
 
         framework = self.create_framework()
 
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             pass
 
-        class MyNotifier(Object):
-            foo = EventSource(MyEvent)
+        class MyNotifier(ops.Object):
+            foo = ops.EventSource(MyEvent)
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
 
             def _on_foo(self, event):
                 self.seen.append(event.handle)
                 event.defer()
@@ -598,28 +581,28 @@
         # Register the type and check that the event is gone from storage.
         framework_copy.register_type(MyEvent, event_handle.parent, event_handle.kind)
         self.assertRaises(NoSnapshotError, framework_copy.load_snapshot, event_handle)
 
     def test_auto_register_event_types(self):
         framework = self.create_framework()
 
-        class MyFoo(EventBase):
+        class MyFoo(ops.EventBase):
             pass
 
-        class MyBar(EventBase):
+        class MyBar(ops.EventBase):
             pass
 
-        class MyEvents(ObjectEvents):
-            foo = EventSource(MyFoo)
+        class MyEvents(ops.ObjectEvents):
+            foo = ops.EventSource(MyFoo)
 
-        class MyNotifier(Object):
+        class MyNotifier(ops.Object):
             on = MyEvents()
-            bar = EventSource(MyBar)
+            bar = ops.EventSource(MyBar)
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
 
             def _on_foo(self, event):
                 self.seen.append(f"on_foo:{type(event).__name__}:{event.handle.kind}")
                 event.defer()
@@ -641,25 +624,25 @@
         pub.bar.emit()
 
         self.assertEqual(obs.seen, ["on_foo:MyFoo:foo", "on_bar:MyBar:bar"])
 
     def test_dynamic_event_types(self):
         framework = self.create_framework()
 
-        class MyEventsA(ObjectEvents):
+        class MyEventsA(ops.ObjectEvents):
             handle_kind = 'on_a'
 
-        class MyEventsB(ObjectEvents):
+        class MyEventsB(ops.ObjectEvents):
             handle_kind = 'on_b'
 
-        class MyNotifier(Object):
+        class MyNotifier(ops.Object):
             on_a = MyEventsA()
             on_b = MyEventsB()
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
 
             def _on_foo(self, event):
                 self.seen.append(f"on_foo:{type(event).__name__}:{event.handle.kind}")
                 event.defer()
@@ -667,24 +650,24 @@
             def _on_bar(self, event):
                 self.seen.append(f"on_bar:{type(event).__name__}:{event.handle.kind}")
                 event.defer()
 
         pub = MyNotifier(framework, "1")
         obs = MyObserver(framework, "1")
 
-        class MyFoo(EventBase):
+        class MyFoo(ops.EventBase):
             pass
 
-        class MyBar(EventBase):
+        class MyBar(ops.EventBase):
             pass
 
-        class DeadBeefEvent(EventBase):
+        class DeadBeefEvent(ops.EventBase):
             pass
 
-        class NoneEvent(EventBase):
+        class NoneEvent(ops.EventBase):
             pass
 
         pub.on_a.define_event("foo", MyFoo)
         pub.on_b.define_event("bar", MyBar)
 
         framework.observe(pub.on_a.foo, obs._on_foo)
         framework.observe(pub.on_b.bar, obs._on_bar)
@@ -707,29 +690,29 @@
             pub.on_a.define_event("None", NoneEvent)
 
         # Try to override an existing attribute.
         with self.assertRaises(RuntimeError):
             pub.on_a.define_event("foo", MyFoo)
 
     def test_event_key_roundtrip(self):
-        class MyEvent(EventBase):
+        class MyEvent(ops.EventBase):
             def __init__(self, handle, value):
                 super().__init__(handle)
                 self.value = value
 
             def snapshot(self):
                 return self.value
 
             def restore(self, value):
                 self.value = value
 
-        class MyNotifier(Object):
-            foo = EventSource(MyEvent)
+        class MyNotifier(ops.Object):
+            foo = ops.EventSource(MyEvent)
 
-        class MyObserver(Object):
+        class MyObserver(ops.Object):
             has_deferred = False
 
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.seen = []
 
             def _on_foo(self, event):
@@ -764,59 +747,59 @@
         self.assertEqual(obs2.seen, [('4', 'second'), ('1', 'first')])
 
     def test_helper_properties(self):
         framework = self.create_framework()
         framework.model = 'test-model'
         framework.meta = 'test-meta'
 
-        my_obj = Object(framework, 'my_obj')
+        my_obj = ops.Object(framework, 'my_obj')
         self.assertEqual(my_obj.model, framework.model)
 
     def test_ban_concurrent_frameworks(self):
         f = self.create_framework(tmpdir=self.tmpdir)
         with self.assertRaises(Exception) as cm:
             self.create_framework(tmpdir=self.tmpdir)
         self.assertIn('database is locked', str(cm.exception))
         f.close()
 
     def test_snapshot_saving_restricted_to_simple_types(self):
         # this can not be saved, as it has not simple types!
         to_be_saved = {"bar": TestFramework}
 
-        class FooEvent(EventBase):
+        class FooEvent(ops.EventBase):
             def snapshot(self):
                 return to_be_saved
 
-        handle = Handle(None, "a_foo", "some_key")
+        handle = ops.Handle(None, "a_foo", "some_key")
         event = FooEvent(handle)
 
         framework = self.create_framework()
         framework.register_type(FooEvent, None, handle.kind)
         with self.assertRaises(ValueError) as cm:
             framework.save_snapshot(event)
         expected = (
             "unable to save the data for FooEvent, it must contain only simple types: "
             "{'bar': <class 'test.test_framework.TestFramework'>}")
         self.assertEqual(str(cm.exception), expected)
 
     def test_unobserved_events_dont_leave_cruft(self):
-        class FooEvent(EventBase):
+        class FooEvent(ops.EventBase):
             def snapshot(self):
                 return {'content': 1}
 
-        class Events(ObjectEvents):
-            foo = EventSource(FooEvent)
+        class Events(ops.ObjectEvents):
+            foo = ops.EventSource(FooEvent)
 
-        class Emitter(Object):
+        class Emitter(ops.Object):
             on = Events()
 
         framework = self.create_framework()
         e = Emitter(framework, 'key')
         e.on.foo.emit()
-        ev_1_handle = Handle(e.on, "foo", "1")
+        ev_1_handle = ops.Handle(e.on, "foo", "1")
         with self.assertRaises(NoSnapshotError):
             framework.load_snapshot(ev_1_handle)
         # Committing will save the framework's state, but no other snapshots should be saved
         framework.commit()
         events = framework._storage.list_snapshots()
         self.assertEqual(list(events), [framework._stored.handle.path])
 
@@ -835,35 +818,35 @@
             self.assertIsNotNone(regex.match(e))
         for e in non_examples:
             self.assertIsNone(regex.match(e))
 
     def test_remove_unreferenced_events(self):
         framework = self.create_framework()
 
-        class Evt(EventBase):
+        class Evt(ops.EventBase):
             pass
 
-        class Events(ObjectEvents):
-            event = EventSource(Evt)
+        class Events(ops.ObjectEvents):
+            event = ops.EventSource(Evt)
 
-        class ObjectWithStorage(Object):
-            _stored = StoredState()
+        class ObjectWithStorage(ops.Object):
+            _stored = ops.StoredState()
             on = Events()
 
             def __init__(self, framework, key):
                 super().__init__(framework, key)
                 self._stored.set_default(foo=2)
                 self.framework.observe(self.on.event, self._on_event)
 
             def _on_event(self, event):
                 event.defer()
 
         # This is an event that 'happened in the past' that doesn't have an associated notice.
         o = ObjectWithStorage(framework, 'obj')
-        handle = Handle(o.on, 'event', '100')
+        handle = ops.Handle(o.on, 'event', '100')
         event = Evt(handle)
         framework.save_snapshot(event)
         self.assertEqual(list(framework._storage.list_snapshots()), [handle.path])
         o.on.event.emit()
         self.assertEqual(
             list(framework._storage.notices('')),
             [('ObjectWithStorage[obj]/on/event[1]', 'ObjectWithStorage[obj]', '_on_event')])
@@ -886,71 +869,79 @@
 class TestStoredState(BaseTestCase):
 
     def setUp(self):
         self.tmpdir = Path(tempfile.mkdtemp())
         self.addCleanup(shutil.rmtree, str(self.tmpdir))
 
     def test_stored_dict_repr(self):
-        self.assertEqual(repr(StoredDict(None, {})), "ops.framework.StoredDict()")
-        self.assertEqual(repr(StoredDict(None, {"a": 1})), "ops.framework.StoredDict({'a': 1})")
+        self.assertEqual(repr(ops.StoredDict(None, {})), "ops.framework.StoredDict()")
+        self.assertEqual(
+            repr(
+                ops.StoredDict(
+                    None, {
+                        "a": 1})), "ops.framework.StoredDict({'a': 1})")
 
     def test_stored_list_repr(self):
-        self.assertEqual(repr(StoredList(None, [])), "ops.framework.StoredList()")
-        self.assertEqual(repr(StoredList(None, [1, 2, 3])), 'ops.framework.StoredList([1, 2, 3])')
+        self.assertEqual(repr(ops.StoredList(None, [])), "ops.framework.StoredList()")
+        self.assertEqual(
+            repr(
+                ops.StoredList(
+                    None, [
+                        1, 2, 3])), 'ops.framework.StoredList([1, 2, 3])')
 
     def test_stored_set_repr(self):
-        self.assertEqual(repr(StoredSet(None, set())), 'ops.framework.StoredSet()')
-        self.assertEqual(repr(StoredSet(None, {1})), 'ops.framework.StoredSet({1})')
+        self.assertEqual(repr(ops.StoredSet(None, set())), 'ops.framework.StoredSet()')
+        self.assertEqual(repr(ops.StoredSet(None, {1})), 'ops.framework.StoredSet({1})')
 
     def test_basic_state_storage(self):
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
         self._stored_state_tests(SomeObject)
 
     def test_straight_subclass(self):
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
         class Sub(SomeObject):
             pass
 
         self._stored_state_tests(Sub)
 
     def test_straight_sub_subclass(self):
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
         class Sub(SomeObject):
             pass
 
         class SubSub(SomeObject):
             pass
 
         self._stored_state_tests(SubSub)
 
     def test_two_subclasses(self):
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
         class SubA(SomeObject):
             pass
 
         class SubB(SomeObject):
             pass
 
         self._stored_state_tests(SubA)
         self._stored_state_tests(SubB)
 
     def test_the_crazy_thing(self):
-        class NoState(Object):
+        class NoState(ops.Object):
             pass
 
         class StatedObject(NoState):
-            _stored = StoredState()
+            _stored = ops.StoredState()
 
         class Sibling(NoState):
             pass
 
         class FinalChild(StatedObject, Sibling):
             pass
 
@@ -996,16 +987,16 @@
         self.assertEqual(obj_copy._stored.bar, "s")
         self.assertEqual(obj_copy._stored.baz, 4.2)
         self.assertEqual(obj_copy._stored.bing, True)
 
         framework_copy.close()
 
     def test_two_subclasses_no_conflicts(self):
-        class Base(Object):
-            _stored = StoredState()
+        class Base(ops.Object):
+            _stored = ops.StoredState()
 
         class SubA(Base):
             pass
 
         class SubB(Base):
             pass
 
@@ -1027,16 +1018,16 @@
         z2 = Base(framework2, None)
 
         self.assertEqual(a2._stored.foo, 42)
         self.assertEqual(b2._stored.foo, "hello")
         self.assertEqual(z2._stored.foo, {1})
 
     def test_two_names_one_state(self):
-        class Mine(Object):
-            _stored = StoredState()
+        class Mine(ops.Object):
+            _stored = ops.StoredState()
             _stored2 = _stored
 
         framework = self.create_framework()
         obj = Mine(framework, None)
 
         with self.assertRaises(RuntimeError):
             obj._stored.foo = 42
@@ -1047,19 +1038,19 @@
         framework.close()
 
         # make sure we're not changing the object on failure
         self.assertNotIn("_stored", obj.__dict__)
         self.assertNotIn("_stored2", obj.__dict__)
 
     def test_same_name_two_classes(self):
-        class Base(Object):
+        class Base(ops.Object):
             pass
 
         class A(Base):
-            _stored = StoredState()
+            _stored = ops.StoredState()
 
         class B(Base):
             _stored = A._stored
 
         framework = self.create_framework()
         a = A(framework, None)
         b = B(framework, None)
@@ -1075,16 +1066,16 @@
 
         # make sure we're not changing the object on failure
         self.assertNotIn("_stored", b.__dict__)
 
     def test_mutable_types_invalid(self):
         framework = self.create_framework()
 
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
         obj = SomeObject(framework, '1')
         try:
             class CustomObject:
                 pass
             obj._stored.foo = CustomObject()
         except AttributeError as e:
@@ -1157,40 +1148,40 @@
         ), (
             lambda: ['a'],
             ['c'],
             ['a', ['c']],
             lambda a, b: a.append(b),
             lambda res, expected_res: (
                 self.assertEqual(res, expected_res),
-                self.assertIsInstance(res[1], StoredList),
+                self.assertIsInstance(res[1], ops.StoredList),
             )
         ), (
             lambda: ['a', ['c']],
             'b',
             ['b', 'a', ['c']],
             lambda a, b: a.insert(0, b),
             lambda res, expected_res: self.assertEqual(res, expected_res)
         ), (
             lambda: ['b', 'a', ['c']],
             ['d'],
             ['b', ['d'], 'a', ['c']],
             lambda a, b: a.insert(1, b),
             lambda res, expected_res: (
                 self.assertEqual(res, expected_res),
-                self.assertIsInstance(res[1], StoredList)
+                self.assertIsInstance(res[1], ops.StoredList)
             ),
         ), (
             lambda: ['b', 'a', ['c']],
             ['d'],
             ['b', ['d'], ['c']],
             # a[1] = b
             lambda a, b: a.__setitem__(1, b),
             lambda res, expected_res: (
                 self.assertEqual(res, expected_res),
-                self.assertIsInstance(res[1], StoredList)
+                self.assertIsInstance(res[1], ops.StoredList)
             ),
         ), (
             lambda: ['b', ['d'], 'a', ['c']],
             0,
             [['d'], 'a', ['c']],
             lambda a, b: a.pop(b),
             lambda res, expected_res: self.assertEqual(res, expected_res)
@@ -1247,18 +1238,18 @@
             {'a'},
             set(),
             # Nested sets are not allowed as sets themselves are not hashable.
             lambda a, b: self.assertRaises(TypeError, a.add, b),
             lambda res, expected_res: self.assertEqual(res, expected_res)
         )]
 
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
-        class WrappedFramework(Framework):
+        class WrappedFramework(ops.Framework):
             def __init__(self, store, charm_dir, meta, model, event_name):
                 super().__init__(store, charm_dir, meta, model, event_name)
                 self.snapshots = []
 
             def save_snapshot(self, value):
                 if value.handle.path == 'SomeObject[1]/StoredStateData[_stored]':
                     self.snapshots.append((type(value), value.snapshot()))
@@ -1267,24 +1258,24 @@
         # Validate correctness of modification operations.
         for get_a, b, expected_res, op, validate_op in test_operations:
             storage = SQLiteStorage(self.tmpdir / "framework.data")
             framework = WrappedFramework(storage, self.tmpdir, None, None, "foo")
             obj = SomeObject(framework, '1')
 
             obj._stored.a = get_a()
-            self.assertTrue(isinstance(obj._stored, BoundStoredState))
+            self.assertTrue(isinstance(obj._stored, ops.BoundStoredState))
 
             op(obj._stored.a, b)
             validate_op(obj._stored.a, expected_res)
 
             obj._stored.a = get_a()
             framework.commit()
             # We should see an update for initializing a
             self.assertEqual(framework.snapshots, [
-                (StoredStateData, {'a': get_a()}),
+                (ops.StoredStateData, {'a': get_a()}),
             ])
             del obj
             gc.collect()
             obj_copy1 = SomeObject(framework, '1')
             self.assertEqual(obj_copy1._stored.a, get_a())
 
             op(obj_copy1._stored.a, b)
@@ -1384,16 +1375,16 @@
             [1, 2, 5, 8],
             [1, 2, 5, 6, 10],
             lambda a, b: a >= b,
             True,
             False
         )]
 
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
         framework = self.create_framework()
 
         for i, (a, b, op, op_ab, op_ba) in enumerate(test_operations):
             obj = SomeObject(framework, str(i))
             obj._stored.a = a
             self.assertEqual(op(obj._stored.a, b), op_ab)
@@ -1423,16 +1414,16 @@
         ), (
             set(),
             lambda a, b: set(a),
             {"a", "b"},
             set()
         )]
 
-        class SomeObject(Object):
-            _stored = StoredState()
+        class SomeObject(ops.Object):
+            _stored = ops.StoredState()
 
         framework = self.create_framework()
 
         # Validate that operations between StoredSet and built-in sets
         # only result in built-in sets being returned.
         # Make sure that commutativity is preserved and that the
         # original sets are not changed or used as a result.
@@ -1455,16 +1446,16 @@
                 self.assertIsNot(result, b)
                 self.assertEqual(a, old_a)
                 self.assertEqual(b, old_b)
 
     def test_set_default(self):
         framework = self.create_framework()
 
-        class StatefulObject(Object):
-            _stored = StoredState()
+        class StatefulObject(ops.Object):
+            _stored = ops.StoredState()
         parent = StatefulObject(framework, 'key')
         parent._stored.set_default(foo=1)
         self.assertEqual(parent._stored.foo, 1)
         parent._stored.set_default(foo=2)
         # foo was already set, so it doesn't get replaced
         self.assertEqual(parent._stored.foo, 1)
         parent._stored.set_default(foo=3, bar=4)
@@ -1477,15 +1468,15 @@
         parent._stored.set_default(foo=5, bar=6)
         self.assertEqual(parent._stored.foo, 1)
         self.assertEqual(parent._stored.bar, 4)
         # TODO: jam 2020-01-30 is there a clean way to tell that
         #       parent._stored._data.dirty is False?
 
 
-class GenericObserver(Object):
+class GenericObserver(ops.Object):
     """Generic observer for the tests."""
 
     def __init__(self, parent, key):
         super().__init__(parent, key)
         self.called = False
 
     def callback_method(self, event):
@@ -1715,41 +1706,41 @@
             framework = self.create_framework()
         self.assertEqual(framework._juju_debug_at, {'foo', 'bar', 'all'})
 
     def test_basic_interruption_enabled(self):
         framework = self.create_framework()
         framework._juju_debug_at = {'hook'}
 
-        publisher = charm.CharmEvents(framework, "1")
+        publisher = ops.CharmEvents(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.install, observer.callback_method)
 
         with patch('sys.stderr', new_callable=io.StringIO) as fake_stderr:
             with patch('pdb.runcall') as mock:
                 publisher.install.emit()
 
         # Check that the pdb module was used correctly and that the callback method was NOT
         # called (as we intercepted the normal pdb behaviour! this is to check that the
         # framework didn't call the callback directly)
         self.assertEqual(mock.call_count, 1)
         expected_callback, expected_event = mock.call_args[0]
         self.assertEqual(expected_callback, observer.callback_method)
-        self.assertIsInstance(expected_event, EventBase)
+        self.assertIsInstance(expected_event, ops.EventBase)
         self.assertFalse(observer.called)
 
         # Verify proper message was given to the user.
         self.assertEqual(fake_stderr.getvalue(), _BREAKPOINT_WELCOME_MESSAGE)
 
     def test_interruption_enabled_with_all(self):
         test_model = self.create_model()
         framework = self.create_framework(model=test_model)
         framework._juju_debug_at = {'all'}
 
-        class CustomEvents(ObjectEvents):
-            foobar_action = EventSource(charm.ActionEvent)
+        class CustomEvents(ops.ObjectEvents):
+            foobar_action = ops.EventSource(ops.ActionEvent)
 
         publisher = CustomEvents(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.foobar_action, observer.callback_method)
         fake_script(self, 'action-get', "echo {}")
 
         with patch('sys.stderr', new_callable=io.StringIO):
@@ -1761,16 +1752,16 @@
         self.assertFalse(observer.called)
 
     def test_actions_are_interrupted(self):
         test_model = self.create_model()
         framework = self.create_framework(model=test_model)
         framework._juju_debug_at = {'hook'}
 
-        class CustomEvents(ObjectEvents):
-            foobar_action = EventSource(charm.ActionEvent)
+        class CustomEvents(ops.ObjectEvents):
+            foobar_action = ops.EventSource(ops.ActionEvent)
 
         publisher = CustomEvents(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.foobar_action, observer.callback_method)
         fake_script(self, 'action-get', "echo {}")
 
         with patch('sys.stderr', new_callable=io.StringIO):
@@ -1778,17 +1769,17 @@
                 with patch.dict(os.environ, {'JUJU_ACTION_NAME': 'foobar'}):
                     publisher.foobar_action.emit()
 
         self.assertEqual(mock.call_count, 1)
         self.assertFalse(observer.called)
 
     def test_internal_events_not_interrupted(self):
-        class MyNotifier(Object):
+        class MyNotifier(ops.Object):
             """Generic notifier for the tests."""
-            bar = EventSource(EventBase)
+            bar = ops.EventSource(ops.EventBase)
 
         framework = self.create_framework()
         framework._juju_debug_at = {'hook'}
 
         publisher = MyNotifier(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.bar, observer.callback_method)
@@ -1799,72 +1790,72 @@
         self.assertEqual(mock.call_count, 0)
         self.assertTrue(observer.called)
 
     def test_envvar_mixed(self):
         framework = self.create_framework()
         framework._juju_debug_at = {'foo', 'hook', 'all', 'whatever'}
 
-        publisher = charm.CharmEvents(framework, "1")
+        publisher = ops.CharmEvents(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.install, observer.callback_method)
 
         with patch('sys.stderr', new_callable=io.StringIO):
             with patch('pdb.runcall') as mock:
                 publisher.install.emit()
 
         self.assertEqual(mock.call_count, 1)
         self.assertFalse(observer.called)
 
     def test_no_registered_method(self):
         framework = self.create_framework()
         framework._juju_debug_at = {'hook'}
 
-        publisher = charm.CharmEvents(framework, "1")
+        publisher = ops.CharmEvents(framework, "1")
         observer = GenericObserver(framework, "1")
 
         with patch('pdb.runcall') as mock:
             publisher.install.emit()
 
         self.assertEqual(mock.call_count, 0)
         self.assertFalse(observer.called)
 
     def test_envvar_nohook(self):
         framework = self.create_framework()
         framework._juju_debug_at = {'something-else'}
 
-        publisher = charm.CharmEvents(framework, "1")
+        publisher = ops.CharmEvents(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.install, observer.callback_method)
 
         with patch.dict(os.environ, {'JUJU_DEBUG_AT': 'something-else'}):
             with patch('pdb.runcall') as mock:
                 publisher.install.emit()
 
         self.assertEqual(mock.call_count, 0)
         self.assertTrue(observer.called)
 
     def test_envvar_missing(self):
         framework = self.create_framework()
         framework._juju_debug_at = set()
 
-        publisher = charm.CharmEvents(framework, "1")
+        publisher = ops.CharmEvents(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.install, observer.callback_method)
 
         with patch('pdb.runcall') as mock:
             publisher.install.emit()
 
         self.assertEqual(mock.call_count, 0)
         self.assertTrue(observer.called)
 
     def test_welcome_message_not_multiple(self):
         framework = self.create_framework()
         framework._juju_debug_at = {'hook'}
 
-        publisher = charm.CharmEvents(framework, "1")
+        publisher = ops.CharmEvents(framework, "1")
         observer = GenericObserver(framework, "1")
         framework.observe(publisher.install, observer.callback_method)
 
         with patch('sys.stderr', new_callable=io.StringIO) as fake_stderr:
             with patch('pdb.runcall') as mock:
                 publisher.install.emit()
                 self.assertEqual(fake_stderr.getvalue(), _BREAKPOINT_WELCOME_MESSAGE)
```

### Comparing `ops-2.1.1/test/test_helpers.py` & `ops-2.2.0/test/test_helpers.py`

 * *Files 5% similar despite different names*

```diff
@@ -15,17 +15,16 @@
 import os
 import pathlib
 import shutil
 import subprocess
 import tempfile
 import unittest
 
-from ops.charm import CharmMeta
-from ops.framework import Framework
-from ops.model import Model, _ModelBackend
+import ops
+from ops.model import _ModelBackend
 from ops.storage import SQLiteStorage
 
 
 def fake_script(test_case, name, content):
     if not hasattr(test_case, 'fake_script_path'):
         fake_script_path = tempfile.mkdtemp('-fake_script')
         old_path = os.environ["PATH"]
@@ -116,21 +115,21 @@
         if tmpdir is None:
             data_fpath = ":memory:"
             charm_dir = 'non-existant'
         else:
             data_fpath = tmpdir / "framework.data"
             charm_dir = tmpdir
 
-        framework = Framework(
+        framework = ops.Framework(
             SQLiteStorage(data_fpath),
             charm_dir,
             meta=None,
             model=model)
         self.addCleanup(framework.close)
         return framework
 
     def create_model(self):
         """Create a Model object."""
         backend = _ModelBackend(unit_name='myapp/0')
-        meta = CharmMeta()
-        model = Model(meta, backend)
+        meta = ops.CharmMeta()
+        model = ops.Model(meta, backend)
         return model
```

### Comparing `ops-2.1.1/test/test_infra.py` & `ops-2.2.0/test/test_infra.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/test/test_jujuversion.py` & `ops-2.2.0/test/test_jujuversion.py`

 * *Files 6% similar despite different names*

```diff
@@ -11,15 +11,15 @@
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 import os
 import unittest.mock  # in this file, importing just 'patch' would be confusing
 
-from ops.jujuversion import JujuVersion
+import ops
 
 
 class TestJujuVersion(unittest.TestCase):
 
     def test_parsing(self):
         test_cases = [
             ("0.0.0", 0, 0, '', 0, 0),
@@ -30,52 +30,52 @@
             ("10.234.3456.1", 10, 234, '', 3456, 1),
             ("1.21-alpha12", 1, 21, 'alpha', 12, 0),
             ("1.21-alpha1.34", 1, 21, 'alpha', 1, 34),
             ("2.7", 2, 7, '', 0, 0)
         ]
 
         for vs, major, minor, tag, patch, build in test_cases:
-            v = JujuVersion(vs)
+            v = ops.JujuVersion(vs)
             self.assertEqual(v.major, major)
             self.assertEqual(v.minor, minor)
             self.assertEqual(v.tag, tag)
             self.assertEqual(v.patch, patch)
             self.assertEqual(v.build, build)
 
     @unittest.mock.patch('os.environ', new={})
     def test_from_environ(self):
         # JUJU_VERSION is not set
-        v = JujuVersion.from_environ()
-        self.assertEqual(v, JujuVersion('0.0.0'))
+        v = ops.JujuVersion.from_environ()
+        self.assertEqual(v, ops.JujuVersion('0.0.0'))
 
         os.environ['JUJU_VERSION'] = 'no'
         with self.assertRaisesRegex(RuntimeError, 'not a valid Juju version'):
-            JujuVersion.from_environ()
+            ops.JujuVersion.from_environ()
 
         os.environ['JUJU_VERSION'] = '2.8.0'
-        v = JujuVersion.from_environ()
-        self.assertEqual(v, JujuVersion('2.8.0'))
+        v = ops.JujuVersion.from_environ()
+        self.assertEqual(v, ops.JujuVersion('2.8.0'))
 
     def test_has_app_data(self):
-        self.assertTrue(JujuVersion('2.8.0').has_app_data())
-        self.assertTrue(JujuVersion('2.7.0').has_app_data())
-        self.assertFalse(JujuVersion('2.6.9').has_app_data())
+        self.assertTrue(ops.JujuVersion('2.8.0').has_app_data())
+        self.assertTrue(ops.JujuVersion('2.7.0').has_app_data())
+        self.assertFalse(ops.JujuVersion('2.6.9').has_app_data())
 
     def test_is_dispatch_aware(self):
-        self.assertTrue(JujuVersion('2.8.0').is_dispatch_aware())
-        self.assertFalse(JujuVersion('2.7.9').is_dispatch_aware())
+        self.assertTrue(ops.JujuVersion('2.8.0').is_dispatch_aware())
+        self.assertFalse(ops.JujuVersion('2.7.9').is_dispatch_aware())
 
     def test_has_controller_storage(self):
-        self.assertTrue(JujuVersion('2.8.0').has_controller_storage())
-        self.assertFalse(JujuVersion('2.7.9').has_controller_storage())
+        self.assertTrue(ops.JujuVersion('2.8.0').has_controller_storage())
+        self.assertFalse(ops.JujuVersion('2.7.9').has_controller_storage())
 
     def test_has_secrets(self):
-        self.assertTrue(JujuVersion('3.0.2').has_secrets)
-        self.assertFalse(JujuVersion('3.0.1').has_secrets)
-        self.assertFalse(JujuVersion('2.9.30').has_secrets)
+        self.assertTrue(ops.JujuVersion('3.0.2').has_secrets)
+        self.assertFalse(ops.JujuVersion('3.0.1').has_secrets)
+        self.assertFalse(ops.JujuVersion('2.9.30').has_secrets)
 
     def test_parsing_errors(self):
         invalid_versions = [
             "xyz",
             "foo.bar",
             "foo.bar.baz",
             "dead.beef.ca.fe",
@@ -86,15 +86,15 @@
             "1.21-alpha1beta",    # Non-numeric string after the patch number.
             "1.21-alpha-dev",     # Tag duplication.
             "1.21-alpha_dev3",    # Underscore in a tag.
             "1.21-alpha123dev3",  # Non-numeric string after the patch number.
         ]
         for v in invalid_versions:
             with self.assertRaises(RuntimeError):
-                JujuVersion(v)
+                ops.JujuVersion(v)
 
     def test_equality(self):
         test_cases = [
             ("1.0.0", "1.0.0", True),
             ("01.0.0", "1.0.0", True),
             ("10.0.0", "9.0.0", False),
             ("1.0.0", "1.0.1", False),
@@ -114,16 +114,16 @@
             ("2.0.0.0", "2.0.0", True),
             ("2.0.0.0", "2.0.0.0", True),
             ("2.0.0.1", "2.0.0.0", False),
             ("2.0.1.10", "2.0.0.0", False),
         ]
 
         for a, b, expected in test_cases:
-            self.assertEqual(JujuVersion(a) == JujuVersion(b), expected)
-            self.assertEqual(JujuVersion(a) == b, expected)
+            self.assertEqual(ops.JujuVersion(a) == ops.JujuVersion(b), expected)
+            self.assertEqual(ops.JujuVersion(a) == b, expected)
 
     def test_comparison(self):
         test_cases = [
             ("1.0.0", "1.0.0", False, True),
             ("01.0.0", "1.0.0", False, True),
             ("10.0.0", "9.0.0", False, False),
             ("1.0.0", "1.0.1", True, True),
@@ -145,16 +145,16 @@
             ("2.0.0.1", "2.0.0.0", False, False),
             ("2.0.1.10", "2.0.0.0", False, False),
             ("2.10.0", "2.8.0", False, False),
         ]
 
         for a, b, expected_strict, expected_weak in test_cases:
             with self.subTest(a=a, b=b):
-                self.assertEqual(JujuVersion(a) < JujuVersion(b), expected_strict)
-                self.assertEqual(JujuVersion(a) <= JujuVersion(b), expected_weak)
-                self.assertEqual(JujuVersion(b) > JujuVersion(a), expected_strict)
-                self.assertEqual(JujuVersion(b) >= JujuVersion(a), expected_weak)
+                self.assertEqual(ops.JujuVersion(a) < ops.JujuVersion(b), expected_strict)
+                self.assertEqual(ops.JujuVersion(a) <= ops.JujuVersion(b), expected_weak)
+                self.assertEqual(ops.JujuVersion(b) > ops.JujuVersion(a), expected_strict)
+                self.assertEqual(ops.JujuVersion(b) >= ops.JujuVersion(a), expected_weak)
                 # Implicit conversion.
-                self.assertEqual(JujuVersion(a) < b, expected_strict)
-                self.assertEqual(JujuVersion(a) <= b, expected_weak)
-                self.assertEqual(b > JujuVersion(a), expected_strict)
-                self.assertEqual(b >= JujuVersion(a), expected_weak)
+                self.assertEqual(ops.JujuVersion(a) < b, expected_strict)
+                self.assertEqual(ops.JujuVersion(a) <= b, expected_weak)
+                self.assertEqual(b > ops.JujuVersion(a), expected_strict)
+                self.assertEqual(b >= ops.JujuVersion(a), expected_weak)
```

### Comparing `ops-2.1.1/test/test_lib.py` & `ops-2.2.0/test/test_lib.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/test/test_log.py` & `ops-2.2.0/test/test_log.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/test/test_main.py` & `ops-2.2.0/test/test_main.py`

 * *Files 4% similar despite different names*

```diff
@@ -24,56 +24,28 @@
 import unittest
 import warnings
 from pathlib import Path
 from unittest.mock import patch
 
 import logassert
 
-from ops.charm import (
-    ActionEvent,
-    CharmBase,
-    CharmEvents,
-    CharmMeta,
-    CollectMetricsEvent,
-    ConfigChangedEvent,
-    HookEvent,
-    InstallEvent,
-    LeaderSettingsChangedEvent,
-    PebbleReadyEvent,
-    RelationBrokenEvent,
-    RelationChangedEvent,
-    RelationDepartedEvent,
-    RelationEvent,
-    RelationJoinedEvent,
-    SecretChangedEvent,
-    SecretEvent,
-    SecretExpiredEvent,
-    SecretRemoveEvent,
-    SecretRotateEvent,
-    StartEvent,
-    StorageAttachedEvent,
-    UpdateStatusEvent,
-    UpgradeCharmEvent,
-    WorkloadEvent,
-)
-from ops.framework import Framework, LifecycleEvent, StoredStateData
-from ops.main import CHARM_STATE_FILE, _should_use_controller_storage, main
+import ops
+from ops.main import CHARM_STATE_FILE, _should_use_controller_storage
 from ops.storage import SQLiteStorage
-from ops.version import version
 
 from .charms.test_main.src.charm import MyCharmEvents
 from .test_helpers import fake_script, fake_script_calls
 
 # This relies on the expected repository structure to find a path to
 # source of the charm under test.
 TEST_CHARM_DIR = Path(f"{__file__}/../charms/test_main").resolve()
 
 VERSION_LOGLINE = [
     'juju-log', '--log-level', 'DEBUG', '--',
-    f'Operator Framework {version} up and running.',
+    f'Operator Framework {ops.__version__} up and running.',
 ]
 
 logger = logging.getLogger(__name__)
 
 
 class SymlinkTargetError(Exception):
     pass
@@ -101,26 +73,26 @@
 
 
 @patch('ops.main.setup_root_logging', new=lambda *a, **kw: None)
 class CharmInitTestCase(unittest.TestCase):
 
     @patch('sys.stderr', new_callable=io.StringIO)
     def test_breakpoint(self, fake_stderr):
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             pass
         self._check(MyCharm, extra_environ={'JUJU_DEBUG_AT': 'all'})
 
         with patch('pdb.Pdb.set_trace') as mock:
             breakpoint()
 
         self.assertEqual(mock.call_count, 1)
         self.assertIn('Starting pdb to debug charm operator', fake_stderr.getvalue())
 
     def test_no_debug_breakpoint(self):
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             pass
         self._check(MyCharm, extra_environ={'JUJU_DEBUG_AT': ''})
 
         with patch('pdb.Pdb.set_trace') as mock:
             breakpoint()
 
         self.assertEqual(mock.call_count, 0)
@@ -140,38 +112,38 @@
                     with tempfile.TemporaryDirectory() as tmpdirname:
                         tmpdirname = Path(tmpdirname)
                         fake_metadata = tmpdirname / 'metadata.yaml'
                         with fake_metadata.open('wb') as fh:
                             fh.write(b'name: test')
                         mock_charmdir.return_value = tmpdirname
 
-                        main(charm_class, **kwargs)
+                        ops.main(charm_class, **kwargs)
 
     def test_init_signature_passthrough(self):
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
 
             def __init__(self, *args):
                 super().__init__(*args)
 
         with warnings.catch_warnings(record=True) as warn_cm:
             self._check(MyCharm)
         self.assertEqual(warn_cm, [])
 
     def test_init_signature_old_key_argument(self):
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
 
             def __init__(self, framework, somekey):
                 super().__init__(framework, somekey)
 
         # Support for "key" has been deprecated since ops 0.7 and was removed in 2.0
         with self.assertRaises(TypeError):
             self._check(MyCharm)
 
     def test_init_signature_only_framework(self):
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
 
             def __init__(self, framework):
                 super().__init__(framework)
 
         with warnings.catch_warnings(record=True) as warn_cm:
             self._check(MyCharm)
         self.assertEqual(warn_cm, [])
@@ -179,37 +151,37 @@
     def test_storage_no_storage(self):
         # here we patch juju_backend_available so it refuses to set it up
         with patch('ops.storage.juju_backend_available') as juju_backend_available:
             juju_backend_available.return_value = False
             with self.assertRaisesRegex(
                     RuntimeError,
                     'charm set use_juju_for_storage=True, but Juju .* does not support it'):
-                self._check(CharmBase, use_juju_for_storage=True)
+                self._check(ops.CharmBase, use_juju_for_storage=True)
 
     def test_storage_with_storage(self):
         # here we patch juju_backend_available, so it gets set up and falls over when used
         with patch('ops.storage.juju_backend_available') as juju_backend_available:
             juju_backend_available.return_value = True
             with self.assertRaisesRegex(FileNotFoundError, 'state-get'):
-                self._check(CharmBase, use_juju_for_storage=True)
+                self._check(ops.CharmBase, use_juju_for_storage=True)
 
     def test_controller_storage_deprecated(self):
         with patch('ops.storage.juju_backend_available') as juju_backend_available:
             juju_backend_available.return_value = True
             with self.assertWarnsRegex(DeprecationWarning, 'Controller storage'):
                 with self.assertRaisesRegex(FileNotFoundError, 'state-get'):
-                    self._check(CharmBase, use_juju_for_storage=True)
+                    self._check(ops.CharmBase, use_juju_for_storage=True)
 
 
 @patch('sys.argv', new=("hooks/config-changed",))
 @patch('ops.main.setup_root_logging', new=lambda *a, **kw: None)
 class TestDispatch(unittest.TestCase):
     def _check(self, *, with_dispatch=False, dispatch_path=''):
         """Helper for below tests."""
-        class MyCharm(CharmBase):
+        class MyCharm(ops.CharmBase):
             def __init__(self, framework):
                 super().__init__(framework)
 
         fake_environ = {
             'JUJU_UNIT_NAME': 'test_main/0',
             'JUJU_MODEL_NAME': 'mymodel',
         }
@@ -229,15 +201,15 @@
                 dispatch.write_text('', encoding='utf8')
                 dispatch.chmod(0o755)
 
             with patch.dict(os.environ, fake_environ):
                 with patch('ops.main._emit_charm_event') as mock_charm_event:
                     with patch('ops.main._get_charm_dir') as mock_charmdir:
                         mock_charmdir.return_value = tmpdir
-                        main(MyCharm)
+                        ops.main(MyCharm)
 
         self.assertEqual(mock_charm_event.call_count, 1)
         return mock_charm_event.call_args[0][1]
 
     def test_most_legacy(self):
         """Without dispatch, sys.argv[0] is used."""
         event = self._check()
@@ -281,20 +253,20 @@
         return NotImplemented
 
     def setUp(self):
         self._setup_charm_dir()
 
         # Relations events are defined dynamically and modify the class attributes.
         # We use a subclass temporarily to prevent these side effects from leaking.
-        class TestCharmEvents(CharmEvents):
+        class TestCharmEvents(ops.CharmEvents):
             pass
-        CharmBase.on = TestCharmEvents()
+        ops.CharmBase.on = TestCharmEvents()
 
         def cleanup():
-            CharmBase.on = CharmEvents()
+            ops.CharmBase.on = ops.CharmEvents()
         self.addCleanup(cleanup)
 
         fake_script(self, 'juju-log', "exit 0")
 
         # set to something other than None for tests that care
         self.stdout = None
         self.stderr = None
@@ -333,33 +305,33 @@
     def _read_and_clear_state(self, event_name: str):
         if self.CHARM_STATE_FILE.stat().st_size:
             storage = SQLiteStorage(self.CHARM_STATE_FILE)
             with (self.JUJU_CHARM_DIR / 'metadata.yaml').open() as m:
                 af = (self.JUJU_CHARM_DIR / 'actions.yaml')
                 if af.exists():
                     with af.open() as a:
-                        meta = CharmMeta.from_yaml(m, a)
+                        meta = ops.CharmMeta.from_yaml(m, a)
                 else:
-                    meta = CharmMeta.from_yaml(m)
-            framework = Framework(storage, self.JUJU_CHARM_DIR, meta, None, event_name)
+                    meta = ops.CharmMeta.from_yaml(m)
+            framework = ops.Framework(storage, self.JUJU_CHARM_DIR, meta, None, event_name)
 
             class ThisCharmEvents(MyCharmEvents):
                 pass
 
             class Charm(self.charm_module.Charm):
                 on = ThisCharmEvents()
 
             mycharm = Charm(framework)
             stored = mycharm._stored
             # Override the saved data with a cleared state
             storage.save_snapshot(stored._data.handle.path, {})
             storage.commit()
             framework.close()
         else:
-            stored = StoredStateData(None, None)
+            stored = ops.StoredStateData(None, None)
         return stored
 
     def _simulate_event(self, event_spec):
         ppath = Path(__file__).parent
         pypath = str(ppath.parent)
         if 'PYTHONPATH' in os.environ:
             pypath += os.pathsep + os.environ['PYTHONPATH']
@@ -368,24 +340,24 @@
             'PATH': os.pathsep.join([str(ppath / 'bin'), env['PATH']]),
             'PYTHONPATH': pypath,
             'JUJU_CHARM_DIR': str(self.JUJU_CHARM_DIR),
             'JUJU_UNIT_NAME': 'test_main/0',
         })
         if event_spec.set_in_env is not None:
             env.update(event_spec.set_in_env)
-        if issubclass(event_spec.event_type, SecretEvent):
+        if issubclass(event_spec.event_type, ops.SecretEvent):
             env.update({
                 'JUJU_SECRET_ID': event_spec.secret_id,
                 'JUJU_SECRET_LABEL': event_spec.secret_label or '',
             })
-        if issubclass(event_spec.event_type, (SecretRemoveEvent, SecretExpiredEvent)):
+        if issubclass(event_spec.event_type, (ops.SecretRemoveEvent, ops.SecretExpiredEvent)):
             env.update({
                 'JUJU_SECRET_REVISION': str(event_spec.secret_revision or ''),
             })
-        if issubclass(event_spec.event_type, RelationEvent):
+        if issubclass(event_spec.event_type, ops.RelationEvent):
             rel_name = event_spec.event_name.split('_')[0]
             env.update({
                 'JUJU_RELATION': rel_name,
                 'JUJU_RELATION_ID': str(event_spec.relation_id),
             })
             remote_app = event_spec.remote_app
             # For juju < 2.7 app name is extracted from JUJU_REMOTE_UNIT.
@@ -402,19 +374,19 @@
                 departing_unit_name = ''
             env['JUJU_DEPARTING_UNIT'] = departing_unit_name
         else:
             env.update({
                 'JUJU_REMOTE_UNIT': '',
                 'JUJU_REMOTE_APP': '',
             })
-        if issubclass(event_spec.event_type, WorkloadEvent):
+        if issubclass(event_spec.event_type, ops.WorkloadEvent):
             env.update({
                 'JUJU_WORKLOAD_NAME': event_spec.workload_name,
             })
-        if issubclass(event_spec.event_type, ActionEvent):
+        if issubclass(event_spec.event_type, ops.ActionEvent):
             event_filename = event_spec.event_name[:-len('_action')].replace('_', '-')
             env.update({
                 event_spec.env_var: event_filename,
             })
             if event_spec.env_var == 'JUJU_ACTION_NAME':
                 event_dir = 'actions'
             else:
@@ -426,179 +398,179 @@
             env['JUJU_MODEL_NAME'] = event_spec.model_name
 
         self._call_event(Path(event_dir, event_filename), env)
         return self._read_and_clear_state(event_spec.event_name)
 
     def test_event_reemitted(self):
         # First run "install" to make sure all hooks are set up.
-        state = self._simulate_event(EventSpec(InstallEvent, 'install'))
+        state = self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
         self.assertEqual(list(state.observed_event_types), ['InstallEvent'])
 
-        state = self._simulate_event(EventSpec(ConfigChangedEvent, 'config-changed'))
+        state = self._simulate_event(EventSpec(ops.ConfigChangedEvent, 'config-changed'))
         self.assertEqual(list(state.observed_event_types), ['ConfigChangedEvent'])
 
         # Re-emit should pick the deferred config-changed.
-        state = self._simulate_event(EventSpec(UpdateStatusEvent, 'update-status'))
+        state = self._simulate_event(EventSpec(ops.UpdateStatusEvent, 'update-status'))
         self.assertEqual(
             list(state.observed_event_types),
             ['ConfigChangedEvent', 'UpdateStatusEvent'])
 
     def test_no_reemission_on_collect_metrics(self):
         fake_script(self, 'add-metric', 'exit 0')
 
         # First run "install" to make sure all hooks are set up.
-        state = self._simulate_event(EventSpec(InstallEvent, 'install'))
+        state = self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
         self.assertEqual(list(state.observed_event_types), ['InstallEvent'])
 
-        state = self._simulate_event(EventSpec(ConfigChangedEvent, 'config-changed'))
+        state = self._simulate_event(EventSpec(ops.ConfigChangedEvent, 'config-changed'))
         self.assertEqual(list(state.observed_event_types), ['ConfigChangedEvent'])
 
         # Re-emit should not pick the deferred config-changed because
         # collect-metrics runs in a restricted context.
-        state = self._simulate_event(EventSpec(CollectMetricsEvent, 'collect-metrics'))
+        state = self._simulate_event(EventSpec(ops.CollectMetricsEvent, 'collect-metrics'))
         self.assertEqual(list(state.observed_event_types), ['CollectMetricsEvent'])
 
     def test_multiple_events_handled(self):
         self._prepare_actions()
 
         fake_script(self, 'action-get', "echo '{}'")
 
         # Sample events with a different amount of dashes used
         # and with endpoints from different sections of metadata.yaml
         events_under_test = [(
-            EventSpec(InstallEvent, 'install'),
+            EventSpec(ops.InstallEvent, 'install'),
             {},
         ), (
-            EventSpec(StartEvent, 'start'),
+            EventSpec(ops.StartEvent, 'start'),
             {},
         ), (
-            EventSpec(UpdateStatusEvent, 'update_status'),
+            EventSpec(ops.UpdateStatusEvent, 'update_status'),
             {},
         ), (
-            EventSpec(LeaderSettingsChangedEvent, 'leader_settings_changed'),
+            EventSpec(ops.LeaderSettingsChangedEvent, 'leader_settings_changed'),
             {},
         ), (
-            EventSpec(RelationJoinedEvent, 'db_relation_joined',
+            EventSpec(ops.RelationJoinedEvent, 'db_relation_joined',
                       relation_id=1,
                       remote_app='remote',
                       remote_unit='remote/0'),
             {'relation_name': 'db',
              'relation_id': 1,
              'app_name': 'remote',
              'unit_name': 'remote/0'},
         ), (
-            EventSpec(RelationChangedEvent, 'mon_relation_changed',
+            EventSpec(ops.RelationChangedEvent, 'mon_relation_changed',
                       relation_id=2,
                       remote_app='remote',
                       remote_unit='remote/0'),
             {'relation_name': 'mon',
              'relation_id': 2,
              'app_name': 'remote',
              'unit_name': 'remote/0'},
         ), (
-            EventSpec(RelationChangedEvent, 'mon_relation_changed',
+            EventSpec(ops.RelationChangedEvent, 'mon_relation_changed',
                       relation_id=2,
                       remote_app='remote',
                       remote_unit=None),
             {'relation_name': 'mon',
              'relation_id': 2,
              'app_name': 'remote',
              'unit_name': None},
         ), (
-            EventSpec(RelationDepartedEvent, 'mon_relation_departed',
+            EventSpec(ops.RelationDepartedEvent, 'mon_relation_departed',
                       relation_id=2,
                       remote_app='remote',
                       remote_unit='remote/0',
                       departing_unit_name='remote/42'),
             {'relation_name': 'mon',
              'relation_id': 2,
              'app_name': 'remote',
              'unit_name': 'remote/0',
              'departing_unit_name': 'remote/42'},
         ), (
-            EventSpec(RelationBrokenEvent, 'ha_relation_broken',
+            EventSpec(ops.RelationBrokenEvent, 'ha_relation_broken',
                       relation_id=3),
             {'relation_name': 'ha',
              'relation_id': 3},
         ), (
             # Events without a remote app specified (for Juju < 2.7).
-            EventSpec(RelationJoinedEvent, 'db_relation_joined',
+            EventSpec(ops.RelationJoinedEvent, 'db_relation_joined',
                       relation_id=1,
                       remote_unit='remote/0'),
             {'relation_name': 'db',
              'relation_id': 1,
              'app_name': 'remote',
              'unit_name': 'remote/0'},
         ), (
-            EventSpec(RelationChangedEvent, 'mon_relation_changed',
+            EventSpec(ops.RelationChangedEvent, 'mon_relation_changed',
                       relation_id=2,
                       remote_unit='remote/0'),
             {'relation_name': 'mon',
              'relation_id': 2,
              'app_name': 'remote',
              'unit_name': 'remote/0'},
         ), (
-            EventSpec(RelationDepartedEvent, 'mon_relation_departed',
+            EventSpec(ops.RelationDepartedEvent, 'mon_relation_departed',
                       relation_id=2,
                       remote_unit='remote/0',
                       departing_unit_name='remote/42'),
             {'relation_name': 'mon',
              'relation_id': 2,
              'app_name': 'remote',
              'unit_name': 'remote/0',
              'departing_unit_name': 'remote/42'},
         ), (
-            EventSpec(ActionEvent, 'start_action',
+            EventSpec(ops.ActionEvent, 'start_action',
                       env_var='JUJU_ACTION_NAME'),
             {},
         ), (
-            EventSpec(ActionEvent, 'foo_bar_action',
+            EventSpec(ops.ActionEvent, 'foo_bar_action',
                       env_var='JUJU_ACTION_NAME'),
             {},
         ), (
-            EventSpec(PebbleReadyEvent, 'test_pebble_ready',
+            EventSpec(ops.PebbleReadyEvent, 'test_pebble_ready',
                       workload_name='test'),
             {'container_name': 'test'},
         ), (
-            EventSpec(SecretChangedEvent, 'secret_changed',
+            EventSpec(ops.SecretChangedEvent, 'secret_changed',
                       secret_id='secret:12345',
                       secret_label='foo'),
             {'id': 'secret:12345',
              'label': 'foo',
              'revision': 42}
         ), (
-            EventSpec(SecretRotateEvent, 'secret_rotate',
+            EventSpec(ops.SecretRotateEvent, 'secret_rotate',
                       secret_id='secret:12345',
                       secret_label='foo',
                       secret_revision='42'),
             {'id': 'secret:12345',
              'label': 'foo',
              'revision': 42}
         ), (
-            EventSpec(SecretRemoveEvent, 'secret_remove',
+            EventSpec(ops.SecretRemoveEvent, 'secret_remove',
                       secret_id='secret:12345',
                       secret_label='foo',
                       secret_revision='42'),
             {'id': 'secret:12345',
              'label': 'foo',
              'revision': 42}
         ), (
-            EventSpec(SecretExpiredEvent, 'secret_expired',
+            EventSpec(ops.SecretExpiredEvent, 'secret_expired',
                       secret_id='secret:12345',
                       secret_label='foo',
                       secret_revision='42'),
             {'id': 'secret:12345',
              'label': 'foo',
              'revision': 42}
         )]
 
         logger.debug('Expected events %s', events_under_test)
 
         # First run "install" to make sure all hooks are set up.
-        self._simulate_event(EventSpec(InstallEvent, 'install'))
+        self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
 
         # Simulate hook executions for every event.
         for event_spec, expected_event_data in events_under_test:
             state = self._simulate_event(event_spec)
 
             state_key = f"on_{event_spec.event_name}"
             handled_events = getattr(state, state_key, [])
@@ -620,48 +592,48 @@
         # Simulate a scenario where there is a symlink for an event that
         # a charm does not know how to handle.
         hook_path = self.JUJU_CHARM_DIR / 'hooks/not-implemented-event'
         # This will be cleared up in tearDown.
         hook_path.symlink_to('install')
 
         try:
-            self._simulate_event(EventSpec(HookEvent, 'not-implemented-event'))
+            self._simulate_event(EventSpec(ops.HookEvent, 'not-implemented-event'))
         except subprocess.CalledProcessError:
             self.fail('Event simulation for an unsupported event'
                       ' results in a non-zero exit code returned')
 
     def test_no_actions(self):
         (self.JUJU_CHARM_DIR / 'actions.yaml').unlink()
-        self._simulate_event(EventSpec(InstallEvent, 'install'))
+        self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
 
     def test_empty_actions(self):
         (self.JUJU_CHARM_DIR / 'actions.yaml').write_text('')
-        self._simulate_event(EventSpec(InstallEvent, 'install'))
+        self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
 
     def test_collect_metrics(self):
         fake_script(self, 'add-metric', 'exit 0')
-        self._simulate_event(EventSpec(InstallEvent, 'install'))
+        self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
         # Clear the calls during 'install'
         fake_script_calls(self, clear=True)
-        self._simulate_event(EventSpec(CollectMetricsEvent, 'collect_metrics'))
+        self._simulate_event(EventSpec(ops.CollectMetricsEvent, 'collect_metrics'))
 
         expected = [
             VERSION_LOGLINE,
             ['juju-log', '--log-level', 'DEBUG', '--', 'Emitting Juju event collect_metrics.'],
             ['add-metric', '--labels', 'bar=4.2', 'foo=42'],
         ]
         calls = fake_script_calls(self)
 
         self.assertEqual(calls, expected)
 
     def test_custom_event(self):
-        self._simulate_event(EventSpec(InstallEvent, 'install'))
+        self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
         # Clear the calls during 'install'
         fake_script_calls(self, clear=True)
-        self._simulate_event(EventSpec(UpdateStatusEvent, 'update-status',
+        self._simulate_event(EventSpec(ops.UpdateStatusEvent, 'update-status',
                                        set_in_env={'EMIT_CUSTOM_EVENT': "1"}))
 
         expected = [
             VERSION_LOGLINE,
             ['juju-log', '--log-level', 'DEBUG', '--', 'Emitting Juju event update_status.'],
             ['juju-log', '--log-level', 'DEBUG', '--', 'Emitting custom event '
                                                        '<CustomEvent via Charm/on/custom[5]>.'],
@@ -669,40 +641,40 @@
         calls = fake_script_calls(self)
         self.assertEqual(expected, calls)
 
     def test_logger(self):
         fake_script(self, 'action-get', "echo '{}'")
 
         test_cases = [(
-            EventSpec(ActionEvent, 'log_critical_action', env_var='JUJU_ACTION_NAME'),
+            EventSpec(ops.ActionEvent, 'log_critical_action', env_var='JUJU_ACTION_NAME'),
             ['juju-log', '--log-level', 'CRITICAL', '--', 'super critical'],
         ), (
-            EventSpec(ActionEvent, 'log_error_action',
+            EventSpec(ops.ActionEvent, 'log_error_action',
                       env_var='JUJU_ACTION_NAME'),
             ['juju-log', '--log-level', 'ERROR', '--', 'grave error'],
         ), (
-            EventSpec(ActionEvent, 'log_warning_action',
+            EventSpec(ops.ActionEvent, 'log_warning_action',
                       env_var='JUJU_ACTION_NAME'),
             ['juju-log', '--log-level', 'WARNING', '--', 'wise warning'],
         ), (
-            EventSpec(ActionEvent, 'log_info_action',
+            EventSpec(ops.ActionEvent, 'log_info_action',
                       env_var='JUJU_ACTION_NAME'),
             ['juju-log', '--log-level', 'INFO', '--', 'useful info'],
         )]
 
         # Set up action symlinks.
-        self._simulate_event(EventSpec(InstallEvent, 'install'))
+        self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
 
         for event_spec, calls in test_cases:
             self._simulate_event(event_spec)
             self.assertIn(calls, fake_script_calls(self, clear=True))
 
     def test_excepthook(self):
         with self.assertRaises(subprocess.CalledProcessError):
-            self._simulate_event(EventSpec(InstallEvent, 'install',
+            self._simulate_event(EventSpec(ops.InstallEvent, 'install',
                                            set_in_env={'TRY_EXCEPTHOOK': '1'}))
 
         calls = [' '.join(i) for i in fake_script_calls(self)]
 
         self.assertEqual(calls.pop(0), ' '.join(VERSION_LOGLINE))
         self.assertRegex(calls.pop(0), 'Using local storage: not a Kubernetes podspec charm')
         self.assertRegex(calls.pop(0), 'Initializing SQLite local storage: ')
@@ -719,35 +691,35 @@
         self.assertEqual(len(calls), 1, f"expected 1 call, but got extra: {calls[1:]}")
 
     def test_sets_model_name(self):
         self._prepare_actions()
 
         fake_script(self, 'action-get', "echo '{}'")
         state = self._simulate_event(EventSpec(
-            ActionEvent, 'get_model_name_action',
+            ops.ActionEvent, 'get_model_name_action',
             env_var='JUJU_ACTION_NAME',
             model_name='test-model-name'))
         self.assertIsNotNone(state)
         self.assertEqual(state._on_get_model_name_action, ['test-model-name'])
 
     def test_has_valid_status(self):
         self._prepare_actions()
 
         fake_script(self, 'action-get', "echo '{}'")
         fake_script(self, 'status-get', """echo '{"status": "unknown", "message": ""}'""")
         state = self._simulate_event(EventSpec(
-            ActionEvent, 'get_status_action',
+            ops.ActionEvent, 'get_status_action',
             env_var='JUJU_ACTION_NAME'))
         self.assertIsNotNone(state)
         self.assertEqual(state.status_name, 'unknown')
         self.assertEqual(state.status_message, '')
         fake_script(
             self, 'status-get', """echo '{"status": "blocked", "message": "help meeee"}'""")
         state = self._simulate_event(EventSpec(
-            ActionEvent, 'get_status_action',
+            ops.ActionEvent, 'get_status_action',
             env_var='JUJU_ACTION_NAME'))
         self.assertIsNotNone(state)
         self.assertEqual(state.status_name, 'blocked')
         self.assertEqual(state.status_message, 'help meeee')
 
 
 class TestMainWithNoDispatch(_TestMain, unittest.TestCase):
@@ -807,21 +779,21 @@
             [sys.executable, str(event_file)],
             check=True, env=env, cwd=str(self.JUJU_CHARM_DIR))
 
     def test_setup_event_links(self):
         """Test auto-creation of symlinks caused by initial events."""
         all_event_hooks = [f"hooks/{name.replace('_', '-')}"
                            for name, event_source in self.charm_module.Charm.on.events().items()
-                           if issubclass(event_source.event_type, LifecycleEvent)]
+                           if issubclass(event_source.event_type, ops.LifecycleEvent)]
 
         initial_events = {
-            EventSpec(InstallEvent, 'install'),
-            EventSpec(StorageAttachedEvent, 'disks-storage-attached'),
-            EventSpec(StartEvent, 'start'),
-            EventSpec(UpgradeCharmEvent, 'upgrade-charm'),
+            EventSpec(ops.InstallEvent, 'install'),
+            EventSpec(ops.StorageAttachedEvent, 'disks-storage-attached'),
+            EventSpec(ops.StartEvent, 'start'),
+            EventSpec(ops.UpgradeCharmEvent, 'upgrade-charm'),
         }
         initial_hooks = {f"hooks/{ev.event_name}" for ev in initial_events}
 
         def _assess_event_links(event_spec):
             self.assertTrue(self.hooks_dir / event_spec.event_name in self.hooks_dir.iterdir())
             for event_hook in all_event_hooks:
                 hook_path = self.JUJU_CHARM_DIR / event_hook
@@ -843,15 +815,15 @@
             self._simulate_event(initial_event)
             _assess_event_links(initial_event)
             # Make sure it is idempotent.
             self._simulate_event(initial_event)
             _assess_event_links(initial_event)
 
     def test_setup_action_links(self):
-        self._simulate_event(EventSpec(InstallEvent, 'install'))
+        self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
         # foo-bar is one of the actions defined in actions.yaml
         action_hook = self.JUJU_CHARM_DIR / 'actions' / 'foo-bar'
         self.assertTrue(action_hook.exists())
 
 
 class TestMainWithNoDispatchButJujuIsDispatchAware(TestMainWithNoDispatch):
     def _call_event(self, rel_path, env):
@@ -882,18 +854,18 @@
         """Test auto-creation of symlinks.
 
         Symlink creation caused by initial events should _not_ happen when using dispatch.
         """
         all_event_hooks = [f"hooks/{e.replace('_', '-')}"
                            for e in self.charm_module.Charm.on.events().keys()]
         initial_events = {
-            EventSpec(InstallEvent, 'install'),
-            EventSpec(StorageAttachedEvent, 'disks-storage-attached'),
-            EventSpec(StartEvent, 'start'),
-            EventSpec(UpgradeCharmEvent, 'upgrade-charm'),
+            EventSpec(ops.InstallEvent, 'install'),
+            EventSpec(ops.StorageAttachedEvent, 'disks-storage-attached'),
+            EventSpec(ops.StartEvent, 'start'),
+            EventSpec(ops.UpgradeCharmEvent, 'upgrade-charm'),
         }
 
         def _assess_event_links(event_spec):
             self.assertNotIn(self.hooks_dir / event_spec.event_name, self.hooks_dir.iterdir())
             for event_hook in all_event_hooks:
                 self.assertFalse((self.JUJU_CHARM_DIR / event_hook).exists(),
                                  f"Spurious hook: {event_hook}")
@@ -904,15 +876,15 @@
             self._simulate_event(initial_event)
             _assess_event_links(initial_event)
 
     def test_hook_and_dispatch(self):
         old_path = self.fake_script_path
         self.fake_script_path = self.hooks_dir
         fake_script(self, 'install', 'exit 0')
-        state = self._simulate_event(EventSpec(InstallEvent, 'install'))
+        state = self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
 
         # the script was called, *and*, the .on. was called
         self.assertEqual(fake_script_calls(self), [['install', '']])
         self.assertEqual(list(state.observed_event_types), ['InstallEvent'])
 
         self.fake_script_path = old_path
         hook = Path('hooks/install')
@@ -929,15 +901,15 @@
         ]
         calls = fake_script_calls(self)
         self.assertRegex(' '.join(calls.pop(-2)), 'Initializing SQLite local storage: ')
         self.assertEqual(calls, expected)
 
     def test_non_executable_hook_and_dispatch(self):
         (self.hooks_dir / "install").write_text("")
-        state = self._simulate_event(EventSpec(InstallEvent, 'install'))
+        state = self._simulate_event(EventSpec(ops.InstallEvent, 'install'))
 
         self.assertEqual(list(state.observed_event_types), ['InstallEvent'])
 
         expected = [
             VERSION_LOGLINE,
             ['juju-log', '--log-level', 'WARNING', '--',
              'Legacy hooks/install exists but is not executable.'],
@@ -953,15 +925,15 @@
     def test_hook_and_dispatch_with_failing_hook(self):
         self.stdout = self.stderr = tempfile.TemporaryFile()
         self.addCleanup(self.stdout.close)
 
         old_path = self.fake_script_path
         self.fake_script_path = self.hooks_dir
         fake_script(self, 'install', 'exit 42')
-        event = EventSpec(InstallEvent, 'install')
+        event = EventSpec(ops.InstallEvent, 'install')
         with self.assertRaises(subprocess.CalledProcessError):
             self._simulate_event(event)
         self.fake_script_path = old_path
 
         self.stdout.seek(0)
         self.assertEqual(self.stdout.read(), b'')
         calls = fake_script_calls(self)
@@ -971,15 +943,15 @@
             ['juju-log', '--log-level', 'INFO', '--', f'Running legacy {hook}.'],
             ['juju-log', '--log-level', 'WARNING', '--',
              f'Legacy {hook} exited with status 42.'],
         ]
         self.assertEqual(calls, expected)
 
     def test_hook_and_dispatch_but_hook_is_dispatch(self):
-        event = EventSpec(InstallEvent, 'install')
+        event = EventSpec(ops.InstallEvent, 'install')
         hook_path = self.hooks_dir / 'install'
         for ((rel, ind), path) in {
                 # relative and indirect
                 (True, True): Path('../dispatch'),
                 # relative and direct
                 (True, False): Path(self.charm_exec_path),
                 # absolute and direct
@@ -1003,15 +975,15 @@
                     hook_path.unlink()
 
     def test_hook_and_dispatch_but_hook_is_dispatch_copy(self):
         hook_path = self.hooks_dir / 'install'
         path = (self.hooks_dir / self.charm_exec_path).resolve()
         shutil.copy(str(path), str(hook_path))
 
-        event = EventSpec(InstallEvent, 'install')
+        event = EventSpec(ops.InstallEvent, 'install')
         state = self._simulate_event(event)
 
         # the .on. was only called once
         self.assertEqual(list(state.observed_event_types), ['InstallEvent'])
         self.assertEqual(list(state.on_install), ['InstallEvent'])
         hook = Path('hooks/install')
         expected = [
@@ -1152,28 +1124,28 @@
 
 
 class TestStorageHeuristics(unittest.TestCase):
     def setUp(self):
         logassert.setup(self, '')
 
     def test_fallback_to_current_juju_version__too_old(self):
-        meta = CharmMeta.from_yaml("series: [kubernetes]")
+        meta = ops.CharmMeta.from_yaml("series: [kubernetes]")
         with patch.dict(os.environ, {"JUJU_VERSION": "1.0"}):
             self.assertFalse(_should_use_controller_storage(Path("/xyzzy"), meta))
             self.assertLogged('Using local storage: JUJU_VERSION=1.0.0')
 
     def test_fallback_to_current_juju_version__new_enough(self):
-        meta = CharmMeta.from_yaml("series: [kubernetes]")
+        meta = ops.CharmMeta.from_yaml("series: [kubernetes]")
         with patch.dict(os.environ, {"JUJU_VERSION": "2.8"}):
             self.assertTrue(_should_use_controller_storage(Path("/xyzzy"), meta))
             self.assertLogged('Using controller storage: JUJU_VERSION=2.8.0')
 
     def test_not_if_not_in_k8s(self):
-        meta = CharmMeta.from_yaml("series: [ecs]")
+        meta = ops.CharmMeta.from_yaml("series: [ecs]")
         with patch.dict(os.environ, {"JUJU_VERSION": "2.8"}):
             self.assertFalse(_should_use_controller_storage(Path("/xyzzy"), meta))
             self.assertLogged('Using local storage: not a Kubernetes podspec charm')
 
     def test_not_if_already_local(self):
-        meta = CharmMeta.from_yaml("series: [kubernetes]")
+        meta = ops.CharmMeta.from_yaml("series: [kubernetes]")
         with patch.dict(os.environ, {"JUJU_VERSION": "2.8"}), tempfile.NamedTemporaryFile() as fd:
             self.assertFalse(_should_use_controller_storage(Path(fd.name), meta))
```

### Comparing `ops-2.1.1/test/test_model.py` & `ops-2.2.0/test/test_model.py`

 * *Files 2% similar despite different names*

```diff
@@ -47,8097 +47,8031 @@
 000002e0: 6572 6564 4469 6374 0a66 726f 6d20 7465  eredDict.from te
 000002f0: 7374 2e74 6573 745f 6865 6c70 6572 7320  st.test_helpers 
 00000300: 696d 706f 7274 2066 616b 655f 7363 7269  import fake_scri
 00000310: 7074 2c20 6661 6b65 5f73 6372 6970 745f  pt, fake_script_
 00000320: 6361 6c6c 730a 6672 6f6d 2074 6578 7477  calls.from textw
 00000330: 7261 7020 696d 706f 7274 2064 6564 656e  rap import deden
 00000340: 740a 0a69 6d70 6f72 7420 7079 7465 7374  t..import pytest
-00000350: 0a0a 696d 706f 7274 206f 7073 2e63 6861  ..import ops.cha
-00000360: 726d 0a69 6d70 6f72 7420 6f70 732e 6d6f  rm.import ops.mo
-00000370: 6465 6c0a 696d 706f 7274 206f 7073 2e74  del.import ops.t
-00000380: 6573 7469 6e67 0a66 726f 6d20 6f70 7320  esting.from ops 
-00000390: 696d 706f 7274 206d 6f64 656c 0a66 726f  import model.fro
-000003a0: 6d20 6f70 732e 5f70 7269 7661 7465 2069  m ops._private i
-000003b0: 6d70 6f72 7420 7961 6d6c 0a66 726f 6d20  mport yaml.from 
-000003c0: 6f70 732e 6368 6172 6d20 696d 706f 7274  ops.charm import
-000003d0: 2052 656c 6174 696f 6e4d 6574 612c 2052   RelationMeta, R
-000003e0: 656c 6174 696f 6e52 6f6c 650a 6672 6f6d  elationRole.from
-000003f0: 206f 7073 2e70 6562 626c 6520 696d 706f   ops.pebble impo
-00000400: 7274 2028 0a20 2020 2041 5049 4572 726f  rt (.    APIErro
-00000410: 722c 0a20 2020 2043 6f6e 6e65 6374 696f  r,.    Connectio
-00000420: 6e45 7272 6f72 2c0a 2020 2020 4669 6c65  nError,.    File
-00000430: 496e 666f 2c0a 2020 2020 4669 6c65 5479  Info,.    FileTy
-00000440: 7065 2c0a 2020 2020 5365 7276 6963 6549  pe,.    ServiceI
-00000450: 6e66 6f2c 0a20 2020 2053 7973 7465 6d49  nfo,.    SystemI
-00000460: 6e66 6f2c 0a29 0a0a 0a63 6c61 7373 2054  nfo,.)...class T
-00000470: 6573 744d 6f64 656c 2875 6e69 7474 6573  estModel(unittes
-00000480: 742e 5465 7374 4361 7365 293a 0a20 2020  t.TestCase):.   
-00000490: 2064 6566 2073 6574 5570 2873 656c 6629   def setUp(self)
-000004a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
-000004b0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
-000004c0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
-000004d0: 2e63 6861 726d 2e43 6861 726d 4261 7365  .charm.CharmBase
-000004e0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-000004f0: 2020 2020 2020 206e 616d 653a 206d 7961         name: mya
-00000500: 7070 0a20 2020 2020 2020 2020 2020 2070  pp.            p
-00000510: 726f 7669 6465 733a 0a20 2020 2020 2020  rovides:.       
-00000520: 2020 2020 2020 2064 6230 3a0a 2020 2020         db0:.    
-00000530: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00000540: 7266 6163 653a 2064 6230 0a20 2020 2020  rface: db0.     
-00000550: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00000560: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
-00000570: 6231 3a0a 2020 2020 2020 2020 2020 2020  b1:.            
-00000580: 2020 2020 696e 7465 7266 6163 653a 2064      interface: d
-00000590: 6231 0a20 2020 2020 2020 2020 2020 2070  b1.            p
-000005a0: 6565 7273 3a0a 2020 2020 2020 2020 2020  eers:.          
-000005b0: 2020 2020 6462 323a 0a20 2020 2020 2020      db2:.       
-000005c0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-000005d0: 6365 3a20 6462 320a 2020 2020 2020 2020  ce: db2.        
-000005e0: 2020 2020 7265 736f 7572 6365 733a 0a20      resources:. 
-000005f0: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
-00000600: 3a20 7b74 7970 653a 2066 696c 652c 2066  : {type: file, f
-00000610: 696c 656e 616d 653a 2066 6f6f 2e74 7874  ilename: foo.txt
-00000620: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00000630: 6261 723a 207b 7479 7065 3a20 6669 6c65  bar: {type: file
-00000640: 2c20 6669 6c65 6e61 6d65 3a20 6261 722e  , filename: bar.
-00000650: 7478 747d 0a20 2020 2020 2020 2027 2727  txt}.        '''
-00000660: 2c20 636f 6e66 6967 3d27 2727 0a20 2020  , config='''.   
-00000670: 2020 2020 206f 7074 696f 6e73 3a0a 2020       options:.  
-00000680: 2020 2020 2020 2020 2020 666f 6f3a 0a20            foo:. 
-00000690: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000006a0: 7970 653a 2073 7472 696e 670a 2020 2020  ype: string.    
-000006b0: 2020 2020 2020 2020 6261 723a 0a20 2020          bar:.   
-000006c0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-000006d0: 653a 2069 6e74 0a20 2020 2020 2020 2020  e: int.         
-000006e0: 2020 2071 7578 3a0a 2020 2020 2020 2020     qux:.        
-000006f0: 2020 2020 2020 2020 7479 7065 3a20 626f          type: bo
-00000700: 6f6c 6561 6e0a 2020 2020 2020 2020 2727  olean.        ''
-00000710: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00000720: 6164 6443 6c65 616e 7570 2873 656c 662e  addCleanup(self.
-00000730: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00000740: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00000750: 6c61 7469 6f6e 5f69 645f 6462 3020 3d20  lation_id_db0 = 
-00000760: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-00000770: 5f72 656c 6174 696f 6e28 2764 6230 272c  _relation('db0',
-00000780: 2027 6462 2729 0a20 2020 2020 2020 2073   'db').        s
-00000790: 656c 662e 6861 726e 6573 732e 5f67 6574  elf.harness._get
-000007a0: 5f62 6163 6b65 6e64 5f63 616c 6c73 2872  _backend_calls(r
-000007b0: 6573 6574 3d54 7275 6529 0a20 2020 2020  eset=True).     
-000007c0: 2020 2073 656c 662e 6d6f 6465 6c20 3d20     self.model = 
-000007d0: 7365 6c66 2e68 6172 6e65 7373 2e6d 6f64  self.harness.mod
-000007e0: 656c 0a0a 2020 2020 6465 6620 7465 7374  el..    def test
-000007f0: 5f6d 6f64 656c 5f61 7474 7269 6275 7465  _model_attribute
-00000800: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-00000810: 2073 656c 662e 6173 7365 7274 4973 2873   self.assertIs(s
-00000820: 656c 662e 6d6f 6465 6c2e 6170 702c 2073  elf.model.app, s
-00000830: 656c 662e 6d6f 6465 6c2e 756e 6974 2e61  elf.model.unit.a
-00000840: 7070 290a 2020 2020 2020 2020 7365 6c66  pp).        self
-00000850: 2e61 7373 6572 7449 734e 6f6e 6528 7365  .assertIsNone(se
-00000860: 6c66 2e6d 6f64 656c 2e6e 616d 6529 0a0a  lf.model.name)..
-00000870: 2020 2020 6465 6620 7465 7374 5f75 6e69      def test_uni
-00000880: 745f 696d 6d75 7461 626c 6528 7365 6c66  t_immutable(self
-00000890: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
-000008a0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-000008b0: 7328 4174 7472 6962 7574 6545 7272 6f72  s(AttributeError
-000008c0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000008d0: 656c 662e 6d6f 6465 6c2e 756e 6974 203d  elf.model.unit =
-000008e0: 206f 626a 6563 7428 290a 0a20 2020 2064   object()..    d
-000008f0: 6566 2074 6573 745f 6170 705f 696d 6d75  ef test_app_immu
-00000900: 7461 626c 6528 7365 6c66 293a 0a20 2020  table(self):.   
-00000910: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00000920: 7373 6572 7452 6169 7365 7328 4174 7472  ssertRaises(Attr
-00000930: 6962 7574 6545 7272 6f72 293a 0a20 2020  ibuteError):.   
-00000940: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
-00000950: 6465 6c2e 6170 7020 3d20 6f62 6a65 6374  del.app = object
-00000960: 2829 0a0a 2020 2020 6465 6620 7465 7374  ()..    def test
-00000970: 5f6d 6f64 656c 5f6e 616d 655f 6672 6f6d  _model_name_from
-00000980: 5f62 6163 6b65 6e64 2873 656c 6629 3a0a  _backend(self):.
-00000990: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-000009a0: 6e65 7373 2e73 6574 5f6d 6f64 656c 5f6e  ness.set_model_n
-000009b0: 616d 6528 2764 6566 6175 6c74 2729 0a20  ame('default'). 
-000009c0: 2020 2020 2020 206d 203d 206f 7073 2e6d         m = ops.m
-000009d0: 6f64 656c 2e4d 6f64 656c 286f 7073 2e63  odel.Model(ops.c
-000009e0: 6861 726d 2e43 6861 726d 4d65 7461 2829  harm.CharmMeta()
-000009f0: 2c20 7365 6c66 2e68 6172 6e65 7373 2e5f  , self.harness._
-00000a00: 6261 636b 656e 6429 0a20 2020 2020 2020  backend).       
-00000a10: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00000a20: 6c28 6d2e 6e61 6d65 2c20 2764 6566 6175  l(m.name, 'defau
-00000a30: 6c74 2729 0a20 2020 2020 2020 2077 6974  lt').        wit
-00000a40: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00000a50: 7365 7328 4174 7472 6962 7574 6545 7272  ses(AttributeErr
-00000a60: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00000a70: 206d 2e6e 616d 6520 3d20 2263 6861 6e67   m.name = "chang
-00000a80: 6573 2d64 6973 616c 6c6f 7765 6422 0a0a  es-disallowed"..
-00000a90: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
-00000aa0: 6174 696f 6e73 5f6b 6579 7328 7365 6c66  ations_keys(self
-00000ab0: 293a 0a20 2020 2020 2020 2072 656c 5f61  ):.        rel_a
-00000ac0: 7070 3120 3d20 7365 6c66 2e68 6172 6e65  pp1 = self.harne
-00000ad0: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-00000ae0: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
-00000af0: 7031 2729 0a20 2020 2020 2020 2073 656c  p1').        sel
-00000b00: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
-00000b10: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-00000b20: 6170 7031 2c20 2772 656d 6f74 6561 7070  app1, 'remoteapp
-00000b30: 312f 3027 290a 2020 2020 2020 2020 7365  1/0').        se
-00000b40: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-00000b50: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00000b60: 5f61 7070 312c 2027 7265 6d6f 7465 6170  _app1, 'remoteap
-00000b70: 7031 2f31 2729 0a20 2020 2020 2020 2072  p1/1').        r
-00000b80: 656c 5f61 7070 3220 3d20 7365 6c66 2e68  el_app2 = self.h
-00000b90: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00000ba0: 696f 6e28 2764 6231 272c 2027 7265 6d6f  ion('db1', 'remo
-00000bb0: 7465 6170 7032 2729 0a20 2020 2020 2020  teapp2').       
-00000bc0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00000bd0: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-00000be0: 7265 6c5f 6170 7032 2c20 2772 656d 6f74  rel_app2, 'remot
-00000bf0: 6561 7070 322f 3027 290a 0a20 2020 2020  eapp2/0')..     
-00000c00: 2020 2023 2057 6520 696e 7661 6c69 6461     # We invalida
-00000c10: 7465 2064 6231 2073 6f20 7468 6174 2069  te db1 so that i
-00000c20: 7420 6361 7573 6573 2075 7320 746f 2072  t causes us to r
-00000c30: 656c 6f61 6420 6974 0a20 2020 2020 2020  eload it.       
-00000c40: 2073 656c 662e 6d6f 6465 6c2e 7265 6c61   self.model.rela
-00000c50: 7469 6f6e 732e 5f69 6e76 616c 6964 6174  tions._invalidat
-00000c60: 6528 2764 6231 2729 0a20 2020 2020 2020  e('db1').       
-00000c70: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
-00000c80: 6e64 4361 6c6c 7328 290a 2020 2020 2020  ndCalls().      
-00000c90: 2020 666f 7220 7265 6c61 7469 6f6e 2069    for relation i
-00000ca0: 6e20 7365 6c66 2e6d 6f64 656c 2e72 656c  n self.model.rel
-00000cb0: 6174 696f 6e73 5b27 6462 3127 5d3a 0a20  ations['db1']:. 
-00000cc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000cd0: 6173 7365 7274 496e 2873 656c 662e 6d6f  assertIn(self.mo
-00000ce0: 6465 6c2e 756e 6974 2c20 7265 6c61 7469  del.unit, relati
-00000cf0: 6f6e 2e64 6174 6129 0a20 2020 2020 2020  on.data).       
-00000d00: 2020 2020 2075 6e69 745f 6672 6f6d 5f72       unit_from_r
-00000d10: 656c 203d 206e 6578 7428 6669 6c74 6572  el = next(filter
-00000d20: 286c 616d 6264 6120 753a 2075 2e6e 616d  (lambda u: u.nam
-00000d30: 6520 3d3d 2027 6d79 6170 702f 3027 2c20  e == 'myapp/0', 
-00000d40: 7265 6c61 7469 6f6e 2e64 6174 612e 6b65  relation.data.ke
-00000d50: 7973 2829 2929 0a20 2020 2020 2020 2020  ys())).         
-00000d60: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-00000d70: 2873 656c 662e 6d6f 6465 6c2e 756e 6974  (self.model.unit
-00000d80: 2c20 756e 6974 5f66 726f 6d5f 7265 6c29  , unit_from_rel)
-00000d90: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00000da0: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
-00000db0: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
-00000dc0: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
-00000dd0: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
-00000de0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00000df0: 6c69 7374 272c 2072 656c 5f61 7070 3129  list', rel_app1)
-00000e00: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-00000e10: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
-00000e20: 7265 6c5f 6170 7032 292c 0a20 2020 2020  rel_app2),.     
-00000e30: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-00000e40: 6573 745f 7265 6c61 7469 6f6e 735f 696d  est_relations_im
-00000e50: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
-00000e60: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00000e70: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
-00000e80: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
-00000e90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00000ea0: 6d6f 6465 6c2e 7265 6c61 7469 6f6e 7320  model.relations 
-00000eb0: 3d20 7b7d 0a0a 2020 2020 6465 6620 7465  = {}..    def te
-00000ec0: 7374 5f67 6574 5f72 656c 6174 696f 6e28  st_get_relation(
-00000ed0: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
-00000ee0: 206f 6e65 2072 656c 6174 696f 6e20 6f6e   one relation on
-00000ef0: 2064 6231 0a20 2020 2020 2020 2023 2074   db1.        # t
-00000f00: 776f 2072 656c 6174 696f 6e73 206f 6e20  wo relations on 
-00000f10: 6462 300a 2020 2020 2020 2020 2320 6e6f  db0.        # no
-00000f20: 2072 656c 6174 696f 6e73 206f 6e20 6462   relations on db
-00000f30: 320a 2020 2020 2020 2020 7265 6c61 7469  2.        relati
-00000f40: 6f6e 5f69 645f 6462 3120 3d20 7365 6c66  on_id_db1 = self
-00000f50: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-00000f60: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
-00000f70: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
-00000f80: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00000f90: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00000fa0: 7428 7265 6c61 7469 6f6e 5f69 645f 6462  t(relation_id_db
-00000fb0: 312c 2027 7265 6d6f 7465 6170 7031 2f30  1, 'remoteapp1/0
-00000fc0: 2729 0a20 2020 2020 2020 2072 656c 6174  ').        relat
-00000fd0: 696f 6e5f 6964 5f64 6230 5f62 203d 2073  ion_id_db0_b = s
-00000fe0: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00000ff0: 7265 6c61 7469 6f6e 2827 6462 3027 2c20  relation('db0', 
-00001000: 2761 6e6f 7468 6572 2729 0a20 2020 2020  'another').     
-00001010: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
-00001020: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
-00001030: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00001040: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00001050: 6d6f 6465 6c2e 4d6f 6465 6c45 7272 6f72  model.ModelError
-00001060: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-00001070: 2059 6f75 2068 6176 6520 746f 2073 7065   You have to spe
-00001080: 6369 6679 2069 7420 6279 206a 7573 7420  cify it by just 
-00001090: 7468 6520 696e 7465 6765 7220 4944 0a20  the integer ID. 
-000010a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000010b0: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
-000010c0: 6f6e 2827 6462 3127 2c20 6627 6462 313a  on('db1', f'db1:
-000010d0: 7b72 656c 6174 696f 6e5f 6964 5f64 6231  {relation_id_db1
-000010e0: 7d27 290a 2020 2020 2020 2020 7265 6c5f  }').        rel_
-000010f0: 6462 3120 3d20 7365 6c66 2e6d 6f64 656c  db1 = self.model
-00001100: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-00001110: 6231 272c 2072 656c 6174 696f 6e5f 6964  b1', relation_id
-00001120: 5f64 6231 290a 2020 2020 2020 2020 7365  _db1).        se
-00001130: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-00001140: 6e63 6528 7265 6c5f 6462 312c 206f 7073  nce(rel_db1, ops
-00001150: 2e6d 6f64 656c 2e52 656c 6174 696f 6e29  .model.Relation)
-00001160: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00001170: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
-00001180: 285b 0a20 2020 2020 2020 2020 2020 2028  ([.            (
-00001190: 2772 656c 6174 696f 6e5f 6964 7327 2c20  'relation_ids', 
-000011a0: 2764 6231 2729 2c0a 2020 2020 2020 2020  'db1'),.        
-000011b0: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
-000011c0: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
-000011d0: 645f 6462 3129 2c0a 2020 2020 2020 2020  d_db1),.        
-000011e0: 5d29 0a20 2020 2020 2020 2064 6561 645f  ]).        dead_
-000011f0: 7265 6c20 3d20 7365 6c66 2e6d 6f64 656c  rel = self.model
-00001200: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-00001210: 6231 272c 2037 290a 2020 2020 2020 2020  b1', 7).        
-00001220: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-00001230: 7461 6e63 6528 6465 6164 5f72 656c 2c20  tance(dead_rel, 
-00001240: 6f70 732e 6d6f 6465 6c2e 5265 6c61 7469  ops.model.Relati
-00001250: 6f6e 290a 2020 2020 2020 2020 7365 6c66  on).        self
-00001260: 2e61 7373 6572 7445 7175 616c 2873 6574  .assertEqual(set
-00001270: 2864 6561 645f 7265 6c2e 6461 7461 2e6b  (dead_rel.data.k
-00001280: 6579 7328 2929 2c20 7b73 656c 662e 6d6f  eys()), {self.mo
-00001290: 6465 6c2e 756e 6974 2c20 7365 6c66 2e6d  del.unit, self.m
-000012a0: 6f64 656c 2e75 6e69 742e 6170 707d 290a  odel.unit.app}).
-000012b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000012c0: 6572 7445 7175 616c 2864 6561 645f 7265  ertEqual(dead_re
-000012d0: 6c2e 6461 7461 5b73 656c 662e 6d6f 6465  l.data[self.mode
-000012e0: 6c2e 756e 6974 5d2c 207b 7d29 0a20 2020  l.unit], {}).   
-000012f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00001300: 4261 636b 656e 6443 616c 6c73 285b 0a20  BackendCalls([. 
-00001310: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
-00001320: 6174 696f 6e5f 6c69 7374 272c 2037 292c  ation_list', 7),
-00001330: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
-00001340: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
-00001350: 7070 5f6e 616d 6527 2c20 3729 2c0a 2020  pp_name', 7),.  
-00001360: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
-00001370: 7469 6f6e 5f67 6574 272c 2037 2c20 276d  tion_get', 7, 'm
-00001380: 7961 7070 2f30 272c 2046 616c 7365 292c  yapp/0', False),
-00001390: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-000013a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000013b0: 4973 4e6f 6e65 2873 656c 662e 6d6f 6465  IsNone(self.mode
-000013c0: 6c2e 6765 745f 7265 6c61 7469 6f6e 2827  l.get_relation('
-000013d0: 6462 3227 2929 0a20 2020 2020 2020 2073  db2')).        s
-000013e0: 656c 662e 6173 7365 7274 4261 636b 656e  elf.assertBacken
-000013f0: 6443 616c 6c73 285b 0a20 2020 2020 2020  dCalls([.       
-00001400: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00001410: 6964 7327 2c20 2764 6232 2729 2c0a 2020  ids', 'db2'),.  
-00001420: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-00001430: 2073 656c 662e 6173 7365 7274 4973 2873   self.assertIs(s
-00001440: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
-00001450: 6c61 7469 6f6e 2827 6462 3127 292c 2072  lation('db1'), r
-00001460: 656c 5f64 6231 290a 2020 2020 2020 2020  el_db1).        
-00001470: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00001480: 5261 6973 6573 286f 7073 2e6d 6f64 656c  Raises(ops.model
-00001490: 2e54 6f6f 4d61 6e79 5265 6c61 7465 6441  .TooManyRelatedA
-000014a0: 7070 7345 7272 6f72 293a 0a20 2020 2020  ppsError):.     
-000014b0: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
-000014c0: 6c2e 6765 745f 7265 6c61 7469 6f6e 2827  l.get_relation('
-000014d0: 6462 3027 290a 0a20 2020 2020 2020 2073  db0')..        s
-000014e0: 656c 662e 6173 7365 7274 4261 636b 656e  elf.assertBacken
-000014f0: 6443 616c 6c73 285b 0a20 2020 2020 2020  dCalls([.       
-00001500: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00001510: 6964 7327 2c20 2764 6230 2729 2c0a 2020  ids', 'db0'),.  
-00001520: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
-00001530: 7469 6f6e 5f6c 6973 7427 2c20 7365 6c66  tion_list', self
-00001540: 2e72 656c 6174 696f 6e5f 6964 5f64 6230  .relation_id_db0
-00001550: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00001560: 2772 656c 6174 696f 6e5f 7265 6d6f 7465  'relation_remote
-00001570: 5f61 7070 5f6e 616d 6527 2c20 3029 2c0a  _app_name', 0),.
-00001580: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
-00001590: 6c61 7469 6f6e 5f6c 6973 7427 2c20 7265  lation_list', re
-000015a0: 6c61 7469 6f6e 5f69 645f 6462 305f 6229  lation_id_db0_b)
-000015b0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-000015c0: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
-000015d0: 6170 705f 6e61 6d65 272c 2032 292c 0a20  app_name', 2),. 
-000015e0: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-000015f0: 6566 2074 6573 745f 7065 6572 5f72 656c  ef test_peer_rel
-00001600: 6174 696f 6e5f 6170 7028 7365 6c66 293a  ation_app(self):
-00001610: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-00001620: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00001630: 6f6e 2827 6462 3227 2c20 276d 7961 7070  on('db2', 'myapp
-00001640: 2729 0a20 2020 2020 2020 2072 656c 5f64  ').        rel_d
-00001650: 6270 6565 7220 3d20 7365 6c66 2e6d 6f64  bpeer = self.mod
-00001660: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-00001670: 2764 6232 2729 0a20 2020 2020 2020 2073  'db2').        s
-00001680: 656c 662e 6173 7365 7274 4973 2872 656c  elf.assertIs(rel
-00001690: 5f64 6270 6565 722e 6170 702c 2073 656c  _dbpeer.app, sel
-000016a0: 662e 6d6f 6465 6c2e 6170 7029 0a0a 2020  f.model.app)..  
-000016b0: 2020 6465 6620 7465 7374 5f72 656d 6f74    def test_remot
-000016c0: 655f 756e 6974 735f 6973 5f6f 7572 2873  e_units_is_our(s
-000016d0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-000016e0: 6c61 7469 6f6e 5f69 6420 3d20 7365 6c66  lation_id = self
-000016f0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-00001700: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
-00001710: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
-00001720: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00001730: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00001740: 7428 7265 6c61 7469 6f6e 5f69 642c 2027  t(relation_id, '
-00001750: 7265 6d6f 7465 6170 7031 2f30 2729 0a20  remoteapp1/0'). 
-00001760: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-00001770: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00001780: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
-00001790: 642c 2027 7265 6d6f 7465 6170 7031 2f31  d, 'remoteapp1/1
-000017a0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000017b0: 7265 7365 7442 6163 6b65 6e64 4361 6c6c  resetBackendCall
-000017c0: 7328 290a 0a20 2020 2020 2020 2066 6f72  s()..        for
-000017d0: 2075 2069 6e20 7365 6c66 2e6d 6f64 656c   u in self.model
-000017e0: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-000017f0: 6231 2729 2e75 6e69 7473 3a0a 2020 2020  b1').units:.    
-00001800: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00001810: 6572 7446 616c 7365 2875 2e5f 6973 5f6f  ertFalse(u._is_o
-00001820: 7572 5f75 6e69 7429 0a20 2020 2020 2020  ur_unit).       
-00001830: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00001840: 4661 6c73 6528 752e 6170 702e 5f69 735f  False(u.app._is_
-00001850: 6f75 725f 6170 7029 0a0a 2020 2020 2020  our_app)..      
-00001860: 2020 7365 6c66 2e61 7373 6572 7442 6163    self.assertBac
-00001870: 6b65 6e64 4361 6c6c 7328 5b0a 2020 2020  kendCalls([.    
-00001880: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
-00001890: 6f6e 5f69 6473 272c 2027 6462 3127 292c  on_ids', 'db1'),
-000018a0: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
-000018b0: 656c 6174 696f 6e5f 6c69 7374 272c 2072  elation_list', r
-000018c0: 656c 6174 696f 6e5f 6964 290a 2020 2020  elation_id).    
-000018d0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-000018e0: 7465 7374 5f6f 7572 5f75 6e69 745f 6973  test_our_unit_is
-000018f0: 5f6f 7572 2873 656c 6629 3a0a 2020 2020  _our(self):.    
-00001900: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00001910: 7275 6528 7365 6c66 2e6d 6f64 656c 2e75  rue(self.model.u
-00001920: 6e69 742e 5f69 735f 6f75 725f 756e 6974  nit._is_our_unit
-00001930: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00001940: 7373 6572 7454 7275 6528 7365 6c66 2e6d  ssertTrue(self.m
-00001950: 6f64 656c 2e75 6e69 742e 6170 702e 5f69  odel.unit.app._i
-00001960: 735f 6f75 725f 6170 7029 0a0a 2020 2020  s_our_app)..    
-00001970: 6465 6620 7465 7374 5f69 6e76 616c 6964  def test_invalid
-00001980: 5f74 7970 655f 7265 6c61 7469 6f6e 5f64  _type_relation_d
-00001990: 6174 6128 7365 6c66 293a 0a20 2020 2020  ata(self):.     
-000019a0: 2020 2072 656c 6174 696f 6e5f 6964 203d     relation_id =
-000019b0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-000019c0: 645f 7265 6c61 7469 6f6e 2827 6462 3127  d_relation('db1'
-000019d0: 2c20 2772 656d 6f74 6561 7070 3127 290a  , 'remoteapp1').
-000019e0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-000019f0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00001a00: 6e5f 756e 6974 2872 656c 6174 696f 6e5f  n_unit(relation_
-00001a10: 6964 2c20 2772 656d 6f74 6561 7070 312f  id, 'remoteapp1/
-00001a20: 3027 290a 0a20 2020 2020 2020 2077 6974  0')..        wit
-00001a30: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00001a40: 7365 7328 6d6f 6465 6c2e 5265 6c61 7469  ses(model.Relati
-00001a50: 6f6e 4461 7461 4572 726f 7229 3a0a 2020  onDataError):.  
-00001a60: 2020 2020 2020 2020 2020 7769 7468 2073            with s
-00001a70: 656c 662e 6861 726e 6573 732e 5f65 7665  elf.harness._eve
-00001a80: 6e74 5f63 6f6e 7465 7874 2827 666f 6f5f  nt_context('foo_
-00001a90: 6576 656e 7427 293a 0a20 2020 2020 2020  event'):.       
-00001aa0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00001ab0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00001ac0: 6174 696f 6e5f 6461 7461 280a 2020 2020  ation_data(.    
-00001ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ae0: 7265 6c61 7469 6f6e 5f69 642c 0a20 2020  relation_id,.   
-00001af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b00: 2027 7265 6d6f 7465 6170 7031 2f30 272c   'remoteapp1/0',
-00001b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001b20: 2020 2020 207b 3432 3a20 2772 656d 6f74       {42: 'remot
-00001b30: 6561 7070 312d 3027 7d29 0a0a 2020 2020  eapp1-0'})..    
-00001b40: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00001b50: 7365 7274 5261 6973 6573 286d 6f64 656c  sertRaises(model
-00001b60: 2e52 656c 6174 696f 6e44 6174 6145 7272  .RelationDataErr
-00001b70: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00001b80: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
-00001b90: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
-00001ba0: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
-00001bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001bc0: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
-00001bd0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00001be0: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
-00001bf0: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
-00001c00: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00001c10: 2020 2020 2020 2020 2772 656d 6f74 6561          'remotea
-00001c20: 7070 312f 3027 2c0a 2020 2020 2020 2020  pp1/0',.        
-00001c30: 2020 2020 2020 2020 2020 2020 7b27 666f              {'fo
-00001c40: 6f27 3a20 3432 7d29 0a0a 2020 2020 6465  o': 42})..    de
-00001c50: 6620 7465 7374 5f67 6574 5f61 7070 5f72  f test_get_app_r
-00001c60: 656c 6174 696f 6e5f 6461 7461 2873 656c  elation_data(sel
-00001c70: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00001c80: 2e68 6172 6e65 7373 2e62 6567 696e 2829  .harness.begin()
-00001c90: 0a20 2020 2020 2020 2072 656c 6174 696f  .        relatio
-00001ca0: 6e5f 6964 203d 2073 656c 662e 6861 726e  n_id = self.harn
-00001cb0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00001cc0: 2827 6462 3127 2c20 2772 656d 6f74 6527  ('db1', 'remote'
-00001cd0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-00001ce0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00001cf0: 696f 6e5f 756e 6974 2872 656c 6174 696f  ion_unit(relatio
-00001d00: 6e5f 6964 2c20 2772 656d 6f74 652f 3027  n_id, 'remote/0'
-00001d10: 290a 2020 2020 2020 2020 6c6f 6361 6c5f  ).        local_
-00001d20: 6170 7020 3d20 7365 6c66 2e68 6172 6e65  app = self.harne
-00001d30: 7373 2e6d 6f64 656c 2e61 7070 2e6e 616d  ss.model.app.nam
-00001d40: 650a 2020 2020 2020 2020 7769 7468 2073  e.        with s
-00001d50: 656c 662e 6861 726e 6573 732e 5f65 7665  elf.harness._eve
-00001d60: 6e74 5f63 6f6e 7465 7874 2827 666f 6f5f  nt_context('foo_
-00001d70: 6576 656e 7427 293a 0a20 2020 2020 2020  event'):.       
-00001d80: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00001d90: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00001da0: 6e5f 6461 7461 280a 2020 2020 2020 2020  n_data(.        
-00001db0: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
-00001dc0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00001dd0: 2020 2020 206c 6f63 616c 5f61 7070 2c0a       local_app,.
-00001de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001df0: 7b27 666f 6f27 3a20 2762 6172 277d 290a  {'foo': 'bar'}).
-00001e00: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00001e10: 7274 2073 656c 662e 6861 726e 6573 732e  rt self.harness.
-00001e20: 6765 745f 7265 6c61 7469 6f6e 5f64 6174  get_relation_dat
-00001e30: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
-00001e40: 2020 2072 656c 6174 696f 6e5f 6964 2c20     relation_id, 
-00001e50: 7365 6c66 2e68 6172 6e65 7373 2e6d 6f64  self.harness.mod
-00001e60: 656c 2e61 7070 2920 3d3d 2073 656c 662e  el.app) == self.
-00001e70: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
-00001e80: 7469 6f6e 5f64 6174 6128 0a20 2020 2020  tion_data(.     
-00001e90: 2020 2020 2020 2020 2020 2072 656c 6174             relat
-00001ea0: 696f 6e5f 6964 2c20 6c6f 6361 6c5f 6170  ion_id, local_ap
-00001eb0: 7029 203d 3d20 7b27 666f 6f27 3a20 2762  p) == {'foo': 'b
-00001ec0: 6172 277d 0a0a 2020 2020 6465 6620 7465  ar'}..    def te
-00001ed0: 7374 5f75 6e69 745f 7265 6c61 7469 6f6e  st_unit_relation
-00001ee0: 5f64 6174 6128 7365 6c66 293a 0a20 2020  _data(self):.   
-00001ef0: 2020 2020 2072 656c 6174 696f 6e5f 6964       relation_id
-00001f00: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
-00001f10: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00001f20: 3127 2c20 2772 656d 6f74 6561 7070 3127  1', 'remoteapp1'
-00001f30: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-00001f40: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00001f50: 696f 6e5f 756e 6974 2872 656c 6174 696f  ion_unit(relatio
-00001f60: 6e5f 6964 2c20 2772 656d 6f74 6561 7070  n_id, 'remoteapp
-00001f70: 312f 3027 290a 2020 2020 2020 2020 7769  1/0').        wi
-00001f80: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
-00001f90: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
-00001fa0: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
-00001fb0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00001fc0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00001fd0: 6174 696f 6e5f 6461 7461 280a 2020 2020  ation_data(.    
-00001fe0: 2020 2020 2020 2020 2020 2020 7265 6c61              rela
-00001ff0: 7469 6f6e 5f69 642c 0a20 2020 2020 2020  tion_id,.       
-00002000: 2020 2020 2020 2020 2027 7265 6d6f 7465           'remote
-00002010: 6170 7031 2f30 272c 0a20 2020 2020 2020  app1/0',.       
-00002020: 2020 2020 2020 2020 207b 2768 6f73 7427           {'host'
-00002030: 3a20 2772 656d 6f74 6561 7070 312d 3027  : 'remoteapp1-0'
-00002040: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-00002050: 6d6f 6465 6c2e 7265 6c61 7469 6f6e 732e  model.relations.
-00002060: 5f69 6e76 616c 6964 6174 6528 2764 6231  _invalidate('db1
-00002070: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00002080: 7265 7365 7442 6163 6b65 6e64 4361 6c6c  resetBackendCall
-00002090: 7328 290a 0a20 2020 2020 2020 2072 616e  s()..        ran
-000020a0: 646f 6d5f 756e 6974 203d 2073 656c 662e  dom_unit = self.
-000020b0: 6d6f 6465 6c2e 6765 745f 756e 6974 2827  model.get_unit('
-000020c0: 7261 6e64 6f6d 756e 6974 2f30 2729 0a20  randomunit/0'). 
-000020d0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000020e0: 2e61 7373 6572 7452 6169 7365 7328 4b65  .assertRaises(Ke
-000020f0: 7945 7272 6f72 293a 0a20 2020 2020 2020  yError):.       
-00002100: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
-00002110: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-00002120: 3127 292e 6461 7461 5b72 616e 646f 6d5f  1').data[random_
-00002130: 756e 6974 5d0a 2020 2020 2020 2020 7265  unit].        re
-00002140: 6d6f 7465 6170 7031 5f30 203d 206e 6578  moteapp1_0 = nex
-00002150: 7428 6669 6c74 6572 286c 616d 6264 6120  t(filter(lambda 
-00002160: 753a 2075 2e6e 616d 6520 3d3d 2027 7265  u: u.name == 're
-00002170: 6d6f 7465 6170 7031 2f30 272c 0a20 2020  moteapp1/0',.   
-00002180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000021a0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-000021b0: 656c 6174 696f 6e28 2764 6231 2729 2e75  elation('db1').u
-000021c0: 6e69 7473 2929 0a20 2020 2020 2020 2073  nits)).        s
-000021d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000021e0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-000021f0: 656c 6174 696f 6e28 2764 6231 2729 2e64  elation('db1').d
-00002200: 6174 615b 7265 6d6f 7465 6170 7031 5f30  ata[remoteapp1_0
-00002210: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00002220: 2020 2020 2020 2020 2020 2020 7b27 686f              {'ho
-00002230: 7374 273a 2027 7265 6d6f 7465 6170 7031  st': 'remoteapp1
-00002240: 2d30 277d 290a 0a20 2020 2020 2020 2073  -0'})..        s
-00002250: 656c 662e 6173 7365 7274 4261 636b 656e  elf.assertBacken
-00002260: 6443 616c 6c73 285b 0a20 2020 2020 2020  dCalls([.       
-00002270: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00002280: 6964 7327 2c20 2764 6231 2729 2c0a 2020  ids', 'db1'),.  
-00002290: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
-000022a0: 7469 6f6e 5f6c 6973 7427 2c20 7265 6c61  tion_list', rela
-000022b0: 7469 6f6e 5f69 6429 2c0a 2020 2020 2020  tion_id),.      
-000022c0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
-000022d0: 5f67 6574 272c 2072 656c 6174 696f 6e5f  _get', relation_
-000022e0: 6964 2c20 2772 656d 6f74 6561 7070 312f  id, 'remoteapp1/
-000022f0: 3027 2c20 4661 6c73 6529 2c0a 2020 2020  0', False),.    
-00002300: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-00002310: 7465 7374 5f72 656d 6f74 655f 6170 705f  test_remote_app_
-00002320: 7265 6c61 7469 6f6e 5f64 6174 6128 7365  relation_data(se
-00002330: 6c66 293a 0a20 2020 2020 2020 2072 656c  lf):.        rel
-00002340: 6174 696f 6e5f 6964 203d 2073 656c 662e  ation_id = self.
-00002350: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00002360: 7469 6f6e 2827 6462 3127 2c20 2772 656d  tion('db1', 'rem
-00002370: 6f74 6561 7070 3127 290a 2020 2020 2020  oteapp1').      
-00002380: 2020 7769 7468 2073 656c 662e 6861 726e    with self.harn
-00002390: 6573 732e 5f65 7665 6e74 5f63 6f6e 7465  ess._event_conte
-000023a0: 7874 2827 666f 6f5f 6576 656e 7427 293a  xt('foo_event'):
-000023b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000023c0: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
-000023d0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-000023e0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
-000023f0: 6f74 6561 7070 3127 2c0a 2020 2020 2020  oteapp1',.      
-00002400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002420: 2020 2020 2020 2020 7b27 7365 6372 6574          {'secret
-00002430: 273a 2027 6361 6665 6465 6164 6265 6566  ': 'cafedeadbeef
-00002440: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-00002450: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-00002460: 6174 696f 6e5f 756e 6974 2872 656c 6174  ation_unit(relat
-00002470: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
-00002480: 7070 312f 3027 290a 2020 2020 2020 2020  pp1/0').        
-00002490: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-000024a0: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-000024b0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
-000024c0: 6f74 6561 7070 312f 3127 290a 2020 2020  oteapp1/1').    
-000024d0: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
-000024e0: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
-000024f0: 2020 2020 2020 7265 6c5f 6462 3120 3d20        rel_db1 = 
-00002500: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
-00002510: 656c 6174 696f 6e28 2764 6231 2729 0a20  elation('db1'). 
-00002520: 2020 2020 2020 2023 2054 7279 2074 6f20         # Try to 
-00002530: 6765 7420 7265 6c61 7469 6f6e 2064 6174  get relation dat
-00002540: 6120 666f 7220 616e 2069 6e76 616c 6964  a for an invalid
-00002550: 2072 656d 6f74 6520 6170 706c 6963 6174   remote applicat
-00002560: 696f 6e2e 0a20 2020 2020 2020 2072 616e  ion..        ran
-00002570: 646f 6d5f 6170 7020 3d20 7365 6c66 2e6d  dom_app = self.m
-00002580: 6f64 656c 2e5f 6361 6368 652e 6765 7428  odel._cache.get(
-00002590: 6f70 732e 6d6f 6465 6c2e 4170 706c 6963  ops.model.Applic
-000025a0: 6174 696f 6e2c 2027 7261 6e64 6f6d 6170  ation, 'randomap
-000025b0: 7027 290a 2020 2020 2020 2020 7769 7468  p').        with
-000025c0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-000025d0: 6573 284b 6579 4572 726f 7229 3a0a 2020  es(KeyError):.  
-000025e0: 2020 2020 2020 2020 2020 7265 6c5f 6462            rel_db
-000025f0: 312e 6461 7461 5b72 616e 646f 6d5f 6170  1.data[random_ap
-00002600: 705d 0a0a 2020 2020 2020 2020 7265 6d6f  p]..        remo
-00002610: 7465 6170 7031 203d 2072 656c 5f64 6231  teapp1 = rel_db1
-00002620: 2e61 7070 0a20 2020 2020 2020 2073 656c  .app.        sel
-00002630: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
-00002640: 6d6f 7465 6170 7031 2e6e 616d 652c 2027  moteapp1.name, '
-00002650: 7265 6d6f 7465 6170 7031 2729 0a20 2020  remoteapp1').   
-00002660: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00002670: 4571 7561 6c28 7265 6c5f 6462 312e 6461  Equal(rel_db1.da
-00002680: 7461 5b72 656d 6f74 6561 7070 315d 2c0a  ta[remoteapp1],.
-00002690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000026a0: 2020 2020 2020 2020 207b 2773 6563 7265           {'secre
-000026b0: 7427 3a20 2763 6166 6564 6561 6462 6565  t': 'cafedeadbee
-000026c0: 6627 7d29 0a0a 2020 2020 2020 2020 7365  f'})..        se
-000026d0: 6c66 2e61 7373 6572 7442 6163 6b65 6e64  lf.assertBackend
-000026e0: 4361 6c6c 7328 5b0a 2020 2020 2020 2020  Calls([.        
-000026f0: 2020 2020 2827 7265 6c61 7469 6f6e 5f69      ('relation_i
-00002700: 6473 272c 2027 6462 3127 292c 0a20 2020  ds', 'db1'),.   
-00002710: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
-00002720: 696f 6e5f 6c69 7374 272c 2072 656c 6174  ion_list', relat
-00002730: 696f 6e5f 6964 292c 0a20 2020 2020 2020  ion_id),.       
-00002740: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00002750: 6765 7427 2c20 7265 6c61 7469 6f6e 5f69  get', relation_i
-00002760: 642c 2027 7265 6d6f 7465 6170 7031 272c  d, 'remoteapp1',
-00002770: 2054 7275 6529 2c0a 2020 2020 2020 2020   True),.        
-00002780: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00002790: 5f72 656c 6174 696f 6e5f 6461 7461 5f6d  _relation_data_m
-000027a0: 6f64 6966 795f 7265 6d6f 7465 2873 656c  odify_remote(sel
-000027b0: 6629 3a0a 2020 2020 2020 2020 7265 6c61  f):.        rela
-000027c0: 7469 6f6e 5f69 6420 3d20 7365 6c66 2e68  tion_id = self.h
-000027d0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-000027e0: 696f 6e28 2764 6231 272c 2027 7265 6d6f  ion('db1', 'remo
-000027f0: 7465 6170 7031 2729 0a20 2020 2020 2020  teapp1').       
-00002800: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
-00002810: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
-00002820: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
-00002830: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00002840: 2e68 6172 6e65 7373 2e75 7064 6174 655f  .harness.update_
-00002850: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-00002860: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
-00002870: 7465 6170 7031 272c 0a20 2020 2020 2020  teapp1',.       
-00002880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000350: 0a0a 696d 706f 7274 206f 7073 0a69 6d70  ..import ops.imp
+00000360: 6f72 7420 6f70 732e 7465 7374 696e 670a  ort ops.testing.
+00000370: 6672 6f6d 206f 7073 2069 6d70 6f72 7420  from ops import 
+00000380: 7065 6262 6c65 0a66 726f 6d20 6f70 732e  pebble.from ops.
+00000390: 5f70 7269 7661 7465 2069 6d70 6f72 7420  _private import 
+000003a0: 7961 6d6c 0a66 726f 6d20 6f70 732e 6d6f  yaml.from ops.mo
+000003b0: 6465 6c20 696d 706f 7274 205f 4d6f 6465  del import _Mode
+000003c0: 6c42 6163 6b65 6e64 0a0a 0a63 6c61 7373  lBackend...class
+000003d0: 2054 6573 744d 6f64 656c 2875 6e69 7474   TestModel(unitt
+000003e0: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
+000003f0: 2020 2064 6566 2073 6574 5570 2873 656c     def setUp(sel
+00000400: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00000410: 2e68 6172 6e65 7373 203d 206f 7073 2e74  .harness = ops.t
+00000420: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+00000430: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+00000440: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+00000450: 2020 206e 616d 653a 206d 7961 7070 0a20     name: myapp. 
+00000460: 2020 2020 2020 2020 2020 2070 726f 7669             provi
+00000470: 6465 733a 0a20 2020 2020 2020 2020 2020  des:.           
+00000480: 2020 2064 6230 3a0a 2020 2020 2020 2020     db0:.        
+00000490: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+000004a0: 653a 2064 6230 0a20 2020 2020 2020 2020  e: db0.         
+000004b0: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
+000004c0: 2020 2020 2020 2020 2020 2064 6231 3a0a             db1:.
+000004d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000004e0: 696e 7465 7266 6163 653a 2064 6231 0a20  interface: db1. 
+000004f0: 2020 2020 2020 2020 2020 2070 6565 7273             peers
+00000500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00000510: 6462 323a 0a20 2020 2020 2020 2020 2020  db2:.           
+00000520: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+00000530: 6462 320a 2020 2020 2020 2020 2020 2020  db2.            
+00000540: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
+00000550: 2020 2020 2020 2020 2066 6f6f 3a20 7b74           foo: {t
+00000560: 7970 653a 2066 696c 652c 2066 696c 656e  ype: file, filen
+00000570: 616d 653a 2066 6f6f 2e74 7874 7d0a 2020  ame: foo.txt}.  
+00000580: 2020 2020 2020 2020 2020 2020 6261 723a              bar:
+00000590: 207b 7479 7065 3a20 6669 6c65 2c20 6669   {type: file, fi
+000005a0: 6c65 6e61 6d65 3a20 6261 722e 7478 747d  lename: bar.txt}
+000005b0: 0a20 2020 2020 2020 2027 2727 2c20 636f  .        ''', co
+000005c0: 6e66 6967 3d27 2727 0a20 2020 2020 2020  nfig='''.       
+000005d0: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
+000005e0: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
+000005f0: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+00000600: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
+00000610: 2020 2020 6261 723a 0a20 2020 2020 2020      bar:.       
+00000620: 2020 2020 2020 2020 2074 7970 653a 2069           type: i
+00000630: 6e74 0a20 2020 2020 2020 2020 2020 2071  nt.            q
+00000640: 7578 3a0a 2020 2020 2020 2020 2020 2020  ux:.            
+00000650: 2020 2020 7479 7065 3a20 626f 6f6c 6561      type: boolea
+00000660: 6e0a 2020 2020 2020 2020 2727 2729 0a20  n.        '''). 
+00000670: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+00000680: 6c65 616e 7570 2873 656c 662e 6861 726e  leanup(self.harn
+00000690: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+000006a0: 2020 2020 2073 656c 662e 7265 6c61 7469       self.relati
+000006b0: 6f6e 5f69 645f 6462 3020 3d20 7365 6c66  on_id_db0 = self
+000006c0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+000006d0: 6174 696f 6e28 2764 6230 272c 2027 6462  ation('db0', 'db
+000006e0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000006f0: 6861 726e 6573 732e 5f67 6574 5f62 6163  harness._get_bac
+00000700: 6b65 6e64 5f63 616c 6c73 2872 6573 6574  kend_calls(reset
+00000710: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
+00000720: 656c 662e 6d6f 6465 6c20 3d20 7365 6c66  elf.model = self
+00000730: 2e68 6172 6e65 7373 2e6d 6f64 656c 0a0a  .harness.model..
+00000740: 2020 2020 6465 6620 7465 7374 5f6d 6f64      def test_mod
+00000750: 656c 5f61 7474 7269 6275 7465 7328 7365  el_attributes(se
+00000760: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00000770: 662e 6173 7365 7274 4973 2873 656c 662e  f.assertIs(self.
+00000780: 6d6f 6465 6c2e 6170 702c 2073 656c 662e  model.app, self.
+00000790: 6d6f 6465 6c2e 756e 6974 2e61 7070 290a  model.unit.app).
+000007a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000007b0: 6572 7449 734e 6f6e 6528 7365 6c66 2e6d  ertIsNone(self.m
+000007c0: 6f64 656c 2e6e 616d 6529 0a0a 2020 2020  odel.name)..    
+000007d0: 6465 6620 7465 7374 5f75 6e69 745f 696d  def test_unit_im
+000007e0: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
+000007f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00000800: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
+00000810: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00000820: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000830: 6d6f 6465 6c2e 756e 6974 203d 206f 626a  model.unit = obj
+00000840: 6563 7428 290a 0a20 2020 2064 6566 2074  ect()..    def t
+00000850: 6573 745f 6170 705f 696d 6d75 7461 626c  est_app_immutabl
+00000860: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00000870: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00000880: 7452 6169 7365 7328 4174 7472 6962 7574  tRaises(Attribut
+00000890: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+000008a0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+000008b0: 6170 7020 3d20 6f62 6a65 6374 2829 0a0a  app = object()..
+000008c0: 2020 2020 6465 6620 7465 7374 5f6d 6f64      def test_mod
+000008d0: 656c 5f6e 616d 655f 6672 6f6d 5f62 6163  el_name_from_bac
+000008e0: 6b65 6e64 2873 656c 6629 3a0a 2020 2020  kend(self):.    
+000008f0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00000900: 2e73 6574 5f6d 6f64 656c 5f6e 616d 6528  .set_model_name(
+00000910: 2764 6566 6175 6c74 2729 0a20 2020 2020  'default').     
+00000920: 2020 206d 203d 206f 7073 2e4d 6f64 656c     m = ops.Model
+00000930: 286f 7073 2e43 6861 726d 4d65 7461 2829  (ops.CharmMeta()
+00000940: 2c20 7365 6c66 2e68 6172 6e65 7373 2e5f  , self.harness._
+00000950: 6261 636b 656e 6429 0a20 2020 2020 2020  backend).       
+00000960: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00000970: 6c28 6d2e 6e61 6d65 2c20 2764 6566 6175  l(m.name, 'defau
+00000980: 6c74 2729 0a20 2020 2020 2020 2077 6974  lt').        wit
+00000990: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+000009a0: 7365 7328 4174 7472 6962 7574 6545 7272  ses(AttributeErr
+000009b0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000009c0: 206d 2e6e 616d 6520 3d20 2263 6861 6e67   m.name = "chang
+000009d0: 6573 2d64 6973 616c 6c6f 7765 6422 0a0a  es-disallowed"..
+000009e0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+000009f0: 6174 696f 6e73 5f6b 6579 7328 7365 6c66  ations_keys(self
+00000a00: 293a 0a20 2020 2020 2020 2072 656c 5f61  ):.        rel_a
+00000a10: 7070 3120 3d20 7365 6c66 2e68 6172 6e65  pp1 = self.harne
+00000a20: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00000a30: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
+00000a40: 7031 2729 0a20 2020 2020 2020 2073 656c  p1').        sel
+00000a50: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
+00000a60: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
+00000a70: 6170 7031 2c20 2772 656d 6f74 6561 7070  app1, 'remoteapp
+00000a80: 312f 3027 290a 2020 2020 2020 2020 7365  1/0').        se
+00000a90: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+00000aa0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00000ab0: 5f61 7070 312c 2027 7265 6d6f 7465 6170  _app1, 'remoteap
+00000ac0: 7031 2f31 2729 0a20 2020 2020 2020 2072  p1/1').        r
+00000ad0: 656c 5f61 7070 3220 3d20 7365 6c66 2e68  el_app2 = self.h
+00000ae0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00000af0: 696f 6e28 2764 6231 272c 2027 7265 6d6f  ion('db1', 'remo
+00000b00: 7465 6170 7032 2729 0a20 2020 2020 2020  teapp2').       
+00000b10: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00000b20: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+00000b30: 7265 6c5f 6170 7032 2c20 2772 656d 6f74  rel_app2, 'remot
+00000b40: 6561 7070 322f 3027 290a 0a20 2020 2020  eapp2/0')..     
+00000b50: 2020 2023 2057 6520 696e 7661 6c69 6461     # We invalida
+00000b60: 7465 2064 6231 2073 6f20 7468 6174 2069  te db1 so that i
+00000b70: 7420 6361 7573 6573 2075 7320 746f 2072  t causes us to r
+00000b80: 656c 6f61 6420 6974 0a20 2020 2020 2020  eload it.       
+00000b90: 2073 656c 662e 6d6f 6465 6c2e 7265 6c61   self.model.rela
+00000ba0: 7469 6f6e 732e 5f69 6e76 616c 6964 6174  tions._invalidat
+00000bb0: 6528 2764 6231 2729 0a20 2020 2020 2020  e('db1').       
+00000bc0: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
+00000bd0: 6e64 4361 6c6c 7328 290a 2020 2020 2020  ndCalls().      
+00000be0: 2020 666f 7220 7265 6c61 7469 6f6e 2069    for relation i
+00000bf0: 6e20 7365 6c66 2e6d 6f64 656c 2e72 656c  n self.model.rel
+00000c00: 6174 696f 6e73 5b27 6462 3127 5d3a 0a20  ations['db1']:. 
+00000c10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000c20: 6173 7365 7274 496e 2873 656c 662e 6d6f  assertIn(self.mo
+00000c30: 6465 6c2e 756e 6974 2c20 7265 6c61 7469  del.unit, relati
+00000c40: 6f6e 2e64 6174 6129 0a20 2020 2020 2020  on.data).       
+00000c50: 2020 2020 2075 6e69 745f 6672 6f6d 5f72       unit_from_r
+00000c60: 656c 203d 206e 6578 7428 6669 6c74 6572  el = next(filter
+00000c70: 286c 616d 6264 6120 753a 2075 2e6e 616d  (lambda u: u.nam
+00000c80: 6520 3d3d 2027 6d79 6170 702f 3027 2c20  e == 'myapp/0', 
+00000c90: 7265 6c61 7469 6f6e 2e64 6174 612e 6b65  relation.data.ke
+00000ca0: 7973 2829 2929 0a20 2020 2020 2020 2020  ys())).         
+00000cb0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+00000cc0: 2873 656c 662e 6d6f 6465 6c2e 756e 6974  (self.model.unit
+00000cd0: 2c20 756e 6974 5f66 726f 6d5f 7265 6c29  , unit_from_rel)
+00000ce0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00000cf0: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
+00000d00: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
+00000d10: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
+00000d20: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
+00000d30: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+00000d40: 6c69 7374 272c 2072 656c 5f61 7070 3129  list', rel_app1)
+00000d50: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+00000d60: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
+00000d70: 7265 6c5f 6170 7032 292c 0a20 2020 2020  rel_app2),.     
+00000d80: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+00000d90: 6573 745f 7265 6c61 7469 6f6e 735f 696d  est_relations_im
+00000da0: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
+00000db0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00000dc0: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
+00000dd0: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00000de0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000df0: 6d6f 6465 6c2e 7265 6c61 7469 6f6e 7320  model.relations 
+00000e00: 3d20 7b7d 0a0a 2020 2020 6465 6620 7465  = {}..    def te
+00000e10: 7374 5f67 6574 5f72 656c 6174 696f 6e28  st_get_relation(
+00000e20: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+00000e30: 206f 6e65 2072 656c 6174 696f 6e20 6f6e   one relation on
+00000e40: 2064 6231 0a20 2020 2020 2020 2023 2074   db1.        # t
+00000e50: 776f 2072 656c 6174 696f 6e73 206f 6e20  wo relations on 
+00000e60: 6462 300a 2020 2020 2020 2020 2320 6e6f  db0.        # no
+00000e70: 2072 656c 6174 696f 6e73 206f 6e20 6462   relations on db
+00000e80: 320a 2020 2020 2020 2020 7265 6c61 7469  2.        relati
+00000e90: 6f6e 5f69 645f 6462 3120 3d20 7365 6c66  on_id_db1 = self
+00000ea0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+00000eb0: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
+00000ec0: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
+00000ed0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00000ee0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00000ef0: 7428 7265 6c61 7469 6f6e 5f69 645f 6462  t(relation_id_db
+00000f00: 312c 2027 7265 6d6f 7465 6170 7031 2f30  1, 'remoteapp1/0
+00000f10: 2729 0a20 2020 2020 2020 2072 656c 6174  ').        relat
+00000f20: 696f 6e5f 6964 5f64 6230 5f62 203d 2073  ion_id_db0_b = s
+00000f30: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+00000f40: 7265 6c61 7469 6f6e 2827 6462 3027 2c20  relation('db0', 
+00000f50: 2761 6e6f 7468 6572 2729 0a20 2020 2020  'another').     
+00000f60: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+00000f70: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00000f80: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00000f90: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+00000fa0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
+00000fb0: 2020 2020 2020 2020 2023 2059 6f75 2068           # You h
+00000fc0: 6176 6520 746f 2073 7065 6369 6679 2069  ave to specify i
+00000fd0: 7420 6279 206a 7573 7420 7468 6520 696e  t by just the in
+00000fe0: 7465 6765 7220 4944 0a20 2020 2020 2020  teger ID.       
+00000ff0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+00001000: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00001010: 3127 2c20 6627 6462 313a 7b72 656c 6174  1', f'db1:{relat
+00001020: 696f 6e5f 6964 5f64 6231 7d27 290a 2020  ion_id_db1}').  
+00001030: 2020 2020 2020 7265 6c5f 6462 3120 3d20        rel_db1 = 
+00001040: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+00001050: 656c 6174 696f 6e28 2764 6231 272c 2072  elation('db1', r
+00001060: 656c 6174 696f 6e5f 6964 5f64 6231 290a  elation_id_db1).
+00001070: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00001080: 6572 7449 7349 6e73 7461 6e63 6528 7265  ertIsInstance(re
+00001090: 6c5f 6462 312c 206f 7073 2e52 656c 6174  l_db1, ops.Relat
+000010a0: 696f 6e29 0a20 2020 2020 2020 2073 656c  ion).        sel
+000010b0: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+000010c0: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
+000010d0: 2020 2028 2772 656c 6174 696f 6e5f 6964     ('relation_id
+000010e0: 7327 2c20 2764 6231 2729 2c0a 2020 2020  s', 'db1'),.    
+000010f0: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
+00001100: 6f6e 5f6c 6973 7427 2c20 7265 6c61 7469  on_list', relati
+00001110: 6f6e 5f69 645f 6462 3129 2c0a 2020 2020  on_id_db1),.    
+00001120: 2020 2020 5d29 0a20 2020 2020 2020 2064      ]).        d
+00001130: 6561 645f 7265 6c20 3d20 7365 6c66 2e6d  ead_rel = self.m
+00001140: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
+00001150: 6e28 2764 6231 272c 2037 290a 2020 2020  n('db1', 7).    
+00001160: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+00001170: 7349 6e73 7461 6e63 6528 6465 6164 5f72  sInstance(dead_r
+00001180: 656c 2c20 6f70 732e 5265 6c61 7469 6f6e  el, ops.Relation
+00001190: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000011a0: 7373 6572 7445 7175 616c 2873 6574 2864  ssertEqual(set(d
+000011b0: 6561 645f 7265 6c2e 6461 7461 2e6b 6579  ead_rel.data.key
+000011c0: 7328 2929 2c20 7b73 656c 662e 6d6f 6465  s()), {self.mode
+000011d0: 6c2e 756e 6974 2c20 7365 6c66 2e6d 6f64  l.unit, self.mod
+000011e0: 656c 2e75 6e69 742e 6170 707d 290a 2020  el.unit.app}).  
+000011f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00001200: 7445 7175 616c 2864 6561 645f 7265 6c2e  tEqual(dead_rel.
+00001210: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
+00001220: 756e 6974 5d2c 207b 7d29 0a20 2020 2020  unit], {}).     
+00001230: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
+00001240: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
+00001250: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+00001260: 696f 6e5f 6c69 7374 272c 2037 292c 0a20  ion_list', 7),. 
+00001270: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
+00001280: 6174 696f 6e5f 7265 6d6f 7465 5f61 7070  ation_remote_app
+00001290: 5f6e 616d 6527 2c20 3729 2c0a 2020 2020  _name', 7),.    
+000012a0: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
+000012b0: 6f6e 5f67 6574 272c 2037 2c20 276d 7961  on_get', 7, 'mya
+000012c0: 7070 2f30 272c 2046 616c 7365 292c 0a20  pp/0', False),. 
+000012d0: 2020 2020 2020 205d 290a 0a20 2020 2020         ])..     
+000012e0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+000012f0: 4e6f 6e65 2873 656c 662e 6d6f 6465 6c2e  None(self.model.
+00001300: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00001310: 3227 2929 0a20 2020 2020 2020 2073 656c  2')).        sel
+00001320: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+00001330: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
+00001340: 2020 2028 2772 656c 6174 696f 6e5f 6964     ('relation_id
+00001350: 7327 2c20 2764 6232 2729 2c0a 2020 2020  s', 'db2'),.    
+00001360: 2020 2020 5d29 0a20 2020 2020 2020 2073      ]).        s
+00001370: 656c 662e 6173 7365 7274 4973 2873 656c  elf.assertIs(sel
+00001380: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+00001390: 7469 6f6e 2827 6462 3127 292c 2072 656c  tion('db1'), rel
+000013a0: 5f64 6231 290a 2020 2020 2020 2020 7769  _db1).        wi
+000013b0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+000013c0: 6973 6573 286f 7073 2e54 6f6f 4d61 6e79  ises(ops.TooMany
+000013d0: 5265 6c61 7465 6441 7070 7345 7272 6f72  RelatedAppsError
+000013e0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000013f0: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
+00001400: 6c61 7469 6f6e 2827 6462 3027 290a 0a20  lation('db0').. 
+00001410: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00001420: 7274 4261 636b 656e 6443 616c 6c73 285b  rtBackendCalls([
+00001430: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
+00001440: 656c 6174 696f 6e5f 6964 7327 2c20 2764  elation_ids', 'd
+00001450: 6230 2729 2c0a 2020 2020 2020 2020 2020  b0'),.          
+00001460: 2020 2827 7265 6c61 7469 6f6e 5f6c 6973    ('relation_lis
+00001470: 7427 2c20 7365 6c66 2e72 656c 6174 696f  t', self.relatio
+00001480: 6e5f 6964 5f64 6230 292c 0a20 2020 2020  n_id_db0),.     
+00001490: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+000014a0: 6e5f 7265 6d6f 7465 5f61 7070 5f6e 616d  n_remote_app_nam
+000014b0: 6527 2c20 3029 2c0a 2020 2020 2020 2020  e', 0),.        
+000014c0: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
+000014d0: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
+000014e0: 645f 6462 305f 6229 2c0a 2020 2020 2020  d_db0_b),.      
+000014f0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
+00001500: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
+00001510: 272c 2032 292c 0a20 2020 2020 2020 205d  ', 2),.        ]
+00001520: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00001530: 7065 6572 5f72 656c 6174 696f 6e5f 6170  peer_relation_ap
+00001540: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
+00001550: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00001560: 645f 7265 6c61 7469 6f6e 2827 6462 3227  d_relation('db2'
+00001570: 2c20 276d 7961 7070 2729 0a20 2020 2020  , 'myapp').     
+00001580: 2020 2072 656c 5f64 6270 6565 7220 3d20     rel_dbpeer = 
+00001590: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+000015a0: 656c 6174 696f 6e28 2764 6232 2729 0a20  elation('db2'). 
+000015b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000015c0: 7274 4973 2872 656c 5f64 6270 6565 722e  rtIs(rel_dbpeer.
+000015d0: 6170 702c 2073 656c 662e 6d6f 6465 6c2e  app, self.model.
+000015e0: 6170 7029 0a0a 2020 2020 6465 6620 7465  app)..    def te
+000015f0: 7374 5f72 656d 6f74 655f 756e 6974 735f  st_remote_units_
+00001600: 6973 5f6f 7572 2873 656c 6629 3a0a 2020  is_our(self):.  
+00001610: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+00001620: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
+00001630: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+00001640: 6231 272c 2027 7265 6d6f 7465 6170 7031  b1', 'remoteapp1
+00001650: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00001660: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00001670: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
+00001680: 6f6e 5f69 642c 2027 7265 6d6f 7465 6170  on_id, 'remoteap
+00001690: 7031 2f30 2729 0a20 2020 2020 2020 2073  p1/0').        s
+000016a0: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+000016b0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
+000016c0: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
+000016d0: 7465 6170 7031 2f31 2729 0a20 2020 2020  teapp1/1').     
+000016e0: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+000016f0: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00001700: 2020 2020 2066 6f72 2075 2069 6e20 7365       for u in se
+00001710: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
+00001720: 6174 696f 6e28 2764 6231 2729 2e75 6e69  ation('db1').uni
+00001730: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00001740: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
+00001750: 2875 2e5f 6973 5f6f 7572 5f75 6e69 7429  (u._is_our_unit)
+00001760: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00001770: 662e 6173 7365 7274 4661 6c73 6528 752e  f.assertFalse(u.
+00001780: 6170 702e 5f69 735f 6f75 725f 6170 7029  app._is_our_app)
+00001790: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+000017a0: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
+000017b0: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
+000017c0: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
+000017d0: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
+000017e0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+000017f0: 6c69 7374 272c 2072 656c 6174 696f 6e5f  list', relation_
+00001800: 6964 290a 2020 2020 2020 2020 5d29 0a0a  id).        ])..
+00001810: 2020 2020 6465 6620 7465 7374 5f6f 7572      def test_our
+00001820: 5f75 6e69 745f 6973 5f6f 7572 2873 656c  _unit_is_our(sel
+00001830: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00001840: 2e61 7373 6572 7454 7275 6528 7365 6c66  .assertTrue(self
+00001850: 2e6d 6f64 656c 2e75 6e69 742e 5f69 735f  .model.unit._is_
+00001860: 6f75 725f 756e 6974 290a 2020 2020 2020  our_unit).      
+00001870: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+00001880: 6528 7365 6c66 2e6d 6f64 656c 2e75 6e69  e(self.model.uni
+00001890: 742e 6170 702e 5f69 735f 6f75 725f 6170  t.app._is_our_ap
+000018a0: 7029 0a0a 2020 2020 6465 6620 7465 7374  p)..    def test
+000018b0: 5f69 6e76 616c 6964 5f74 7970 655f 7265  _invalid_type_re
+000018c0: 6c61 7469 6f6e 5f64 6174 6128 7365 6c66  lation_data(self
+000018d0: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
+000018e0: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
+000018f0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00001900: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
+00001910: 6561 7070 3127 290a 2020 2020 2020 2020  eapp1').        
+00001920: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00001930: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00001940: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+00001950: 6f74 6561 7070 312f 3027 290a 0a20 2020  oteapp1/0')..   
+00001960: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00001970: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+00001980: 5265 6c61 7469 6f6e 4461 7461 4572 726f  RelationDataErro
+00001990: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000019a0: 7769 7468 2073 656c 662e 6861 726e 6573  with self.harnes
+000019b0: 732e 5f65 7665 6e74 5f63 6f6e 7465 7874  s._event_context
+000019c0: 2827 666f 6f5f 6576 656e 7427 293a 0a20  ('foo_event'):. 
+000019d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000019e0: 656c 662e 6861 726e 6573 732e 7570 6461  elf.harness.upda
+000019f0: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00001a00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00001a10: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+00001a20: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00001a30: 2020 2020 2020 2027 7265 6d6f 7465 6170         'remoteap
+00001a40: 7031 2f30 272c 0a20 2020 2020 2020 2020  p1/0',.         
+00001a50: 2020 2020 2020 2020 2020 207b 3432 3a20             {42: 
+00001a60: 2772 656d 6f74 6561 7070 312d 3027 7d29  'remoteapp1-0'})
+00001a70: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+00001a80: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00001a90: 286f 7073 2e52 656c 6174 696f 6e44 6174  (ops.RelationDat
+00001aa0: 6145 7272 6f72 293a 0a20 2020 2020 2020  aError):.       
+00001ab0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
+00001ac0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
+00001ad0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
+00001ae0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00001af0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00001b00: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+00001b10: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+00001b20: 2020 2020 2020 2020 2020 2072 656c 6174             relat
+00001b30: 696f 6e5f 6964 2c0a 2020 2020 2020 2020  ion_id,.        
+00001b40: 2020 2020 2020 2020 2020 2020 2772 656d              'rem
+00001b50: 6f74 6561 7070 312f 3027 2c0a 2020 2020  oteapp1/0',.    
+00001b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b70: 7b27 666f 6f27 3a20 3432 7d29 0a0a 2020  {'foo': 42})..  
+00001b80: 2020 6465 6620 7465 7374 5f67 6574 5f61    def test_get_a
+00001b90: 7070 5f72 656c 6174 696f 6e5f 6461 7461  pp_relation_data
+00001ba0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00001bb0: 7365 6c66 2e68 6172 6e65 7373 2e62 6567  self.harness.beg
+00001bc0: 696e 2829 0a20 2020 2020 2020 2072 656c  in().        rel
+00001bd0: 6174 696f 6e5f 6964 203d 2073 656c 662e  ation_id = self.
+00001be0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00001bf0: 7469 6f6e 2827 6462 3127 2c20 2772 656d  tion('db1', 'rem
+00001c00: 6f74 6527 290a 2020 2020 2020 2020 7365  ote').        se
+00001c10: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+00001c20: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00001c30: 6174 696f 6e5f 6964 2c20 2772 656d 6f74  ation_id, 'remot
+00001c40: 652f 3027 290a 2020 2020 2020 2020 6c6f  e/0').        lo
+00001c50: 6361 6c5f 6170 7020 3d20 7365 6c66 2e68  cal_app = self.h
+00001c60: 6172 6e65 7373 2e6d 6f64 656c 2e61 7070  arness.model.app
+00001c70: 2e6e 616d 650a 2020 2020 2020 2020 7769  .name.        wi
+00001c80: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
+00001c90: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+00001ca0: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
+00001cb0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+00001cc0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
+00001cd0: 6174 696f 6e5f 6461 7461 280a 2020 2020  ation_data(.    
+00001ce0: 2020 2020 2020 2020 2020 2020 7265 6c61              rela
+00001cf0: 7469 6f6e 5f69 642c 0a20 2020 2020 2020  tion_id,.       
+00001d00: 2020 2020 2020 2020 206c 6f63 616c 5f61           local_a
+00001d10: 7070 2c0a 2020 2020 2020 2020 2020 2020  pp,.            
+00001d20: 2020 2020 7b27 666f 6f27 3a20 2762 6172      {'foo': 'bar
+00001d30: 277d 290a 2020 2020 2020 2020 2020 2020  '}).            
+00001d40: 6173 7365 7274 2073 656c 662e 6861 726e  assert self.harn
+00001d50: 6573 732e 6765 745f 7265 6c61 7469 6f6e  ess.get_relation
+00001d60: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+00001d70: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+00001d80: 6964 2c20 7365 6c66 2e68 6172 6e65 7373  id, self.harness
+00001d90: 2e6d 6f64 656c 2e61 7070 2920 3d3d 2073  .model.app) == s
+00001da0: 656c 662e 6861 726e 6573 732e 6765 745f  elf.harness.get_
+00001db0: 7265 6c61 7469 6f6e 5f64 6174 6128 0a20  relation_data(. 
+00001dc0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001dd0: 656c 6174 696f 6e5f 6964 2c20 6c6f 6361  elation_id, loca
+00001de0: 6c5f 6170 7029 203d 3d20 7b27 666f 6f27  l_app) == {'foo'
+00001df0: 3a20 2762 6172 277d 0a0a 2020 2020 6465  : 'bar'}..    de
+00001e00: 6620 7465 7374 5f75 6e69 745f 7265 6c61  f test_unit_rela
+00001e10: 7469 6f6e 5f64 6174 6128 7365 6c66 293a  tion_data(self):
+00001e20: 0a20 2020 2020 2020 2072 656c 6174 696f  .        relatio
+00001e30: 6e5f 6964 203d 2073 656c 662e 6861 726e  n_id = self.harn
+00001e40: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00001e50: 2827 6462 3127 2c20 2772 656d 6f74 6561  ('db1', 'remotea
+00001e60: 7070 3127 290a 2020 2020 2020 2020 7365  pp1').        se
+00001e70: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+00001e80: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00001e90: 6174 696f 6e5f 6964 2c20 2772 656d 6f74  ation_id, 'remot
+00001ea0: 6561 7070 312f 3027 290a 2020 2020 2020  eapp1/0').      
+00001eb0: 2020 7769 7468 2073 656c 662e 6861 726e    with self.harn
+00001ec0: 6573 732e 5f65 7665 6e74 5f63 6f6e 7465  ess._event_conte
+00001ed0: 7874 2827 666f 6f5f 6576 656e 7427 293a  xt('foo_event'):
+00001ee0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00001ef0: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
+00001f00: 5f72 656c 6174 696f 6e5f 6461 7461 280a  _relation_data(.
+00001f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001f20: 7265 6c61 7469 6f6e 5f69 642c 0a20 2020  relation_id,.   
+00001f30: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00001f40: 6d6f 7465 6170 7031 2f30 272c 0a20 2020  moteapp1/0',.   
+00001f50: 2020 2020 2020 2020 2020 2020 207b 2768               {'h
+00001f60: 6f73 7427 3a20 2772 656d 6f74 6561 7070  ost': 'remoteapp
+00001f70: 312d 3027 7d29 0a20 2020 2020 2020 2073  1-0'}).        s
+00001f80: 656c 662e 6d6f 6465 6c2e 7265 6c61 7469  elf.model.relati
+00001f90: 6f6e 732e 5f69 6e76 616c 6964 6174 6528  ons._invalidate(
+00001fa0: 2764 6231 2729 0a20 2020 2020 2020 2073  'db1').        s
+00001fb0: 656c 662e 7265 7365 7442 6163 6b65 6e64  elf.resetBackend
+00001fc0: 4361 6c6c 7328 290a 0a20 2020 2020 2020  Calls()..       
+00001fd0: 2072 616e 646f 6d5f 756e 6974 203d 2073   random_unit = s
+00001fe0: 656c 662e 6d6f 6465 6c2e 6765 745f 756e  elf.model.get_un
+00001ff0: 6974 2827 7261 6e64 6f6d 756e 6974 2f30  it('randomunit/0
+00002000: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
+00002010: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00002020: 7328 4b65 7945 7272 6f72 293a 0a20 2020  s(KeyError):.   
+00002030: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
+00002040: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+00002050: 2827 6462 3127 292e 6461 7461 5b72 616e  ('db1').data[ran
+00002060: 646f 6d5f 756e 6974 5d0a 2020 2020 2020  dom_unit].      
+00002070: 2020 7265 6d6f 7465 6170 7031 5f30 203d    remoteapp1_0 =
+00002080: 206e 6578 7428 6669 6c74 6572 286c 616d   next(filter(lam
+00002090: 6264 6120 753a 2075 2e6e 616d 6520 3d3d  bda u: u.name ==
+000020a0: 2027 7265 6d6f 7465 6170 7031 2f30 272c   'remoteapp1/0',
+000020b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000020c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000020d0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e67      self.model.g
+000020e0: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+000020f0: 2729 2e75 6e69 7473 2929 0a20 2020 2020  ').units)).     
+00002100: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00002110: 7561 6c28 7365 6c66 2e6d 6f64 656c 2e67  ual(self.model.g
+00002120: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+00002130: 2729 2e64 6174 615b 7265 6d6f 7465 6170  ').data[remoteap
+00002140: 7031 5f30 5d2c 0a20 2020 2020 2020 2020  p1_0],.         
+00002150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002160: 7b27 686f 7374 273a 2027 7265 6d6f 7465  {'host': 'remote
+00002170: 6170 7031 2d30 277d 290a 0a20 2020 2020  app1-0'})..     
+00002180: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
+00002190: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
+000021a0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+000021b0: 696f 6e5f 6964 7327 2c20 2764 6231 2729  ion_ids', 'db1')
+000021c0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+000021d0: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
+000021e0: 7265 6c61 7469 6f6e 5f69 6429 2c0a 2020  relation_id),.  
+000021f0: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
+00002200: 7469 6f6e 5f67 6574 272c 2072 656c 6174  tion_get', relat
+00002210: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
+00002220: 7070 312f 3027 2c20 4661 6c73 6529 2c0a  pp1/0', False),.
+00002230: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+00002240: 6465 6620 7465 7374 5f72 656d 6f74 655f  def test_remote_
+00002250: 6170 705f 7265 6c61 7469 6f6e 5f64 6174  app_relation_dat
+00002260: 6128 7365 6c66 293a 0a20 2020 2020 2020  a(self):.       
+00002270: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
+00002280: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+00002290: 7265 6c61 7469 6f6e 2827 6462 3127 2c20  relation('db1', 
+000022a0: 2772 656d 6f74 6561 7070 3127 290a 2020  'remoteapp1').  
+000022b0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000022c0: 6861 726e 6573 732e 5f65 7665 6e74 5f63  harness._event_c
+000022d0: 6f6e 7465 7874 2827 666f 6f5f 6576 656e  ontext('foo_even
+000022e0: 7427 293a 0a20 2020 2020 2020 2020 2020  t'):.           
+000022f0: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
+00002300: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00002310: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
+00002320: 2772 656d 6f74 6561 7070 3127 2c0a 2020  'remoteapp1',.  
+00002330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002350: 2020 2020 2020 2020 2020 2020 7b27 7365              {'se
+00002360: 6372 6574 273a 2027 6361 6665 6465 6164  cret': 'cafedead
+00002370: 6265 6566 277d 290a 2020 2020 2020 2020  beef'}).        
+00002380: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00002390: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+000023a0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+000023b0: 6f74 6561 7070 312f 3027 290a 2020 2020  oteapp1/0').    
+000023c0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+000023d0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+000023e0: 6974 2872 656c 6174 696f 6e5f 6964 2c20  it(relation_id, 
+000023f0: 2772 656d 6f74 6561 7070 312f 3127 290a  'remoteapp1/1').
+00002400: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+00002410: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
+00002420: 0a0a 2020 2020 2020 2020 7265 6c5f 6462  ..        rel_db
+00002430: 3120 3d20 7365 6c66 2e6d 6f64 656c 2e67  1 = self.model.g
+00002440: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+00002450: 2729 0a20 2020 2020 2020 2023 2054 7279  ').        # Try
+00002460: 2074 6f20 6765 7420 7265 6c61 7469 6f6e   to get relation
+00002470: 2064 6174 6120 666f 7220 616e 2069 6e76   data for an inv
+00002480: 616c 6964 2072 656d 6f74 6520 6170 706c  alid remote appl
+00002490: 6963 6174 696f 6e2e 0a20 2020 2020 2020  ication..       
+000024a0: 2072 616e 646f 6d5f 6170 7020 3d20 7365   random_app = se
+000024b0: 6c66 2e6d 6f64 656c 2e5f 6361 6368 652e  lf.model._cache.
+000024c0: 6765 7428 6f70 732e 4170 706c 6963 6174  get(ops.Applicat
+000024d0: 696f 6e2c 2027 7261 6e64 6f6d 6170 7027  ion, 'randomapp'
+000024e0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+000024f0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00002500: 284b 6579 4572 726f 7229 3a0a 2020 2020  (KeyError):.    
+00002510: 2020 2020 2020 2020 7265 6c5f 6462 312e          rel_db1.
+00002520: 6461 7461 5b72 616e 646f 6d5f 6170 705d  data[random_app]
+00002530: 0a0a 2020 2020 2020 2020 7265 6d6f 7465  ..        remote
+00002540: 6170 7031 203d 2072 656c 5f64 6231 2e61  app1 = rel_db1.a
+00002550: 7070 0a20 2020 2020 2020 2073 656c 662e  pp.        self.
+00002560: 6173 7365 7274 4571 7561 6c28 7265 6d6f  assertEqual(remo
+00002570: 7465 6170 7031 2e6e 616d 652c 2027 7265  teapp1.name, 're
+00002580: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
+00002590: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000025a0: 7561 6c28 7265 6c5f 6462 312e 6461 7461  ual(rel_db1.data
+000025b0: 5b72 656d 6f74 6561 7070 315d 2c0a 2020  [remoteapp1],.  
+000025c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025d0: 2020 2020 2020 207b 2773 6563 7265 7427         {'secret'
+000025e0: 3a20 2763 6166 6564 6561 6462 6565 6627  : 'cafedeadbeef'
+000025f0: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
+00002600: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00002610: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
+00002620: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
+00002630: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
+00002640: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00002650: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
+00002660: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
+00002670: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+00002680: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+00002690: 2027 7265 6d6f 7465 6170 7031 272c 2054   'remoteapp1', T
+000026a0: 7275 6529 2c0a 2020 2020 2020 2020 5d29  rue),.        ])
+000026b0: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
+000026c0: 656c 6174 696f 6e5f 6461 7461 5f6d 6f64  elation_data_mod
+000026d0: 6966 795f 7265 6d6f 7465 2873 656c 6629  ify_remote(self)
+000026e0: 3a0a 2020 2020 2020 2020 7265 6c61 7469  :.        relati
+000026f0: 6f6e 5f69 6420 3d20 7365 6c66 2e68 6172  on_id = self.har
+00002700: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00002710: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
+00002720: 6170 7031 2729 0a20 2020 2020 2020 2077  app1').        w
+00002730: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+00002740: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
+00002750: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
+00002760: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+00002770: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+00002780: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
+00002790: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
+000027a0: 6170 7031 272c 0a20 2020 2020 2020 2020  app1',.         
+000027b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027d0: 2020 2020 207b 2773 6563 7265 7427 3a20       {'secret': 
+000027e0: 2763 6166 6564 6561 6462 6565 6627 7d29  'cafedeadbeef'})
+000027f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00002800: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
+00002810: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
+00002820: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
+00002830: 6170 7031 2f30 2729 0a20 2020 2020 2020  app1/0').       
+00002840: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00002850: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00002860: 6e5f 6461 7461 2872 656c 6174 696f 6e5f  n_data(relation_
+00002870: 6964 2c20 2772 656d 6f74 6561 7070 312f  id, 'remoteapp1/
+00002880: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
 00002890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000028a0: 2020 2020 2020 207b 2773 6563 7265 7427         {'secret'
-000028b0: 3a20 2763 6166 6564 6561 6462 6565 6627  : 'cafedeadbeef'
-000028c0: 7d29 0a20 2020 2020 2020 2020 2020 2073  }).            s
-000028d0: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-000028e0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-000028f0: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
-00002900: 7465 6170 7031 2f30 2729 0a20 2020 2020  teapp1/0').     
-00002910: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-00002920: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00002930: 696f 6e5f 6461 7461 2872 656c 6174 696f  ion_data(relatio
-00002940: 6e5f 6964 2c20 2772 656d 6f74 6561 7070  n_id, 'remoteapp
-00002950: 312f 3027 2c0a 2020 2020 2020 2020 2020  1/0',.          
-00002960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002980: 2020 2020 7b27 686f 7374 273a 2027 7265      {'host': 're
-00002990: 6d6f 7465 6170 7031 2f30 277d 290a 2020  moteapp1/0'}).  
-000029a0: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-000029b0: 2e72 656c 6174 696f 6e73 2e5f 696e 7661  .relations._inva
-000029c0: 6c69 6461 7465 2827 6462 3127 290a 2020  lidate('db1').  
-000029d0: 2020 2020 2020 7365 6c66 2e72 6573 6574        self.reset
-000029e0: 4261 636b 656e 6443 616c 6c73 2829 0a0a  BackendCalls()..
-000029f0: 2020 2020 2020 2020 7265 6c5f 6462 3120          rel_db1 
-00002a00: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-00002a10: 5f72 656c 6174 696f 6e28 2764 6231 2729  _relation('db1')
-00002a20: 0a20 2020 2020 2020 2072 656d 6f74 6561  .        remotea
-00002a30: 7070 315f 3020 3d20 6e65 7874 2866 696c  pp1_0 = next(fil
-00002a40: 7465 7228 6c61 6d62 6461 2075 3a20 752e  ter(lambda u: u.
-00002a50: 6e61 6d65 203d 3d20 2772 656d 6f74 6561  name == 'remotea
-00002a60: 7070 312f 3027 2c0a 2020 2020 2020 2020  pp1/0',.        
-00002a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00002a90: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
-00002aa0: 6f6e 2827 6462 3127 292e 756e 6974 7329  on('db1').units)
-00002ab0: 290a 2020 2020 2020 2020 2320 466f 7263  ).        # Forc
-00002ac0: 6520 6d65 6d6f 7279 2063 6163 6865 2074  e memory cache t
-00002ad0: 6f20 6265 206c 6f61 6465 642e 0a20 2020  o be loaded..   
-00002ae0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00002af0: 496e 2827 686f 7374 272c 2072 656c 5f64  In('host', rel_d
-00002b00: 6231 2e64 6174 615b 7265 6d6f 7465 6170  b1.data[remoteap
-00002b10: 7031 5f30 5d29 0a20 2020 2020 2020 2073  p1_0]).        s
-00002b20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00002b30: 7265 7072 2872 656c 5f64 6231 2e64 6174  repr(rel_db1.dat
-00002b40: 615b 7265 6d6f 7465 6170 7031 5f30 5d29  a[remoteapp1_0])
-00002b50: 2c20 227b 2768 6f73 7427 3a20 2772 656d  , "{'host': 'rem
-00002b60: 6f74 6561 7070 312f 3027 7d22 290a 0a20  oteapp1/0'}").. 
-00002b70: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00002b80: 2e68 6172 6e65 7373 2e5f 6576 656e 745f  .harness._event_
-00002b90: 636f 6e74 6578 7428 2766 6f6f 5f65 7665  context('foo_eve
-00002ba0: 6e74 2729 3a0a 2020 2020 2020 2020 2020  nt'):.          
-00002bb0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00002bc0: 7274 5261 6973 6573 286f 7073 2e6d 6f64  rtRaises(ops.mod
-00002bd0: 656c 2e52 656c 6174 696f 6e44 6174 6145  el.RelationDataE
-00002be0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00002bf0: 2020 2020 2020 2072 656c 5f64 6231 2e64         rel_db1.d
-00002c00: 6174 615b 7265 6d6f 7465 6170 7031 5f30  ata[remoteapp1_0
-00002c10: 5d5b 2766 6f6f 275d 203d 2027 6261 7227  ]['foo'] = 'bar'
-00002c20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00002c30: 7365 7274 4e6f 7449 6e28 2766 6f6f 272c  sertNotIn('foo',
-00002c40: 2072 656c 5f64 6231 2e64 6174 615b 7265   rel_db1.data[re
-00002c50: 6d6f 7465 6170 7031 5f30 5d29 0a0a 2020  moteapp1_0])..  
-00002c60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00002c70: 7442 6163 6b65 6e64 4361 6c6c 7328 5b0a  tBackendCalls([.
-00002c80: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
-00002c90: 6c61 7469 6f6e 5f69 6473 272c 2027 6462  lation_ids', 'db
-00002ca0: 3127 292c 0a20 2020 2020 2020 2020 2020  1'),.           
-00002cb0: 2028 2772 656c 6174 696f 6e5f 6c69 7374   ('relation_list
-00002cc0: 272c 2072 656c 6174 696f 6e5f 6964 292c  ', relation_id),
-00002cd0: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
-00002ce0: 656c 6174 696f 6e5f 6765 7427 2c20 7265  elation_get', re
-00002cf0: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
-00002d00: 7465 6170 7031 2f30 272c 2046 616c 7365  teapp1/0', False
-00002d10: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-00002d20: 2020 2020 2020 2023 2074 6869 7320 7769         # this wi
-00002d30: 6c6c 2066 6972 6520 6d6f 7265 2062 6163  ll fire more bac
-00002d40: 6b65 6e64 2063 616c 6c73 0a20 2020 2020  kend calls.     
-00002d50: 2020 2077 6974 6820 7365 6c66 2e68 6172     with self.har
-00002d60: 6e65 7373 2e5f 6576 656e 745f 636f 6e74  ness._event_cont
-00002d70: 6578 7428 2766 6f6f 5f65 7665 6e74 2729  ext('foo_event')
-00002d80: 3a0a 2020 2020 2020 2020 2020 2020 6461  :.            da
-00002d90: 7461 5f72 6570 7220 3d20 7265 7072 2872  ta_repr = repr(r
-00002da0: 656c 5f64 6231 2e64 6174 6129 0a20 2020  el_db1.data).   
-00002db0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00002dc0: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
-00002dd0: 2020 2064 6174 615f 7265 7072 2c0a 2020     data_repr,.  
-00002de0: 2020 2020 2020 2020 2020 2827 7b3c 6f70            ('{<op
-00002df0: 732e 6d6f 6465 6c2e 556e 6974 206d 7961  s.model.Unit mya
-00002e00: 7070 2f30 3e3a 207b 7d2c 2027 0a20 2020  pp/0>: {}, '.   
-00002e10: 2020 2020 2020 2020 2020 273c 6f70 732e            '<ops.
-00002e20: 6d6f 6465 6c2e 4170 706c 6963 6174 696f  model.Applicatio
-00002e30: 6e20 6d79 6170 703e 3a20 3c6e 2f61 3e2c  n myapp>: <n/a>,
-00002e40: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00002e50: 223c 6f70 732e 6d6f 6465 6c2e 556e 6974  "<ops.model.Unit
-00002e60: 2072 656d 6f74 6561 7070 312f 303e 3a20   remoteapp1/0>: 
-00002e70: 7b27 686f 7374 273a 2027 7265 6d6f 7465  {'host': 'remote
-00002e80: 6170 7031 2f30 277d 2c20 220a 2020 2020  app1/0'}, ".    
-00002e90: 2020 2020 2020 2020 2022 3c6f 7073 2e6d           "<ops.m
-00002ea0: 6f64 656c 2e41 7070 6c69 6361 7469 6f6e  odel.Application
-00002eb0: 2072 656d 6f74 6561 7070 313e 3a20 7b27   remoteapp1>: {'
-00002ec0: 7365 6372 6574 273a 2027 6361 6665 6465  secret': 'cafede
-00002ed0: 6164 6265 6566 277d 7d22 2929 0a0a 2020  adbeef'}}"))..  
-00002ee0: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-00002ef0: 696f 6e5f 6461 7461 5f6d 6f64 6966 795f  ion_data_modify_
-00002f00: 6f75 7228 7365 6c66 293a 0a20 2020 2020  our(self):.     
-00002f10: 2020 2072 656c 6174 696f 6e5f 6964 203d     relation_id =
-00002f20: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00002f30: 645f 7265 6c61 7469 6f6e 2827 6462 3127  d_relation('db1'
-00002f40: 2c20 2772 656d 6f74 6561 7070 3127 290a  , 'remoteapp1').
-00002f50: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-00002f60: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00002f70: 6174 696f 6e5f 6461 7461 2872 656c 6174  ation_data(relat
-00002f80: 696f 6e5f 6964 2c20 276d 7961 7070 2f30  ion_id, 'myapp/0
-00002f90: 272c 207b 2768 6f73 7427 3a20 276e 6f74  ', {'host': 'not
-00002fa0: 6869 6e67 277d 290a 2020 2020 2020 2020  hing'}).        
-00002fb0: 7365 6c66 2e72 6573 6574 4261 636b 656e  self.resetBacken
-00002fc0: 6443 616c 6c73 2829 0a20 2020 2020 2020  dCalls().       
-00002fd0: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
-00002fe0: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
-00002ff0: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
-00003000: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
-00003010: 6462 3120 3d20 7365 6c66 2e6d 6f64 656c  db1 = self.model
-00003020: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-00003030: 6231 2729 0a20 2020 2020 2020 2020 2020  b1').           
-00003040: 2023 2075 7064 6174 655f 7265 6c61 7469   # update_relati
-00003050: 6f6e 5f64 6174 6120 7769 6c6c 2061 6c73  on_data will als
-00003060: 6f20 7472 6967 6765 7220 7265 6c61 7469  o trigger relati
-00003070: 6f6e 2d67 6574 2c20 736f 2077 650a 2020  on-get, so we.  
-00003080: 2020 2020 2020 2020 2020 2320 696e 7661            # inva
-00003090: 6c69 6461 7465 2074 6865 2063 6163 6865  lidate the cache
-000030a0: 2074 6f20 656e 7375 7265 2069 7420 7769   to ensure it wi
-000030b0: 6c6c 2062 6520 7265 6c6f 6164 6564 0a20  ll be reloaded. 
-000030c0: 2020 2020 2020 2020 2020 2072 656c 5f64             rel_d
-000030d0: 6231 2e64 6174 615b 7365 6c66 2e6d 6f64  b1.data[self.mod
-000030e0: 656c 2e75 6e69 745d 2e5f 696e 7661 6c69  el.unit]._invali
-000030f0: 6461 7465 2829 0a20 2020 2020 2020 2020  date().         
-00003100: 2020 2023 2046 6f72 6365 206d 656d 6f72     # Force memor
-00003110: 7920 6361 6368 6520 746f 2062 6520 6c6f  y cache to be lo
-00003120: 6164 6564 2e0a 2020 2020 2020 2020 2020  aded..          
-00003130: 2020 7365 6c66 2e61 7373 6572 7449 6e28    self.assertIn(
-00003140: 2768 6f73 7427 2c20 7265 6c5f 6462 312e  'host', rel_db1.
-00003150: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
-00003160: 756e 6974 5d29 0a20 2020 2020 2020 2020  unit]).         
-00003170: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
-00003180: 7365 6c66 2e6d 6f64 656c 2e75 6e69 745d  self.model.unit]
-00003190: 5b27 686f 7374 275d 203d 2027 6261 7227  ['host'] = 'bar'
-000031a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000031b0: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
-000031c0: 6c5f 6462 312e 6461 7461 5b73 656c 662e  l_db1.data[self.
-000031d0: 6d6f 6465 6c2e 756e 6974 5d5b 2768 6f73  model.unit]['hos
-000031e0: 7427 5d2c 2027 6261 7227 290a 0a20 2020  t'], 'bar')..   
-000031f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003200: 4261 636b 656e 6443 616c 6c73 285b 0a20  BackendCalls([. 
-00003210: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
-00003220: 6174 696f 6e5f 6765 7427 2c20 7265 6c61  ation_get', rela
-00003230: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
-00003240: 3027 2c20 4661 6c73 6529 2c0a 2020 2020  0', False),.    
-00003250: 2020 2020 2020 2020 2827 7570 6461 7465          ('update
-00003260: 5f72 656c 6174 696f 6e5f 6461 7461 272c  _relation_data',
-00003270: 2072 656c 6174 696f 6e5f 6964 2c20 7365   relation_id, se
-00003280: 6c66 2e6d 6f64 656c 2e75 6e69 742c 2027  lf.model.unit, '
-00003290: 686f 7374 272c 2027 6261 7227 292c 0a20  host', 'bar'),. 
-000032a0: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-000032b0: 6566 2074 6573 745f 6170 705f 7265 6c61  ef test_app_rela
-000032c0: 7469 6f6e 5f64 6174 615f 6d6f 6469 6679  tion_data_modify
-000032d0: 5f6c 6f63 616c 5f61 735f 6c65 6164 6572  _local_as_leader
-000032e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000032f0: 7265 6c61 7469 6f6e 5f69 6420 3d20 7365  relation_id = se
-00003300: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-00003310: 656c 6174 696f 6e28 2764 6231 272c 2027  elation('db1', '
-00003320: 7265 6d6f 7465 6170 7031 2729 0a20 2020  remoteapp1').   
-00003330: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00003340: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00003350: 6e5f 6461 7461 2872 656c 6174 696f 6e5f  n_data(relation_
-00003360: 6964 2c20 276d 7961 7070 272c 207b 2770  id, 'myapp', {'p
-00003370: 6173 7377 6f72 6427 3a20 2764 6561 6462  assword': 'deadb
-00003380: 6565 6663 6166 6527 7d29 0a20 2020 2020  eefcafe'}).     
-00003390: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-000033a0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-000033b0: 7428 7265 6c61 7469 6f6e 5f69 642c 2027  t(relation_id, '
-000033c0: 7265 6d6f 7465 6170 7031 2f30 2729 0a20  remoteapp1/0'). 
-000033d0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-000033e0: 6573 732e 7365 745f 6c65 6164 6572 2854  ess.set_leader(T
-000033f0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-00003400: 662e 7265 7365 7442 6163 6b65 6e64 4361  f.resetBackendCa
-00003410: 6c6c 7328 290a 0a20 2020 2020 2020 206c  lls()..        l
-00003420: 6f63 616c 5f61 7070 203d 2073 656c 662e  ocal_app = self.
-00003430: 6d6f 6465 6c2e 756e 6974 2e61 7070 0a0a  model.unit.app..
-00003440: 2020 2020 2020 2020 7265 6c5f 6462 3120          rel_db1 
-00003450: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-00003460: 5f72 656c 6174 696f 6e28 2764 6231 2729  _relation('db1')
-00003470: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00003480: 7365 7274 4571 7561 6c28 7265 6c5f 6462  sertEqual(rel_db
-00003490: 312e 6461 7461 5b6c 6f63 616c 5f61 7070  1.data[local_app
-000034a0: 5d2c 207b 2770 6173 7377 6f72 6427 3a20  ], {'password': 
-000034b0: 2764 6561 6462 6565 6663 6166 6527 7d29  'deadbeefcafe'})
-000034c0: 0a0a 2020 2020 2020 2020 7265 6c5f 6462  ..        rel_db
-000034d0: 312e 6461 7461 5b6c 6f63 616c 5f61 7070  1.data[local_app
-000034e0: 5d5b 2770 6173 7377 6f72 6427 5d20 3d20  ]['password'] = 
-000034f0: 2766 6f6f 270a 0a20 2020 2020 2020 2073  'foo'..        s
-00003500: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00003510: 7265 6c5f 6462 312e 6461 7461 5b6c 6f63  rel_db1.data[loc
-00003520: 616c 5f61 7070 5d5b 2770 6173 7377 6f72  al_app]['passwor
-00003530: 6427 5d2c 2027 666f 6f27 290a 0a20 2020  d'], 'foo')..   
-00003540: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003550: 4261 636b 656e 6443 616c 6c73 280a 2020  BackendCalls(.  
-00003560: 2020 2020 2020 2020 2020 5b28 2772 656c            [('rel
-00003570: 6174 696f 6e5f 6964 7327 2c20 2764 6231  ation_ids', 'db1
-00003580: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00003590: 2028 2772 656c 6174 696f 6e5f 6c69 7374   ('relation_list
-000035a0: 272c 2031 292c 0a20 2020 2020 2020 2020  ', 1),.         
-000035b0: 2020 2020 2827 7265 6c61 7469 6f6e 5f67      ('relation_g
-000035c0: 6574 272c 2031 2c20 276d 7961 7070 272c  et', 1, 'myapp',
-000035d0: 2054 7275 6529 2c0a 2020 2020 2020 2020   True),.        
-000035e0: 2020 2020 2028 2775 7064 6174 655f 7265       ('update_re
-000035f0: 6c61 7469 6f6e 5f64 6174 6127 2c20 312c  lation_data', 1,
-00003600: 2073 656c 662e 6d6f 6465 6c2e 6170 702c   self.model.app,
-00003610: 2027 7061 7373 776f 7264 272c 2027 666f   'password', 'fo
-00003620: 6f27 295d 290a 0a20 2020 2064 6566 2074  o')])..    def t
-00003630: 6573 745f 6170 705f 7265 6c61 7469 6f6e  est_app_relation
-00003640: 5f64 6174 615f 6d6f 6469 6679 5f6c 6f63  _data_modify_loc
-00003650: 616c 5f61 735f 6d69 6e69 6f6e 2873 656c  al_as_minion(sel
-00003660: 6629 3a0a 2020 2020 2020 2020 7265 6c61  f):.        rela
-00003670: 7469 6f6e 5f69 6420 3d20 7365 6c66 2e68  tion_id = self.h
-00003680: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00003690: 696f 6e28 2764 6231 272c 2027 7265 6d6f  ion('db1', 'remo
-000036a0: 7465 6170 7031 2729 0a20 2020 2020 2020  teapp1').       
-000036b0: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
-000036c0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-000036d0: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
-000036e0: 276d 7961 7070 272c 207b 2770 6173 7377  'myapp', {'passw
-000036f0: 6f72 6427 3a20 2764 6561 6462 6565 6663  ord': 'deadbeefc
-00003700: 6166 6527 7d29 0a20 2020 2020 2020 2073  afe'}).        s
-00003710: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00003720: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-00003730: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
-00003740: 7465 6170 7031 2f30 2729 0a20 2020 2020  teapp1/0').     
-00003750: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00003760: 7365 745f 6c65 6164 6572 2846 616c 7365  set_leader(False
-00003770: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-00003780: 6573 6574 4261 636b 656e 6443 616c 6c73  esetBackendCalls
-00003790: 2829 0a0a 2020 2020 2020 2020 6c6f 6361  ()..        loca
-000037a0: 6c5f 6170 7020 3d20 7365 6c66 2e6d 6f64  l_app = self.mod
-000037b0: 656c 2e75 6e69 742e 6170 700a 0a20 2020  el.unit.app..   
-000037c0: 2020 2020 2072 656c 5f64 6231 203d 2073       rel_db1 = s
-000037d0: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
-000037e0: 6c61 7469 6f6e 2827 6462 3127 290a 2020  lation('db1').  
-000037f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00003800: 7445 7175 616c 2872 656c 5f64 6231 2e64  tEqual(rel_db1.d
-00003810: 6174 615b 6c6f 6361 6c5f 6170 705d 2c20  ata[local_app], 
-00003820: 7b27 7061 7373 776f 7264 273a 2027 6465  {'password': 'de
-00003830: 6164 6265 6566 6361 6665 277d 290a 0a20  adbeefcafe'}).. 
-00003840: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00003850: 2e68 6172 6e65 7373 2e5f 6576 656e 745f  .harness._event_
-00003860: 636f 6e74 6578 7428 2766 6f6f 5f65 7665  context('foo_eve
-00003870: 6e74 2729 3a0a 2020 2020 2020 2020 2020  nt'):.          
-00003880: 2020 2320 6966 2077 6520 7765 7265 2069    # if we were i
-00003890: 6e73 6964 6520 616e 2065 7665 6e74 2063  nside an event c
-000038a0: 6f6e 7465 7874 2c20 7765 2764 2067 6574  ontext, we'd get
-000038b0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-000038c0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-000038d0: 6973 6573 286f 7073 2e6d 6f64 656c 2e52  ises(ops.model.R
-000038e0: 656c 6174 696f 6e44 6174 6145 7272 6f72  elationDataError
-000038f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00003900: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
-00003910: 6c6f 6361 6c5f 6170 705d 5b27 7061 7373  local_app]['pass
-00003920: 776f 7264 275d 203d 2027 666f 6f62 6172  word'] = 'foobar
-00003930: 270a 0a20 2020 2020 2020 2073 656c 662e  '..        self.
-00003940: 6173 7365 7274 4261 636b 656e 6443 616c  assertBackendCal
-00003950: 6c73 285b 2827 7265 6c61 7469 6f6e 5f69  ls([('relation_i
-00003960: 6473 272c 2027 6462 3127 292c 0a20 2020  ds', 'db1'),.   
-00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003980: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-00003990: 7265 6c61 7469 6f6e 5f6c 6973 7427 2c20  relation_list', 
-000039a0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-000039b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039c0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-000039d0: 6765 7427 2c20 312c 2027 6d79 6170 7027  get', 1, 'myapp'
-000039e0: 2c20 5472 7565 292c 0a20 2020 2020 2020  , True),.       
-000039f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a00: 2020 2020 2020 2020 2020 2827 6973 5f6c            ('is_l
-00003a10: 6561 6465 7227 2c29 5d29 0a0a 2020 2020  eader',)])..    
-00003a20: 6465 6620 7465 7374 5f72 656c 6174 696f  def test_relatio
-00003a30: 6e5f 6461 7461 5f61 6363 6573 735f 7065  n_data_access_pe
-00003a40: 6572 5f6c 6561 6465 7228 7365 6c66 293a  er_leader(self):
-00003a50: 0a20 2020 2020 2020 2072 5f69 6420 3d20  .        r_id = 
-00003a60: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-00003a70: 5f72 656c 6174 696f 6e28 2764 6232 272c  _relation('db2',
-00003a80: 2027 6d79 6170 7027 290a 2020 2020 2020   'myapp').      
-00003a90: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
-00003aa0: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
-00003ab0: 2872 5f69 642c 2027 6d79 6170 702f 3127  (r_id, 'myapp/1'
-00003ac0: 2920 2023 2070 6565 7221 0a20 2020 2020  )  # peer!.     
-00003ad0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00003ae0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
-00003af0: 6461 7461 2872 5f69 642c 2027 6d79 6170  data(r_id, 'myap
-00003b00: 7027 2c20 7b27 666f 6f27 3a20 2762 6172  p', {'foo': 'bar
-00003b10: 277d 290a 2020 2020 2020 2020 7769 7468  '}).        with
-00003b20: 2073 656c 662e 6861 726e 6573 732e 5f65   self.harness._e
-00003b30: 7665 6e74 5f63 6f6e 7465 7874 2827 666f  vent_context('fo
-00003b40: 6f5f 6576 656e 7427 293a 0a20 2020 2020  o_event'):.     
-00003b50: 2020 2020 2020 2023 206c 6561 6465 7273         # leaders
-00003b60: 2063 616e 2072 6561 640a 2020 2020 2020   can read.      
-00003b70: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-00003b80: 7373 2e73 6574 5f6c 6561 6465 7228 5472  ss.set_leader(Tr
-00003b90: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00003ba0: 7265 6c61 7469 6f6e 203d 2073 656c 662e  relation = self.
-00003bb0: 6861 726e 6573 732e 6d6f 6465 6c2e 6765  harness.model.ge
-00003bc0: 745f 7265 6c61 7469 6f6e 2827 6462 3227  t_relation('db2'
-00003bd0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00003be0: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-00003bf0: 656c 6174 696f 6e2e 6461 7461 5b72 656c  elation.data[rel
-00003c00: 6174 696f 6e2e 6170 705d 5b27 666f 6f27  ation.app]['foo'
-00003c10: 5d2c 2027 6261 7227 290a 0a20 2020 2064  ], 'bar')..    d
-00003c20: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
-00003c30: 5f64 6174 615f 6163 6365 7373 5f70 6565  _data_access_pee
-00003c40: 725f 6d69 6e69 6f6e 2873 656c 6629 3a0a  r_minion(self):.
-00003c50: 2020 2020 2020 2020 725f 6964 203d 2073          r_id = s
-00003c60: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00003c70: 7265 6c61 7469 6f6e 2827 6462 3227 2c20  relation('db2', 
-00003c80: 276d 7961 7070 2729 0a20 2020 2020 2020  'myapp').       
-00003c90: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00003ca0: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-00003cb0: 725f 6964 2c20 276d 7961 7070 2f31 2729  r_id, 'myapp/1')
-00003cc0: 2020 2320 7065 6572 210a 2020 2020 2020    # peer!.      
-00003cd0: 2020 7365 6c66 2e68 6172 6e65 7373 2e75    self.harness.u
-00003ce0: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00003cf0: 6174 6128 725f 6964 2c20 276d 7961 7070  ata(r_id, 'myapp
-00003d00: 272c 207b 2766 6f6f 273a 2027 6261 7227  ', {'foo': 'bar'
-00003d10: 7d29 0a20 2020 2020 2020 2077 6974 6820  }).        with 
-00003d20: 7365 6c66 2e68 6172 6e65 7373 2e5f 6576  self.harness._ev
-00003d30: 656e 745f 636f 6e74 6578 7428 2766 6f6f  ent_context('foo
-00003d40: 5f65 7665 6e74 2729 3a0a 2020 2020 2020  _event'):.      
-00003d50: 2020 2020 2020 2320 6e6f 6e6c 6561 6465        # nonleade
-00003d60: 7273 2063 616e 2072 6561 640a 2020 2020  rs can read.    
-00003d70: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-00003d80: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
-00003d90: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-00003da0: 2020 2072 656c 6174 696f 6e20 3d20 7365     relation = se
-00003db0: 6c66 2e68 6172 6e65 7373 2e6d 6f64 656c  lf.harness.model
-00003dc0: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-00003dd0: 6232 2729 0a20 2020 2020 2020 2020 2020  b2').           
-00003de0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00003df0: 6c28 7265 6c61 7469 6f6e 2e64 6174 615b  l(relation.data[
-00003e00: 7265 6c61 7469 6f6e 2e61 7070 5d5b 2766  relation.app]['f
-00003e10: 6f6f 275d 2c20 2762 6172 2729 0a0a 2020  oo'], 'bar')..  
-00003e20: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-00003e30: 696f 6e5f 6461 7461 5f64 656c 5f6b 6579  ion_data_del_key
-00003e40: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00003e50: 7265 6c61 7469 6f6e 5f69 6420 3d20 7365  relation_id = se
-00003e60: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-00003e70: 656c 6174 696f 6e28 2764 6231 272c 2027  elation('db1', '
-00003e80: 7265 6d6f 7465 6170 7031 2729 0a20 2020  remoteapp1').   
-00003e90: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
-00003ea0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
-00003eb0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
-00003ec0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00003ed0: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
-00003ee0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00003ef0: 6128 7265 6c61 7469 6f6e 5f69 642c 2027  a(relation_id, '
-00003f00: 6d79 6170 702f 3027 2c20 7b27 686f 7374  myapp/0', {'host
-00003f10: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
-00003f20: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00003f30: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-00003f40: 7428 7265 6c61 7469 6f6e 5f69 642c 2027  t(relation_id, '
-00003f50: 7265 6d6f 7465 6170 7031 2f30 2729 0a20  remoteapp1/0'). 
-00003f60: 2020 2020 2020 2073 656c 662e 7265 7365         self.rese
-00003f70: 7442 6163 6b65 6e64 4361 6c6c 7328 290a  tBackendCalls().
-00003f80: 0a20 2020 2020 2020 2072 656c 5f64 6231  .        rel_db1
-00003f90: 203d 2073 656c 662e 6d6f 6465 6c2e 6765   = self.model.ge
-00003fa0: 745f 7265 6c61 7469 6f6e 2827 6462 3127  t_relation('db1'
-00003fb0: 290a 2020 2020 2020 2020 2320 466f 7263  ).        # Forc
-00003fc0: 6520 6d65 6d6f 7279 2063 6163 6865 2074  e memory cache t
-00003fd0: 6f20 6265 206c 6f61 6465 642e 0a20 2020  o be loaded..   
-00003fe0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003ff0: 496e 2827 686f 7374 272c 2072 656c 5f64  In('host', rel_d
-00004000: 6231 2e64 6174 615b 7365 6c66 2e6d 6f64  b1.data[self.mod
-00004010: 656c 2e75 6e69 745d 290a 2020 2020 2020  el.unit]).      
-00004020: 2020 6465 6c20 7265 6c5f 6462 312e 6461    del rel_db1.da
-00004030: 7461 5b73 656c 662e 6d6f 6465 6c2e 756e  ta[self.model.un
-00004040: 6974 5d5b 2768 6f73 7427 5d0a 2020 2020  it]['host'].    
-00004050: 2020 2020 7365 6c66 2e61 7373 6572 744e      self.assertN
-00004060: 6f74 496e 2827 686f 7374 272c 2072 656c  otIn('host', rel
-00004070: 5f64 6231 2e64 6174 615b 7365 6c66 2e6d  _db1.data[self.m
-00004080: 6f64 656c 2e75 6e69 745d 290a 2020 2020  odel.unit]).    
-00004090: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000040a0: 7175 616c 287b 7d2c 2073 656c 662e 6861  qual({}, self.ha
-000040b0: 726e 6573 732e 6765 745f 7265 6c61 7469  rness.get_relati
-000040c0: 6f6e 5f64 6174 6128 7265 6c61 7469 6f6e  on_data(relation
-000040d0: 5f69 642c 2027 6d79 6170 702f 3027 2929  _id, 'myapp/0'))
-000040e0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-000040f0: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
-00004100: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
-00004110: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
-00004120: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
-00004130: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-00004140: 6c69 7374 272c 2072 656c 6174 696f 6e5f  list', relation_
-00004150: 6964 292c 0a20 2020 2020 2020 2020 2020  id),.           
-00004160: 2028 2772 656c 6174 696f 6e5f 6765 7427   ('relation_get'
-00004170: 2c20 7265 6c61 7469 6f6e 5f69 642c 2027  , relation_id, '
-00004180: 6d79 6170 702f 3027 2c20 4661 6c73 6529  myapp/0', False)
-00004190: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-000041a0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
-000041b0: 6461 7461 272c 2072 656c 6174 696f 6e5f  data', relation_
-000041c0: 6964 2c20 7365 6c66 2e6d 6f64 656c 2e75  id, self.model.u
-000041d0: 6e69 742c 2027 686f 7374 272c 2027 2729  nit, 'host', '')
-000041e0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-000041f0: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-00004200: 696f 6e5f 6461 7461 5f64 656c 5f6d 6973  ion_data_del_mis
-00004210: 7369 6e67 5f6b 6579 2873 656c 6629 3a0a  sing_key(self):.
-00004220: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
-00004230: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
-00004240: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
-00004250: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
-00004260: 7031 2729 0a20 2020 2020 2020 2077 6974  p1').        wit
-00004270: 6820 7365 6c66 2e68 6172 6e65 7373 2e5f  h self.harness._
-00004280: 6576 656e 745f 636f 6e74 6578 7428 2766  event_context('f
-00004290: 6f6f 5f65 7665 6e74 2729 3a0a 2020 2020  oo_event'):.    
-000042a0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-000042b0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-000042c0: 7469 6f6e 5f64 6174 6128 7265 6c61 7469  tion_data(relati
-000042d0: 6f6e 5f69 642c 2027 6d79 6170 702f 3027  on_id, 'myapp/0'
-000042e0: 2c20 7b27 686f 7374 273a 2027 6261 7227  , {'host': 'bar'
-000042f0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-00004300: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00004310: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
-00004320: 6f6e 5f69 642c 2027 7265 6d6f 7465 6170  on_id, 'remoteap
-00004330: 7031 2f30 2729 0a20 2020 2020 2020 2073  p1/0').        s
-00004340: 656c 662e 7265 7365 7442 6163 6b65 6e64  elf.resetBackend
-00004350: 4361 6c6c 7328 290a 0a20 2020 2020 2020  Calls()..       
-00004360: 2072 656c 5f64 6231 203d 2073 656c 662e   rel_db1 = self.
-00004370: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
-00004380: 6f6e 2827 6462 3127 290a 2020 2020 2020  on('db1').      
-00004390: 2020 2320 466f 7263 6520 6d65 6d6f 7279    # Force memory
-000043a0: 2063 6163 6865 2074 6f20 6265 206c 6f61   cache to be loa
-000043b0: 6465 642e 0a20 2020 2020 2020 2073 656c  ded..        sel
-000043c0: 662e 6173 7365 7274 496e 2827 686f 7374  f.assertIn('host
-000043d0: 272c 2072 656c 5f64 6231 2e64 6174 615b  ', rel_db1.data[
-000043e0: 7365 6c66 2e6d 6f64 656c 2e75 6e69 745d  self.model.unit]
-000043f0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00004400: 656c 662e 6861 726e 6573 732e 5f65 7665  elf.harness._eve
-00004410: 6e74 5f63 6f6e 7465 7874 2827 666f 6f5f  nt_context('foo_
-00004420: 6576 656e 7427 293a 0a20 2020 2020 2020  event'):.       
-00004430: 2020 2020 2072 656c 5f64 6231 2e64 6174       rel_db1.dat
-00004440: 615b 7365 6c66 2e6d 6f64 656c 2e75 6e69  a[self.model.uni
-00004450: 745d 5b27 706f 7274 275d 203d 2027 2720  t]['port'] = '' 
-00004460: 2020 2320 5361 6d65 2061 7320 6120 6465    # Same as a de
-00004470: 6c65 7465 2c20 7368 6f75 6c64 206e 6f74  lete, should not
-00004480: 2066 6169 6c2e 0a20 2020 2020 2020 2073   fail..        s
-00004490: 656c 662e 6173 7365 7274 4e6f 7449 6e28  elf.assertNotIn(
-000044a0: 2770 6f72 7427 2c20 7265 6c5f 6462 312e  'port', rel_db1.
-000044b0: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
-000044c0: 756e 6974 5d29 0a20 2020 2020 2020 2077  unit]).        w
-000044d0: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
-000044e0: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
-000044f0: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
-00004500: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00004510: 7373 6572 7445 7175 616c 287b 2768 6f73  ssertEqual({'hos
-00004520: 7427 3a20 2762 6172 277d 2c0a 2020 2020  t': 'bar'},.    
-00004530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004540: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00004550: 726e 6573 732e 6765 745f 7265 6c61 7469  rness.get_relati
-00004560: 6f6e 5f64 6174 6128 7265 6c61 7469 6f6e  on_data(relation
-00004570: 5f69 642c 2027 6d79 6170 702f 3027 2929  _id, 'myapp/0'))
-00004580: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00004590: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
-000045a0: 7328 5b0a 2020 2020 2020 2020 2020 2020  s([.            
-000045b0: 2827 7265 6c61 7469 6f6e 5f69 6473 272c  ('relation_ids',
-000045c0: 2027 6462 3127 292c 0a20 2020 2020 2020   'db1'),.       
-000045d0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
-000045e0: 6c69 7374 272c 2072 656c 6174 696f 6e5f  list', relation_
-000045f0: 6964 292c 0a20 2020 2020 2020 2020 2020  id),.           
-00004600: 2028 2772 656c 6174 696f 6e5f 6765 7427   ('relation_get'
-00004610: 2c20 7265 6c61 7469 6f6e 5f69 642c 2027  , relation_id, '
-00004620: 6d79 6170 702f 3027 2c20 4661 6c73 6529  myapp/0', False)
-00004630: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-00004640: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
-00004650: 6461 7461 272c 2072 656c 6174 696f 6e5f  data', relation_
-00004660: 6964 2c20 7365 6c66 2e6d 6f64 656c 2e75  id, self.model.u
-00004670: 6e69 742c 2027 706f 7274 272c 2027 2729  nit, 'port', '')
-00004680: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-00004690: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-000046a0: 696f 6e5f 7365 745f 6661 696c 2873 656c  ion_set_fail(sel
-000046b0: 6629 3a0a 2020 2020 2020 2020 7265 6c61  f):.        rela
-000046c0: 7469 6f6e 5f69 6420 3d20 7365 6c66 2e68  tion_id = self.h
-000046d0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-000046e0: 696f 6e28 2764 6231 272c 2027 7265 6d6f  ion('db1', 'remo
-000046f0: 7465 6170 7031 2729 0a20 2020 2020 2020  teapp1').       
-00004700: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
-00004710: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
-00004720: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
-00004730: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00004740: 2e68 6172 6e65 7373 2e75 7064 6174 655f  .harness.update_
-00004750: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-00004760: 6c61 7469 6f6e 5f69 642c 2027 6d79 6170  lation_id, 'myap
-00004770: 702f 3027 2c20 7b27 686f 7374 273a 2027  p/0', {'host': '
-00004780: 6d79 6170 702d 3027 7d29 0a20 2020 2020  myapp-0'}).     
-00004790: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-000047a0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
-000047b0: 7428 7265 6c61 7469 6f6e 5f69 642c 2027  t(relation_id, '
-000047c0: 7265 6d6f 7465 6170 7031 2f30 2729 0a20  remoteapp1/0'). 
-000047d0: 2020 2020 2020 2073 656c 662e 7265 7365         self.rese
-000047e0: 7442 6163 6b65 6e64 4361 6c6c 7328 290a  tBackendCalls().
-000047f0: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
-00004800: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
-00004810: 5f62 6163 6b65 6e64 0a20 2020 2020 2020  _backend.       
-00004820: 2023 2054 4f44 4f3a 206a 616d 2032 3032   # TODO: jam 202
-00004830: 302d 3033 2d30 3620 5468 6973 2069 7320  0-03-06 This is 
-00004840: 7761 7920 746f 6f20 6d75 6368 2069 6e66  way too much inf
-00004850: 6f72 6d61 7469 6f6e 2061 626f 7574 2072  ormation about r
-00004860: 656c 6174 696f 6e5f 7365 740a 2020 2020  elation_set.    
-00004870: 2020 2020 2320 2020 2020 2020 5468 6520      #       The 
-00004880: 6f72 6967 696e 616c 2074 6573 7420 666f  original test fo
-00004890: 7263 6564 2027 7265 6c61 7469 6f6e 2d73  rced 'relation-s
-000048a0: 6574 2720 746f 2072 6574 7572 6e20 6578  et' to return ex
-000048b0: 6974 2063 6f64 6520 322c 0a20 2020 2020  it code 2,.     
-000048c0: 2020 2023 2020 2020 2020 2062 7574 2074     #       but t
-000048d0: 6865 7265 2077 6173 206e 6f74 6869 6e67  here was nothing
-000048e0: 2069 6c6c 6567 616c 2061 626f 7574 2074   illegal about t
-000048f0: 6865 2064 6174 6120 7468 6174 2077 6173  he data that was
-00004900: 2062 6569 6e67 2073 6574 2c0a 2020 2020   being set,.    
-00004910: 2020 2020 2320 2020 2020 2020 666f 7220      #       for 
-00004920: 7573 2074 6f20 7072 6f70 6572 6c79 2074  us to properly t
-00004930: 6573 7420 7468 6520 7369 6465 2065 6666  est the side eff
-00004940: 6563 7473 206f 6620 7265 6c61 7469 6f6e  ects of relation
-00004950: 2d73 6574 2066 6169 6c69 6e67 2e0a 0a20  -set failing... 
-00004960: 2020 2020 2020 2064 6566 2062 726f 6b65         def broke
-00004970: 6e5f 7570 6461 7465 5f72 656c 6174 696f  n_update_relatio
-00004980: 6e5f 6461 7461 2872 656c 6174 696f 6e5f  n_data(relation_
-00004990: 6964 2c20 656e 7469 7479 2c20 6b65 792c  id, entity, key,
-000049a0: 2076 616c 7565 293a 0a20 2020 2020 2020   value):.       
-000049b0: 2020 2020 2062 6163 6b65 6e64 2e5f 6361       backend._ca
-000049c0: 6c6c 732e 6170 7065 6e64 2828 2775 7064  lls.append(('upd
-000049d0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-000049e0: 6127 2c20 7265 6c61 7469 6f6e 5f69 642c  a', relation_id,
-000049f0: 2065 6e74 6974 792c 206b 6579 2c20 7661   entity, key, va
-00004a00: 6c75 6529 290a 2020 2020 2020 2020 2020  lue)).          
-00004a10: 2020 7261 6973 6520 6f70 732e 6d6f 6465    raise ops.mode
-00004a20: 6c2e 4d6f 6465 6c45 7272 6f72 2829 0a20  l.ModelError(). 
-00004a30: 2020 2020 2020 2062 6163 6b65 6e64 2e75         backend.u
-00004a40: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00004a50: 6174 6120 3d20 6272 6f6b 656e 5f75 7064  ata = broken_upd
-00004a60: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00004a70: 610a 0a20 2020 2020 2020 2072 656c 5f64  a..        rel_d
-00004a80: 6231 203d 2073 656c 662e 6d6f 6465 6c2e  b1 = self.model.
-00004a90: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
-00004aa0: 3127 290a 2020 2020 2020 2020 2320 466f  1').        # Fo
-00004ab0: 7263 6520 6d65 6d6f 7279 2063 6163 6865  rce memory cache
-00004ac0: 2074 6f20 6265 206c 6f61 6465 642e 0a20   to be loaded.. 
-00004ad0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00004ae0: 7274 496e 2827 686f 7374 272c 2072 656c  rtIn('host', rel
-00004af0: 5f64 6231 2e64 6174 615b 7365 6c66 2e6d  _db1.data[self.m
-00004b00: 6f64 656c 2e75 6e69 745d 290a 0a20 2020  odel.unit])..   
-00004b10: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
-00004b20: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
-00004b30: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
-00004b40: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00004b50: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00004b60: 5261 6973 6573 286f 7073 2e6d 6f64 656c  Raises(ops.model
-00004b70: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-00004b80: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00004b90: 6c5f 6462 312e 6461 7461 5b73 656c 662e  l_db1.data[self.
-00004ba0: 6d6f 6465 6c2e 756e 6974 5d5b 2768 6f73  model.unit]['hos
-00004bb0: 7427 5d20 3d20 2762 6172 270a 2020 2020  t'] = 'bar'.    
-00004bc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00004bd0: 6572 7445 7175 616c 2872 656c 5f64 6231  ertEqual(rel_db1
-00004be0: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
-00004bf0: 2e75 6e69 745d 5b27 686f 7374 275d 2c20  .unit]['host'], 
-00004c00: 276d 7961 7070 2d30 2729 0a20 2020 2020  'myapp-0').     
-00004c10: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00004c20: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-00004c30: 732e 6d6f 6465 6c2e 4d6f 6465 6c45 7272  s.model.ModelErr
-00004c40: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00004c50: 2020 2020 2064 656c 2072 656c 5f64 6231       del rel_db1
-00004c60: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
-00004c70: 2e75 6e69 745d 5b27 686f 7374 275d 0a20  .unit]['host']. 
-00004c80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00004c90: 6173 7365 7274 496e 2827 686f 7374 272c  assertIn('host',
-00004ca0: 2072 656c 5f64 6231 2e64 6174 615b 7365   rel_db1.data[se
-00004cb0: 6c66 2e6d 6f64 656c 2e75 6e69 745d 290a  lf.model.unit]).
-00004cc0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00004cd0: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
-00004ce0: 285b 0a20 2020 2020 2020 2020 2020 2028  ([.            (
-00004cf0: 2772 656c 6174 696f 6e5f 6964 7327 2c20  'relation_ids', 
-00004d00: 2764 6231 2729 2c0a 2020 2020 2020 2020  'db1'),.        
-00004d10: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
-00004d20: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
-00004d30: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-00004d40: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
-00004d50: 2072 656c 6174 696f 6e5f 6964 2c20 276d   relation_id, 'm
-00004d60: 7961 7070 2f30 272c 2046 616c 7365 292c  yapp/0', False),
-00004d70: 0a20 2020 2020 2020 2020 2020 2028 2775  .            ('u
-00004d80: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-00004d90: 6174 6127 2c20 7265 6c61 7469 6f6e 5f69  ata', relation_i
-00004da0: 642c 2073 656c 662e 6d6f 6465 6c2e 756e  d, self.model.un
-00004db0: 6974 2c20 2768 6f73 7427 2c20 2762 6172  it, 'host', 'bar
-00004dc0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00004dd0: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
-00004de0: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
-00004df0: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
-00004e00: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
-00004e10: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
-00004e20: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
-00004e30: 6174 696f 6e5f 6461 7461 5f74 7970 655f  ation_data_type_
-00004e40: 6368 6563 6b28 7365 6c66 293a 0a20 2020  check(self):.   
-00004e50: 2020 2020 2072 656c 6174 696f 6e5f 6964       relation_id
-00004e60: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
-00004e70: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00004e80: 3127 2c20 2772 656d 6f74 6561 7070 3127  1', 'remoteapp1'
-00004e90: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-00004ea0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-00004eb0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
-00004ec0: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
-00004ed0: 3027 2c20 7b27 686f 7374 273a 2027 6d79  0', {'host': 'my
-00004ee0: 6170 702d 3027 7d29 0a20 2020 2020 2020  app-0'}).       
-00004ef0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-00004f00: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-00004f10: 7265 6c61 7469 6f6e 5f69 642c 2027 7265  relation_id, 're
-00004f20: 6d6f 7465 6170 7031 2f30 2729 0a20 2020  moteapp1/0').   
-00004f30: 2020 2020 2073 656c 662e 7265 7365 7442       self.resetB
-00004f40: 6163 6b65 6e64 4361 6c6c 7328 290a 0a20  ackendCalls().. 
-00004f50: 2020 2020 2020 2072 656c 5f64 6231 203d         rel_db1 =
-00004f60: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-00004f70: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
-00004f80: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
-00004f90: 2076 616c 7565 2069 6e20 280a 2020 2020   value in (.    
-00004fa0: 2020 2020 2020 2020 2020 2020 2827 666f              ('fo
-00004fb0: 6f27 2c20 3129 2c0a 2020 2020 2020 2020  o', 1),.        
-00004fc0: 2020 2020 2020 2020 2827 666f 6f27 2c20          ('foo', 
-00004fd0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
-00004fe0: 2020 2020 2020 2028 2766 6f6f 272c 207b         ('foo', {
-00004ff0: 2766 6f6f 273a 2027 6261 7227 7d29 2c0a  'foo': 'bar'}),.
-00005000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005010: 2831 2c20 2766 6f6f 2729 2c0a 2020 2020  (1, 'foo'),.    
-00005020: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
-00005030: 652c 2027 666f 6f27 292c 0a20 2020 2020  e, 'foo'),.     
-00005040: 2020 2020 2020 2020 2020 2028 2827 666f             (('fo
-00005050: 6f27 2c20 2762 6172 2729 2c20 2766 6f6f  o', 'bar'), 'foo
-00005060: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00005070: 2020 2020 2831 2c20 3129 2c0a 2020 2020      (1, 1),.    
-00005080: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
-00005090: 652c 204e 6f6e 6529 0a20 2020 2020 2020  e, None).       
-000050a0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-000050b0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-000050c0: 5261 6973 6573 286f 7073 2e6d 6f64 656c  Raises(ops.model
-000050d0: 2e52 656c 6174 696f 6e44 6174 6145 7272  .RelationDataErr
-000050e0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-000050f0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
-00005100: 6172 6e65 7373 2e66 7261 6d65 776f 726b  arness.framework
-00005110: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
-00005120: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
-00005130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005140: 2020 7265 6c5f 6462 312e 6461 7461 5b73    rel_db1.data[s
-00005150: 656c 662e 6d6f 6465 6c2e 756e 6974 5d5b  elf.model.unit][
-00005160: 6b65 795d 203d 2076 616c 7565 0a0a 2020  key] = value..  
-00005170: 2020 2020 2020 2320 4e6f 2064 6174 6120        # No data 
-00005180: 6861 7320 6163 7475 616c 6c79 2062 6565  has actually bee
-00005190: 6e20 6368 616e 6765 640a 2020 2020 2020  n changed.      
-000051a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000051b0: 616c 2864 6963 7428 7265 6c5f 6462 312e  al(dict(rel_db1.
-000051c0: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
-000051d0: 756e 6974 5d29 2c20 7b27 686f 7374 273a  unit]), {'host':
-000051e0: 2027 6d79 6170 702d 3027 7d29 0a0a 2020   'myapp-0'})..  
-000051f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00005200: 7442 6163 6b65 6e64 4361 6c6c 7328 5b0a  tBackendCalls([.
-00005210: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
-00005220: 6c61 7469 6f6e 5f69 6473 272c 2027 6462  lation_ids', 'db
-00005230: 3127 292c 0a20 2020 2020 2020 2020 2020  1'),.           
-00005240: 2028 2772 656c 6174 696f 6e5f 6c69 7374   ('relation_list
-00005250: 272c 2072 656c 6174 696f 6e5f 6964 292c  ', relation_id),
-00005260: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
-00005270: 656c 6174 696f 6e5f 6765 7427 2c20 7265  elation_get', re
-00005280: 6c61 7469 6f6e 5f69 642c 2027 6d79 6170  lation_id, 'myap
-00005290: 702f 3027 2c20 4661 6c73 6529 2c0a 2020  p/0', False),.  
-000052a0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
-000052b0: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
-000052c0: 6c6f 6361 6c5f 6170 705f 6461 7461 5f72  local_app_data_r
-000052d0: 6561 6461 6269 6c69 7479 5f6c 6561 6465  eadability_leade
-000052e0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-000052f0: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
-00005300: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00005310: 7265 6c61 7469 6f6e 2827 6462 3127 2c20  relation('db1', 
-00005320: 2772 656d 6f74 6561 7070 3127 290a 2020  'remoteapp1').  
-00005330: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-00005340: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
-00005350: 6f6e 5f64 6174 6128 7265 6c61 7469 6f6e  on_data(relation
-00005360: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
-00005370: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00005380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005390: 2020 2020 2020 2020 2020 2020 207b 2773               {'s
-000053a0: 6563 7265 7427 3a20 2763 6166 6564 6561  ecret': 'cafedea
-000053b0: 6462 6565 6627 7d29 0a20 2020 2020 2020  dbeef'}).       
-000053c0: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
-000053d0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-000053e0: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
-000053f0: 276d 7961 7070 272c 0a20 2020 2020 2020  'myapp',.       
-00005400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005420: 2020 207b 276c 6f63 616c 273a 2027 6461     {'local': 'da
-00005430: 7461 277d 290a 0a20 2020 2020 2020 2073  ta'})..        s
-00005440: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00005450: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-00005460: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
-00005470: 7465 6170 7031 2f30 2729 0a20 2020 2020  teapp1/0').     
-00005480: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00005490: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
-000054a0: 6461 7461 2872 656c 6174 696f 6e5f 6964  data(relation_id
-000054b0: 2c20 2772 656d 6f74 6561 7070 312f 3027  , 'remoteapp1/0'
-000054c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000054d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054e0: 2020 2020 2020 2020 2020 2020 7b27 686f              {'ho
-000054f0: 7374 273a 2027 7265 6d6f 7465 6170 7031  st': 'remoteapp1
-00005500: 2f30 277d 290a 2020 2020 2020 2020 7365  /0'}).        se
-00005510: 6c66 2e6d 6f64 656c 2e72 656c 6174 696f  lf.model.relatio
-00005520: 6e73 2e5f 696e 7661 6c69 6461 7465 2827  ns._invalidate('
-00005530: 6462 3127 290a 2020 2020 2020 2020 7365  db1').        se
-00005540: 6c66 2e72 6573 6574 4261 636b 656e 6443  lf.resetBackendC
-00005550: 616c 6c73 2829 0a0a 2020 2020 2020 2020  alls()..        
-00005560: 7265 6c5f 6462 3120 3d20 7365 6c66 2e6d  rel_db1 = self.m
-00005570: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
-00005580: 6e28 2764 6231 2729 0a20 2020 2020 2020  n('db1').       
-00005590: 2073 656c 662e 6861 726e 6573 732e 6265   self.harness.be
-000055a0: 6769 6e28 290a 2020 2020 2020 2020 7365  gin().        se
-000055b0: 6c66 2e68 6172 6e65 7373 2e73 6574 5f6c  lf.harness.set_l
-000055c0: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
-000055d0: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
-000055e0: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
-000055f0: 2020 2020 2020 6c6f 6361 6c5f 6170 7020        local_app 
-00005600: 3d20 7365 6c66 2e68 6172 6e65 7373 2e63  = self.harness.c
-00005610: 6861 726d 2e61 7070 0a20 2020 2020 2020  harm.app.       
-00005620: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
-00005630: 6e64 4361 6c6c 7328 290a 0a20 2020 2020  ndCalls()..     
-00005640: 2020 2023 2061 6464 7265 7373 696e 6720     # addressing 
-00005650: 7468 6520 6f62 6a65 6374 2069 7320 4f4b  the object is OK
-00005660: 0a20 2020 2020 2020 2072 656c 5f64 6231  .        rel_db1
-00005670: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
-00005680: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00005690: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
-000056a0: 7328 5b5d 290a 0a20 2020 2020 2020 2077  s([])..        w
-000056b0: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
-000056c0: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
-000056d0: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
-000056e0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000056f0: 6573 6574 4261 636b 656e 6443 616c 6c73  esetBackendCalls
-00005700: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-00005710: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00005720: 2872 656c 5f64 6231 2e64 6174 615b 6c6f  (rel_db1.data[lo
-00005730: 6361 6c5f 6170 705d 5b27 6c6f 6361 6c27  cal_app]['local'
-00005740: 5d2c 2027 6461 7461 2729 0a0a 2020 2020  ], 'data')..    
-00005750: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00005760: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
-00005770: 5b28 2769 735f 6c65 6164 6572 272c 292c  [('is_leader',),
-00005780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000057a0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
-000057b0: 5f67 6574 272c 2031 2c20 276d 7961 7070  _get', 1, 'myapp
-000057c0: 272c 2054 7275 6529 5d29 0a0a 2020 2020  ', True)])..    
-000057d0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-000057e0: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
-000057f0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00005800: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-00005810: 6570 7228 7265 6c5f 6462 312e 6461 7461  epr(rel_db1.data
-00005820: 5b6c 6f63 616c 5f61 7070 5d29 2c20 7265  [local_app]), re
-00005830: 7072 287b 276c 6f63 616c 273a 2027 6461  pr({'local': 'da
-00005840: 7461 277d 2929 0a0a 2020 2020 2020 2020  ta'}))..        
-00005850: 2020 2020 2320 7765 2064 6f6e 2774 2067      # we don't g
-00005860: 6574 2074 6865 2064 6174 612c 2062 6563  et the data, bec
-00005870: 6175 7365 2077 6527 7265 206c 617a 790a  ause we're lazy.
-00005880: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005890: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
-000058a0: 6c6c 7328 5b28 2769 735f 6c65 6164 6572  lls([('is_leader
-000058b0: 272c 295d 290a 0a20 2020 2020 2020 2020  ',)])..         
-000058c0: 2020 2023 2061 7320 7765 6c6c 2061 7320     # as well as 
-000058d0: 7265 6c61 7469 6f6e 2064 6174 6120 7265  relation data re
-000058e0: 7072 2829 2069 6e20 6765 6e65 7261 6c3a  pr() in general:
-000058f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00005900: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-00005910: 6365 2872 6570 7228 7265 6c5f 6462 312e  ce(repr(rel_db1.
-00005920: 6461 7461 292c 2073 7472 290a 0a20 2020  data), str)..   
-00005930: 2064 6566 2074 6573 745f 7265 6c61 7469   def test_relati
-00005940: 6f6e 5f6c 6f63 616c 5f61 7070 5f64 6174  on_local_app_dat
-00005950: 615f 7265 6164 6162 696c 6974 795f 666f  a_readability_fo
-00005960: 6c6c 6f77 6572 2873 656c 6629 3a0a 2020  llower(self):.  
-00005970: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
-00005980: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
-00005990: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-000059a0: 6231 272c 2027 7265 6d6f 7465 6170 7031  b1', 'remoteapp1
-000059b0: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
-000059c0: 7365 6c66 2e68 6172 6e65 7373 2e5f 6576  self.harness._ev
-000059d0: 656e 745f 636f 6e74 6578 7428 2766 6f6f  ent_context('foo
-000059e0: 5f65 7665 6e74 2729 3a0a 2020 2020 2020  _event'):.      
-000059f0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-00005a00: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
-00005a10: 6f6e 5f64 6174 6128 7265 6c61 7469 6f6e  on_data(relation
-00005a20: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
-00005a30: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00005a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a60: 207b 2773 6563 7265 7427 3a20 2763 6166   {'secret': 'caf
-00005a70: 6564 6561 6462 6565 6627 7d29 0a20 2020  edeadbeef'}).   
-00005a80: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00005a90: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00005aa0: 6174 696f 6e5f 6461 7461 2872 656c 6174  ation_data(relat
-00005ab0: 696f 6e5f 6964 2c20 276d 7961 7070 272c  ion_id, 'myapp',
-00005ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ae0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00005af0: 276c 6f63 616c 273a 2027 6461 7461 277d  'local': 'data'}
-00005b00: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
-00005b10: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00005b20: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-00005b30: 6c61 7469 6f6e 5f69 642c 2027 7265 6d6f  lation_id, 'remo
-00005b40: 7465 6170 7031 2f30 2729 0a20 2020 2020  teapp1/0').     
-00005b50: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
-00005b60: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00005b70: 696f 6e5f 6461 7461 2872 656c 6174 696f  ion_data(relatio
-00005b80: 6e5f 6964 2c20 2772 656d 6f74 6561 7070  n_id, 'remoteapp
-00005b90: 312f 3027 2c0a 2020 2020 2020 2020 2020  1/0',.          
-00005ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005bc0: 2020 2020 7b27 686f 7374 273a 2027 7265      {'host': 're
-00005bd0: 6d6f 7465 6170 7031 2f30 277d 290a 2020  moteapp1/0'}).  
-00005be0: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-00005bf0: 2e72 656c 6174 696f 6e73 2e5f 696e 7661  .relations._inva
-00005c00: 6c69 6461 7465 2827 6462 3127 290a 2020  lidate('db1').  
-00005c10: 2020 2020 2020 7365 6c66 2e72 6573 6574        self.reset
-00005c20: 4261 636b 656e 6443 616c 6c73 2829 0a0a  BackendCalls()..
-00005c30: 2020 2020 2020 2020 7265 6c5f 6462 3120          rel_db1 
-00005c40: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-00005c50: 5f72 656c 6174 696f 6e28 2764 6231 2729  _relation('db1')
-00005c60: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-00005c70: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-00005c80: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-00005c90: 7373 2e73 6574 5f6c 6561 6465 7228 4661  ss.set_leader(Fa
-00005ca0: 6c73 6529 0a0a 2020 2020 2020 2020 6c6f  lse)..        lo
-00005cb0: 6361 6c5f 6170 7020 3d20 7365 6c66 2e68  cal_app = self.h
-00005cc0: 6172 6e65 7373 2e63 6861 726d 2e61 7070  arness.charm.app
-00005cd0: 0a20 2020 2020 2020 2023 2061 6464 7265  .        # addre
-00005ce0: 7373 696e 6720 7468 6520 6f62 6a65 6374  ssing the object
-00005cf0: 2069 7320 4f4b 0a20 2020 2020 2020 2072   is OK.        r
-00005d00: 656c 5f64 6231 2e64 6174 615b 6c6f 6361  el_db1.data[loca
-00005d10: 6c5f 6170 705d 0a20 2020 2020 2020 2023  l_app].        #
-00005d20: 206e 6f6e 6c65 6164 6572 2075 6e69 7473   nonleader units
-00005d30: 2063 616e 6e6f 7420 7265 6164 2074 6865   cannot read the
-00005d40: 6972 206c 6f63 616c 2061 7070 2064 6174  ir local app dat
-00005d50: 6162 6167 0a20 2020 2020 2020 2023 2061  abag.        # a
-00005d60: 7474 656d 7074 696e 6720 746f 2072 6561  ttempting to rea
-00005d70: 6420 6974 2069 7320 6e6f 740a 2020 2020  d it is not.    
-00005d80: 2020 2020 7769 7468 2073 656c 662e 6861      with self.ha
-00005d90: 726e 6573 732e 5f65 7665 6e74 5f63 6f6e  rness._event_con
-00005da0: 7465 7874 2827 666f 6f5f 6576 656e 7427  text('foo_event'
-00005db0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00005dc0: 656c 662e 7265 7365 7442 6163 6b65 6e64  elf.resetBackend
-00005dd0: 4361 6c6c 7328 290a 0a20 2020 2020 2020  Calls()..       
-00005de0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00005df0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00005e00: 6d6f 6465 6c2e 5265 6c61 7469 6f6e 4461  model.RelationDa
-00005e10: 7461 4572 726f 7229 3a0a 2020 2020 2020  taError):.      
-00005e20: 2020 2020 2020 2020 2020 2320 276c 6f63            # 'loc
-00005e30: 616c 2720 6973 2074 6865 7265 2c20 6275  al' is there, bu
-00005e40: 7420 7374 696c 6c3a 0a20 2020 2020 2020  t still:.       
-00005e50: 2020 2020 2020 2020 2072 656c 5f64 6231           rel_db1
-00005e60: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
-00005e70: 5b27 6c6f 6361 6c27 5d0a 0a20 2020 2020  ['local']..     
-00005e80: 2020 2020 2020 2023 2077 6520 6469 646e         # we didn
-00005e90: 2774 2065 7665 6e20 6765 7420 746f 2072  't even get to r
-00005ea0: 656c 6174 696f 6e2d 6765 740a 2020 2020  elation-get.    
-00005eb0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00005ec0: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
-00005ed0: 5b28 2769 735f 6c65 6164 6572 272c 2029  [('is_leader', )
-00005ee0: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-00005ef0: 2320 7765 2063 616e 2774 2073 6565 2069  # we can't see i
-00005f00: 7420 6275 7420 7265 7072 2829 2077 6f72  t but repr() wor
-00005f10: 6b73 0a20 2020 2020 2020 2020 2020 2073  ks.            s
-00005f20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00005f30: 7265 7072 2872 656c 5f64 6231 2e64 6174  repr(rel_db1.dat
-00005f40: 615b 6c6f 6361 6c5f 6170 705d 292c 2027  a[local_app]), '
-00005f50: 3c6e 2f61 3e27 290a 2020 2020 2020 2020  <n/a>').        
-00005f60: 2020 2020 7365 6c66 2e61 7373 6572 7442      self.assertB
-00005f70: 6163 6b65 6e64 4361 6c6c 7328 5b28 2769  ackendCalls([('i
-00005f80: 735f 6c65 6164 6572 272c 2029 5d29 0a0a  s_leader', )])..
-00005f90: 2020 2020 2020 2020 2020 2020 2320 6173              # as
-00005fa0: 2077 656c 6c20 6173 2072 656c 6174 696f   well as relatio
-00005fb0: 6e20 6461 7461 2072 6570 7228 2920 696e  n data repr() in
-00005fc0: 2067 656e 6572 616c 3a0a 2020 2020 2020   general:.      
-00005fd0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00005fe0: 7449 7349 6e73 7461 6e63 6528 7265 7072  tIsInstance(repr
-00005ff0: 2872 656c 5f64 6231 2e64 6174 6129 2c20  (rel_db1.data), 
-00006000: 7374 7229 0a0a 2020 2020 2020 2020 2020  str)..          
-00006010: 2020 6578 7065 6374 6564 5f62 6163 6b65    expected_backe
-00006020: 6e64 5f63 616c 6c73 203d 205b 0a20 2020  nd_calls = [.   
-00006030: 2020 2020 2020 2020 2020 2020 2028 2772               ('r
-00006040: 656c 6174 696f 6e5f 6765 7427 2c20 312c  elation_get', 1,
-00006050: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
-00006060: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00006070: 2020 2020 2827 6973 5f6c 6561 6465 7227      ('is_leader'
-00006080: 2c29 2c0a 2020 2020 2020 2020 2020 2020  ,),.            
-00006090: 2020 2020 2827 7265 6c61 7469 6f6e 5f67      ('relation_g
-000060a0: 6574 272c 2031 2c20 2772 656d 6f74 6561  et', 1, 'remotea
-000060b0: 7070 312f 3027 2c20 4661 6c73 6529 2c0a  pp1/0', False),.
-000060c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060d0: 2827 6973 5f6c 6561 6465 7227 2c29 2c0a  ('is_leader',),.
-000060e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060f0: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
-00006100: 2031 2c20 2772 656d 6f74 6561 7070 3127   1, 'remoteapp1'
-00006110: 2c20 5472 7565 295d 0a20 2020 2020 2020  , True)].       
-00006120: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00006130: 4261 636b 656e 6443 616c 6c73 2865 7870  BackendCalls(exp
-00006140: 6563 7465 645f 6261 636b 656e 645f 6361  ected_backend_ca
-00006150: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
-00006160: 7374 5f72 656c 6174 696f 6e5f 6e6f 5f75  st_relation_no_u
-00006170: 6e69 7473 2873 656c 6629 3a0a 2020 2020  nits(self):.    
-00006180: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-00006190: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-000061a0: 6231 272c 2027 7265 6d6f 7465 6170 7031  b1', 'remoteapp1
-000061b0: 2729 0a20 2020 2020 2020 2072 656c 203d  ').        rel =
-000061c0: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-000061d0: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
-000061e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000061f0: 6572 7445 7175 616c 2872 656c 2e75 6e69  ertEqual(rel.uni
-00006200: 7473 2c20 7365 7428 2929 0a20 2020 2020  ts, set()).     
-00006210: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-00006220: 2872 656c 2e61 7070 2c20 7365 6c66 2e6d  (rel.app, self.m
-00006230: 6f64 656c 2e67 6574 5f61 7070 2827 7265  odel.get_app('re
-00006240: 6d6f 7465 6170 7031 2729 290a 2020 2020  moteapp1')).    
-00006250: 2020 2020 7365 6c66 2e61 7373 6572 7442      self.assertB
-00006260: 6163 6b65 6e64 4361 6c6c 7328 5b0a 2020  ackendCalls([.  
-00006270: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
-00006280: 7469 6f6e 5f69 6473 272c 2027 6462 3127  tion_ids', 'db1'
-00006290: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-000062a0: 2772 656c 6174 696f 6e5f 6c69 7374 272c  'relation_list',
-000062b0: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
-000062c0: 2028 2772 656c 6174 696f 6e5f 7265 6d6f   ('relation_remo
-000062d0: 7465 5f61 7070 5f6e 616d 6527 2c20 3129  te_app_name', 1)
-000062e0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-000062f0: 2020 6465 6620 7465 7374 5f63 6f6e 6669    def test_confi
-00006300: 6728 7365 6c66 293a 0a20 2020 2020 2020  g(self):.       
-00006310: 2073 656c 662e 6861 726e 6573 732e 5f67   self.harness._g
-00006320: 6574 5f62 6163 6b65 6e64 5f63 616c 6c73  et_backend_calls
-00006330: 2872 6573 6574 3d54 7275 6529 0a20 2020  (reset=True).   
-00006340: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00006350: 732e 7570 6461 7465 5f63 6f6e 6669 6728  s.update_config(
-00006360: 7b27 666f 6f27 3a20 2766 6f6f 272c 2027  {'foo': 'foo', '
-00006370: 6261 7227 3a20 312c 2027 7175 7827 3a20  bar': 1, 'qux': 
-00006380: 5472 7565 7d29 0a20 2020 2020 2020 2073  True}).        s
-00006390: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000063a0: 7365 6c66 2e6d 6f64 656c 2e63 6f6e 6669  self.model.confi
-000063b0: 672c 207b 0a20 2020 2020 2020 2020 2020  g, {.           
-000063c0: 2027 666f 6f27 3a20 2766 6f6f 272c 0a20   'foo': 'foo',. 
-000063d0: 2020 2020 2020 2020 2020 2027 6261 7227             'bar'
-000063e0: 3a20 312c 0a20 2020 2020 2020 2020 2020  : 1,.           
-000063f0: 2027 7175 7827 3a20 5472 7565 2c0a 2020   'qux': True,.  
-00006400: 2020 2020 2020 7d29 0a20 2020 2020 2020        }).       
-00006410: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00006420: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
-00006430: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00006440: 2320 436f 6e66 6972 6d20 7468 6174 2077  # Confirm that w
-00006450: 6520 6361 6e6e 6f74 206d 6f64 6966 7920  e cannot modify 
-00006460: 636f 6e66 6967 2076 616c 7565 732e 0a20  config values.. 
-00006470: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006480: 6d6f 6465 6c2e 636f 6e66 6967 5b27 666f  model.config['fo
-00006490: 6f27 5d20 3d20 2762 6172 270a 0a20 2020  o'] = 'bar'..   
-000064a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000064b0: 4261 636b 656e 6443 616c 6c73 285b 2827  BackendCalls([('
-000064c0: 636f 6e66 6967 5f67 6574 272c 295d 290a  config_get',)]).
-000064d0: 0a20 2020 2064 6566 2074 6573 745f 636f  .    def test_co
-000064e0: 6e66 6967 5f69 6d6d 7574 6162 6c65 2873  nfig_immutable(s
-000064f0: 656c 6629 3a0a 2020 2020 2020 2020 7769  elf):.        wi
-00006500: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00006510: 6973 6573 2841 7474 7269 6275 7465 4572  ises(AttributeEr
-00006520: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00006530: 2020 7365 6c66 2e6d 6f64 656c 2e63 6f6e    self.model.con
-00006540: 6669 6720 3d20 7b7d 0a0a 2020 2020 6465  fig = {}..    de
-00006550: 6620 7465 7374 5f69 735f 6c65 6164 6572  f test_is_leader
-00006560: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00006570: 7265 6c61 7469 6f6e 5f69 6420 3d20 7365  relation_id = se
-00006580: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-00006590: 656c 6174 696f 6e28 2764 6231 272c 2027  elation('db1', '
-000065a0: 7265 6d6f 7465 6170 7031 2729 0a20 2020  remoteapp1').   
-000065b0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-000065c0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-000065d0: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
-000065e0: 2027 7265 6d6f 7465 6170 7031 2f30 2729   'remoteapp1/0')
-000065f0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-00006600: 726e 6573 732e 7365 745f 6c65 6164 6572  rness.set_leader
-00006610: 2854 7275 6529 0a20 2020 2020 2020 2073  (True).        s
-00006620: 656c 662e 7265 7365 7442 6163 6b65 6e64  elf.resetBackend
-00006630: 4361 6c6c 7328 290a 0a20 2020 2020 2020  Calls()..       
-00006640: 2064 6566 2063 6865 636b 5f72 656d 6f74   def check_remot
-00006650: 655f 756e 6974 7328 293a 0a20 2020 2020  e_units():.     
-00006660: 2020 2020 2020 2023 2043 616e 6e6f 7420         # Cannot 
-00006670: 6465 7465 726d 696e 6520 6c65 6164 6572  determine leader
-00006680: 7368 6970 2066 6f72 2072 656d 6f74 6520  ship for remote 
-00006690: 756e 6974 732e 0a20 2020 2020 2020 2020  units..         
-000066a0: 2020 2066 6f72 2075 2069 6e20 7365 6c66     for u in self
-000066b0: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
-000066c0: 696f 6e28 2764 6231 2729 2e75 6e69 7473  ion('db1').units
-000066d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000066e0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-000066f0: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
-00006700: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00006710: 2020 2020 2020 2020 2020 2020 752e 6973              u.is
-00006720: 5f6c 6561 6465 7228 290a 0a20 2020 2020  _leader()..     
-00006730: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00006740: 7565 2873 656c 662e 6d6f 6465 6c2e 756e  ue(self.model.un
-00006750: 6974 2e69 735f 6c65 6164 6572 2829 290a  it.is_leader()).
-00006760: 0a20 2020 2020 2020 2063 6865 636b 5f72  .        check_r
-00006770: 656d 6f74 655f 756e 6974 7328 290a 0a20  emote_units().. 
-00006780: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
-00006790: 6120 6e65 7720 6d6f 6465 6c20 616e 6420  a new model and 
-000067a0: 6261 636b 656e 6420 746f 2064 726f 7020  backend to drop 
-000067b0: 6120 6361 6368 6564 2069 732d 6c65 6164  a cached is-lead
-000067c0: 6572 206f 7574 7075 742e 0a20 2020 2020  er output..     
-000067d0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-000067e0: 7365 745f 6c65 6164 6572 2846 616c 7365  set_leader(False
-000067f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006800: 7373 6572 7446 616c 7365 2873 656c 662e  ssertFalse(self.
-00006810: 6d6f 6465 6c2e 756e 6974 2e69 735f 6c65  model.unit.is_le
-00006820: 6164 6572 2829 290a 0a20 2020 2020 2020  ader())..       
-00006830: 2063 6865 636b 5f72 656d 6f74 655f 756e   check_remote_un
-00006840: 6974 7328 290a 0a20 2020 2020 2020 2073  its()..        s
-00006850: 656c 662e 6173 7365 7274 4261 636b 656e  elf.assertBacken
-00006860: 6443 616c 6c73 285b 0a20 2020 2020 2020  dCalls([.       
-00006870: 2020 2020 2028 2769 735f 6c65 6164 6572       ('is_leader
-00006880: 272c 292c 0a20 2020 2020 2020 2020 2020  ',),.           
-00006890: 2028 2772 656c 6174 696f 6e5f 6964 7327   ('relation_ids'
-000068a0: 2c20 2764 6231 2729 2c0a 2020 2020 2020  , 'db1'),.      
-000068b0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
-000068c0: 5f6c 6973 7427 2c20 7265 6c61 7469 6f6e  _list', relation
-000068d0: 5f69 6429 2c0a 2020 2020 2020 2020 2020  _id),.          
-000068e0: 2020 2827 6973 5f6c 6561 6465 7227 2c29    ('is_leader',)
-000068f0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-00006900: 2020 6465 6620 7465 7374 5f77 6f72 6b6c    def test_workl
-00006910: 6f61 645f 7665 7273 696f 6e28 7365 6c66  oad_version(self
-00006920: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00006930: 6d6f 6465 6c2e 756e 6974 2e73 6574 5f77  model.unit.set_w
-00006940: 6f72 6b6c 6f61 645f 7665 7273 696f 6e28  orkload_version(
-00006950: 2731 2e32 2e33 2729 0a20 2020 2020 2020  '1.2.3').       
-00006960: 2073 656c 662e 6173 7365 7274 4261 636b   self.assertBack
-00006970: 656e 6443 616c 6c73 285b 0a20 2020 2020  endCalls([.     
-00006980: 2020 2020 2020 2028 2761 7070 6c69 6361         ('applica
-00006990: 7469 6f6e 5f76 6572 7369 6f6e 5f73 6574  tion_version_set
-000069a0: 272c 2027 312e 322e 3327 292c 0a20 2020  ', '1.2.3'),.   
-000069b0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-000069c0: 2074 6573 745f 776f 726b 6c6f 6164 5f76   test_workload_v
-000069d0: 6572 7369 6f6e 5f69 6e76 616c 6964 2873  ersion_invalid(s
-000069e0: 656c 6629 3a0a 2020 2020 2020 2020 7769  elf):.        wi
-000069f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00006a00: 6973 6573 2854 7970 6545 7272 6f72 2920  ises(TypeError) 
-00006a10: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00006a20: 2020 2073 656c 662e 6d6f 6465 6c2e 756e     self.model.un
-00006a30: 6974 2e73 6574 5f77 6f72 6b6c 6f61 645f  it.set_workload_
-00006a40: 7665 7273 696f 6e28 3529 0a20 2020 2020  version(5).     
-00006a50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00006a60: 7561 6c28 7374 7228 636d 2e65 7863 6570  ual(str(cm.excep
-00006a70: 7469 6f6e 292c 2022 776f 726b 6c6f 6164  tion), "workload
-00006a80: 2076 6572 7369 6f6e 206d 7573 7420 6265   version must be
-00006a90: 2061 2073 7472 2c20 6e6f 7420 696e 743a   a str, not int:
-00006aa0: 2035 2229 0a20 2020 2020 2020 2073 656c   5").        sel
-00006ab0: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
-00006ac0: 616c 6c73 285b 5d29 0a0a 2020 2020 6465  alls([])..    de
-00006ad0: 6620 7465 7374 5f72 6573 6f75 7263 6573  f test_resources
-00006ae0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00006af0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00006b00: 5261 6973 6573 286f 7073 2e6d 6f64 656c  Raises(ops.model
-00006b10: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-00006b20: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-00006b30: 6172 6e65 7373 2e6d 6f64 656c 2e72 6573  arness.model.res
-00006b40: 6f75 7263 6573 2e66 6574 6368 2827 666f  ources.fetch('fo
-00006b50: 6f27 290a 0a20 2020 2020 2020 2073 656c  o')..        sel
-00006b60: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
-00006b70: 736f 7572 6365 2827 666f 6f27 2c20 2766  source('foo', 'f
-00006b80: 6f6f 2063 6f6e 7465 6e74 735c 6e27 290a  oo contents\n').
-00006b90: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-00006ba0: 6e65 7373 2e61 6464 5f72 6573 6f75 7263  ness.add_resourc
-00006bb0: 6528 2762 6172 272c 2027 2729 0a0a 2020  e('bar', '')..  
-00006bc0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00006bd0: 6173 7365 7274 5261 6973 6573 284e 616d  assertRaises(Nam
-00006be0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00006bf0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-00006c00: 732e 6d6f 6465 6c2e 7265 736f 7572 6365  s.model.resource
-00006c10: 732e 6665 7463 6828 2771 7578 2729 0a0a  s.fetch('qux')..
-00006c20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00006c30: 6572 7445 7175 616c 2873 656c 662e 6861  ertEqual(self.ha
-00006c40: 726e 6573 732e 6d6f 6465 6c2e 7265 736f  rness.model.reso
-00006c50: 7572 6365 732e 6665 7463 6828 2766 6f6f  urces.fetch('foo
-00006c60: 2729 2e6e 616d 652c 2027 666f 6f2e 7478  ').name, 'foo.tx
-00006c70: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
-00006c80: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00006c90: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
-00006ca0: 7265 736f 7572 6365 732e 6665 7463 6828  resources.fetch(
-00006cb0: 2762 6172 2729 2e6e 616d 652c 2027 6261  'bar').name, 'ba
-00006cc0: 722e 7478 7427 290a 0a20 2020 2064 6566  r.txt')..    def
-00006cd0: 2074 6573 745f 7265 736f 7572 6365 735f   test_resources_
-00006ce0: 696d 6d75 7461 626c 6528 7365 6c66 293a  immutable(self):
-00006cf0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00006d00: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00006d10: 4174 7472 6962 7574 6545 7272 6f72 293a  AttributeError):
-00006d20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00006d30: 662e 6d6f 6465 6c2e 7265 736f 7572 6365  f.model.resource
-00006d40: 7320 3d20 6f62 6a65 6374 2829 0a0a 2020  s = object()..  
-00006d50: 2020 6465 6620 7465 7374 5f70 6f64 5f73    def test_pod_s
-00006d60: 7065 6328 7365 6c66 293a 0a20 2020 2020  pec(self):.     
-00006d70: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
-00006d80: 7365 745f 6c65 6164 6572 2854 7275 6529  set_leader(True)
-00006d90: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-00006da0: 726e 6573 732e 6d6f 6465 6c2e 706f 642e  rness.model.pod.
-00006db0: 7365 745f 7370 6563 287b 2766 6f6f 273a  set_spec({'foo':
-00006dc0: 2027 6261 7227 7d29 0a20 2020 2020 2020   'bar'}).       
-00006dd0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00006de0: 6c28 7365 6c66 2e68 6172 6e65 7373 2e67  l(self.harness.g
-00006df0: 6574 5f70 6f64 5f73 7065 6328 292c 2028  et_pod_spec(), (
-00006e00: 7b27 666f 6f27 3a20 2762 6172 277d 2c20  {'foo': 'bar'}, 
-00006e10: 4e6f 6e65 2929 0a0a 2020 2020 2020 2020  None))..        
-00006e20: 7365 6c66 2e68 6172 6e65 7373 2e6d 6f64  self.harness.mod
-00006e30: 656c 2e70 6f64 2e73 6574 5f73 7065 6328  el.pod.set_spec(
-00006e40: 7b27 6261 7227 3a20 2766 6f6f 277d 2c20  {'bar': 'foo'}, 
-00006e50: 7b27 7175 7827 3a20 2762 617a 277d 290a  {'qux': 'baz'}).
-00006e60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00006e70: 6572 7445 7175 616c 2873 656c 662e 6861  ertEqual(self.ha
-00006e80: 726e 6573 732e 6765 745f 706f 645f 7370  rness.get_pod_sp
-00006e90: 6563 2829 2c20 287b 2762 6172 273a 2027  ec(), ({'bar': '
-00006ea0: 666f 6f27 7d2c 207b 2771 7578 273a 2027  foo'}, {'qux': '
-00006eb0: 6261 7a27 7d29 290a 0a20 2020 2020 2020  baz'}))..       
-00006ec0: 2023 206e 6f20 6c65 6164 6572 202d 3e20   # no leader -> 
-00006ed0: 6e6f 2073 6574 2070 6f64 2073 7065 630a  no set pod spec.
-00006ee0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-00006ef0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
-00006f00: 4661 6c73 6529 0a20 2020 2020 2020 2077  False).        w
-00006f10: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00006f20: 6169 7365 7328 6f70 732e 6d6f 6465 6c2e  aises(ops.model.
-00006f30: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
-00006f40: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00006f50: 726e 6573 732e 6d6f 6465 6c2e 706f 642e  rness.model.pod.
-00006f60: 7365 745f 7370 6563 287b 2766 6f6f 273a  set_spec({'foo':
-00006f70: 2027 6261 7227 7d29 0a0a 2020 2020 6465   'bar'})..    de
-00006f80: 6620 7465 7374 5f70 6f64 5f69 6d6d 7574  f test_pod_immut
-00006f90: 6162 6c65 2873 656c 6629 3a0a 2020 2020  able(self):.    
-00006fa0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00006fb0: 7365 7274 5261 6973 6573 2841 7474 7269  sertRaises(Attri
-00006fc0: 6275 7465 4572 726f 7229 3a0a 2020 2020  buteError):.    
-00006fd0: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-00006fe0: 656c 2e70 6f64 203d 206f 626a 6563 7428  el.pod = object(
-00006ff0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00007000: 6261 7365 5f73 7461 7475 735f 696e 7374  base_status_inst
-00007010: 616e 6365 5f72 6169 7365 7328 7365 6c66  ance_raises(self
-00007020: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
-00007030: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00007040: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
-00007050: 2020 2020 2020 2020 2020 6f70 732e 6d6f            ops.mo
-00007060: 6465 6c2e 5374 6174 7573 4261 7365 2827  del.StatusBase('
-00007070: 7465 7374 2729 0a0a 2020 2020 2020 2020  test')..        
-00007080: 636c 6173 7320 4e6f 4e61 6d65 5374 6174  class NoNameStat
-00007090: 7573 286f 7073 2e6d 6f64 656c 2e53 7461  us(ops.model.Sta
-000070a0: 7475 7342 6173 6529 3a0a 2020 2020 2020  tusBase):.      
-000070b0: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-000070c0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-000070d0: 7365 7274 5261 6973 6573 2841 7474 7269  sertRaises(Attri
-000070e0: 6275 7465 4572 726f 7229 3a0a 2020 2020  buteError):.    
-000070f0: 2020 2020 2020 2020 6f70 732e 6d6f 6465          ops.mode
-00007100: 6c2e 5374 6174 7573 4261 7365 2e72 6567  l.StatusBase.reg
-00007110: 6973 7465 725f 7374 6174 7573 284e 6f4e  ister_status(NoN
-00007120: 616d 6553 7461 7475 7329 0a0a 2020 2020  ameStatus)..    
-00007130: 6465 6620 7465 7374 5f73 7461 7475 735f  def test_status_
-00007140: 7265 7072 2873 656c 6629 3a0a 2020 2020  repr(self):.    
-00007150: 2020 2020 7465 7374 5f63 6173 6573 203d      test_cases =
-00007160: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-00007170: 4163 7469 7665 5374 6174 7573 2827 5365  ActiveStatus('Se
-00007180: 6173 6865 6c6c 2729 223a 206f 7073 2e6d  ashell')": ops.m
-00007190: 6f64 656c 2e41 6374 6976 6553 7461 7475  odel.ActiveStatu
-000071a0: 7328 2753 6561 7368 656c 6c27 292c 0a20  s('Seashell'),. 
-000071b0: 2020 2020 2020 2020 2020 2022 4d61 696e             "Main
-000071c0: 7465 6e61 6e63 6553 7461 7475 7328 2752  tenanceStatus('R
-000071d0: 6564 2729 223a 206f 7073 2e6d 6f64 656c  ed')": ops.model
-000071e0: 2e4d 6169 6e74 656e 616e 6365 5374 6174  .MaintenanceStat
-000071f0: 7573 2827 5265 6427 292c 0a20 2020 2020  us('Red'),.     
-00007200: 2020 2020 2020 2022 426c 6f63 6b65 6453         "BlockedS
-00007210: 7461 7475 7328 274d 6167 656e 7461 2729  tatus('Magenta')
-00007220: 223a 206f 7073 2e6d 6f64 656c 2e42 6c6f  ": ops.model.Blo
-00007230: 636b 6564 5374 6174 7573 2827 4d61 6765  ckedStatus('Mage
-00007240: 6e74 6127 292c 0a20 2020 2020 2020 2020  nta'),.         
-00007250: 2020 2022 5761 6974 696e 6753 7461 7475     "WaitingStatu
-00007260: 7328 2754 6869 7374 6c65 2729 223a 206f  s('Thistle')": o
-00007270: 7073 2e6d 6f64 656c 2e57 6169 7469 6e67  ps.model.Waiting
-00007280: 5374 6174 7573 2827 5468 6973 746c 6527  Status('Thistle'
-00007290: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-000072a0: 556e 6b6e 6f77 6e53 7461 7475 7328 2927  UnknownStatus()'
-000072b0: 3a20 6f70 732e 6d6f 6465 6c2e 556e 6b6e  : ops.model.Unkn
-000072c0: 6f77 6e53 7461 7475 7328 292c 0a20 2020  ownStatus(),.   
-000072d0: 2020 2020 207d 0a20 2020 2020 2020 2066       }.        f
-000072e0: 6f72 2065 7870 6563 7465 642c 2073 7461  or expected, sta
-000072f0: 7475 7320 696e 2074 6573 745f 6361 7365  tus in test_case
-00007300: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-00007310: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007320: 7274 4571 7561 6c28 7265 7072 2873 7461  rtEqual(repr(sta
-00007330: 7475 7329 2c20 6578 7065 6374 6564 290a  tus), expected).
-00007340: 0a20 2020 2064 6566 2074 6573 745f 7374  .    def test_st
-00007350: 6174 7573 5f65 7128 7365 6c66 293a 0a20  atus_eq(self):. 
-00007360: 2020 2020 2020 2073 7461 7475 735f 7479         status_ty
-00007370: 7065 7320 3d20 5b0a 2020 2020 2020 2020  pes = [.        
-00007380: 2020 2020 6f70 732e 6d6f 6465 6c2e 4163      ops.model.Ac
-00007390: 7469 7665 5374 6174 7573 2c0a 2020 2020  tiveStatus,.    
-000073a0: 2020 2020 2020 2020 6f70 732e 6d6f 6465          ops.mode
-000073b0: 6c2e 4d61 696e 7465 6e61 6e63 6553 7461  l.MaintenanceSta
-000073c0: 7475 732c 0a20 2020 2020 2020 2020 2020  tus,.           
-000073d0: 206f 7073 2e6d 6f64 656c 2e42 6c6f 636b   ops.model.Block
-000073e0: 6564 5374 6174 7573 2c0a 2020 2020 2020  edStatus,.      
-000073f0: 2020 2020 2020 6f70 732e 6d6f 6465 6c2e        ops.model.
-00007400: 5761 6974 696e 6753 7461 7475 732c 0a20  WaitingStatus,. 
-00007410: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
-00007420: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007430: 616c 286f 7073 2e6d 6f64 656c 2e55 6e6b  al(ops.model.Unk
-00007440: 6e6f 776e 5374 6174 7573 2829 2c20 6f70  nownStatus(), op
-00007450: 732e 6d6f 6465 6c2e 556e 6b6e 6f77 6e53  s.model.UnknownS
-00007460: 7461 7475 7328 2929 0a20 2020 2020 2020  tatus()).       
-00007470: 2066 6f72 2028 692c 2074 3129 2069 6e20   for (i, t1) in 
-00007480: 656e 756d 6572 6174 6528 7374 6174 7573  enumerate(status
-00007490: 5f74 7970 6573 293a 0a20 2020 2020 2020  _types):.       
-000074a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000074b0: 4e6f 7445 7175 616c 2874 3128 2727 292c  NotEqual(t1(''),
-000074c0: 206f 7073 2e6d 6f64 656c 2e55 6e6b 6e6f   ops.model.Unkno
-000074d0: 776e 5374 6174 7573 2829 290a 2020 2020  wnStatus()).    
-000074e0: 2020 2020 2020 2020 666f 7220 286a 2c20          for (j, 
-000074f0: 7432 2920 696e 2065 6e75 6d65 7261 7465  t2) in enumerate
-00007500: 2873 7461 7475 735f 7479 7065 7329 3a0a  (status_types):.
-00007510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007520: 7365 6c66 2e61 7373 6572 744e 6f74 4571  self.assertNotEq
-00007530: 7561 6c28 7431 2827 6f6e 6527 292c 2074  ual(t1('one'), t
-00007540: 3228 2774 776f 2729 290a 2020 2020 2020  2('two')).      
-00007550: 2020 2020 2020 2020 2020 6966 2069 203d            if i =
-00007560: 3d20 6a3a 0a20 2020 2020 2020 2020 2020  = j:.           
-00007570: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-00007580: 7365 7274 4571 7561 6c28 7431 2827 6f6e  sertEqual(t1('on
-00007590: 6527 292c 2074 3228 276f 6e65 2729 290a  e'), t2('one')).
-000075a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000075b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000075c0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-000075d0: 7373 6572 744e 6f74 4571 7561 6c28 7431  ssertNotEqual(t1
-000075e0: 2827 6f6e 6527 292c 2074 3228 276f 6e65  ('one'), t2('one
-000075f0: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
-00007600: 745f 6163 7469 7665 5f6d 6573 7361 6765  t_active_message
-00007610: 5f64 6566 6175 6c74 2873 656c 6629 3a0a  _default(self):.
-00007620: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007630: 6572 7445 7175 616c 286f 7073 2e6d 6f64  ertEqual(ops.mod
-00007640: 656c 2e41 6374 6976 6553 7461 7475 7328  el.ActiveStatus(
-00007650: 292e 6d65 7373 6167 652c 2027 2729 0a0a  ).message, '')..
-00007660: 2020 2020 6465 6620 7465 7374 5f6c 6f63      def test_loc
-00007670: 616c 5f73 6574 5f76 616c 6964 5f75 6e69  al_set_valid_uni
-00007680: 745f 7374 6174 7573 2873 656c 6629 3a0a  t_status(self):.
-00007690: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-000076a0: 6e65 7373 2e5f 6765 745f 6261 636b 656e  ness._get_backen
-000076b0: 645f 6361 6c6c 7328 7265 7365 743d 5472  d_calls(reset=Tr
-000076c0: 7565 290a 2020 2020 2020 2020 7465 7374  ue).        test
-000076d0: 5f63 6173 6573 203d 205b 280a 2020 2020  _cases = [(.    
-000076e0: 2020 2020 2020 2020 2761 6374 6976 6527          'active'
-000076f0: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
-00007700: 732e 6d6f 6465 6c2e 4163 7469 7665 5374  s.model.ActiveSt
-00007710: 6174 7573 2827 4772 6565 6e27 292c 0a20  atus('Green'),. 
-00007720: 2020 2020 2020 2020 2020 2028 2773 7461             ('sta
-00007730: 7475 735f 7365 7427 2c20 2761 6374 6976  tus_set', 'activ
-00007740: 6527 2c20 2747 7265 656e 272c 207b 2769  e', 'Green', {'i
-00007750: 735f 6170 7027 3a20 4661 6c73 657d 292c  s_app': False}),
-00007760: 0a20 2020 2020 2020 2029 2c20 280a 2020  .        ), (.  
-00007770: 2020 2020 2020 2020 2020 276d 6169 6e74            'maint
-00007780: 656e 616e 6365 272c 0a20 2020 2020 2020  enance',.       
-00007790: 2020 2020 206f 7073 2e6d 6f64 656c 2e4d       ops.model.M
-000077a0: 6169 6e74 656e 616e 6365 5374 6174 7573  aintenanceStatus
-000077b0: 2827 5965 6c6c 6f77 2729 2c0a 2020 2020  ('Yellow'),.    
-000077c0: 2020 2020 2020 2020 2827 7374 6174 7573          ('status
-000077d0: 5f73 6574 272c 2027 6d61 696e 7465 6e61  _set', 'maintena
-000077e0: 6e63 6527 2c20 2759 656c 6c6f 7727 2c20  nce', 'Yellow', 
-000077f0: 7b27 6973 5f61 7070 273a 2046 616c 7365  {'is_app': False
-00007800: 7d29 2c0a 2020 2020 2020 2020 292c 2028  }),.        ), (
-00007810: 0a20 2020 2020 2020 2020 2020 2027 626c  .            'bl
-00007820: 6f63 6b65 6427 2c0a 2020 2020 2020 2020  ocked',.        
-00007830: 2020 2020 6f70 732e 6d6f 6465 6c2e 426c      ops.model.Bl
-00007840: 6f63 6b65 6453 7461 7475 7328 2752 6564  ockedStatus('Red
-00007850: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00007860: 2827 7374 6174 7573 5f73 6574 272c 2027  ('status_set', '
-00007870: 626c 6f63 6b65 6427 2c20 2752 6564 272c  blocked', 'Red',
-00007880: 207b 2769 735f 6170 7027 3a20 4661 6c73   {'is_app': Fals
-00007890: 657d 292c 0a20 2020 2020 2020 2029 2c20  e}),.        ), 
-000078a0: 280a 2020 2020 2020 2020 2020 2020 2777  (.            'w
-000078b0: 6169 7469 6e67 272c 0a20 2020 2020 2020  aiting',.       
-000078c0: 2020 2020 206f 7073 2e6d 6f64 656c 2e57       ops.model.W
-000078d0: 6169 7469 6e67 5374 6174 7573 2827 5768  aitingStatus('Wh
-000078e0: 6974 6527 292c 0a20 2020 2020 2020 2020  ite'),.         
-000078f0: 2020 2028 2773 7461 7475 735f 7365 7427     ('status_set'
-00007900: 2c20 2777 6169 7469 6e67 272c 2027 5768  , 'waiting', 'Wh
-00007910: 6974 6527 2c20 7b27 6973 5f61 7070 273a  ite', {'is_app':
-00007920: 2046 616c 7365 7d29 2c0a 2020 2020 2020   False}),.      
-00007930: 2020 295d 0a0a 2020 2020 2020 2020 666f    )]..        fo
-00007940: 7220 7465 7374 5f63 6173 652c 2074 6172  r test_case, tar
-00007950: 6765 745f 7374 6174 7573 2c20 6261 636b  get_status, back
-00007960: 656e 645f 6361 6c6c 2069 6e20 7465 7374  end_call in test
-00007970: 5f63 6173 6573 3a0a 2020 2020 2020 2020  _cases:.        
-00007980: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
-00007990: 6254 6573 7428 7465 7374 5f63 6173 6529  bTest(test_case)
-000079a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000079b0: 2020 7365 6c66 2e6d 6f64 656c 2e75 6e69    self.model.uni
-000079c0: 742e 7374 6174 7573 203d 2074 6172 6765  t.status = targe
-000079d0: 745f 7374 6174 7573 0a20 2020 2020 2020  t_status.       
-000079e0: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-000079f0: 7365 7274 4571 7561 6c28 7365 6c66 2e6d  sertEqual(self.m
-00007a00: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
-00007a10: 2c20 7461 7267 6574 5f73 7461 7475 7329  , target_status)
-00007a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007a30: 2073 656c 662e 6d6f 6465 6c2e 756e 6974   self.model.unit
-00007a40: 2e5f 696e 7661 6c69 6461 7465 2829 0a20  ._invalidate(). 
-00007a50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007a60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00007a70: 7365 6c66 2e6d 6f64 656c 2e75 6e69 742e  self.model.unit.
-00007a80: 7374 6174 7573 2c20 7461 7267 6574 5f73  status, target_s
-00007a90: 7461 7475 7329 0a20 2020 2020 2020 2020  tatus).         
-00007aa0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007ab0: 7274 4261 636b 656e 6443 616c 6c73 285b  rtBackendCalls([
-00007ac0: 6261 636b 656e 645f 6361 6c6c 2c20 2827  backend_call, ('
-00007ad0: 7374 6174 7573 5f67 6574 272c 207b 2769  status_get', {'i
-00007ae0: 735f 6170 7027 3a20 4661 6c73 657d 295d  s_app': False})]
-00007af0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00007b00: 6c6f 6361 6c5f 7365 745f 7661 6c69 645f  local_set_valid_
-00007b10: 6170 705f 7374 6174 7573 2873 656c 6629  app_status(self)
-00007b20: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
-00007b30: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
-00007b40: 7228 5472 7565 290a 2020 2020 2020 2020  r(True).        
-00007b50: 7465 7374 5f63 6173 6573 203d 205b 280a  test_cases = [(.
-00007b60: 2020 2020 2020 2020 2020 2020 2761 6374              'act
-00007b70: 6976 6527 2c0a 2020 2020 2020 2020 2020  ive',.          
-00007b80: 2020 6f70 732e 6d6f 6465 6c2e 4163 7469    ops.model.Acti
-00007b90: 7665 5374 6174 7573 2827 4772 6565 6e27  veStatus('Green'
-00007ba0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00007bb0: 2773 7461 7475 735f 7365 7427 2c20 2761  'status_set', 'a
-00007bc0: 6374 6976 6527 2c20 2747 7265 656e 272c  ctive', 'Green',
-00007bd0: 207b 2769 735f 6170 7027 3a20 5472 7565   {'is_app': True
-00007be0: 7d29 2c0a 2020 2020 2020 2020 292c 2028  }),.        ), (
-00007bf0: 0a20 2020 2020 2020 2020 2020 2027 6d61  .            'ma
-00007c00: 696e 7465 6e61 6e63 6527 2c0a 2020 2020  intenance',.    
-00007c10: 2020 2020 2020 2020 6f70 732e 6d6f 6465          ops.mode
-00007c20: 6c2e 4d61 696e 7465 6e61 6e63 6553 7461  l.MaintenanceSta
-00007c30: 7475 7328 2759 656c 6c6f 7727 292c 0a20  tus('Yellow'),. 
-00007c40: 2020 2020 2020 2020 2020 2028 2773 7461             ('sta
-00007c50: 7475 735f 7365 7427 2c20 276d 6169 6e74  tus_set', 'maint
-00007c60: 656e 616e 6365 272c 2027 5965 6c6c 6f77  enance', 'Yellow
-00007c70: 272c 207b 2769 735f 6170 7027 3a20 5472  ', {'is_app': Tr
-00007c80: 7565 7d29 2c0a 2020 2020 2020 2020 292c  ue}),.        ),
-00007c90: 2028 0a20 2020 2020 2020 2020 2020 2027   (.            '
-00007ca0: 626c 6f63 6b65 6427 2c0a 2020 2020 2020  blocked',.      
-00007cb0: 2020 2020 2020 6f70 732e 6d6f 6465 6c2e        ops.model.
-00007cc0: 426c 6f63 6b65 6453 7461 7475 7328 2752  BlockedStatus('R
-00007cd0: 6564 2729 2c0a 2020 2020 2020 2020 2020  ed'),.          
-00007ce0: 2020 2827 7374 6174 7573 5f73 6574 272c    ('status_set',
-00007cf0: 2027 626c 6f63 6b65 6427 2c20 2752 6564   'blocked', 'Red
-00007d00: 272c 207b 2769 735f 6170 7027 3a20 5472  ', {'is_app': Tr
-00007d10: 7565 7d29 2c0a 2020 2020 2020 2020 292c  ue}),.        ),
-00007d20: 2028 0a20 2020 2020 2020 2020 2020 2027   (.            '
-00007d30: 7761 6974 696e 6727 2c0a 2020 2020 2020  waiting',.      
-00007d40: 2020 2020 2020 6f70 732e 6d6f 6465 6c2e        ops.model.
-00007d50: 5761 6974 696e 6753 7461 7475 7328 2757  WaitingStatus('W
-00007d60: 6869 7465 2729 2c0a 2020 2020 2020 2020  hite'),.        
-00007d70: 2020 2020 2827 7374 6174 7573 5f73 6574      ('status_set
-00007d80: 272c 2027 7761 6974 696e 6727 2c20 2757  ', 'waiting', 'W
-00007d90: 6869 7465 272c 207b 2769 735f 6170 7027  hite', {'is_app'
-00007da0: 3a20 5472 7565 7d29 2c0a 2020 2020 2020  : True}),.      
-00007db0: 2020 295d 0a0a 2020 2020 2020 2020 666f    )]..        fo
-00007dc0: 7220 7465 7374 5f63 6173 652c 2074 6172  r test_case, tar
-00007dd0: 6765 745f 7374 6174 7573 2c20 6261 636b  get_status, back
-00007de0: 656e 645f 6361 6c6c 2069 6e20 7465 7374  end_call in test
-00007df0: 5f63 6173 6573 3a0a 2020 2020 2020 2020  _cases:.        
-00007e00: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
-00007e10: 6254 6573 7428 7465 7374 5f63 6173 6529  bTest(test_case)
-00007e20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007e30: 2020 7365 6c66 2e6d 6f64 656c 2e61 7070    self.model.app
-00007e40: 2e73 7461 7475 7320 3d20 7461 7267 6574  .status = target
-00007e50: 5f73 7461 7475 730a 2020 2020 2020 2020  _status.        
-00007e60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007e70: 6572 7445 7175 616c 2873 656c 662e 6d6f  ertEqual(self.mo
-00007e80: 6465 6c2e 6170 702e 7374 6174 7573 2c20  del.app.status, 
-00007e90: 7461 7267 6574 5f73 7461 7475 7329 0a20  target_status). 
-00007ea0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007eb0: 656c 662e 6d6f 6465 6c2e 6170 702e 5f69  elf.model.app._i
-00007ec0: 6e76 616c 6964 6174 6528 290a 2020 2020  nvalidate().    
-00007ed0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00007ee0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00007ef0: 662e 6d6f 6465 6c2e 6170 702e 7374 6174  f.model.app.stat
-00007f00: 7573 2c20 7461 7267 6574 5f73 7461 7475  us, target_statu
-00007f10: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00007f20: 2020 2023 2054 6865 7265 2069 7320 6120     # There is a 
-00007f30: 6261 636b 656e 6420 6361 6c6c 2074 6f20  backend call to 
-00007f40: 6368 6563 6b20 6966 2077 6520 6361 6e20  check if we can 
-00007f50: 7365 7420 7468 6520 7661 6c75 652c 0a20  set the value,. 
-00007f60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007f70: 2061 6e64 2074 6865 6e20 616e 6f74 6865   and then anothe
-00007f80: 7220 6368 6563 6b20 6561 6368 2074 696d  r check each tim
-00007f90: 6520 7765 2061 7373 6572 7420 7468 6520  e we assert the 
-00007fa0: 7374 6174 7573 2061 626f 7665 0a20 2020  status above.   
-00007fb0: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-00007fc0: 6563 7465 645f 6361 6c6c 7320 3d20 5b0a  ected_calls = [.
-00007fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fe0: 2020 2020 2827 6973 5f6c 6561 6465 7227      ('is_leader'
-00007ff0: 2c29 2c20 6261 636b 656e 645f 6361 6c6c  ,), backend_call
-00008000: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008010: 2020 2020 2020 2827 6973 5f6c 6561 6465        ('is_leade
-00008020: 7227 2c29 2c0a 2020 2020 2020 2020 2020  r',),.          
-00008030: 2020 2020 2020 2020 2020 2827 6973 5f6c            ('is_l
-00008040: 6561 6465 7227 2c29 2c20 2827 7374 6174  eader',), ('stat
-00008050: 7573 5f67 6574 272c 207b 2769 735f 6170  us_get', {'is_ap
-00008060: 7027 3a20 5472 7565 7d29 2c0a 2020 2020  p': True}),.    
-00008070: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00008080: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00008090: 6c66 2e61 7373 6572 7442 6163 6b65 6e64  lf.assertBackend
-000080a0: 4361 6c6c 7328 6578 7065 6374 6564 5f63  Calls(expected_c
-000080b0: 616c 6c73 290a 0a20 2020 2064 6566 2074  alls)..    def t
-000080c0: 6573 745f 7365 745f 6170 705f 7374 6174  est_set_app_stat
-000080d0: 7573 5f6e 6f6e 5f6c 6561 6465 725f 7261  us_non_leader_ra
-000080e0: 6973 6573 2873 656c 6629 3a0a 2020 2020  ises(self):.    
-000080f0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-00008100: 2e73 6574 5f6c 6561 6465 7228 4661 6c73  .set_leader(Fals
-00008110: 6529 0a20 2020 2020 2020 2077 6974 6820  e).        with 
-00008120: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00008130: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
-00008140: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00008150: 662e 6d6f 6465 6c2e 6170 702e 7374 6174  f.model.app.stat
-00008160: 7573 0a0a 2020 2020 2020 2020 7769 7468  us..        with
-00008170: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00008180: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-00008190: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000081a0: 6c66 2e6d 6f64 656c 2e61 7070 2e73 7461  lf.model.app.sta
-000081b0: 7475 7320 3d20 6f70 732e 6d6f 6465 6c2e  tus = ops.model.
-000081c0: 4163 7469 7665 5374 6174 7573 2829 0a0a  ActiveStatus()..
-000081d0: 2020 2020 6465 6620 7465 7374 5f73 6574      def test_set
-000081e0: 5f75 6e69 745f 7374 6174 7573 5f69 6e76  _unit_status_inv
-000081f0: 616c 6964 2873 656c 6629 3a0a 2020 2020  alid(self):.    
-00008200: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00008210: 7365 7274 5261 6973 6573 286f 7073 2e6d  sertRaises(ops.m
-00008220: 6f64 656c 2e49 6e76 616c 6964 5374 6174  odel.InvalidStat
-00008230: 7573 4572 726f 7229 3a0a 2020 2020 2020  usError):.      
-00008240: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
-00008250: 2e75 6e69 742e 7374 6174 7573 203d 2027  .unit.status = '
-00008260: 626c 6f63 6b65 6427 0a0a 2020 2020 6465  blocked'..    de
-00008270: 6620 7465 7374 5f73 6574 5f61 7070 5f73  f test_set_app_s
-00008280: 7461 7475 735f 696e 7661 6c69 6428 7365  tatus_invalid(se
-00008290: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
-000082a0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-000082b0: 7365 7328 6f70 732e 6d6f 6465 6c2e 496e  ses(ops.model.In
-000082c0: 7661 6c69 6453 7461 7475 7345 7272 6f72  validStatusError
-000082d0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000082e0: 656c 662e 6d6f 6465 6c2e 6170 702e 7374  elf.model.app.st
-000082f0: 6174 7573 203d 2027 626c 6f63 6b65 6427  atus = 'blocked'
-00008300: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
-00008310: 656d 6f74 655f 756e 6974 5f73 7461 7475  emote_unit_statu
-00008320: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-00008330: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
-00008340: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
-00008350: 7265 6c61 7469 6f6e 2827 6462 3127 2c20  relation('db1', 
-00008360: 2772 656d 6f74 6561 7070 3127 290a 2020  'remoteapp1').  
-00008370: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-00008380: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-00008390: 756e 6974 2872 656c 6174 696f 6e5f 6964  unit(relation_id
-000083a0: 2c20 2772 656d 6f74 6561 7070 312f 3027  , 'remoteapp1/0'
-000083b0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-000083c0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-000083d0: 696f 6e5f 756e 6974 2872 656c 6174 696f  ion_unit(relatio
-000083e0: 6e5f 6964 2c20 2772 656d 6f74 6561 7070  n_id, 'remoteapp
-000083f0: 312f 3127 290a 2020 2020 2020 2020 7265  1/1').        re
-00008400: 6d6f 7465 5f75 6e69 7420 3d20 6e65 7874  mote_unit = next
-00008410: 2866 696c 7465 7228 6c61 6d62 6461 2075  (filter(lambda u
-00008420: 3a20 752e 6e61 6d65 203d 3d20 2772 656d  : u.name == 'rem
-00008430: 6f74 6561 7070 312f 3027 2c0a 2020 2020  oteapp1/0',.    
-00008440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008450: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00008460: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
-00008470: 6174 696f 6e28 2764 6231 2729 2e75 6e69  ation('db1').uni
-00008480: 7473 2929 0a20 2020 2020 2020 2073 656c  ts)).        sel
-00008490: 662e 7265 7365 7442 6163 6b65 6e64 4361  f.resetBackendCa
-000084a0: 6c6c 7328 290a 0a20 2020 2020 2020 2023  lls()..        #
-000084b0: 2052 656d 6f74 6520 756e 6974 2073 7461   Remote unit sta
-000084c0: 7475 7320 6973 2061 6c77 6179 7320 756e  tus is always un
-000084d0: 6b6e 6f77 6e2e 0a20 2020 2020 2020 2073  known..        s
-000084e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000084f0: 7265 6d6f 7465 5f75 6e69 742e 7374 6174  remote_unit.stat
-00008500: 7573 2c20 6f70 732e 6d6f 6465 6c2e 556e  us, ops.model.Un
-00008510: 6b6e 6f77 6e53 7461 7475 7328 2929 0a0a  knownStatus())..
-00008520: 2020 2020 2020 2020 7465 7374 5f73 7461          test_sta
-00008530: 7475 7365 7320 3d20 280a 2020 2020 2020  tuses = (.      
-00008540: 2020 2020 2020 6f70 732e 6d6f 6465 6c2e        ops.model.
-00008550: 556e 6b6e 6f77 6e53 7461 7475 7328 292c  UnknownStatus(),
-00008560: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
-00008570: 2e6d 6f64 656c 2e41 6374 6976 6553 7461  .model.ActiveSta
-00008580: 7475 7328 2747 7265 656e 2729 2c0a 2020  tus('Green'),.  
-00008590: 2020 2020 2020 2020 2020 6f70 732e 6d6f            ops.mo
-000085a0: 6465 6c2e 4d61 696e 7465 6e61 6e63 6553  del.MaintenanceS
-000085b0: 7461 7475 7328 2759 656c 6c6f 7727 292c  tatus('Yellow'),
-000085c0: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
-000085d0: 2e6d 6f64 656c 2e42 6c6f 636b 6564 5374  .model.BlockedSt
-000085e0: 6174 7573 2827 5265 6427 292c 0a20 2020  atus('Red'),.   
-000085f0: 2020 2020 2020 2020 206f 7073 2e6d 6f64           ops.mod
-00008600: 656c 2e57 6169 7469 6e67 5374 6174 7573  el.WaitingStatus
-00008610: 2827 5768 6974 6527 292c 0a20 2020 2020  ('White'),.     
-00008620: 2020 2029 0a0a 2020 2020 2020 2020 666f     )..        fo
-00008630: 7220 7461 7267 6574 5f73 7461 7475 7320  r target_status 
-00008640: 696e 2074 6573 745f 7374 6174 7573 6573  in test_statuses
-00008650: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-00008660: 7468 2073 656c 662e 7375 6254 6573 7428  th self.subTest(
-00008670: 7461 7267 6574 5f73 7461 7475 732e 6e61  target_status.na
-00008680: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
-00008690: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000086a0: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
-000086b0: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
-000086c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000086d0: 656d 6f74 655f 756e 6974 2e73 7461 7475  emote_unit.statu
-000086e0: 7320 3d20 7461 7267 6574 5f73 7461 7475  s = target_statu
-000086f0: 730a 2020 2020 2020 2020 7365 6c66 2e61  s.        self.a
-00008700: 7373 6572 7442 6163 6b65 6e64 4361 6c6c  ssertBackendCall
-00008710: 7328 5b5d 290a 0a20 2020 2064 6566 2074  s([])..    def t
-00008720: 6573 745f 7265 6d6f 7465 5f61 7070 5f73  est_remote_app_s
-00008730: 7461 7475 7328 7365 6c66 293a 0a20 2020  tatus(self):.   
-00008740: 2020 2020 2072 656c 6174 696f 6e5f 6964       relation_id
-00008750: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
-00008760: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00008770: 3127 2c20 2772 656d 6f74 6561 7070 3127  1', 'remoteapp1'
-00008780: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
-00008790: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-000087a0: 696f 6e5f 756e 6974 2872 656c 6174 696f  ion_unit(relatio
-000087b0: 6e5f 6964 2c20 2772 656d 6f74 6561 7070  n_id, 'remoteapp
-000087c0: 312f 3027 290a 2020 2020 2020 2020 7365  1/0').        se
-000087d0: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
-000087e0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-000087f0: 6174 696f 6e5f 6964 2c20 2772 656d 6f74  ation_id, 'remot
-00008800: 6561 7070 312f 3127 290a 2020 2020 2020  eapp1/1').      
-00008810: 2020 7265 6d6f 7465 6170 7031 203d 2073    remoteapp1 = s
-00008820: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
-00008830: 6c61 7469 6f6e 2827 6462 3127 292e 6170  lation('db1').ap
-00008840: 700a 2020 2020 2020 2020 7365 6c66 2e72  p.        self.r
-00008850: 6573 6574 4261 636b 656e 6443 616c 6c73  esetBackendCalls
-00008860: 2829 0a0a 2020 2020 2020 2020 2320 5265  ()..        # Re
-00008870: 6d6f 7465 2061 7070 6c69 6361 7469 6f6e  mote application
-00008880: 2073 7461 7475 7320 6973 2061 6c77 6179   status is alway
-00008890: 7320 756e 6b6e 6f77 6e2e 0a20 2020 2020  s unknown..     
-000088a0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-000088b0: 496e 7374 616e 6365 2872 656d 6f74 6561  Instance(remotea
-000088c0: 7070 312e 7374 6174 7573 2c20 6f70 732e  pp1.status, ops.
-000088d0: 6d6f 6465 6c2e 556e 6b6e 6f77 6e53 7461  model.UnknownSta
-000088e0: 7475 7329 0a0a 2020 2020 2020 2020 7465  tus)..        te
-000088f0: 7374 5f73 7461 7475 7365 7320 3d20 280a  st_statuses = (.
-00008900: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-00008910: 6d6f 6465 6c2e 556e 6b6e 6f77 6e53 7461  model.UnknownSta
-00008920: 7475 7328 292c 0a20 2020 2020 2020 2020  tus(),.         
-00008930: 2020 206f 7073 2e6d 6f64 656c 2e41 6374     ops.model.Act
-00008940: 6976 6553 7461 7475 7328 292c 0a20 2020  iveStatus(),.   
-00008950: 2020 2020 2020 2020 206f 7073 2e6d 6f64           ops.mod
-00008960: 656c 2e4d 6169 6e74 656e 616e 6365 5374  el.MaintenanceSt
-00008970: 6174 7573 2827 5570 6772 6164 696e 6720  atus('Upgrading 
-00008980: 736f 6674 7761 7265 2729 2c0a 2020 2020  software'),.    
-00008990: 2020 2020 2020 2020 6f70 732e 6d6f 6465          ops.mode
-000089a0: 6c2e 426c 6f63 6b65 6453 7461 7475 7328  l.BlockedStatus(
-000089b0: 2741 7761 6974 696e 6720 6d61 6e75 616c  'Awaiting manual
-000089c0: 2072 6573 6f6c 7574 696f 6e27 292c 0a20   resolution'),. 
-000089d0: 2020 2020 2020 2020 2020 206f 7073 2e6d             ops.m
-000089e0: 6f64 656c 2e57 6169 7469 6e67 5374 6174  odel.WaitingStat
-000089f0: 7573 2827 4177 6169 7469 6e67 2072 656c  us('Awaiting rel
-00008a00: 6174 6564 2061 7070 2075 7064 6174 6573  ated app updates
-00008a10: 2729 2c0a 2020 2020 2020 2020 290a 2020  '),.        ).  
-00008a20: 2020 2020 2020 666f 7220 7461 7267 6574        for target
-00008a30: 5f73 7461 7475 7320 696e 2074 6573 745f  _status in test_
-00008a40: 7374 6174 7573 6573 3a0a 2020 2020 2020  statuses:.      
-00008a50: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00008a60: 7375 6254 6573 7428 7461 7267 6574 5f73  subTest(target_s
-00008a70: 7461 7475 732e 6e61 6d65 293a 0a20 2020  tatus.name):.   
-00008a80: 2020 2020 2020 2020 2020 2020 2077 6974               wit
-00008a90: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00008aa0: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
-00008ab0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00008ac0: 2020 2020 2020 2072 656d 6f74 6561 7070         remoteapp
-00008ad0: 312e 7374 6174 7573 203d 2074 6172 6765  1.status = targe
-00008ae0: 745f 7374 6174 7573 0a20 2020 2020 2020  t_status.       
-00008af0: 2073 656c 662e 6173 7365 7274 4261 636b   self.assertBack
-00008b00: 656e 6443 616c 6c73 285b 5d29 0a0a 2020  endCalls([])..  
-00008b10: 2020 6465 6620 7465 7374 5f73 746f 7261    def test_stora
-00008b20: 6765 2873 656c 6629 3a0a 2020 2020 2020  ge(self):.      
-00008b30: 2020 6d65 7461 203d 206f 7073 2e63 6861    meta = ops.cha
-00008b40: 726d 2e43 6861 726d 4d65 7461 2829 0a20  rm.CharmMeta(). 
-00008b50: 2020 2020 2020 206d 6574 612e 7374 6f72         meta.stor
-00008b60: 6167 6573 203d 207b 2764 6973 6b73 273a  ages = {'disks':
-00008b70: 204e 6f6e 652c 2027 6461 7461 273a 204e   None, 'data': N
-00008b80: 6f6e 657d 0a20 2020 2020 2020 206d 6f64  one}.        mod
-00008b90: 656c 203d 206f 7073 2e6d 6f64 656c 2e4d  el = ops.model.M
-00008ba0: 6f64 656c 286d 6574 612c 206f 7073 2e6d  odel(meta, ops.m
-00008bb0: 6f64 656c 2e5f 4d6f 6465 6c42 6163 6b65  odel._ModelBacke
-00008bc0: 6e64 2827 6d79 6170 702f 3027 2929 0a0a  nd('myapp/0'))..
-00008bd0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00008be0: 6970 7428 7365 6c66 2c20 2773 746f 7261  ipt(self, 'stora
-00008bf0: 6765 2d6c 6973 7427 2c20 2727 270a 2020  ge-list', '''.  
-00008c00: 2020 2020 2020 2020 2020 6966 205b 2022            if [ "
-00008c10: 2431 2220 3d20 6469 736b 7320 5d3b 2074  $1" = disks ]; t
-00008c20: 6865 6e0a 2020 2020 2020 2020 2020 2020  hen.            
-00008c30: 2020 2020 6563 686f 2027 5b22 6469 736b      echo '["disk
-00008c40: 732f 3022 2c20 2264 6973 6b73 2f31 225d  s/0", "disks/1"]
-00008c50: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-00008c60: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00008c70: 2020 2065 6368 6f20 275b 5d27 0a20 2020     echo '[]'.   
-00008c80: 2020 2020 2020 2020 2066 690a 2020 2020           fi.    
-00008c90: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00008ca0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00008cb0: 662c 2027 7374 6f72 6167 652d 6765 7427  f, 'storage-get'
-00008cc0: 2c20 2727 270a 2020 2020 2020 2020 2020  , '''.          
-00008cd0: 2020 6966 205b 2022 2432 2220 3d20 6469    if [ "$2" = di
-00008ce0: 736b 732f 3020 5d3b 2074 6865 6e0a 2020  sks/0 ]; then.  
-00008cf0: 2020 2020 2020 2020 2020 2020 2020 6563                ec
-00008d00: 686f 2027 222f 7661 722f 7372 762f 6469  ho '"/var/srv/di
-00008d10: 736b 732f 3022 270a 2020 2020 2020 2020  sks/0"'.        
-00008d20: 2020 2020 656c 6966 205b 2022 2432 2220      elif [ "$2" 
-00008d30: 3d20 6469 736b 732f 3120 5d3b 2074 6865  = disks/1 ]; the
-00008d40: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00008d50: 2020 6563 686f 2027 222f 7661 722f 7372    echo '"/var/sr
-00008d60: 762f 6469 736b 732f 3122 270a 2020 2020  v/disks/1"'.    
-00008d70: 2020 2020 2020 2020 656c 7365 0a20 2020          else.   
-00008d80: 2020 2020 2020 2020 2020 2020 2065 7869               exi
-00008d90: 7420 320a 2020 2020 2020 2020 2020 2020  t 2.            
-00008da0: 6669 0a20 2020 2020 2020 2027 2727 290a  fi.        ''').
-00008db0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00008dc0: 6970 7428 7365 6c66 2c20 2773 746f 7261  ipt(self, 'stora
-00008dd0: 6765 2d61 6464 272c 2027 2729 0a0a 2020  ge-add', '')..  
-00008de0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00008df0: 7445 7175 616c 286c 656e 286d 6f64 656c  tEqual(len(model
-00008e00: 2e73 746f 7261 6765 7329 2c20 3229 0a20  .storages), 2). 
-00008e10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008e20: 7274 4571 7561 6c28 6d6f 6465 6c2e 7374  rtEqual(model.st
-00008e30: 6f72 6167 6573 2e6b 6579 7328 292c 206d  orages.keys(), m
-00008e40: 6574 612e 7374 6f72 6167 6573 2e6b 6579  eta.storages.key
-00008e50: 7328 2929 0a20 2020 2020 2020 2073 656c  s()).        sel
-00008e60: 662e 6173 7365 7274 496e 2827 6469 736b  f.assertIn('disk
-00008e70: 7327 2c20 6d6f 6465 6c2e 7374 6f72 6167  s', model.storag
-00008e80: 6573 290a 0a20 2020 2020 2020 2077 6974  es)..        wit
-00008e90: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
-00008ea0: 4b65 7945 7272 6f72 2c20 6d61 7463 683d  KeyError, match=
-00008eb0: 2744 6964 2079 6f75 206d 6561 6e27 293a  'Did you mean'):
-00008ec0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-00008ed0: 656c 2e73 746f 7261 6765 735b 2764 6f65  el.storages['doe
-00008ee0: 732d 6e6f 742d 6578 6973 7427 5d0a 0a20  s-not-exist'].. 
-00008ef0: 2020 2020 2020 2074 6573 745f 6361 7365         test_case
-00008f00: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-00008f10: 2020 303a 207b 276e 616d 6527 3a20 2764    0: {'name': 'd
-00008f20: 6973 6b73 272c 2027 6c6f 6361 7469 6f6e  isks', 'location
-00008f30: 273a 2070 6174 686c 6962 2e50 6174 6828  ': pathlib.Path(
-00008f40: 272f 7661 722f 7372 762f 6469 736b 732f  '/var/srv/disks/
-00008f50: 3027 297d 2c0a 2020 2020 2020 2020 2020  0')},.          
-00008f60: 2020 313a 207b 276e 616d 6527 3a20 2764    1: {'name': 'd
-00008f70: 6973 6b73 272c 2027 6c6f 6361 7469 6f6e  isks', 'location
-00008f80: 273a 2070 6174 686c 6962 2e50 6174 6828  ': pathlib.Path(
-00008f90: 272f 7661 722f 7372 762f 6469 736b 732f  '/var/srv/disks/
-00008fa0: 3127 297d 2c0a 2020 2020 2020 2020 7d0a  1')},.        }.
-00008fb0: 2020 2020 2020 2020 666f 7220 7374 6f72          for stor
-00008fc0: 6167 6520 696e 206d 6f64 656c 2e73 746f  age in model.sto
-00008fd0: 7261 6765 735b 2764 6973 6b73 275d 3a0a  rages['disks']:.
-00008fe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00008ff0: 2e61 7373 6572 7445 7175 616c 2873 746f  .assertEqual(sto
-00009000: 7261 6765 2e6e 616d 652c 2027 6469 736b  rage.name, 'disk
-00009010: 7327 290a 2020 2020 2020 2020 2020 2020  s').            
-00009020: 7365 6c66 2e61 7373 6572 7449 6e28 7374  self.assertIn(st
-00009030: 6f72 6167 652e 6964 2c20 7465 7374 5f63  orage.id, test_c
-00009040: 6173 6573 290a 2020 2020 2020 2020 2020  ases).          
-00009050: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00009060: 616c 2873 746f 7261 6765 2e6e 616d 652c  al(storage.name,
-00009070: 2074 6573 745f 6361 7365 735b 7374 6f72   test_cases[stor
-00009080: 6167 652e 6964 5d5b 276e 616d 6527 5d29  age.id]['name'])
-00009090: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000090a0: 662e 6173 7365 7274 4571 7561 6c28 7374  f.assertEqual(st
-000090b0: 6f72 6167 652e 6c6f 6361 7469 6f6e 2c20  orage.location, 
-000090c0: 7465 7374 5f63 6173 6573 5b73 746f 7261  test_cases[stora
-000090d0: 6765 2e69 645d 5b27 6c6f 6361 7469 6f6e  ge.id]['location
-000090e0: 275d 290a 0a20 2020 2020 2020 2073 656c  '])..        sel
-000090f0: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00009100: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-00009110: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-00009120: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-00009130: 205b 2773 746f 7261 6765 2d6c 6973 7427   ['storage-list'
-00009140: 2c20 2764 6973 6b73 272c 2027 2d2d 666f  , 'disks', '--fo
-00009150: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
-00009160: 2020 2020 2020 2020 205b 2773 746f 7261           ['stora
-00009170: 6765 2d67 6574 272c 2027 2d73 272c 2027  ge-get', '-s', '
-00009180: 6469 736b 732f 3027 2c20 276c 6f63 6174  disks/0', 'locat
-00009190: 696f 6e27 2c20 272d 2d66 6f72 6d61 743d  ion', '--format=
-000091a0: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
-000091b0: 2020 2020 5b27 7374 6f72 6167 652d 6765      ['storage-ge
-000091c0: 7427 2c20 272d 7327 2c20 2764 6973 6b73  t', '-s', 'disks
-000091d0: 2f31 272c 2027 6c6f 6361 7469 6f6e 272c  /1', 'location',
-000091e0: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
-000091f0: 5d2c 0a20 2020 2020 2020 205d 290a 0a20  ],.        ]).. 
-00009200: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00009210: 7274 5365 7175 656e 6365 4571 7561 6c28  rtSequenceEqual(
-00009220: 6d6f 6465 6c2e 7374 6f72 6167 6573 5b27  model.storages['
-00009230: 6461 7461 275d 2c20 5b5d 290a 2020 2020  data'], []).    
-00009240: 2020 2020 6d6f 6465 6c2e 7374 6f72 6167      model.storag
-00009250: 6573 2e72 6571 7565 7374 2827 6461 7461  es.request('data
-00009260: 272c 2063 6f75 6e74 3d33 290a 2020 2020  ', count=3).    
-00009270: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00009280: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-00009290: 5f63 616c 6c73 2873 656c 6629 2c20 5b0a  _calls(self), [.
-000092a0: 2020 2020 2020 2020 2020 2020 5b27 7374              ['st
-000092b0: 6f72 6167 652d 6c69 7374 272c 2027 6461  orage-list', 'da
-000092c0: 7461 272c 2027 2d2d 666f 726d 6174 3d6a  ta', '--format=j
-000092d0: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
-000092e0: 2020 205b 2773 746f 7261 6765 2d61 6464     ['storage-add
-000092f0: 272c 2027 6461 7461 3d33 275d 2c0a 2020  ', 'data=3'],.  
-00009300: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
-00009310: 2020 2320 5472 7920 746f 2061 6464 2073    # Try to add s
-00009320: 746f 7261 6765 206e 6f74 2070 7265 7365  torage not prese
-00009330: 6e74 2069 6e20 6368 6172 6d20 6d65 7461  nt in charm meta
-00009340: 6461 7461 2e0a 2020 2020 2020 2020 7769  data..        wi
-00009350: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00009360: 6973 6573 286f 7073 2e6d 6f64 656c 2e4d  ises(ops.model.M
-00009370: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
-00009380: 2020 2020 2020 2020 6d6f 6465 6c2e 7374          model.st
-00009390: 6f72 6167 6573 2e72 6571 7565 7374 2827  orages.request('
-000093a0: 6465 6164 6265 6566 2729 0a0a 2020 2020  deadbeef')..    
-000093b0: 2020 2020 2320 496e 7661 6c69 6420 636f      # Invalid co
-000093c0: 756e 7420 7061 7261 6d65 7465 7220 7479  unt parameter ty
-000093d0: 7065 732e 0a20 2020 2020 2020 2066 6f72  pes..        for
-000093e0: 2063 6f75 6e74 5f76 2069 6e20 5b4e 6f6e   count_v in [Non
-000093f0: 652c 2046 616c 7365 2c20 322e 302c 2027  e, False, 2.0, '
-00009400: 6127 2c20 6227 6265 6566 272c 206f 626a  a', b'beef', obj
-00009410: 6563 745d 3a0a 2020 2020 2020 2020 2020  ect]:.          
-00009420: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00009430: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
-00009440: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00009450: 2020 2020 206d 6f64 656c 2e73 746f 7261       model.stora
-00009460: 6765 732e 7265 7175 6573 7428 2764 6174  ges.request('dat
-00009470: 6127 2c20 636f 756e 745f 7629 0a0a 2020  a', count_v)..  
-00009480: 2020 6465 6620 7465 7374 5f73 746f 7261    def test_stora
-00009490: 6765 735f 696d 6d75 7461 626c 6528 7365  ges_immutable(se
-000094a0: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
-000094b0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-000094c0: 7365 7328 4174 7472 6962 7574 6545 7272  ses(AttributeErr
-000094d0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-000094e0: 2073 656c 662e 6d6f 6465 6c2e 7374 6f72   self.model.stor
-000094f0: 6167 6573 203d 207b 7d0a 0a20 2020 2064  ages = {}..    d
-00009500: 6566 2072 6573 6574 4261 636b 656e 6443  ef resetBackendC
-00009510: 616c 6c73 2873 656c 6629 3a20 2023 206e  alls(self):  # n
-00009520: 6f71 613a 204e 3830 320a 2020 2020 2020  oqa: N802.      
-00009530: 2020 7365 6c66 2e68 6172 6e65 7373 2e5f    self.harness._
-00009540: 6765 745f 6261 636b 656e 645f 6361 6c6c  get_backend_call
-00009550: 7328 7265 7365 743d 5472 7565 290a 0a20  s(reset=True).. 
-00009560: 2020 2064 6566 2061 7373 6572 7442 6163     def assertBac
-00009570: 6b65 6e64 4361 6c6c 7328 7365 6c66 2c20  kendCalls(self, 
-00009580: 6578 7065 6374 6564 2c20 2a2c 2072 6573  expected, *, res
-00009590: 6574 3d54 7275 6529 3a20 2023 206e 6f71  et=True):  # noq
-000095a0: 613a 204e 3830 320a 2020 2020 2020 2020  a: N802.        
-000095b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000095c0: 2865 7870 6563 7465 642c 2073 656c 662e  (expected, self.
-000095d0: 6861 726e 6573 732e 5f67 6574 5f62 6163  harness._get_bac
-000095e0: 6b65 6e64 5f63 616c 6c73 2872 6573 6574  kend_calls(reset
-000095f0: 3d72 6573 6574 2929 0a0a 2020 2020 6465  =reset))..    de
-00009600: 6620 7465 7374 5f72 756e 5f65 7272 6f72  f test_run_error
-00009610: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00009620: 6d6f 6465 6c20 3d20 6f70 732e 6d6f 6465  model = ops.mode
-00009630: 6c2e 4d6f 6465 6c28 6f70 732e 6368 6172  l.Model(ops.char
-00009640: 6d2e 4368 6172 6d4d 6574 6128 292c 206f  m.CharmMeta(), o
-00009650: 7073 2e6d 6f64 656c 2e5f 4d6f 6465 6c42  ps.model._ModelB
-00009660: 6163 6b65 6e64 2827 6d79 6170 702f 3027  ackend('myapp/0'
-00009670: 2929 0a20 2020 2020 2020 2066 616b 655f  )).        fake_
-00009680: 7363 7269 7074 2873 656c 662c 2027 7374  script(self, 'st
-00009690: 6174 7573 2d67 6574 272c 2022 2222 6563  atus-get', """ec
-000096a0: 686f 2027 4552 524f 5220 6361 6e6e 6f74  ho 'ERROR cannot
-000096b0: 2067 6574 2073 7461 7475 7327 203e 2632   get status' >&2
-000096c0: 3b20 6578 6974 2031 2222 2229 0a20 2020  ; exit 1""").   
-000096d0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000096e0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-000096f0: 6d6f 6465 6c2e 4d6f 6465 6c45 7272 6f72  model.ModelError
-00009700: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-00009710: 2020 2020 205f 203d 206d 6f64 656c 2e75       _ = model.u
-00009720: 6e69 742e 7374 6174 7573 2e6d 6573 7361  nit.status.messa
-00009730: 6765 0a20 2020 2020 2020 2073 656c 662e  ge.        self.
-00009740: 6173 7365 7274 4571 7561 6c28 7374 7228  assertEqual(str(
-00009750: 636d 2e65 7863 6570 7469 6f6e 292c 2027  cm.exception), '
-00009760: 4552 524f 5220 6361 6e6e 6f74 2067 6574  ERROR cannot get
-00009770: 2073 7461 7475 735c 6e27 290a 2020 2020   status\n').    
-00009780: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00009790: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
-000097a0: 6e2e 6172 6773 5b30 5d2c 2027 4552 524f  n.args[0], 'ERRO
-000097b0: 5220 6361 6e6e 6f74 2067 6574 2073 7461  R cannot get sta
-000097c0: 7475 735c 6e27 290a 0a0a 636c 6173 7320  tus\n')...class 
-000097d0: 5075 7368 5075 6c6c 4361 7365 3a0a 2020  PushPullCase:.  
-000097e0: 2020 2222 2254 6573 7420 6361 7365 2066    """Test case f
-000097f0: 6f72 2074 6162 6c65 2d64 7269 7665 6e20  or table-driven 
-00009800: 7465 7374 732e 2222 220a 0a20 2020 2064  tests."""..    d
-00009810: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00009820: 2c20 2a2a 7661 6c73 293a 0a20 2020 2020  , **vals):.     
-00009830: 2020 2073 656c 662e 7061 7474 6572 6e20     self.pattern 
-00009840: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-00009850: 656c 662e 6473 7420 3d20 4e6f 6e65 0a20  elf.dst = None. 
-00009860: 2020 2020 2020 2073 656c 662e 6572 726f         self.erro
-00009870: 7273 203d 205b 5d0a 2020 2020 2020 2020  rs = [].        
-00009880: 7365 6c66 2e77 616e 7420 3d20 7365 7428  self.want = set(
-00009890: 290a 2020 2020 2020 2020 666f 7220 6b65  ).        for ke
-000098a0: 792c 2076 616c 2069 6e20 7661 6c73 2e69  y, val in vals.i
-000098b0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-000098c0: 2020 2020 7365 7461 7474 7228 7365 6c66      setattr(self
-000098d0: 2c20 6b65 792c 2076 616c 290a 0a0a 7265  , key, val)...re
-000098e0: 6375 7273 6976 655f 6c69 7374 5f63 6173  cursive_list_cas
-000098f0: 6573 203d 205b 0a20 2020 2050 7573 6850  es = [.    PushP
-00009900: 756c 6c43 6173 6528 0a20 2020 2020 2020  ullCase(.       
-00009910: 206e 616d 653d 2762 6173 6963 2072 6563   name='basic rec
-00009920: 7572 7369 7665 206c 6973 7427 2c0a 2020  ursive list',.  
-00009930: 2020 2020 2020 7061 7468 3d27 2f27 2c0a        path='/',.
-00009940: 2020 2020 2020 2020 6669 6c65 733d 5b27          files=['
-00009950: 2f66 6f6f 2f62 6172 2e74 7874 272c 2027  /foo/bar.txt', '
-00009960: 2f62 617a 2e74 7874 275d 2c0a 2020 2020  /baz.txt'],.    
-00009970: 2020 2020 7761 6e74 3d7b 272f 666f 6f2f      want={'/foo/
-00009980: 6261 722e 7478 7427 2c20 272f 6261 7a2e  bar.txt', '/baz.
-00009990: 7478 7427 7d2c 0a20 2020 2029 2c0a 2020  txt'},.    ),.  
-000099a0: 2020 5075 7368 5075 6c6c 4361 7365 280a    PushPullCase(.
-000099b0: 2020 2020 2020 2020 6e61 6d65 3d27 6261          name='ba
-000099c0: 7369 6320 7265 6375 7273 6976 6520 6c69  sic recursive li
-000099d0: 7374 2072 6576 6572 7365 272c 0a20 2020  st reverse',.   
-000099e0: 2020 2020 2070 6174 683d 272f 272c 0a20       path='/',. 
-000099f0: 2020 2020 2020 2066 696c 6573 3d5b 272f         files=['/
-00009a00: 6261 7a2e 7478 7427 2c20 272f 666f 6f2f  baz.txt', '/foo/
-00009a10: 6261 722e 7478 7427 5d2c 0a20 2020 2020  bar.txt'],.     
-00009a20: 2020 2077 616e 743d 7b27 2f66 6f6f 2f62     want={'/foo/b
-00009a30: 6172 2e74 7874 272c 2027 2f62 617a 2e74  ar.txt', '/baz.t
-00009a40: 7874 277d 2c0a 2020 2020 292c 0a20 2020  xt'},.    ),.   
-00009a50: 2050 7573 6850 756c 6c43 6173 6528 0a20   PushPullCase(. 
-00009a60: 2020 2020 2020 206e 616d 653d 2764 6972         name='dir
-00009a70: 6563 746c 7920 6c69 7374 2061 2028 6e6f  ectly list a (no
-00009a80: 6e2d 6469 7265 6374 6f72 7929 2066 696c  n-directory) fil
-00009a90: 6527 2c0a 2020 2020 2020 2020 7061 7468  e',.        path
-00009aa0: 3d27 2f62 617a 2e74 7874 272c 0a20 2020  ='/baz.txt',.   
-00009ab0: 2020 2020 2066 696c 6573 3d5b 272f 6261       files=['/ba
-00009ac0: 7a2e 7478 7427 5d2c 0a20 2020 2020 2020  z.txt'],.       
-00009ad0: 2077 616e 743d 7b27 2f62 617a 2e74 7874   want={'/baz.txt
-00009ae0: 277d 2c0a 2020 2020 292c 0a5d 0a0a 0a40  '},.    ),.]...@
-00009af0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-00009b00: 6d65 7472 697a 6528 2763 6173 6527 2c20  metrize('case', 
-00009b10: 7265 6375 7273 6976 655f 6c69 7374 5f63  recursive_list_c
-00009b20: 6173 6573 290a 6465 6620 7465 7374 5f72  ases).def test_r
-00009b30: 6563 7572 7369 7665 5f6c 6973 7428 6361  ecursive_list(ca
-00009b40: 7365 293a 0a20 2020 2064 6566 206c 6973  se):.    def lis
-00009b50: 745f 6675 6e63 5f67 656e 2866 696c 655f  t_func_gen(file_
-00009b60: 6c69 7374 293a 0a20 2020 2020 2020 2061  list):.        a
-00009b70: 7267 7320 3d20 7b0a 2020 2020 2020 2020  rgs = {.        
-00009b80: 2020 2020 276c 6173 745f 6d6f 6469 6669      'last_modifi
-00009b90: 6564 273a 2064 6174 6574 696d 652e 7469  ed': datetime.ti
-00009ba0: 6d65 2829 2c0a 2020 2020 2020 2020 2020  me(),.          
-00009bb0: 2020 2770 6572 6d69 7373 696f 6e73 273a    'permissions':
-00009bc0: 2030 6f37 3737 2c0a 2020 2020 2020 2020   0o777,.        
-00009bd0: 2020 2020 2773 697a 6527 3a20 3432 2c0a      'size': 42,.
-00009be0: 2020 2020 2020 2020 2020 2020 2775 7365              'use
-00009bf0: 725f 6964 273a 2030 2c0a 2020 2020 2020  r_id': 0,.      
-00009c00: 2020 2020 2020 2775 7365 7227 3a20 2766        'user': 'f
-00009c10: 6f6f 272c 0a20 2020 2020 2020 2020 2020  oo',.           
-00009c20: 2027 6772 6f75 705f 6964 273a 2031 3032   'group_id': 102
-00009c30: 342c 0a20 2020 2020 2020 2020 2020 2027  4,.            '
-00009c40: 6772 6f75 7027 3a20 2762 6172 272c 0a20  group': 'bar',. 
-00009c50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00009c60: 2066 696c 655f 696e 666f 732c 2064 6972   file_infos, dir
-00009c70: 7320 3d20 5b5d 2c20 7365 7428 290a 2020  s = [], set().  
-00009c80: 2020 2020 2020 666f 7220 6620 696e 2066        for f in f
-00009c90: 696c 655f 6c69 7374 3a0a 2020 2020 2020  ile_list:.      
-00009ca0: 2020 2020 2020 6669 6c65 5f69 6e66 6f73        file_infos
-00009cb0: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-00009cc0: 2020 2020 2020 2020 2046 696c 6549 6e66           FileInf
-00009cd0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00009ce0: 2020 2020 2020 2070 6174 683d 662c 0a20         path=f,. 
+000028a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000028b0: 2020 7b27 686f 7374 273a 2027 7265 6d6f    {'host': 'remo
+000028c0: 7465 6170 7031 2f30 277d 290a 2020 2020  teapp1/0'}).    
+000028d0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e72      self.model.r
+000028e0: 656c 6174 696f 6e73 2e5f 696e 7661 6c69  elations._invali
+000028f0: 6461 7465 2827 6462 3127 290a 2020 2020  date('db1').    
+00002900: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
+00002910: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
+00002920: 2020 2020 2020 7265 6c5f 6462 3120 3d20        rel_db1 = 
+00002930: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+00002940: 656c 6174 696f 6e28 2764 6231 2729 0a20  elation('db1'). 
+00002950: 2020 2020 2020 2072 656d 6f74 6561 7070         remoteapp
+00002960: 315f 3020 3d20 6e65 7874 2866 696c 7465  1_0 = next(filte
+00002970: 7228 6c61 6d62 6461 2075 3a20 752e 6e61  r(lambda u: u.na
+00002980: 6d65 203d 3d20 2772 656d 6f74 6561 7070  me == 'remoteapp
+00002990: 312f 3027 2c0a 2020 2020 2020 2020 2020  1/0',.          
+000029a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029b0: 2020 2020 2020 2020 2073 656c 662e 6d6f           self.mo
+000029c0: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+000029d0: 2827 6462 3127 292e 756e 6974 7329 290a  ('db1').units)).
+000029e0: 2020 2020 2020 2020 2320 466f 7263 6520          # Force 
+000029f0: 6d65 6d6f 7279 2063 6163 6865 2074 6f20  memory cache to 
+00002a00: 6265 206c 6f61 6465 642e 0a20 2020 2020  be loaded..     
+00002a10: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
+00002a20: 2827 686f 7374 272c 2072 656c 5f64 6231  ('host', rel_db1
+00002a30: 2e64 6174 615b 7265 6d6f 7465 6170 7031  .data[remoteapp1
+00002a40: 5f30 5d29 0a20 2020 2020 2020 2073 656c  _0]).        sel
+00002a50: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
+00002a60: 7072 2872 656c 5f64 6231 2e64 6174 615b  pr(rel_db1.data[
+00002a70: 7265 6d6f 7465 6170 7031 5f30 5d29 2c20  remoteapp1_0]), 
+00002a80: 227b 2768 6f73 7427 3a20 2772 656d 6f74  "{'host': 'remot
+00002a90: 6561 7070 312f 3027 7d22 290a 0a20 2020  eapp1/0'}")..   
+00002aa0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
+00002ab0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
+00002ac0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
+00002ad0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00002ae0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00002af0: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+00002b00: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
+00002b10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00002b20: 656c 5f64 6231 2e64 6174 615b 7265 6d6f  el_db1.data[remo
+00002b30: 7465 6170 7031 5f30 5d5b 2766 6f6f 275d  teapp1_0]['foo']
+00002b40: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
+00002b50: 2073 656c 662e 6173 7365 7274 4e6f 7449   self.assertNotI
+00002b60: 6e28 2766 6f6f 272c 2072 656c 5f64 6231  n('foo', rel_db1
+00002b70: 2e64 6174 615b 7265 6d6f 7465 6170 7031  .data[remoteapp1
+00002b80: 5f30 5d29 0a0a 2020 2020 2020 2020 7365  _0])..        se
+00002b90: 6c66 2e61 7373 6572 7442 6163 6b65 6e64  lf.assertBackend
+00002ba0: 4361 6c6c 7328 5b0a 2020 2020 2020 2020  Calls([.        
+00002bb0: 2020 2020 2827 7265 6c61 7469 6f6e 5f69      ('relation_i
+00002bc0: 6473 272c 2027 6462 3127 292c 0a20 2020  ds', 'db1'),.   
+00002bd0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+00002be0: 696f 6e5f 6c69 7374 272c 2072 656c 6174  ion_list', relat
+00002bf0: 696f 6e5f 6964 292c 0a20 2020 2020 2020  ion_id),.       
+00002c00: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+00002c10: 6765 7427 2c20 7265 6c61 7469 6f6e 5f69  get', relation_i
+00002c20: 642c 2027 7265 6d6f 7465 6170 7031 2f30  d, 'remoteapp1/0
+00002c30: 272c 2046 616c 7365 292c 0a20 2020 2020  ', False),.     
+00002c40: 2020 205d 290a 0a20 2020 2020 2020 2023     ])..        #
+00002c50: 2074 6869 7320 7769 6c6c 2066 6972 6520   this will fire 
+00002c60: 6d6f 7265 2062 6163 6b65 6e64 2063 616c  more backend cal
+00002c70: 6c73 0a20 2020 2020 2020 2077 6974 6820  ls.        with 
+00002c80: 7365 6c66 2e68 6172 6e65 7373 2e5f 6576  self.harness._ev
+00002c90: 656e 745f 636f 6e74 6578 7428 2766 6f6f  ent_context('foo
+00002ca0: 5f65 7665 6e74 2729 3a0a 2020 2020 2020  _event'):.      
+00002cb0: 2020 2020 2020 6461 7461 5f72 6570 7220        data_repr 
+00002cc0: 3d20 7265 7072 2872 656c 5f64 6231 2e64  = repr(rel_db1.d
+00002cd0: 6174 6129 0a20 2020 2020 2020 2073 656c  ata).        sel
+00002ce0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00002cf0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00002d00: 7265 7072 2c0a 2020 2020 2020 2020 2020  repr,.          
+00002d10: 2020 2827 7b3c 6f70 732e 6d6f 6465 6c2e    ('{<ops.model.
+00002d20: 556e 6974 206d 7961 7070 2f30 3e3a 207b  Unit myapp/0>: {
+00002d30: 7d2c 2027 0a20 2020 2020 2020 2020 2020  }, '.           
+00002d40: 2020 273c 6f70 732e 6d6f 6465 6c2e 4170    '<ops.model.Ap
+00002d50: 706c 6963 6174 696f 6e20 6d79 6170 703e  plication myapp>
+00002d60: 3a20 3c6e 2f61 3e2c 2027 0a20 2020 2020  : <n/a>, '.     
+00002d70: 2020 2020 2020 2020 223c 6f70 732e 6d6f          "<ops.mo
+00002d80: 6465 6c2e 556e 6974 2072 656d 6f74 6561  del.Unit remotea
+00002d90: 7070 312f 303e 3a20 7b27 686f 7374 273a  pp1/0>: {'host':
+00002da0: 2027 7265 6d6f 7465 6170 7031 2f30 277d   'remoteapp1/0'}
+00002db0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+00002dc0: 2022 3c6f 7073 2e6d 6f64 656c 2e41 7070   "<ops.model.App
+00002dd0: 6c69 6361 7469 6f6e 2072 656d 6f74 6561  lication remotea
+00002de0: 7070 313e 3a20 7b27 7365 6372 6574 273a  pp1>: {'secret':
+00002df0: 2027 6361 6665 6465 6164 6265 6566 277d   'cafedeadbeef'}
+00002e00: 7d22 2929 0a0a 2020 2020 6465 6620 7465  }"))..    def te
+00002e10: 7374 5f72 656c 6174 696f 6e5f 6461 7461  st_relation_data
+00002e20: 5f6d 6f64 6966 795f 6f75 7228 7365 6c66  _modify_our(self
+00002e30: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
+00002e40: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
+00002e50: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00002e60: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
+00002e70: 6561 7070 3127 290a 0a20 2020 2020 2020  eapp1')..       
+00002e80: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
+00002e90: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00002ea0: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
+00002eb0: 276d 7961 7070 2f30 272c 207b 2768 6f73  'myapp/0', {'hos
+00002ec0: 7427 3a20 276e 6f74 6869 6e67 277d 290a  t': 'nothing'}).
+00002ed0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+00002ee0: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
+00002ef0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00002f00: 6c66 2e68 6172 6e65 7373 2e5f 6576 656e  lf.harness._even
+00002f10: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
+00002f20: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
+00002f30: 2020 2020 7265 6c5f 6462 3120 3d20 7365      rel_db1 = se
+00002f40: 6c66 2e6d 6f64 656c 2e67 6574 5f72 656c  lf.model.get_rel
+00002f50: 6174 696f 6e28 2764 6231 2729 0a20 2020  ation('db1').   
+00002f60: 2020 2020 2020 2020 2023 2075 7064 6174           # updat
+00002f70: 655f 7265 6c61 7469 6f6e 5f64 6174 6120  e_relation_data 
+00002f80: 7769 6c6c 2061 6c73 6f20 7472 6967 6765  will also trigge
+00002f90: 7220 7265 6c61 7469 6f6e 2d67 6574 2c20  r relation-get, 
+00002fa0: 736f 2077 650a 2020 2020 2020 2020 2020  so we.          
+00002fb0: 2020 2320 696e 7661 6c69 6461 7465 2074    # invalidate t
+00002fc0: 6865 2063 6163 6865 2074 6f20 656e 7375  he cache to ensu
+00002fd0: 7265 2069 7420 7769 6c6c 2062 6520 7265  re it will be re
+00002fe0: 6c6f 6164 6564 0a20 2020 2020 2020 2020  loaded.         
+00002ff0: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
+00003000: 7365 6c66 2e6d 6f64 656c 2e75 6e69 745d  self.model.unit]
+00003010: 2e5f 696e 7661 6c69 6461 7465 2829 0a20  ._invalidate(). 
+00003020: 2020 2020 2020 2020 2020 2023 2046 6f72             # For
+00003030: 6365 206d 656d 6f72 7920 6361 6368 6520  ce memory cache 
+00003040: 746f 2062 6520 6c6f 6164 6564 2e0a 2020  to be loaded..  
+00003050: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00003060: 7373 6572 7449 6e28 2768 6f73 7427 2c20  ssertIn('host', 
+00003070: 7265 6c5f 6462 312e 6461 7461 5b73 656c  rel_db1.data[sel
+00003080: 662e 6d6f 6465 6c2e 756e 6974 5d29 0a20  f.model.unit]). 
+00003090: 2020 2020 2020 2020 2020 2072 656c 5f64             rel_d
+000030a0: 6231 2e64 6174 615b 7365 6c66 2e6d 6f64  b1.data[self.mod
+000030b0: 656c 2e75 6e69 745d 5b27 686f 7374 275d  el.unit]['host']
+000030c0: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
+000030d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000030e0: 4571 7561 6c28 7265 6c5f 6462 312e 6461  Equal(rel_db1.da
+000030f0: 7461 5b73 656c 662e 6d6f 6465 6c2e 756e  ta[self.model.un
+00003100: 6974 5d5b 2768 6f73 7427 5d2c 2027 6261  it]['host'], 'ba
+00003110: 7227 290a 0a20 2020 2020 2020 2073 656c  r')..        sel
+00003120: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+00003130: 616c 6c73 285b 0a20 2020 2020 2020 2020  alls([.         
+00003140: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+00003150: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+00003160: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
+00003170: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00003180: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+00003190: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+000031a0: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+000031b0: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
+000031c0: 6261 7227 292c 0a20 2020 2020 2020 205d  bar'),.        ]
+000031d0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000031e0: 6170 705f 7265 6c61 7469 6f6e 5f64 6174  app_relation_dat
+000031f0: 615f 6d6f 6469 6679 5f6c 6f63 616c 5f61  a_modify_local_a
+00003200: 735f 6c65 6164 6572 2873 656c 6629 3a0a  s_leader(self):.
+00003210: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
+00003220: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
+00003230: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00003240: 2764 6231 272c 2027 7265 6d6f 7465 6170  'db1', 'remoteap
+00003250: 7031 2729 0a20 2020 2020 2020 2073 656c  p1').        sel
+00003260: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
+00003270: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00003280: 656c 6174 696f 6e5f 6964 2c20 276d 7961  elation_id, 'mya
+00003290: 7070 272c 207b 2770 6173 7377 6f72 6427  pp', {'password'
+000032a0: 3a20 2764 6561 6462 6565 6663 6166 6527  : 'deadbeefcafe'
+000032b0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+000032c0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+000032d0: 7469 6f6e 5f75 6e69 7428 7265 6c61 7469  tion_unit(relati
+000032e0: 6f6e 5f69 642c 2027 7265 6d6f 7465 6170  on_id, 'remoteap
+000032f0: 7031 2f30 2729 0a20 2020 2020 2020 2073  p1/0').        s
+00003300: 656c 662e 6861 726e 6573 732e 7365 745f  elf.harness.set_
+00003310: 6c65 6164 6572 2854 7275 6529 0a20 2020  leader(True).   
+00003320: 2020 2020 2073 656c 662e 7265 7365 7442       self.resetB
+00003330: 6163 6b65 6e64 4361 6c6c 7328 290a 0a20  ackendCalls().. 
+00003340: 2020 2020 2020 206c 6f63 616c 5f61 7070         local_app
+00003350: 203d 2073 656c 662e 6d6f 6465 6c2e 756e   = self.model.un
+00003360: 6974 2e61 7070 0a0a 2020 2020 2020 2020  it.app..        
+00003370: 7265 6c5f 6462 3120 3d20 7365 6c66 2e6d  rel_db1 = self.m
+00003380: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
+00003390: 6e28 2764 6231 2729 0a20 2020 2020 2020  n('db1').       
+000033a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000033b0: 6c28 7265 6c5f 6462 312e 6461 7461 5b6c  l(rel_db1.data[l
+000033c0: 6f63 616c 5f61 7070 5d2c 207b 2770 6173  ocal_app], {'pas
+000033d0: 7377 6f72 6427 3a20 2764 6561 6462 6565  sword': 'deadbee
+000033e0: 6663 6166 6527 7d29 0a0a 2020 2020 2020  fcafe'})..      
+000033f0: 2020 7265 6c5f 6462 312e 6461 7461 5b6c    rel_db1.data[l
+00003400: 6f63 616c 5f61 7070 5d5b 2770 6173 7377  ocal_app]['passw
+00003410: 6f72 6427 5d20 3d20 2766 6f6f 270a 0a20  ord'] = 'foo'.. 
+00003420: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00003430: 7274 4571 7561 6c28 7265 6c5f 6462 312e  rtEqual(rel_db1.
+00003440: 6461 7461 5b6c 6f63 616c 5f61 7070 5d5b  data[local_app][
+00003450: 2770 6173 7377 6f72 6427 5d2c 2027 666f  'password'], 'fo
+00003460: 6f27 290a 0a20 2020 2020 2020 2073 656c  o')..        sel
+00003470: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+00003480: 616c 6c73 280a 2020 2020 2020 2020 2020  alls(.          
+00003490: 2020 5b28 2772 656c 6174 696f 6e5f 6964    [('relation_id
+000034a0: 7327 2c20 2764 6231 2729 2c0a 2020 2020  s', 'db1'),.    
+000034b0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
+000034c0: 696f 6e5f 6c69 7374 272c 2031 292c 0a20  ion_list', 1),. 
+000034d0: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
+000034e0: 6c61 7469 6f6e 5f67 6574 272c 2031 2c20  lation_get', 1, 
+000034f0: 276d 7961 7070 272c 2054 7275 6529 2c0a  'myapp', True),.
+00003500: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
+00003510: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00003520: 6174 6127 2c20 312c 2073 656c 662e 6d6f  ata', 1, self.mo
+00003530: 6465 6c2e 6170 702c 2027 7061 7373 776f  del.app, 'passwo
+00003540: 7264 272c 2027 666f 6f27 295d 290a 0a20  rd', 'foo')]).. 
+00003550: 2020 2064 6566 2074 6573 745f 6170 705f     def test_app_
+00003560: 7265 6c61 7469 6f6e 5f64 6174 615f 6d6f  relation_data_mo
+00003570: 6469 6679 5f6c 6f63 616c 5f61 735f 6d69  dify_local_as_mi
+00003580: 6e69 6f6e 2873 656c 6629 3a0a 2020 2020  nion(self):.    
+00003590: 2020 2020 7265 6c61 7469 6f6e 5f69 6420      relation_id 
+000035a0: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
+000035b0: 6464 5f72 656c 6174 696f 6e28 2764 6231  dd_relation('db1
+000035c0: 272c 2027 7265 6d6f 7465 6170 7031 2729  ', 'remoteapp1')
+000035d0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+000035e0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
+000035f0: 6174 696f 6e5f 6461 7461 2872 656c 6174  ation_data(relat
+00003600: 696f 6e5f 6964 2c20 276d 7961 7070 272c  ion_id, 'myapp',
+00003610: 207b 2770 6173 7377 6f72 6427 3a20 2764   {'password': 'd
+00003620: 6561 6462 6565 6663 6166 6527 7d29 0a20  eadbeefcafe'}). 
+00003630: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+00003640: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00003650: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
+00003660: 642c 2027 7265 6d6f 7465 6170 7031 2f30  d, 'remoteapp1/0
+00003670: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00003680: 6861 726e 6573 732e 7365 745f 6c65 6164  harness.set_lead
+00003690: 6572 2846 616c 7365 290a 2020 2020 2020  er(False).      
+000036a0: 2020 7365 6c66 2e72 6573 6574 4261 636b    self.resetBack
+000036b0: 656e 6443 616c 6c73 2829 0a0a 2020 2020  endCalls()..    
+000036c0: 2020 2020 6c6f 6361 6c5f 6170 7020 3d20      local_app = 
+000036d0: 7365 6c66 2e6d 6f64 656c 2e75 6e69 742e  self.model.unit.
+000036e0: 6170 700a 0a20 2020 2020 2020 2072 656c  app..        rel
+000036f0: 5f64 6231 203d 2073 656c 662e 6d6f 6465  _db1 = self.mode
+00003700: 6c2e 6765 745f 7265 6c61 7469 6f6e 2827  l.get_relation('
+00003710: 6462 3127 290a 2020 2020 2020 2020 7365  db1').        se
+00003720: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+00003730: 656c 5f64 6231 2e64 6174 615b 6c6f 6361  el_db1.data[loca
+00003740: 6c5f 6170 705d 2c20 7b27 7061 7373 776f  l_app], {'passwo
+00003750: 7264 273a 2027 6465 6164 6265 6566 6361  rd': 'deadbeefca
+00003760: 6665 277d 290a 0a20 2020 2020 2020 2077  fe'})..        w
+00003770: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+00003780: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
+00003790: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
+000037a0: 2020 2020 2020 2020 2020 2320 6966 2077            # if w
+000037b0: 6520 7765 7265 2069 6e73 6964 6520 616e  e were inside an
+000037c0: 2065 7665 6e74 2063 6f6e 7465 7874 2c20   event context, 
+000037d0: 7765 2764 2067 6574 3a0a 2020 2020 2020  we'd get:.      
+000037e0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000037f0: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00003800: 2e52 656c 6174 696f 6e44 6174 6145 7272  .RelationDataErr
+00003810: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00003820: 2020 2020 2072 656c 5f64 6231 2e64 6174       rel_db1.dat
+00003830: 615b 6c6f 6361 6c5f 6170 705d 5b27 7061  a[local_app]['pa
+00003840: 7373 776f 7264 275d 203d 2027 666f 6f62  ssword'] = 'foob
+00003850: 6172 270a 0a20 2020 2020 2020 2073 656c  ar'..        sel
+00003860: 662e 6173 7365 7274 4261 636b 656e 6443  f.assertBackendC
+00003870: 616c 6c73 285b 2827 7265 6c61 7469 6f6e  alls([('relation
+00003880: 5f69 6473 272c 2027 6462 3127 292c 0a20  _ids', 'db1'),. 
+00003890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038b0: 2827 7265 6c61 7469 6f6e 5f6c 6973 7427  ('relation_list'
+000038c0: 2c20 3129 2c0a 2020 2020 2020 2020 2020  , 1),.          
+000038d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038e0: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+000038f0: 6e5f 6765 7427 2c20 312c 2027 6d79 6170  n_get', 1, 'myap
+00003900: 7027 2c20 5472 7565 292c 0a20 2020 2020  p', True),.     
+00003910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003920: 2020 2020 2020 2020 2020 2020 2827 6973              ('is
+00003930: 5f6c 6561 6465 7227 2c29 5d29 0a0a 2020  _leader',)])..  
+00003940: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
+00003950: 696f 6e5f 6461 7461 5f61 6363 6573 735f  ion_data_access_
+00003960: 7065 6572 5f6c 6561 6465 7228 7365 6c66  peer_leader(self
+00003970: 293a 0a20 2020 2020 2020 2072 5f69 6420  ):.        r_id 
+00003980: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
+00003990: 6464 5f72 656c 6174 696f 6e28 2764 6232  dd_relation('db2
+000039a0: 272c 2027 6d79 6170 7027 290a 2020 2020  ', 'myapp').    
+000039b0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+000039c0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+000039d0: 6974 2872 5f69 642c 2027 6d79 6170 702f  it(r_id, 'myapp/
+000039e0: 3127 2920 2023 2070 6565 7221 0a20 2020  1')  # peer!.   
+000039f0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00003a00: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00003a10: 6e5f 6461 7461 2872 5f69 642c 2027 6d79  n_data(r_id, 'my
+00003a20: 6170 7027 2c20 7b27 666f 6f27 3a20 2762  app', {'foo': 'b
+00003a30: 6172 277d 290a 2020 2020 2020 2020 7769  ar'}).        wi
+00003a40: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
+00003a50: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+00003a60: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
+00003a70: 2020 2020 2020 2020 2023 206c 6561 6465           # leade
+00003a80: 7273 2063 616e 2072 6561 640a 2020 2020  rs can read.    
+00003a90: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+00003aa0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
+00003ab0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00003ac0: 2020 7265 6c61 7469 6f6e 203d 2073 656c    relation = sel
+00003ad0: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
+00003ae0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00003af0: 3227 290a 2020 2020 2020 2020 2020 2020  2').            
+00003b00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00003b10: 2872 656c 6174 696f 6e2e 6461 7461 5b72  (relation.data[r
+00003b20: 656c 6174 696f 6e2e 6170 705d 5b27 666f  elation.app]['fo
+00003b30: 6f27 5d2c 2027 6261 7227 290a 0a20 2020  o'], 'bar')..   
+00003b40: 2064 6566 2074 6573 745f 7265 6c61 7469   def test_relati
+00003b50: 6f6e 5f64 6174 615f 6163 6365 7373 5f70  on_data_access_p
+00003b60: 6565 725f 6d69 6e69 6f6e 2873 656c 6629  eer_minion(self)
+00003b70: 3a0a 2020 2020 2020 2020 725f 6964 203d  :.        r_id =
+00003b80: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00003b90: 645f 7265 6c61 7469 6f6e 2827 6462 3227  d_relation('db2'
+00003ba0: 2c20 276d 7961 7070 2729 0a20 2020 2020  , 'myapp').     
+00003bb0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00003bc0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00003bd0: 7428 725f 6964 2c20 276d 7961 7070 2f31  t(r_id, 'myapp/1
+00003be0: 2729 2020 2320 7065 6572 210a 2020 2020  ')  # peer!.    
+00003bf0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00003c00: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+00003c10: 5f64 6174 6128 725f 6964 2c20 276d 7961  _data(r_id, 'mya
+00003c20: 7070 272c 207b 2766 6f6f 273a 2027 6261  pp', {'foo': 'ba
+00003c30: 7227 7d29 0a20 2020 2020 2020 2077 6974  r'}).        wit
+00003c40: 6820 7365 6c66 2e68 6172 6e65 7373 2e5f  h self.harness._
+00003c50: 6576 656e 745f 636f 6e74 6578 7428 2766  event_context('f
+00003c60: 6f6f 5f65 7665 6e74 2729 3a0a 2020 2020  oo_event'):.    
+00003c70: 2020 2020 2020 2020 2320 6e6f 6e6c 6561          # nonlea
+00003c80: 6465 7273 2063 616e 2072 6561 640a 2020  ders can read.  
+00003c90: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+00003ca0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+00003cb0: 7228 4661 6c73 6529 0a20 2020 2020 2020  r(False).       
+00003cc0: 2020 2020 2072 656c 6174 696f 6e20 3d20       relation = 
+00003cd0: 7365 6c66 2e68 6172 6e65 7373 2e6d 6f64  self.harness.mod
+00003ce0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
+00003cf0: 2764 6232 2729 0a20 2020 2020 2020 2020  'db2').         
+00003d00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00003d10: 7561 6c28 7265 6c61 7469 6f6e 2e64 6174  ual(relation.dat
+00003d20: 615b 7265 6c61 7469 6f6e 2e61 7070 5d5b  a[relation.app][
+00003d30: 2766 6f6f 275d 2c20 2762 6172 2729 0a0a  'foo'], 'bar')..
+00003d40: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+00003d50: 6174 696f 6e5f 6461 7461 5f64 656c 5f6b  ation_data_del_k
+00003d60: 6579 2873 656c 6629 3a0a 2020 2020 2020  ey(self):.      
+00003d70: 2020 7265 6c61 7469 6f6e 5f69 6420 3d20    relation_id = 
+00003d80: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00003d90: 5f72 656c 6174 696f 6e28 2764 6231 272c  _relation('db1',
+00003da0: 2027 7265 6d6f 7465 6170 7031 2729 0a20   'remoteapp1'). 
+00003db0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00003dc0: 2e68 6172 6e65 7373 2e5f 6576 656e 745f  .harness._event_
+00003dd0: 636f 6e74 6578 7428 2766 6f6f 5f65 7665  context('foo_eve
+00003de0: 6e74 2729 3a0a 2020 2020 2020 2020 2020  nt'):.          
+00003df0: 2020 7365 6c66 2e68 6172 6e65 7373 2e75    self.harness.u
+00003e00: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00003e10: 6174 6128 7265 6c61 7469 6f6e 5f69 642c  ata(relation_id,
+00003e20: 2027 6d79 6170 702f 3027 2c20 7b27 686f   'myapp/0', {'ho
+00003e30: 7374 273a 2027 6261 7227 7d29 0a20 2020  st': 'bar'}).   
+00003e40: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00003e50: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+00003e60: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
+00003e70: 2027 7265 6d6f 7465 6170 7031 2f30 2729   'remoteapp1/0')
+00003e80: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00003e90: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
+00003ea0: 290a 0a20 2020 2020 2020 2072 656c 5f64  )..        rel_d
+00003eb0: 6231 203d 2073 656c 662e 6d6f 6465 6c2e  b1 = self.model.
+00003ec0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00003ed0: 3127 290a 2020 2020 2020 2020 2320 466f  1').        # Fo
+00003ee0: 7263 6520 6d65 6d6f 7279 2063 6163 6865  rce memory cache
+00003ef0: 2074 6f20 6265 206c 6f61 6465 642e 0a20   to be loaded.. 
+00003f00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00003f10: 7274 496e 2827 686f 7374 272c 2072 656c  rtIn('host', rel
+00003f20: 5f64 6231 2e64 6174 615b 7365 6c66 2e6d  _db1.data[self.m
+00003f30: 6f64 656c 2e75 6e69 745d 290a 2020 2020  odel.unit]).    
+00003f40: 2020 2020 6465 6c20 7265 6c5f 6462 312e      del rel_db1.
+00003f50: 6461 7461 5b73 656c 662e 6d6f 6465 6c2e  data[self.model.
+00003f60: 756e 6974 5d5b 2768 6f73 7427 5d0a 2020  unit]['host'].  
+00003f70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00003f80: 744e 6f74 496e 2827 686f 7374 272c 2072  tNotIn('host', r
+00003f90: 656c 5f64 6231 2e64 6174 615b 7365 6c66  el_db1.data[self
+00003fa0: 2e6d 6f64 656c 2e75 6e69 745d 290a 2020  .model.unit]).  
+00003fb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00003fc0: 7445 7175 616c 287b 7d2c 2073 656c 662e  tEqual({}, self.
+00003fd0: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
+00003fe0: 7469 6f6e 5f64 6174 6128 7265 6c61 7469  tion_data(relati
+00003ff0: 6f6e 5f69 642c 2027 6d79 6170 702f 3027  on_id, 'myapp/0'
+00004000: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+00004010: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00004020: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
+00004030: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
+00004040: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
+00004050: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00004060: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
+00004070: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
+00004080: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+00004090: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+000040a0: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
+000040b0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+000040c0: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+000040d0: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+000040e0: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+000040f0: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
+00004100: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+00004110: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+00004120: 6174 696f 6e5f 6461 7461 5f64 656c 5f6d  ation_data_del_m
+00004130: 6973 7369 6e67 5f6b 6579 2873 656c 6629  issing_key(self)
+00004140: 3a0a 2020 2020 2020 2020 7265 6c61 7469  :.        relati
+00004150: 6f6e 5f69 6420 3d20 7365 6c66 2e68 6172  on_id = self.har
+00004160: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00004170: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
+00004180: 6170 7031 2729 0a20 2020 2020 2020 2077  app1').        w
+00004190: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+000041a0: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
+000041b0: 2766 6f6f 5f65 7665 6e74 2729 3a0a 2020  'foo_event'):.  
+000041c0: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+000041d0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+000041e0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
+000041f0: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
+00004200: 3027 2c20 7b27 686f 7374 273a 2027 6261  0', {'host': 'ba
+00004210: 7227 7d29 0a20 2020 2020 2020 2073 656c  r'}).        sel
+00004220: 662e 6861 726e 6573 732e 6164 645f 7265  f.harness.add_re
+00004230: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c61  lation_unit(rela
+00004240: 7469 6f6e 5f69 642c 2027 7265 6d6f 7465  tion_id, 'remote
+00004250: 6170 7031 2f30 2729 0a20 2020 2020 2020  app1/0').       
+00004260: 2073 656c 662e 7265 7365 7442 6163 6b65   self.resetBacke
+00004270: 6e64 4361 6c6c 7328 290a 0a20 2020 2020  ndCalls()..     
+00004280: 2020 2072 656c 5f64 6231 203d 2073 656c     rel_db1 = sel
+00004290: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+000042a0: 7469 6f6e 2827 6462 3127 290a 2020 2020  tion('db1').    
+000042b0: 2020 2020 2320 466f 7263 6520 6d65 6d6f      # Force memo
+000042c0: 7279 2063 6163 6865 2074 6f20 6265 206c  ry cache to be l
+000042d0: 6f61 6465 642e 0a20 2020 2020 2020 2073  oaded..        s
+000042e0: 656c 662e 6173 7365 7274 496e 2827 686f  elf.assertIn('ho
+000042f0: 7374 272c 2072 656c 5f64 6231 2e64 6174  st', rel_db1.dat
+00004300: 615b 7365 6c66 2e6d 6f64 656c 2e75 6e69  a[self.model.uni
+00004310: 745d 290a 2020 2020 2020 2020 7769 7468  t]).        with
+00004320: 2073 656c 662e 6861 726e 6573 732e 5f65   self.harness._e
+00004330: 7665 6e74 5f63 6f6e 7465 7874 2827 666f  vent_context('fo
+00004340: 6f5f 6576 656e 7427 293a 0a20 2020 2020  o_event'):.     
+00004350: 2020 2020 2020 2072 656c 5f64 6231 2e64         rel_db1.d
+00004360: 6174 615b 7365 6c66 2e6d 6f64 656c 2e75  ata[self.model.u
+00004370: 6e69 745d 5b27 706f 7274 275d 203d 2027  nit]['port'] = '
+00004380: 2720 2020 2320 5361 6d65 2061 7320 6120  '   # Same as a 
+00004390: 6465 6c65 7465 2c20 7368 6f75 6c64 206e  delete, should n
+000043a0: 6f74 2066 6169 6c2e 0a20 2020 2020 2020  ot fail..       
+000043b0: 2073 656c 662e 6173 7365 7274 4e6f 7449   self.assertNotI
+000043c0: 6e28 2770 6f72 7427 2c20 7265 6c5f 6462  n('port', rel_db
+000043d0: 312e 6461 7461 5b73 656c 662e 6d6f 6465  1.data[self.mode
+000043e0: 6c2e 756e 6974 5d29 0a20 2020 2020 2020  l.unit]).       
+000043f0: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
+00004400: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
+00004410: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
+00004420: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00004430: 2e61 7373 6572 7445 7175 616c 287b 2768  .assertEqual({'h
+00004440: 6f73 7427 3a20 2762 6172 277d 2c0a 2020  ost': 'bar'},.  
+00004450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004460: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00004470: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
+00004480: 7469 6f6e 5f64 6174 6128 7265 6c61 7469  tion_data(relati
+00004490: 6f6e 5f69 642c 2027 6d79 6170 702f 3027  on_id, 'myapp/0'
+000044a0: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+000044b0: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+000044c0: 6c6c 7328 5b0a 2020 2020 2020 2020 2020  lls([.          
+000044d0: 2020 2827 7265 6c61 7469 6f6e 5f69 6473    ('relation_ids
+000044e0: 272c 2027 6462 3127 292c 0a20 2020 2020  ', 'db1'),.     
+000044f0: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00004500: 6e5f 6c69 7374 272c 2072 656c 6174 696f  n_list', relatio
+00004510: 6e5f 6964 292c 0a20 2020 2020 2020 2020  n_id),.         
+00004520: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
+00004530: 7427 2c20 7265 6c61 7469 6f6e 5f69 642c  t', relation_id,
+00004540: 2027 6d79 6170 702f 3027 2c20 4661 6c73   'myapp/0', Fals
+00004550: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00004560: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+00004570: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+00004580: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+00004590: 2e75 6e69 742c 2027 706f 7274 272c 2027  .unit, 'port', '
+000045a0: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+000045b0: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+000045c0: 6174 696f 6e5f 7365 745f 6661 696c 2873  ation_set_fail(s
+000045d0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+000045e0: 6c61 7469 6f6e 5f69 6420 3d20 7365 6c66  lation_id = self
+000045f0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+00004600: 6174 696f 6e28 2764 6231 272c 2027 7265  ation('db1', 're
+00004610: 6d6f 7465 6170 7031 2729 0a20 2020 2020  moteapp1').     
+00004620: 2020 2077 6974 6820 7365 6c66 2e68 6172     with self.har
+00004630: 6e65 7373 2e5f 6576 656e 745f 636f 6e74  ness._event_cont
+00004640: 6578 7428 2766 6f6f 5f65 7665 6e74 2729  ext('foo_event')
+00004650: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00004660: 6c66 2e68 6172 6e65 7373 2e75 7064 6174  lf.harness.updat
+00004670: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+00004680: 7265 6c61 7469 6f6e 5f69 642c 2027 6d79  relation_id, 'my
+00004690: 6170 702f 3027 2c20 7b27 686f 7374 273a  app/0', {'host':
+000046a0: 2027 6d79 6170 702d 3027 7d29 0a20 2020   'myapp-0'}).   
+000046b0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+000046c0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+000046d0: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
+000046e0: 2027 7265 6d6f 7465 6170 7031 2f30 2729   'remoteapp1/0')
+000046f0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00004700: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
+00004710: 290a 0a20 2020 2020 2020 2062 6163 6b65  )..        backe
+00004720: 6e64 203d 2073 656c 662e 6861 726e 6573  nd = self.harnes
+00004730: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
+00004740: 2020 2023 2054 4f44 4f3a 206a 616d 2032     # TODO: jam 2
+00004750: 3032 302d 3033 2d30 3620 5468 6973 2069  020-03-06 This i
+00004760: 7320 7761 7920 746f 6f20 6d75 6368 2069  s way too much i
+00004770: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+00004780: 2072 656c 6174 696f 6e5f 7365 740a 2020   relation_set.  
+00004790: 2020 2020 2020 2320 2020 2020 2020 5468        #       Th
+000047a0: 6520 6f72 6967 696e 616c 2074 6573 7420  e original test 
+000047b0: 666f 7263 6564 2027 7265 6c61 7469 6f6e  forced 'relation
+000047c0: 2d73 6574 2720 746f 2072 6574 7572 6e20  -set' to return 
+000047d0: 6578 6974 2063 6f64 6520 322c 0a20 2020  exit code 2,.   
+000047e0: 2020 2020 2023 2020 2020 2020 2062 7574       #       but
+000047f0: 2074 6865 7265 2077 6173 206e 6f74 6869   there was nothi
+00004800: 6e67 2069 6c6c 6567 616c 2061 626f 7574  ng illegal about
+00004810: 2074 6865 2064 6174 6120 7468 6174 2077   the data that w
+00004820: 6173 2062 6569 6e67 2073 6574 2c0a 2020  as being set,.  
+00004830: 2020 2020 2020 2320 2020 2020 2020 666f        #       fo
+00004840: 7220 7573 2074 6f20 7072 6f70 6572 6c79  r us to properly
+00004850: 2074 6573 7420 7468 6520 7369 6465 2065   test the side e
+00004860: 6666 6563 7473 206f 6620 7265 6c61 7469  ffects of relati
+00004870: 6f6e 2d73 6574 2066 6169 6c69 6e67 2e0a  on-set failing..
+00004880: 0a20 2020 2020 2020 2064 6566 2062 726f  .        def bro
+00004890: 6b65 6e5f 7570 6461 7465 5f72 656c 6174  ken_update_relat
+000048a0: 696f 6e5f 6461 7461 2872 656c 6174 696f  ion_data(relatio
+000048b0: 6e5f 6964 2c20 656e 7469 7479 2c20 6b65  n_id, entity, ke
+000048c0: 792c 2076 616c 7565 293a 0a20 2020 2020  y, value):.     
+000048d0: 2020 2020 2020 2062 6163 6b65 6e64 2e5f         backend._
+000048e0: 6361 6c6c 732e 6170 7065 6e64 2828 2775  calls.append(('u
+000048f0: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00004900: 6174 6127 2c20 7265 6c61 7469 6f6e 5f69  ata', relation_i
+00004910: 642c 2065 6e74 6974 792c 206b 6579 2c20  d, entity, key, 
+00004920: 7661 6c75 6529 290a 2020 2020 2020 2020  value)).        
+00004930: 2020 2020 7261 6973 6520 6f70 732e 4d6f      raise ops.Mo
+00004940: 6465 6c45 7272 6f72 2829 0a20 2020 2020  delError().     
+00004950: 2020 2062 6163 6b65 6e64 2e75 7064 6174     backend.updat
+00004960: 655f 7265 6c61 7469 6f6e 5f64 6174 6120  e_relation_data 
+00004970: 3d20 6272 6f6b 656e 5f75 7064 6174 655f  = broken_update_
+00004980: 7265 6c61 7469 6f6e 5f64 6174 610a 0a20  relation_data.. 
+00004990: 2020 2020 2020 2072 656c 5f64 6231 203d         rel_db1 =
+000049a0: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+000049b0: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
+000049c0: 2020 2020 2020 2020 2320 466f 7263 6520          # Force 
+000049d0: 6d65 6d6f 7279 2063 6163 6865 2074 6f20  memory cache to 
+000049e0: 6265 206c 6f61 6465 642e 0a20 2020 2020  be loaded..     
+000049f0: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
+00004a00: 2827 686f 7374 272c 2072 656c 5f64 6231  ('host', rel_db1
+00004a10: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
+00004a20: 2e75 6e69 745d 290a 0a20 2020 2020 2020  .unit])..       
+00004a30: 2077 6974 6820 7365 6c66 2e68 6172 6e65   with self.harne
+00004a40: 7373 2e5f 6576 656e 745f 636f 6e74 6578  ss._event_contex
+00004a50: 7428 2766 6f6f 5f65 7665 6e74 2729 3a0a  t('foo_event'):.
+00004a60: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00004a70: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00004a80: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+00004a90: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00004aa0: 2020 2020 7265 6c5f 6462 312e 6461 7461      rel_db1.data
+00004ab0: 5b73 656c 662e 6d6f 6465 6c2e 756e 6974  [self.model.unit
+00004ac0: 5d5b 2768 6f73 7427 5d20 3d20 2762 6172  ]['host'] = 'bar
+00004ad0: 270a 2020 2020 2020 2020 2020 2020 7365  '.            se
+00004ae0: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+00004af0: 656c 5f64 6231 2e64 6174 615b 7365 6c66  el_db1.data[self
+00004b00: 2e6d 6f64 656c 2e75 6e69 745d 5b27 686f  .model.unit]['ho
+00004b10: 7374 275d 2c20 276d 7961 7070 2d30 2729  st'], 'myapp-0')
+00004b20: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00004b30: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00004b40: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+00004b50: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00004b60: 2020 2020 2064 656c 2072 656c 5f64 6231       del rel_db1
+00004b70: 2e64 6174 615b 7365 6c66 2e6d 6f64 656c  .data[self.model
+00004b80: 2e75 6e69 745d 5b27 686f 7374 275d 0a20  .unit]['host']. 
+00004b90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00004ba0: 6173 7365 7274 496e 2827 686f 7374 272c  assertIn('host',
+00004bb0: 2072 656c 5f64 6231 2e64 6174 615b 7365   rel_db1.data[se
+00004bc0: 6c66 2e6d 6f64 656c 2e75 6e69 745d 290a  lf.model.unit]).
+00004bd0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00004be0: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
+00004bf0: 285b 0a20 2020 2020 2020 2020 2020 2028  ([.            (
+00004c00: 2772 656c 6174 696f 6e5f 6964 7327 2c20  'relation_ids', 
+00004c10: 2764 6231 2729 2c0a 2020 2020 2020 2020  'db1'),.        
+00004c20: 2020 2020 2827 7265 6c61 7469 6f6e 5f6c      ('relation_l
+00004c30: 6973 7427 2c20 7265 6c61 7469 6f6e 5f69  ist', relation_i
+00004c40: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+00004c50: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
+00004c60: 2072 656c 6174 696f 6e5f 6964 2c20 276d   relation_id, 'm
+00004c70: 7961 7070 2f30 272c 2046 616c 7365 292c  yapp/0', False),
+00004c80: 0a20 2020 2020 2020 2020 2020 2028 2775  .            ('u
+00004c90: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00004ca0: 6174 6127 2c20 7265 6c61 7469 6f6e 5f69  ata', relation_i
+00004cb0: 642c 2073 656c 662e 6d6f 6465 6c2e 756e  d, self.model.un
+00004cc0: 6974 2c20 2768 6f73 7427 2c20 2762 6172  it, 'host', 'bar
+00004cd0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00004ce0: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
+00004cf0: 6e5f 6461 7461 272c 2072 656c 6174 696f  n_data', relatio
+00004d00: 6e5f 6964 2c20 7365 6c66 2e6d 6f64 656c  n_id, self.model
+00004d10: 2e75 6e69 742c 2027 686f 7374 272c 2027  .unit, 'host', '
+00004d20: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
+00004d30: 2020 2020 6465 6620 7465 7374 5f72 656c      def test_rel
+00004d40: 6174 696f 6e5f 6461 7461 5f74 7970 655f  ation_data_type_
+00004d50: 6368 6563 6b28 7365 6c66 293a 0a20 2020  check(self):.   
+00004d60: 2020 2020 2072 656c 6174 696f 6e5f 6964       relation_id
+00004d70: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
+00004d80: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+00004d90: 3127 2c20 2772 656d 6f74 6561 7070 3127  1', 'remoteapp1'
+00004da0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
+00004db0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+00004dc0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c61  lation_data(rela
+00004dd0: 7469 6f6e 5f69 642c 2027 6d79 6170 702f  tion_id, 'myapp/
+00004de0: 3027 2c20 7b27 686f 7374 273a 2027 6d79  0', {'host': 'my
+00004df0: 6170 702d 3027 7d29 0a20 2020 2020 2020  app-0'}).       
+00004e00: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+00004e10: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+00004e20: 7265 6c61 7469 6f6e 5f69 642c 2027 7265  relation_id, 're
+00004e30: 6d6f 7465 6170 7031 2f30 2729 0a20 2020  moteapp1/0').   
+00004e40: 2020 2020 2073 656c 662e 7265 7365 7442       self.resetB
+00004e50: 6163 6b65 6e64 4361 6c6c 7328 290a 0a20  ackendCalls().. 
+00004e60: 2020 2020 2020 2072 656c 5f64 6231 203d         rel_db1 =
+00004e70: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+00004e80: 7265 6c61 7469 6f6e 2827 6462 3127 290a  relation('db1').
+00004e90: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
+00004ea0: 2076 616c 7565 2069 6e20 280a 2020 2020   value in (.    
+00004eb0: 2020 2020 2020 2020 2020 2020 2827 666f              ('fo
+00004ec0: 6f27 2c20 3129 2c0a 2020 2020 2020 2020  o', 1),.        
+00004ed0: 2020 2020 2020 2020 2827 666f 6f27 2c20          ('foo', 
+00004ee0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+00004ef0: 2020 2020 2020 2028 2766 6f6f 272c 207b         ('foo', {
+00004f00: 2766 6f6f 273a 2027 6261 7227 7d29 2c0a  'foo': 'bar'}),.
+00004f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f20: 2831 2c20 2766 6f6f 2729 2c0a 2020 2020  (1, 'foo'),.    
+00004f30: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
+00004f40: 652c 2027 666f 6f27 292c 0a20 2020 2020  e, 'foo'),.     
+00004f50: 2020 2020 2020 2020 2020 2028 2827 666f             (('fo
+00004f60: 6f27 2c20 2762 6172 2729 2c20 2766 6f6f  o', 'bar'), 'foo
+00004f70: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00004f80: 2020 2020 2831 2c20 3129 2c0a 2020 2020      (1, 1),.    
+00004f90: 2020 2020 2020 2020 2020 2020 284e 6f6e              (Non
+00004fa0: 652c 204e 6f6e 6529 0a20 2020 2020 2020  e, None).       
+00004fb0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00004fc0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00004fd0: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+00004fe0: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
+00004ff0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00005000: 6974 6820 7365 6c66 2e68 6172 6e65 7373  ith self.harness
+00005010: 2e66 7261 6d65 776f 726b 2e5f 6576 656e  .framework._even
+00005020: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
+00005030: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
+00005040: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
+00005050: 6462 312e 6461 7461 5b73 656c 662e 6d6f  db1.data[self.mo
+00005060: 6465 6c2e 756e 6974 5d5b 6b65 795d 203d  del.unit][key] =
+00005070: 2076 616c 7565 0a0a 2020 2020 2020 2020   value..        
+00005080: 2320 4e6f 2064 6174 6120 6861 7320 6163  # No data has ac
+00005090: 7475 616c 6c79 2062 6565 6e20 6368 616e  tually been chan
+000050a0: 6765 640a 2020 2020 2020 2020 7365 6c66  ged.        self
+000050b0: 2e61 7373 6572 7445 7175 616c 2864 6963  .assertEqual(dic
+000050c0: 7428 7265 6c5f 6462 312e 6461 7461 5b73  t(rel_db1.data[s
+000050d0: 656c 662e 6d6f 6465 6c2e 756e 6974 5d29  elf.model.unit])
+000050e0: 2c20 7b27 686f 7374 273a 2027 6d79 6170  , {'host': 'myap
+000050f0: 702d 3027 7d29 0a0a 2020 2020 2020 2020  p-0'})..        
+00005100: 7365 6c66 2e61 7373 6572 7442 6163 6b65  self.assertBacke
+00005110: 6e64 4361 6c6c 7328 5b0a 2020 2020 2020  ndCalls([.      
+00005120: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
+00005130: 5f69 6473 272c 2027 6462 3127 292c 0a20  _ids', 'db1'),. 
+00005140: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
+00005150: 6174 696f 6e5f 6c69 7374 272c 2072 656c  ation_list', rel
+00005160: 6174 696f 6e5f 6964 292c 0a20 2020 2020  ation_id),.     
+00005170: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00005180: 6e5f 6765 7427 2c20 7265 6c61 7469 6f6e  n_get', relation
+00005190: 5f69 642c 2027 6d79 6170 702f 3027 2c20  _id, 'myapp/0', 
+000051a0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+000051b0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+000051c0: 5f72 656c 6174 696f 6e5f 6c6f 6361 6c5f  _relation_local_
+000051d0: 6170 705f 6461 7461 5f72 6561 6461 6269  app_data_readabi
+000051e0: 6c69 7479 5f6c 6561 6465 7228 7365 6c66  lity_leader(self
+000051f0: 293a 0a20 2020 2020 2020 2072 656c 6174  ):.        relat
+00005200: 696f 6e5f 6964 203d 2073 656c 662e 6861  ion_id = self.ha
+00005210: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00005220: 6f6e 2827 6462 3127 2c20 2772 656d 6f74  on('db1', 'remot
+00005230: 6561 7070 3127 290a 2020 2020 2020 2020  eapp1').        
+00005240: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
+00005250: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+00005260: 6128 7265 6c61 7469 6f6e 5f69 642c 2027  a(relation_id, '
+00005270: 7265 6d6f 7465 6170 7031 272c 0a20 2020  remoteapp1',.   
+00005280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052a0: 2020 2020 2020 207b 2773 6563 7265 7427         {'secret'
+000052b0: 3a20 2763 6166 6564 6561 6462 6565 6627  : 'cafedeadbeef'
+000052c0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+000052d0: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
+000052e0: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
+000052f0: 6174 696f 6e5f 6964 2c20 276d 7961 7070  ation_id, 'myapp
+00005300: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00005310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005320: 2020 2020 2020 2020 2020 2020 207b 276c               {'l
+00005330: 6f63 616c 273a 2027 6461 7461 277d 290a  ocal': 'data'}).
+00005340: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+00005350: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00005360: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
+00005370: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
+00005380: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
+00005390: 662e 6861 726e 6573 732e 7570 6461 7465  f.harness.update
+000053a0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+000053b0: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+000053c0: 6f74 6561 7070 312f 3027 2c0a 2020 2020  oteapp1/0',.    
+000053d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053f0: 2020 2020 2020 7b27 686f 7374 273a 2027        {'host': '
+00005400: 7265 6d6f 7465 6170 7031 2f30 277d 290a  remoteapp1/0'}).
+00005410: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
+00005420: 656c 2e72 656c 6174 696f 6e73 2e5f 696e  el.relations._in
+00005430: 7661 6c69 6461 7465 2827 6462 3127 290a  validate('db1').
+00005440: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+00005450: 6574 4261 636b 656e 6443 616c 6c73 2829  etBackendCalls()
+00005460: 0a0a 2020 2020 2020 2020 7265 6c5f 6462  ..        rel_db
+00005470: 3120 3d20 7365 6c66 2e6d 6f64 656c 2e67  1 = self.model.g
+00005480: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+00005490: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000054a0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+000054b0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+000054c0: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
+000054d0: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
+000054e0: 6c66 2e72 6573 6574 4261 636b 656e 6443  lf.resetBackendC
+000054f0: 616c 6c73 2829 0a0a 2020 2020 2020 2020  alls()..        
+00005500: 6c6f 6361 6c5f 6170 7020 3d20 7365 6c66  local_app = self
+00005510: 2e68 6172 6e65 7373 2e63 6861 726d 2e61  .harness.charm.a
+00005520: 7070 0a20 2020 2020 2020 2073 656c 662e  pp.        self.
+00005530: 7265 7365 7442 6163 6b65 6e64 4361 6c6c  resetBackendCall
+00005540: 7328 290a 0a20 2020 2020 2020 2023 2061  s()..        # a
+00005550: 6464 7265 7373 696e 6720 7468 6520 6f62  ddressing the ob
+00005560: 6a65 6374 2069 7320 4f4b 0a20 2020 2020  ject is OK.     
+00005570: 2020 2072 656c 5f64 6231 2e64 6174 615b     rel_db1.data[
+00005580: 6c6f 6361 6c5f 6170 705d 0a0a 2020 2020  local_app]..    
+00005590: 2020 2020 7365 6c66 2e61 7373 6572 7442      self.assertB
+000055a0: 6163 6b65 6e64 4361 6c6c 7328 5b5d 290a  ackendCalls([]).
+000055b0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+000055c0: 6c66 2e68 6172 6e65 7373 2e5f 6576 656e  lf.harness._even
+000055d0: 745f 636f 6e74 6578 7428 2766 6f6f 5f65  t_context('foo_e
+000055e0: 7665 6e74 2729 3a0a 2020 2020 2020 2020  vent'):.        
+000055f0: 2020 2020 7365 6c66 2e72 6573 6574 4261      self.resetBa
+00005600: 636b 656e 6443 616c 6c73 2829 0a0a 2020  ckendCalls()..  
+00005610: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00005620: 7373 6572 7445 7175 616c 2872 656c 5f64  ssertEqual(rel_d
+00005630: 6231 2e64 6174 615b 6c6f 6361 6c5f 6170  b1.data[local_ap
+00005640: 705d 5b27 6c6f 6361 6c27 5d2c 2027 6461  p]['local'], 'da
+00005650: 7461 2729 0a0a 2020 2020 2020 2020 2020  ta')..          
+00005660: 2020 7365 6c66 2e61 7373 6572 7442 6163    self.assertBac
+00005670: 6b65 6e64 4361 6c6c 7328 5b28 2769 735f  kendCalls([('is_
+00005680: 6c65 6164 6572 272c 292c 0a20 2020 2020  leader',),.     
+00005690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056b0: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
+000056c0: 2031 2c20 276d 7961 7070 272c 2054 7275   1, 'myapp', Tru
+000056d0: 6529 5d29 0a0a 2020 2020 2020 2020 2020  e)])..          
+000056e0: 2020 7365 6c66 2e72 6573 6574 4261 636b    self.resetBack
+000056f0: 656e 6443 616c 6c73 2829 0a0a 2020 2020  endCalls()..    
+00005700: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00005710: 6572 7445 7175 616c 2872 6570 7228 7265  ertEqual(repr(re
+00005720: 6c5f 6462 312e 6461 7461 5b6c 6f63 616c  l_db1.data[local
+00005730: 5f61 7070 5d29 2c20 7265 7072 287b 276c  _app]), repr({'l
+00005740: 6f63 616c 273a 2027 6461 7461 277d 2929  ocal': 'data'}))
+00005750: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00005760: 7765 2064 6f6e 2774 2067 6574 2074 6865  we don't get the
+00005770: 2064 6174 612c 2062 6563 6175 7365 2077   data, because w
+00005780: 6527 7265 206c 617a 790a 2020 2020 2020  e're lazy.      
+00005790: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000057a0: 7442 6163 6b65 6e64 4361 6c6c 7328 5b28  tBackendCalls([(
+000057b0: 2769 735f 6c65 6164 6572 272c 295d 290a  'is_leader',)]).
+000057c0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+000057d0: 7320 7765 6c6c 2061 7320 7265 6c61 7469  s well as relati
+000057e0: 6f6e 2064 6174 6120 7265 7072 2829 2069  on data repr() i
+000057f0: 6e20 6765 6e65 7261 6c3a 0a20 2020 2020  n general:.     
+00005800: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00005810: 7274 4973 496e 7374 616e 6365 2872 6570  rtIsInstance(rep
+00005820: 7228 7265 6c5f 6462 312e 6461 7461 292c  r(rel_db1.data),
+00005830: 2073 7472 290a 0a20 2020 2064 6566 2074   str)..    def t
+00005840: 6573 745f 7265 6c61 7469 6f6e 5f6c 6f63  est_relation_loc
+00005850: 616c 5f61 7070 5f64 6174 615f 7265 6164  al_app_data_read
+00005860: 6162 696c 6974 795f 666f 6c6c 6f77 6572  ability_follower
+00005870: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00005880: 7265 6c61 7469 6f6e 5f69 6420 3d20 7365  relation_id = se
+00005890: 6c66 2e68 6172 6e65 7373 2e61 6464 5f72  lf.harness.add_r
+000058a0: 656c 6174 696f 6e28 2764 6231 272c 2027  elation('db1', '
+000058b0: 7265 6d6f 7465 6170 7031 2729 0a20 2020  remoteapp1').   
+000058c0: 2020 2020 2077 6974 6820 7365 6c66 2e68       with self.h
+000058d0: 6172 6e65 7373 2e5f 6576 656e 745f 636f  arness._event_co
+000058e0: 6e74 6578 7428 2766 6f6f 5f65 7665 6e74  ntext('foo_event
+000058f0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00005900: 7365 6c66 2e68 6172 6e65 7373 2e75 7064  self.harness.upd
+00005910: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+00005920: 6128 7265 6c61 7469 6f6e 5f69 642c 2027  a(relation_id, '
+00005930: 7265 6d6f 7465 6170 7031 272c 0a20 2020  remoteapp1',.   
+00005940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005960: 2020 2020 2020 2020 2020 207b 2773 6563             {'sec
+00005970: 7265 7427 3a20 2763 6166 6564 6561 6462  ret': 'cafedeadb
+00005980: 6565 6627 7d29 0a20 2020 2020 2020 2020  eef'}).         
+00005990: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+000059a0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
+000059b0: 6461 7461 2872 656c 6174 696f 6e5f 6964  data(relation_id
+000059c0: 2c20 276d 7961 7070 272c 0a20 2020 2020  , 'myapp',.     
+000059d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000059e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000059f0: 2020 2020 2020 2020 207b 276c 6f63 616c           {'local
+00005a00: 273a 2027 6461 7461 277d 290a 0a20 2020  ': 'data'})..   
+00005a10: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+00005a20: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00005a30: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
+00005a40: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
+00005a50: 2f30 2729 0a20 2020 2020 2020 2020 2020  /0').           
+00005a60: 2073 656c 662e 6861 726e 6573 732e 7570   self.harness.up
+00005a70: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00005a80: 7461 2872 656c 6174 696f 6e5f 6964 2c20  ta(relation_id, 
+00005a90: 2772 656d 6f74 6561 7070 312f 3027 2c0a  'remoteapp1/0',.
+00005aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ac0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+00005ad0: 686f 7374 273a 2027 7265 6d6f 7465 6170  host': 'remoteap
+00005ae0: 7031 2f30 277d 290a 2020 2020 2020 2020  p1/0'}).        
+00005af0: 7365 6c66 2e6d 6f64 656c 2e72 656c 6174  self.model.relat
+00005b00: 696f 6e73 2e5f 696e 7661 6c69 6461 7465  ions._invalidate
+00005b10: 2827 6462 3127 290a 2020 2020 2020 2020  ('db1').        
+00005b20: 7365 6c66 2e72 6573 6574 4261 636b 656e  self.resetBacken
+00005b30: 6443 616c 6c73 2829 0a0a 2020 2020 2020  dCalls()..      
+00005b40: 2020 7265 6c5f 6462 3120 3d20 7365 6c66    rel_db1 = self
+00005b50: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
+00005b60: 696f 6e28 2764 6231 2729 0a20 2020 2020  ion('db1').     
+00005b70: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00005b80: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+00005b90: 7365 6c66 2e68 6172 6e65 7373 2e73 6574  self.harness.set
+00005ba0: 5f6c 6561 6465 7228 4661 6c73 6529 0a0a  _leader(False)..
+00005bb0: 2020 2020 2020 2020 6c6f 6361 6c5f 6170          local_ap
+00005bc0: 7020 3d20 7365 6c66 2e68 6172 6e65 7373  p = self.harness
+00005bd0: 2e63 6861 726d 2e61 7070 0a20 2020 2020  .charm.app.     
+00005be0: 2020 2023 2061 6464 7265 7373 696e 6720     # addressing 
+00005bf0: 7468 6520 6f62 6a65 6374 2069 7320 4f4b  the object is OK
+00005c00: 0a20 2020 2020 2020 2072 656c 5f64 6231  .        rel_db1
+00005c10: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
+00005c20: 0a20 2020 2020 2020 2023 206e 6f6e 6c65  .        # nonle
+00005c30: 6164 6572 2075 6e69 7473 2063 616e 6e6f  ader units canno
+00005c40: 7420 7265 6164 2074 6865 6972 206c 6f63  t read their loc
+00005c50: 616c 2061 7070 2064 6174 6162 6167 0a20  al app databag. 
+00005c60: 2020 2020 2020 2023 2061 7474 656d 7074         # attempt
+00005c70: 696e 6720 746f 2072 6561 6420 6974 2069  ing to read it i
+00005c80: 7320 6e6f 740a 2020 2020 2020 2020 7769  s not.        wi
+00005c90: 7468 2073 656c 662e 6861 726e 6573 732e  th self.harness.
+00005ca0: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+00005cb0: 666f 6f5f 6576 656e 7427 293a 0a20 2020  foo_event'):.   
+00005cc0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+00005cd0: 7365 7442 6163 6b65 6e64 4361 6c6c 7328  setBackendCalls(
+00005ce0: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
+00005cf0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00005d00: 6169 7365 7328 6f70 732e 5265 6c61 7469  aises(ops.Relati
+00005d10: 6f6e 4461 7461 4572 726f 7229 3a0a 2020  onDataError):.  
+00005d20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00005d30: 276c 6f63 616c 2720 6973 2074 6865 7265  'local' is there
+00005d40: 2c20 6275 7420 7374 696c 6c3a 0a20 2020  , but still:.   
+00005d50: 2020 2020 2020 2020 2020 2020 2072 656c               rel
+00005d60: 5f64 6231 2e64 6174 615b 6c6f 6361 6c5f  _db1.data[local_
+00005d70: 6170 705d 5b27 6c6f 6361 6c27 5d0a 0a20  app]['local'].. 
+00005d80: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
+00005d90: 6469 646e 2774 2065 7665 6e20 6765 7420  didn't even get 
+00005da0: 746f 2072 656c 6174 696f 6e2d 6765 740a  to relation-get.
+00005db0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005dc0: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00005dd0: 6c6c 7328 5b28 2769 735f 6c65 6164 6572  lls([('is_leader
+00005de0: 272c 2029 5d29 0a0a 2020 2020 2020 2020  ', )])..        
+00005df0: 2020 2020 2320 7765 2063 616e 2774 2073      # we can't s
+00005e00: 6565 2069 7420 6275 7420 7265 7072 2829  ee it but repr()
+00005e10: 2077 6f72 6b73 0a20 2020 2020 2020 2020   works.         
+00005e20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00005e30: 7561 6c28 7265 7072 2872 656c 5f64 6231  ual(repr(rel_db1
+00005e40: 2e64 6174 615b 6c6f 6361 6c5f 6170 705d  .data[local_app]
+00005e50: 292c 2027 3c6e 2f61 3e27 290a 2020 2020  ), '<n/a>').    
+00005e60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00005e70: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
+00005e80: 5b28 2769 735f 6c65 6164 6572 272c 2029  [('is_leader', )
+00005e90: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+00005ea0: 2320 6173 2077 656c 6c20 6173 2072 656c  # as well as rel
+00005eb0: 6174 696f 6e20 6461 7461 2072 6570 7228  ation data repr(
+00005ec0: 2920 696e 2067 656e 6572 616c 3a0a 2020  ) in general:.  
+00005ed0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00005ee0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+00005ef0: 7265 7072 2872 656c 5f64 6231 2e64 6174  repr(rel_db1.dat
+00005f00: 6129 2c20 7374 7229 0a0a 2020 2020 2020  a), str)..      
+00005f10: 2020 2020 2020 6578 7065 6374 6564 5f62        expected_b
+00005f20: 6163 6b65 6e64 5f63 616c 6c73 203d 205b  ackend_calls = [
+00005f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005f40: 2028 2772 656c 6174 696f 6e5f 6765 7427   ('relation_get'
+00005f50: 2c20 312c 2027 6d79 6170 702f 3027 2c20  , 1, 'myapp/0', 
+00005f60: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+00005f70: 2020 2020 2020 2020 2827 6973 5f6c 6561          ('is_lea
+00005f80: 6465 7227 2c29 2c0a 2020 2020 2020 2020  der',),.        
+00005f90: 2020 2020 2020 2020 2827 7265 6c61 7469          ('relati
+00005fa0: 6f6e 5f67 6574 272c 2031 2c20 2772 656d  on_get', 1, 'rem
+00005fb0: 6f74 6561 7070 312f 3027 2c20 4661 6c73  oteapp1/0', Fals
+00005fc0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00005fd0: 2020 2020 2827 6973 5f6c 6561 6465 7227      ('is_leader'
+00005fe0: 2c29 2c0a 2020 2020 2020 2020 2020 2020  ,),.            
+00005ff0: 2020 2020 2827 7265 6c61 7469 6f6e 5f67      ('relation_g
+00006000: 6574 272c 2031 2c20 2772 656d 6f74 6561  et', 1, 'remotea
+00006010: 7070 3127 2c20 5472 7565 295d 0a20 2020  pp1', True)].   
+00006020: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00006030: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
+00006040: 2865 7870 6563 7465 645f 6261 636b 656e  (expected_backen
+00006050: 645f 6361 6c6c 7329 0a0a 2020 2020 6465  d_calls)..    de
+00006060: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
+00006070: 6e6f 5f75 6e69 7473 2873 656c 6629 3a0a  no_units(self):.
+00006080: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+00006090: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+000060a0: 6e28 2764 6231 272c 2027 7265 6d6f 7465  n('db1', 'remote
+000060b0: 6170 7031 2729 0a20 2020 2020 2020 2072  app1').        r
+000060c0: 656c 203d 2073 656c 662e 6d6f 6465 6c2e  el = self.model.
+000060d0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+000060e0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+000060f0: 2e61 7373 6572 7445 7175 616c 2872 656c  .assertEqual(rel
+00006100: 2e75 6e69 7473 2c20 7365 7428 2929 0a20  .units, set()). 
+00006110: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006120: 7274 4973 2872 656c 2e61 7070 2c20 7365  rtIs(rel.app, se
+00006130: 6c66 2e6d 6f64 656c 2e67 6574 5f61 7070  lf.model.get_app
+00006140: 2827 7265 6d6f 7465 6170 7031 2729 290a  ('remoteapp1')).
+00006150: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00006160: 6572 7442 6163 6b65 6e64 4361 6c6c 7328  ertBackendCalls(
+00006170: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+00006180: 7265 6c61 7469 6f6e 5f69 6473 272c 2027  relation_ids', '
+00006190: 6462 3127 292c 0a20 2020 2020 2020 2020  db1'),.         
+000061a0: 2020 2028 2772 656c 6174 696f 6e5f 6c69     ('relation_li
+000061b0: 7374 272c 2031 292c 0a20 2020 2020 2020  st', 1),.       
+000061c0: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+000061d0: 7265 6d6f 7465 5f61 7070 5f6e 616d 6527  remote_app_name'
+000061e0: 2c20 3129 2c0a 2020 2020 2020 2020 5d29  , 1),.        ])
+000061f0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
+00006200: 6f6e 6669 6728 7365 6c66 293a 0a20 2020  onfig(self):.   
+00006210: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+00006220: 732e 5f67 6574 5f62 6163 6b65 6e64 5f63  s._get_backend_c
+00006230: 616c 6c73 2872 6573 6574 3d54 7275 6529  alls(reset=True)
+00006240: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+00006250: 726e 6573 732e 7570 6461 7465 5f63 6f6e  rness.update_con
+00006260: 6669 6728 7b27 666f 6f27 3a20 2766 6f6f  fig({'foo': 'foo
+00006270: 272c 2027 6261 7227 3a20 312c 2027 7175  ', 'bar': 1, 'qu
+00006280: 7827 3a20 5472 7565 7d29 0a20 2020 2020  x': True}).     
+00006290: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000062a0: 7561 6c28 7365 6c66 2e6d 6f64 656c 2e63  ual(self.model.c
+000062b0: 6f6e 6669 672c 207b 0a20 2020 2020 2020  onfig, {.       
+000062c0: 2020 2020 2027 666f 6f27 3a20 2766 6f6f       'foo': 'foo
+000062d0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000062e0: 6261 7227 3a20 312c 0a20 2020 2020 2020  bar': 1,.       
+000062f0: 2020 2020 2027 7175 7827 3a20 5472 7565       'qux': True
+00006300: 2c0a 2020 2020 2020 2020 7d29 0a20 2020  ,.        }).   
+00006310: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00006320: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+00006330: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00006340: 2020 2020 2320 436f 6e66 6972 6d20 7468      # Confirm th
+00006350: 6174 2077 6520 6361 6e6e 6f74 206d 6f64  at we cannot mod
+00006360: 6966 7920 636f 6e66 6967 2076 616c 7565  ify config value
+00006370: 732e 0a20 2020 2020 2020 2020 2020 2073  s..            s
+00006380: 656c 662e 6d6f 6465 6c2e 636f 6e66 6967  elf.model.config
+00006390: 5b27 666f 6f27 5d20 3d20 2762 6172 270a  ['foo'] = 'bar'.
+000063a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000063b0: 7365 7274 4261 636b 656e 6443 616c 6c73  sertBackendCalls
+000063c0: 285b 2827 636f 6e66 6967 5f67 6574 272c  ([('config_get',
+000063d0: 295d 290a 0a20 2020 2064 6566 2074 6573  )])..    def tes
+000063e0: 745f 636f 6e66 6967 5f69 6d6d 7574 6162  t_config_immutab
+000063f0: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
+00006400: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00006410: 7274 5261 6973 6573 2841 7474 7269 6275  rtRaises(Attribu
+00006420: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
+00006430: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
+00006440: 2e63 6f6e 6669 6720 3d20 7b7d 0a0a 2020  .config = {}..  
+00006450: 2020 6465 6620 7465 7374 5f69 735f 6c65    def test_is_le
+00006460: 6164 6572 2873 656c 6629 3a0a 2020 2020  ader(self):.    
+00006470: 2020 2020 7265 6c61 7469 6f6e 5f69 6420      relation_id 
+00006480: 3d20 7365 6c66 2e68 6172 6e65 7373 2e61  = self.harness.a
+00006490: 6464 5f72 656c 6174 696f 6e28 2764 6231  dd_relation('db1
+000064a0: 272c 2027 7265 6d6f 7465 6170 7031 2729  ', 'remoteapp1')
+000064b0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+000064c0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+000064d0: 6f6e 5f75 6e69 7428 7265 6c61 7469 6f6e  on_unit(relation
+000064e0: 5f69 642c 2027 7265 6d6f 7465 6170 7031  _id, 'remoteapp1
+000064f0: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
+00006500: 662e 6861 726e 6573 732e 7365 745f 6c65  f.harness.set_le
+00006510: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
+00006520: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+00006530: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00006540: 2020 2020 2064 6566 2063 6865 636b 5f72       def check_r
+00006550: 656d 6f74 655f 756e 6974 7328 293a 0a20  emote_units():. 
+00006560: 2020 2020 2020 2020 2020 2023 2043 616e             # Can
+00006570: 6e6f 7420 6465 7465 726d 696e 6520 6c65  not determine le
+00006580: 6164 6572 7368 6970 2066 6f72 2072 656d  adership for rem
+00006590: 6f74 6520 756e 6974 732e 0a20 2020 2020  ote units..     
+000065a0: 2020 2020 2020 2066 6f72 2075 2069 6e20         for u in 
+000065b0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+000065c0: 656c 6174 696f 6e28 2764 6231 2729 2e75  elation('db1').u
+000065d0: 6e69 7473 3a0a 2020 2020 2020 2020 2020  nits:.          
+000065e0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000065f0: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+00006600: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+00006610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006620: 752e 6973 5f6c 6561 6465 7228 290a 0a20  u.is_leader().. 
+00006630: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006640: 7274 5472 7565 2873 656c 662e 6d6f 6465  rtTrue(self.mode
+00006650: 6c2e 756e 6974 2e69 735f 6c65 6164 6572  l.unit.is_leader
+00006660: 2829 290a 0a20 2020 2020 2020 2063 6865  ())..        che
+00006670: 636b 5f72 656d 6f74 655f 756e 6974 7328  ck_remote_units(
+00006680: 290a 0a20 2020 2020 2020 2023 2043 7265  )..        # Cre
+00006690: 6174 6520 6120 6e65 7720 6d6f 6465 6c20  ate a new model 
+000066a0: 616e 6420 6261 636b 656e 6420 746f 2064  and backend to d
+000066b0: 726f 7020 6120 6361 6368 6564 2069 732d  rop a cached is-
+000066c0: 6c65 6164 6572 206f 7574 7075 742e 0a20  leader output.. 
+000066d0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+000066e0: 6573 732e 7365 745f 6c65 6164 6572 2846  ess.set_leader(F
+000066f0: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
+00006700: 6c66 2e61 7373 6572 7446 616c 7365 2873  lf.assertFalse(s
+00006710: 656c 662e 6d6f 6465 6c2e 756e 6974 2e69  elf.model.unit.i
+00006720: 735f 6c65 6164 6572 2829 290a 0a20 2020  s_leader())..   
+00006730: 2020 2020 2063 6865 636b 5f72 656d 6f74       check_remot
+00006740: 655f 756e 6974 7328 290a 0a20 2020 2020  e_units()..     
+00006750: 2020 2073 656c 662e 6173 7365 7274 4261     self.assertBa
+00006760: 636b 656e 6443 616c 6c73 285b 0a20 2020  ckendCalls([.   
+00006770: 2020 2020 2020 2020 2028 2769 735f 6c65           ('is_le
+00006780: 6164 6572 272c 292c 0a20 2020 2020 2020  ader',),.       
+00006790: 2020 2020 2028 2772 656c 6174 696f 6e5f       ('relation_
+000067a0: 6964 7327 2c20 2764 6231 2729 2c0a 2020  ids', 'db1'),.  
+000067b0: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
+000067c0: 7469 6f6e 5f6c 6973 7427 2c20 7265 6c61  tion_list', rela
+000067d0: 7469 6f6e 5f69 6429 2c0a 2020 2020 2020  tion_id),.      
+000067e0: 2020 2020 2020 2827 6973 5f6c 6561 6465        ('is_leade
+000067f0: 7227 2c29 2c0a 2020 2020 2020 2020 5d29  r',),.        ])
+00006800: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
+00006810: 6f72 6b6c 6f61 645f 7665 7273 696f 6e28  orkload_version(
+00006820: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00006830: 656c 662e 6d6f 6465 6c2e 756e 6974 2e73  elf.model.unit.s
+00006840: 6574 5f77 6f72 6b6c 6f61 645f 7665 7273  et_workload_vers
+00006850: 696f 6e28 2731 2e32 2e33 2729 0a20 2020  ion('1.2.3').   
+00006860: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00006870: 4261 636b 656e 6443 616c 6c73 285b 0a20  BackendCalls([. 
+00006880: 2020 2020 2020 2020 2020 2028 2761 7070             ('app
+00006890: 6c69 6361 7469 6f6e 5f76 6572 7369 6f6e  lication_version
+000068a0: 5f73 6574 272c 2027 312e 322e 3327 292c  _set', '1.2.3'),
+000068b0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+000068c0: 2064 6566 2074 6573 745f 776f 726b 6c6f   def test_worklo
+000068d0: 6164 5f76 6572 7369 6f6e 5f69 6e76 616c  ad_version_inval
+000068e0: 6964 2873 656c 6629 3a0a 2020 2020 2020  id(self):.      
+000068f0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00006900: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
+00006910: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+00006920: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+00006930: 6c2e 756e 6974 2e73 6574 5f77 6f72 6b6c  l.unit.set_workl
+00006940: 6f61 645f 7665 7273 696f 6e28 3529 0a20  oad_version(5). 
+00006950: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006960: 7274 4571 7561 6c28 7374 7228 636d 2e65  rtEqual(str(cm.e
+00006970: 7863 6570 7469 6f6e 292c 2022 776f 726b  xception), "work
+00006980: 6c6f 6164 2076 6572 7369 6f6e 206d 7573  load version mus
+00006990: 7420 6265 2061 2073 7472 2c20 6e6f 7420  t be a str, not 
+000069a0: 696e 743a 2035 2229 0a20 2020 2020 2020  int: 5").       
+000069b0: 2073 656c 662e 6173 7365 7274 4261 636b   self.assertBack
+000069c0: 656e 6443 616c 6c73 285b 5d29 0a0a 2020  endCalls([])..  
+000069d0: 2020 6465 6620 7465 7374 5f72 6573 6f75    def test_resou
+000069e0: 7263 6573 2873 656c 6629 3a0a 2020 2020  rces(self):.    
+000069f0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00006a00: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+00006a10: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+00006a20: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
+00006a30: 6e65 7373 2e6d 6f64 656c 2e72 6573 6f75  ness.model.resou
+00006a40: 7263 6573 2e66 6574 6368 2827 666f 6f27  rces.fetch('foo'
+00006a50: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00006a60: 6861 726e 6573 732e 6164 645f 7265 736f  harness.add_reso
+00006a70: 7572 6365 2827 666f 6f27 2c20 2766 6f6f  urce('foo', 'foo
+00006a80: 2063 6f6e 7465 6e74 735c 6e27 290a 2020   contents\n').  
+00006a90: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+00006aa0: 7373 2e61 6464 5f72 6573 6f75 7263 6528  ss.add_resource(
+00006ab0: 2762 6172 272c 2027 2729 0a0a 2020 2020  'bar', '')..    
+00006ac0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00006ad0: 7365 7274 5261 6973 6573 284e 616d 6545  sertRaises(NameE
+00006ae0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00006af0: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+00006b00: 6d6f 6465 6c2e 7265 736f 7572 6365 732e  model.resources.
+00006b10: 6665 7463 6828 2771 7578 2729 0a0a 2020  fetch('qux')..  
+00006b20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006b30: 7445 7175 616c 2873 656c 662e 6861 726e  tEqual(self.harn
+00006b40: 6573 732e 6d6f 6465 6c2e 7265 736f 7572  ess.model.resour
+00006b50: 6365 732e 6665 7463 6828 2766 6f6f 2729  ces.fetch('foo')
+00006b60: 2e6e 616d 652c 2027 666f 6f2e 7478 7427  .name, 'foo.txt'
+00006b70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006b80: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00006b90: 6861 726e 6573 732e 6d6f 6465 6c2e 7265  harness.model.re
+00006ba0: 736f 7572 6365 732e 6665 7463 6828 2762  sources.fetch('b
+00006bb0: 6172 2729 2e6e 616d 652c 2027 6261 722e  ar').name, 'bar.
+00006bc0: 7478 7427 290a 0a20 2020 2064 6566 2074  txt')..    def t
+00006bd0: 6573 745f 7265 736f 7572 6365 735f 696d  est_resources_im
+00006be0: 6d75 7461 626c 6528 7365 6c66 293a 0a20  mutable(self):. 
+00006bf0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00006c00: 2e61 7373 6572 7452 6169 7365 7328 4174  .assertRaises(At
+00006c10: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00006c20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00006c30: 6d6f 6465 6c2e 7265 736f 7572 6365 7320  model.resources 
+00006c40: 3d20 6f62 6a65 6374 2829 0a0a 2020 2020  = object()..    
+00006c50: 6465 6620 7465 7374 5f70 6f64 5f73 7065  def test_pod_spe
+00006c60: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
+00006c70: 2073 656c 662e 6861 726e 6573 732e 7365   self.harness.se
+00006c80: 745f 6c65 6164 6572 2854 7275 6529 0a20  t_leader(True). 
+00006c90: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+00006ca0: 6573 732e 6d6f 6465 6c2e 706f 642e 7365  ess.model.pod.se
+00006cb0: 745f 7370 6563 287b 2766 6f6f 273a 2027  t_spec({'foo': '
+00006cc0: 6261 7227 7d29 0a20 2020 2020 2020 2073  bar'}).        s
+00006cd0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006ce0: 7365 6c66 2e68 6172 6e65 7373 2e67 6574  self.harness.get
+00006cf0: 5f70 6f64 5f73 7065 6328 292c 2028 7b27  _pod_spec(), ({'
+00006d00: 666f 6f27 3a20 2762 6172 277d 2c20 4e6f  foo': 'bar'}, No
+00006d10: 6e65 2929 0a0a 2020 2020 2020 2020 7365  ne))..        se
+00006d20: 6c66 2e68 6172 6e65 7373 2e6d 6f64 656c  lf.harness.model
+00006d30: 2e70 6f64 2e73 6574 5f73 7065 6328 7b27  .pod.set_spec({'
+00006d40: 6261 7227 3a20 2766 6f6f 277d 2c20 7b27  bar': 'foo'}, {'
+00006d50: 7175 7827 3a20 2762 617a 277d 290a 2020  qux': 'baz'}).  
+00006d60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006d70: 7445 7175 616c 2873 656c 662e 6861 726e  tEqual(self.harn
+00006d80: 6573 732e 6765 745f 706f 645f 7370 6563  ess.get_pod_spec
+00006d90: 2829 2c20 287b 2762 6172 273a 2027 666f  (), ({'bar': 'fo
+00006da0: 6f27 7d2c 207b 2771 7578 273a 2027 6261  o'}, {'qux': 'ba
+00006db0: 7a27 7d29 290a 0a20 2020 2020 2020 2023  z'}))..        #
+00006dc0: 206e 6f20 6c65 6164 6572 202d 3e20 6e6f   no leader -> no
+00006dd0: 2073 6574 2070 6f64 2073 7065 630a 2020   set pod spec.  
+00006de0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+00006df0: 7373 2e73 6574 5f6c 6561 6465 7228 4661  ss.set_leader(Fa
+00006e00: 6c73 6529 0a20 2020 2020 2020 2077 6974  lse).        wit
+00006e10: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00006e20: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+00006e30: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00006e40: 2073 656c 662e 6861 726e 6573 732e 6d6f   self.harness.mo
+00006e50: 6465 6c2e 706f 642e 7365 745f 7370 6563  del.pod.set_spec
+00006e60: 287b 2766 6f6f 273a 2027 6261 7227 7d29  ({'foo': 'bar'})
+00006e70: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
+00006e80: 6f64 5f69 6d6d 7574 6162 6c65 2873 656c  od_immutable(sel
+00006e90: 6629 3a0a 2020 2020 2020 2020 7769 7468  f):.        with
+00006ea0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00006eb0: 6573 2841 7474 7269 6275 7465 4572 726f  es(AttributeErro
+00006ec0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00006ed0: 7365 6c66 2e6d 6f64 656c 2e70 6f64 203d  self.model.pod =
+00006ee0: 206f 626a 6563 7428 290a 0a20 2020 2064   object()..    d
+00006ef0: 6566 2074 6573 745f 6261 7365 5f73 7461  ef test_base_sta
+00006f00: 7475 735f 696e 7374 616e 6365 5f72 6169  tus_instance_rai
+00006f10: 7365 7328 7365 6c66 293a 0a20 2020 2020  ses(self):.     
+00006f20: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00006f30: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+00006f40: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00006f50: 2020 6f70 732e 5374 6174 7573 4261 7365    ops.StatusBase
+00006f60: 2827 7465 7374 2729 0a0a 2020 2020 2020  ('test')..      
+00006f70: 2020 636c 6173 7320 4e6f 4e61 6d65 5374    class NoNameSt
+00006f80: 6174 7573 286f 7073 2e53 7461 7475 7342  atus(ops.StatusB
+00006f90: 6173 6529 3a0a 2020 2020 2020 2020 2020  ase):.          
+00006fa0: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
+00006fb0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00006fc0: 5261 6973 6573 2841 7474 7269 6275 7465  Raises(Attribute
+00006fd0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00006fe0: 2020 2020 6f70 732e 5374 6174 7573 4261      ops.StatusBa
+00006ff0: 7365 2e72 6567 6973 7465 725f 7374 6174  se.register_stat
+00007000: 7573 284e 6f4e 616d 6553 7461 7475 7329  us(NoNameStatus)
+00007010: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00007020: 7461 7475 735f 7265 7072 2873 656c 6629  tatus_repr(self)
+00007030: 3a0a 2020 2020 2020 2020 7465 7374 5f63  :.        test_c
+00007040: 6173 6573 203d 207b 0a20 2020 2020 2020  ases = {.       
+00007050: 2020 2020 2022 4163 7469 7665 5374 6174       "ActiveStat
+00007060: 7573 2827 5365 6173 6865 6c6c 2729 223a  us('Seashell')":
+00007070: 206f 7073 2e41 6374 6976 6553 7461 7475   ops.ActiveStatu
+00007080: 7328 2753 6561 7368 656c 6c27 292c 0a20  s('Seashell'),. 
+00007090: 2020 2020 2020 2020 2020 2022 4d61 696e             "Main
+000070a0: 7465 6e61 6e63 6553 7461 7475 7328 2752  tenanceStatus('R
+000070b0: 6564 2729 223a 206f 7073 2e4d 6169 6e74  ed')": ops.Maint
+000070c0: 656e 616e 6365 5374 6174 7573 2827 5265  enanceStatus('Re
+000070d0: 6427 292c 0a20 2020 2020 2020 2020 2020  d'),.           
+000070e0: 2022 426c 6f63 6b65 6453 7461 7475 7328   "BlockedStatus(
+000070f0: 274d 6167 656e 7461 2729 223a 206f 7073  'Magenta')": ops
+00007100: 2e42 6c6f 636b 6564 5374 6174 7573 2827  .BlockedStatus('
+00007110: 4d61 6765 6e74 6127 292c 0a20 2020 2020  Magenta'),.     
+00007120: 2020 2020 2020 2022 5761 6974 696e 6753         "WaitingS
+00007130: 7461 7475 7328 2754 6869 7374 6c65 2729  tatus('Thistle')
+00007140: 223a 206f 7073 2e57 6169 7469 6e67 5374  ": ops.WaitingSt
+00007150: 6174 7573 2827 5468 6973 746c 6527 292c  atus('Thistle'),
+00007160: 0a20 2020 2020 2020 2020 2020 2027 556e  .            'Un
+00007170: 6b6e 6f77 6e53 7461 7475 7328 2927 3a20  knownStatus()': 
+00007180: 6f70 732e 556e 6b6e 6f77 6e53 7461 7475  ops.UnknownStatu
+00007190: 7328 292c 0a20 2020 2020 2020 207d 0a20  s(),.        }. 
+000071a0: 2020 2020 2020 2066 6f72 2065 7870 6563         for expec
+000071b0: 7465 642c 2073 7461 7475 7320 696e 2074  ted, status in t
+000071c0: 6573 745f 6361 7365 732e 6974 656d 7328  est_cases.items(
+000071d0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000071e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000071f0: 7265 7072 2873 7461 7475 7329 2c20 6578  repr(status), ex
+00007200: 7065 6374 6564 290a 0a20 2020 2064 6566  pected)..    def
+00007210: 2074 6573 745f 7374 6174 7573 5f65 7128   test_status_eq(
+00007220: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00007230: 7461 7475 735f 7479 7065 7320 3d20 5b0a  tatus_types = [.
+00007240: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
+00007250: 4163 7469 7665 5374 6174 7573 2c0a 2020  ActiveStatus,.  
+00007260: 2020 2020 2020 2020 2020 6f70 732e 4d61            ops.Ma
+00007270: 696e 7465 6e61 6e63 6553 7461 7475 732c  intenanceStatus,
+00007280: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
+00007290: 2e42 6c6f 636b 6564 5374 6174 7573 2c0a  .BlockedStatus,.
+000072a0: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
+000072b0: 5761 6974 696e 6753 7461 7475 732c 0a20  WaitingStatus,. 
+000072c0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+000072d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000072e0: 616c 286f 7073 2e55 6e6b 6e6f 776e 5374  al(ops.UnknownSt
+000072f0: 6174 7573 2829 2c20 6f70 732e 556e 6b6e  atus(), ops.Unkn
+00007300: 6f77 6e53 7461 7475 7328 2929 0a20 2020  ownStatus()).   
+00007310: 2020 2020 2066 6f72 2028 692c 2074 3129       for (i, t1)
+00007320: 2069 6e20 656e 756d 6572 6174 6528 7374   in enumerate(st
+00007330: 6174 7573 5f74 7970 6573 293a 0a20 2020  atus_types):.   
+00007340: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00007350: 7365 7274 4e6f 7445 7175 616c 2874 3128  sertNotEqual(t1(
+00007360: 2727 292c 206f 7073 2e55 6e6b 6e6f 776e  ''), ops.Unknown
+00007370: 5374 6174 7573 2829 290a 2020 2020 2020  Status()).      
+00007380: 2020 2020 2020 666f 7220 286a 2c20 7432        for (j, t2
+00007390: 2920 696e 2065 6e75 6d65 7261 7465 2873  ) in enumerate(s
+000073a0: 7461 7475 735f 7479 7065 7329 3a0a 2020  tatus_types):.  
+000073b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000073c0: 6c66 2e61 7373 6572 744e 6f74 4571 7561  lf.assertNotEqua
+000073d0: 6c28 7431 2827 6f6e 6527 292c 2074 3228  l(t1('one'), t2(
+000073e0: 2774 776f 2729 290a 2020 2020 2020 2020  'two')).        
+000073f0: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
+00007400: 6a3a 0a20 2020 2020 2020 2020 2020 2020  j:.             
+00007410: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007420: 7274 4571 7561 6c28 7431 2827 6f6e 6527  rtEqual(t1('one'
+00007430: 292c 2074 3228 276f 6e65 2729 290a 2020  ), t2('one')).  
+00007440: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00007450: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007460: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00007470: 6572 744e 6f74 4571 7561 6c28 7431 2827  ertNotEqual(t1('
+00007480: 6f6e 6527 292c 2074 3228 276f 6e65 2729  one'), t2('one')
+00007490: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000074a0: 6163 7469 7665 5f6d 6573 7361 6765 5f64  active_message_d
+000074b0: 6566 6175 6c74 2873 656c 6629 3a0a 2020  efault(self):.  
+000074c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000074d0: 7445 7175 616c 286f 7073 2e41 6374 6976  tEqual(ops.Activ
+000074e0: 6553 7461 7475 7328 292e 6d65 7373 6167  eStatus().messag
+000074f0: 652c 2027 2729 0a0a 2020 2020 6465 6620  e, '')..    def 
+00007500: 7465 7374 5f6c 6f63 616c 5f73 6574 5f76  test_local_set_v
+00007510: 616c 6964 5f75 6e69 745f 7374 6174 7573  alid_unit_status
+00007520: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00007530: 7365 6c66 2e68 6172 6e65 7373 2e5f 6765  self.harness._ge
+00007540: 745f 6261 636b 656e 645f 6361 6c6c 7328  t_backend_calls(
+00007550: 7265 7365 743d 5472 7565 290a 2020 2020  reset=True).    
+00007560: 2020 2020 7465 7374 5f63 6173 6573 203d      test_cases =
+00007570: 205b 280a 2020 2020 2020 2020 2020 2020   [(.            
+00007580: 2761 6374 6976 6527 2c0a 2020 2020 2020  'active',.      
+00007590: 2020 2020 2020 6f70 732e 4163 7469 7665        ops.Active
+000075a0: 5374 6174 7573 2827 4772 6565 6e27 292c  Status('Green'),
+000075b0: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
+000075c0: 7461 7475 735f 7365 7427 2c20 2761 6374  tatus_set', 'act
+000075d0: 6976 6527 2c20 2747 7265 656e 272c 207b  ive', 'Green', {
+000075e0: 2769 735f 6170 7027 3a20 4661 6c73 657d  'is_app': False}
+000075f0: 292c 0a20 2020 2020 2020 2029 2c20 280a  ),.        ), (.
+00007600: 2020 2020 2020 2020 2020 2020 276d 6169              'mai
+00007610: 6e74 656e 616e 6365 272c 0a20 2020 2020  ntenance',.     
+00007620: 2020 2020 2020 206f 7073 2e4d 6169 6e74         ops.Maint
+00007630: 656e 616e 6365 5374 6174 7573 2827 5965  enanceStatus('Ye
+00007640: 6c6c 6f77 2729 2c0a 2020 2020 2020 2020  llow'),.        
+00007650: 2020 2020 2827 7374 6174 7573 5f73 6574      ('status_set
+00007660: 272c 2027 6d61 696e 7465 6e61 6e63 6527  ', 'maintenance'
+00007670: 2c20 2759 656c 6c6f 7727 2c20 7b27 6973  , 'Yellow', {'is
+00007680: 5f61 7070 273a 2046 616c 7365 7d29 2c0a  _app': False}),.
+00007690: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
+000076a0: 2020 2020 2020 2020 2027 626c 6f63 6b65           'blocke
+000076b0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+000076c0: 6f70 732e 426c 6f63 6b65 6453 7461 7475  ops.BlockedStatu
+000076d0: 7328 2752 6564 2729 2c0a 2020 2020 2020  s('Red'),.      
+000076e0: 2020 2020 2020 2827 7374 6174 7573 5f73        ('status_s
+000076f0: 6574 272c 2027 626c 6f63 6b65 6427 2c20  et', 'blocked', 
+00007700: 2752 6564 272c 207b 2769 735f 6170 7027  'Red', {'is_app'
+00007710: 3a20 4661 6c73 657d 292c 0a20 2020 2020  : False}),.     
+00007720: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
+00007730: 2020 2020 2777 6169 7469 6e67 272c 0a20      'waiting',. 
+00007740: 2020 2020 2020 2020 2020 206f 7073 2e57             ops.W
+00007750: 6169 7469 6e67 5374 6174 7573 2827 5768  aitingStatus('Wh
+00007760: 6974 6527 292c 0a20 2020 2020 2020 2020  ite'),.         
+00007770: 2020 2028 2773 7461 7475 735f 7365 7427     ('status_set'
+00007780: 2c20 2777 6169 7469 6e67 272c 2027 5768  , 'waiting', 'Wh
+00007790: 6974 6527 2c20 7b27 6973 5f61 7070 273a  ite', {'is_app':
+000077a0: 2046 616c 7365 7d29 2c0a 2020 2020 2020   False}),.      
+000077b0: 2020 295d 0a0a 2020 2020 2020 2020 666f    )]..        fo
+000077c0: 7220 7465 7374 5f63 6173 652c 2074 6172  r test_case, tar
+000077d0: 6765 745f 7374 6174 7573 2c20 6261 636b  get_status, back
+000077e0: 656e 645f 6361 6c6c 2069 6e20 7465 7374  end_call in test
+000077f0: 5f63 6173 6573 3a0a 2020 2020 2020 2020  _cases:.        
+00007800: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
+00007810: 6254 6573 7428 7465 7374 5f63 6173 6529  bTest(test_case)
+00007820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007830: 2020 7365 6c66 2e6d 6f64 656c 2e75 6e69    self.model.uni
+00007840: 742e 7374 6174 7573 203d 2074 6172 6765  t.status = targe
+00007850: 745f 7374 6174 7573 0a20 2020 2020 2020  t_status.       
+00007860: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00007870: 7365 7274 4571 7561 6c28 7365 6c66 2e6d  sertEqual(self.m
+00007880: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
+00007890: 2c20 7461 7267 6574 5f73 7461 7475 7329  , target_status)
+000078a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000078b0: 2073 656c 662e 6d6f 6465 6c2e 756e 6974   self.model.unit
+000078c0: 2e5f 696e 7661 6c69 6461 7465 2829 0a20  ._invalidate(). 
+000078d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000078e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000078f0: 7365 6c66 2e6d 6f64 656c 2e75 6e69 742e  self.model.unit.
+00007900: 7374 6174 7573 2c20 7461 7267 6574 5f73  status, target_s
+00007910: 7461 7475 7329 0a20 2020 2020 2020 2020  tatus).         
+00007920: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007930: 7274 4261 636b 656e 6443 616c 6c73 285b  rtBackendCalls([
+00007940: 6261 636b 656e 645f 6361 6c6c 2c20 2827  backend_call, ('
+00007950: 7374 6174 7573 5f67 6574 272c 207b 2769  status_get', {'i
+00007960: 735f 6170 7027 3a20 4661 6c73 657d 295d  s_app': False})]
+00007970: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00007980: 6c6f 6361 6c5f 7365 745f 7661 6c69 645f  local_set_valid_
+00007990: 6170 705f 7374 6174 7573 2873 656c 6629  app_status(self)
+000079a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
+000079b0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+000079c0: 7228 5472 7565 290a 2020 2020 2020 2020  r(True).        
+000079d0: 7465 7374 5f63 6173 6573 203d 205b 280a  test_cases = [(.
+000079e0: 2020 2020 2020 2020 2020 2020 2761 6374              'act
+000079f0: 6976 6527 2c0a 2020 2020 2020 2020 2020  ive',.          
+00007a00: 2020 6f70 732e 4163 7469 7665 5374 6174    ops.ActiveStat
+00007a10: 7573 2827 4772 6565 6e27 292c 0a20 2020  us('Green'),.   
+00007a20: 2020 2020 2020 2020 2028 2773 7461 7475           ('statu
+00007a30: 735f 7365 7427 2c20 2761 6374 6976 6527  s_set', 'active'
+00007a40: 2c20 2747 7265 656e 272c 207b 2769 735f  , 'Green', {'is_
+00007a50: 6170 7027 3a20 5472 7565 7d29 2c0a 2020  app': True}),.  
+00007a60: 2020 2020 2020 292c 2028 0a20 2020 2020        ), (.     
+00007a70: 2020 2020 2020 2027 6d61 696e 7465 6e61         'maintena
+00007a80: 6e63 6527 2c0a 2020 2020 2020 2020 2020  nce',.          
+00007a90: 2020 6f70 732e 4d61 696e 7465 6e61 6e63    ops.Maintenanc
+00007aa0: 6553 7461 7475 7328 2759 656c 6c6f 7727  eStatus('Yellow'
+00007ab0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00007ac0: 2773 7461 7475 735f 7365 7427 2c20 276d  'status_set', 'm
+00007ad0: 6169 6e74 656e 616e 6365 272c 2027 5965  aintenance', 'Ye
+00007ae0: 6c6c 6f77 272c 207b 2769 735f 6170 7027  llow', {'is_app'
+00007af0: 3a20 5472 7565 7d29 2c0a 2020 2020 2020  : True}),.      
+00007b00: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
+00007b10: 2020 2027 626c 6f63 6b65 6427 2c0a 2020     'blocked',.  
+00007b20: 2020 2020 2020 2020 2020 6f70 732e 426c            ops.Bl
+00007b30: 6f63 6b65 6453 7461 7475 7328 2752 6564  ockedStatus('Red
+00007b40: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00007b50: 2827 7374 6174 7573 5f73 6574 272c 2027  ('status_set', '
+00007b60: 626c 6f63 6b65 6427 2c20 2752 6564 272c  blocked', 'Red',
+00007b70: 207b 2769 735f 6170 7027 3a20 5472 7565   {'is_app': True
+00007b80: 7d29 2c0a 2020 2020 2020 2020 292c 2028  }),.        ), (
+00007b90: 0a20 2020 2020 2020 2020 2020 2027 7761  .            'wa
+00007ba0: 6974 696e 6727 2c0a 2020 2020 2020 2020  iting',.        
+00007bb0: 2020 2020 6f70 732e 5761 6974 696e 6753      ops.WaitingS
+00007bc0: 7461 7475 7328 2757 6869 7465 2729 2c0a  tatus('White'),.
+00007bd0: 2020 2020 2020 2020 2020 2020 2827 7374              ('st
+00007be0: 6174 7573 5f73 6574 272c 2027 7761 6974  atus_set', 'wait
+00007bf0: 696e 6727 2c20 2757 6869 7465 272c 207b  ing', 'White', {
+00007c00: 2769 735f 6170 7027 3a20 5472 7565 7d29  'is_app': True})
+00007c10: 2c0a 2020 2020 2020 2020 295d 0a0a 2020  ,.        )]..  
+00007c20: 2020 2020 2020 666f 7220 7465 7374 5f63        for test_c
+00007c30: 6173 652c 2074 6172 6765 745f 7374 6174  ase, target_stat
+00007c40: 7573 2c20 6261 636b 656e 645f 6361 6c6c  us, backend_call
+00007c50: 2069 6e20 7465 7374 5f63 6173 6573 3a0a   in test_cases:.
+00007c60: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00007c70: 2073 656c 662e 7375 6254 6573 7428 7465   self.subTest(te
+00007c80: 7374 5f63 6173 6529 3a0a 2020 2020 2020  st_case):.      
+00007c90: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00007ca0: 6f64 656c 2e61 7070 2e73 7461 7475 7320  odel.app.status 
+00007cb0: 3d20 7461 7267 6574 5f73 7461 7475 730a  = target_status.
+00007cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00007ce0: 2873 656c 662e 6d6f 6465 6c2e 6170 702e  (self.model.app.
+00007cf0: 7374 6174 7573 2c20 7461 7267 6574 5f73  status, target_s
+00007d00: 7461 7475 7329 0a20 2020 2020 2020 2020  tatus).         
+00007d10: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+00007d20: 6c2e 6170 702e 5f69 6e76 616c 6964 6174  l.app._invalidat
+00007d30: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00007d40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007d50: 7175 616c 2873 656c 662e 6d6f 6465 6c2e  qual(self.model.
+00007d60: 6170 702e 7374 6174 7573 2c20 7461 7267  app.status, targ
+00007d70: 6574 5f73 7461 7475 7329 0a20 2020 2020  et_status).     
+00007d80: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00007d90: 7265 2069 7320 6120 6261 636b 656e 6420  re is a backend 
+00007da0: 6361 6c6c 2074 6f20 6368 6563 6b20 6966  call to check if
+00007db0: 2077 6520 6361 6e20 7365 7420 7468 6520   we can set the 
+00007dc0: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+00007dd0: 2020 2020 2020 2023 2061 6e64 2074 6865         # and the
+00007de0: 6e20 616e 6f74 6865 7220 6368 6563 6b20  n another check 
+00007df0: 6561 6368 2074 696d 6520 7765 2061 7373  each time we ass
+00007e00: 6572 7420 7468 6520 7374 6174 7573 2061  ert the status a
+00007e10: 626f 7665 0a20 2020 2020 2020 2020 2020  bove.           
+00007e20: 2020 2020 2065 7870 6563 7465 645f 6361       expected_ca
+00007e30: 6c6c 7320 3d20 5b0a 2020 2020 2020 2020  lls = [.        
+00007e40: 2020 2020 2020 2020 2020 2020 2827 6973              ('is
+00007e50: 5f6c 6561 6465 7227 2c29 2c20 6261 636b  _leader',), back
+00007e60: 656e 645f 6361 6c6c 2c0a 2020 2020 2020  end_call,.      
+00007e70: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+00007e80: 6973 5f6c 6561 6465 7227 2c29 2c0a 2020  is_leader',),.  
+00007e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ea0: 2020 2827 6973 5f6c 6561 6465 7227 2c29    ('is_leader',)
+00007eb0: 2c20 2827 7374 6174 7573 5f67 6574 272c  , ('status_get',
+00007ec0: 207b 2769 735f 6170 7027 3a20 5472 7565   {'is_app': True
+00007ed0: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00007ee0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00007ef0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007f00: 7442 6163 6b65 6e64 4361 6c6c 7328 6578  tBackendCalls(ex
+00007f10: 7065 6374 6564 5f63 616c 6c73 290a 0a20  pected_calls).. 
+00007f20: 2020 2064 6566 2074 6573 745f 7365 745f     def test_set_
+00007f30: 6170 705f 7374 6174 7573 5f6e 6f6e 5f6c  app_status_non_l
+00007f40: 6561 6465 725f 7261 6973 6573 2873 656c  eader_raises(sel
+00007f50: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00007f60: 2e68 6172 6e65 7373 2e73 6574 5f6c 6561  .harness.set_lea
+00007f70: 6465 7228 4661 6c73 6529 0a20 2020 2020  der(False).     
+00007f80: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00007f90: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+00007fa0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00007fb0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+00007fc0: 6170 702e 7374 6174 7573 0a0a 2020 2020  app.status..    
+00007fd0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00007fe0: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
+00007ff0: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+00008000: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
+00008010: 2e61 7070 2e73 7461 7475 7320 3d20 6f70  .app.status = op
+00008020: 732e 4163 7469 7665 5374 6174 7573 2829  s.ActiveStatus()
+00008030: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+00008040: 6574 5f75 6e69 745f 7374 6174 7573 5f69  et_unit_status_i
+00008050: 6e76 616c 6964 2873 656c 6629 3a0a 2020  nvalid(self):.  
+00008060: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00008070: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00008080: 2e49 6e76 616c 6964 5374 6174 7573 4572  .InvalidStatusEr
+00008090: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000080a0: 2020 7365 6c66 2e6d 6f64 656c 2e75 6e69    self.model.uni
+000080b0: 742e 7374 6174 7573 203d 2027 626c 6f63  t.status = 'bloc
+000080c0: 6b65 6427 0a0a 2020 2020 6465 6620 7465  ked'..    def te
+000080d0: 7374 5f73 6574 5f61 7070 5f73 7461 7475  st_set_app_statu
+000080e0: 735f 696e 7661 6c69 6428 7365 6c66 293a  s_invalid(self):
+000080f0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00008100: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00008110: 6f70 732e 496e 7661 6c69 6453 7461 7475  ops.InvalidStatu
+00008120: 7345 7272 6f72 293a 0a20 2020 2020 2020  sError):.       
+00008130: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+00008140: 6170 702e 7374 6174 7573 203d 2027 626c  app.status = 'bl
+00008150: 6f63 6b65 6427 0a0a 2020 2020 6465 6620  ocked'..    def 
+00008160: 7465 7374 5f72 656d 6f74 655f 756e 6974  test_remote_unit
+00008170: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
+00008180: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+00008190: 6964 203d 2073 656c 662e 6861 726e 6573  id = self.harnes
+000081a0: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+000081b0: 6462 3127 2c20 2772 656d 6f74 6561 7070  db1', 'remoteapp
+000081c0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+000081d0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+000081e0: 6174 696f 6e5f 756e 6974 2872 656c 6174  ation_unit(relat
+000081f0: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
+00008200: 7070 312f 3027 290a 2020 2020 2020 2020  pp1/0').        
+00008210: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00008220: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00008230: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+00008240: 6f74 6561 7070 312f 3127 290a 2020 2020  oteapp1/1').    
+00008250: 2020 2020 7265 6d6f 7465 5f75 6e69 7420      remote_unit 
+00008260: 3d20 6e65 7874 2866 696c 7465 7228 6c61  = next(filter(la
+00008270: 6d62 6461 2075 3a20 752e 6e61 6d65 203d  mbda u: u.name =
+00008280: 3d20 2772 656d 6f74 6561 7070 312f 3027  = 'remoteapp1/0'
+00008290: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000082a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082b0: 2020 2020 7365 6c66 2e6d 6f64 656c 2e67      self.model.g
+000082c0: 6574 5f72 656c 6174 696f 6e28 2764 6231  et_relation('db1
+000082d0: 2729 2e75 6e69 7473 2929 0a20 2020 2020  ').units)).     
+000082e0: 2020 2073 656c 662e 7265 7365 7442 6163     self.resetBac
+000082f0: 6b65 6e64 4361 6c6c 7328 290a 0a20 2020  kendCalls()..   
+00008300: 2020 2020 2023 2052 656d 6f74 6520 756e       # Remote un
+00008310: 6974 2073 7461 7475 7320 6973 2061 6c77  it status is alw
+00008320: 6179 7320 756e 6b6e 6f77 6e2e 0a20 2020  ays unknown..   
+00008330: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008340: 4571 7561 6c28 7265 6d6f 7465 5f75 6e69  Equal(remote_uni
+00008350: 742e 7374 6174 7573 2c20 6f70 732e 556e  t.status, ops.Un
+00008360: 6b6e 6f77 6e53 7461 7475 7328 2929 0a0a  knownStatus())..
+00008370: 2020 2020 2020 2020 7465 7374 5f73 7461          test_sta
+00008380: 7475 7365 7320 3d20 280a 2020 2020 2020  tuses = (.      
+00008390: 2020 2020 2020 6f70 732e 556e 6b6e 6f77        ops.Unknow
+000083a0: 6e53 7461 7475 7328 292c 0a20 2020 2020  nStatus(),.     
+000083b0: 2020 2020 2020 206f 7073 2e41 6374 6976         ops.Activ
+000083c0: 6553 7461 7475 7328 2747 7265 656e 2729  eStatus('Green')
+000083d0: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
+000083e0: 732e 4d61 696e 7465 6e61 6e63 6553 7461  s.MaintenanceSta
+000083f0: 7475 7328 2759 656c 6c6f 7727 292c 0a20  tus('Yellow'),. 
+00008400: 2020 2020 2020 2020 2020 206f 7073 2e42             ops.B
+00008410: 6c6f 636b 6564 5374 6174 7573 2827 5265  lockedStatus('Re
+00008420: 6427 292c 0a20 2020 2020 2020 2020 2020  d'),.           
+00008430: 206f 7073 2e57 6169 7469 6e67 5374 6174   ops.WaitingStat
+00008440: 7573 2827 5768 6974 6527 292c 0a20 2020  us('White'),.   
+00008450: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00008460: 666f 7220 7461 7267 6574 5f73 7461 7475  for target_statu
+00008470: 7320 696e 2074 6573 745f 7374 6174 7573  s in test_status
+00008480: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00008490: 7769 7468 2073 656c 662e 7375 6254 6573  with self.subTes
+000084a0: 7428 7461 7267 6574 5f73 7461 7475 732e  t(target_status.
+000084b0: 6e61 6d65 293a 0a20 2020 2020 2020 2020  name):.         
+000084c0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000084d0: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
+000084e0: 6e74 696d 6545 7272 6f72 293a 0a20 2020  ntimeError):.   
+000084f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008500: 2072 656d 6f74 655f 756e 6974 2e73 7461   remote_unit.sta
+00008510: 7475 7320 3d20 7461 7267 6574 5f73 7461  tus = target_sta
+00008520: 7475 730a 2020 2020 2020 2020 7365 6c66  tus.        self
+00008530: 2e61 7373 6572 7442 6163 6b65 6e64 4361  .assertBackendCa
+00008540: 6c6c 7328 5b5d 290a 0a20 2020 2064 6566  lls([])..    def
+00008550: 2074 6573 745f 7265 6d6f 7465 5f61 7070   test_remote_app
+00008560: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
+00008570: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+00008580: 6964 203d 2073 656c 662e 6861 726e 6573  id = self.harnes
+00008590: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+000085a0: 6462 3127 2c20 2772 656d 6f74 6561 7070  db1', 'remoteapp
+000085b0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+000085c0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+000085d0: 6174 696f 6e5f 756e 6974 2872 656c 6174  ation_unit(relat
+000085e0: 696f 6e5f 6964 2c20 2772 656d 6f74 6561  ion_id, 'remotea
+000085f0: 7070 312f 3027 290a 2020 2020 2020 2020  pp1/0').        
+00008600: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
+00008610: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00008620: 656c 6174 696f 6e5f 6964 2c20 2772 656d  elation_id, 'rem
+00008630: 6f74 6561 7070 312f 3127 290a 2020 2020  oteapp1/1').    
+00008640: 2020 2020 7265 6d6f 7465 6170 7031 203d      remoteapp1 =
+00008650: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+00008660: 7265 6c61 7469 6f6e 2827 6462 3127 292e  relation('db1').
+00008670: 6170 700a 2020 2020 2020 2020 7365 6c66  app.        self
+00008680: 2e72 6573 6574 4261 636b 656e 6443 616c  .resetBackendCal
+00008690: 6c73 2829 0a0a 2020 2020 2020 2020 2320  ls()..        # 
+000086a0: 5265 6d6f 7465 2061 7070 6c69 6361 7469  Remote applicati
+000086b0: 6f6e 2073 7461 7475 7320 6973 2061 6c77  on status is alw
+000086c0: 6179 7320 756e 6b6e 6f77 6e2e 0a20 2020  ays unknown..   
+000086d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000086e0: 4973 496e 7374 616e 6365 2872 656d 6f74  IsInstance(remot
+000086f0: 6561 7070 312e 7374 6174 7573 2c20 6f70  eapp1.status, op
+00008700: 732e 556e 6b6e 6f77 6e53 7461 7475 7329  s.UnknownStatus)
+00008710: 0a0a 2020 2020 2020 2020 7465 7374 5f73  ..        test_s
+00008720: 7461 7475 7365 7320 3d20 280a 2020 2020  tatuses = (.    
+00008730: 2020 2020 2020 2020 6f70 732e 556e 6b6e          ops.Unkn
+00008740: 6f77 6e53 7461 7475 7328 292c 0a20 2020  ownStatus(),.   
+00008750: 2020 2020 2020 2020 206f 7073 2e41 6374           ops.Act
+00008760: 6976 6553 7461 7475 7328 292c 0a20 2020  iveStatus(),.   
+00008770: 2020 2020 2020 2020 206f 7073 2e4d 6169           ops.Mai
+00008780: 6e74 656e 616e 6365 5374 6174 7573 2827  ntenanceStatus('
+00008790: 5570 6772 6164 696e 6720 736f 6674 7761  Upgrading softwa
+000087a0: 7265 2729 2c0a 2020 2020 2020 2020 2020  re'),.          
+000087b0: 2020 6f70 732e 426c 6f63 6b65 6453 7461    ops.BlockedSta
+000087c0: 7475 7328 2741 7761 6974 696e 6720 6d61  tus('Awaiting ma
+000087d0: 6e75 616c 2072 6573 6f6c 7574 696f 6e27  nual resolution'
+000087e0: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
+000087f0: 7073 2e57 6169 7469 6e67 5374 6174 7573  ps.WaitingStatus
+00008800: 2827 4177 6169 7469 6e67 2072 656c 6174  ('Awaiting relat
+00008810: 6564 2061 7070 2075 7064 6174 6573 2729  ed app updates')
+00008820: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00008830: 2020 2020 666f 7220 7461 7267 6574 5f73      for target_s
+00008840: 7461 7475 7320 696e 2074 6573 745f 7374  tatus in test_st
+00008850: 6174 7573 6573 3a0a 2020 2020 2020 2020  atuses:.        
+00008860: 2020 2020 7769 7468 2073 656c 662e 7375      with self.su
+00008870: 6254 6573 7428 7461 7267 6574 5f73 7461  bTest(target_sta
+00008880: 7475 732e 6e61 6d65 293a 0a20 2020 2020  tus.name):.     
+00008890: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+000088a0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+000088b0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+000088c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000088d0: 2020 2020 2072 656d 6f74 6561 7070 312e       remoteapp1.
+000088e0: 7374 6174 7573 203d 2074 6172 6765 745f  status = target_
+000088f0: 7374 6174 7573 0a20 2020 2020 2020 2073  status.        s
+00008900: 656c 662e 6173 7365 7274 4261 636b 656e  elf.assertBacken
+00008910: 6443 616c 6c73 285b 5d29 0a0a 2020 2020  dCalls([])..    
+00008920: 6465 6620 7465 7374 5f73 746f 7261 6765  def test_storage
+00008930: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00008940: 6d65 7461 203d 206f 7073 2e43 6861 726d  meta = ops.Charm
+00008950: 4d65 7461 2829 0a20 2020 2020 2020 206d  Meta().        m
+00008960: 6574 612e 7374 6f72 6167 6573 203d 207b  eta.storages = {
+00008970: 2764 6973 6b73 273a 204e 6f6e 652c 2027  'disks': None, '
+00008980: 6461 7461 273a 204e 6f6e 657d 0a20 2020  data': None}.   
+00008990: 2020 2020 206d 6f64 656c 203d 206f 7073       model = ops
+000089a0: 2e4d 6f64 656c 286d 6574 612c 205f 4d6f  .Model(meta, _Mo
+000089b0: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
+000089c0: 702f 3027 2929 0a0a 2020 2020 2020 2020  p/0'))..        
+000089d0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+000089e0: 2c20 2773 746f 7261 6765 2d6c 6973 7427  , 'storage-list'
+000089f0: 2c20 2727 270a 2020 2020 2020 2020 2020  , '''.          
+00008a00: 2020 6966 205b 2022 2431 2220 3d20 6469    if [ "$1" = di
+00008a10: 736b 7320 5d3b 2074 6865 6e0a 2020 2020  sks ]; then.    
+00008a20: 2020 2020 2020 2020 2020 2020 6563 686f              echo
+00008a30: 2027 5b22 6469 736b 732f 3022 2c20 2264   '["disks/0", "d
+00008a40: 6973 6b73 2f31 225d 270a 2020 2020 2020  isks/1"]'.      
+00008a50: 2020 2020 2020 656c 7365 0a20 2020 2020        else.     
+00008a60: 2020 2020 2020 2020 2020 2065 6368 6f20             echo 
+00008a70: 275b 5d27 0a20 2020 2020 2020 2020 2020  '[]'.           
+00008a80: 2066 690a 2020 2020 2020 2020 2727 2729   fi.        ''')
+00008a90: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00008aa0: 7269 7074 2873 656c 662c 2027 7374 6f72  ript(self, 'stor
+00008ab0: 6167 652d 6765 7427 2c20 2727 270a 2020  age-get', '''.  
+00008ac0: 2020 2020 2020 2020 2020 6966 205b 2022            if [ "
+00008ad0: 2432 2220 3d20 6469 736b 732f 3020 5d3b  $2" = disks/0 ];
+00008ae0: 2074 6865 6e0a 2020 2020 2020 2020 2020   then.          
+00008af0: 2020 2020 2020 6563 686f 2027 222f 7661        echo '"/va
+00008b00: 722f 7372 762f 6469 736b 732f 3022 270a  r/srv/disks/0"'.
+00008b10: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00008b20: 205b 2022 2432 2220 3d20 6469 736b 732f   [ "$2" = disks/
+00008b30: 3120 5d3b 2074 6865 6e0a 2020 2020 2020  1 ]; then.      
+00008b40: 2020 2020 2020 2020 2020 6563 686f 2027            echo '
+00008b50: 222f 7661 722f 7372 762f 6469 736b 732f  "/var/srv/disks/
+00008b60: 3122 270a 2020 2020 2020 2020 2020 2020  1"'.            
+00008b70: 656c 7365 0a20 2020 2020 2020 2020 2020  else.           
+00008b80: 2020 2020 2065 7869 7420 320a 2020 2020       exit 2.    
+00008b90: 2020 2020 2020 2020 6669 0a20 2020 2020          fi.     
+00008ba0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00008bb0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00008bc0: 2c20 2773 746f 7261 6765 2d61 6464 272c  , 'storage-add',
+00008bd0: 2027 2729 0a0a 2020 2020 2020 2020 7365   '')..        se
+00008be0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+00008bf0: 656e 286d 6f64 656c 2e73 746f 7261 6765  en(model.storage
+00008c00: 7329 2c20 3229 0a20 2020 2020 2020 2073  s), 2).        s
+00008c10: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00008c20: 6d6f 6465 6c2e 7374 6f72 6167 6573 2e6b  model.storages.k
+00008c30: 6579 7328 292c 206d 6574 612e 7374 6f72  eys(), meta.stor
+00008c40: 6167 6573 2e6b 6579 7328 2929 0a20 2020  ages.keys()).   
+00008c50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008c60: 496e 2827 6469 736b 7327 2c20 6d6f 6465  In('disks', mode
+00008c70: 6c2e 7374 6f72 6167 6573 290a 0a20 2020  l.storages)..   
+00008c80: 2020 2020 2077 6974 6820 7079 7465 7374       with pytest
+00008c90: 2e72 6169 7365 7328 4b65 7945 7272 6f72  .raises(KeyError
+00008ca0: 2c20 6d61 7463 683d 2744 6964 2079 6f75  , match='Did you
+00008cb0: 206d 6561 6e27 293a 0a20 2020 2020 2020   mean'):.       
+00008cc0: 2020 2020 206d 6f64 656c 2e73 746f 7261       model.stora
+00008cd0: 6765 735b 2764 6f65 732d 6e6f 742d 6578  ges['does-not-ex
+00008ce0: 6973 7427 5d0a 0a20 2020 2020 2020 2074  ist']..        t
+00008cf0: 6573 745f 6361 7365 7320 3d20 7b0a 2020  est_cases = {.  
+00008d00: 2020 2020 2020 2020 2020 303a 207b 276e            0: {'n
+00008d10: 616d 6527 3a20 2764 6973 6b73 272c 2027  ame': 'disks', '
+00008d20: 6c6f 6361 7469 6f6e 273a 2070 6174 686c  location': pathl
+00008d30: 6962 2e50 6174 6828 272f 7661 722f 7372  ib.Path('/var/sr
+00008d40: 762f 6469 736b 732f 3027 297d 2c0a 2020  v/disks/0')},.  
+00008d50: 2020 2020 2020 2020 2020 313a 207b 276e            1: {'n
+00008d60: 616d 6527 3a20 2764 6973 6b73 272c 2027  ame': 'disks', '
+00008d70: 6c6f 6361 7469 6f6e 273a 2070 6174 686c  location': pathl
+00008d80: 6962 2e50 6174 6828 272f 7661 722f 7372  ib.Path('/var/sr
+00008d90: 762f 6469 736b 732f 3127 297d 2c0a 2020  v/disks/1')},.  
+00008da0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00008db0: 666f 7220 7374 6f72 6167 6520 696e 206d  for storage in m
+00008dc0: 6f64 656c 2e73 746f 7261 6765 735b 2764  odel.storages['d
+00008dd0: 6973 6b73 275d 3a0a 2020 2020 2020 2020  isks']:.        
+00008de0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00008df0: 7175 616c 2873 746f 7261 6765 2e6e 616d  qual(storage.nam
+00008e00: 652c 2027 6469 736b 7327 290a 2020 2020  e, 'disks').    
+00008e10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00008e20: 6572 7449 6e28 7374 6f72 6167 652e 6964  ertIn(storage.id
+00008e30: 2c20 7465 7374 5f63 6173 6573 290a 2020  , test_cases).  
+00008e40: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00008e50: 7373 6572 7445 7175 616c 2873 746f 7261  ssertEqual(stora
+00008e60: 6765 2e6e 616d 652c 2074 6573 745f 6361  ge.name, test_ca
+00008e70: 7365 735b 7374 6f72 6167 652e 6964 5d5b  ses[storage.id][
+00008e80: 276e 616d 6527 5d29 0a20 2020 2020 2020  'name']).       
+00008e90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008ea0: 4571 7561 6c28 7374 6f72 6167 652e 6c6f  Equal(storage.lo
+00008eb0: 6361 7469 6f6e 2c20 7465 7374 5f63 6173  cation, test_cas
+00008ec0: 6573 5b73 746f 7261 6765 2e69 645d 5b27  es[storage.id]['
+00008ed0: 6c6f 6361 7469 6f6e 275d 290a 0a20 2020  location'])..   
+00008ee0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008ef0: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
+00008f00: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+00008f10: 6561 723d 5472 7565 292c 205b 0a20 2020  ear=True), [.   
+00008f20: 2020 2020 2020 2020 205b 2773 746f 7261           ['stora
+00008f30: 6765 2d6c 6973 7427 2c20 2764 6973 6b73  ge-list', 'disks
+00008f40: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+00008f50: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
+00008f60: 205b 2773 746f 7261 6765 2d67 6574 272c   ['storage-get',
+00008f70: 2027 2d73 272c 2027 6469 736b 732f 3027   '-s', 'disks/0'
+00008f80: 2c20 276c 6f63 6174 696f 6e27 2c20 272d  , 'location', '-
+00008f90: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
+00008fa0: 2020 2020 2020 2020 2020 2020 5b27 7374              ['st
+00008fb0: 6f72 6167 652d 6765 7427 2c20 272d 7327  orage-get', '-s'
+00008fc0: 2c20 2764 6973 6b73 2f31 272c 2027 6c6f  , 'disks/1', 'lo
+00008fd0: 6361 7469 6f6e 272c 2027 2d2d 666f 726d  cation', '--form
+00008fe0: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
+00008ff0: 2020 205d 290a 0a20 2020 2020 2020 2073     ])..        s
+00009000: 656c 662e 6173 7365 7274 5365 7175 656e  elf.assertSequen
+00009010: 6365 4571 7561 6c28 6d6f 6465 6c2e 7374  ceEqual(model.st
+00009020: 6f72 6167 6573 5b27 6461 7461 275d 2c20  orages['data'], 
+00009030: 5b5d 290a 2020 2020 2020 2020 6d6f 6465  []).        mode
+00009040: 6c2e 7374 6f72 6167 6573 2e72 6571 7565  l.storages.reque
+00009050: 7374 2827 6461 7461 272c 2063 6f75 6e74  st('data', count
+00009060: 3d33 290a 2020 2020 2020 2020 7365 6c66  =3).        self
+00009070: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+00009080: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+00009090: 656c 6629 2c20 5b0a 2020 2020 2020 2020  elf), [.        
+000090a0: 2020 2020 5b27 7374 6f72 6167 652d 6c69      ['storage-li
+000090b0: 7374 272c 2027 6461 7461 272c 2027 2d2d  st', 'data', '--
+000090c0: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
+000090d0: 2020 2020 2020 2020 2020 205b 2773 746f             ['sto
+000090e0: 7261 6765 2d61 6464 272c 2027 6461 7461  rage-add', 'data
+000090f0: 3d33 275d 2c0a 2020 2020 2020 2020 5d29  =3'],.        ])
+00009100: 0a0a 2020 2020 2020 2020 2320 5472 7920  ..        # Try 
+00009110: 746f 2061 6464 2073 746f 7261 6765 206e  to add storage n
+00009120: 6f74 2070 7265 7365 6e74 2069 6e20 6368  ot present in ch
+00009130: 6172 6d20 6d65 7461 6461 7461 2e0a 2020  arm metadata..  
+00009140: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00009150: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00009160: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
+00009170: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
+00009180: 7374 6f72 6167 6573 2e72 6571 7565 7374  storages.request
+00009190: 2827 6465 6164 6265 6566 2729 0a0a 2020  ('deadbeef')..  
+000091a0: 2020 2020 2020 2320 496e 7661 6c69 6420        # Invalid 
+000091b0: 636f 756e 7420 7061 7261 6d65 7465 7220  count parameter 
+000091c0: 7479 7065 732e 0a20 2020 2020 2020 2066  types..        f
+000091d0: 6f72 2063 6f75 6e74 5f76 2069 6e20 5b4e  or count_v in [N
+000091e0: 6f6e 652c 2046 616c 7365 2c20 322e 302c  one, False, 2.0,
+000091f0: 2027 6127 2c20 6227 6265 6566 272c 206f   'a', b'beef', o
+00009200: 626a 6563 745d 3a0a 2020 2020 2020 2020  bject]:.        
+00009210: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00009220: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
+00009230: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00009240: 2020 2020 2020 206d 6f64 656c 2e73 746f         model.sto
+00009250: 7261 6765 732e 7265 7175 6573 7428 2764  rages.request('d
+00009260: 6174 6127 2c20 636f 756e 745f 7629 0a0a  ata', count_v)..
+00009270: 2020 2020 6465 6620 7465 7374 5f73 746f      def test_sto
+00009280: 7261 6765 735f 696d 6d75 7461 626c 6528  rages_immutable(
+00009290: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
+000092a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+000092b0: 6169 7365 7328 4174 7472 6962 7574 6545  aises(AttributeE
+000092c0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+000092d0: 2020 2073 656c 662e 6d6f 6465 6c2e 7374     self.model.st
+000092e0: 6f72 6167 6573 203d 207b 7d0a 0a20 2020  orages = {}..   
+000092f0: 2064 6566 2072 6573 6574 4261 636b 656e   def resetBacken
+00009300: 6443 616c 6c73 2873 656c 6629 3a20 2023  dCalls(self):  #
+00009310: 206e 6f71 613a 204e 3830 320a 2020 2020   noqa: N802.    
+00009320: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+00009330: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
+00009340: 6c6c 7328 7265 7365 743d 5472 7565 290a  lls(reset=True).
+00009350: 0a20 2020 2064 6566 2061 7373 6572 7442  .    def assertB
+00009360: 6163 6b65 6e64 4361 6c6c 7328 7365 6c66  ackendCalls(self
+00009370: 2c20 6578 7065 6374 6564 2c20 2a2c 2072  , expected, *, r
+00009380: 6573 6574 3d54 7275 6529 3a20 2023 206e  eset=True):  # n
+00009390: 6f71 613a 204e 3830 320a 2020 2020 2020  oqa: N802.      
+000093a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000093b0: 616c 2865 7870 6563 7465 642c 2073 656c  al(expected, sel
+000093c0: 662e 6861 726e 6573 732e 5f67 6574 5f62  f.harness._get_b
+000093d0: 6163 6b65 6e64 5f63 616c 6c73 2872 6573  ackend_calls(res
+000093e0: 6574 3d72 6573 6574 2929 0a0a 2020 2020  et=reset))..    
+000093f0: 6465 6620 7465 7374 5f72 756e 5f65 7272  def test_run_err
+00009400: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
+00009410: 2020 6d6f 6465 6c20 3d20 6f70 732e 4d6f    model = ops.Mo
+00009420: 6465 6c28 6f70 732e 4368 6172 6d4d 6574  del(ops.CharmMet
+00009430: 6128 292c 205f 4d6f 6465 6c42 6163 6b65  a(), _ModelBacke
+00009440: 6e64 2827 6d79 6170 702f 3027 2929 0a20  nd('myapp/0')). 
+00009450: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00009460: 7074 2873 656c 662c 2027 7374 6174 7573  pt(self, 'status
+00009470: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
+00009480: 4552 524f 5220 6361 6e6e 6f74 2067 6574  ERROR cannot get
+00009490: 2073 7461 7475 7327 203e 2632 3b20 6578   status' >&2; ex
+000094a0: 6974 2031 2222 2229 0a20 2020 2020 2020  it 1""").       
+000094b0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+000094c0: 7452 6169 7365 7328 6f70 732e 4d6f 6465  tRaises(ops.Mode
+000094d0: 6c45 7272 6f72 2920 6173 2063 6d3a 0a20  lError) as cm:. 
+000094e0: 2020 2020 2020 2020 2020 205f 203d 206d             _ = m
+000094f0: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
+00009500: 2e6d 6573 7361 6765 0a20 2020 2020 2020  .message.       
+00009510: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00009520: 6c28 7374 7228 636d 2e65 7863 6570 7469  l(str(cm.excepti
+00009530: 6f6e 292c 2027 4552 524f 5220 6361 6e6e  on), 'ERROR cann
+00009540: 6f74 2067 6574 2073 7461 7475 735c 6e27  ot get status\n'
+00009550: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009560: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00009570: 6365 7074 696f 6e2e 6172 6773 5b30 5d2c  ception.args[0],
+00009580: 2027 4552 524f 5220 6361 6e6e 6f74 2067   'ERROR cannot g
+00009590: 6574 2073 7461 7475 735c 6e27 290a 0a0a  et status\n')...
+000095a0: 636c 6173 7320 5075 7368 5075 6c6c 4361  class PushPullCa
+000095b0: 7365 3a0a 2020 2020 2222 2254 6573 7420  se:.    """Test 
+000095c0: 6361 7365 2066 6f72 2074 6162 6c65 2d64  case for table-d
+000095d0: 7269 7665 6e20 7465 7374 732e 2222 220a  riven tests.""".
+000095e0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+000095f0: 5f28 7365 6c66 2c20 2a2a 7661 6c73 293a  _(self, **vals):
+00009600: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
+00009610: 7474 6572 6e20 3d20 4e6f 6e65 0a20 2020  ttern = None.   
+00009620: 2020 2020 2073 656c 662e 6473 7420 3d20       self.dst = 
+00009630: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00009640: 662e 6572 726f 7273 203d 205b 5d0a 2020  f.errors = [].  
+00009650: 2020 2020 2020 7365 6c66 2e77 616e 7420        self.want 
+00009660: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00009670: 666f 7220 6b65 792c 2076 616c 2069 6e20  for key, val in 
+00009680: 7661 6c73 2e69 7465 6d73 2829 3a0a 2020  vals.items():.  
+00009690: 2020 2020 2020 2020 2020 7365 7461 7474            setatt
+000096a0: 7228 7365 6c66 2c20 6b65 792c 2076 616c  r(self, key, val
+000096b0: 290a 0a0a 7265 6375 7273 6976 655f 6c69  )...recursive_li
+000096c0: 7374 5f63 6173 6573 203d 205b 0a20 2020  st_cases = [.   
+000096d0: 2050 7573 6850 756c 6c43 6173 6528 0a20   PushPullCase(. 
+000096e0: 2020 2020 2020 206e 616d 653d 2762 6173         name='bas
+000096f0: 6963 2072 6563 7572 7369 7665 206c 6973  ic recursive lis
+00009700: 7427 2c0a 2020 2020 2020 2020 7061 7468  t',.        path
+00009710: 3d27 2f27 2c0a 2020 2020 2020 2020 6669  ='/',.        fi
+00009720: 6c65 733d 5b27 2f66 6f6f 2f62 6172 2e74  les=['/foo/bar.t
+00009730: 7874 272c 2027 2f62 617a 2e74 7874 275d  xt', '/baz.txt']
+00009740: 2c0a 2020 2020 2020 2020 7761 6e74 3d7b  ,.        want={
+00009750: 272f 666f 6f2f 6261 722e 7478 7427 2c20  '/foo/bar.txt', 
+00009760: 272f 6261 7a2e 7478 7427 7d2c 0a20 2020  '/baz.txt'},.   
+00009770: 2029 2c0a 2020 2020 5075 7368 5075 6c6c   ),.    PushPull
+00009780: 4361 7365 280a 2020 2020 2020 2020 6e61  Case(.        na
+00009790: 6d65 3d27 6261 7369 6320 7265 6375 7273  me='basic recurs
+000097a0: 6976 6520 6c69 7374 2072 6576 6572 7365  ive list reverse
+000097b0: 272c 0a20 2020 2020 2020 2070 6174 683d  ',.        path=
+000097c0: 272f 272c 0a20 2020 2020 2020 2066 696c  '/',.        fil
+000097d0: 6573 3d5b 272f 6261 7a2e 7478 7427 2c20  es=['/baz.txt', 
+000097e0: 272f 666f 6f2f 6261 722e 7478 7427 5d2c  '/foo/bar.txt'],
+000097f0: 0a20 2020 2020 2020 2077 616e 743d 7b27  .        want={'
+00009800: 2f66 6f6f 2f62 6172 2e74 7874 272c 2027  /foo/bar.txt', '
+00009810: 2f62 617a 2e74 7874 277d 2c0a 2020 2020  /baz.txt'},.    
+00009820: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
+00009830: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
+00009840: 653d 2764 6972 6563 746c 7920 6c69 7374  e='directly list
+00009850: 2061 2028 6e6f 6e2d 6469 7265 6374 6f72   a (non-director
+00009860: 7929 2066 696c 6527 2c0a 2020 2020 2020  y) file',.      
+00009870: 2020 7061 7468 3d27 2f62 617a 2e74 7874    path='/baz.txt
+00009880: 272c 0a20 2020 2020 2020 2066 696c 6573  ',.        files
+00009890: 3d5b 272f 6261 7a2e 7478 7427 5d2c 0a20  =['/baz.txt'],. 
+000098a0: 2020 2020 2020 2077 616e 743d 7b27 2f62         want={'/b
+000098b0: 617a 2e74 7874 277d 2c0a 2020 2020 292c  az.txt'},.    ),
+000098c0: 0a5d 0a0a 0a40 7079 7465 7374 2e6d 6172  .]...@pytest.mar
+000098d0: 6b2e 7061 7261 6d65 7472 697a 6528 2763  k.parametrize('c
+000098e0: 6173 6527 2c20 7265 6375 7273 6976 655f  ase', recursive_
+000098f0: 6c69 7374 5f63 6173 6573 290a 6465 6620  list_cases).def 
+00009900: 7465 7374 5f72 6563 7572 7369 7665 5f6c  test_recursive_l
+00009910: 6973 7428 6361 7365 293a 0a20 2020 2064  ist(case):.    d
+00009920: 6566 206c 6973 745f 6675 6e63 5f67 656e  ef list_func_gen
+00009930: 2866 696c 655f 6c69 7374 293a 0a20 2020  (file_list):.   
+00009940: 2020 2020 2061 7267 7320 3d20 7b0a 2020       args = {.  
+00009950: 2020 2020 2020 2020 2020 276c 6173 745f            'last_
+00009960: 6d6f 6469 6669 6564 273a 2064 6174 6574  modified': datet
+00009970: 696d 652e 7469 6d65 2829 2c0a 2020 2020  ime.time(),.    
+00009980: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
+00009990: 696f 6e73 273a 2030 6f37 3737 2c0a 2020  ions': 0o777,.  
+000099a0: 2020 2020 2020 2020 2020 2773 697a 6527            'size'
+000099b0: 3a20 3432 2c0a 2020 2020 2020 2020 2020  : 42,.          
+000099c0: 2020 2775 7365 725f 6964 273a 2030 2c0a    'user_id': 0,.
+000099d0: 2020 2020 2020 2020 2020 2020 2775 7365              'use
+000099e0: 7227 3a20 2766 6f6f 272c 0a20 2020 2020  r': 'foo',.     
+000099f0: 2020 2020 2020 2027 6772 6f75 705f 6964         'group_id
+00009a00: 273a 2031 3032 342c 0a20 2020 2020 2020  ': 1024,.       
+00009a10: 2020 2020 2027 6772 6f75 7027 3a20 2762       'group': 'b
+00009a20: 6172 272c 0a20 2020 2020 2020 207d 0a20  ar',.        }. 
+00009a30: 2020 2020 2020 2066 696c 655f 696e 666f         file_info
+00009a40: 732c 2064 6972 7320 3d20 5b5d 2c20 7365  s, dirs = [], se
+00009a50: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
+00009a60: 6620 696e 2066 696c 655f 6c69 7374 3a0a  f in file_list:.
+00009a70: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00009a80: 5f69 6e66 6f73 2e61 7070 656e 6428 0a20  _infos.append(. 
+00009a90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00009aa0: 6562 626c 652e 4669 6c65 496e 666f 280a  ebble.FileInfo(.
+00009ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ac0: 2020 2020 7061 7468 3d66 2c0a 2020 2020      path=f,.    
+00009ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ae0: 6e61 6d65 3d6f 732e 7061 7468 2e62 6173  name=os.path.bas
+00009af0: 656e 616d 6528 6629 2c0a 2020 2020 2020  ename(f),.      
+00009b00: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+00009b10: 7065 3d70 6562 626c 652e 4669 6c65 5479  pe=pebble.FileTy
+00009b20: 7065 2e46 494c 452c 0a20 2020 2020 2020  pe.FILE,.       
+00009b30: 2020 2020 2020 2020 2020 2020 202a 2a61               **a
+00009b40: 7267 7329 290a 0a20 2020 2020 2020 2020  rgs))..         
+00009b50: 2020 2023 2063 6f6c 6c65 6374 2061 6c6c     # collect all
+00009b60: 2074 6865 2064 6972 6563 746f 7269 6573   the directories
+00009b70: 2066 6f72 2074 6865 2074 6573 7420 6361   for the test ca
+00009b80: 7365 2773 2066 696c 6573 0a20 2020 2020  se's files.     
+00009b90: 2020 2020 2020 2064 6972 7061 7468 203d         dirpath =
+00009ba0: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
+00009bb0: 2866 290a 2020 2020 2020 2020 2020 2020  (f).            
+00009bc0: 6966 2064 6972 7061 7468 2021 3d20 2727  if dirpath != ''
+00009bd0: 2061 6e64 2064 6972 7061 7468 206e 6f74   and dirpath not
+00009be0: 2069 6e20 6469 7273 3a0a 2020 2020 2020   in dirs:.      
+00009bf0: 2020 2020 2020 2020 2020 6469 7273 2e75            dirs.u
+00009c00: 7064 6174 6528 6469 7270 6174 6829 0a20  pdate(dirpath). 
+00009c10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009c20: 696c 655f 696e 666f 732e 6170 7065 6e64  ile_infos.append
+00009c30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009c40: 2020 2020 2020 7065 6262 6c65 2e46 696c        pebble.Fil
+00009c50: 6549 6e66 6f28 0a20 2020 2020 2020 2020  eInfo(.         
+00009c60: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00009c70: 6174 683d 6469 7270 6174 682c 0a20 2020  ath=dirpath,.   
+00009c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c90: 2020 2020 206e 616d 653d 6f73 2e70 6174       name=os.pat
+00009ca0: 682e 6261 7365 6e61 6d65 2864 6972 7061  h.basename(dirpa
+00009cb0: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
+00009cc0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00009cd0: 653d 7065 6262 6c65 2e46 696c 6554 7970  e=pebble.FileTyp
+00009ce0: 652e 4449 5245 4354 4f52 592c 0a20 2020  e.DIRECTORY,.   
 00009cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d00: 2020 206e 616d 653d 6f73 2e70 6174 682e     name=os.path.
-00009d10: 6261 7365 6e61 6d65 2866 292c 0a20 2020  basename(f),.   
-00009d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d30: 2074 7970 653d 4669 6c65 5479 7065 2e46   type=FileType.F
-00009d40: 494c 452c 0a20 2020 2020 2020 2020 2020  ILE,.           
-00009d50: 2020 2020 2020 2020 202a 2a61 7267 7329           **args)
-00009d60: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00009d70: 2063 6f6c 6c65 6374 2061 6c6c 2074 6865   collect all the
-00009d80: 2064 6972 6563 746f 7269 6573 2066 6f72   directories for
-00009d90: 2074 6865 2074 6573 7420 6361 7365 2773   the test case's
-00009da0: 2066 696c 6573 0a20 2020 2020 2020 2020   files.         
-00009db0: 2020 2064 6972 7061 7468 203d 206f 732e     dirpath = os.
-00009dc0: 7061 7468 2e64 6972 6e61 6d65 2866 290a  path.dirname(f).
-00009dd0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00009de0: 6972 7061 7468 2021 3d20 2727 2061 6e64  irpath != '' and
-00009df0: 2064 6972 7061 7468 206e 6f74 2069 6e20   dirpath not in 
-00009e00: 6469 7273 3a0a 2020 2020 2020 2020 2020  dirs:.          
-00009e10: 2020 2020 2020 6469 7273 2e75 7064 6174        dirs.updat
-00009e20: 6528 6469 7270 6174 6829 0a20 2020 2020  e(dirpath).     
-00009e30: 2020 2020 2020 2020 2020 2066 696c 655f             file_
-00009e40: 696e 666f 732e 6170 7065 6e64 280a 2020  infos.append(.  
-00009e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e60: 2020 4669 6c65 496e 666f 280a 2020 2020    FileInfo(.    
-00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e80: 2020 2020 7061 7468 3d64 6972 7061 7468      path=dirpath
-00009e90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009ea0: 2020 2020 2020 2020 2020 6e61 6d65 3d6f            name=o
-00009eb0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00009ec0: 6469 7270 6174 6829 2c0a 2020 2020 2020  dirpath),.      
-00009ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ee0: 2020 7479 7065 3d46 696c 6554 7970 652e    type=FileType.
-00009ef0: 4449 5245 4354 4f52 592c 0a20 2020 2020  DIRECTORY,.     
-00009f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f10: 2020 202a 2a61 7267 7329 290a 0a20 2020     **args))..   
-00009f20: 2020 2020 2064 6566 2069 6e6e 6572 2870       def inner(p
-00009f30: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
-00009f40: 2020 7061 7468 203d 2073 7472 2870 6174    path = str(pat
-00009f50: 6829 0a20 2020 2020 2020 2020 2020 206d  h).            m
-00009f60: 6174 6368 6573 203d 205b 5d0a 2020 2020  atches = [].    
-00009f70: 2020 2020 2020 2020 666f 7220 696e 666f          for info
-00009f80: 2069 6e20 6669 6c65 5f69 6e66 6f73 3a0a   in file_infos:.
+00009d00: 2020 2020 202a 2a61 7267 7329 290a 0a20       **args)).. 
+00009d10: 2020 2020 2020 2064 6566 2069 6e6e 6572         def inner
+00009d20: 2870 6174 6829 3a0a 2020 2020 2020 2020  (path):.        
+00009d30: 2020 2020 7061 7468 203d 2073 7472 2870      path = str(p
+00009d40: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00009d50: 206d 6174 6368 6573 203d 205b 5d0a 2020   matches = [].  
+00009d60: 2020 2020 2020 2020 2020 666f 7220 696e            for in
+00009d70: 666f 2069 6e20 6669 6c65 5f69 6e66 6f73  fo in file_infos
+00009d80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009d90: 2020 2320 6578 636c 7564 6520 6669 6c65    # exclude file
+00009da0: 2069 6e66 6f73 2066 6f72 2073 6570 6172   infos for separ
+00009db0: 6174 6520 7472 6565 7320 616e 6420 616c  ate trees and al
+00009dc0: 736f 0a20 2020 2020 2020 2020 2020 2020  so.             
+00009dd0: 2020 2023 2066 6f72 2074 6865 2064 6972     # for the dir
+00009de0: 6563 746f 7279 2077 6520 6172 6520 6c69  ectory we are li
+00009df0: 7374 696e 6720 6974 7365 6c66 202d 2077  sting itself - w
+00009e00: 6520 6f6e 6c79 2077 616e 7420 6974 7320  e only want its 
+00009e10: 636f 6e74 656e 7473 2e0a 2020 2020 2020  contents..      
+00009e20: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00009e30: 2069 6e66 6f2e 7061 7468 2e73 7461 7274   info.path.start
+00009e40: 7377 6974 6828 7061 7468 2920 6f72 2028  swith(path) or (
+00009e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009e60: 2020 2020 2020 2020 2069 6e66 6f2e 7479           info.ty
+00009e70: 7065 203d 3d20 7065 6262 6c65 2e46 696c  pe == pebble.Fil
+00009e80: 6554 7970 652e 4449 5245 4354 4f52 5920  eType.DIRECTORY 
+00009e90: 616e 6420 7061 7468 203d 3d20 696e 666f  and path == info
+00009ea0: 2e70 6174 6829 3a0a 2020 2020 2020 2020  .path):.        
+00009eb0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00009ec0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00009ed0: 2020 2020 2023 2065 7863 6c75 6465 2066       # exclude f
+00009ee0: 696c 6520 696e 666f 7320 666f 7220 6669  ile infos for fi
+00009ef0: 6c65 7320 7468 6174 2061 7265 2069 6e20  les that are in 
+00009f00: 7375 6264 6972 6563 746f 7269 6573 206f  subdirectories o
+00009f10: 6620 7061 7468 2e0a 2020 2020 2020 2020  f path..        
+00009f20: 2020 2020 2020 2020 2320 7765 206f 6e6c          # we onl
+00009f30: 7920 7761 6e74 2066 696c 6573 2074 6861  y want files tha
+00009f40: 7420 6172 6520 6469 7265 6374 6c79 2069  t are directly i
+00009f50: 6e20 7061 7468 2e0a 2020 2020 2020 2020  n path..        
+00009f60: 2020 2020 2020 2020 6966 2069 6e66 6f2e          if info.
+00009f70: 7061 7468 5b6c 656e 2870 6174 6829 3a5d  path[len(path):]
+00009f80: 2e66 696e 6428 272f 2729 203e 2030 3a0a  .find('/') > 0:.
 00009f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fa0: 2320 6578 636c 7564 6520 6669 6c65 2069  # exclude file i
-00009fb0: 6e66 6f73 2066 6f72 2073 6570 6172 6174  nfos for separat
-00009fc0: 6520 7472 6565 7320 616e 6420 616c 736f  e trees and also
-00009fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009fe0: 2023 2066 6f72 2074 6865 2064 6972 6563   # for the direc
-00009ff0: 746f 7279 2077 6520 6172 6520 6c69 7374  tory we are list
-0000a000: 696e 6720 6974 7365 6c66 202d 2077 6520  ing itself - we 
-0000a010: 6f6e 6c79 2077 616e 7420 6974 7320 636f  only want its co
-0000a020: 6e74 656e 7473 2e0a 2020 2020 2020 2020  ntents..        
-0000a030: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0000a040: 6e66 6f2e 7061 7468 2e73 7461 7274 7377  nfo.path.startsw
-0000a050: 6974 6828 7061 7468 2920 6f72 2028 0a20  ith(path) or (. 
-0000a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a070: 2020 2020 2020 2069 6e66 6f2e 7479 7065         info.type
-0000a080: 203d 3d20 4669 6c65 5479 7065 2e44 4952   == FileType.DIR
-0000a090: 4543 544f 5259 2061 6e64 2070 6174 6820  ECTORY and path 
-0000a0a0: 3d3d 2069 6e66 6f2e 7061 7468 293a 0a20  == info.path):. 
-0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0c0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-0000a0d0: 2020 2020 2020 2020 2020 2020 2320 6578              # ex
-0000a0e0: 636c 7564 6520 6669 6c65 2069 6e66 6f73  clude file infos
-0000a0f0: 2066 6f72 2066 696c 6573 2074 6861 7420   for files that 
-0000a100: 6172 6520 696e 2073 7562 6469 7265 6374  are in subdirect
-0000a110: 6f72 6965 7320 6f66 2070 6174 682e 0a20  ories of path.. 
-0000a120: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000a130: 2077 6520 6f6e 6c79 2077 616e 7420 6669   we only want fi
-0000a140: 6c65 7320 7468 6174 2061 7265 2064 6972  les that are dir
-0000a150: 6563 746c 7920 696e 2070 6174 682e 0a20  ectly in path.. 
-0000a160: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000a170: 6620 696e 666f 2e70 6174 685b 6c65 6e28  f info.path[len(
-0000a180: 7061 7468 293a 5d2e 6669 6e64 2827 2f27  path):].find('/'
-0000a190: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-0000a1a0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0000a1b0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-0000a1c0: 2020 2020 6d61 7463 6865 732e 6170 7065      matches.appe
-0000a1d0: 6e64 2869 6e66 6f29 0a20 2020 2020 2020  nd(info).       
-0000a1e0: 2020 2020 2072 6574 7572 6e20 6d61 7463       return matc
-0000a1f0: 6865 730a 2020 2020 2020 2020 7265 7475  hes.        retu
-0000a200: 726e 2069 6e6e 6572 0a0a 2020 2020 2320  rn inner..    # 
-0000a210: 7465 7374 2072 6177 2062 7573 696e 6573  test raw busines
-0000a220: 7320 6c6f 6769 6320 666f 7220 7265 6375  s logic for recu
-0000a230: 7273 696f 6e20 616e 6420 6465 7374 2070  rsion and dest p
-0000a240: 6174 6820 636f 6e73 7472 7563 7469 6f6e  ath construction
-0000a250: 0a20 2020 2066 696c 6573 203d 2073 6574  .    files = set
-0000a260: 2829 0a20 2020 2063 6173 652e 7061 7468  ().    case.path
-0000a270: 203d 206f 732e 7061 7468 2e6e 6f72 6d70   = os.path.normp
-0000a280: 6174 6828 6361 7365 2e70 6174 6829 0a20  ath(case.path). 
-0000a290: 2020 2063 6173 652e 6669 6c65 7320 3d20     case.files = 
-0000a2a0: 5b6f 732e 7061 7468 2e6e 6f72 6d70 6174  [os.path.normpat
-0000a2b0: 6828 6629 2066 6f72 2066 2069 6e20 6361  h(f) for f in ca
-0000a2c0: 7365 2e66 696c 6573 5d0a 2020 2020 6361  se.files].    ca
-0000a2d0: 7365 2e77 616e 7420 3d20 7b6f 732e 7061  se.want = {os.pa
-0000a2e0: 7468 2e6e 6f72 6d70 6174 6828 6629 2066  th.normpath(f) f
-0000a2f0: 6f72 2066 2069 6e20 6361 7365 2e77 616e  or f in case.wan
-0000a300: 747d 0a20 2020 2066 6f72 2066 2069 6e20  t}.    for f in 
-0000a310: 6f70 732e 6d6f 6465 6c2e 436f 6e74 6169  ops.model.Contai
-0000a320: 6e65 722e 5f6c 6973 745f 7265 6375 7273  ner._list_recurs
-0000a330: 6976 6528 0a20 2020 2020 2020 206c 6973  ive(.        lis
-0000a340: 745f 6675 6e63 5f67 656e 280a 2020 2020  t_func_gen(.    
-0000a350: 2020 2020 2020 2020 6361 7365 2e66 696c          case.fil
-0000a360: 6573 292c 2070 6174 686c 6962 2e50 6174  es), pathlib.Pat
-0000a370: 6828 0a20 2020 2020 2020 2020 2020 2063  h(.            c
-0000a380: 6173 652e 7061 7468 2929 3a0a 2020 2020  ase.path)):.    
-0000a390: 2020 2020 7061 7468 203d 2066 2e70 6174      path = f.pat
-0000a3a0: 680a 2020 2020 2020 2020 6966 2063 6173  h.        if cas
-0000a3b0: 652e 6473 7420 6973 206e 6f74 204e 6f6e  e.dst is not Non
-0000a3c0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0000a3d0: 2074 6573 7420 6465 7374 696e 6174 696f   test destinatio
-0000a3e0: 6e20 7061 7468 2063 6f6e 7374 7275 6374  n path construct
-0000a3f0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-0000a400: 5f2c 2070 6174 6820 3d20 662e 7061 7468  _, path = f.path
-0000a410: 2c20 6f70 732e 6d6f 6465 6c2e 436f 6e74  , ops.model.Cont
-0000a420: 6169 6e65 722e 5f62 7569 6c64 5f64 6573  ainer._build_des
-0000a430: 7470 6174 6828 0a20 2020 2020 2020 2020  tpath(.         
-0000a440: 2020 2020 2020 2066 2e70 6174 682c 2063         f.path, c
-0000a450: 6173 652e 7061 7468 2c20 6361 7365 2e64  ase.path, case.d
-0000a460: 7374 290a 2020 2020 2020 2020 6669 6c65  st).        file
-0000a470: 732e 6164 6428 7061 7468 290a 2020 2020  s.add(path).    
-0000a480: 6173 7365 7274 2063 6173 652e 7761 6e74  assert case.want
-0000a490: 203d 3d20 6669 6c65 732c 2066 2763 6173   == files, f'cas
-0000a4a0: 6520 7b63 6173 652e 6e61 6d65 2172 7d20  e {case.name!r} 
-0000a4b0: 6861 7320 7772 6f6e 6720 6669 6c65 733a  has wrong files:
-0000a4c0: 2077 616e 7420 7b63 6173 652e 7761 6e74   want {case.want
-0000a4d0: 7d2c 2067 6f74 207b 6669 6c65 737d 270a  }, got {files}'.
-0000a4e0: 0a0a 7265 6375 7273 6976 655f 7075 7368  ..recursive_push
-0000a4f0: 5f70 756c 6c5f 6361 7365 7320 3d20 5b0a  _pull_cases = [.
-0000a500: 2020 2020 5075 7368 5075 6c6c 4361 7365      PushPullCase
-0000a510: 280a 2020 2020 2020 2020 6e61 6d65 3d27  (.        name='
-0000a520: 6261 7369 6320 7075 7368 2f70 756c 6c27  basic push/pull'
-0000a530: 2c0a 2020 2020 2020 2020 7061 7468 3d27  ,.        path='
-0000a540: 2f66 6f6f 272c 0a20 2020 2020 2020 2064  /foo',.        d
-0000a550: 7374 3d27 2f62 617a 272c 0a20 2020 2020  st='/baz',.     
-0000a560: 2020 2066 696c 6573 3d5b 272f 666f 6f2f     files=['/foo/
-0000a570: 6261 722e 7478 7427 5d2c 0a20 2020 2020  bar.txt'],.     
-0000a580: 2020 2077 616e 743d 7b27 2f62 617a 2f66     want={'/baz/f
-0000a590: 6f6f 2f62 6172 2e74 7874 277d 2c0a 2020  oo/bar.txt'},.  
-0000a5a0: 2020 292c 0a20 2020 2050 7573 6850 756c    ),.    PushPul
-0000a5b0: 6c43 6173 6528 0a20 2020 2020 2020 206e  lCase(.        n
-0000a5c0: 616d 653d 2770 7573 682f 7075 6c6c 202d  ame='push/pull -
-0000a5d0: 2074 7261 696c 696e 6720 736c 6173 6827   trailing slash'
-0000a5e0: 2c0a 2020 2020 2020 2020 7061 7468 3d27  ,.        path='
-0000a5f0: 2f66 6f6f 2f27 2c0a 2020 2020 2020 2020  /foo/',.        
-0000a600: 6473 743d 272f 6261 7a27 2c0a 2020 2020  dst='/baz',.    
-0000a610: 2020 2020 6669 6c65 733d 5b27 2f66 6f6f      files=['/foo
-0000a620: 2f62 6172 2e74 7874 275d 2c0a 2020 2020  /bar.txt'],.    
-0000a630: 2020 2020 7761 6e74 3d7b 272f 6261 7a2f      want={'/baz/
-0000a640: 666f 6f2f 6261 722e 7478 7427 7d2c 0a20  foo/bar.txt'},. 
-0000a650: 2020 2029 2c0a 2020 2020 5075 7368 5075     ),.    PushPu
-0000a660: 6c6c 4361 7365 280a 2020 2020 2020 2020  llCase(.        
-0000a670: 6e61 6d65 3d27 6261 7369 6320 7075 7368  name='basic push
-0000a680: 2f70 756c 6c20 2d20 726f 6f74 272c 0a20  /pull - root',. 
-0000a690: 2020 2020 2020 2070 6174 683d 272f 272c         path='/',
-0000a6a0: 0a20 2020 2020 2020 2064 7374 3d27 2f62  .        dst='/b
-0000a6b0: 617a 272c 0a20 2020 2020 2020 2066 696c  az',.        fil
-0000a6c0: 6573 3d5b 272f 666f 6f2f 6261 722e 7478  es=['/foo/bar.tx
-0000a6d0: 7427 5d2c 0a20 2020 2020 2020 2077 616e  t'],.        wan
-0000a6e0: 743d 7b27 2f62 617a 2f66 6f6f 2f62 6172  t={'/baz/foo/bar
-0000a6f0: 2e74 7874 277d 2c0a 2020 2020 292c 0a20  .txt'},.    ),. 
-0000a700: 2020 2050 7573 6850 756c 6c43 6173 6528     PushPullCase(
-0000a710: 0a20 2020 2020 2020 206e 616d 653d 2762  .        name='b
-0000a720: 6173 6963 2070 7573 682f 7075 6c6c 202d  asic push/pull -
-0000a730: 206d 756c 7469 636f 6d70 6f6e 656e 7420   multicomponent 
-0000a740: 7061 7468 272c 0a20 2020 2020 2020 2070  path',.        p
-0000a750: 6174 683d 272f 666f 6f2f 6261 7227 2c0a  ath='/foo/bar',.
-0000a760: 2020 2020 2020 2020 6473 743d 272f 6261          dst='/ba
-0000a770: 7a27 2c0a 2020 2020 2020 2020 6669 6c65  z',.        file
-0000a780: 733d 5b27 2f66 6f6f 2f62 6172 2f62 617a  s=['/foo/bar/baz
-0000a790: 2e74 7874 275d 2c0a 2020 2020 2020 2020  .txt'],.        
-0000a7a0: 7761 6e74 3d7b 272f 6261 7a2f 6261 722f  want={'/baz/bar/
-0000a7b0: 6261 7a2e 7478 7427 7d2c 0a20 2020 2029  baz.txt'},.    )
-0000a7c0: 2c0a 2020 2020 5075 7368 5075 6c6c 4361  ,.    PushPullCa
-0000a7d0: 7365 280a 2020 2020 2020 2020 6e61 6d65  se(.        name
-0000a7e0: 3d27 7075 7368 2f70 756c 6c20 636f 6e74  ='push/pull cont
-0000a7f0: 656e 7473 272c 0a20 2020 2020 2020 2070  ents',.        p
-0000a800: 6174 683d 272f 666f 6f2f 2a27 2c0a 2020  ath='/foo/*',.  
-0000a810: 2020 2020 2020 6473 743d 272f 6261 7a27        dst='/baz'
-0000a820: 2c0a 2020 2020 2020 2020 6669 6c65 733d  ,.        files=
-0000a830: 5b27 2f66 6f6f 2f62 6172 2e74 7874 275d  ['/foo/bar.txt']
-0000a840: 2c0a 2020 2020 2020 2020 7761 6e74 3d7b  ,.        want={
-0000a850: 272f 6261 7a2f 6261 722e 7478 7427 7d2c  '/baz/bar.txt'},
-0000a860: 0a20 2020 2029 2c0a 2020 2020 5075 7368  .    ),.    Push
-0000a870: 5075 6c6c 4361 7365 280a 2020 2020 2020  PullCase(.      
-0000a880: 2020 6e61 6d65 3d27 6469 7265 6374 6c79    name='directly
-0000a890: 2070 7573 682f 7075 6c6c 2061 2073 7065   push/pull a spe
-0000a8a0: 6369 6669 6320 6669 6c65 272c 0a20 2020  cific file',.   
-0000a8b0: 2020 2020 2070 6174 683d 272f 666f 6f2f       path='/foo/
-0000a8c0: 6261 722e 7478 7427 2c0a 2020 2020 2020  bar.txt',.      
-0000a8d0: 2020 6473 743d 272f 6261 7a27 2c0a 2020    dst='/baz',.  
-0000a8e0: 2020 2020 2020 6669 6c65 733d 5b27 2f66        files=['/f
-0000a8f0: 6f6f 2f62 6172 2e74 7874 275d 2c0a 2020  oo/bar.txt'],.  
-0000a900: 2020 2020 2020 7761 6e74 3d7b 272f 6261        want={'/ba
-0000a910: 7a2f 6261 722e 7478 7427 7d2c 0a20 2020  z/bar.txt'},.   
-0000a920: 2029 2c0a 2020 2020 5075 7368 5075 6c6c   ),.    PushPull
-0000a930: 4361 7365 280a 2020 2020 2020 2020 6e61  Case(.        na
-0000a940: 6d65 3d27 6572 726f 7220 6f6e 2070 7573  me='error on pus
-0000a950: 682f 7075 6c6c 206e 6f6e 2d65 7869 7374  h/pull non-exist
-0000a960: 696e 6720 6669 6c65 272c 0a20 2020 2020  ing file',.     
-0000a970: 2020 2070 6174 683d 272f 666f 6f2f 6261     path='/foo/ba
-0000a980: 722e 7478 7427 2c0a 2020 2020 2020 2020  r.txt',.        
-0000a990: 6473 743d 272f 6261 7a27 2c0a 2020 2020  dst='/baz',.    
-0000a9a0: 2020 2020 6669 6c65 733d 5b5d 2c0a 2020      files=[],.  
-0000a9b0: 2020 2020 2020 6572 726f 7273 3d7b 272f        errors={'/
-0000a9c0: 666f 6f2f 6261 722e 7478 7427 7d2c 0a20  foo/bar.txt'},. 
-0000a9d0: 2020 2029 2c0a 2020 2020 5075 7368 5075     ),.    PushPu
-0000a9e0: 6c6c 4361 7365 280a 2020 2020 2020 2020  llCase(.        
-0000a9f0: 6e61 6d65 3d27 7075 7368 2f70 756c 6c20  name='push/pull 
-0000aa00: 6d75 6c74 6970 6c65 206e 6f6e 2d65 7869  multiple non-exi
-0000aa10: 7374 696e 6720 6669 6c65 7327 2c0a 2020  sting files',.  
-0000aa20: 2020 2020 2020 7061 7468 3d5b 272f 666f        path=['/fo
-0000aa30: 6f2f 6261 722e 7478 7427 2c20 272f 626f  o/bar.txt', '/bo
-0000aa40: 6f2f 6661 722e 7478 7427 5d2c 0a20 2020  o/far.txt'],.   
-0000aa50: 2020 2020 2064 7374 3d27 2f62 617a 272c       dst='/baz',
-0000aa60: 0a20 2020 2020 2020 2066 696c 6573 3d5b  .        files=[
-0000aa70: 5d2c 0a20 2020 2020 2020 2065 7272 6f72  ],.        error
-0000aa80: 733d 7b27 2f66 6f6f 2f62 6172 2e74 7874  s={'/foo/bar.txt
-0000aa90: 272c 2027 2f62 6f6f 2f66 6172 2e74 7874  ', '/boo/far.txt
-0000aaa0: 277d 2c0a 2020 2020 292c 0a20 2020 2050  '},.    ),.    P
-0000aab0: 7573 6850 756c 6c43 6173 6528 0a20 2020  ushPullCase(.   
-0000aac0: 2020 2020 206e 616d 653d 2770 7573 682f       name='push/
-0000aad0: 7075 6c6c 2066 696c 6520 616e 6420 6469  pull file and di
-0000aae0: 7220 636f 6d62 6f27 2c0a 2020 2020 2020  r combo',.      
-0000aaf0: 2020 7061 7468 3d5b 272f 666f 6f2f 666f    path=['/foo/fo
-0000ab00: 6f62 6172 2e74 7874 272c 2027 2f66 6f6f  obar.txt', '/foo
-0000ab10: 2f62 6172 275d 2c0a 2020 2020 2020 2020  /bar'],.        
-0000ab20: 6473 743d 272f 6261 7a27 2c0a 2020 2020  dst='/baz',.    
-0000ab30: 2020 2020 6669 6c65 733d 5b27 2f66 6f6f      files=['/foo
-0000ab40: 2f62 6172 2f62 617a 2e74 7874 272c 2027  /bar/baz.txt', '
-0000ab50: 2f66 6f6f 2f66 6f6f 6261 722e 7478 7427  /foo/foobar.txt'
-0000ab60: 2c20 272f 7175 7578 2e74 7874 275d 2c0a  , '/quux.txt'],.
-0000ab70: 2020 2020 2020 2020 7761 6e74 3d7b 272f          want={'/
-0000ab80: 6261 7a2f 666f 6f62 6172 2e74 7874 272c  baz/foobar.txt',
-0000ab90: 2027 2f62 617a 2f62 6172 2f62 617a 2e74   '/baz/bar/baz.t
-0000aba0: 7874 277d 2c0a 2020 2020 292c 0a5d 0a0a  xt'},.    ),.]..
-0000abb0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
-0000abc0: 7261 6d65 7472 697a 6528 2763 6173 6527  rametrize('case'
-0000abd0: 2c20 7265 6375 7273 6976 655f 7075 7368  , recursive_push
-0000abe0: 5f70 756c 6c5f 6361 7365 7329 0a64 6566  _pull_cases).def
-0000abf0: 2074 6573 745f 7265 6375 7273 6976 655f   test_recursive_
-0000ac00: 7075 7368 5f61 6e64 5f70 756c 6c28 6361  push_and_pull(ca
-0000ac10: 7365 293a 0a20 2020 2023 2066 756c 6c20  se):.    # full 
-0000ac20: 2269 6e74 6567 7261 7469 6f6e 2220 7465  "integration" te
-0000ac30: 7374 206f 6620 7075 7368 2b70 756c 6c0a  st of push+pull.
-0000ac40: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
-0000ac50: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
-0000ac60: 7328 6f70 732e 6368 6172 6d2e 4368 6172  s(ops.charm.Char
-0000ac70: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-0000ac80: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-0000ac90: 7374 2d61 7070 0a20 2020 2020 2020 2063  st-app.        c
-0000aca0: 6f6e 7461 696e 6572 733a 0a20 2020 2020  ontainers:.     
-0000acb0: 2020 2020 2066 6f6f 3a0a 2020 2020 2020       foo:.      
-0000acc0: 2020 2020 2020 7265 736f 7572 6365 3a20        resource: 
-0000acd0: 666f 6f2d 696d 6167 650a 2020 2020 2020  foo-image.      
-0000ace0: 2020 2727 2729 0a20 2020 2068 6172 6e65    ''').    harne
-0000acf0: 7373 2e62 6567 696e 2829 0a20 2020 2068  ss.begin().    h
-0000ad00: 6172 6e65 7373 2e73 6574 5f63 616e 5f63  arness.set_can_c
-0000ad10: 6f6e 6e65 6374 2827 666f 6f27 2c20 5472  onnect('foo', Tr
-0000ad20: 7565 290a 2020 2020 6320 3d20 6861 726e  ue).    c = harn
-0000ad30: 6573 732e 6d6f 6465 6c2e 756e 6974 2e63  ess.model.unit.c
-0000ad40: 6f6e 7461 696e 6572 735b 2766 6f6f 275d  ontainers['foo']
-0000ad50: 0a0a 2020 2020 2320 6372 6561 7465 2070  ..    # create p
-0000ad60: 7573 6820 7465 7374 2063 6173 6520 6669  ush test case fi
-0000ad70: 6c65 7379 7374 656d 2073 7472 7563 7475  lesystem structu
-0000ad80: 7265 0a20 2020 2070 7573 685f 7372 6320  re.    push_src 
-0000ad90: 3d20 7465 6d70 6669 6c65 2e54 656d 706f  = tempfile.Tempo
-0000ada0: 7261 7279 4469 7265 6374 6f72 7928 290a  raryDirectory().
-0000adb0: 2020 2020 666f 7220 6669 6c65 2069 6e20      for file in 
-0000adc0: 6361 7365 2e66 696c 6573 3a0a 2020 2020  case.files:.    
-0000add0: 2020 2020 6670 6174 6820 3d20 6f73 2e70      fpath = os.p
-0000ade0: 6174 682e 6a6f 696e 2870 7573 685f 7372  ath.join(push_sr
-0000adf0: 632e 6e61 6d65 2c20 6669 6c65 5b31 3a5d  c.name, file[1:]
-0000ae00: 290a 2020 2020 2020 2020 6f73 2e6d 616b  ).        os.mak
-0000ae10: 6564 6972 7328 6f73 2e70 6174 682e 6469  edirs(os.path.di
-0000ae20: 726e 616d 6528 6670 6174 6829 2c20 6578  rname(fpath), ex
-0000ae30: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
-0000ae40: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
-0000ae50: 7061 7468 2c20 2777 2729 2061 7320 663a  path, 'w') as f:
-0000ae60: 0a20 2020 2020 2020 2020 2020 2066 2e77  .            f.w
-0000ae70: 7269 7465 2827 6865 6c6c 6f27 290a 0a20  rite('hello').. 
-0000ae80: 2020 2023 2074 6573 7420 7075 7368 0a20     # test push. 
-0000ae90: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000aea0: 2863 6173 652e 7061 7468 2c20 6c69 7374  (case.path, list
-0000aeb0: 293a 0a20 2020 2020 2020 2023 2073 7761  ):.        # swa
-0000aec0: 7020 736c 6173 6820 666f 7220 6475 6d6d  p slash for dumm
-0000aed0: 7920 6469 7220 6f6e 2072 6f6f 7420 6469  y dir on root di
-0000aee0: 7220 736f 2050 6174 682e 7061 7265 6e74  r so Path.parent
-0000aef0: 2064 6f65 736e 2774 2072 6574 7572 6e20   doesn't return 
-0000af00: 746d 7064 6972 2070 6174 6820 636f 6d70  tmpdir path comp
-0000af10: 6f6e 656e 740a 2020 2020 2020 2020 2320  onent.        # 
-0000af20: 6f74 6865 7277 6973 6520 7265 6d6f 7665  otherwise remove
-0000af30: 206c 6561 6469 6e67 2073 6c61 7368 2073   leading slash s
-0000af40: 6f20 7765 2063 616e 2064 6f20 7468 6520  o we can do the 
-0000af50: 7061 7468 206a 6f69 6e20 7072 6f70 6572  path join proper
-0000af60: 6c79 2e0a 2020 2020 2020 2020 7075 7368  ly..        push
-0000af70: 5f70 6174 6820 3d20 5b6f 732e 7061 7468  _path = [os.path
-0000af80: 2e6a 6f69 6e28 7075 7368 5f73 7263 2e6e  .join(push_src.n
-0000af90: 616d 652c 2070 5b31 3a5d 2069 6620 6c65  ame, p[1:] if le
-0000afa0: 6e28 7029 203e 2031 2065 6c73 6520 2766  n(p) > 1 else 'f
-0000afb0: 6f6f 2729 0a20 2020 2020 2020 2020 2020  oo').           
-0000afc0: 2020 2020 2020 2020 2020 666f 7220 7020            for p 
-0000afd0: 696e 2063 6173 652e 7061 7468 5d0a 2020  in case.path].  
-0000afe0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000aff0: 2320 7377 6170 2073 6c61 7368 2066 6f72  # swap slash for
-0000b000: 2064 756d 6d79 2064 6972 206f 6e20 726f   dummy dir on ro
-0000b010: 6f74 2064 6972 2073 6f20 5061 7468 2e70  ot dir so Path.p
-0000b020: 6172 656e 7420 646f 6573 6e27 7420 7265  arent doesn't re
-0000b030: 7475 726e 2074 6d70 6469 7220 7061 7468  turn tmpdir path
-0000b040: 2063 6f6d 706f 6e65 6e74 0a20 2020 2020   component.     
-0000b050: 2020 2023 206f 7468 6572 7769 7365 2072     # otherwise r
-0000b060: 656d 6f76 6520 6c65 6164 696e 6720 736c  emove leading sl
-0000b070: 6173 6820 736f 2077 6520 6361 6e20 646f  ash so we can do
-0000b080: 2074 6865 2070 6174 6820 6a6f 696e 2070   the path join p
-0000b090: 726f 7065 726c 792e 0a20 2020 2020 2020  roperly..       
-0000b0a0: 2070 7573 685f 7061 7468 203d 206f 732e   push_path = os.
-0000b0b0: 7061 7468 2e6a 6f69 6e28 7075 7368 5f73  path.join(push_s
-0000b0c0: 7263 2e6e 616d 652c 2063 6173 652e 7061  rc.name, case.pa
-0000b0d0: 7468 5b31 3a5d 2069 6620 6c65 6e28 6361  th[1:] if len(ca
-0000b0e0: 7365 2e70 6174 6829 203e 2031 2065 6c73  se.path) > 1 els
-0000b0f0: 6520 2766 6f6f 2729 0a0a 2020 2020 6572  e 'foo')..    er
-0000b100: 726f 7273 203d 205b 5d0a 2020 2020 7472  rors = [].    tr
-0000b110: 793a 0a20 2020 2020 2020 2063 2e70 7573  y:.        c.pus
-0000b120: 685f 7061 7468 2870 7573 685f 7061 7468  h_path(push_path
-0000b130: 2c20 6361 7365 2e64 7374 290a 2020 2020  , case.dst).    
-0000b140: 6578 6365 7074 206f 7073 2e6d 6f64 656c  except ops.model
-0000b150: 2e4d 756c 7469 5075 7368 5075 6c6c 4572  .MultiPushPullEr
-0000b160: 726f 7220 6173 2065 7272 3a0a 2020 2020  ror as err:.    
-0000b170: 2020 2020 6966 206e 6f74 2063 6173 652e      if not case.
-0000b180: 6572 726f 7273 3a0a 2020 2020 2020 2020  errors:.        
-0000b190: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
-0000b1a0: 2020 6572 726f 7273 203d 207b 7372 635b    errors = {src[
-0000b1b0: 6c65 6e28 7075 7368 5f73 7263 2e6e 616d  len(push_src.nam
-0000b1c0: 6529 3a5d 2066 6f72 2073 7263 2c20 5f20  e):] for src, _ 
-0000b1d0: 696e 2065 7272 2e65 7272 6f72 737d 0a0a  in err.errors}..
-0000b1e0: 2020 2020 6173 7365 7274 2063 6173 652e      assert case.
-0000b1f0: 6572 726f 7273 203d 3d20 6572 726f 7273  errors == errors
-0000b200: 2c20 5c0a 2020 2020 2020 2020 6627 7075  , \.        f'pu
-0000b210: 7368 5f70 6174 6820 6761 7665 2077 726f  sh_path gave wro
-0000b220: 6e67 2065 7870 6563 7465 6420 6572 726f  ng expected erro
-0000b230: 7273 3a20 7761 6e74 207b 6361 7365 2e65  rs: want {case.e
-0000b240: 7272 6f72 737d 2c20 676f 7420 7b65 7272  rrors}, got {err
-0000b250: 6f72 737d 270a 2020 2020 666f 7220 6670  ors}'.    for fp
-0000b260: 6174 6820 696e 2063 6173 652e 7761 6e74  ath in case.want
-0000b270: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-0000b280: 2063 2e65 7869 7374 7328 6670 6174 6829   c.exists(fpath)
-0000b290: 2c20 6627 7075 7368 5f70 6174 6820 6661  , f'push_path fa
-0000b2a0: 696c 6564 3a20 6669 6c65 207b 6670 6174  iled: file {fpat
-0000b2b0: 687d 206d 6973 7369 6e67 2061 7420 6465  h} missing at de
-0000b2c0: 7374 696e 6174 696f 6e27 0a0a 2020 2020  stination'..    
-0000b2d0: 2320 6372 6561 7465 2070 756c 6c20 7465  # create pull te
-0000b2e0: 7374 2063 6173 6520 6669 6c65 7379 7374  st case filesyst
-0000b2f0: 656d 2073 7472 7563 7475 7265 0a20 2020  em structure.   
-0000b300: 2070 756c 6c5f 6473 7420 3d20 7465 6d70   pull_dst = temp
-0000b310: 6669 6c65 2e54 656d 706f 7261 7279 4469  file.TemporaryDi
-0000b320: 7265 6374 6f72 7928 290a 2020 2020 666f  rectory().    fo
-0000b330: 7220 6670 6174 6820 696e 2063 6173 652e  r fpath in case.
-0000b340: 6669 6c65 733a 0a20 2020 2020 2020 2063  files:.        c
-0000b350: 2e70 7573 6828 6670 6174 682c 2027 6865  .push(fpath, 'he
-0000b360: 6c6c 6f27 2c20 6d61 6b65 5f64 6972 733d  llo', make_dirs=
-0000b370: 5472 7565 290a 0a20 2020 2023 2074 6573  True)..    # tes
-0000b380: 7420 7075 6c6c 0a20 2020 2065 7272 6f72  t pull.    error
-0000b390: 7320 3d20 5b5d 0a20 2020 2074 7279 3a0a  s = [].    try:.
-0000b3a0: 2020 2020 2020 2020 632e 7075 6c6c 5f70          c.pull_p
-0000b3b0: 6174 6828 6361 7365 2e70 6174 682c 206f  ath(case.path, o
-0000b3c0: 732e 7061 7468 2e6a 6f69 6e28 7075 6c6c  s.path.join(pull
-0000b3d0: 5f64 7374 2e6e 616d 652c 2063 6173 652e  _dst.name, case.
-0000b3e0: 6473 745b 313a 5d29 290a 2020 2020 6578  dst[1:])).    ex
-0000b3f0: 6365 7074 206f 7073 2e6d 6f64 656c 2e4d  cept ops.model.M
-0000b400: 756c 7469 5075 7368 5075 6c6c 4572 726f  ultiPushPullErro
-0000b410: 7220 6173 2065 7272 3a0a 2020 2020 2020  r as err:.      
-0000b420: 2020 6966 206e 6f74 2063 6173 652e 6572    if not case.er
-0000b430: 726f 7273 3a0a 2020 2020 2020 2020 2020  rors:.          
-0000b440: 2020 7261 6973 650a 2020 2020 2020 2020    raise.        
-0000b450: 6572 726f 7273 203d 207b 7372 6320 666f  errors = {src fo
-0000b460: 7220 7372 632c 205f 2069 6e20 6572 722e  r src, _ in err.
-0000b470: 6572 726f 7273 7d0a 0a20 2020 2061 7373  errors}..    ass
-0000b480: 6572 7420 6361 7365 2e65 7272 6f72 7320  ert case.errors 
-0000b490: 3d3d 2065 7272 6f72 732c 205c 0a20 2020  == errors, \.   
-0000b4a0: 2020 2020 2066 2770 756c 6c5f 7061 7468       f'pull_path
-0000b4b0: 2067 6176 6520 7772 6f6e 6720 6578 7065   gave wrong expe
-0000b4c0: 6374 6564 2065 7272 6f72 733a 2077 616e  cted errors: wan
-0000b4d0: 7420 7b63 6173 652e 6572 726f 7273 7d2c  t {case.errors},
-0000b4e0: 2067 6f74 207b 6572 726f 7273 7d27 0a20   got {errors}'. 
-0000b4f0: 2020 2066 6f72 2066 7061 7468 2069 6e20     for fpath in 
-0000b500: 6361 7365 2e77 616e 743a 0a20 2020 2020  case.want:.     
-0000b510: 2020 2061 7373 6572 7420 632e 6578 6973     assert c.exis
-0000b520: 7473 2866 7061 7468 292c 2066 2770 756c  ts(fpath), f'pul
-0000b530: 6c5f 7061 7468 2066 6169 6c65 643a 2066  l_path failed: f
-0000b540: 696c 6520 7b66 7061 7468 7d20 6d69 7373  ile {fpath} miss
-0000b550: 696e 6720 6174 2064 6573 7469 6e61 7469  ing at destinati
-0000b560: 6f6e 270a 0a0a 636c 6173 7320 5465 7374  on'...class Test
-0000b570: 4170 706c 6963 6174 696f 6e28 756e 6974  Application(unit
-0000b580: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
-0000b590: 0a20 2020 2064 6566 2073 6574 5570 2873  .    def setUp(s
-0000b5a0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000b5b0: 6c66 2e68 6172 6e65 7373 203d 206f 7073  lf.harness = ops
-0000b5c0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
-0000b5d0: 286f 7073 2e63 6861 726d 2e43 6861 726d  (ops.charm.Charm
-0000b5e0: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-0000b5f0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000b600: 206d 7961 7070 0a20 2020 2020 2020 2020   myapp.         
-0000b610: 2020 2070 726f 7669 6465 733a 0a20 2020     provides:.   
-0000b620: 2020 2020 2020 2020 2020 2064 6230 3a0a             db0:.
-0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b640: 696e 7465 7266 6163 653a 2064 6230 0a20  interface: db0. 
-0000b650: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-0000b660: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-0000b670: 2020 2064 6231 3a0a 2020 2020 2020 2020     db1:.        
-0000b680: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-0000b690: 653a 2064 6231 0a20 2020 2020 2020 2020  e: db1.         
-0000b6a0: 2020 2070 6565 7273 3a0a 2020 2020 2020     peers:.      
-0000b6b0: 2020 2020 2020 2020 6462 323a 0a20 2020          db2:.   
-0000b6c0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-0000b6d0: 6572 6661 6365 3a20 6462 320a 2020 2020  erface: db2.    
-0000b6e0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0000b6f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000b700: 2066 6f6f 3a20 7b74 7970 653a 2066 696c   foo: {type: fil
-0000b710: 652c 2066 696c 656e 616d 653a 2066 6f6f  e, filename: foo
-0000b720: 2e74 7874 7d0a 2020 2020 2020 2020 2020  .txt}.          
-0000b730: 2020 2020 6261 723a 207b 7479 7065 3a20      bar: {type: 
-0000b740: 6669 6c65 2c20 6669 6c65 6e61 6d65 3a20  file, filename: 
-0000b750: 6261 722e 7478 747d 0a20 2020 2020 2020  bar.txt}.       
-0000b760: 2020 2020 2063 6f6e 7461 696e 6572 733a       containers:
-0000b770: 0a20 2020 2020 2020 2020 2020 2020 2062  .              b
-0000b780: 6172 3a0a 2020 2020 2020 2020 2020 2020  ar:.            
-0000b790: 2020 2020 6b3a 2076 0a20 2020 2020 2020      k: v.       
-0000b7a0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-0000b7b0: 6c66 2e70 6565 725f 7265 6c5f 6964 203d  lf.peer_rel_id =
-0000b7c0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-0000b7d0: 645f 7265 6c61 7469 6f6e 2827 6462 3227  d_relation('db2'
-0000b7e0: 2c20 2764 6232 2729 0a20 2020 2020 2020  , 'db2').       
-0000b7f0: 2073 656c 662e 6170 7020 3d20 7365 6c66   self.app = self
-0000b800: 2e68 6172 6e65 7373 2e6d 6f64 656c 2e61  .harness.model.a
-0000b810: 7070 0a20 2020 2020 2020 2073 656c 662e  pp.        self.
-0000b820: 6164 6443 6c65 616e 7570 2873 656c 662e  addCleanup(self.
-0000b830: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-0000b840: 0a0a 2020 2020 2320 5465 7374 7320 6669  ..    # Tests fi
-0000b850: 7820 666f 7220 6874 7470 733a 2f2f 6769  x for https://gi
-0000b860: 7468 7562 2e63 6f6d 2f63 616e 6f6e 6963  thub.com/canonic
-0000b870: 616c 2f6f 7065 7261 746f 722f 6973 7375  al/operator/issu
-0000b880: 6573 2f36 3934 2e0a 2020 2020 6465 6620  es/694..    def 
-0000b890: 7465 7374 5f6d 6f63 6b65 645f 6765 745f  test_mocked_get_
-0000b8a0: 7365 7276 6963 6573 2873 656c 6629 3a0a  services(self):.
-0000b8b0: 2020 2020 2020 2020 7365 6c66 2e68 6172          self.har
-0000b8c0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
-0000b8d0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
-0000b8e0: 732e 7365 745f 6361 6e5f 636f 6e6e 6563  s.set_can_connec
-0000b8f0: 7428 2762 6172 272c 2054 7275 6529 0a20  t('bar', True). 
-0000b900: 2020 2020 2020 2063 203d 2073 656c 662e         c = self.
-0000b910: 6861 726e 6573 732e 6368 6172 6d2e 756e  harness.charm.un
-0000b920: 6974 2e67 6574 5f63 6f6e 7461 696e 6572  it.get_container
-0000b930: 2827 6261 7227 290a 2020 2020 2020 2020  ('bar').        
-0000b940: 632e 6164 645f 6c61 7965 7228 276c 6179  c.add_layer('lay
-0000b950: 6572 3127 2c20 7b0a 2020 2020 2020 2020  er1', {.        
-0000b960: 2020 2020 2773 756d 6d61 7279 273a 2027      'summary': '
-0000b970: 6c61 7965 7227 2c0a 2020 2020 2020 2020  layer',.        
-0000b980: 2020 2020 2773 6572 7669 6365 7327 3a20      'services': 
-0000b990: 7b22 6261 7a22 3a20 7b27 6f76 6572 7269  {"baz": {'overri
-0000b9a0: 6465 273a 2027 7265 706c 6163 6527 2c20  de': 'replace', 
-0000b9b0: 2773 756d 6d61 7279 273a 2027 6563 686f  'summary': 'echo
-0000b9c0: 272c 2027 636f 6d6d 616e 6427 3a20 2765  ', 'command': 'e
-0000b9d0: 6368 6f20 3127 7d7d 2c0a 2020 2020 2020  cho 1'}},.      
-0000b9e0: 2020 7d29 0a0a 2020 2020 2020 2020 7320    })..        s 
-0000b9f0: 3d20 632e 6765 745f 7365 7276 6963 6528  = c.get_service(
-0000ba00: 2762 617a 2729 2020 2320 536f 2066 6172  'baz')  # So far
-0000ba10: 2c20 736f 2067 6f6f 640a 2020 2020 2020  , so good.      
-0000ba20: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000ba30: 6528 7329 0a20 2020 2020 2020 2073 656c  e(s).        sel
-0000ba40: 662e 6173 7365 7274 5472 7565 2827 6261  f.assertTrue('ba
-0000ba50: 7a27 2069 6e20 632e 6765 745f 7365 7276  z' in c.get_serv
-0000ba60: 6963 6573 2829 290a 0a20 2020 2064 6566  ices())..    def
-0000ba70: 2074 6573 745f 706c 616e 6e65 645f 756e   test_planned_un
-0000ba80: 6974 7328 7365 6c66 293a 0a20 2020 2020  its(self):.     
-0000ba90: 2020 2072 656c 5f69 6420 3d20 7365 6c66     rel_id = self
-0000baa0: 2e70 6565 725f 7265 6c5f 6964 0a0a 2020  .peer_rel_id..  
-0000bab0: 2020 2020 2020 2320 5465 7374 2074 6861        # Test tha
-0000bac0: 7420 7765 2061 6c77 6179 7320 636f 756e  t we always coun
-0000bad0: 7420 6f75 7273 656c 662e 0a20 2020 2020  t ourself..     
-0000bae0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000baf0: 7561 6c28 7365 6c66 2e61 7070 2e70 6c61  ual(self.app.pla
-0000bb00: 6e6e 6564 5f75 6e69 7473 2829 2c20 3129  nned_units(), 1)
-0000bb10: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
-0000bb20: 736f 6d65 2075 6e69 7473 2c20 616e 6420  some units, and 
-0000bb30: 7665 7269 6679 2063 6f75 6e74 2e0a 2020  verify count..  
-0000bb40: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000bb50: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-0000bb60: 756e 6974 2872 656c 5f69 642c 2027 6d79  unit(rel_id, 'my
-0000bb70: 6170 702f 3127 290a 2020 2020 2020 2020  app/1').        
-0000bb80: 7365 6c66 2e68 6172 6e65 7373 2e61 6464  self.harness.add
-0000bb90: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-0000bba0: 656c 5f69 642c 2027 6d79 6170 702f 3227  el_id, 'myapp/2'
-0000bbb0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000bbc0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000bbd0: 2e61 7070 2e70 6c61 6e6e 6564 5f75 6e69  .app.planned_uni
-0000bbe0: 7473 2829 2c20 3329 0a0a 2020 2020 2020  ts(), 3)..      
-0000bbf0: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
-0000bc00: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
-0000bc10: 2872 656c 5f69 642c 2027 6d79 6170 702f  (rel_id, 'myapp/
-0000bc20: 3327 290a 2020 2020 2020 2020 7365 6c66  3').        self
-0000bc30: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000bc40: 662e 6170 702e 706c 616e 6e65 645f 756e  f.app.planned_un
-0000bc50: 6974 7328 292c 2034 290a 0a20 2020 2020  its(), 4)..     
-0000bc60: 2020 2023 2041 6e64 2072 656d 6f76 6520     # And remove 
-0000bc70: 6120 756e 6974 0a20 2020 2020 2020 2073  a unit.        s
-0000bc80: 656c 662e 6861 726e 6573 732e 7265 6d6f  elf.harness.remo
-0000bc90: 7665 5f72 656c 6174 696f 6e5f 756e 6974  ve_relation_unit
-0000bca0: 2872 656c 5f69 642c 2027 6d79 6170 702f  (rel_id, 'myapp/
-0000bcb0: 3227 290a 0a20 2020 2020 2020 2073 656c  2')..        sel
-0000bcc0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000bcd0: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
-0000bce0: 6e69 7473 2829 2c20 3329 0a0a 2020 2020  nits(), 3)..    
-0000bcf0: 6465 6620 7465 7374 5f70 6c61 6e6e 6564  def test_planned
-0000bd00: 5f75 6e69 7473 5f75 7365 725f 7365 7428  _units_user_set(
-0000bd10: 7365 6c66 293a 0a0a 2020 2020 2020 2020  self):..        
-0000bd20: 7365 6c66 2e68 6172 6e65 7373 2e73 6574  self.harness.set
-0000bd30: 5f70 6c61 6e6e 6564 5f75 6e69 7473 2831  _planned_units(1
-0000bd40: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000bd50: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000bd60: 6170 702e 706c 616e 6e65 645f 756e 6974  app.planned_unit
-0000bd70: 7328 292c 2031 290a 0a20 2020 2020 2020  s(), 1)..       
-0000bd80: 2073 656c 662e 6861 726e 6573 732e 7365   self.harness.se
-0000bd90: 745f 706c 616e 6e65 645f 756e 6974 7328  t_planned_units(
-0000bda0: 3229 0a20 2020 2020 2020 2073 656c 662e  2).        self.
-0000bdb0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000bdc0: 2e61 7070 2e70 6c61 6e6e 6564 5f75 6e69  .app.planned_uni
-0000bdd0: 7473 2829 2c20 3229 0a0a 2020 2020 2020  ts(), 2)..      
-0000bde0: 2020 7365 6c66 2e68 6172 6e65 7373 2e73    self.harness.s
-0000bdf0: 6574 5f70 6c61 6e6e 6564 5f75 6e69 7473  et_planned_units
-0000be00: 2831 3030 290a 2020 2020 2020 2020 7365  (100).        se
-0000be10: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000be20: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
-0000be30: 756e 6974 7328 292c 2031 3030 290a 0a20  units(), 100).. 
-0000be40: 2020 2064 6566 2074 6573 745f 706c 616e     def test_plan
-0000be50: 6e65 645f 756e 6974 735f 6761 7262 6167  ned_units_garbag
-0000be60: 655f 7661 6c75 6573 2873 656c 6629 3a0a  e_values(self):.
-0000be70: 2020 2020 2020 2020 2320 506c 616e 6e65          # Planne
-0000be80: 6420 756e 6974 7320 7368 6f75 6c64 2062  d units should b
-0000be90: 6520 6120 706f 7369 7469 7665 2069 6e74  e a positive int
-0000bea0: 6567 6572 2c20 6f72 207a 6572 6f2e 0a20  eger, or zero.. 
-0000beb0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0000bec0: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
-0000bed0: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
-0000bee0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000bef0: 7373 2e73 6574 5f70 6c61 6e6e 6564 5f75  ss.set_planned_u
-0000bf00: 6e69 7473 282d 3129 0a20 2020 2020 2020  nits(-1).       
-0000bf10: 2023 2056 6572 6966 7920 7468 6174 2077   # Verify that w
-0000bf20: 6520 6469 646e 2774 2073 6574 206f 7572  e didn't set our
-0000bf30: 2076 616c 7565 2062 6566 6f72 6520 7261   value before ra
-0000bf40: 6973 696e 6720 7468 6520 6572 726f 722e  ising the error.
-0000bf50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000bf60: 7365 7274 5472 7565 2873 656c 662e 6861  sertTrue(self.ha
-0000bf70: 726e 6573 732e 5f62 6163 6b65 6e64 2e5f  rness._backend._
-0000bf80: 706c 616e 6e65 645f 756e 6974 7320 6973  planned_units is
-0000bf90: 204e 6f6e 6529 0a20 2020 2020 2020 2023   None).        #
-0000bfa0: 2056 6572 6966 7920 7468 6174 2077 6520   Verify that we 
-0000bfb0: 7374 696c 6c20 6765 7420 7468 6520 6465  still get the de
-0000bfc0: 6661 756c 7420 7661 6c75 6520 6261 636b  fault value back
-0000bfd0: 2066 726f 6d20 2e70 6c61 6e6e 6564 5f75   from .planned_u
-0000bfe0: 6e69 7473 2e0a 2020 2020 2020 2020 7365  nits..        se
-0000bff0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000c000: 656c 662e 6170 702e 706c 616e 6e65 645f  elf.app.planned_
-0000c010: 756e 6974 7328 292c 2031 290a 0a20 2020  units(), 1)..   
-0000c020: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000c030: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-0000c040: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0000c050: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
-0000c060: 2e73 6574 5f70 6c61 6e6e 6564 5f75 6e69  .set_planned_uni
-0000c070: 7473 2822 666f 6f22 290a 0a20 2020 2020  ts("foo")..     
-0000c080: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000c090: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-0000c0a0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000c0b0: 2020 7365 6c66 2e68 6172 6e65 7373 2e73    self.harness.s
-0000c0c0: 6574 5f70 6c61 6e6e 6564 5f75 6e69 7473  et_planned_units
-0000c0d0: 282d 3334 3233 3030 3031 3032 3331 3233  (-34230001023123
-0000c0e0: 3231 3039 3029 0a0a 2020 2020 6465 6620  21090)..    def 
-0000c0f0: 7465 7374 5f70 6c61 6e6e 6564 5f75 6e69  test_planned_uni
-0000c100: 7473 5f6f 7665 7272 6964 6528 7365 6c66  ts_override(self
-0000c110: 293a 0a20 2020 2020 2020 2022 2222 5665  ):.        """Ve
-0000c120: 7269 6679 2074 6861 7420 7765 206f 7665  rify that we ove
-0000c130: 7272 6964 6520 7468 6520 6361 6c63 756c  rride the calcul
-0000c140: 6174 6564 2076 616c 7565 206f 6620 706c  ated value of pl
-0000c150: 616e 6e65 645f 756e 6974 7320 7768 656e  anned_units when
-0000c160: 2077 6520 7365 7420 6974 206d 616e 7561   we set it manua
-0000c170: 6c6c 792e 0a0a 2020 2020 2020 2020 5768  lly...        Wh
-0000c180: 656e 2061 2063 6861 726d 2061 7574 686f  en a charm autho
-0000c190: 7220 7772 6974 6573 2061 2074 6573 7420  r writes a test 
-0000c1a0: 7468 6174 2065 7870 6c69 6369 746c 7920  that explicitly 
-0000c1b0: 6361 6c6c 7320 7365 745f 706c 616e 6e65  calls set_planne
-0000c1c0: 645f 756e 6974 732c 2077 6520 6173 7375  d_units, we assu
-0000c1d0: 6d65 2074 6861 740a 2020 2020 2020 2020  me that.        
-0000c1e0: 7468 6569 7220 696e 7465 6e74 2069 7320  their intent is 
-0000c1f0: 746f 206f 7665 7272 6964 6520 7468 6520  to override the 
-0000c200: 6361 6c63 756c 6174 6564 2072 6574 7572  calculated retur
-0000c210: 6e20 7661 6c75 652e 204f 6674 656e 2c20  n value. Often, 
-0000c220: 7468 6973 2077 696c 6c20 6265 2062 6563  this will be bec
-0000c230: 6175 7365 2074 6865 0a20 2020 2020 2020  ause the.       
-0000c240: 2063 6861 726d 2061 7574 686f 7220 6973   charm author is
-0000c250: 2063 6f6d 706f 7369 6e67 2061 2063 6861   composing a cha
-0000c260: 726d 2077 6974 686f 7574 2070 6565 7220  rm without peer 
-0000c270: 7265 6c61 7469 6f6e 732c 2061 6e64 2074  relations, and t
-0000c280: 6865 2068 6172 6e65 7373 2773 2063 6f75  he harness's cou
-0000c290: 6e74 206f 660a 2020 2020 2020 2020 706c  nt of.        pl
-0000c2a0: 616e 6e65 6420 756e 6974 732c 2077 6869  anned units, whi
-0000c2b0: 6368 2069 7320 6261 7365 6420 6f6e 2074  ch is based on t
-0000c2c0: 6865 206e 756d 6265 7220 6f66 2070 6565  he number of pee
-0000c2d0: 7220 7265 6c61 7469 6f6e 732c 2077 696c  r relations, wil
-0000c2e0: 6c20 6e6f 7420 6265 2061 6363 7572 6174  l not be accurat
-0000c2f0: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-0000c300: 2020 2020 2020 2070 6565 725f 6964 203d         peer_id =
-0000c310: 2073 656c 662e 7065 6572 5f72 656c 5f69   self.peer_rel_i
-0000c320: 640a 0a20 2020 2020 2020 2073 656c 662e  d..        self.
-0000c330: 6861 726e 6573 732e 7365 745f 706c 616e  harness.set_plan
-0000c340: 6e65 645f 756e 6974 7328 3130 290a 2020  ned_units(10).  
-0000c350: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
-0000c360: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-0000c370: 756e 6974 2870 6565 725f 6964 2c20 276d  unit(peer_id, 'm
-0000c380: 7961 7070 2f31 2729 0a20 2020 2020 2020  yapp/1').       
-0000c390: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
-0000c3a0: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
-0000c3b0: 7065 6572 5f69 642c 2027 6d79 6170 702f  peer_id, 'myapp/
-0000c3c0: 3227 290a 2020 2020 2020 2020 7365 6c66  2').        self
-0000c3d0: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
-0000c3e0: 6174 696f 6e5f 756e 6974 2870 6565 725f  ation_unit(peer_
-0000c3f0: 6964 2c20 276d 7961 7070 2f33 2729 0a0a  id, 'myapp/3')..
-0000c400: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000c410: 6572 7445 7175 616c 2873 656c 662e 6170  ertEqual(self.ap
-0000c420: 702e 706c 616e 6e65 645f 756e 6974 7328  p.planned_units(
-0000c430: 292c 2031 3029 0a0a 2020 2020 2020 2020  ), 10)..        
-0000c440: 2320 5665 7269 6679 2074 6861 7420 7765  # Verify that we
-0000c450: 2063 616e 2063 6c65 6172 2074 6865 206f   can clear the o
-0000c460: 7665 7272 6964 652e 0a20 2020 2020 2020  verride..       
-0000c470: 2073 656c 662e 6861 726e 6573 732e 7265   self.harness.re
-0000c480: 7365 745f 706c 616e 6e65 645f 756e 6974  set_planned_unit
-0000c490: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-0000c4a0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000c4b0: 662e 6170 702e 706c 616e 6e65 645f 756e  f.app.planned_un
-0000c4c0: 6974 7328 292c 2034 2920 2023 2073 656c  its(), 4)  # sel
-0000c4d0: 6620 2b20 3320 7065 6572 730a 0a0a 636c  f + 3 peers...cl
-0000c4e0: 6173 7320 5465 7374 436f 6e74 6169 6e65  ass TestContaine
-0000c4f0: 7273 2875 6e69 7474 6573 742e 5465 7374  rs(unittest.Test
-0000c500: 4361 7365 293a 0a20 2020 2064 6566 2073  Case):.    def s
-0000c510: 6574 5570 2873 656c 6629 3a0a 2020 2020  etUp(self):.    
-0000c520: 2020 2020 6d65 7461 203d 206f 7073 2e63      meta = ops.c
-0000c530: 6861 726d 2e43 6861 726d 4d65 7461 2e66  harm.CharmMeta.f
-0000c540: 726f 6d5f 7961 6d6c 2822 2222 0a6e 616d  rom_yaml(""".nam
-0000c550: 653a 206b 3873 2d63 6861 726d 0a63 6f6e  e: k8s-charm.con
-0000c560: 7461 696e 6572 733a 0a20 2063 313a 0a20  tainers:.  c1:. 
-0000c570: 2020 206b 3a20 760a 2020 6332 3a0a 2020     k: v.  c2:.  
-0000c580: 2020 6b3a 2076 0a22 2222 290a 2020 2020    k: v.""").    
-0000c590: 2020 2020 6261 636b 656e 6420 3d20 6f70      backend = op
-0000c5a0: 732e 6d6f 6465 6c2e 5f4d 6f64 656c 4261  s.model._ModelBa
-0000c5b0: 636b 656e 6428 276d 7961 7070 2f30 2729  ckend('myapp/0')
-0000c5c0: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
-0000c5d0: 6465 6c20 3d20 6f70 732e 6d6f 6465 6c2e  del = ops.model.
-0000c5e0: 4d6f 6465 6c28 6d65 7461 2c20 6261 636b  Model(meta, back
-0000c5f0: 656e 6429 0a0a 2020 2020 6465 6620 7465  end)..    def te
-0000c600: 7374 5f75 6e69 745f 636f 6e74 6169 6e65  st_unit_containe
-0000c610: 7273 2873 656c 6629 3a0a 2020 2020 2020  rs(self):.      
-0000c620: 2020 636f 6e74 6169 6e65 7273 203d 2073    containers = s
-0000c630: 656c 662e 6d6f 6465 6c2e 756e 6974 2e63  elf.model.unit.c
-0000c640: 6f6e 7461 696e 6572 730a 2020 2020 2020  ontainers.      
-0000c650: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000c660: 616c 2873 6f72 7465 6428 636f 6e74 6169  al(sorted(contai
-0000c670: 6e65 7273 292c 205b 2763 3127 2c20 2763  ners), ['c1', 'c
-0000c680: 3227 5d29 0a20 2020 2020 2020 2073 656c  2']).        sel
-0000c690: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-0000c6a0: 6e28 636f 6e74 6169 6e65 7273 292c 2032  n(containers), 2
-0000c6b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000c6c0: 7373 6572 7449 6e28 2763 3127 2c20 636f  ssertIn('c1', co
-0000c6d0: 6e74 6169 6e65 7273 290a 2020 2020 2020  ntainers).      
-0000c6e0: 2020 7365 6c66 2e61 7373 6572 7449 6e28    self.assertIn(
-0000c6f0: 2763 3227 2c20 636f 6e74 6169 6e65 7273  'c2', containers
-0000c700: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000c710: 7373 6572 744e 6f74 496e 2827 6333 272c  ssertNotIn('c3',
-0000c720: 2063 6f6e 7461 696e 6572 7329 0a20 2020   containers).   
-0000c730: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
-0000c740: 205b 2763 3127 2c20 2763 3227 5d3a 0a20   ['c1', 'c2']:. 
-0000c750: 2020 2020 2020 2020 2020 2063 6f6e 7461             conta
-0000c760: 696e 6572 203d 2063 6f6e 7461 696e 6572  iner = container
-0000c770: 735b 6e61 6d65 5d0a 2020 2020 2020 2020  s[name].        
-0000c780: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0000c790: 7349 6e73 7461 6e63 6528 636f 6e74 6169  sInstance(contai
-0000c7a0: 6e65 722c 206f 7073 2e6d 6f64 656c 2e43  ner, ops.model.C
-0000c7b0: 6f6e 7461 696e 6572 290a 2020 2020 2020  ontainer).      
-0000c7c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000c7d0: 7445 7175 616c 2863 6f6e 7461 696e 6572  tEqual(container
-0000c7e0: 2e6e 616d 652c 206e 616d 6529 0a20 2020  .name, name).   
-0000c7f0: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-0000c800: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
-0000c810: 6f6e 7461 696e 6572 2e70 6562 626c 652c  ontainer.pebble,
-0000c820: 206f 7073 2e70 6562 626c 652e 436c 6965   ops.pebble.Clie
-0000c830: 6e74 290a 2020 2020 2020 2020 7769 7468  nt).        with
-0000c840: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000c850: 6573 284b 6579 4572 726f 7229 3a0a 2020  es(KeyError):.  
-0000c860: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
-0000c870: 6e65 7273 5b27 6333 275d 0a0a 2020 2020  ners['c3']..    
-0000c880: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000c890: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0000c8a0: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-0000c8b0: 2020 2020 2020 6f74 6865 725f 756e 6974        other_unit
-0000c8c0: 203d 2073 656c 662e 6d6f 6465 6c2e 6765   = self.model.ge
-0000c8d0: 745f 756e 6974 2827 6f74 6865 7227 290a  t_unit('other').
-0000c8e0: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
-0000c8f0: 725f 756e 6974 2e63 6f6e 7461 696e 6572  r_unit.container
-0000c900: 730a 0a20 2020 2064 6566 2074 6573 745f  s..    def test_
-0000c910: 756e 6974 5f67 6574 5f63 6f6e 7461 696e  unit_get_contain
-0000c920: 6572 2873 656c 6629 3a0a 2020 2020 2020  er(self):.      
-0000c930: 2020 756e 6974 203d 2073 656c 662e 6d6f    unit = self.mo
-0000c940: 6465 6c2e 756e 6974 0a20 2020 2020 2020  del.unit.       
-0000c950: 2066 6f72 206e 616d 6520 696e 205b 2763   for name in ['c
-0000c960: 3127 2c20 2763 3227 5d3a 0a20 2020 2020  1', 'c2']:.     
-0000c970: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
-0000c980: 203d 2075 6e69 742e 6765 745f 636f 6e74   = unit.get_cont
-0000c990: 6169 6e65 7228 6e61 6d65 290a 2020 2020  ainer(name).    
-0000c9a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000c9b0: 6572 7449 7349 6e73 7461 6e63 6528 636f  ertIsInstance(co
-0000c9c0: 6e74 6169 6e65 722c 206f 7073 2e6d 6f64  ntainer, ops.mod
-0000c9d0: 656c 2e43 6f6e 7461 696e 6572 290a 2020  el.Container).  
-0000c9e0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-0000c9f0: 7373 6572 7445 7175 616c 2863 6f6e 7461  ssertEqual(conta
-0000ca00: 696e 6572 2e6e 616d 652c 206e 616d 6529  iner.name, name)
-0000ca10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000ca20: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-0000ca30: 6365 2863 6f6e 7461 696e 6572 2e70 6562  ce(container.peb
-0000ca40: 626c 652c 206f 7073 2e70 6562 626c 652e  ble, ops.pebble.
-0000ca50: 436c 6965 6e74 290a 2020 2020 2020 2020  Client).        
-0000ca60: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000ca70: 5261 6973 6573 286f 7073 2e6d 6f64 656c  Raises(ops.model
-0000ca80: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-0000ca90: 2020 2020 2020 2020 2020 756e 6974 2e67            unit.g
-0000caa0: 6574 5f63 6f6e 7461 696e 6572 2827 6333  et_container('c3
-0000cab0: 2729 0a0a 2020 2020 2020 2020 7769 7468  ')..        with
-0000cac0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000cad0: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-0000cae0: 3a0a 2020 2020 2020 2020 2020 2020 6f74  :.            ot
-0000caf0: 6865 725f 756e 6974 203d 2073 656c 662e  her_unit = self.
-0000cb00: 6d6f 6465 6c2e 6765 745f 756e 6974 2827  model.get_unit('
-0000cb10: 6f74 6865 7227 290a 2020 2020 2020 2020  other').        
-0000cb20: 2020 2020 6f74 6865 725f 756e 6974 2e67      other_unit.g
-0000cb30: 6574 5f63 6f6e 7461 696e 6572 2827 666f  et_container('fo
-0000cb40: 6f27 290a 0a0a 636c 6173 7320 5465 7374  o')...class Test
-0000cb50: 436f 6e74 6169 6e65 7250 6562 626c 6528  ContainerPebble(
-0000cb60: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
-0000cb70: 6529 3a0a 2020 2020 6465 6620 7365 7455  e):.    def setU
-0000cb80: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
-0000cb90: 206d 6574 6120 3d20 6f70 732e 6368 6172   meta = ops.char
-0000cba0: 6d2e 4368 6172 6d4d 6574 612e 6672 6f6d  m.CharmMeta.from
-0000cbb0: 5f79 616d 6c28 2222 220a 6e61 6d65 3a20  _yaml(""".name: 
-0000cbc0: 6b38 732d 6368 6172 6d0a 636f 6e74 6169  k8s-charm.contai
-0000cbd0: 6e65 7273 3a0a 2020 6331 3a0a 2020 2020  ners:.  c1:.    
-0000cbe0: 6b3a 2076 0a22 2222 290a 2020 2020 2020  k: v.""").      
-0000cbf0: 2020 6261 636b 656e 6420 3d20 4d6f 636b    backend = Mock
-0000cc00: 5065 6262 6c65 4261 636b 656e 6428 276d  PebbleBackend('m
-0000cc10: 7961 7070 2f30 2729 0a20 2020 2020 2020  yapp/0').       
-0000cc20: 2073 656c 662e 6d6f 6465 6c20 3d20 6f70   self.model = op
-0000cc30: 732e 6d6f 6465 6c2e 4d6f 6465 6c28 6d65  s.model.Model(me
-0000cc40: 7461 2c20 6261 636b 656e 6429 0a20 2020  ta, backend).   
-0000cc50: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
-0000cc60: 6e65 7220 3d20 7365 6c66 2e6d 6f64 656c  ner = self.model
-0000cc70: 2e75 6e69 742e 636f 6e74 6169 6e65 7273  .unit.containers
-0000cc80: 5b27 6331 275d 0a20 2020 2020 2020 2073  ['c1'].        s
-0000cc90: 656c 662e 7065 6262 6c65 203d 2073 656c  elf.pebble = sel
-0000cca0: 662e 636f 6e74 6169 6e65 722e 7065 6262  f.container.pebb
-0000ccb0: 6c65 0a0a 2020 2020 6465 6620 7465 7374  le..    def test
-0000ccc0: 5f73 6f63 6b65 745f 7061 7468 2873 656c  _socket_path(sel
-0000ccd0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0000cce0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000ccf0: 662e 7065 6262 6c65 2e73 6f63 6b65 745f  f.pebble.socket_
-0000cd00: 7061 7468 2c20 272f 6368 6172 6d2f 636f  path, '/charm/co
-0000cd10: 6e74 6169 6e65 7273 2f63 312f 7065 6262  ntainers/c1/pebb
-0000cd20: 6c65 2e73 6f63 6b65 7427 290a 0a20 2020  le.socket')..   
-0000cd30: 2064 6566 2074 6573 745f 6175 746f 7374   def test_autost
-0000cd40: 6172 7428 7365 6c66 293a 0a20 2020 2020  art(self):.     
-0000cd50: 2020 2073 656c 662e 636f 6e74 6169 6e65     self.containe
-0000cd60: 722e 6175 746f 7374 6172 7428 290a 2020  r.autostart().  
-0000cd70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000cd80: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
-0000cd90: 6c65 2e72 6571 7565 7374 732c 205b 2827  le.requests, [('
-0000cda0: 6175 746f 7374 6172 7427 2c29 5d29 0a0a  autostart',)])..
-0000cdb0: 2020 2020 6465 6620 7465 7374 5f72 6570      def test_rep
-0000cdc0: 6c61 6e28 7365 6c66 293a 0a20 2020 2020  lan(self):.     
-0000cdd0: 2020 2073 656c 662e 636f 6e74 6169 6e65     self.containe
-0000cde0: 722e 7265 706c 616e 2829 0a20 2020 2020  r.replan().     
-0000cdf0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000ce00: 7561 6c28 7365 6c66 2e70 6562 626c 652e  ual(self.pebble.
-0000ce10: 7265 7175 6573 7473 2c20 5b28 2772 6570  requests, [('rep
-0000ce20: 6c61 6e27 2c29 5d29 0a0a 2020 2020 6465  lan',)])..    de
-0000ce30: 6620 7465 7374 5f63 616e 5f63 6f6e 6e65  f test_can_conne
-0000ce40: 6374 2873 656c 6629 3a0a 2020 2020 2020  ct(self):.      
-0000ce50: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
-0000ce60: 7370 6f6e 7365 732e 6170 7065 6e64 2853  sponses.append(S
-0000ce70: 7973 7465 6d49 6e66 6f2e 6672 6f6d 5f64  ystemInfo.from_d
-0000ce80: 6963 7428 7b27 7665 7273 696f 6e27 3a20  ict({'version': 
-0000ce90: 2731 2e30 2e30 277d 2929 0a20 2020 2020  '1.0.0'})).     
-0000cea0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000ceb0: 7565 2873 656c 662e 636f 6e74 6169 6e65  ue(self.containe
-0000cec0: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
-0000ced0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000cee0: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
-0000cef0: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
-0000cf00: 5b28 2767 6574 5f73 7973 7465 6d5f 696e  [('get_system_in
-0000cf10: 666f 272c 295d 290a 0a20 2020 2064 6566  fo',)])..    def
-0000cf20: 2074 6573 745f 7374 6172 7428 7365 6c66   test_start(self
-0000cf30: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000cf40: 636f 6e74 6169 6e65 722e 7374 6172 7428  container.start(
-0000cf50: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
-0000cf60: 656c 662e 636f 6e74 6169 6e65 722e 7374  elf.container.st
-0000cf70: 6172 7428 2766 6f6f 272c 2027 6261 7227  art('foo', 'bar'
-0000cf80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000cf90: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000cfa0: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
-0000cfb0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-0000cfc0: 2773 7461 7274 272c 2028 2766 6f6f 272c  'start', ('foo',
-0000cfd0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0000cfe0: 2827 7374 6172 7427 2c20 2827 666f 6f27  ('start', ('foo'
-0000cff0: 2c20 2762 6172 2729 292c 0a20 2020 2020  , 'bar')),.     
-0000d000: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-0000d010: 6573 745f 7374 6172 745f 6e6f 5f61 7267  est_start_no_arg
-0000d020: 756d 656e 7473 2873 656c 6629 3a0a 2020  uments(self):.  
-0000d030: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000d040: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-0000d050: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000d060: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
-0000d070: 6e65 722e 7374 6172 7428 290a 0a20 2020  ner.start()..   
-0000d080: 2064 6566 2074 6573 745f 7374 6f70 2873   def test_stop(s
-0000d090: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000d0a0: 6c66 2e63 6f6e 7461 696e 6572 2e73 746f  lf.container.sto
-0000d0b0: 7028 2766 6f6f 2729 0a20 2020 2020 2020  p('foo').       
-0000d0c0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000d0d0: 7374 6f70 2827 666f 6f27 2c20 2762 6172  stop('foo', 'bar
-0000d0e0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000d0f0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000d100: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-0000d110: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000d120: 2827 7374 6f70 272c 2028 2766 6f6f 272c  ('stop', ('foo',
-0000d130: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0000d140: 2827 7374 6f70 272c 2028 2766 6f6f 272c  ('stop', ('foo',
-0000d150: 2027 6261 7227 2929 2c0a 2020 2020 2020   'bar')),.      
-0000d160: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0000d170: 7374 5f73 746f 705f 6e6f 5f61 7267 756d  st_stop_no_argum
-0000d180: 656e 7473 2873 656c 6629 3a0a 2020 2020  ents(self):.    
-0000d190: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000d1a0: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-0000d1b0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000d1c0: 2020 2073 656c 662e 636f 6e74 6169 6e65     self.containe
-0000d1d0: 722e 7374 6f70 2829 0a0a 2020 2020 6465  r.stop()..    de
-0000d1e0: 6620 7465 7374 5f72 6573 7461 7274 2873  f test_restart(s
-0000d1f0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000d200: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
-0000d210: 7461 7274 2827 666f 6f27 290a 2020 2020  tart('foo').    
-0000d220: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000d230: 6572 2e72 6573 7461 7274 2827 666f 6f27  er.restart('foo'
-0000d240: 2c20 2762 6172 2729 0a20 2020 2020 2020  , 'bar').       
-0000d250: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000d260: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
-0000d270: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000d280: 2020 2020 2020 2827 7265 7374 6172 7427        ('restart'
-0000d290: 2c20 2827 666f 6f27 2c29 292c 0a20 2020  , ('foo',)),.   
-0000d2a0: 2020 2020 2020 2020 2028 2772 6573 7461           ('resta
-0000d2b0: 7274 272c 2028 2766 6f6f 272c 2027 6261  rt', ('foo', 'ba
-0000d2c0: 7227 2929 2c0a 2020 2020 2020 2020 5d29  r')),.        ])
-0000d2d0: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
-0000d2e0: 6573 7461 7274 5f66 616c 6c62 6163 6b28  estart_fallback(
-0000d2f0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-0000d300: 6566 2072 6573 7461 7274 5f73 6572 7669  ef restart_servi
-0000d310: 6365 7328 7365 7276 6963 6573 293a 0a20  ces(services):. 
-0000d320: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000d330: 7065 6262 6c65 2e72 6571 7565 7374 732e  pebble.requests.
-0000d340: 6170 7065 6e64 2828 2772 6573 7461 7274  append(('restart
-0000d350: 272c 2073 6572 7669 6365 7329 290a 2020  ', services)).  
-0000d360: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000d370: 4150 4945 7272 6f72 287b 7d2c 2034 3030  APIError({}, 400
-0000d380: 2c20 2222 2c20 2222 290a 0a20 2020 2020  , "", "")..     
-0000d390: 2020 2073 656c 662e 7065 6262 6c65 2e72     self.pebble.r
-0000d3a0: 6573 7461 7274 5f73 6572 7669 6365 7320  estart_services 
-0000d3b0: 3d20 7265 7374 6172 745f 7365 7276 6963  = restart_servic
-0000d3c0: 6573 0a20 2020 2020 2020 2023 2053 6574  es.        # Set
-0000d3d0: 7570 2074 6865 2050 6562 626c 6520 636c  up the Pebble cl
-0000d3e0: 6965 6e74 2074 6f20 7265 7370 6f6e 6420  ient to respond 
-0000d3f0: 746f 2061 2063 616c 6c20 746f 2067 6574  to a call to get
-0000d400: 5f73 6572 7669 6365 7328 290a 2020 2020  _services().    
-0000d410: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-0000d420: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000d430: 285b 0a20 2020 2020 2020 2020 2020 2053  ([.            S
-0000d440: 6572 7669 6365 496e 666f 2e66 726f 6d5f  erviceInfo.from_
-0000d450: 6469 6374 287b 276e 616d 6527 3a20 2766  dict({'name': 'f
-0000d460: 6f6f 272c 2027 7374 6172 7475 7027 3a20  oo', 'startup': 
-0000d470: 2765 6e61 626c 6564 272c 2027 6375 7272  'enabled', 'curr
-0000d480: 656e 7427 3a20 2761 6374 6976 6527 7d29  ent': 'active'})
-0000d490: 2c0a 2020 2020 2020 2020 2020 2020 5365  ,.            Se
-0000d4a0: 7276 6963 6549 6e66 6f2e 6672 6f6d 5f64  rviceInfo.from_d
-0000d4b0: 6963 7428 7b27 6e61 6d65 273a 2027 6261  ict({'name': 'ba
-0000d4c0: 7227 2c20 2773 7461 7274 7570 273a 2027  r', 'startup': '
-0000d4d0: 656e 6162 6c65 6427 2c20 2763 7572 7265  enabled', 'curre
-0000d4e0: 6e74 273a 2027 696e 6163 7469 7665 277d  nt': 'inactive'}
-0000d4f0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-0000d500: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
-0000d510: 6169 6e65 722e 7265 7374 6172 7428 2766  ainer.restart('f
-0000d520: 6f6f 272c 2027 6261 7227 290a 2020 2020  oo', 'bar').    
-0000d530: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000d540: 7175 616c 2873 656c 662e 7065 6262 6c65  qual(self.pebble
-0000d550: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-0000d560: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
-0000d570: 6973 2074 6865 2066 6972 7374 2072 6571  is the first req
-0000d580: 7565 7374 2c20 7768 6963 6820 696e 2072  uest, which in r
-0000d590: 6561 6c20 6c69 6665 2066 6169 6c73 2077  eal life fails w
-0000d5a0: 6974 6820 4150 4945 7272 6f72 206f 6e20  ith APIError on 
-0000d5b0: 6f6c 6465 7220 7665 7273 696f 6e73 0a20  older versions. 
-0000d5c0: 2020 2020 2020 2020 2020 2028 2772 6573             ('res
-0000d5d0: 7461 7274 272c 2028 2766 6f6f 272c 2027  tart', ('foo', '
-0000d5e0: 6261 7227 2929 2c0a 2020 2020 2020 2020  bar')),.        
-0000d5f0: 2020 2020 2320 4e65 7874 2074 6865 2063      # Next the c
-0000d600: 6f64 6520 7368 6f75 6c64 206c 6f6f 7020  ode should loop 
-0000d610: 6f76 6572 2074 6865 2073 7461 7274 6564  over the started
-0000d620: 2073 6572 7669 6365 732c 2061 6e64 2073   services, and s
-0000d630: 746f 7020 7468 656d 0a20 2020 2020 2020  top them.       
-0000d640: 2020 2020 2028 2767 6574 5f73 6572 7669       ('get_servi
-0000d650: 6365 7327 2c20 2827 666f 6f27 2c20 2762  ces', ('foo', 'b
-0000d660: 6172 2729 292c 0a20 2020 2020 2020 2020  ar')),.         
-0000d670: 2020 2028 2773 746f 7027 2c20 2827 666f     ('stop', ('fo
-0000d680: 6f27 2c29 292c 0a20 2020 2020 2020 2020  o',)),.         
-0000d690: 2020 2023 2054 6865 6e20 7374 6172 7420     # Then start 
-0000d6a0: 616c 6c20 7468 6520 7370 6563 6966 6965  all the specifie
-0000d6b0: 6420 7365 7276 6963 6573 0a20 2020 2020  d services.     
-0000d6c0: 2020 2020 2020 2028 2773 7461 7274 272c         ('start',
-0000d6d0: 2028 2766 6f6f 272c 2027 6261 7227 2929   ('foo', 'bar'))
-0000d6e0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-0000d6f0: 2064 6566 2074 6573 745f 7265 7374 6172   def test_restar
-0000d700: 745f 6661 6c6c 6261 636b 5f6e 6f6e 5f34  t_fallback_non_4
-0000d710: 3030 5f65 7272 6f72 2873 656c 6629 3a0a  00_error(self):.
-0000d720: 2020 2020 2020 2020 6465 6620 7265 7374          def rest
-0000d730: 6172 745f 7365 7276 6963 6573 2873 6572  art_services(ser
-0000d740: 7669 6365 7329 3a0a 2020 2020 2020 2020  vices):.        
-0000d750: 2020 2020 7261 6973 6520 4150 4945 7272      raise APIErr
-0000d760: 6f72 287b 7d2c 2035 3030 2c20 2222 2c20  or({}, 500, "", 
-0000d770: 2222 290a 0a20 2020 2020 2020 2073 656c  "")..        sel
-0000d780: 662e 7065 6262 6c65 2e72 6573 7461 7274  f.pebble.restart
-0000d790: 5f73 6572 7669 6365 7320 3d20 7265 7374  _services = rest
-0000d7a0: 6172 745f 7365 7276 6963 6573 0a20 2020  art_services.   
-0000d7b0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000d7c0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-0000d7d0: 7065 6262 6c65 2e41 5049 4572 726f 7229  pebble.APIError)
-0000d7e0: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
-0000d7f0: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000d800: 6572 2e72 6573 7461 7274 2827 666f 6f27  er.restart('foo'
-0000d810: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000d820: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
-0000d830: 6365 7074 696f 6e2e 636f 6465 2c20 3530  ception.code, 50
-0000d840: 3029 0a0a 2020 2020 6465 6620 7465 7374  0)..    def test
-0000d850: 5f72 6573 7461 7274 5f6e 6f5f 6172 6775  _restart_no_argu
-0000d860: 6d65 6e74 7328 7365 6c66 293a 0a20 2020  ments(self):.   
-0000d870: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000d880: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-0000d890: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0000d8a0: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-0000d8b0: 6572 2e72 6573 7461 7274 2829 0a0a 2020  er.restart()..  
-0000d8c0: 2020 6465 6620 7465 7374 5f74 7970 655f    def test_type_
-0000d8d0: 6572 726f 7273 2873 656c 6629 3a0a 2020  errors(self):.  
-0000d8e0: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
-0000d8f0: 2e63 6861 726d 2e43 6861 726d 4d65 7461  .charm.CharmMeta
-0000d900: 2e66 726f 6d5f 7961 6d6c 2822 2222 0a6e  .from_yaml(""".n
-0000d910: 616d 653a 206b 3873 2d63 6861 726d 0a63  ame: k8s-charm.c
-0000d920: 6f6e 7461 696e 6572 733a 0a20 2063 313a  ontainers:.  c1:
-0000d930: 0a20 2020 206b 3a20 760a 2222 2229 0a20  .    k: v."""). 
-0000d940: 2020 2020 2020 2023 204f 6e6c 7920 7468         # Only th
-0000d950: 6520 7265 616c 2070 6562 626c 6520 436c  e real pebble Cl
-0000d960: 6965 6e74 2063 6865 636b 7320 7479 7065  ient checks type
-0000d970: 732c 2073 6f20 7573 6520 6163 7475 616c  s, so use actual
-0000d980: 2062 6163 6b65 6e64 2063 6c61 7373 0a20   backend class. 
-0000d990: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
-0000d9a0: 206f 7073 2e6d 6f64 656c 2e5f 4d6f 6465   ops.model._Mode
-0000d9b0: 6c42 6163 6b65 6e64 2827 6d79 6170 702f  lBackend('myapp/
-0000d9c0: 3027 290a 2020 2020 2020 2020 6d6f 6465  0').        mode
-0000d9d0: 6c20 3d20 6f70 732e 6d6f 6465 6c2e 4d6f  l = ops.model.Mo
-0000d9e0: 6465 6c28 6d65 7461 2c20 6261 636b 656e  del(meta, backen
-0000d9f0: 6429 0a20 2020 2020 2020 2063 6f6e 7461  d).        conta
-0000da00: 696e 6572 203d 206d 6f64 656c 2e75 6e69  iner = model.uni
-0000da10: 742e 636f 6e74 6169 6e65 7273 5b27 6331  t.containers['c1
-0000da20: 275d 0a0a 2020 2020 2020 2020 7769 7468  ']..        with
-0000da30: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000da40: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
-0000da50: 2020 2020 2020 2020 2020 2063 6f6e 7461             conta
-0000da60: 696e 6572 2e73 7461 7274 285b 2766 6f6f  iner.start(['foo
-0000da70: 275d 290a 0a20 2020 2020 2020 2077 6974  '])..        wit
-0000da80: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000da90: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-0000daa0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0000dab0: 6169 6e65 722e 7374 6f70 285b 2766 6f6f  ainer.stop(['foo
-0000dac0: 275d 290a 0a20 2020 2064 6566 2074 6573  '])..    def tes
-0000dad0: 745f 6164 645f 6c61 7965 7228 7365 6c66  t_add_layer(self
-0000dae0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000daf0: 636f 6e74 6169 6e65 722e 6164 645f 6c61  container.add_la
-0000db00: 7965 7228 2761 272c 2027 7375 6d6d 6172  yer('a', 'summar
-0000db10: 793a 2073 7472 5c6e 2729 0a20 2020 2020  y: str\n').     
-0000db20: 2020 2073 656c 662e 636f 6e74 6169 6e65     self.containe
-0000db30: 722e 6164 645f 6c61 7965 7228 2762 272c  r.add_layer('b',
-0000db40: 207b 2773 756d 6d61 7279 273a 2027 6469   {'summary': 'di
-0000db50: 6374 277d 290a 2020 2020 2020 2020 7365  ct'}).        se
-0000db60: 6c66 2e63 6f6e 7461 696e 6572 2e61 6464  lf.container.add
-0000db70: 5f6c 6179 6572 2827 6327 2c20 6f70 732e  _layer('c', ops.
-0000db80: 7065 6262 6c65 2e4c 6179 6572 2827 7375  pebble.Layer('su
-0000db90: 6d6d 6172 793a 204c 6179 6572 2729 290a  mmary: Layer')).
-0000dba0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000dbb0: 7461 696e 6572 2e61 6464 5f6c 6179 6572  tainer.add_layer
-0000dbc0: 2827 6427 2c20 2773 756d 6d61 7279 3a20  ('d', 'summary: 
-0000dbd0: 7374 725c 6e27 2c20 636f 6d62 696e 653d  str\n', combine=
-0000dbe0: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-0000dbf0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000dc00: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
-0000dc10: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000dc20: 2020 2028 2761 6464 5f6c 6179 6572 272c     ('add_layer',
-0000dc30: 2027 6127 2c20 2773 756d 6d61 7279 3a20   'a', 'summary: 
-0000dc40: 7374 725c 6e27 2c20 4661 6c73 6529 2c0a  str\n', False),.
-0000dc50: 2020 2020 2020 2020 2020 2020 2827 6164              ('ad
-0000dc60: 645f 6c61 7965 7227 2c20 2762 272c 2027  d_layer', 'b', '
-0000dc70: 7375 6d6d 6172 793a 2064 6963 745c 6e27  summary: dict\n'
-0000dc80: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
-0000dc90: 2020 2020 2020 2827 6164 645f 6c61 7965        ('add_laye
-0000dca0: 7227 2c20 2763 272c 2027 7375 6d6d 6172  r', 'c', 'summar
-0000dcb0: 793a 204c 6179 6572 5c6e 272c 2046 616c  y: Layer\n', Fal
-0000dcc0: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
-0000dcd0: 2028 2761 6464 5f6c 6179 6572 272c 2027   ('add_layer', '
-0000dce0: 6427 2c20 2773 756d 6d61 7279 3a20 7374  d', 'summary: st
-0000dcf0: 725c 6e27 2c20 5472 7565 292c 0a20 2020  r\n', True),.   
-0000dd00: 2020 2020 205d 290a 0a20 2020 2020 2020       ])..       
-0000dd10: 2023 2063 6f6d 6269 6e65 2069 7320 6120   # combine is a 
-0000dd20: 6b65 7977 6f72 642d 6f6e 6c79 2061 7267  keyword-only arg
-0000dd30: 2028 7368 6f75 6c64 2062 6520 636f 6d62   (should be comb
-0000dd40: 696e 653d 5472 7565 290a 2020 2020 2020  ine=True).      
-0000dd50: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0000dd60: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
-0000dd70: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000dd80: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000dd90: 6164 645f 6c61 7965 7228 2778 272c 207b  add_layer('x', {
-0000dda0: 7d2c 2054 7275 6529 0a0a 2020 2020 6465  }, True)..    de
-0000ddb0: 6620 7465 7374 5f67 6574 5f70 6c61 6e28  f test_get_plan(
-0000ddc0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
-0000ddd0: 6c61 6e5f 7961 6d6c 203d 2027 7365 7276  lan_yaml = 'serv
-0000dde0: 6963 6573 3a5c 6e20 666f 6f3a 5c6e 2020  ices:\n foo:\n  
-0000ddf0: 6f76 6572 7269 6465 3a20 7265 706c 6163  override: replac
-0000de00: 655c 6e20 2063 6f6d 6d61 6e64 3a20 6261  e\n  command: ba
-0000de10: 7227 0a20 2020 2020 2020 2073 656c 662e  r'.        self.
-0000de20: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
-0000de30: 2e61 7070 656e 6428 6f70 732e 7065 6262  .append(ops.pebb
-0000de40: 6c65 2e50 6c61 6e28 706c 616e 5f79 616d  le.Plan(plan_yam
-0000de50: 6c29 290a 2020 2020 2020 2020 706c 616e  l)).        plan
-0000de60: 203d 2073 656c 662e 636f 6e74 6169 6e65   = self.containe
-0000de70: 722e 6765 745f 706c 616e 2829 0a20 2020  r.get_plan().   
-0000de80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000de90: 4571 7561 6c28 7365 6c66 2e70 6562 626c  Equal(self.pebbl
-0000dea0: 652e 7265 7175 6573 7473 2c20 5b28 2767  e.requests, [('g
-0000deb0: 6574 5f70 6c61 6e27 2c29 5d29 0a20 2020  et_plan',)]).   
-0000dec0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000ded0: 4973 496e 7374 616e 6365 2870 6c61 6e2c  IsInstance(plan,
-0000dee0: 206f 7073 2e70 6562 626c 652e 506c 616e   ops.pebble.Plan
-0000def0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000df00: 7373 6572 7445 7175 616c 2870 6c61 6e2e  ssertEqual(plan.
-0000df10: 746f 5f79 616d 6c28 292c 2079 616d 6c2e  to_yaml(), yaml.
-0000df20: 7361 6665 5f64 756d 7028 7961 6d6c 2e73  safe_dump(yaml.s
-0000df30: 6166 655f 6c6f 6164 2870 6c61 6e5f 7961  afe_load(plan_ya
-0000df40: 6d6c 2929 290a 0a20 2020 2040 7374 6174  ml)))..    @stat
-0000df50: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-0000df60: 205f 6d61 6b65 5f73 6572 7669 6365 286e   _make_service(n
-0000df70: 616d 652c 2073 7461 7274 7570 2c20 6375  ame, startup, cu
-0000df80: 7272 656e 7429 3a0a 2020 2020 2020 2020  rrent):.        
-0000df90: 7265 7475 726e 206f 7073 2e70 6562 626c  return ops.pebbl
-0000dfa0: 652e 5365 7276 6963 6549 6e66 6f2e 6672  e.ServiceInfo.fr
-0000dfb0: 6f6d 5f64 6963 7428 0a20 2020 2020 2020  om_dict(.       
-0000dfc0: 2020 2020 207b 276e 616d 6527 3a20 6e61       {'name': na
-0000dfd0: 6d65 2c20 2773 7461 7274 7570 273a 2073  me, 'startup': s
-0000dfe0: 7461 7274 7570 2c20 2763 7572 7265 6e74  tartup, 'current
-0000dff0: 273a 2063 7572 7265 6e74 7d29 0a0a 2020  ': current})..  
-0000e000: 2020 6465 6620 7465 7374 5f67 6574 5f73    def test_get_s
-0000e010: 6572 7669 6365 7328 7365 6c66 293a 0a20  ervices(self):. 
-0000e020: 2020 2020 2020 2074 776f 5f73 6572 7669         two_servi
-0000e030: 6365 7320 3d20 5b0a 2020 2020 2020 2020  ces = [.        
-0000e040: 2020 2020 7365 6c66 2e5f 6d61 6b65 5f73      self._make_s
-0000e050: 6572 7669 6365 2827 7331 272c 2027 656e  ervice('s1', 'en
-0000e060: 6162 6c65 6427 2c20 2761 6374 6976 6527  abled', 'active'
-0000e070: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-0000e080: 656c 662e 5f6d 616b 655f 7365 7276 6963  elf._make_servic
-0000e090: 6528 2773 3227 2c20 2764 6973 6162 6c65  e('s2', 'disable
-0000e0a0: 6427 2c20 2769 6e61 6374 6976 6527 292c  d', 'inactive'),
-0000e0b0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0000e0c0: 2020 2073 656c 662e 7065 6262 6c65 2e72     self.pebble.r
-0000e0d0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-0000e0e0: 7477 6f5f 7365 7276 6963 6573 290a 2020  two_services).  
-0000e0f0: 2020 2020 2020 7365 7276 6963 6573 203d        services =
-0000e100: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
-0000e110: 6765 745f 7365 7276 6963 6573 2829 0a20  get_services(). 
-0000e120: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e130: 7274 4571 7561 6c28 6c65 6e28 7365 7276  rtEqual(len(serv
-0000e140: 6963 6573 292c 2032 290a 2020 2020 2020  ices), 2).      
+00009fa0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00009fb0: 2020 2020 2020 2020 2020 2020 206d 6174               mat
+00009fc0: 6368 6573 2e61 7070 656e 6428 696e 666f  ches.append(info
+00009fd0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00009fe0: 7475 726e 206d 6174 6368 6573 0a20 2020  turn matches.   
+00009ff0: 2020 2020 2072 6574 7572 6e20 696e 6e65       return inne
+0000a000: 720a 0a20 2020 2023 2074 6573 7420 7261  r..    # test ra
+0000a010: 7720 6275 7369 6e65 7373 206c 6f67 6963  w business logic
+0000a020: 2066 6f72 2072 6563 7572 7369 6f6e 2061   for recursion a
+0000a030: 6e64 2064 6573 7420 7061 7468 2063 6f6e  nd dest path con
+0000a040: 7374 7275 6374 696f 6e0a 2020 2020 6669  struction.    fi
+0000a050: 6c65 7320 3d20 7365 7428 290a 2020 2020  les = set().    
+0000a060: 6361 7365 2e70 6174 6820 3d20 6f73 2e70  case.path = os.p
+0000a070: 6174 682e 6e6f 726d 7061 7468 2863 6173  ath.normpath(cas
+0000a080: 652e 7061 7468 290a 2020 2020 6361 7365  e.path).    case
+0000a090: 2e66 696c 6573 203d 205b 6f73 2e70 6174  .files = [os.pat
+0000a0a0: 682e 6e6f 726d 7061 7468 2866 2920 666f  h.normpath(f) fo
+0000a0b0: 7220 6620 696e 2063 6173 652e 6669 6c65  r f in case.file
+0000a0c0: 735d 0a20 2020 2063 6173 652e 7761 6e74  s].    case.want
+0000a0d0: 203d 207b 6f73 2e70 6174 682e 6e6f 726d   = {os.path.norm
+0000a0e0: 7061 7468 2866 2920 666f 7220 6620 696e  path(f) for f in
+0000a0f0: 2063 6173 652e 7761 6e74 7d0a 2020 2020   case.want}.    
+0000a100: 666f 7220 6620 696e 206f 7073 2e43 6f6e  for f in ops.Con
+0000a110: 7461 696e 6572 2e5f 6c69 7374 5f72 6563  tainer._list_rec
+0000a120: 7572 7369 7665 280a 2020 2020 2020 2020  ursive(.        
+0000a130: 6c69 7374 5f66 756e 635f 6765 6e28 0a20  list_func_gen(. 
+0000a140: 2020 2020 2020 2020 2020 2063 6173 652e             case.
+0000a150: 6669 6c65 7329 2c20 7061 7468 6c69 622e  files), pathlib.
+0000a160: 5061 7468 280a 2020 2020 2020 2020 2020  Path(.          
+0000a170: 2020 6361 7365 2e70 6174 6829 293a 0a20    case.path)):. 
+0000a180: 2020 2020 2020 2070 6174 6820 3d20 662e         path = f.
+0000a190: 7061 7468 0a20 2020 2020 2020 2069 6620  path.        if 
+0000a1a0: 6361 7365 2e64 7374 2069 7320 6e6f 7420  case.dst is not 
+0000a1b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000a1c0: 2020 2320 7465 7374 2064 6573 7469 6e61    # test destina
+0000a1d0: 7469 6f6e 2070 6174 6820 636f 6e73 7472  tion path constr
+0000a1e0: 7563 7469 6f6e 0a20 2020 2020 2020 2020  uction.         
+0000a1f0: 2020 205f 2c20 7061 7468 203d 2066 2e70     _, path = f.p
+0000a200: 6174 682c 206f 7073 2e43 6f6e 7461 696e  ath, ops.Contain
+0000a210: 6572 2e5f 6275 696c 645f 6465 7374 7061  er._build_destpa
+0000a220: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
+0000a230: 2020 2020 662e 7061 7468 2c20 6361 7365      f.path, case
+0000a240: 2e70 6174 682c 2063 6173 652e 6473 7429  .path, case.dst)
+0000a250: 0a20 2020 2020 2020 2066 696c 6573 2e61  .        files.a
+0000a260: 6464 2870 6174 6829 0a20 2020 2061 7373  dd(path).    ass
+0000a270: 6572 7420 6361 7365 2e77 616e 7420 3d3d  ert case.want ==
+0000a280: 2066 696c 6573 2c20 6627 6361 7365 207b   files, f'case {
+0000a290: 6361 7365 2e6e 616d 6521 727d 2068 6173  case.name!r} has
+0000a2a0: 2077 726f 6e67 2066 696c 6573 3a20 7761   wrong files: wa
+0000a2b0: 6e74 207b 6361 7365 2e77 616e 747d 2c20  nt {case.want}, 
+0000a2c0: 676f 7420 7b66 696c 6573 7d27 0a0a 0a72  got {files}'...r
+0000a2d0: 6563 7572 7369 7665 5f70 7573 685f 7075  ecursive_push_pu
+0000a2e0: 6c6c 5f63 6173 6573 203d 205b 0a20 2020  ll_cases = [.   
+0000a2f0: 2050 7573 6850 756c 6c43 6173 6528 0a20   PushPullCase(. 
+0000a300: 2020 2020 2020 206e 616d 653d 2762 6173         name='bas
+0000a310: 6963 2070 7573 682f 7075 6c6c 272c 0a20  ic push/pull',. 
+0000a320: 2020 2020 2020 2070 6174 683d 272f 666f         path='/fo
+0000a330: 6f27 2c0a 2020 2020 2020 2020 6473 743d  o',.        dst=
+0000a340: 272f 6261 7a27 2c0a 2020 2020 2020 2020  '/baz',.        
+0000a350: 6669 6c65 733d 5b27 2f66 6f6f 2f62 6172  files=['/foo/bar
+0000a360: 2e74 7874 275d 2c0a 2020 2020 2020 2020  .txt'],.        
+0000a370: 7761 6e74 3d7b 272f 6261 7a2f 666f 6f2f  want={'/baz/foo/
+0000a380: 6261 722e 7478 7427 7d2c 0a20 2020 2029  bar.txt'},.    )
+0000a390: 2c0a 2020 2020 5075 7368 5075 6c6c 4361  ,.    PushPullCa
+0000a3a0: 7365 280a 2020 2020 2020 2020 6e61 6d65  se(.        name
+0000a3b0: 3d27 7075 7368 2f70 756c 6c20 2d20 7472  ='push/pull - tr
+0000a3c0: 6169 6c69 6e67 2073 6c61 7368 272c 0a20  ailing slash',. 
+0000a3d0: 2020 2020 2020 2070 6174 683d 272f 666f         path='/fo
+0000a3e0: 6f2f 272c 0a20 2020 2020 2020 2064 7374  o/',.        dst
+0000a3f0: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
+0000a400: 2066 696c 6573 3d5b 272f 666f 6f2f 6261   files=['/foo/ba
+0000a410: 722e 7478 7427 5d2c 0a20 2020 2020 2020  r.txt'],.       
+0000a420: 2077 616e 743d 7b27 2f62 617a 2f66 6f6f   want={'/baz/foo
+0000a430: 2f62 6172 2e74 7874 277d 2c0a 2020 2020  /bar.txt'},.    
+0000a440: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
+0000a450: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
+0000a460: 653d 2762 6173 6963 2070 7573 682f 7075  e='basic push/pu
+0000a470: 6c6c 202d 2072 6f6f 7427 2c0a 2020 2020  ll - root',.    
+0000a480: 2020 2020 7061 7468 3d27 2f27 2c0a 2020      path='/',.  
+0000a490: 2020 2020 2020 6473 743d 272f 6261 7a27        dst='/baz'
+0000a4a0: 2c0a 2020 2020 2020 2020 6669 6c65 733d  ,.        files=
+0000a4b0: 5b27 2f66 6f6f 2f62 6172 2e74 7874 275d  ['/foo/bar.txt']
+0000a4c0: 2c0a 2020 2020 2020 2020 7761 6e74 3d7b  ,.        want={
+0000a4d0: 272f 6261 7a2f 666f 6f2f 6261 722e 7478  '/baz/foo/bar.tx
+0000a4e0: 7427 7d2c 0a20 2020 2029 2c0a 2020 2020  t'},.    ),.    
+0000a4f0: 5075 7368 5075 6c6c 4361 7365 280a 2020  PushPullCase(.  
+0000a500: 2020 2020 2020 6e61 6d65 3d27 6261 7369        name='basi
+0000a510: 6320 7075 7368 2f70 756c 6c20 2d20 6d75  c push/pull - mu
+0000a520: 6c74 6963 6f6d 706f 6e65 6e74 2070 6174  lticomponent pat
+0000a530: 6827 2c0a 2020 2020 2020 2020 7061 7468  h',.        path
+0000a540: 3d27 2f66 6f6f 2f62 6172 272c 0a20 2020  ='/foo/bar',.   
+0000a550: 2020 2020 2064 7374 3d27 2f62 617a 272c       dst='/baz',
+0000a560: 0a20 2020 2020 2020 2066 696c 6573 3d5b  .        files=[
+0000a570: 272f 666f 6f2f 6261 722f 6261 7a2e 7478  '/foo/bar/baz.tx
+0000a580: 7427 5d2c 0a20 2020 2020 2020 2077 616e  t'],.        wan
+0000a590: 743d 7b27 2f62 617a 2f62 6172 2f62 617a  t={'/baz/bar/baz
+0000a5a0: 2e74 7874 277d 2c0a 2020 2020 292c 0a20  .txt'},.    ),. 
+0000a5b0: 2020 2050 7573 6850 756c 6c43 6173 6528     PushPullCase(
+0000a5c0: 0a20 2020 2020 2020 206e 616d 653d 2770  .        name='p
+0000a5d0: 7573 682f 7075 6c6c 2063 6f6e 7465 6e74  ush/pull content
+0000a5e0: 7327 2c0a 2020 2020 2020 2020 7061 7468  s',.        path
+0000a5f0: 3d27 2f66 6f6f 2f2a 272c 0a20 2020 2020  ='/foo/*',.     
+0000a600: 2020 2064 7374 3d27 2f62 617a 272c 0a20     dst='/baz',. 
+0000a610: 2020 2020 2020 2066 696c 6573 3d5b 272f         files=['/
+0000a620: 666f 6f2f 6261 722e 7478 7427 5d2c 0a20  foo/bar.txt'],. 
+0000a630: 2020 2020 2020 2077 616e 743d 7b27 2f62         want={'/b
+0000a640: 617a 2f62 6172 2e74 7874 277d 2c0a 2020  az/bar.txt'},.  
+0000a650: 2020 292c 0a20 2020 2050 7573 6850 756c    ),.    PushPul
+0000a660: 6c43 6173 6528 0a20 2020 2020 2020 206e  lCase(.        n
+0000a670: 616d 653d 2764 6972 6563 746c 7920 7075  ame='directly pu
+0000a680: 7368 2f70 756c 6c20 6120 7370 6563 6966  sh/pull a specif
+0000a690: 6963 2066 696c 6527 2c0a 2020 2020 2020  ic file',.      
+0000a6a0: 2020 7061 7468 3d27 2f66 6f6f 2f62 6172    path='/foo/bar
+0000a6b0: 2e74 7874 272c 0a20 2020 2020 2020 2064  .txt',.        d
+0000a6c0: 7374 3d27 2f62 617a 272c 0a20 2020 2020  st='/baz',.     
+0000a6d0: 2020 2066 696c 6573 3d5b 272f 666f 6f2f     files=['/foo/
+0000a6e0: 6261 722e 7478 7427 5d2c 0a20 2020 2020  bar.txt'],.     
+0000a6f0: 2020 2077 616e 743d 7b27 2f62 617a 2f62     want={'/baz/b
+0000a700: 6172 2e74 7874 277d 2c0a 2020 2020 292c  ar.txt'},.    ),
+0000a710: 0a20 2020 2050 7573 6850 756c 6c43 6173  .    PushPullCas
+0000a720: 6528 0a20 2020 2020 2020 206e 616d 653d  e(.        name=
+0000a730: 2765 7272 6f72 206f 6e20 7075 7368 2f70  'error on push/p
+0000a740: 756c 6c20 6e6f 6e2d 6578 6973 7469 6e67  ull non-existing
+0000a750: 2066 696c 6527 2c0a 2020 2020 2020 2020   file',.        
+0000a760: 7061 7468 3d27 2f66 6f6f 2f62 6172 2e74  path='/foo/bar.t
+0000a770: 7874 272c 0a20 2020 2020 2020 2064 7374  xt',.        dst
+0000a780: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
+0000a790: 2066 696c 6573 3d5b 5d2c 0a20 2020 2020   files=[],.     
+0000a7a0: 2020 2065 7272 6f72 733d 7b27 2f66 6f6f     errors={'/foo
+0000a7b0: 2f62 6172 2e74 7874 277d 2c0a 2020 2020  /bar.txt'},.    
+0000a7c0: 292c 0a20 2020 2050 7573 6850 756c 6c43  ),.    PushPullC
+0000a7d0: 6173 6528 0a20 2020 2020 2020 206e 616d  ase(.        nam
+0000a7e0: 653d 2770 7573 682f 7075 6c6c 206d 756c  e='push/pull mul
+0000a7f0: 7469 706c 6520 6e6f 6e2d 6578 6973 7469  tiple non-existi
+0000a800: 6e67 2066 696c 6573 272c 0a20 2020 2020  ng files',.     
+0000a810: 2020 2070 6174 683d 5b27 2f66 6f6f 2f62     path=['/foo/b
+0000a820: 6172 2e74 7874 272c 2027 2f62 6f6f 2f66  ar.txt', '/boo/f
+0000a830: 6172 2e74 7874 275d 2c0a 2020 2020 2020  ar.txt'],.      
+0000a840: 2020 6473 743d 272f 6261 7a27 2c0a 2020    dst='/baz',.  
+0000a850: 2020 2020 2020 6669 6c65 733d 5b5d 2c0a        files=[],.
+0000a860: 2020 2020 2020 2020 6572 726f 7273 3d7b          errors={
+0000a870: 272f 666f 6f2f 6261 722e 7478 7427 2c20  '/foo/bar.txt', 
+0000a880: 272f 626f 6f2f 6661 722e 7478 7427 7d2c  '/boo/far.txt'},
+0000a890: 0a20 2020 2029 2c0a 2020 2020 5075 7368  .    ),.    Push
+0000a8a0: 5075 6c6c 4361 7365 280a 2020 2020 2020  PullCase(.      
+0000a8b0: 2020 6e61 6d65 3d27 7075 7368 2f70 756c    name='push/pul
+0000a8c0: 6c20 6669 6c65 2061 6e64 2064 6972 2063  l file and dir c
+0000a8d0: 6f6d 626f 272c 0a20 2020 2020 2020 2070  ombo',.        p
+0000a8e0: 6174 683d 5b27 2f66 6f6f 2f66 6f6f 6261  ath=['/foo/fooba
+0000a8f0: 722e 7478 7427 2c20 272f 666f 6f2f 6261  r.txt', '/foo/ba
+0000a900: 7227 5d2c 0a20 2020 2020 2020 2064 7374  r'],.        dst
+0000a910: 3d27 2f62 617a 272c 0a20 2020 2020 2020  ='/baz',.       
+0000a920: 2066 696c 6573 3d5b 272f 666f 6f2f 6261   files=['/foo/ba
+0000a930: 722f 6261 7a2e 7478 7427 2c20 272f 666f  r/baz.txt', '/fo
+0000a940: 6f2f 666f 6f62 6172 2e74 7874 272c 2027  o/foobar.txt', '
+0000a950: 2f71 7575 782e 7478 7427 5d2c 0a20 2020  /quux.txt'],.   
+0000a960: 2020 2020 2077 616e 743d 7b27 2f62 617a       want={'/baz
+0000a970: 2f66 6f6f 6261 722e 7478 7427 2c20 272f  /foobar.txt', '/
+0000a980: 6261 7a2f 6261 722f 6261 7a2e 7478 7427  baz/bar/baz.txt'
+0000a990: 7d2c 0a20 2020 2029 2c0a 5d0a 0a0a 4070  },.    ),.]...@p
+0000a9a0: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0000a9b0: 6574 7269 7a65 2827 6361 7365 272c 2072  etrize('case', r
+0000a9c0: 6563 7572 7369 7665 5f70 7573 685f 7075  ecursive_push_pu
+0000a9d0: 6c6c 5f63 6173 6573 290a 6465 6620 7465  ll_cases).def te
+0000a9e0: 7374 5f72 6563 7572 7369 7665 5f70 7573  st_recursive_pus
+0000a9f0: 685f 616e 645f 7075 6c6c 2863 6173 6529  h_and_pull(case)
+0000aa00: 3a0a 2020 2020 2320 6675 6c6c 2022 696e  :.    # full "in
+0000aa10: 7465 6772 6174 696f 6e22 2074 6573 7420  tegration" test 
+0000aa20: 6f66 2070 7573 682b 7075 6c6c 0a20 2020  of push+pull.   
+0000aa30: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+0000aa40: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+0000aa50: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+0000aa60: 7461 3d27 2727 0a20 2020 2020 2020 206e  ta='''.        n
+0000aa70: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+0000aa80: 2020 2020 2020 636f 6e74 6169 6e65 7273        containers
+0000aa90: 3a0a 2020 2020 2020 2020 2020 666f 6f3a  :.          foo:
+0000aaa0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0000aab0: 6f75 7263 653a 2066 6f6f 2d69 6d61 6765  ource: foo-image
+0000aac0: 0a20 2020 2020 2020 2027 2727 290a 2020  .        ''').  
+0000aad0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+0000aae0: 290a 2020 2020 6861 726e 6573 732e 7365  ).    harness.se
+0000aaf0: 745f 6361 6e5f 636f 6e6e 6563 7428 2766  t_can_connect('f
+0000ab00: 6f6f 272c 2054 7275 6529 0a20 2020 2063  oo', True).    c
+0000ab10: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
+0000ab20: 2e75 6e69 742e 636f 6e74 6169 6e65 7273  .unit.containers
+0000ab30: 5b27 666f 6f27 5d0a 0a20 2020 2023 2063  ['foo']..    # c
+0000ab40: 7265 6174 6520 7075 7368 2074 6573 7420  reate push test 
+0000ab50: 6361 7365 2066 696c 6573 7973 7465 6d20  case filesystem 
+0000ab60: 7374 7275 6374 7572 650a 2020 2020 7075  structure.    pu
+0000ab70: 7368 5f73 7263 203d 2074 656d 7066 696c  sh_src = tempfil
+0000ab80: 652e 5465 6d70 6f72 6172 7944 6972 6563  e.TemporaryDirec
+0000ab90: 746f 7279 2829 0a20 2020 2066 6f72 2066  tory().    for f
+0000aba0: 696c 6520 696e 2063 6173 652e 6669 6c65  ile in case.file
+0000abb0: 733a 0a20 2020 2020 2020 2066 7061 7468  s:.        fpath
+0000abc0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0000abd0: 7075 7368 5f73 7263 2e6e 616d 652c 2066  push_src.name, f
+0000abe0: 696c 655b 313a 5d29 0a20 2020 2020 2020  ile[1:]).       
+0000abf0: 206f 732e 6d61 6b65 6469 7273 286f 732e   os.makedirs(os.
+0000ac00: 7061 7468 2e64 6972 6e61 6d65 2866 7061  path.dirname(fpa
+0000ac10: 7468 292c 2065 7869 7374 5f6f 6b3d 5472  th), exist_ok=Tr
+0000ac20: 7565 290a 2020 2020 2020 2020 7769 7468  ue).        with
+0000ac30: 206f 7065 6e28 6670 6174 682c 2027 7727   open(fpath, 'w'
+0000ac40: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0000ac50: 2020 2020 662e 7772 6974 6528 2768 656c      f.write('hel
+0000ac60: 6c6f 2729 0a0a 2020 2020 2320 7465 7374  lo')..    # test
+0000ac70: 2070 7573 680a 2020 2020 6966 2069 7369   push.    if isi
+0000ac80: 6e73 7461 6e63 6528 6361 7365 2e70 6174  nstance(case.pat
+0000ac90: 682c 206c 6973 7429 3a0a 2020 2020 2020  h, list):.      
+0000aca0: 2020 2320 7377 6170 2073 6c61 7368 2066    # swap slash f
+0000acb0: 6f72 2064 756d 6d79 2064 6972 206f 6e20  or dummy dir on 
+0000acc0: 726f 6f74 2064 6972 2073 6f20 5061 7468  root dir so Path
+0000acd0: 2e70 6172 656e 7420 646f 6573 6e27 7420  .parent doesn't 
+0000ace0: 7265 7475 726e 2074 6d70 6469 7220 7061  return tmpdir pa
+0000acf0: 7468 2063 6f6d 706f 6e65 6e74 0a20 2020  th component.   
+0000ad00: 2020 2020 2023 206f 7468 6572 7769 7365       # otherwise
+0000ad10: 2072 656d 6f76 6520 6c65 6164 696e 6720   remove leading 
+0000ad20: 736c 6173 6820 736f 2077 6520 6361 6e20  slash so we can 
+0000ad30: 646f 2074 6865 2070 6174 6820 6a6f 696e  do the path join
+0000ad40: 2070 726f 7065 726c 792e 0a20 2020 2020   properly..     
+0000ad50: 2020 2070 7573 685f 7061 7468 203d 205b     push_path = [
+0000ad60: 6f73 2e70 6174 682e 6a6f 696e 2870 7573  os.path.join(pus
+0000ad70: 685f 7372 632e 6e61 6d65 2c20 705b 313a  h_src.name, p[1:
+0000ad80: 5d20 6966 206c 656e 2870 2920 3e20 3120  ] if len(p) > 1 
+0000ad90: 656c 7365 2027 666f 6f27 290a 2020 2020  else 'foo').    
+0000ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000adb0: 2066 6f72 2070 2069 6e20 6361 7365 2e70   for p in case.p
+0000adc0: 6174 685d 0a20 2020 2065 6c73 653a 0a20  ath].    else:. 
+0000add0: 2020 2020 2020 2023 2073 7761 7020 736c         # swap sl
+0000ade0: 6173 6820 666f 7220 6475 6d6d 7920 6469  ash for dummy di
+0000adf0: 7220 6f6e 2072 6f6f 7420 6469 7220 736f  r on root dir so
+0000ae00: 2050 6174 682e 7061 7265 6e74 2064 6f65   Path.parent doe
+0000ae10: 736e 2774 2072 6574 7572 6e20 746d 7064  sn't return tmpd
+0000ae20: 6972 2070 6174 6820 636f 6d70 6f6e 656e  ir path componen
+0000ae30: 740a 2020 2020 2020 2020 2320 6f74 6865  t.        # othe
+0000ae40: 7277 6973 6520 7265 6d6f 7665 206c 6561  rwise remove lea
+0000ae50: 6469 6e67 2073 6c61 7368 2073 6f20 7765  ding slash so we
+0000ae60: 2063 616e 2064 6f20 7468 6520 7061 7468   can do the path
+0000ae70: 206a 6f69 6e20 7072 6f70 6572 6c79 2e0a   join properly..
+0000ae80: 2020 2020 2020 2020 7075 7368 5f70 6174          push_pat
+0000ae90: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0000aea0: 2870 7573 685f 7372 632e 6e61 6d65 2c20  (push_src.name, 
+0000aeb0: 6361 7365 2e70 6174 685b 313a 5d20 6966  case.path[1:] if
+0000aec0: 206c 656e 2863 6173 652e 7061 7468 2920   len(case.path) 
+0000aed0: 3e20 3120 656c 7365 2027 666f 6f27 290a  > 1 else 'foo').
+0000aee0: 0a20 2020 2065 7272 6f72 7320 3d20 5b5d  .    errors = []
+0000aef0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+0000af00: 2020 632e 7075 7368 5f70 6174 6828 7075    c.push_path(pu
+0000af10: 7368 5f70 6174 682c 2063 6173 652e 6473  sh_path, case.ds
+0000af20: 7429 0a20 2020 2065 7863 6570 7420 6f70  t).    except op
+0000af30: 732e 4d75 6c74 6950 7573 6850 756c 6c45  s.MultiPushPullE
+0000af40: 7272 6f72 2061 7320 6572 723a 0a20 2020  rror as err:.   
+0000af50: 2020 2020 2069 6620 6e6f 7420 6361 7365       if not case
+0000af60: 2e65 7272 6f72 733a 0a20 2020 2020 2020  .errors:.       
+0000af70: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+0000af80: 2020 2065 7272 6f72 7320 3d20 7b73 7263     errors = {src
+0000af90: 5b6c 656e 2870 7573 685f 7372 632e 6e61  [len(push_src.na
+0000afa0: 6d65 293a 5d20 666f 7220 7372 632c 205f  me):] for src, _
+0000afb0: 2069 6e20 6572 722e 6572 726f 7273 7d0a   in err.errors}.
+0000afc0: 0a20 2020 2061 7373 6572 7420 6361 7365  .    assert case
+0000afd0: 2e65 7272 6f72 7320 3d3d 2065 7272 6f72  .errors == error
+0000afe0: 732c 205c 0a20 2020 2020 2020 2066 2770  s, \.        f'p
+0000aff0: 7573 685f 7061 7468 2067 6176 6520 7772  ush_path gave wr
+0000b000: 6f6e 6720 6578 7065 6374 6564 2065 7272  ong expected err
+0000b010: 6f72 733a 2077 616e 7420 7b63 6173 652e  ors: want {case.
+0000b020: 6572 726f 7273 7d2c 2067 6f74 207b 6572  errors}, got {er
+0000b030: 726f 7273 7d27 0a20 2020 2066 6f72 2066  rors}'.    for f
+0000b040: 7061 7468 2069 6e20 6361 7365 2e77 616e  path in case.wan
+0000b050: 743a 0a20 2020 2020 2020 2061 7373 6572  t:.        asser
+0000b060: 7420 632e 6578 6973 7473 2866 7061 7468  t c.exists(fpath
+0000b070: 292c 2066 2770 7573 685f 7061 7468 2066  ), f'push_path f
+0000b080: 6169 6c65 643a 2066 696c 6520 7b66 7061  ailed: file {fpa
+0000b090: 7468 7d20 6d69 7373 696e 6720 6174 2064  th} missing at d
+0000b0a0: 6573 7469 6e61 7469 6f6e 270a 0a20 2020  estination'..   
+0000b0b0: 2023 2063 7265 6174 6520 7075 6c6c 2074   # create pull t
+0000b0c0: 6573 7420 6361 7365 2066 696c 6573 7973  est case filesys
+0000b0d0: 7465 6d20 7374 7275 6374 7572 650a 2020  tem structure.  
+0000b0e0: 2020 7075 6c6c 5f64 7374 203d 2074 656d    pull_dst = tem
+0000b0f0: 7066 696c 652e 5465 6d70 6f72 6172 7944  pfile.TemporaryD
+0000b100: 6972 6563 746f 7279 2829 0a20 2020 2066  irectory().    f
+0000b110: 6f72 2066 7061 7468 2069 6e20 6361 7365  or fpath in case
+0000b120: 2e66 696c 6573 3a0a 2020 2020 2020 2020  .files:.        
+0000b130: 632e 7075 7368 2866 7061 7468 2c20 2768  c.push(fpath, 'h
+0000b140: 656c 6c6f 272c 206d 616b 655f 6469 7273  ello', make_dirs
+0000b150: 3d54 7275 6529 0a0a 2020 2020 2320 7465  =True)..    # te
+0000b160: 7374 2070 756c 6c0a 2020 2020 6572 726f  st pull.    erro
+0000b170: 7273 203d 205b 5d0a 2020 2020 7472 793a  rs = [].    try:
+0000b180: 0a20 2020 2020 2020 2063 2e70 756c 6c5f  .        c.pull_
+0000b190: 7061 7468 2863 6173 652e 7061 7468 2c20  path(case.path, 
+0000b1a0: 6f73 2e70 6174 682e 6a6f 696e 2870 756c  os.path.join(pul
+0000b1b0: 6c5f 6473 742e 6e61 6d65 2c20 6361 7365  l_dst.name, case
+0000b1c0: 2e64 7374 5b31 3a5d 2929 0a20 2020 2065  .dst[1:])).    e
+0000b1d0: 7863 6570 7420 6f70 732e 4d75 6c74 6950  xcept ops.MultiP
+0000b1e0: 7573 6850 756c 6c45 7272 6f72 2061 7320  ushPullError as 
+0000b1f0: 6572 723a 0a20 2020 2020 2020 2069 6620  err:.        if 
+0000b200: 6e6f 7420 6361 7365 2e65 7272 6f72 733a  not case.errors:
+0000b210: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000b220: 7365 0a20 2020 2020 2020 2065 7272 6f72  se.        error
+0000b230: 7320 3d20 7b73 7263 2066 6f72 2073 7263  s = {src for src
+0000b240: 2c20 5f20 696e 2065 7272 2e65 7272 6f72  , _ in err.error
+0000b250: 737d 0a0a 2020 2020 6173 7365 7274 2063  s}..    assert c
+0000b260: 6173 652e 6572 726f 7273 203d 3d20 6572  ase.errors == er
+0000b270: 726f 7273 2c20 5c0a 2020 2020 2020 2020  rors, \.        
+0000b280: 6627 7075 6c6c 5f70 6174 6820 6761 7665  f'pull_path gave
+0000b290: 2077 726f 6e67 2065 7870 6563 7465 6420   wrong expected 
+0000b2a0: 6572 726f 7273 3a20 7761 6e74 207b 6361  errors: want {ca
+0000b2b0: 7365 2e65 7272 6f72 737d 2c20 676f 7420  se.errors}, got 
+0000b2c0: 7b65 7272 6f72 737d 270a 2020 2020 666f  {errors}'.    fo
+0000b2d0: 7220 6670 6174 6820 696e 2063 6173 652e  r fpath in case.
+0000b2e0: 7761 6e74 3a0a 2020 2020 2020 2020 6173  want:.        as
+0000b2f0: 7365 7274 2063 2e65 7869 7374 7328 6670  sert c.exists(fp
+0000b300: 6174 6829 2c20 6627 7075 6c6c 5f70 6174  ath), f'pull_pat
+0000b310: 6820 6661 696c 6564 3a20 6669 6c65 207b  h failed: file {
+0000b320: 6670 6174 687d 206d 6973 7369 6e67 2061  fpath} missing a
+0000b330: 7420 6465 7374 696e 6174 696f 6e27 0a0a  t destination'..
+0000b340: 0a63 6c61 7373 2054 6573 7441 7070 6c69  .class TestAppli
+0000b350: 6361 7469 6f6e 2875 6e69 7474 6573 742e  cation(unittest.
+0000b360: 5465 7374 4361 7365 293a 0a0a 2020 2020  TestCase):..    
+0000b370: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
+0000b380: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+0000b390: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+0000b3a0: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
+0000b3b0: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
+0000b3c0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+0000b3d0: 6e61 6d65 3a20 6d79 6170 700a 2020 2020  name: myapp.    
+0000b3e0: 2020 2020 2020 2020 7072 6f76 6964 6573          provides
+0000b3f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b400: 6462 303a 0a20 2020 2020 2020 2020 2020  db0:.           
+0000b410: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+0000b420: 6462 300a 2020 2020 2020 2020 2020 2020  db0.            
+0000b430: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
+0000b440: 2020 2020 2020 2020 6462 313a 0a20 2020          db1:.   
+0000b450: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0000b460: 6572 6661 6365 3a20 6462 310a 2020 2020  erface: db1.    
+0000b470: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
+0000b480: 2020 2020 2020 2020 2020 2020 2064 6232               db2
+0000b490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b4a0: 2020 696e 7465 7266 6163 653a 2064 6232    interface: db2
+0000b4b0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0000b4c0: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
+0000b4d0: 2020 2020 2020 666f 6f3a 207b 7479 7065        foo: {type
+0000b4e0: 3a20 6669 6c65 2c20 6669 6c65 6e61 6d65  : file, filename
+0000b4f0: 3a20 666f 6f2e 7478 747d 0a20 2020 2020  : foo.txt}.     
+0000b500: 2020 2020 2020 2020 2062 6172 3a20 7b74           bar: {t
+0000b510: 7970 653a 2066 696c 652c 2066 696c 656e  ype: file, filen
+0000b520: 616d 653a 2062 6172 2e74 7874 7d0a 2020  ame: bar.txt}.  
+0000b530: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
+0000b540: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
+0000b550: 2020 2020 6261 723a 0a20 2020 2020 2020      bar:.       
+0000b560: 2020 2020 2020 2020 206b 3a20 760a 2020           k: v.  
+0000b570: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+0000b580: 2020 2073 656c 662e 7065 6572 5f72 656c     self.peer_rel
+0000b590: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
+0000b5a0: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+0000b5b0: 2764 6232 272c 2027 6462 3227 290a 2020  'db2', 'db2').  
+0000b5c0: 2020 2020 2020 7365 6c66 2e61 7070 203d        self.app =
+0000b5d0: 2073 656c 662e 6861 726e 6573 732e 6d6f   self.harness.mo
+0000b5e0: 6465 6c2e 6170 700a 2020 2020 2020 2020  del.app.        
+0000b5f0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0000b600: 7365 6c66 2e68 6172 6e65 7373 2e63 6c65  self.harness.cle
+0000b610: 616e 7570 290a 0a20 2020 2023 2054 6573  anup)..    # Tes
+0000b620: 7473 2066 6978 2066 6f72 2068 7474 7073  ts fix for https
+0000b630: 3a2f 2f67 6974 6875 622e 636f 6d2f 6361  ://github.com/ca
+0000b640: 6e6f 6e69 6361 6c2f 6f70 6572 6174 6f72  nonical/operator
+0000b650: 2f69 7373 7565 732f 3639 342e 0a20 2020  /issues/694..   
+0000b660: 2064 6566 2074 6573 745f 6d6f 636b 6564   def test_mocked
+0000b670: 5f67 6574 5f73 6572 7669 6365 7328 7365  _get_services(se
+0000b680: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+0000b690: 662e 6861 726e 6573 732e 6265 6769 6e28  f.harness.begin(
+0000b6a0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
+0000b6b0: 6172 6e65 7373 2e73 6574 5f63 616e 5f63  arness.set_can_c
+0000b6c0: 6f6e 6e65 6374 2827 6261 7227 2c20 5472  onnect('bar', Tr
+0000b6d0: 7565 290a 2020 2020 2020 2020 6320 3d20  ue).        c = 
+0000b6e0: 7365 6c66 2e68 6172 6e65 7373 2e63 6861  self.harness.cha
+0000b6f0: 726d 2e75 6e69 742e 6765 745f 636f 6e74  rm.unit.get_cont
+0000b700: 6169 6e65 7228 2762 6172 2729 0a20 2020  ainer('bar').   
+0000b710: 2020 2020 2063 2e61 6464 5f6c 6179 6572       c.add_layer
+0000b720: 2827 6c61 7965 7231 272c 207b 0a20 2020  ('layer1', {.   
+0000b730: 2020 2020 2020 2020 2027 7375 6d6d 6172           'summar
+0000b740: 7927 3a20 276c 6179 6572 272c 0a20 2020  y': 'layer',.   
+0000b750: 2020 2020 2020 2020 2027 7365 7276 6963           'servic
+0000b760: 6573 273a 207b 2262 617a 223a 207b 276f  es': {"baz": {'o
+0000b770: 7665 7272 6964 6527 3a20 2772 6570 6c61  verride': 'repla
+0000b780: 6365 272c 2027 7375 6d6d 6172 7927 3a20  ce', 'summary': 
+0000b790: 2765 6368 6f27 2c20 2763 6f6d 6d61 6e64  'echo', 'command
+0000b7a0: 273a 2027 6563 686f 2031 277d 7d2c 0a20  ': 'echo 1'}},. 
+0000b7b0: 2020 2020 2020 207d 290a 0a20 2020 2020         })..     
+0000b7c0: 2020 2073 203d 2063 2e67 6574 5f73 6572     s = c.get_ser
+0000b7d0: 7669 6365 2827 6261 7a27 2920 2023 2053  vice('baz')  # S
+0000b7e0: 6f20 6661 722c 2073 6f20 676f 6f64 0a20  o far, so good. 
+0000b7f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000b800: 7274 5472 7565 2873 290a 2020 2020 2020  rtTrue(s).      
+0000b810: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0000b820: 6528 2762 617a 2720 696e 2063 2e67 6574  e('baz' in c.get
+0000b830: 5f73 6572 7669 6365 7328 2929 0a0a 2020  _services())..  
+0000b840: 2020 6465 6620 7465 7374 5f70 6c61 6e6e    def test_plann
+0000b850: 6564 5f75 6e69 7473 2873 656c 6629 3a0a  ed_units(self):.
+0000b860: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
+0000b870: 2073 656c 662e 7065 6572 5f72 656c 5f69   self.peer_rel_i
+0000b880: 640a 0a20 2020 2020 2020 2023 2054 6573  d..        # Tes
+0000b890: 7420 7468 6174 2077 6520 616c 7761 7973  t that we always
+0000b8a0: 2063 6f75 6e74 206f 7572 7365 6c66 2e0a   count ourself..
+0000b8b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000b8c0: 6572 7445 7175 616c 2873 656c 662e 6170  ertEqual(self.ap
+0000b8d0: 702e 706c 616e 6e65 645f 756e 6974 7328  p.planned_units(
+0000b8e0: 292c 2031 290a 0a20 2020 2020 2020 2023  ), 1)..        #
+0000b8f0: 2041 6464 2073 6f6d 6520 756e 6974 732c   Add some units,
+0000b900: 2061 6e64 2076 6572 6966 7920 636f 756e   and verify coun
+0000b910: 742e 0a20 2020 2020 2020 2073 656c 662e  t..        self.
+0000b920: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0000b930: 7469 6f6e 5f75 6e69 7428 7265 6c5f 6964  tion_unit(rel_id
+0000b940: 2c20 276d 7961 7070 2f31 2729 0a20 2020  , 'myapp/1').   
+0000b950: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+0000b960: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+0000b970: 6e69 7428 7265 6c5f 6964 2c20 276d 7961  nit(rel_id, 'mya
+0000b980: 7070 2f32 2729 0a0a 2020 2020 2020 2020  pp/2')..        
+0000b990: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000b9a0: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
+0000b9b0: 645f 756e 6974 7328 292c 2033 290a 0a20  d_units(), 3).. 
+0000b9c0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+0000b9d0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+0000b9e0: 5f75 6e69 7428 7265 6c5f 6964 2c20 276d  _unit(rel_id, 'm
+0000b9f0: 7961 7070 2f33 2729 0a20 2020 2020 2020  yapp/3').       
+0000ba00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ba10: 6c28 7365 6c66 2e61 7070 2e70 6c61 6e6e  l(self.app.plann
+0000ba20: 6564 5f75 6e69 7473 2829 2c20 3429 0a0a  ed_units(), 4)..
+0000ba30: 2020 2020 2020 2020 2320 416e 6420 7265          # And re
+0000ba40: 6d6f 7665 2061 2075 6e69 740a 2020 2020  move a unit.    
+0000ba50: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0000ba60: 2e72 656d 6f76 655f 7265 6c61 7469 6f6e  .remove_relation
+0000ba70: 5f75 6e69 7428 7265 6c5f 6964 2c20 276d  _unit(rel_id, 'm
+0000ba80: 7961 7070 2f32 2729 0a0a 2020 2020 2020  yapp/2')..      
+0000ba90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000baa0: 616c 2873 656c 662e 6170 702e 706c 616e  al(self.app.plan
+0000bab0: 6e65 645f 756e 6974 7328 292c 2033 290a  ned_units(), 3).
+0000bac0: 0a20 2020 2064 6566 2074 6573 745f 706c  .    def test_pl
+0000bad0: 616e 6e65 645f 756e 6974 735f 7573 6572  anned_units_user
+0000bae0: 5f73 6574 2873 656c 6629 3a0a 0a20 2020  _set(self):..   
+0000baf0: 2020 2020 2073 656c 662e 6861 726e 6573       self.harnes
+0000bb00: 732e 7365 745f 706c 616e 6e65 645f 756e  s.set_planned_un
+0000bb10: 6974 7328 3129 0a20 2020 2020 2020 2073  its(1).        s
+0000bb20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000bb30: 7365 6c66 2e61 7070 2e70 6c61 6e6e 6564  self.app.planned
+0000bb40: 5f75 6e69 7473 2829 2c20 3129 0a0a 2020  _units(), 1)..  
+0000bb50: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0000bb60: 7373 2e73 6574 5f70 6c61 6e6e 6564 5f75  ss.set_planned_u
+0000bb70: 6e69 7473 2832 290a 2020 2020 2020 2020  nits(2).        
+0000bb80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000bb90: 2873 656c 662e 6170 702e 706c 616e 6e65  (self.app.planne
+0000bba0: 645f 756e 6974 7328 292c 2032 290a 0a20  d_units(), 2).. 
+0000bbb0: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+0000bbc0: 6573 732e 7365 745f 706c 616e 6e65 645f  ess.set_planned_
+0000bbd0: 756e 6974 7328 3130 3029 0a20 2020 2020  units(100).     
+0000bbe0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000bbf0: 7561 6c28 7365 6c66 2e61 7070 2e70 6c61  ual(self.app.pla
+0000bc00: 6e6e 6564 5f75 6e69 7473 2829 2c20 3130  nned_units(), 10
+0000bc10: 3029 0a0a 2020 2020 6465 6620 7465 7374  0)..    def test
+0000bc20: 5f70 6c61 6e6e 6564 5f75 6e69 7473 5f67  _planned_units_g
+0000bc30: 6172 6261 6765 5f76 616c 7565 7328 7365  arbage_values(se
+0000bc40: 6c66 293a 0a20 2020 2020 2020 2023 2050  lf):.        # P
+0000bc50: 6c61 6e6e 6564 2075 6e69 7473 2073 686f  lanned units sho
+0000bc60: 756c 6420 6265 2061 2070 6f73 6974 6976  uld be a positiv
+0000bc70: 6520 696e 7465 6765 722c 206f 7220 7a65  e integer, or ze
+0000bc80: 726f 2e0a 2020 2020 2020 2020 7769 7468  ro..        with
+0000bc90: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000bca0: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
+0000bcb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000bcc0: 6861 726e 6573 732e 7365 745f 706c 616e  harness.set_plan
+0000bcd0: 6e65 645f 756e 6974 7328 2d31 290a 2020  ned_units(-1).  
+0000bce0: 2020 2020 2020 2320 5665 7269 6679 2074        # Verify t
+0000bcf0: 6861 7420 7765 2064 6964 6e27 7420 7365  hat we didn't se
+0000bd00: 7420 6f75 7220 7661 6c75 6520 6265 666f  t our value befo
+0000bd10: 7265 2072 6169 7369 6e67 2074 6865 2065  re raising the e
+0000bd20: 7272 6f72 2e0a 2020 2020 2020 2020 7365  rror..        se
+0000bd30: 6c66 2e61 7373 6572 7454 7275 6528 7365  lf.assertTrue(se
+0000bd40: 6c66 2e68 6172 6e65 7373 2e5f 6261 636b  lf.harness._back
+0000bd50: 656e 642e 5f70 6c61 6e6e 6564 5f75 6e69  end._planned_uni
+0000bd60: 7473 2069 7320 4e6f 6e65 290a 2020 2020  ts is None).    
+0000bd70: 2020 2020 2320 5665 7269 6679 2074 6861      # Verify tha
+0000bd80: 7420 7765 2073 7469 6c6c 2067 6574 2074  t we still get t
+0000bd90: 6865 2064 6566 6175 6c74 2076 616c 7565  he default value
+0000bda0: 2062 6163 6b20 6672 6f6d 202e 706c 616e   back from .plan
+0000bdb0: 6e65 645f 756e 6974 732e 0a20 2020 2020  ned_units..     
+0000bdc0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000bdd0: 7561 6c28 7365 6c66 2e61 7070 2e70 6c61  ual(self.app.pla
+0000bde0: 6e6e 6564 5f75 6e69 7473 2829 2c20 3129  nned_units(), 1)
+0000bdf0: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+0000be00: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0000be10: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+0000be20: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+0000be30: 726e 6573 732e 7365 745f 706c 616e 6e65  rness.set_planne
+0000be40: 645f 756e 6974 7328 2266 6f6f 2229 0a0a  d_units("foo")..
+0000be50: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0000be60: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
+0000be70: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
+0000be80: 2020 2020 2020 2073 656c 662e 6861 726e         self.harn
+0000be90: 6573 732e 7365 745f 706c 616e 6e65 645f  ess.set_planned_
+0000bea0: 756e 6974 7328 2d33 3432 3330 3030 3130  units(-342300010
+0000beb0: 3233 3132 3332 3130 3930 290a 0a20 2020  2312321090)..   
+0000bec0: 2064 6566 2074 6573 745f 706c 616e 6e65   def test_planne
+0000bed0: 645f 756e 6974 735f 6f76 6572 7269 6465  d_units_override
+0000bee0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000bef0: 2222 2256 6572 6966 7920 7468 6174 2077  """Verify that w
+0000bf00: 6520 6f76 6572 7269 6465 2074 6865 2063  e override the c
+0000bf10: 616c 6375 6c61 7465 6420 7661 6c75 6520  alculated value 
+0000bf20: 6f66 2070 6c61 6e6e 6564 5f75 6e69 7473  of planned_units
+0000bf30: 2077 6865 6e20 7765 2073 6574 2069 7420   when we set it 
+0000bf40: 6d61 6e75 616c 6c79 2e0a 0a20 2020 2020  manually...     
+0000bf50: 2020 2057 6865 6e20 6120 6368 6172 6d20     When a charm 
+0000bf60: 6175 7468 6f72 2077 7269 7465 7320 6120  author writes a 
+0000bf70: 7465 7374 2074 6861 7420 6578 706c 6963  test that explic
+0000bf80: 6974 6c79 2063 616c 6c73 2073 6574 5f70  itly calls set_p
+0000bf90: 6c61 6e6e 6564 5f75 6e69 7473 2c20 7765  lanned_units, we
+0000bfa0: 2061 7373 756d 6520 7468 6174 0a20 2020   assume that.   
+0000bfb0: 2020 2020 2074 6865 6972 2069 6e74 656e       their inten
+0000bfc0: 7420 6973 2074 6f20 6f76 6572 7269 6465  t is to override
+0000bfd0: 2074 6865 2063 616c 6375 6c61 7465 6420   the calculated 
+0000bfe0: 7265 7475 726e 2076 616c 7565 2e20 4f66  return value. Of
+0000bff0: 7465 6e2c 2074 6869 7320 7769 6c6c 2062  ten, this will b
+0000c000: 6520 6265 6361 7573 6520 7468 650a 2020  e because the.  
+0000c010: 2020 2020 2020 6368 6172 6d20 6175 7468        charm auth
+0000c020: 6f72 2069 7320 636f 6d70 6f73 696e 6720  or is composing 
+0000c030: 6120 6368 6172 6d20 7769 7468 6f75 7420  a charm without 
+0000c040: 7065 6572 2072 656c 6174 696f 6e73 2c20  peer relations, 
+0000c050: 616e 6420 7468 6520 6861 726e 6573 7327  and the harness'
+0000c060: 7320 636f 756e 7420 6f66 0a20 2020 2020  s count of.     
+0000c070: 2020 2070 6c61 6e6e 6564 2075 6e69 7473     planned units
+0000c080: 2c20 7768 6963 6820 6973 2062 6173 6564  , which is based
+0000c090: 206f 6e20 7468 6520 6e75 6d62 6572 206f   on the number o
+0000c0a0: 6620 7065 6572 2072 656c 6174 696f 6e73  f peer relations
+0000c0b0: 2c20 7769 6c6c 206e 6f74 2062 6520 6163  , will not be ac
+0000c0c0: 6375 7261 7465 2e0a 2020 2020 2020 2020  curate..        
+0000c0d0: 2222 220a 2020 2020 2020 2020 7065 6572  """.        peer
+0000c0e0: 5f69 6420 3d20 7365 6c66 2e70 6565 725f  _id = self.peer_
+0000c0f0: 7265 6c5f 6964 0a0a 2020 2020 2020 2020  rel_id..        
+0000c100: 7365 6c66 2e68 6172 6e65 7373 2e73 6574  self.harness.set
+0000c110: 5f70 6c61 6e6e 6564 5f75 6e69 7473 2831  _planned_units(1
+0000c120: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+0000c130: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0000c140: 7469 6f6e 5f75 6e69 7428 7065 6572 5f69  tion_unit(peer_i
+0000c150: 642c 2027 6d79 6170 702f 3127 290a 2020  d, 'myapp/1').  
+0000c160: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0000c170: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
+0000c180: 756e 6974 2870 6565 725f 6964 2c20 276d  unit(peer_id, 'm
+0000c190: 7961 7070 2f32 2729 0a20 2020 2020 2020  yapp/2').       
+0000c1a0: 2073 656c 662e 6861 726e 6573 732e 6164   self.harness.ad
+0000c1b0: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+0000c1c0: 7065 6572 5f69 642c 2027 6d79 6170 702f  peer_id, 'myapp/
+0000c1d0: 3327 290a 0a20 2020 2020 2020 2073 656c  3')..        sel
+0000c1e0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000c1f0: 6c66 2e61 7070 2e70 6c61 6e6e 6564 5f75  lf.app.planned_u
+0000c200: 6e69 7473 2829 2c20 3130 290a 0a20 2020  nits(), 10)..   
+0000c210: 2020 2020 2023 2056 6572 6966 7920 7468       # Verify th
+0000c220: 6174 2077 6520 6361 6e20 636c 6561 7220  at we can clear 
+0000c230: 7468 6520 6f76 6572 7269 6465 2e0a 2020  the override..  
+0000c240: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0000c250: 7373 2e72 6573 6574 5f70 6c61 6e6e 6564  ss.reset_planned
+0000c260: 5f75 6e69 7473 2829 0a20 2020 2020 2020  _units().       
+0000c270: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000c280: 6c28 7365 6c66 2e61 7070 2e70 6c61 6e6e  l(self.app.plann
+0000c290: 6564 5f75 6e69 7473 2829 2c20 3429 2020  ed_units(), 4)  
+0000c2a0: 2320 7365 6c66 202b 2033 2070 6565 7273  # self + 3 peers
+0000c2b0: 0a0a 0a63 6c61 7373 2054 6573 7443 6f6e  ...class TestCon
+0000c2c0: 7461 696e 6572 7328 756e 6974 7465 7374  tainers(unittest
+0000c2d0: 2e54 6573 7443 6173 6529 3a0a 2020 2020  .TestCase):.    
+0000c2e0: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
+0000c2f0: 0a20 2020 2020 2020 206d 6574 6120 3d20  .        meta = 
+0000c300: 6f70 732e 4368 6172 6d4d 6574 612e 6672  ops.CharmMeta.fr
+0000c310: 6f6d 5f79 616d 6c28 2222 220a 6e61 6d65  om_yaml(""".name
+0000c320: 3a20 6b38 732d 6368 6172 6d0a 636f 6e74  : k8s-charm.cont
+0000c330: 6169 6e65 7273 3a0a 2020 6331 3a0a 2020  ainers:.  c1:.  
+0000c340: 2020 6b3a 2076 0a20 2063 323a 0a20 2020    k: v.  c2:.   
+0000c350: 206b 3a20 760a 2222 2229 0a20 2020 2020   k: v.""").     
+0000c360: 2020 2062 6163 6b65 6e64 203d 205f 4d6f     backend = _Mo
+0000c370: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
+0000c380: 702f 3027 290a 2020 2020 2020 2020 7365  p/0').        se
+0000c390: 6c66 2e6d 6f64 656c 203d 206f 7073 2e4d  lf.model = ops.M
+0000c3a0: 6f64 656c 286d 6574 612c 2062 6163 6b65  odel(meta, backe
+0000c3b0: 6e64 290a 0a20 2020 2064 6566 2074 6573  nd)..    def tes
+0000c3c0: 745f 756e 6974 5f63 6f6e 7461 696e 6572  t_unit_container
+0000c3d0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000c3e0: 2063 6f6e 7461 696e 6572 7320 3d20 7365   containers = se
+0000c3f0: 6c66 2e6d 6f64 656c 2e75 6e69 742e 636f  lf.model.unit.co
+0000c400: 6e74 6169 6e65 7273 0a20 2020 2020 2020  ntainers.       
+0000c410: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000c420: 6c28 736f 7274 6564 2863 6f6e 7461 696e  l(sorted(contain
+0000c430: 6572 7329 2c20 5b27 6331 272c 2027 6332  ers), ['c1', 'c2
+0000c440: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
+0000c450: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+0000c460: 2863 6f6e 7461 696e 6572 7329 2c20 3229  (containers), 2)
+0000c470: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000c480: 7365 7274 496e 2827 6331 272c 2063 6f6e  sertIn('c1', con
+0000c490: 7461 696e 6572 7329 0a20 2020 2020 2020  tainers).       
+0000c4a0: 2073 656c 662e 6173 7365 7274 496e 2827   self.assertIn('
+0000c4b0: 6332 272c 2063 6f6e 7461 696e 6572 7329  c2', containers)
+0000c4c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000c4d0: 7365 7274 4e6f 7449 6e28 2763 3327 2c20  sertNotIn('c3', 
+0000c4e0: 636f 6e74 6169 6e65 7273 290a 2020 2020  containers).    
+0000c4f0: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
+0000c500: 5b27 6331 272c 2027 6332 275d 3a0a 2020  ['c1', 'c2']:.  
+0000c510: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
+0000c520: 6e65 7220 3d20 636f 6e74 6169 6e65 7273  ner = containers
+0000c530: 5b6e 616d 655d 0a20 2020 2020 2020 2020  [name].         
+0000c540: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0000c550: 496e 7374 616e 6365 2863 6f6e 7461 696e  Instance(contain
+0000c560: 6572 2c20 6f70 732e 436f 6e74 6169 6e65  er, ops.Containe
+0000c570: 7229 0a20 2020 2020 2020 2020 2020 2073  r).            s
+0000c580: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000c590: 636f 6e74 6169 6e65 722e 6e61 6d65 2c20  container.name, 
+0000c5a0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0000c5b0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+0000c5c0: 6e73 7461 6e63 6528 636f 6e74 6169 6e65  nstance(containe
+0000c5d0: 722e 7065 6262 6c65 2c20 7065 6262 6c65  r.pebble, pebble
+0000c5e0: 2e43 6c69 656e 7429 0a20 2020 2020 2020  .Client).       
+0000c5f0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000c600: 7452 6169 7365 7328 4b65 7945 7272 6f72  tRaises(KeyError
+0000c610: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+0000c620: 6f6e 7461 696e 6572 735b 2763 3327 5d0a  ontainers['c3'].
+0000c630: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0000c640: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0000c650: 5275 6e74 696d 6545 7272 6f72 293a 0a20  RuntimeError):. 
+0000c660: 2020 2020 2020 2020 2020 206f 7468 6572             other
+0000c670: 5f75 6e69 7420 3d20 7365 6c66 2e6d 6f64  _unit = self.mod
+0000c680: 656c 2e67 6574 5f75 6e69 7428 276f 7468  el.get_unit('oth
+0000c690: 6572 2729 0a20 2020 2020 2020 2020 2020  er').           
+0000c6a0: 206f 7468 6572 5f75 6e69 742e 636f 6e74   other_unit.cont
+0000c6b0: 6169 6e65 7273 0a0a 2020 2020 6465 6620  ainers..    def 
+0000c6c0: 7465 7374 5f75 6e69 745f 6765 745f 636f  test_unit_get_co
+0000c6d0: 6e74 6169 6e65 7228 7365 6c66 293a 0a20  ntainer(self):. 
+0000c6e0: 2020 2020 2020 2075 6e69 7420 3d20 7365         unit = se
+0000c6f0: 6c66 2e6d 6f64 656c 2e75 6e69 740a 2020  lf.model.unit.  
+0000c700: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
+0000c710: 6e20 5b27 6331 272c 2027 6332 275d 3a0a  n ['c1', 'c2']:.
+0000c720: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000c730: 6169 6e65 7220 3d20 756e 6974 2e67 6574  ainer = unit.get
+0000c740: 5f63 6f6e 7461 696e 6572 286e 616d 6529  _container(name)
+0000c750: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000c760: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+0000c770: 6365 2863 6f6e 7461 696e 6572 2c20 6f70  ce(container, op
+0000c780: 732e 436f 6e74 6169 6e65 7229 0a20 2020  s.Container).   
+0000c790: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0000c7a0: 7365 7274 4571 7561 6c28 636f 6e74 6169  sertEqual(contai
+0000c7b0: 6e65 722e 6e61 6d65 2c20 6e61 6d65 290a  ner.name, name).
+0000c7c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000c7d0: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+0000c7e0: 6528 636f 6e74 6169 6e65 722e 7065 6262  e(container.pebb
+0000c7f0: 6c65 2c20 7065 6262 6c65 2e43 6c69 656e  le, pebble.Clien
+0000c800: 7429 0a20 2020 2020 2020 2077 6974 6820  t).        with 
+0000c810: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0000c820: 7328 6f70 732e 4d6f 6465 6c45 7272 6f72  s(ops.ModelError
+0000c830: 293a 0a20 2020 2020 2020 2020 2020 2075  ):.            u
+0000c840: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
+0000c850: 7228 2763 3327 290a 0a20 2020 2020 2020  r('c3')..       
+0000c860: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000c870: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
+0000c880: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0000c890: 2020 206f 7468 6572 5f75 6e69 7420 3d20     other_unit = 
+0000c8a0: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f75  self.model.get_u
+0000c8b0: 6e69 7428 276f 7468 6572 2729 0a20 2020  nit('other').   
+0000c8c0: 2020 2020 2020 2020 206f 7468 6572 5f75           other_u
+0000c8d0: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
+0000c8e0: 7228 2766 6f6f 2729 0a0a 0a63 6c61 7373  r('foo')...class
+0000c8f0: 2054 6573 7443 6f6e 7461 696e 6572 5065   TestContainerPe
+0000c900: 6262 6c65 2875 6e69 7474 6573 742e 5465  bble(unittest.Te
+0000c910: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+0000c920: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0000c930: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
+0000c940: 2e43 6861 726d 4d65 7461 2e66 726f 6d5f  .CharmMeta.from_
+0000c950: 7961 6d6c 2822 2222 0a6e 616d 653a 206b  yaml(""".name: k
+0000c960: 3873 2d63 6861 726d 0a63 6f6e 7461 696e  8s-charm.contain
+0000c970: 6572 733a 0a20 2063 313a 0a20 2020 206b  ers:.  c1:.    k
+0000c980: 3a20 760a 2222 2229 0a20 2020 2020 2020  : v.""").       
+0000c990: 2062 6163 6b65 6e64 203d 204d 6f63 6b50   backend = MockP
+0000c9a0: 6562 626c 6542 6163 6b65 6e64 2827 6d79  ebbleBackend('my
+0000c9b0: 6170 702f 3027 290a 2020 2020 2020 2020  app/0').        
+0000c9c0: 7365 6c66 2e6d 6f64 656c 203d 206f 7073  self.model = ops
+0000c9d0: 2e4d 6f64 656c 286d 6574 612c 2062 6163  .Model(meta, bac
+0000c9e0: 6b65 6e64 290a 2020 2020 2020 2020 7365  kend).        se
+0000c9f0: 6c66 2e63 6f6e 7461 696e 6572 203d 2073  lf.container = s
+0000ca00: 656c 662e 6d6f 6465 6c2e 756e 6974 2e63  elf.model.unit.c
+0000ca10: 6f6e 7461 696e 6572 735b 2763 3127 5d0a  ontainers['c1'].
+0000ca20: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000ca30: 626c 6520 3d20 7365 6c66 2e63 6f6e 7461  ble = self.conta
+0000ca40: 696e 6572 2e70 6562 626c 650a 0a20 2020  iner.pebble..   
+0000ca50: 2064 6566 2074 6573 745f 736f 636b 6574   def test_socket
+0000ca60: 5f70 6174 6828 7365 6c66 293a 0a20 2020  _path(self):.   
+0000ca70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000ca80: 4571 7561 6c28 7365 6c66 2e70 6562 626c  Equal(self.pebbl
+0000ca90: 652e 736f 636b 6574 5f70 6174 682c 2027  e.socket_path, '
+0000caa0: 2f63 6861 726d 2f63 6f6e 7461 696e 6572  /charm/container
+0000cab0: 732f 6331 2f70 6562 626c 652e 736f 636b  s/c1/pebble.sock
+0000cac0: 6574 2729 0a0a 2020 2020 6465 6620 7465  et')..    def te
+0000cad0: 7374 5f61 7574 6f73 7461 7274 2873 656c  st_autostart(sel
+0000cae0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000caf0: 2e63 6f6e 7461 696e 6572 2e61 7574 6f73  .container.autos
+0000cb00: 7461 7274 2829 0a20 2020 2020 2020 2073  tart().        s
+0000cb10: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000cb20: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
+0000cb30: 6573 7473 2c20 5b28 2761 7574 6f73 7461  ests, [('autosta
+0000cb40: 7274 272c 295d 290a 0a20 2020 2064 6566  rt',)])..    def
+0000cb50: 2074 6573 745f 7265 706c 616e 2873 656c   test_replan(sel
+0000cb60: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+0000cb70: 2e63 6f6e 7461 696e 6572 2e72 6570 6c61  .container.repla
+0000cb80: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
+0000cb90: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+0000cba0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+0000cbb0: 732c 205b 2827 7265 706c 616e 272c 295d  s, [('replan',)]
+0000cbc0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000cbd0: 6361 6e5f 636f 6e6e 6563 7428 7365 6c66  can_connect(self
+0000cbe0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000cbf0: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
+0000cc00: 2e61 7070 656e 6428 7065 6262 6c65 2e53  .append(pebble.S
+0000cc10: 7973 7465 6d49 6e66 6f2e 6672 6f6d 5f64  ystemInfo.from_d
+0000cc20: 6963 7428 7b27 7665 7273 696f 6e27 3a20  ict({'version': 
+0000cc30: 2731 2e30 2e30 277d 2929 0a20 2020 2020  '1.0.0'})).     
+0000cc40: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+0000cc50: 7565 2873 656c 662e 636f 6e74 6169 6e65  ue(self.containe
+0000cc60: 722e 6361 6e5f 636f 6e6e 6563 7428 2929  r.can_connect())
+0000cc70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000cc80: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
+0000cc90: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
+0000cca0: 5b28 2767 6574 5f73 7973 7465 6d5f 696e  [('get_system_in
+0000ccb0: 666f 272c 295d 290a 0a20 2020 2064 6566  fo',)])..    def
+0000ccc0: 2074 6573 745f 7374 6172 7428 7365 6c66   test_start(self
+0000ccd0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000cce0: 636f 6e74 6169 6e65 722e 7374 6172 7428  container.start(
+0000ccf0: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
+0000cd00: 656c 662e 636f 6e74 6169 6e65 722e 7374  elf.container.st
+0000cd10: 6172 7428 2766 6f6f 272c 2027 6261 7227  art('foo', 'bar'
+0000cd20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000cd30: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000cd40: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+0000cd50: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000cd60: 2773 7461 7274 272c 2028 2766 6f6f 272c  'start', ('foo',
+0000cd70: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0000cd80: 2827 7374 6172 7427 2c20 2827 666f 6f27  ('start', ('foo'
+0000cd90: 2c20 2762 6172 2729 292c 0a20 2020 2020  , 'bar')),.     
+0000cda0: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+0000cdb0: 6573 745f 7374 6172 745f 6e6f 5f61 7267  est_start_no_arg
+0000cdc0: 756d 656e 7473 2873 656c 6629 3a0a 2020  uments(self):.  
+0000cdd0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000cde0: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
+0000cdf0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000ce00: 2020 2020 2073 656c 662e 636f 6e74 6169       self.contai
+0000ce10: 6e65 722e 7374 6172 7428 290a 0a20 2020  ner.start()..   
+0000ce20: 2064 6566 2074 6573 745f 7374 6f70 2873   def test_stop(s
+0000ce30: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+0000ce40: 6c66 2e63 6f6e 7461 696e 6572 2e73 746f  lf.container.sto
+0000ce50: 7028 2766 6f6f 2729 0a20 2020 2020 2020  p('foo').       
+0000ce60: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0000ce70: 7374 6f70 2827 666f 6f27 2c20 2762 6172  stop('foo', 'bar
+0000ce80: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000ce90: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000cea0: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+0000ceb0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0000cec0: 2827 7374 6f70 272c 2028 2766 6f6f 272c  ('stop', ('foo',
+0000ced0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0000cee0: 2827 7374 6f70 272c 2028 2766 6f6f 272c  ('stop', ('foo',
+0000cef0: 2027 6261 7227 2929 2c0a 2020 2020 2020   'bar')),.      
+0000cf00: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0000cf10: 7374 5f73 746f 705f 6e6f 5f61 7267 756d  st_stop_no_argum
+0000cf20: 656e 7473 2873 656c 6629 3a0a 2020 2020  ents(self):.    
+0000cf30: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0000cf40: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
+0000cf50: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0000cf60: 2020 2073 656c 662e 636f 6e74 6169 6e65     self.containe
+0000cf70: 722e 7374 6f70 2829 0a0a 2020 2020 6465  r.stop()..    de
+0000cf80: 6620 7465 7374 5f72 6573 7461 7274 2873  f test_restart(s
+0000cf90: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+0000cfa0: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
+0000cfb0: 7461 7274 2827 666f 6f27 290a 2020 2020  tart('foo').    
+0000cfc0: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
+0000cfd0: 6572 2e72 6573 7461 7274 2827 666f 6f27  er.restart('foo'
+0000cfe0: 2c20 2762 6172 2729 0a20 2020 2020 2020  , 'bar').       
+0000cff0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000d000: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
+0000d010: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+0000d020: 2020 2020 2020 2827 7265 7374 6172 7427        ('restart'
+0000d030: 2c20 2827 666f 6f27 2c29 292c 0a20 2020  , ('foo',)),.   
+0000d040: 2020 2020 2020 2020 2028 2772 6573 7461           ('resta
+0000d050: 7274 272c 2028 2766 6f6f 272c 2027 6261  rt', ('foo', 'ba
+0000d060: 7227 2929 2c0a 2020 2020 2020 2020 5d29  r')),.        ])
+0000d070: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
+0000d080: 6573 7461 7274 5f66 616c 6c62 6163 6b28  estart_fallback(
+0000d090: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+0000d0a0: 6566 2072 6573 7461 7274 5f73 6572 7669  ef restart_servi
+0000d0b0: 6365 7328 7365 7276 6963 6573 293a 0a20  ces(services):. 
+0000d0c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d0d0: 7065 6262 6c65 2e72 6571 7565 7374 732e  pebble.requests.
+0000d0e0: 6170 7065 6e64 2828 2772 6573 7461 7274  append(('restart
+0000d0f0: 272c 2073 6572 7669 6365 7329 290a 2020  ', services)).  
+0000d100: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000d110: 7065 6262 6c65 2e41 5049 4572 726f 7228  pebble.APIError(
+0000d120: 7b7d 2c20 3430 302c 2022 222c 2022 2229  {}, 400, "", "")
+0000d130: 0a0a 2020 2020 2020 2020 7365 6c66 2e70  ..        self.p
+0000d140: 6562 626c 652e 7265 7374 6172 745f 7365  ebble.restart_se
+0000d150: 7276 6963 6573 203d 2072 6573 7461 7274  rvices = restart
+0000d160: 5f73 6572 7669 6365 730a 2020 2020 2020  _services.      
+0000d170: 2020 2320 5365 7475 7020 7468 6520 5065    # Setup the Pe
+0000d180: 6262 6c65 2063 6c69 656e 7420 746f 2072  bble client to r
+0000d190: 6573 706f 6e64 2074 6f20 6120 6361 6c6c  espond to a call
+0000d1a0: 2074 6f20 6765 745f 7365 7276 6963 6573   to get_services
+0000d1b0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000d1c0: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
+0000d1d0: 2e61 7070 656e 6428 5b0a 2020 2020 2020  .append([.      
+0000d1e0: 2020 2020 2020 7065 6262 6c65 2e53 6572        pebble.Ser
+0000d1f0: 7669 6365 496e 666f 2e66 726f 6d5f 6469  viceInfo.from_di
+0000d200: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0000d210: 2020 2020 7b27 6e61 6d65 273a 2027 666f      {'name': 'fo
+0000d220: 6f27 2c20 2773 7461 7274 7570 273a 2027  o', 'startup': '
+0000d230: 656e 6162 6c65 6427 2c20 2763 7572 7265  enabled', 'curre
+0000d240: 6e74 273a 2027 6163 7469 7665 277d 292c  nt': 'active'}),
+0000d250: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
+0000d260: 626c 652e 5365 7276 6963 6549 6e66 6f2e  ble.ServiceInfo.
+0000d270: 6672 6f6d 5f64 6963 7428 0a20 2020 2020  from_dict(.     
+0000d280: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+0000d290: 6527 3a20 2762 6172 272c 2027 7374 6172  e': 'bar', 'star
+0000d2a0: 7475 7027 3a20 2765 6e61 626c 6564 272c  tup': 'enabled',
+0000d2b0: 2027 6375 7272 656e 7427 3a20 2769 6e61   'current': 'ina
+0000d2c0: 6374 6976 6527 7d29 2c0a 2020 2020 2020  ctive'}),.      
+0000d2d0: 2020 5d29 0a0a 2020 2020 2020 2020 7365    ])..        se
+0000d2e0: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
+0000d2f0: 7461 7274 2827 666f 6f27 2c20 2762 6172  tart('foo', 'bar
+0000d300: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0000d310: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000d320: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+0000d330: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0000d340: 2320 5468 6973 2069 7320 7468 6520 6669  # This is the fi
+0000d350: 7273 7420 7265 7175 6573 742c 2077 6869  rst request, whi
+0000d360: 6368 2069 6e20 7265 616c 206c 6966 6520  ch in real life 
+0000d370: 6661 696c 7320 7769 7468 2041 5049 4572  fails with APIEr
+0000d380: 726f 7220 6f6e 206f 6c64 6572 2076 6572  ror on older ver
+0000d390: 7369 6f6e 730a 2020 2020 2020 2020 2020  sions.          
+0000d3a0: 2020 2827 7265 7374 6172 7427 2c20 2827    ('restart', ('
+0000d3b0: 666f 6f27 2c20 2762 6172 2729 292c 0a20  foo', 'bar')),. 
+0000d3c0: 2020 2020 2020 2020 2020 2023 204e 6578             # Nex
+0000d3d0: 7420 7468 6520 636f 6465 2073 686f 756c  t the code shoul
+0000d3e0: 6420 6c6f 6f70 206f 7665 7220 7468 6520  d loop over the 
+0000d3f0: 7374 6172 7465 6420 7365 7276 6963 6573  started services
+0000d400: 2c20 616e 6420 7374 6f70 2074 6865 6d0a  , and stop them.
+0000d410: 2020 2020 2020 2020 2020 2020 2827 6765              ('ge
+0000d420: 745f 7365 7276 6963 6573 272c 2028 2766  t_services', ('f
+0000d430: 6f6f 272c 2027 6261 7227 2929 2c0a 2020  oo', 'bar')),.  
+0000d440: 2020 2020 2020 2020 2020 2827 7374 6f70            ('stop
+0000d450: 272c 2028 2766 6f6f 272c 2929 2c0a 2020  ', ('foo',)),.  
+0000d460: 2020 2020 2020 2020 2020 2320 5468 656e            # Then
+0000d470: 2073 7461 7274 2061 6c6c 2074 6865 2073   start all the s
+0000d480: 7065 6369 6669 6564 2073 6572 7669 6365  pecified service
+0000d490: 730a 2020 2020 2020 2020 2020 2020 2827  s.            ('
+0000d4a0: 7374 6172 7427 2c20 2827 666f 6f27 2c20  start', ('foo', 
+0000d4b0: 2762 6172 2729 290a 2020 2020 2020 2020  'bar')).        
+0000d4c0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+0000d4d0: 5f72 6573 7461 7274 5f66 616c 6c62 6163  _restart_fallbac
+0000d4e0: 6b5f 6e6f 6e5f 3430 305f 6572 726f 7228  k_non_400_error(
+0000d4f0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+0000d500: 6566 2072 6573 7461 7274 5f73 6572 7669  ef restart_servi
+0000d510: 6365 7328 7365 7276 6963 6573 293a 0a20  ces(services):. 
+0000d520: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000d530: 2070 6562 626c 652e 4150 4945 7272 6f72   pebble.APIError
+0000d540: 287b 7d2c 2035 3030 2c20 2222 2c20 2222  ({}, 500, "", ""
+0000d550: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000d560: 7065 6262 6c65 2e72 6573 7461 7274 5f73  pebble.restart_s
+0000d570: 6572 7669 6365 7320 3d20 7265 7374 6172  ervices = restar
+0000d580: 745f 7365 7276 6963 6573 0a20 2020 2020  t_services.     
+0000d590: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000d5a0: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
+0000d5b0: 2e41 5049 4572 726f 7229 2061 7320 636d  .APIError) as cm
+0000d5c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000d5d0: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
+0000d5e0: 7461 7274 2827 666f 6f27 290a 2020 2020  tart('foo').    
+0000d5f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000d600: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+0000d610: 6e2e 636f 6465 2c20 3530 3029 0a0a 2020  n.code, 500)..  
+0000d620: 2020 6465 6620 7465 7374 5f72 6573 7461    def test_resta
+0000d630: 7274 5f6e 6f5f 6172 6775 6d65 6e74 7328  rt_no_arguments(
+0000d640: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
+0000d650: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000d660: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+0000d670: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000d680: 6c66 2e63 6f6e 7461 696e 6572 2e72 6573  lf.container.res
+0000d690: 7461 7274 2829 0a0a 2020 2020 6465 6620  tart()..    def 
+0000d6a0: 7465 7374 5f74 7970 655f 6572 726f 7273  test_type_errors
+0000d6b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000d6c0: 6d65 7461 203d 206f 7073 2e43 6861 726d  meta = ops.Charm
+0000d6d0: 4d65 7461 2e66 726f 6d5f 7961 6d6c 2822  Meta.from_yaml("
+0000d6e0: 2222 0a6e 616d 653a 206b 3873 2d63 6861  "".name: k8s-cha
+0000d6f0: 726d 0a63 6f6e 7461 696e 6572 733a 0a20  rm.containers:. 
+0000d700: 2063 313a 0a20 2020 206b 3a20 760a 2222   c1:.    k: v.""
+0000d710: 2229 0a20 2020 2020 2020 2023 204f 6e6c  ").        # Onl
+0000d720: 7920 7468 6520 7265 616c 2070 6562 626c  y the real pebbl
+0000d730: 6520 436c 6965 6e74 2063 6865 636b 7320  e Client checks 
+0000d740: 7479 7065 732c 2073 6f20 7573 6520 6163  types, so use ac
+0000d750: 7475 616c 2062 6163 6b65 6e64 2063 6c61  tual backend cla
+0000d760: 7373 0a20 2020 2020 2020 2062 6163 6b65  ss.        backe
+0000d770: 6e64 203d 205f 4d6f 6465 6c42 6163 6b65  nd = _ModelBacke
+0000d780: 6e64 2827 6d79 6170 702f 3027 290a 2020  nd('myapp/0').  
+0000d790: 2020 2020 2020 6d6f 6465 6c20 3d20 6f70        model = op
+0000d7a0: 732e 4d6f 6465 6c28 6d65 7461 2c20 6261  s.Model(meta, ba
+0000d7b0: 636b 656e 6429 0a20 2020 2020 2020 2063  ckend).        c
+0000d7c0: 6f6e 7461 696e 6572 203d 206d 6f64 656c  ontainer = model
+0000d7d0: 2e75 6e69 742e 636f 6e74 6169 6e65 7273  .unit.containers
+0000d7e0: 5b27 6331 275d 0a0a 2020 2020 2020 2020  ['c1']..        
+0000d7f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000d800: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
+0000d810: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+0000d820: 6f6e 7461 696e 6572 2e73 7461 7274 285b  ontainer.start([
+0000d830: 2766 6f6f 275d 290a 0a20 2020 2020 2020  'foo'])..       
+0000d840: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000d850: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+0000d860: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000d870: 636f 6e74 6169 6e65 722e 7374 6f70 285b  container.stop([
+0000d880: 2766 6f6f 275d 290a 0a20 2020 2064 6566  'foo'])..    def
+0000d890: 2074 6573 745f 6164 645f 6c61 7965 7228   test_add_layer(
+0000d8a0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0000d8b0: 656c 662e 636f 6e74 6169 6e65 722e 6164  elf.container.ad
+0000d8c0: 645f 6c61 7965 7228 2761 272c 2027 7375  d_layer('a', 'su
+0000d8d0: 6d6d 6172 793a 2073 7472 5c6e 2729 0a20  mmary: str\n'). 
+0000d8e0: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
+0000d8f0: 6169 6e65 722e 6164 645f 6c61 7965 7228  ainer.add_layer(
+0000d900: 2762 272c 207b 2773 756d 6d61 7279 273a  'b', {'summary':
+0000d910: 2027 6469 6374 277d 290a 2020 2020 2020   'dict'}).      
+0000d920: 2020 7365 6c66 2e63 6f6e 7461 696e 6572    self.container
+0000d930: 2e61 6464 5f6c 6179 6572 2827 6327 2c20  .add_layer('c', 
+0000d940: 7065 6262 6c65 2e4c 6179 6572 2827 7375  pebble.Layer('su
+0000d950: 6d6d 6172 793a 204c 6179 6572 2729 290a  mmary: Layer')).
+0000d960: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0000d970: 7461 696e 6572 2e61 6464 5f6c 6179 6572  tainer.add_layer
+0000d980: 2827 6427 2c20 2773 756d 6d61 7279 3a20  ('d', 'summary: 
+0000d990: 7374 725c 6e27 2c20 636f 6d62 696e 653d  str\n', combine=
+0000d9a0: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
+0000d9b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000d9c0: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
+0000d9d0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000d9e0: 2020 2028 2761 6464 5f6c 6179 6572 272c     ('add_layer',
+0000d9f0: 2027 6127 2c20 2773 756d 6d61 7279 3a20   'a', 'summary: 
+0000da00: 7374 725c 6e27 2c20 4661 6c73 6529 2c0a  str\n', False),.
+0000da10: 2020 2020 2020 2020 2020 2020 2827 6164              ('ad
+0000da20: 645f 6c61 7965 7227 2c20 2762 272c 2027  d_layer', 'b', '
+0000da30: 7375 6d6d 6172 793a 2064 6963 745c 6e27  summary: dict\n'
+0000da40: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
+0000da50: 2020 2020 2020 2827 6164 645f 6c61 7965        ('add_laye
+0000da60: 7227 2c20 2763 272c 2027 7375 6d6d 6172  r', 'c', 'summar
+0000da70: 793a 204c 6179 6572 5c6e 272c 2046 616c  y: Layer\n', Fal
+0000da80: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
+0000da90: 2028 2761 6464 5f6c 6179 6572 272c 2027   ('add_layer', '
+0000daa0: 6427 2c20 2773 756d 6d61 7279 3a20 7374  d', 'summary: st
+0000dab0: 725c 6e27 2c20 5472 7565 292c 0a20 2020  r\n', True),.   
+0000dac0: 2020 2020 205d 290a 0a20 2020 2020 2020       ])..       
+0000dad0: 2023 2063 6f6d 6269 6e65 2069 7320 6120   # combine is a 
+0000dae0: 6b65 7977 6f72 642d 6f6e 6c79 2061 7267  keyword-only arg
+0000daf0: 2028 7368 6f75 6c64 2062 6520 636f 6d62   (should be comb
+0000db00: 696e 653d 5472 7565 290a 2020 2020 2020  ine=True).      
+0000db10: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0000db20: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
+0000db30: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0000db40: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0000db50: 6164 645f 6c61 7965 7228 2778 272c 207b  add_layer('x', {
+0000db60: 7d2c 2054 7275 6529 0a0a 2020 2020 6465  }, True)..    de
+0000db70: 6620 7465 7374 5f67 6574 5f70 6c61 6e28  f test_get_plan(
+0000db80: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
+0000db90: 6c61 6e5f 7961 6d6c 203d 2027 7365 7276  lan_yaml = 'serv
+0000dba0: 6963 6573 3a5c 6e20 666f 6f3a 5c6e 2020  ices:\n foo:\n  
+0000dbb0: 6f76 6572 7269 6465 3a20 7265 706c 6163  override: replac
+0000dbc0: 655c 6e20 2063 6f6d 6d61 6e64 3a20 6261  e\n  command: ba
+0000dbd0: 7227 0a20 2020 2020 2020 2073 656c 662e  r'.        self.
+0000dbe0: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
+0000dbf0: 2e61 7070 656e 6428 7065 6262 6c65 2e50  .append(pebble.P
+0000dc00: 6c61 6e28 706c 616e 5f79 616d 6c29 290a  lan(plan_yaml)).
+0000dc10: 2020 2020 2020 2020 706c 616e 203d 2073          plan = s
+0000dc20: 656c 662e 636f 6e74 6169 6e65 722e 6765  elf.container.ge
+0000dc30: 745f 706c 616e 2829 0a20 2020 2020 2020  t_plan().       
+0000dc40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000dc50: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
+0000dc60: 7175 6573 7473 2c20 5b28 2767 6574 5f70  quests, [('get_p
+0000dc70: 6c61 6e27 2c29 5d29 0a20 2020 2020 2020  lan',)]).       
+0000dc80: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+0000dc90: 7374 616e 6365 2870 6c61 6e2c 2070 6562  stance(plan, peb
+0000dca0: 626c 652e 506c 616e 290a 2020 2020 2020  ble.Plan).      
+0000dcb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000dcc0: 616c 2870 6c61 6e2e 746f 5f79 616d 6c28  al(plan.to_yaml(
+0000dcd0: 292c 2079 616d 6c2e 7361 6665 5f64 756d  ), yaml.safe_dum
+0000dce0: 7028 7961 6d6c 2e73 6166 655f 6c6f 6164  p(yaml.safe_load
+0000dcf0: 2870 6c61 6e5f 7961 6d6c 2929 290a 0a20  (plan_yaml))).. 
+0000dd00: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+0000dd10: 0a20 2020 2064 6566 205f 6d61 6b65 5f73  .    def _make_s
+0000dd20: 6572 7669 6365 286e 616d 652c 2073 7461  ervice(name, sta
+0000dd30: 7274 7570 2c20 6375 7272 656e 7429 3a0a  rtup, current):.
+0000dd40: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+0000dd50: 6562 626c 652e 5365 7276 6963 6549 6e66  ebble.ServiceInf
+0000dd60: 6f2e 6672 6f6d 5f64 6963 7428 0a20 2020  o.from_dict(.   
+0000dd70: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+0000dd80: 3a20 6e61 6d65 2c20 2773 7461 7274 7570  : name, 'startup
+0000dd90: 273a 2073 7461 7274 7570 2c20 2763 7572  ': startup, 'cur
+0000dda0: 7265 6e74 273a 2063 7572 7265 6e74 7d29  rent': current})
+0000ddb0: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+0000ddc0: 6574 5f73 6572 7669 6365 7328 7365 6c66  et_services(self
+0000ddd0: 293a 0a20 2020 2020 2020 2074 776f 5f73  ):.        two_s
+0000dde0: 6572 7669 6365 7320 3d20 5b0a 2020 2020  ervices = [.    
+0000ddf0: 2020 2020 2020 2020 7365 6c66 2e5f 6d61          self._ma
+0000de00: 6b65 5f73 6572 7669 6365 2827 7331 272c  ke_service('s1',
+0000de10: 2027 656e 6162 6c65 6427 2c20 2761 6374   'enabled', 'act
+0000de20: 6976 6527 292c 0a20 2020 2020 2020 2020  ive'),.         
+0000de30: 2020 2073 656c 662e 5f6d 616b 655f 7365     self._make_se
+0000de40: 7276 6963 6528 2773 3227 2c20 2764 6973  rvice('s2', 'dis
+0000de50: 6162 6c65 6427 2c20 2769 6e61 6374 6976  abled', 'inactiv
+0000de60: 6527 292c 0a20 2020 2020 2020 205d 0a20  e'),.        ]. 
+0000de70: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
+0000de80: 6c65 2e72 6573 706f 6e73 6573 2e61 7070  le.responses.app
+0000de90: 656e 6428 7477 6f5f 7365 7276 6963 6573  end(two_services
+0000dea0: 290a 2020 2020 2020 2020 7365 7276 6963  ).        servic
+0000deb0: 6573 203d 2073 656c 662e 636f 6e74 6169  es = self.contai
+0000dec0: 6e65 722e 6765 745f 7365 7276 6963 6573  ner.get_services
+0000ded0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000dee0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+0000def0: 7365 7276 6963 6573 292c 2032 290a 2020  services), 2).  
+0000df00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000df10: 7445 7175 616c 2873 6574 2873 6572 7669  tEqual(set(servi
+0000df20: 6365 7329 2c20 7b27 7331 272c 2027 7332  ces), {'s1', 's2
+0000df30: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
+0000df40: 2e61 7373 6572 7445 7175 616c 2873 6572  .assertEqual(ser
+0000df50: 7669 6365 735b 2773 3127 5d2e 6e61 6d65  vices['s1'].name
+0000df60: 2c20 2773 3127 290a 2020 2020 2020 2020  , 's1').        
+0000df70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000df80: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
+0000df90: 7374 6172 7475 702c 2070 6562 626c 652e  startup, pebble.
+0000dfa0: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
+0000dfb0: 4e41 424c 4544 290a 2020 2020 2020 2020  NABLED).        
+0000dfc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000dfd0: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
+0000dfe0: 6375 7272 656e 742c 2070 6562 626c 652e  current, pebble.
+0000dff0: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
+0000e000: 5449 5645 290a 2020 2020 2020 2020 7365  TIVE).        se
+0000e010: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000e020: 6572 7669 6365 735b 2773 3227 5d2e 6e61  ervices['s2'].na
+0000e030: 6d65 2c20 2773 3227 290a 2020 2020 2020  me, 's2').      
+0000e040: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000e050: 616c 2873 6572 7669 6365 735b 2773 3227  al(services['s2'
+0000e060: 5d2e 7374 6172 7475 702c 2070 6562 626c  ].startup, pebbl
+0000e070: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
+0000e080: 2e44 4953 4142 4c45 4429 0a20 2020 2020  .DISABLED).     
+0000e090: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e0a0: 7561 6c28 7365 7276 6963 6573 5b27 7332  ual(services['s2
+0000e0b0: 275d 2e63 7572 7265 6e74 2c20 7065 6262  '].current, pebb
+0000e0c0: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+0000e0d0: 2e49 4e41 4354 4956 4529 0a0a 2020 2020  .INACTIVE)..    
+0000e0e0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000e0f0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000e100: 2874 776f 5f73 6572 7669 6365 7329 0a20  (two_services). 
+0000e110: 2020 2020 2020 2073 6572 7669 6365 7320         services 
+0000e120: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
+0000e130: 2e67 6574 5f73 6572 7669 6365 7328 2773  .get_services('s
+0000e140: 3127 2c20 2773 3227 290a 2020 2020 2020  1', 's2').      
 0000e150: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e160: 616c 2873 6574 2873 6572 7669 6365 7329  al(set(services)
-0000e170: 2c20 7b27 7331 272c 2027 7332 277d 290a  , {'s1', 's2'}).
-0000e180: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000e190: 6572 7445 7175 616c 2873 6572 7669 6365  ertEqual(service
-0000e1a0: 735b 2773 3127 5d2e 6e61 6d65 2c20 2773  s['s1'].name, 's
-0000e1b0: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-0000e1c0: 2e61 7373 6572 7445 7175 616c 2873 6572  .assertEqual(ser
-0000e1d0: 7669 6365 735b 2773 3127 5d2e 7374 6172  vices['s1'].star
-0000e1e0: 7475 702c 206f 7073 2e70 6562 626c 652e  tup, ops.pebble.
-0000e1f0: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
-0000e200: 4e41 424c 4544 290a 2020 2020 2020 2020  NABLED).        
-0000e210: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000e220: 2873 6572 7669 6365 735b 2773 3127 5d2e  (services['s1'].
-0000e230: 6375 7272 656e 742c 206f 7073 2e70 6562  current, ops.peb
-0000e240: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-0000e250: 732e 4143 5449 5645 290a 2020 2020 2020  s.ACTIVE).      
-0000e260: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e270: 616c 2873 6572 7669 6365 735b 2773 3227  al(services['s2'
-0000e280: 5d2e 6e61 6d65 2c20 2773 3227 290a 2020  ].name, 's2').  
-0000e290: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000e2a0: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
-0000e2b0: 2773 3227 5d2e 7374 6172 7475 702c 206f  's2'].startup, o
-0000e2c0: 7073 2e70 6562 626c 652e 5365 7276 6963  ps.pebble.Servic
-0000e2d0: 6553 7461 7274 7570 2e44 4953 4142 4c45  eStartup.DISABLE
-0000e2e0: 4429 0a20 2020 2020 2020 2073 656c 662e  D).        self.
-0000e2f0: 6173 7365 7274 4571 7561 6c28 7365 7276  assertEqual(serv
-0000e300: 6963 6573 5b27 7332 275d 2e63 7572 7265  ices['s2'].curre
-0000e310: 6e74 2c20 6f70 732e 7065 6262 6c65 2e53  nt, ops.pebble.S
-0000e320: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
-0000e330: 4354 4956 4529 0a0a 2020 2020 2020 2020  CTIVE)..        
-0000e340: 7365 6c66 2e70 6562 626c 652e 7265 7370  self.pebble.resp
-0000e350: 6f6e 7365 732e 6170 7065 6e64 2874 776f  onses.append(two
-0000e360: 5f73 6572 7669 6365 7329 0a20 2020 2020  _services).     
-0000e370: 2020 2073 6572 7669 6365 7320 3d20 7365     services = se
-0000e380: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
-0000e390: 5f73 6572 7669 6365 7328 2773 3127 2c20  _services('s1', 
-0000e3a0: 2773 3227 290a 2020 2020 2020 2020 7365  's2').        se
-0000e3b0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-0000e3c0: 656e 2873 6572 7669 6365 7329 2c20 3229  en(services), 2)
-0000e3d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e3e0: 7365 7274 4571 7561 6c28 7365 7428 7365  sertEqual(set(se
-0000e3f0: 7276 6963 6573 292c 207b 2773 3127 2c20  rvices), {'s1', 
-0000e400: 2773 3227 7d29 0a20 2020 2020 2020 2073  's2'}).        s
-0000e410: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000e420: 7365 7276 6963 6573 5b27 7331 275d 2e6e  services['s1'].n
-0000e430: 616d 652c 2027 7331 2729 0a20 2020 2020  ame, 's1').     
-0000e440: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e450: 7561 6c28 7365 7276 6963 6573 5b27 7331  ual(services['s1
-0000e460: 275d 2e73 7461 7274 7570 2c20 6f70 732e  '].startup, ops.
-0000e470: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
-0000e480: 6172 7475 702e 454e 4142 4c45 4429 0a20  artup.ENABLED). 
-0000e490: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e4a0: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
-0000e4b0: 5b27 7331 275d 2e63 7572 7265 6e74 2c20  ['s1'].current, 
-0000e4c0: 6f70 732e 7065 6262 6c65 2e53 6572 7669  ops.pebble.Servi
-0000e4d0: 6365 5374 6174 7573 2e41 4354 4956 4529  ceStatus.ACTIVE)
-0000e4e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e4f0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
-0000e500: 6573 5b27 7332 275d 2e6e 616d 652c 2027  es['s2'].name, '
-0000e510: 7332 2729 0a20 2020 2020 2020 2073 656c  s2').        sel
-0000e520: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000e530: 7276 6963 6573 5b27 7332 275d 2e73 7461  rvices['s2'].sta
-0000e540: 7274 7570 2c20 6f70 732e 7065 6262 6c65  rtup, ops.pebble
+0000e160: 616c 286c 656e 2873 6572 7669 6365 7329  al(len(services)
+0000e170: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
+0000e180: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000e190: 7428 7365 7276 6963 6573 292c 207b 2773  t(services), {'s
+0000e1a0: 3127 2c20 2773 3227 7d29 0a20 2020 2020  1', 's2'}).     
+0000e1b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e1c0: 7561 6c28 7365 7276 6963 6573 5b27 7331  ual(services['s1
+0000e1d0: 275d 2e6e 616d 652c 2027 7331 2729 0a20  '].name, 's1'). 
+0000e1e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000e1f0: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
+0000e200: 5b27 7331 275d 2e73 7461 7274 7570 2c20  ['s1'].startup, 
+0000e210: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+0000e220: 6172 7475 702e 454e 4142 4c45 4429 0a20  artup.ENABLED). 
+0000e230: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000e240: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
+0000e250: 5b27 7331 275d 2e63 7572 7265 6e74 2c20  ['s1'].current, 
+0000e260: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+0000e270: 6174 7573 2e41 4354 4956 4529 0a20 2020  atus.ACTIVE).   
+0000e280: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000e290: 4571 7561 6c28 7365 7276 6963 6573 5b27  Equal(services['
+0000e2a0: 7332 275d 2e6e 616d 652c 2027 7332 2729  s2'].name, 's2')
+0000e2b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000e2c0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
+0000e2d0: 6573 5b27 7332 275d 2e73 7461 7274 7570  es['s2'].startup
+0000e2e0: 2c20 7065 6262 6c65 2e53 6572 7669 6365  , pebble.Service
+0000e2f0: 5374 6172 7475 702e 4449 5341 424c 4544  Startup.DISABLED
+0000e300: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000e310: 7373 6572 7445 7175 616c 2873 6572 7669  ssertEqual(servi
+0000e320: 6365 735b 2773 3227 5d2e 6375 7272 656e  ces['s2'].curren
+0000e330: 742c 2070 6562 626c 652e 5365 7276 6963  t, pebble.Servic
+0000e340: 6553 7461 7475 732e 494e 4143 5449 5645  eStatus.INACTIVE
+0000e350: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000e360: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000e370: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
+0000e380: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0000e390: 2827 6765 745f 7365 7276 6963 6573 272c  ('get_services',
+0000e3a0: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0000e3b0: 2020 2020 2827 6765 745f 7365 7276 6963      ('get_servic
+0000e3c0: 6573 272c 2028 2773 3127 2c20 2773 3227  es', ('s1', 's2'
+0000e3d0: 2929 2c0a 2020 2020 2020 2020 5d29 0a0a  )),.        ])..
+0000e3e0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+0000e3f0: 5f73 6572 7669 6365 2873 656c 6629 3a0a  _service(self):.
+0000e400: 2020 2020 2020 2020 2320 5369 6e67 6c65          # Single
+0000e410: 2073 6572 7669 6365 2072 6574 7572 6e65   service returne
+0000e420: 6420 7375 6363 6573 7366 756c 6c79 0a20  d successfully. 
+0000e430: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
+0000e440: 6c65 2e72 6573 706f 6e73 6573 2e61 7070  le.responses.app
+0000e450: 656e 6428 5b73 656c 662e 5f6d 616b 655f  end([self._make_
+0000e460: 7365 7276 6963 6528 2773 3127 2c20 2765  service('s1', 'e
+0000e470: 6e61 626c 6564 272c 2027 6163 7469 7665  nabled', 'active
+0000e480: 2729 5d29 0a20 2020 2020 2020 2073 203d  ')]).        s =
+0000e490: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0000e4a0: 6765 745f 7365 7276 6963 6528 2773 3127  get_service('s1'
+0000e4b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000e4c0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000e4d0: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+0000e4e0: 205b 2827 6765 745f 7365 7276 6963 6573   [('get_services
+0000e4f0: 272c 2028 2773 3127 2c20 2929 5d29 0a20  ', ('s1', ))]). 
+0000e500: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000e510: 7274 4571 7561 6c28 732e 6e61 6d65 2c20  rtEqual(s.name, 
+0000e520: 2773 3127 290a 2020 2020 2020 2020 7365  's1').        se
+0000e530: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000e540: 2e73 7461 7274 7570 2c20 7065 6262 6c65  .startup, pebble
 0000e550: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-0000e560: 4449 5341 424c 4544 290a 2020 2020 2020  DISABLED).      
-0000e570: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e580: 616c 2873 6572 7669 6365 735b 2773 3227  al(services['s2'
-0000e590: 5d2e 6375 7272 656e 742c 206f 7073 2e70  ].current, ops.p
-0000e5a0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-0000e5b0: 7475 732e 494e 4143 5449 5645 290a 0a20  tus.INACTIVE).. 
-0000e5c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e5d0: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
-0000e5e0: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
-0000e5f0: 2020 2020 2020 2020 2020 2020 2827 6765              ('ge
-0000e600: 745f 7365 7276 6963 6573 272c 204e 6f6e  t_services', Non
-0000e610: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000e620: 2827 6765 745f 7365 7276 6963 6573 272c  ('get_services',
-0000e630: 2028 2773 3127 2c20 2773 3227 2929 2c0a   ('s1', 's2')),.
-0000e640: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-0000e650: 6465 6620 7465 7374 5f67 6574 5f73 6572  def test_get_ser
-0000e660: 7669 6365 2873 656c 6629 3a0a 2020 2020  vice(self):.    
-0000e670: 2020 2020 2320 5369 6e67 6c65 2073 6572      # Single ser
-0000e680: 7669 6365 2072 6574 7572 6e65 6420 7375  vice returned su
-0000e690: 6363 6573 7366 756c 6c79 0a20 2020 2020  ccessfully.     
-0000e6a0: 2020 2073 656c 662e 7065 6262 6c65 2e72     self.pebble.r
-0000e6b0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-0000e6c0: 5b73 656c 662e 5f6d 616b 655f 7365 7276  [self._make_serv
-0000e6d0: 6963 6528 2773 3127 2c20 2765 6e61 626c  ice('s1', 'enabl
-0000e6e0: 6564 272c 2027 6163 7469 7665 2729 5d29  ed', 'active')])
-0000e6f0: 0a20 2020 2020 2020 2073 203d 2073 656c  .        s = sel
-0000e700: 662e 636f 6e74 6169 6e65 722e 6765 745f  f.container.get_
-0000e710: 7365 7276 6963 6528 2773 3127 290a 2020  service('s1').  
-0000e720: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000e730: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
-0000e740: 6c65 2e72 6571 7565 7374 732c 205b 2827  le.requests, [('
-0000e750: 6765 745f 7365 7276 6963 6573 272c 2028  get_services', (
-0000e760: 2773 3127 2c20 2929 5d29 0a20 2020 2020  's1', ))]).     
-0000e770: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e780: 7561 6c28 732e 6e61 6d65 2c20 2773 3127  ual(s.name, 's1'
-0000e790: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000e7a0: 7373 6572 7445 7175 616c 2873 2e73 7461  ssertEqual(s.sta
-0000e7b0: 7274 7570 2c20 6f70 732e 7065 6262 6c65  rtup, ops.pebble
-0000e7c0: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-0000e7d0: 454e 4142 4c45 4429 0a20 2020 2020 2020  ENABLED).       
-0000e7e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000e7f0: 6c28 732e 6375 7272 656e 742c 206f 7073  l(s.current, ops
-0000e800: 2e70 6562 626c 652e 5365 7276 6963 6553  .pebble.ServiceS
-0000e810: 7461 7475 732e 4143 5449 5645 290a 0a20  tatus.ACTIVE).. 
-0000e820: 2020 2020 2020 2023 2049 6620 5065 6262         # If Pebb
-0000e830: 6c65 2072 6574 7572 6e73 206e 6f20 7365  le returns no se
-0000e840: 7276 6963 6573 2c20 7368 6f75 6c64 2062  rvices, should b
-0000e850: 6520 6120 4d6f 6465 6c45 7272 6f72 0a20  e a ModelError. 
-0000e860: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
-0000e870: 6c65 2e72 6573 706f 6e73 6573 2e61 7070  le.responses.app
-0000e880: 656e 6428 5b5d 290a 2020 2020 2020 2020  end([]).        
-0000e890: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000e8a0: 5261 6973 6573 286f 7073 2e6d 6f64 656c  Raises(ops.model
-0000e8b0: 2e4d 6f64 656c 4572 726f 7229 2061 7320  .ModelError) as 
-0000e8c0: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-0000e8d0: 7365 6c66 2e63 6f6e 7461 696e 6572 2e67  self.container.g
-0000e8e0: 6574 5f73 6572 7669 6365 2827 7332 2729  et_service('s2')
-0000e8f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e900: 7365 7274 4571 7561 6c28 7374 7228 636d  sertEqual(str(cm
-0000e910: 2e65 7863 6570 7469 6f6e 292c 2022 7365  .exception), "se
-0000e920: 7276 6963 6520 2773 3227 206e 6f74 2066  rvice 's2' not f
-0000e930: 6f75 6e64 2229 0a0a 2020 2020 2020 2020  ound")..        
-0000e940: 2320 4966 2050 6562 626c 6520 7265 7475  # If Pebble retu
-0000e950: 726e 7320 6d6f 7265 2074 6861 6e20 6f6e  rns more than on
-0000e960: 6520 7365 7276 6963 652c 2052 756e 7469  e service, Runti
-0000e970: 6d65 4572 726f 7220 6973 2072 6169 7365  meError is raise
-0000e980: 640a 2020 2020 2020 2020 7365 6c66 2e70  d.        self.p
-0000e990: 6562 626c 652e 7265 7370 6f6e 7365 732e  ebble.responses.
-0000e9a0: 6170 7065 6e64 285b 0a20 2020 2020 2020  append([.       
-0000e9b0: 2020 2020 2073 656c 662e 5f6d 616b 655f       self._make_
-0000e9c0: 7365 7276 6963 6528 2773 3127 2c20 2765  service('s1', 'e
-0000e9d0: 6e61 626c 6564 272c 2027 6163 7469 7665  nabled', 'active
-0000e9e0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-0000e9f0: 7365 6c66 2e5f 6d61 6b65 5f73 6572 7669  self._make_servi
-0000ea00: 6365 2827 7332 272c 2027 6469 7361 626c  ce('s2', 'disabl
-0000ea10: 6564 272c 2027 696e 6163 7469 7665 2729  ed', 'inactive')
-0000ea20: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-0000ea30: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000ea40: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
-0000ea50: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
-0000ea60: 2020 2020 2020 2073 656c 662e 636f 6e74         self.cont
-0000ea70: 6169 6e65 722e 6765 745f 7365 7276 6963  ainer.get_servic
-0000ea80: 6528 2773 3127 290a 0a20 2020 2064 6566  e('s1')..    def
-0000ea90: 2074 6573 745f 6765 745f 6368 6563 6b73   test_get_checks
-0000eaa0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000eab0: 7265 7370 6f6e 7365 5f63 6865 636b 7320  response_checks 
-0000eac0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0000ead0: 6f70 732e 7065 6262 6c65 2e43 6865 636b  ops.pebble.Check
-0000eae0: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
-0000eaf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eb00: 2027 6e61 6d65 273a 2027 6331 272c 0a20   'name': 'c1',. 
-0000eb10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000eb20: 7374 6174 7573 273a 2027 7570 272c 0a20  status': 'up',. 
-0000eb30: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000eb40: 6661 696c 7572 6573 273a 2030 2c0a 2020  failures': 0,.  
-0000eb50: 2020 2020 2020 2020 2020 2020 2020 2774                't
-0000eb60: 6872 6573 686f 6c64 273a 2033 2c0a 2020  hreshold': 3,.  
-0000eb70: 2020 2020 2020 2020 2020 7d29 2c0a 2020            }),.  
-0000eb80: 2020 2020 2020 2020 2020 6f70 732e 7065            ops.pe
-0000eb90: 6262 6c65 2e43 6865 636b 496e 666f 2e66  bble.CheckInfo.f
-0000eba0: 726f 6d5f 6469 6374 287b 0a20 2020 2020  rom_dict({.     
-0000ebb0: 2020 2020 2020 2020 2020 2027 6e61 6d65             'name
-0000ebc0: 273a 2027 6332 272c 0a20 2020 2020 2020  ': 'c2',.       
-0000ebd0: 2020 2020 2020 2020 2027 6c65 7665 6c27           'level'
-0000ebe0: 3a20 2761 6c69 7665 272c 0a20 2020 2020  : 'alive',.     
-0000ebf0: 2020 2020 2020 2020 2020 2027 7374 6174             'stat
-0000ec00: 7573 273a 2027 646f 776e 272c 0a20 2020  us': 'down',.   
-0000ec10: 2020 2020 2020 2020 2020 2020 2027 6661               'fa
-0000ec20: 696c 7572 6573 273a 2032 2c0a 2020 2020  ilures': 2,.    
-0000ec30: 2020 2020 2020 2020 2020 2020 2774 6872              'thr
-0000ec40: 6573 686f 6c64 273a 2032 2c0a 2020 2020  eshold': 2,.    
-0000ec50: 2020 2020 2020 2020 7d29 2c0a 2020 2020          }),.    
-0000ec60: 2020 2020 5d0a 0a20 2020 2020 2020 2073      ]..        s
-0000ec70: 656c 662e 7065 6262 6c65 2e72 6573 706f  elf.pebble.respo
-0000ec80: 6e73 6573 2e61 7070 656e 6428 7265 7370  nses.append(resp
-0000ec90: 6f6e 7365 5f63 6865 636b 7329 0a20 2020  onse_checks).   
-0000eca0: 2020 2020 2063 6865 636b 7320 3d20 7365       checks = se
-0000ecb0: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
-0000ecc0: 5f63 6865 636b 7328 290a 2020 2020 2020  _checks().      
-0000ecd0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000ece0: 616c 286c 656e 2863 6865 636b 7329 2c20  al(len(checks), 
-0000ecf0: 3229 0a20 2020 2020 2020 2073 656c 662e  2).        self.
-0000ed00: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-0000ed10: 6b73 5b27 6331 275d 2e6e 616d 652c 2027  ks['c1'].name, '
-0000ed20: 6331 2729 0a20 2020 2020 2020 2073 656c  c1').        sel
-0000ed30: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000ed40: 6563 6b73 5b27 6331 275d 2e6c 6576 656c  ecks['c1'].level
-0000ed50: 2c20 6f70 732e 7065 6262 6c65 2e43 6865  , ops.pebble.Che
-0000ed60: 636b 4c65 7665 6c2e 554e 5345 5429 0a20  ckLevel.UNSET). 
-0000ed70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ed80: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
-0000ed90: 6331 275d 2e73 7461 7475 732c 206f 7073  c1'].status, ops
-0000eda0: 2e70 6562 626c 652e 4368 6563 6b53 7461  .pebble.CheckSta
-0000edb0: 7475 732e 5550 290a 2020 2020 2020 2020  tus.UP).        
-0000edc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000edd0: 2863 6865 636b 735b 2763 3127 5d2e 6661  (checks['c1'].fa
-0000ede0: 696c 7572 6573 2c20 3029 0a20 2020 2020  ilures, 0).     
-0000edf0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000ee00: 7561 6c28 6368 6563 6b73 5b27 6331 275d  ual(checks['c1']
-0000ee10: 2e74 6872 6573 686f 6c64 2c20 3329 0a20  .threshold, 3). 
-0000ee20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ee30: 7274 4571 7561 6c28 6368 6563 6b73 5b27  rtEqual(checks['
-0000ee40: 6332 275d 2e6e 616d 652c 2027 6332 2729  c2'].name, 'c2')
-0000ee50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000ee60: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
-0000ee70: 5b27 6332 275d 2e6c 6576 656c 2c20 6f70  ['c2'].level, op
-0000ee80: 732e 7065 6262 6c65 2e43 6865 636b 4c65  s.pebble.CheckLe
-0000ee90: 7665 6c2e 414c 4956 4529 0a20 2020 2020  vel.ALIVE).     
-0000eea0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000eeb0: 7561 6c28 6368 6563 6b73 5b27 6332 275d  ual(checks['c2']
-0000eec0: 2e73 7461 7475 732c 206f 7073 2e70 6562  .status, ops.peb
-0000eed0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-0000eee0: 444f 574e 290a 2020 2020 2020 2020 7365  DOWN).        se
-0000eef0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000ef00: 6865 636b 735b 2763 3227 5d2e 6661 696c  hecks['c2'].fail
-0000ef10: 7572 6573 2c20 3229 0a20 2020 2020 2020  ures, 2).       
-0000ef20: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000ef30: 6c28 6368 6563 6b73 5b27 6332 275d 2e74  l(checks['c2'].t
-0000ef40: 6872 6573 686f 6c64 2c20 3229 0a0a 2020  hreshold, 2)..  
-0000ef50: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
-0000ef60: 652e 7265 7370 6f6e 7365 732e 6170 7065  e.responses.appe
-0000ef70: 6e64 2872 6573 706f 6e73 655f 6368 6563  nd(response_chec
-0000ef80: 6b73 5b31 3a32 5d29 0a20 2020 2020 2020  ks[1:2]).       
-0000ef90: 2063 6865 636b 7320 3d20 7365 6c66 2e63   checks = self.c
-0000efa0: 6f6e 7461 696e 6572 2e67 6574 5f63 6865  ontainer.get_che
-0000efb0: 636b 7328 2763 3127 2c20 2763 3227 2c20  cks('c1', 'c2', 
-0000efc0: 6c65 7665 6c3d 6f70 732e 7065 6262 6c65  level=ops.pebble
-0000efd0: 2e43 6865 636b 4c65 7665 6c2e 414c 4956  .CheckLevel.ALIV
-0000efe0: 4529 0a20 2020 2020 2020 2073 656c 662e  E).        self.
-0000eff0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
-0000f000: 6368 6563 6b73 292c 2031 290a 2020 2020  checks), 1).    
-0000f010: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000f020: 7175 616c 2863 6865 636b 735b 2763 3227  qual(checks['c2'
-0000f030: 5d2e 6e61 6d65 2c20 2763 3227 290a 2020  ].name, 'c2').  
-0000f040: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f050: 7445 7175 616c 2863 6865 636b 735b 2763  tEqual(checks['c
-0000f060: 3227 5d2e 6c65 7665 6c2c 206f 7073 2e70  2'].level, ops.p
-0000f070: 6562 626c 652e 4368 6563 6b4c 6576 656c  ebble.CheckLevel
-0000f080: 2e41 4c49 5645 290a 2020 2020 2020 2020  .ALIVE).        
-0000f090: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000f0a0: 2863 6865 636b 735b 2763 3227 5d2e 7374  (checks['c2'].st
-0000f0b0: 6174 7573 2c20 6f70 732e 7065 6262 6c65  atus, ops.pebble
-0000f0c0: 2e43 6865 636b 5374 6174 7573 2e44 4f57  .CheckStatus.DOW
-0000f0d0: 4e29 0a20 2020 2020 2020 2073 656c 662e  N).        self.
-0000f0e0: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-0000f0f0: 6b73 5b27 6332 275d 2e66 6169 6c75 7265  ks['c2'].failure
-0000f100: 732c 2032 290a 2020 2020 2020 2020 7365  s, 2).        se
-0000f110: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000f120: 6865 636b 735b 2763 3227 5d2e 7468 7265  hecks['c2'].thre
-0000f130: 7368 6f6c 642c 2032 290a 0a20 2020 2020  shold, 2)..     
-0000f140: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f150: 7561 6c28 7365 6c66 2e70 6562 626c 652e  ual(self.pebble.
-0000f160: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000f170: 2020 2020 2020 2020 2827 6765 745f 6368          ('get_ch
-0000f180: 6563 6b73 272c 204e 6f6e 652c 204e 6f6e  ecks', None, Non
-0000f190: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000f1a0: 2827 6765 745f 6368 6563 6b73 272c 206f  ('get_checks', o
-0000f1b0: 7073 2e70 6562 626c 652e 4368 6563 6b4c  ps.pebble.CheckL
-0000f1c0: 6576 656c 2e41 4c49 5645 2c20 2827 6331  evel.ALIVE, ('c1
-0000f1d0: 272c 2027 6332 2729 292c 0a20 2020 2020  ', 'c2')),.     
-0000f1e0: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-0000f1f0: 6573 745f 6765 745f 6368 6563 6b28 7365  est_get_check(se
-0000f200: 6c66 293a 0a20 2020 2020 2020 2023 2053  lf):.        # S
-0000f210: 696e 676c 6520 6368 6563 6b20 7265 7475  ingle check retu
-0000f220: 726e 6564 2073 7563 6365 7373 6675 6c6c  rned successfull
-0000f230: 790a 2020 2020 2020 2020 7365 6c66 2e70  y.        self.p
-0000f240: 6562 626c 652e 7265 7370 6f6e 7365 732e  ebble.responses.
-0000f250: 6170 7065 6e64 285b 0a20 2020 2020 2020  append([.       
-0000f260: 2020 2020 206f 7073 2e70 6562 626c 652e       ops.pebble.
-0000f270: 4368 6563 6b49 6e66 6f2e 6672 6f6d 5f64  CheckInfo.from_d
-0000f280: 6963 7428 7b0a 2020 2020 2020 2020 2020  ict({.          
-0000f290: 2020 2020 2020 276e 616d 6527 3a20 2763        'name': 'c
-0000f2a0: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
-0000f2b0: 2020 2020 2773 7461 7475 7327 3a20 2775      'status': 'u
-0000f2c0: 7027 2c0a 2020 2020 2020 2020 2020 2020  p',.            
-0000f2d0: 2020 2020 2766 6169 6c75 7265 7327 3a20      'failures': 
-0000f2e0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-0000f2f0: 2020 2027 7468 7265 7368 6f6c 6427 3a20     'threshold': 
-0000f300: 332c 0a20 2020 2020 2020 2020 2020 207d  3,.            }
-0000f310: 290a 2020 2020 2020 2020 5d29 0a20 2020  ).        ]).   
-0000f320: 2020 2020 2063 203d 2073 656c 662e 636f       c = self.co
-0000f330: 6e74 6169 6e65 722e 6765 745f 6368 6563  ntainer.get_chec
-0000f340: 6b28 2763 3127 290a 2020 2020 2020 2020  k('c1').        
-0000f350: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000f360: 2873 656c 662e 7065 6262 6c65 2e72 6571  (self.pebble.req
-0000f370: 7565 7374 732c 205b 2827 6765 745f 6368  uests, [('get_ch
-0000f380: 6563 6b73 272c 204e 6f6e 652c 2028 2763  ecks', None, ('c
-0000f390: 3127 2c20 2929 5d29 0a20 2020 2020 2020  1', ))]).       
-0000f3a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f3b0: 6c28 632e 6e61 6d65 2c20 2763 3127 290a  l(c.name, 'c1').
-0000f3c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000f3d0: 6572 7445 7175 616c 2863 2e6c 6576 656c  ertEqual(c.level
-0000f3e0: 2c20 6f70 732e 7065 6262 6c65 2e43 6865  , ops.pebble.Che
-0000f3f0: 636b 4c65 7665 6c2e 554e 5345 5429 0a20  ckLevel.UNSET). 
-0000f400: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000f410: 7274 4571 7561 6c28 632e 7374 6174 7573  rtEqual(c.status
-0000f420: 2c20 6f70 732e 7065 6262 6c65 2e43 6865  , ops.pebble.Che
-0000f430: 636b 5374 6174 7573 2e55 5029 0a20 2020  ckStatus.UP).   
-0000f440: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000f450: 4571 7561 6c28 632e 6661 696c 7572 6573  Equal(c.failures
-0000f460: 2c20 3029 0a20 2020 2020 2020 2073 656c  , 0).        sel
-0000f470: 662e 6173 7365 7274 4571 7561 6c28 632e  f.assertEqual(c.
-0000f480: 7468 7265 7368 6f6c 642c 2033 290a 0a20  threshold, 3).. 
-0000f490: 2020 2020 2020 2023 2049 6620 5065 6262         # If Pebb
-0000f4a0: 6c65 2072 6574 7572 6e73 206e 6f20 6368  le returns no ch
-0000f4b0: 6563 6b73 2c20 7368 6f75 6c64 2062 6520  ecks, should be 
-0000f4c0: 6120 4d6f 6465 6c45 7272 6f72 0a20 2020  a ModelError.   
-0000f4d0: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-0000f4e0: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
-0000f4f0: 6428 5b5d 290a 2020 2020 2020 2020 7769  d([]).        wi
-0000f500: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000f510: 6973 6573 286f 7073 2e6d 6f64 656c 2e4d  ises(ops.model.M
-0000f520: 6f64 656c 4572 726f 7229 2061 7320 636d  odelError) as cm
-0000f530: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000f540: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
-0000f550: 5f63 6865 636b 2827 6332 2729 0a20 2020  _check('c2').   
-0000f560: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000f570: 4571 7561 6c28 7374 7228 636d 2e65 7863  Equal(str(cm.exc
-0000f580: 6570 7469 6f6e 292c 2022 6368 6563 6b20  eption), "check 
-0000f590: 2763 3227 206e 6f74 2066 6f75 6e64 2229  'c2' not found")
-0000f5a0: 0a0a 2020 2020 2020 2020 2320 4966 2050  ..        # If P
-0000f5b0: 6562 626c 6520 7265 7475 726e 7320 6d6f  ebble returns mo
-0000f5c0: 7265 2074 6861 6e20 6f6e 6520 6368 6563  re than one chec
-0000f5d0: 6b2c 2052 756e 7469 6d65 4572 726f 7220  k, RuntimeError 
-0000f5e0: 6973 2072 6169 7365 640a 2020 2020 2020  is raised.      
-0000f5f0: 2020 7365 6c66 2e70 6562 626c 652e 7265    self.pebble.re
-0000f600: 7370 6f6e 7365 732e 6170 7065 6e64 285b  sponses.append([
-0000f610: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
-0000f620: 2e70 6562 626c 652e 4368 6563 6b49 6e66  .pebble.CheckInf
-0000f630: 6f2e 6672 6f6d 5f64 6963 7428 7b0a 2020  o.from_dict({.  
-0000f640: 2020 2020 2020 2020 2020 2020 2020 276e                'n
-0000f650: 616d 6527 3a20 2763 3127 2c0a 2020 2020  ame': 'c1',.    
-0000f660: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
-0000f670: 7475 7327 3a20 2775 7027 2c0a 2020 2020  tus': 'up',.    
-0000f680: 2020 2020 2020 2020 2020 2020 2766 6169              'fai
-0000f690: 6c75 7265 7327 3a20 302c 0a20 2020 2020  lures': 0,.     
-0000f6a0: 2020 2020 2020 2020 2020 2027 7468 7265             'thre
-0000f6b0: 7368 6f6c 6427 3a20 332c 0a20 2020 2020  shold': 3,.     
-0000f6c0: 2020 2020 2020 207d 292c 0a20 2020 2020         }),.     
-0000f6d0: 2020 2020 2020 206f 7073 2e70 6562 626c         ops.pebbl
-0000f6e0: 652e 4368 6563 6b49 6e66 6f2e 6672 6f6d  e.CheckInfo.from
-0000f6f0: 5f64 6963 7428 7b0a 2020 2020 2020 2020  _dict({.        
-0000f700: 2020 2020 2020 2020 276e 616d 6527 3a20          'name': 
-0000f710: 2763 3227 2c0a 2020 2020 2020 2020 2020  'c2',.          
-0000f720: 2020 2020 2020 276c 6576 656c 273a 2027        'level': '
-0000f730: 616c 6976 6527 2c0a 2020 2020 2020 2020  alive',.        
-0000f740: 2020 2020 2020 2020 2773 7461 7475 7327          'status'
-0000f750: 3a20 2764 6f77 6e27 2c0a 2020 2020 2020  : 'down',.      
-0000f760: 2020 2020 2020 2020 2020 2766 6169 6c75            'failu
-0000f770: 7265 7327 3a20 322c 0a20 2020 2020 2020  res': 2,.       
-0000f780: 2020 2020 2020 2020 2027 7468 7265 7368           'thresh
-0000f790: 6f6c 6427 3a20 322c 0a20 2020 2020 2020  old': 2,.       
-0000f7a0: 2020 2020 207d 292c 0a20 2020 2020 2020       }),.       
-0000f7b0: 205d 290a 2020 2020 2020 2020 7769 7468   ]).        with
-0000f7c0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000f7d0: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-0000f7e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000f7f0: 6c66 2e63 6f6e 7461 696e 6572 2e67 6574  lf.container.get
-0000f800: 5f63 6865 636b 2827 6331 2729 0a0a 2020  _check('c1')..  
-0000f810: 2020 6465 6620 7465 7374 5f70 756c 6c28    def test_pull(
-0000f820: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000f830: 656c 662e 7065 6262 6c65 2e72 6573 706f  elf.pebble.respo
-0000f840: 6e73 6573 2e61 7070 656e 6428 2764 756d  nses.append('dum
-0000f850: 6d79 3127 290a 2020 2020 2020 2020 676f  my1').        go
-0000f860: 7420 3d20 7365 6c66 2e63 6f6e 7461 696e  t = self.contain
-0000f870: 6572 2e70 756c 6c28 272f 7061 7468 2f31  er.pull('/path/1
-0000f880: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000f890: 6173 7365 7274 4571 7561 6c28 676f 742c  assertEqual(got,
-0000f8a0: 2027 6475 6d6d 7931 2729 0a20 2020 2020   'dummy1').     
-0000f8b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000f8c0: 7561 6c28 7365 6c66 2e70 6562 626c 652e  ual(self.pebble.
-0000f8d0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000f8e0: 2020 2020 2020 2020 2827 7075 6c6c 272c          ('pull',
-0000f8f0: 2027 2f70 6174 682f 3127 2c20 2775 7466   '/path/1', 'utf
-0000f900: 2d38 2729 2c0a 2020 2020 2020 2020 5d29  -8'),.        ])
-0000f910: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-0000f920: 6262 6c65 2e72 6571 7565 7374 7320 3d20  bble.requests = 
-0000f930: 5b5d 0a0a 2020 2020 2020 2020 7365 6c66  []..        self
-0000f940: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
-0000f950: 732e 6170 7065 6e64 2862 2764 756d 6d79  s.append(b'dummy
-0000f960: 3227 290a 2020 2020 2020 2020 676f 7420  2').        got 
-0000f970: 3d20 7365 6c66 2e63 6f6e 7461 696e 6572  = self.container
-0000f980: 2e70 756c 6c28 272f 7061 7468 2f32 272c  .pull('/path/2',
-0000f990: 2065 6e63 6f64 696e 673d 4e6f 6e65 290a   encoding=None).
-0000f9a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000f9b0: 6572 7445 7175 616c 2867 6f74 2c20 6227  ertEqual(got, b'
-0000f9c0: 6475 6d6d 7932 2729 0a20 2020 2020 2020  dummy2').       
-0000f9d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f9e0: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
-0000f9f0: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000fa00: 2020 2020 2020 2827 7075 6c6c 272c 2027        ('pull', '
-0000fa10: 2f70 6174 682f 3227 2c20 4e6f 6e65 292c  /path/2', None),
-0000fa20: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-0000fa30: 2064 6566 2074 6573 745f 7075 7368 2873   def test_push(s
-0000fa40: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000fa50: 6c66 2e63 6f6e 7461 696e 6572 2e70 7573  lf.container.pus
-0000fa60: 6828 272f 7061 7468 2f31 272c 2027 636f  h('/path/1', 'co
-0000fa70: 6e74 656e 7431 2729 0a20 2020 2020 2020  ntent1').       
-0000fa80: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000fa90: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
-0000faa0: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000fab0: 2020 2020 2020 2827 7075 7368 272c 2027        ('push', '
-0000fac0: 2f70 6174 682f 3127 2c20 2763 6f6e 7465  /path/1', 'conte
-0000fad0: 6e74 3127 2c20 2775 7466 2d38 272c 2046  nt1', 'utf-8', F
-0000fae0: 616c 7365 2c20 4e6f 6e65 2c0a 2020 2020  alse, None,.    
-0000faf0: 2020 2020 2020 2020 204e 6f6e 652c 204e           None, N
-0000fb00: 6f6e 652c 204e 6f6e 652c 204e 6f6e 6529  one, None, None)
-0000fb10: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-0000fb20: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
-0000fb30: 2e72 6571 7565 7374 7320 3d20 5b5d 0a0a  .requests = []..
-0000fb40: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000fb50: 7461 696e 6572 2e70 7573 6828 272f 7061  tainer.push('/pa
-0000fb60: 7468 2f32 272c 2062 2763 6f6e 7465 6e74  th/2', b'content
-0000fb70: 3227 2c20 656e 636f 6469 6e67 3d4e 6f6e  2', encoding=Non
-0000fb80: 652c 206d 616b 655f 6469 7273 3d54 7275  e, make_dirs=Tru
-0000fb90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000fba0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000fbb0: 6572 6d69 7373 696f 6e73 3d30 6f36 3030  ermissions=0o600
-0000fbc0: 2c20 7573 6572 5f69 643d 3132 2c20 7573  , user_id=12, us
-0000fbd0: 6572 3d27 626f 6227 2c20 6772 6f75 705f  er='bob', group_
-0000fbe0: 6964 3d33 342c 2067 726f 7570 3d27 7374  id=34, group='st
-0000fbf0: 6166 6627 290a 2020 2020 2020 2020 7365  aff').        se
-0000fc00: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000fc10: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
-0000fc20: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000fc30: 2020 2028 2770 7573 6827 2c20 272f 7061     ('push', '/pa
-0000fc40: 7468 2f32 272c 2062 2763 6f6e 7465 6e74  th/2', b'content
-0000fc50: 3227 2c20 4e6f 6e65 2c20 5472 7565 2c20  2', None, True, 
-0000fc60: 306f 3630 302c 2031 322c 2027 626f 6227  0o600, 12, 'bob'
-0000fc70: 2c20 3334 2c20 2773 7461 6666 2729 2c0a  , 34, 'staff'),.
-0000fc80: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-0000fc90: 6465 6620 7465 7374 5f6c 6973 745f 6669  def test_list_fi
-0000fca0: 6c65 7328 7365 6c66 293a 0a20 2020 2020  les(self):.     
-0000fcb0: 2020 2073 656c 662e 7065 6262 6c65 2e72     self.pebble.r
-0000fcc0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-0000fcd0: 2764 756d 6d79 3127 290a 2020 2020 2020  'dummy1').      
-0000fce0: 2020 7265 7420 3d20 7365 6c66 2e63 6f6e    ret = self.con
-0000fcf0: 7461 696e 6572 2e6c 6973 745f 6669 6c65  tainer.list_file
-0000fd00: 7328 272f 7061 7468 2f31 2729 0a20 2020  s('/path/1').   
-0000fd10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000fd20: 4571 7561 6c28 7265 742c 2027 6475 6d6d  Equal(ret, 'dumm
-0000fd30: 7931 2729 0a20 2020 2020 2020 2073 656c  y1').        sel
-0000fd40: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000fd50: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
-0000fd60: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-0000fd70: 2020 2827 6c69 7374 5f66 696c 6573 272c    ('list_files',
-0000fd80: 2027 2f70 6174 682f 3127 2c20 4e6f 6e65   '/path/1', None
-0000fd90: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
-0000fda0: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
-0000fdb0: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
-0000fdc0: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
-0000fdd0: 7365 6c66 2e70 6562 626c 652e 7265 7370  self.pebble.resp
-0000fde0: 6f6e 7365 732e 6170 7065 6e64 2827 6475  onses.append('du
-0000fdf0: 6d6d 7932 2729 0a20 2020 2020 2020 2072  mmy2').        r
-0000fe00: 6574 203d 2073 656c 662e 636f 6e74 6169  et = self.contai
-0000fe10: 6e65 722e 6c69 7374 5f66 696c 6573 2827  ner.list_files('
-0000fe20: 2f70 6174 682f 3227 2c20 7061 7474 6572  /path/2', patter
-0000fe30: 6e3d 272a 2e74 7874 272c 2069 7473 656c  n='*.txt', itsel
-0000fe40: 663d 5472 7565 290a 2020 2020 2020 2020  f=True).        
-0000fe50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000fe60: 2872 6574 2c20 2764 756d 6d79 3227 290a  (ret, 'dummy2').
-0000fe70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000fe80: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
-0000fe90: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
-0000fea0: 0a20 2020 2020 2020 2020 2020 2028 276c  .            ('l
-0000feb0: 6973 745f 6669 6c65 7327 2c20 272f 7061  ist_files', '/pa
-0000fec0: 7468 2f32 272c 2027 2a2e 7478 7427 2c20  th/2', '*.txt', 
-0000fed0: 5472 7565 292c 0a20 2020 2020 2020 205d  True),.        ]
-0000fee0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000fef0: 6d61 6b65 5f64 6972 2873 656c 6629 3a0a  make_dir(self):.
-0000ff00: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000ff10: 7461 696e 6572 2e6d 616b 655f 6469 7228  tainer.make_dir(
-0000ff20: 272f 7061 7468 2f31 2729 0a20 2020 2020  '/path/1').     
-0000ff30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000ff40: 7561 6c28 7365 6c66 2e70 6562 626c 652e  ual(self.pebble.
-0000ff50: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000ff60: 2020 2020 2020 2020 2827 6d61 6b65 5f64          ('make_d
-0000ff70: 6972 272c 2027 2f70 6174 682f 3127 2c20  ir', '/path/1', 
-0000ff80: 4661 6c73 652c 204e 6f6e 652c 204e 6f6e  False, None, Non
-0000ff90: 652c 204e 6f6e 652c 204e 6f6e 652c 204e  e, None, None, N
-0000ffa0: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-0000ffb0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-0000ffc0: 6262 6c65 2e72 6571 7565 7374 7320 3d20  bble.requests = 
-0000ffd0: 5b5d 0a0a 2020 2020 2020 2020 7365 6c66  []..        self
-0000ffe0: 2e63 6f6e 7461 696e 6572 2e6d 616b 655f  .container.make_
-0000fff0: 6469 7228 272f 7061 7468 2f32 272c 206d  dir('/path/2', m
-00010000: 616b 655f 7061 7265 6e74 733d 5472 7565  ake_parents=True
-00010010: 2c20 7065 726d 6973 7369 6f6e 733d 306f  , permissions=0o
-00010020: 3730 302c 0a20 2020 2020 2020 2020 2020  700,.           
-00010030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010040: 2020 2020 2075 7365 725f 6964 3d31 322c       user_id=12,
-00010050: 2075 7365 723d 2762 6f62 272c 2067 726f   user='bob', gro
-00010060: 7570 5f69 643d 3334 2c20 6772 6f75 703d  up_id=34, group=
-00010070: 2773 7461 6666 2729 0a20 2020 2020 2020  'staff').       
-00010080: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00010090: 6c28 7365 6c66 2e70 6562 626c 652e 7265  l(self.pebble.re
-000100a0: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-000100b0: 2020 2020 2020 2827 6d61 6b65 5f64 6972        ('make_dir
-000100c0: 272c 2027 2f70 6174 682f 3227 2c20 5472  ', '/path/2', Tr
-000100d0: 7565 2c20 306f 3730 302c 2031 322c 2027  ue, 0o700, 12, '
-000100e0: 626f 6227 2c20 3334 2c20 2773 7461 6666  bob', 34, 'staff
-000100f0: 2729 2c0a 2020 2020 2020 2020 5d29 0a0a  '),.        ])..
-00010100: 2020 2020 6465 6620 7465 7374 5f72 656d      def test_rem
-00010110: 6f76 655f 7061 7468 2873 656c 6629 3a0a  ove_path(self):.
-00010120: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00010130: 7461 696e 6572 2e72 656d 6f76 655f 7061  tainer.remove_pa
-00010140: 7468 2827 2f70 6174 682f 3127 290a 2020  th('/path/1').  
-00010150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010160: 7445 7175 616c 2873 656c 662e 7065 6262  tEqual(self.pebb
-00010170: 6c65 2e72 6571 7565 7374 732c 205b 0a20  le.requests, [. 
-00010180: 2020 2020 2020 2020 2020 2028 2772 656d             ('rem
-00010190: 6f76 655f 7061 7468 272c 2027 2f70 6174  ove_path', '/pat
-000101a0: 682f 3127 2c20 4661 6c73 6529 2c0a 2020  h/1', False),.  
-000101b0: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-000101c0: 2073 656c 662e 7065 6262 6c65 2e72 6571   self.pebble.req
-000101d0: 7565 7374 7320 3d20 5b5d 0a0a 2020 2020  uests = []..    
-000101e0: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
-000101f0: 6572 2e72 656d 6f76 655f 7061 7468 2827  er.remove_path('
-00010200: 2f70 6174 682f 3227 2c20 7265 6375 7273  /path/2', recurs
-00010210: 6976 653d 5472 7565 290a 2020 2020 2020  ive=True).      
-00010220: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00010230: 616c 2873 656c 662e 7065 6262 6c65 2e72  al(self.pebble.r
-00010240: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-00010250: 2020 2020 2020 2028 2772 656d 6f76 655f         ('remove_
-00010260: 7061 7468 272c 2027 2f70 6174 682f 3227  path', '/path/2'
-00010270: 2c20 5472 7565 292c 0a20 2020 2020 2020  , True),.       
-00010280: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
-00010290: 745f 6361 6e5f 636f 6e6e 6563 745f 7369  t_can_connect_si
-000102a0: 6d70 6c65 2873 656c 6629 3a0a 2020 2020  mple(self):.    
-000102b0: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
-000102c0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-000102d0: 2853 7973 7465 6d49 6e66 6f2e 6672 6f6d  (SystemInfo.from
-000102e0: 5f64 6963 7428 7b27 7665 7273 696f 6e27  _dict({'version'
-000102f0: 3a20 2731 2e30 2e30 277d 2929 0a20 2020  : '1.0.0'})).   
-00010300: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00010310: 5472 7565 2873 656c 662e 636f 6e74 6169  True(self.contai
-00010320: 6e65 722e 6361 6e5f 636f 6e6e 6563 7428  ner.can_connect(
-00010330: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-00010340: 5f63 616e 5f63 6f6e 6e65 6374 5f63 6f6e  _can_connect_con
-00010350: 6e65 6374 696f 6e5f 6572 726f 7228 7365  nection_error(se
-00010360: 6c66 293a 0a20 2020 2020 2020 2064 6566  lf):.        def
-00010370: 2072 6169 7365 5f65 7272 6f72 2829 3a0a   raise_error():.
-00010380: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00010390: 6520 436f 6e6e 6563 7469 6f6e 4572 726f  e ConnectionErro
-000103a0: 7228 2763 6f6e 6e65 6374 696f 6e20 6572  r('connection er
-000103b0: 726f 7221 2729 0a20 2020 2020 2020 2073  ror!').        s
-000103c0: 656c 662e 7065 6262 6c65 2e67 6574 5f73  elf.pebble.get_s
-000103d0: 7973 7465 6d5f 696e 666f 203d 2072 6169  ystem_info = rai
-000103e0: 7365 5f65 7272 6f72 0a20 2020 2020 2020  se_error.       
-000103f0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00010400: 744c 6f67 7328 276f 7073 2e6d 6f64 656c  tLogs('ops.model
-00010410: 272c 206c 6576 656c 3d27 4445 4255 4727  ', level='DEBUG'
-00010420: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-00010430: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00010440: 4661 6c73 6528 7365 6c66 2e63 6f6e 7461  False(self.conta
-00010450: 696e 6572 2e63 616e 5f63 6f6e 6e65 6374  iner.can_connect
-00010460: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
-00010470: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-00010480: 2863 6d2e 6f75 7470 7574 292c 2031 290a  (cm.output), 1).
-00010490: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000104a0: 6572 7452 6567 6578 2863 6d2e 6f75 7470  ertRegex(cm.outp
-000104b0: 7574 5b30 5d2c 2072 2744 4542 5547 3a6f  ut[0], r'DEBUG:o
-000104c0: 7073 2e6d 6f64 656c 3a2e 2a3a 2063 6f6e  ps.model:.*: con
-000104d0: 6e65 6374 696f 6e20 6572 726f 7221 2729  nection error!')
-000104e0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-000104f0: 616e 5f63 6f6e 6e65 6374 5f66 696c 655f  an_connect_file_
-00010500: 6e6f 745f 666f 756e 645f 6572 726f 7228  not_found_error(
-00010510: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-00010520: 6566 2072 6169 7365 5f65 7272 6f72 2829  ef raise_error()
-00010530: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00010540: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
-00010550: 4572 726f 7228 2766 696c 6520 6e6f 7420  Error('file not 
-00010560: 666f 756e 6421 2729 0a20 2020 2020 2020  found!').       
-00010570: 2073 656c 662e 7065 6262 6c65 2e67 6574   self.pebble.get
-00010580: 5f73 7973 7465 6d5f 696e 666f 203d 2072  _system_info = r
-00010590: 6169 7365 5f65 7272 6f72 0a20 2020 2020  aise_error.     
-000105a0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-000105b0: 6572 744c 6f67 7328 276f 7073 2e6d 6f64  ertLogs('ops.mod
-000105c0: 656c 272c 206c 6576 656c 3d27 4445 4255  el', level='DEBU
-000105d0: 4727 2920 6173 2063 6d3a 0a20 2020 2020  G') as cm:.     
-000105e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000105f0: 7274 4661 6c73 6528 7365 6c66 2e63 6f6e  rtFalse(self.con
-00010600: 7461 696e 6572 2e63 616e 5f63 6f6e 6e65  tainer.can_conne
-00010610: 6374 2829 290a 2020 2020 2020 2020 7365  ct()).        se
-00010620: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-00010630: 656e 2863 6d2e 6f75 7470 7574 292c 2031  en(cm.output), 1
-00010640: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00010650: 7373 6572 7452 6567 6578 2863 6d2e 6f75  ssertRegex(cm.ou
-00010660: 7470 7574 5b30 5d2c 2072 2744 4542 5547  tput[0], r'DEBUG
-00010670: 3a6f 7073 2e6d 6f64 656c 3a2e 2a3a 2066  :ops.model:.*: f
-00010680: 696c 6520 6e6f 7420 666f 756e 6421 2729  ile not found!')
-00010690: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-000106a0: 616e 5f63 6f6e 6e65 6374 5f61 7069 5f65  an_connect_api_e
-000106b0: 7272 6f72 2873 656c 6629 3a0a 2020 2020  rror(self):.    
-000106c0: 2020 2020 6465 6620 7261 6973 655f 6572      def raise_er
-000106d0: 726f 7228 293a 0a20 2020 2020 2020 2020  ror():.         
-000106e0: 2020 2072 6169 7365 2041 5049 4572 726f     raise APIErro
-000106f0: 7228 2762 6f64 7927 2c20 3430 342c 2027  r('body', 404, '
-00010700: 7374 6174 7573 272c 2027 6170 6920 6572  status', 'api er
-00010710: 726f 7221 2729 0a20 2020 2020 2020 2073  ror!').        s
-00010720: 656c 662e 7065 6262 6c65 2e67 6574 5f73  elf.pebble.get_s
-00010730: 7973 7465 6d5f 696e 666f 203d 2072 6169  ystem_info = rai
-00010740: 7365 5f65 7272 6f72 0a20 2020 2020 2020  se_error.       
-00010750: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00010760: 744c 6f67 7328 276f 7073 2e6d 6f64 656c  tLogs('ops.model
-00010770: 2729 2061 7320 636d 3a0a 2020 2020 2020  ') as cm:.      
-00010780: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010790: 7446 616c 7365 2873 656c 662e 636f 6e74  tFalse(self.cont
-000107a0: 6169 6e65 722e 6361 6e5f 636f 6e6e 6563  ainer.can_connec
-000107b0: 7428 2929 0a20 2020 2020 2020 2073 656c  t()).        sel
-000107c0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-000107d0: 6e28 636d 2e6f 7574 7075 7429 2c20 3129  n(cm.output), 1)
-000107e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000107f0: 7365 7274 5265 6765 7828 636d 2e6f 7574  sertRegex(cm.out
-00010800: 7075 745b 305d 2c20 7227 5741 524e 494e  put[0], r'WARNIN
-00010810: 473a 6f70 732e 6d6f 6465 6c3a 2e2a 3a20  G:ops.model:.*: 
-00010820: 6170 6920 6572 726f 7221 2729 0a0a 2020  api error!')..  
-00010830: 2020 6465 6620 7465 7374 5f65 7865 6328    def test_exec(
-00010840: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00010850: 656c 662e 7065 6262 6c65 2e72 6573 706f  elf.pebble.respo
-00010860: 6e73 6573 2e61 7070 656e 6428 2766 616b  nses.append('fak
-00010870: 655f 6578 6563 5f70 726f 6365 7373 2729  e_exec_process')
-00010880: 0a20 2020 2020 2020 2070 203d 2073 656c  .        p = sel
-00010890: 662e 636f 6e74 6169 6e65 722e 6578 6563  f.container.exec
-000108a0: 280a 2020 2020 2020 2020 2020 2020 5b27  (.            ['
-000108b0: 6563 686f 272c 2027 666f 6f27 5d2c 0a20  echo', 'foo'],. 
-000108c0: 2020 2020 2020 2020 2020 2065 6e76 6972             envir
-000108d0: 6f6e 6d65 6e74 3d7b 274b 3127 3a20 2756  onment={'K1': 'V
-000108e0: 3127 2c20 274b 3227 3a20 2756 3227 7d2c  1', 'K2': 'V2'},
-000108f0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-00010900: 6b69 6e67 5f64 6972 3d27 5744 272c 0a20  king_dir='WD',. 
-00010910: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-00010920: 7574 3d31 302e 352c 0a20 2020 2020 2020  ut=10.5,.       
-00010930: 2020 2020 2075 7365 725f 6964 3d31 3030       user_id=100
-00010940: 302c 0a20 2020 2020 2020 2020 2020 2075  0,.            u
-00010950: 7365 723d 2762 6f62 272c 0a20 2020 2020  ser='bob',.     
-00010960: 2020 2020 2020 2067 726f 7570 5f69 643d         group_id=
-00010970: 3130 3030 2c0a 2020 2020 2020 2020 2020  1000,.          
-00010980: 2020 6772 6f75 703d 2773 7461 6666 272c    group='staff',
-00010990: 0a20 2020 2020 2020 2020 2020 2073 7464  .            std
-000109a0: 696e 3d27 5354 4449 4e27 2c0a 2020 2020  in='STDIN',.    
-000109b0: 2020 2020 2020 2020 7374 646f 7574 3d27          stdout='
-000109c0: 5354 444f 5554 272c 0a20 2020 2020 2020  STDOUT',.       
-000109d0: 2020 2020 2073 7464 6572 723d 2753 5444       stderr='STD
-000109e0: 4552 5227 2c0a 2020 2020 2020 2020 2020  ERR',.          
-000109f0: 2020 656e 636f 6469 6e67 3d4e 6f6e 652c    encoding=None,
-00010a00: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
-00010a10: 6269 6e65 5f73 7464 6572 723d 5472 7565  bine_stderr=True
-00010a20: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00010a30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00010a40: 7175 616c 2873 656c 662e 7065 6262 6c65  qual(self.pebble
-00010a50: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-00010a60: 2020 2020 2020 2020 2028 2765 7865 6327           ('exec'
-00010a70: 2c20 5b27 6563 686f 272c 2027 666f 6f27  , ['echo', 'foo'
-00010a80: 5d2c 2064 6963 7428 0a20 2020 2020 2020  ], dict(.       
-00010a90: 2020 2020 2020 2020 2065 6e76 6972 6f6e           environ
-00010aa0: 6d65 6e74 3d7b 274b 3127 3a20 2756 3127  ment={'K1': 'V1'
-00010ab0: 2c20 274b 3227 3a20 2756 3227 7d2c 0a20  , 'K2': 'V2'},. 
-00010ac0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00010ad0: 6f72 6b69 6e67 5f64 6972 3d27 5744 272c  orking_dir='WD',
-00010ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010af0: 2074 696d 656f 7574 3d31 302e 352c 0a20   timeout=10.5,. 
-00010b00: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00010b10: 7365 725f 6964 3d31 3030 302c 0a20 2020  ser_id=1000,.   
-00010b20: 2020 2020 2020 2020 2020 2020 2075 7365               use
-00010b30: 723d 2762 6f62 272c 0a20 2020 2020 2020  r='bob',.       
-00010b40: 2020 2020 2020 2020 2067 726f 7570 5f69           group_i
-00010b50: 643d 3130 3030 2c0a 2020 2020 2020 2020  d=1000,.        
-00010b60: 2020 2020 2020 2020 6772 6f75 703d 2773          group='s
-00010b70: 7461 6666 272c 0a20 2020 2020 2020 2020  taff',.         
-00010b80: 2020 2020 2020 2073 7464 696e 3d27 5354         stdin='ST
-00010b90: 4449 4e27 2c0a 2020 2020 2020 2020 2020  DIN',.          
-00010ba0: 2020 2020 2020 7374 646f 7574 3d27 5354        stdout='ST
-00010bb0: 444f 5554 272c 0a20 2020 2020 2020 2020  DOUT',.         
-00010bc0: 2020 2020 2020 2073 7464 6572 723d 2753         stderr='S
-00010bd0: 5444 4552 5227 2c0a 2020 2020 2020 2020  TDERR',.        
-00010be0: 2020 2020 2020 2020 656e 636f 6469 6e67          encoding
-00010bf0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00010c00: 2020 2020 2020 2063 6f6d 6269 6e65 5f73         combine_s
-00010c10: 7464 6572 723d 5472 7565 2c0a 2020 2020  tderr=True,.    
-00010c20: 2020 2020 2020 2020 2929 0a20 2020 2020          )).     
-00010c30: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
-00010c40: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-00010c50: 2c20 2766 616b 655f 6578 6563 5f70 726f  , 'fake_exec_pro
-00010c60: 6365 7373 2729 0a0a 2020 2020 6465 6620  cess')..    def 
-00010c70: 7465 7374 5f73 656e 645f 7369 676e 616c  test_send_signal
-00010c80: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00010c90: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00010ca0: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-00010cb0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00010cc0: 656c 662e 636f 6e74 6169 6e65 722e 7365  elf.container.se
-00010cd0: 6e64 5f73 6967 6e61 6c28 2753 4947 4855  nd_signal('SIGHU
-00010ce0: 5027 290a 0a20 2020 2020 2020 2073 656c  P')..        sel
-00010cf0: 662e 636f 6e74 6169 6e65 722e 7365 6e64  f.container.send
-00010d00: 5f73 6967 6e61 6c28 2753 4947 4855 5027  _signal('SIGHUP'
-00010d10: 2c20 2773 3127 290a 2020 2020 2020 2020  , 's1').        
-00010d20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00010d30: 2873 656c 662e 7065 6262 6c65 2e72 6571  (self.pebble.req
-00010d40: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-00010d50: 2020 2020 2028 2773 656e 645f 7369 676e       ('send_sign
-00010d60: 616c 272c 2027 5349 4748 5550 272c 2028  al', 'SIGHUP', (
-00010d70: 2773 3127 2c29 292c 0a20 2020 2020 2020  's1',)),.       
-00010d80: 205d 290a 2020 2020 2020 2020 7365 6c66   ]).        self
-00010d90: 2e70 6562 626c 652e 7265 7175 6573 7473  .pebble.requests
-00010da0: 203d 205b 5d0a 0a20 2020 2020 2020 2073   = []..        s
-00010db0: 656c 662e 636f 6e74 6169 6e65 722e 7365  elf.container.se
-00010dc0: 6e64 5f73 6967 6e61 6c28 2753 4947 4855  nd_signal('SIGHU
-00010dd0: 5027 2c20 2773 3127 2c20 2773 3227 290a  P', 's1', 's2').
-00010de0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00010df0: 6572 7445 7175 616c 2873 656c 662e 7065  ertEqual(self.pe
-00010e00: 6262 6c65 2e72 6571 7565 7374 732c 205b  bble.requests, [
-00010e10: 0a20 2020 2020 2020 2020 2020 2028 2773  .            ('s
-00010e20: 656e 645f 7369 676e 616c 272c 2027 5349  end_signal', 'SI
-00010e30: 4748 5550 272c 2028 2773 3127 2c20 2773  GHUP', ('s1', 's
-00010e40: 3227 2929 2c0a 2020 2020 2020 2020 5d29  2')),.        ])
-00010e50: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-00010e60: 6262 6c65 2e72 6571 7565 7374 7320 3d20  bble.requests = 
-00010e70: 5b5d 0a0a 0a63 6c61 7373 204d 6f63 6b50  []...class MockP
-00010e80: 6562 626c 6542 6163 6b65 6e64 286f 7073  ebbleBackend(ops
-00010e90: 2e6d 6f64 656c 2e5f 4d6f 6465 6c42 6163  .model._ModelBac
-00010ea0: 6b65 6e64 293a 0a20 2020 2064 6566 2067  kend):.    def g
-00010eb0: 6574 5f70 6562 626c 6528 7365 6c66 2c20  et_pebble(self, 
-00010ec0: 736f 636b 6574 5f70 6174 6829 3a0a 2020  socket_path):.  
-00010ed0: 2020 2020 2020 7265 7475 726e 204d 6f63        return Moc
-00010ee0: 6b50 6562 626c 6543 6c69 656e 7428 736f  kPebbleClient(so
-00010ef0: 636b 6574 5f70 6174 6829 0a0a 0a63 6c61  cket_path)...cla
-00010f00: 7373 204d 6f63 6b50 6562 626c 6543 6c69  ss MockPebbleCli
-00010f10: 656e 743a 0a20 2020 2064 6566 205f 5f69  ent:.    def __i
-00010f20: 6e69 745f 5f28 7365 6c66 2c20 736f 636b  nit__(self, sock
-00010f30: 6574 5f70 6174 6829 3a0a 2020 2020 2020  et_path):.      
-00010f40: 2020 7365 6c66 2e73 6f63 6b65 745f 7061    self.socket_pa
-00010f50: 7468 203d 2073 6f63 6b65 745f 7061 7468  th = socket_path
-00010f60: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00010f70: 7175 6573 7473 203d 205b 5d0a 2020 2020  quests = [].    
-00010f80: 2020 2020 7365 6c66 2e72 6573 706f 6e73      self.respons
-00010f90: 6573 203d 205b 5d0a 0a20 2020 2064 6566  es = []..    def
-00010fa0: 2061 7574 6f73 7461 7274 5f73 6572 7669   autostart_servi
-00010fb0: 6365 7328 7365 6c66 293a 0a20 2020 2020  ces(self):.     
-00010fc0: 2020 2073 656c 662e 7265 7175 6573 7473     self.requests
-00010fd0: 2e61 7070 656e 6428 2827 6175 746f 7374  .append(('autost
-00010fe0: 6172 7427 2c29 290a 0a20 2020 2064 6566  art',))..    def
-00010ff0: 2067 6574 5f73 7973 7465 6d5f 696e 666f   get_system_info
-00011000: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00011010: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
-00011020: 7065 6e64 2828 2767 6574 5f73 7973 7465  pend(('get_syste
-00011030: 6d5f 696e 666f 272c 2929 0a20 2020 2020  m_info',)).     
-00011040: 2020 2072 6574 7572 6e20 7365 6c66 2e72     return self.r
-00011050: 6573 706f 6e73 6573 2e70 6f70 2830 290a  esponses.pop(0).
-00011060: 0a20 2020 2064 6566 2072 6570 6c61 6e5f  .    def replan_
-00011070: 7365 7276 6963 6573 2873 656c 6629 3a0a  services(self):.
-00011080: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
-00011090: 7565 7374 732e 6170 7065 6e64 2828 2772  uests.append(('r
-000110a0: 6570 6c61 6e27 2c29 290a 0a20 2020 2064  eplan',))..    d
-000110b0: 6566 2073 7461 7274 5f73 6572 7669 6365  ef start_service
-000110c0: 7328 7365 6c66 2c20 7365 7276 6963 655f  s(self, service_
-000110d0: 6e61 6d65 7329 3a0a 2020 2020 2020 2020  names):.        
-000110e0: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
-000110f0: 7065 6e64 2828 2773 7461 7274 272c 2073  pend(('start', s
-00011100: 6572 7669 6365 5f6e 616d 6573 2929 0a0a  ervice_names))..
-00011110: 2020 2020 6465 6620 7374 6f70 5f73 6572      def stop_ser
-00011120: 7669 6365 7328 7365 6c66 2c20 7365 7276  vices(self, serv
-00011130: 6963 655f 6e61 6d65 7329 3a0a 2020 2020  ice_names):.    
-00011140: 2020 2020 7365 6c66 2e72 6571 7565 7374      self.request
-00011150: 732e 6170 7065 6e64 2828 2773 746f 7027  s.append(('stop'
-00011160: 2c20 7365 7276 6963 655f 6e61 6d65 7329  , service_names)
-00011170: 290a 0a20 2020 2064 6566 2072 6573 7461  )..    def resta
-00011180: 7274 5f73 6572 7669 6365 7328 7365 6c66  rt_services(self
-00011190: 2c20 7365 7276 6963 655f 6e61 6d65 7329  , service_names)
-000111a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e72  :.        self.r
-000111b0: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
-000111c0: 2772 6573 7461 7274 272c 2073 6572 7669  'restart', servi
-000111d0: 6365 5f6e 616d 6573 2929 0a0a 2020 2020  ce_names))..    
-000111e0: 6465 6620 6164 645f 6c61 7965 7228 7365  def add_layer(se
-000111f0: 6c66 2c20 6c61 6265 6c2c 206c 6179 6572  lf, label, layer
-00011200: 2c20 636f 6d62 696e 653d 4661 6c73 6529  , combine=False)
-00011210: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-00011220: 6e73 7461 6e63 6528 6c61 7965 722c 2064  nstance(layer, d
-00011230: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-00011240: 2020 6c61 7965 7220 3d20 6f70 732e 7065    layer = ops.pe
-00011250: 6262 6c65 2e4c 6179 6572 286c 6179 6572  bble.Layer(layer
-00011260: 292e 746f 5f79 616d 6c28 290a 2020 2020  ).to_yaml().    
-00011270: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00011280: 6e63 6528 6c61 7965 722c 206f 7073 2e70  nce(layer, ops.p
-00011290: 6562 626c 652e 4c61 7965 7229 3a0a 2020  ebble.Layer):.  
-000112a0: 2020 2020 2020 2020 2020 6c61 7965 7220            layer 
-000112b0: 3d20 6c61 7965 722e 746f 5f79 616d 6c28  = layer.to_yaml(
-000112c0: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-000112d0: 6571 7565 7374 732e 6170 7065 6e64 2828  equests.append((
-000112e0: 2761 6464 5f6c 6179 6572 272c 206c 6162  'add_layer', lab
-000112f0: 656c 2c20 6c61 7965 722c 2063 6f6d 6269  el, layer, combi
-00011300: 6e65 2929 0a0a 2020 2020 6465 6620 6765  ne))..    def ge
-00011310: 745f 706c 616e 2873 656c 6629 3a0a 2020  t_plan(self):.  
-00011320: 2020 2020 2020 7365 6c66 2e72 6571 7565        self.reque
-00011330: 7374 732e 6170 7065 6e64 2828 2767 6574  sts.append(('get
-00011340: 5f70 6c61 6e27 2c29 290a 2020 2020 2020  _plan',)).      
-00011350: 2020 7265 7475 726e 2073 656c 662e 7265    return self.re
-00011360: 7370 6f6e 7365 732e 706f 7028 3029 0a0a  sponses.pop(0)..
-00011370: 2020 2020 6465 6620 6765 745f 7365 7276      def get_serv
-00011380: 6963 6573 2873 656c 662c 206e 616d 6573  ices(self, names
-00011390: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-000113a0: 7365 6c66 2e72 6571 7565 7374 732e 6170  self.requests.ap
-000113b0: 7065 6e64 2828 2767 6574 5f73 6572 7669  pend(('get_servi
-000113c0: 6365 7327 2c20 6e61 6d65 7329 290a 2020  ces', names)).  
-000113d0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000113e0: 662e 7265 7370 6f6e 7365 732e 706f 7028  f.responses.pop(
-000113f0: 3029 0a0a 2020 2020 6465 6620 6765 745f  0)..    def get_
-00011400: 6368 6563 6b73 2873 656c 662c 206c 6576  checks(self, lev
-00011410: 656c 3d4e 6f6e 652c 206e 616d 6573 3d4e  el=None, names=N
-00011420: 6f6e 6529 3a0a 2020 2020 2020 2020 7365  one):.        se
-00011430: 6c66 2e72 6571 7565 7374 732e 6170 7065  lf.requests.appe
-00011440: 6e64 2828 2767 6574 5f63 6865 636b 7327  nd(('get_checks'
-00011450: 2c20 6c65 7665 6c2c 206e 616d 6573 2929  , level, names))
-00011460: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011470: 7365 6c66 2e72 6573 706f 6e73 6573 2e70  self.responses.p
-00011480: 6f70 2830 290a 0a20 2020 2064 6566 2070  op(0)..    def p
-00011490: 756c 6c28 7365 6c66 2c20 7061 7468 2c20  ull(self, path, 
-000114a0: 2a2c 2065 6e63 6f64 696e 673d 2775 7466  *, encoding='utf
-000114b0: 2d38 2729 3a0a 2020 2020 2020 2020 7365  -8'):.        se
+0000e560: 454e 4142 4c45 4429 0a20 2020 2020 2020  ENABLED).       
+0000e570: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000e580: 6c28 732e 6375 7272 656e 742c 2070 6562  l(s.current, peb
+0000e590: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
+0000e5a0: 732e 4143 5449 5645 290a 0a20 2020 2020  s.ACTIVE)..     
+0000e5b0: 2020 2023 2049 6620 5065 6262 6c65 2072     # If Pebble r
+0000e5c0: 6574 7572 6e73 206e 6f20 7365 7276 6963  eturns no servic
+0000e5d0: 6573 2c20 7368 6f75 6c64 2062 6520 6120  es, should be a 
+0000e5e0: 6f70 732e 4d6f 6465 6c45 7272 6f72 0a20  ops.ModelError. 
+0000e5f0: 2020 2020 2020 2073 656c 662e 7065 6262         self.pebb
+0000e600: 6c65 2e72 6573 706f 6e73 6573 2e61 7070  le.responses.app
+0000e610: 656e 6428 5b5d 290a 2020 2020 2020 2020  end([]).        
+0000e620: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000e630: 5261 6973 6573 286f 7073 2e4d 6f64 656c  Raises(ops.Model
+0000e640: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
+0000e650: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0000e660: 6f6e 7461 696e 6572 2e67 6574 5f73 6572  ontainer.get_ser
+0000e670: 7669 6365 2827 7332 2729 0a20 2020 2020  vice('s2').     
+0000e680: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000e690: 7561 6c28 7374 7228 636d 2e65 7863 6570  ual(str(cm.excep
+0000e6a0: 7469 6f6e 292c 2022 7365 7276 6963 6520  tion), "service 
+0000e6b0: 2773 3227 206e 6f74 2066 6f75 6e64 2229  's2' not found")
+0000e6c0: 0a0a 2020 2020 2020 2020 2320 4966 2050  ..        # If P
+0000e6d0: 6562 626c 6520 7265 7475 726e 7320 6d6f  ebble returns mo
+0000e6e0: 7265 2074 6861 6e20 6f6e 6520 7365 7276  re than one serv
+0000e6f0: 6963 652c 2052 756e 7469 6d65 4572 726f  ice, RuntimeErro
+0000e700: 7220 6973 2072 6169 7365 640a 2020 2020  r is raised.    
+0000e710: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+0000e720: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000e730: 285b 0a20 2020 2020 2020 2020 2020 2073  ([.            s
+0000e740: 656c 662e 5f6d 616b 655f 7365 7276 6963  elf._make_servic
+0000e750: 6528 2773 3127 2c20 2765 6e61 626c 6564  e('s1', 'enabled
+0000e760: 272c 2027 6163 7469 7665 2729 2c0a 2020  ', 'active'),.  
+0000e770: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0000e780: 6d61 6b65 5f73 6572 7669 6365 2827 7332  make_service('s2
+0000e790: 272c 2027 6469 7361 626c 6564 272c 2027  ', 'disabled', '
+0000e7a0: 696e 6163 7469 7665 2729 2c0a 2020 2020  inactive'),.    
+0000e7b0: 2020 2020 5d29 0a20 2020 2020 2020 2077      ]).        w
+0000e7c0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000e7d0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
+0000e7e0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0000e7f0: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0000e800: 6765 745f 7365 7276 6963 6528 2773 3127  get_service('s1'
+0000e810: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000e820: 6765 745f 6368 6563 6b73 2873 656c 6629  get_checks(self)
+0000e830: 3a0a 2020 2020 2020 2020 7265 7370 6f6e  :.        respon
+0000e840: 7365 5f63 6865 636b 7320 3d20 5b0a 2020  se_checks = [.  
+0000e850: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
+0000e860: 2e43 6865 636b 496e 666f 2e66 726f 6d5f  .CheckInfo.from_
+0000e870: 6469 6374 287b 0a20 2020 2020 2020 2020  dict({.         
+0000e880: 2020 2020 2020 2027 6e61 6d65 273a 2027         'name': '
+0000e890: 6331 272c 0a20 2020 2020 2020 2020 2020  c1',.           
+0000e8a0: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
+0000e8b0: 7570 272c 0a20 2020 2020 2020 2020 2020  up',.           
+0000e8c0: 2020 2020 2027 6661 696c 7572 6573 273a       'failures':
+0000e8d0: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
+0000e8e0: 2020 2020 2774 6872 6573 686f 6c64 273a      'threshold':
+0000e8f0: 2033 2c0a 2020 2020 2020 2020 2020 2020   3,.            
+0000e900: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+0000e910: 7065 6262 6c65 2e43 6865 636b 496e 666f  pebble.CheckInfo
+0000e920: 2e66 726f 6d5f 6469 6374 287b 0a20 2020  .from_dict({.   
+0000e930: 2020 2020 2020 2020 2020 2020 2027 6e61               'na
+0000e940: 6d65 273a 2027 6332 272c 0a20 2020 2020  me': 'c2',.     
+0000e950: 2020 2020 2020 2020 2020 2027 6c65 7665             'leve
+0000e960: 6c27 3a20 2761 6c69 7665 272c 0a20 2020  l': 'alive',.   
+0000e970: 2020 2020 2020 2020 2020 2020 2027 7374               'st
+0000e980: 6174 7573 273a 2027 646f 776e 272c 0a20  atus': 'down',. 
+0000e990: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000e9a0: 6661 696c 7572 6573 273a 2032 2c0a 2020  failures': 2,.  
+0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2774                't
+0000e9c0: 6872 6573 686f 6c64 273a 2032 2c0a 2020  hreshold': 2,.  
+0000e9d0: 2020 2020 2020 2020 2020 7d29 2c0a 2020            }),.  
+0000e9e0: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
+0000e9f0: 2073 656c 662e 7065 6262 6c65 2e72 6573   self.pebble.res
+0000ea00: 706f 6e73 6573 2e61 7070 656e 6428 7265  ponses.append(re
+0000ea10: 7370 6f6e 7365 5f63 6865 636b 7329 0a20  sponse_checks). 
+0000ea20: 2020 2020 2020 2063 6865 636b 7320 3d20         checks = 
+0000ea30: 7365 6c66 2e63 6f6e 7461 696e 6572 2e67  self.container.g
+0000ea40: 6574 5f63 6865 636b 7328 290a 2020 2020  et_checks().    
+0000ea50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000ea60: 7175 616c 286c 656e 2863 6865 636b 7329  qual(len(checks)
+0000ea70: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
+0000ea80: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+0000ea90: 6563 6b73 5b27 6331 275d 2e6e 616d 652c  ecks['c1'].name,
+0000eaa0: 2027 6331 2729 0a20 2020 2020 2020 2073   'c1').        s
+0000eab0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000eac0: 6368 6563 6b73 5b27 6331 275d 2e6c 6576  checks['c1'].lev
+0000ead0: 656c 2c20 7065 6262 6c65 2e43 6865 636b  el, pebble.Check
+0000eae0: 4c65 7665 6c2e 554e 5345 5429 0a20 2020  Level.UNSET).   
+0000eaf0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000eb00: 4571 7561 6c28 6368 6563 6b73 5b27 6331  Equal(checks['c1
+0000eb10: 275d 2e73 7461 7475 732c 2070 6562 626c  '].status, pebbl
+0000eb20: 652e 4368 6563 6b53 7461 7475 732e 5550  e.CheckStatus.UP
+0000eb30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000eb40: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0000eb50: 735b 2763 3127 5d2e 6661 696c 7572 6573  s['c1'].failures
+0000eb60: 2c20 3029 0a20 2020 2020 2020 2073 656c  , 0).        sel
+0000eb70: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+0000eb80: 6563 6b73 5b27 6331 275d 2e74 6872 6573  ecks['c1'].thres
+0000eb90: 686f 6c64 2c20 3329 0a20 2020 2020 2020  hold, 3).       
+0000eba0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ebb0: 6c28 6368 6563 6b73 5b27 6332 275d 2e6e  l(checks['c2'].n
+0000ebc0: 616d 652c 2027 6332 2729 0a20 2020 2020  ame, 'c2').     
+0000ebd0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ebe0: 7561 6c28 6368 6563 6b73 5b27 6332 275d  ual(checks['c2']
+0000ebf0: 2e6c 6576 656c 2c20 7065 6262 6c65 2e43  .level, pebble.C
+0000ec00: 6865 636b 4c65 7665 6c2e 414c 4956 4529  heckLevel.ALIVE)
+0000ec10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000ec20: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
+0000ec30: 5b27 6332 275d 2e73 7461 7475 732c 2070  ['c2'].status, p
+0000ec40: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+0000ec50: 732e 444f 574e 290a 2020 2020 2020 2020  s.DOWN).        
+0000ec60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000ec70: 2863 6865 636b 735b 2763 3227 5d2e 6661  (checks['c2'].fa
+0000ec80: 696c 7572 6573 2c20 3229 0a20 2020 2020  ilures, 2).     
+0000ec90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000eca0: 7561 6c28 6368 6563 6b73 5b27 6332 275d  ual(checks['c2']
+0000ecb0: 2e74 6872 6573 686f 6c64 2c20 3229 0a0a  .threshold, 2)..
+0000ecc0: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000ecd0: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000ece0: 7065 6e64 2872 6573 706f 6e73 655f 6368  pend(response_ch
+0000ecf0: 6563 6b73 5b31 3a32 5d29 0a20 2020 2020  ecks[1:2]).     
+0000ed00: 2020 2063 6865 636b 7320 3d20 7365 6c66     checks = self
+0000ed10: 2e63 6f6e 7461 696e 6572 2e67 6574 5f63  .container.get_c
+0000ed20: 6865 636b 7328 2763 3127 2c20 2763 3227  hecks('c1', 'c2'
+0000ed30: 2c20 6c65 7665 6c3d 7065 6262 6c65 2e43  , level=pebble.C
+0000ed40: 6865 636b 4c65 7665 6c2e 414c 4956 4529  heckLevel.ALIVE)
+0000ed50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000ed60: 7365 7274 4571 7561 6c28 6c65 6e28 6368  sertEqual(len(ch
+0000ed70: 6563 6b73 292c 2031 290a 2020 2020 2020  ecks), 1).      
+0000ed80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000ed90: 616c 2863 6865 636b 735b 2763 3227 5d2e  al(checks['c2'].
+0000eda0: 6e61 6d65 2c20 2763 3227 290a 2020 2020  name, 'c2').    
+0000edb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000edc0: 7175 616c 2863 6865 636b 735b 2763 3227  qual(checks['c2'
+0000edd0: 5d2e 6c65 7665 6c2c 2070 6562 626c 652e  ].level, pebble.
+0000ede0: 4368 6563 6b4c 6576 656c 2e41 4c49 5645  CheckLevel.ALIVE
+0000edf0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000ee00: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0000ee10: 735b 2763 3227 5d2e 7374 6174 7573 2c20  s['c2'].status, 
+0000ee20: 7065 6262 6c65 2e43 6865 636b 5374 6174  pebble.CheckStat
+0000ee30: 7573 2e44 4f57 4e29 0a20 2020 2020 2020  us.DOWN).       
+0000ee40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000ee50: 6c28 6368 6563 6b73 5b27 6332 275d 2e66  l(checks['c2'].f
+0000ee60: 6169 6c75 7265 732c 2032 290a 2020 2020  ailures, 2).    
+0000ee70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000ee80: 7175 616c 2863 6865 636b 735b 2763 3227  qual(checks['c2'
+0000ee90: 5d2e 7468 7265 7368 6f6c 642c 2032 290a  ].threshold, 2).
+0000eea0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000eeb0: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
+0000eec0: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
+0000eed0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+0000eee0: 6765 745f 6368 6563 6b73 272c 204e 6f6e  get_checks', Non
+0000eef0: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
+0000ef00: 2020 2020 2020 2827 6765 745f 6368 6563        ('get_chec
+0000ef10: 6b73 272c 2070 6562 626c 652e 4368 6563  ks', pebble.Chec
+0000ef20: 6b4c 6576 656c 2e41 4c49 5645 2c20 2827  kLevel.ALIVE, ('
+0000ef30: 6331 272c 2027 6332 2729 292c 0a20 2020  c1', 'c2')),.   
+0000ef40: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+0000ef50: 2074 6573 745f 6765 745f 6368 6563 6b28   test_get_check(
+0000ef60: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+0000ef70: 2053 696e 676c 6520 6368 6563 6b20 7265   Single check re
+0000ef80: 7475 726e 6564 2073 7563 6365 7373 6675  turned successfu
+0000ef90: 6c6c 790a 2020 2020 2020 2020 7365 6c66  lly.        self
+0000efa0: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
+0000efb0: 732e 6170 7065 6e64 285b 0a20 2020 2020  s.append([.     
+0000efc0: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
+0000efd0: 6563 6b49 6e66 6f2e 6672 6f6d 5f64 6963  eckInfo.from_dic
+0000efe0: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
+0000eff0: 2020 2020 276e 616d 6527 3a20 2763 3127      'name': 'c1'
+0000f000: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f010: 2020 2773 7461 7475 7327 3a20 2775 7027    'status': 'up'
+0000f020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f030: 2020 2766 6169 6c75 7265 7327 3a20 302c    'failures': 0,
+0000f040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f050: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
+0000f060: 0a20 2020 2020 2020 2020 2020 207d 290a  .            }).
+0000f070: 2020 2020 2020 2020 5d29 0a20 2020 2020          ]).     
+0000f080: 2020 2063 203d 2073 656c 662e 636f 6e74     c = self.cont
+0000f090: 6169 6e65 722e 6765 745f 6368 6563 6b28  ainer.get_check(
+0000f0a0: 2763 3127 290a 2020 2020 2020 2020 7365  'c1').        se
+0000f0b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000f0c0: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
+0000f0d0: 7374 732c 205b 2827 6765 745f 6368 6563  sts, [('get_chec
+0000f0e0: 6b73 272c 204e 6f6e 652c 2028 2763 3127  ks', None, ('c1'
+0000f0f0: 2c20 2929 5d29 0a20 2020 2020 2020 2073  , ))]).        s
+0000f100: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000f110: 632e 6e61 6d65 2c20 2763 3127 290a 2020  c.name, 'c1').  
+0000f120: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f130: 7445 7175 616c 2863 2e6c 6576 656c 2c20  tEqual(c.level, 
+0000f140: 7065 6262 6c65 2e43 6865 636b 4c65 7665  pebble.CheckLeve
+0000f150: 6c2e 554e 5345 5429 0a20 2020 2020 2020  l.UNSET).       
+0000f160: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f170: 6c28 632e 7374 6174 7573 2c20 7065 6262  l(c.status, pebb
+0000f180: 6c65 2e43 6865 636b 5374 6174 7573 2e55  le.CheckStatus.U
+0000f190: 5029 0a20 2020 2020 2020 2073 656c 662e  P).        self.
+0000f1a0: 6173 7365 7274 4571 7561 6c28 632e 6661  assertEqual(c.fa
+0000f1b0: 696c 7572 6573 2c20 3029 0a20 2020 2020  ilures, 0).     
+0000f1c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000f1d0: 7561 6c28 632e 7468 7265 7368 6f6c 642c  ual(c.threshold,
+0000f1e0: 2033 290a 0a20 2020 2020 2020 2023 2049   3)..        # I
+0000f1f0: 6620 5065 6262 6c65 2072 6574 7572 6e73  f Pebble returns
+0000f200: 206e 6f20 6368 6563 6b73 2c20 7368 6f75   no checks, shou
+0000f210: 6c64 2062 6520 6120 6f70 732e 4d6f 6465  ld be a ops.Mode
+0000f220: 6c45 7272 6f72 0a20 2020 2020 2020 2073  lError.        s
+0000f230: 656c 662e 7065 6262 6c65 2e72 6573 706f  elf.pebble.respo
+0000f240: 6e73 6573 2e61 7070 656e 6428 5b5d 290a  nses.append([]).
+0000f250: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0000f260: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+0000f270: 7073 2e4d 6f64 656c 4572 726f 7229 2061  ps.ModelError) a
+0000f280: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+0000f290: 2020 7365 6c66 2e63 6f6e 7461 696e 6572    self.container
+0000f2a0: 2e67 6574 5f63 6865 636b 2827 6332 2729  .get_check('c2')
+0000f2b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000f2c0: 7365 7274 4571 7561 6c28 7374 7228 636d  sertEqual(str(cm
+0000f2d0: 2e65 7863 6570 7469 6f6e 292c 2022 6368  .exception), "ch
+0000f2e0: 6563 6b20 2763 3227 206e 6f74 2066 6f75  eck 'c2' not fou
+0000f2f0: 6e64 2229 0a0a 2020 2020 2020 2020 2320  nd")..        # 
+0000f300: 4966 2050 6562 626c 6520 7265 7475 726e  If Pebble return
+0000f310: 7320 6d6f 7265 2074 6861 6e20 6f6e 6520  s more than one 
+0000f320: 6368 6563 6b2c 2052 756e 7469 6d65 4572  check, RuntimeEr
+0000f330: 726f 7220 6973 2072 6169 7365 640a 2020  ror is raised.  
+0000f340: 2020 2020 2020 7365 6c66 2e70 6562 626c        self.pebbl
+0000f350: 652e 7265 7370 6f6e 7365 732e 6170 7065  e.responses.appe
+0000f360: 6e64 285b 0a20 2020 2020 2020 2020 2020  nd([.           
+0000f370: 2070 6562 626c 652e 4368 6563 6b49 6e66   pebble.CheckInf
+0000f380: 6f2e 6672 6f6d 5f64 6963 7428 7b0a 2020  o.from_dict({.  
+0000f390: 2020 2020 2020 2020 2020 2020 2020 276e                'n
+0000f3a0: 616d 6527 3a20 2763 3127 2c0a 2020 2020  ame': 'c1',.    
+0000f3b0: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
+0000f3c0: 7475 7327 3a20 2775 7027 2c0a 2020 2020  tus': 'up',.    
+0000f3d0: 2020 2020 2020 2020 2020 2020 2766 6169              'fai
+0000f3e0: 6c75 7265 7327 3a20 302c 0a20 2020 2020  lures': 0,.     
+0000f3f0: 2020 2020 2020 2020 2020 2027 7468 7265             'thre
+0000f400: 7368 6f6c 6427 3a20 332c 0a20 2020 2020  shold': 3,.     
+0000f410: 2020 2020 2020 207d 292c 0a20 2020 2020         }),.     
+0000f420: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
+0000f430: 6563 6b49 6e66 6f2e 6672 6f6d 5f64 6963  eckInfo.from_dic
+0000f440: 7428 7b0a 2020 2020 2020 2020 2020 2020  t({.            
+0000f450: 2020 2020 276e 616d 6527 3a20 2763 3227      'name': 'c2'
+0000f460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f470: 2020 276c 6576 656c 273a 2027 616c 6976    'level': 'aliv
+0000f480: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+0000f490: 2020 2020 2773 7461 7475 7327 3a20 2764      'status': 'd
+0000f4a0: 6f77 6e27 2c0a 2020 2020 2020 2020 2020  own',.          
+0000f4b0: 2020 2020 2020 2766 6169 6c75 7265 7327        'failures'
+0000f4c0: 3a20 322c 0a20 2020 2020 2020 2020 2020  : 2,.           
+0000f4d0: 2020 2020 2027 7468 7265 7368 6f6c 6427       'threshold'
+0000f4e0: 3a20 322c 0a20 2020 2020 2020 2020 2020  : 2,.           
+0000f4f0: 207d 292c 0a20 2020 2020 2020 205d 290a   }),.        ]).
+0000f500: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0000f510: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
+0000f520: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
+0000f530: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0000f540: 6f6e 7461 696e 6572 2e67 6574 5f63 6865  ontainer.get_che
+0000f550: 636b 2827 6331 2729 0a0a 2020 2020 6465  ck('c1')..    de
+0000f560: 6620 7465 7374 5f70 756c 6c28 7365 6c66  f test_pull(self
+0000f570: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000f580: 7065 6262 6c65 2e72 6573 706f 6e73 6573  pebble.responses
+0000f590: 2e61 7070 656e 6428 2764 756d 6d79 3127  .append('dummy1'
+0000f5a0: 290a 2020 2020 2020 2020 676f 7420 3d20  ).        got = 
+0000f5b0: 7365 6c66 2e63 6f6e 7461 696e 6572 2e70  self.container.p
+0000f5c0: 756c 6c28 272f 7061 7468 2f31 2729 0a20  ull('/path/1'). 
+0000f5d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000f5e0: 7274 4571 7561 6c28 676f 742c 2027 6475  rtEqual(got, 'du
+0000f5f0: 6d6d 7931 2729 0a20 2020 2020 2020 2073  mmy1').        s
+0000f600: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000f610: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
+0000f620: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+0000f630: 2020 2020 2827 7075 6c6c 272c 2027 2f70      ('pull', '/p
+0000f640: 6174 682f 3127 2c20 2775 7466 2d38 2729  ath/1', 'utf-8')
+0000f650: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+0000f660: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000f670: 2e72 6571 7565 7374 7320 3d20 5b5d 0a0a  .requests = []..
+0000f680: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+0000f690: 626c 652e 7265 7370 6f6e 7365 732e 6170  ble.responses.ap
+0000f6a0: 7065 6e64 2862 2764 756d 6d79 3227 290a  pend(b'dummy2').
+0000f6b0: 2020 2020 2020 2020 676f 7420 3d20 7365          got = se
+0000f6c0: 6c66 2e63 6f6e 7461 696e 6572 2e70 756c  lf.container.pul
+0000f6d0: 6c28 272f 7061 7468 2f32 272c 2065 6e63  l('/path/2', enc
+0000f6e0: 6f64 696e 673d 4e6f 6e65 290a 2020 2020  oding=None).    
+0000f6f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000f700: 7175 616c 2867 6f74 2c20 6227 6475 6d6d  qual(got, b'dumm
+0000f710: 7932 2729 0a20 2020 2020 2020 2073 656c  y2').        sel
+0000f720: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000f730: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
+0000f740: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
+0000f750: 2020 2827 7075 6c6c 272c 2027 2f70 6174    ('pull', '/pat
+0000f760: 682f 3227 2c20 4e6f 6e65 292c 0a20 2020  h/2', None),.   
+0000f770: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+0000f780: 2074 6573 745f 7075 7368 2873 656c 6629   test_push(self)
+0000f790: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+0000f7a0: 6f6e 7461 696e 6572 2e70 7573 6828 272f  ontainer.push('/
+0000f7b0: 7061 7468 2f31 272c 2027 636f 6e74 656e  path/1', 'conten
+0000f7c0: 7431 2729 0a20 2020 2020 2020 2073 656c  t1').        sel
+0000f7d0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000f7e0: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
+0000f7f0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
+0000f800: 2020 2827 7075 7368 272c 2027 2f70 6174    ('push', '/pat
+0000f810: 682f 3127 2c20 2763 6f6e 7465 6e74 3127  h/1', 'content1'
+0000f820: 2c20 2775 7466 2d38 272c 2046 616c 7365  , 'utf-8', False
+0000f830: 2c20 4e6f 6e65 2c0a 2020 2020 2020 2020  , None,.        
+0000f840: 2020 2020 204e 6f6e 652c 204e 6f6e 652c       None, None,
+0000f850: 204e 6f6e 652c 204e 6f6e 6529 2c0a 2020   None, None),.  
+0000f860: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
+0000f870: 2073 656c 662e 7065 6262 6c65 2e72 6571   self.pebble.req
+0000f880: 7565 7374 7320 3d20 5b5d 0a0a 2020 2020  uests = []..    
+0000f890: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
+0000f8a0: 6572 2e70 7573 6828 272f 7061 7468 2f32  er.push('/path/2
+0000f8b0: 272c 2062 2763 6f6e 7465 6e74 3227 2c20  ', b'content2', 
+0000f8c0: 656e 636f 6469 6e67 3d4e 6f6e 652c 206d  encoding=None, m
+0000f8d0: 616b 655f 6469 7273 3d54 7275 652c 0a20  ake_dirs=True,. 
+0000f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f8f0: 2020 2020 2020 2020 2020 2070 6572 6d69             permi
+0000f900: 7373 696f 6e73 3d30 6f36 3030 2c20 7573  ssions=0o600, us
+0000f910: 6572 5f69 643d 3132 2c20 7573 6572 3d27  er_id=12, user='
+0000f920: 626f 6227 2c20 6772 6f75 705f 6964 3d33  bob', group_id=3
+0000f930: 342c 2067 726f 7570 3d27 7374 6166 6627  4, group='staff'
+0000f940: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000f950: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+0000f960: 7065 6262 6c65 2e72 6571 7565 7374 732c  pebble.requests,
+0000f970: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+0000f980: 2770 7573 6827 2c20 272f 7061 7468 2f32  'push', '/path/2
+0000f990: 272c 2062 2763 6f6e 7465 6e74 3227 2c20  ', b'content2', 
+0000f9a0: 4e6f 6e65 2c20 5472 7565 2c20 306f 3630  None, True, 0o60
+0000f9b0: 302c 2031 322c 2027 626f 6227 2c20 3334  0, 12, 'bob', 34
+0000f9c0: 2c20 2773 7461 6666 2729 2c0a 2020 2020  , 'staff'),.    
+0000f9d0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+0000f9e0: 7465 7374 5f6c 6973 745f 6669 6c65 7328  test_list_files(
+0000f9f0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0000fa00: 656c 662e 7065 6262 6c65 2e72 6573 706f  elf.pebble.respo
+0000fa10: 6e73 6573 2e61 7070 656e 6428 2764 756d  nses.append('dum
+0000fa20: 6d79 3127 290a 2020 2020 2020 2020 7265  my1').        re
+0000fa30: 7420 3d20 7365 6c66 2e63 6f6e 7461 696e  t = self.contain
+0000fa40: 6572 2e6c 6973 745f 6669 6c65 7328 272f  er.list_files('/
+0000fa50: 7061 7468 2f31 2729 0a20 2020 2020 2020  path/1').       
+0000fa60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000fa70: 6c28 7265 742c 2027 6475 6d6d 7931 2729  l(ret, 'dummy1')
+0000fa80: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000fa90: 7365 7274 4571 7561 6c28 7365 6c66 2e70  sertEqual(self.p
+0000faa0: 6562 626c 652e 7265 7175 6573 7473 2c20  ebble.requests, 
+0000fab0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+0000fac0: 6c69 7374 5f66 696c 6573 272c 2027 2f70  list_files', '/p
+0000fad0: 6174 682f 3127 2c20 4e6f 6e65 2c20 4661  ath/1', None, Fa
+0000fae0: 6c73 6529 2c0a 2020 2020 2020 2020 5d29  lse),.        ])
+0000faf0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+0000fb00: 6262 6c65 2e72 6571 7565 7374 7320 3d20  bble.requests = 
+0000fb10: 5b5d 0a0a 2020 2020 2020 2020 7365 6c66  []..        self
+0000fb20: 2e70 6562 626c 652e 7265 7370 6f6e 7365  .pebble.response
+0000fb30: 732e 6170 7065 6e64 2827 6475 6d6d 7932  s.append('dummy2
+0000fb40: 2729 0a20 2020 2020 2020 2072 6574 203d  ').        ret =
+0000fb50: 2073 656c 662e 636f 6e74 6169 6e65 722e   self.container.
+0000fb60: 6c69 7374 5f66 696c 6573 2827 2f70 6174  list_files('/pat
+0000fb70: 682f 3227 2c20 7061 7474 6572 6e3d 272a  h/2', pattern='*
+0000fb80: 2e74 7874 272c 2069 7473 656c 663d 5472  .txt', itself=Tr
+0000fb90: 7565 290a 2020 2020 2020 2020 7365 6c66  ue).        self
+0000fba0: 2e61 7373 6572 7445 7175 616c 2872 6574  .assertEqual(ret
+0000fbb0: 2c20 2764 756d 6d79 3227 290a 2020 2020  , 'dummy2').    
+0000fbc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000fbd0: 7175 616c 2873 656c 662e 7065 6262 6c65  qual(self.pebble
+0000fbe0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+0000fbf0: 2020 2020 2020 2020 2028 276c 6973 745f           ('list_
+0000fc00: 6669 6c65 7327 2c20 272f 7061 7468 2f32  files', '/path/2
+0000fc10: 272c 2027 2a2e 7478 7427 2c20 5472 7565  ', '*.txt', True
+0000fc20: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
+0000fc30: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
+0000fc40: 5f64 6972 2873 656c 6629 3a0a 2020 2020  _dir(self):.    
+0000fc50: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
+0000fc60: 6572 2e6d 616b 655f 6469 7228 272f 7061  er.make_dir('/pa
+0000fc70: 7468 2f31 2729 0a20 2020 2020 2020 2073  th/1').        s
+0000fc80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000fc90: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
+0000fca0: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+0000fcb0: 2020 2020 2827 6d61 6b65 5f64 6972 272c      ('make_dir',
+0000fcc0: 2027 2f70 6174 682f 3127 2c20 4661 6c73   '/path/1', Fals
+0000fcd0: 652c 204e 6f6e 652c 204e 6f6e 652c 204e  e, None, None, N
+0000fce0: 6f6e 652c 204e 6f6e 652c 204e 6f6e 6529  one, None, None)
+0000fcf0: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+0000fd00: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+0000fd10: 2e72 6571 7565 7374 7320 3d20 5b5d 0a0a  .requests = []..
+0000fd20: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0000fd30: 7461 696e 6572 2e6d 616b 655f 6469 7228  tainer.make_dir(
+0000fd40: 272f 7061 7468 2f32 272c 206d 616b 655f  '/path/2', make_
+0000fd50: 7061 7265 6e74 733d 5472 7565 2c20 7065  parents=True, pe
+0000fd60: 726d 6973 7369 6f6e 733d 306f 3730 302c  rmissions=0o700,
+0000fd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd90: 2075 7365 725f 6964 3d31 322c 2075 7365   user_id=12, use
+0000fda0: 723d 2762 6f62 272c 2067 726f 7570 5f69  r='bob', group_i
+0000fdb0: 643d 3334 2c20 6772 6f75 703d 2773 7461  d=34, group='sta
+0000fdc0: 6666 2729 0a20 2020 2020 2020 2073 656c  ff').        sel
+0000fdd0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000fde0: 6c66 2e70 6562 626c 652e 7265 7175 6573  lf.pebble.reques
+0000fdf0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
+0000fe00: 2020 2827 6d61 6b65 5f64 6972 272c 2027    ('make_dir', '
+0000fe10: 2f70 6174 682f 3227 2c20 5472 7565 2c20  /path/2', True, 
+0000fe20: 306f 3730 302c 2031 322c 2027 626f 6227  0o700, 12, 'bob'
+0000fe30: 2c20 3334 2c20 2773 7461 6666 2729 2c0a  , 34, 'staff'),.
+0000fe40: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0000fe50: 6465 6620 7465 7374 5f72 656d 6f76 655f  def test_remove_
+0000fe60: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
+0000fe70: 2020 2020 7365 6c66 2e63 6f6e 7461 696e      self.contain
+0000fe80: 6572 2e72 656d 6f76 655f 7061 7468 2827  er.remove_path('
+0000fe90: 2f70 6174 682f 3127 290a 2020 2020 2020  /path/1').      
+0000fea0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000feb0: 616c 2873 656c 662e 7065 6262 6c65 2e72  al(self.pebble.r
+0000fec0: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+0000fed0: 2020 2020 2020 2028 2772 656d 6f76 655f         ('remove_
+0000fee0: 7061 7468 272c 2027 2f70 6174 682f 3127  path', '/path/1'
+0000fef0: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
+0000ff00: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
+0000ff10: 662e 7065 6262 6c65 2e72 6571 7565 7374  f.pebble.request
+0000ff20: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
+0000ff30: 7365 6c66 2e63 6f6e 7461 696e 6572 2e72  self.container.r
+0000ff40: 656d 6f76 655f 7061 7468 2827 2f70 6174  emove_path('/pat
+0000ff50: 682f 3227 2c20 7265 6375 7273 6976 653d  h/2', recursive=
+0000ff60: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
+0000ff70: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000ff80: 656c 662e 7065 6262 6c65 2e72 6571 7565  elf.pebble.reque
+0000ff90: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000ffa0: 2020 2028 2772 656d 6f76 655f 7061 7468     ('remove_path
+0000ffb0: 272c 2027 2f70 6174 682f 3227 2c20 5472  ', '/path/2', Tr
+0000ffc0: 7565 292c 0a20 2020 2020 2020 205d 290a  ue),.        ]).
+0000ffd0: 0a20 2020 2064 6566 2074 6573 745f 6361  .    def test_ca
+0000ffe0: 6e5f 636f 6e6e 6563 745f 7369 6d70 6c65  n_connect_simple
+0000fff0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00010000: 7365 6c66 2e70 6562 626c 652e 7265 7370  self.pebble.resp
+00010010: 6f6e 7365 732e 6170 7065 6e64 2870 6562  onses.append(peb
+00010020: 626c 652e 5379 7374 656d 496e 666f 2e66  ble.SystemInfo.f
+00010030: 726f 6d5f 6469 6374 287b 2776 6572 7369  rom_dict({'versi
+00010040: 6f6e 273a 2027 312e 302e 3027 7d29 290a  on': '1.0.0'})).
+00010050: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010060: 6572 7454 7275 6528 7365 6c66 2e63 6f6e  ertTrue(self.con
+00010070: 7461 696e 6572 2e63 616e 5f63 6f6e 6e65  tainer.can_conne
+00010080: 6374 2829 290a 0a20 2020 2064 6566 2074  ct())..    def t
+00010090: 6573 745f 6361 6e5f 636f 6e6e 6563 745f  est_can_connect_
+000100a0: 636f 6e6e 6563 7469 6f6e 5f65 7272 6f72  connection_error
+000100b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000100c0: 6465 6620 7261 6973 655f 6572 726f 7228  def raise_error(
+000100d0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000100e0: 6169 7365 2070 6562 626c 652e 436f 6e6e  aise pebble.Conn
+000100f0: 6563 7469 6f6e 4572 726f 7228 2763 6f6e  ectionError('con
+00010100: 6e65 6374 696f 6e20 6572 726f 7221 2729  nection error!')
+00010110: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+00010120: 6262 6c65 2e67 6574 5f73 7973 7465 6d5f  bble.get_system_
+00010130: 696e 666f 203d 2072 6169 7365 5f65 7272  info = raise_err
+00010140: 6f72 0a20 2020 2020 2020 2077 6974 6820  or.        with 
+00010150: 7365 6c66 2e61 7373 6572 744c 6f67 7328  self.assertLogs(
+00010160: 276f 7073 272c 206c 6576 656c 3d27 4445  'ops', level='DE
+00010170: 4255 4727 2920 6173 2063 6d3a 0a20 2020  BUG') as cm:.   
+00010180: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00010190: 7365 7274 4661 6c73 6528 7365 6c66 2e63  sertFalse(self.c
+000101a0: 6f6e 7461 696e 6572 2e63 616e 5f63 6f6e  ontainer.can_con
+000101b0: 6e65 6374 2829 290a 2020 2020 2020 2020  nect()).        
+000101c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000101d0: 286c 656e 2863 6d2e 6f75 7470 7574 292c  (len(cm.output),
+000101e0: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
+000101f0: 2e61 7373 6572 7452 6567 6578 2863 6d2e  .assertRegex(cm.
+00010200: 6f75 7470 7574 5b30 5d2c 2072 2744 4542  output[0], r'DEB
+00010210: 5547 3a6f 7073 2e6d 6f64 656c 3a2e 2a3a  UG:ops.model:.*:
+00010220: 2063 6f6e 6e65 6374 696f 6e20 6572 726f   connection erro
+00010230: 7221 2729 0a0a 2020 2020 6465 6620 7465  r!')..    def te
+00010240: 7374 5f63 616e 5f63 6f6e 6e65 6374 5f66  st_can_connect_f
+00010250: 696c 655f 6e6f 745f 666f 756e 645f 6572  ile_not_found_er
+00010260: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+00010270: 2020 2064 6566 2072 6169 7365 5f65 7272     def raise_err
+00010280: 6f72 2829 3a0a 2020 2020 2020 2020 2020  or():.          
+00010290: 2020 7261 6973 6520 4669 6c65 4e6f 7446    raise FileNotF
+000102a0: 6f75 6e64 4572 726f 7228 2766 696c 6520  oundError('file 
+000102b0: 6e6f 7420 666f 756e 6421 2729 0a20 2020  not found!').   
+000102c0: 2020 2020 2073 656c 662e 7065 6262 6c65       self.pebble
+000102d0: 2e67 6574 5f73 7973 7465 6d5f 696e 666f  .get_system_info
+000102e0: 203d 2072 6169 7365 5f65 7272 6f72 0a20   = raise_error. 
+000102f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00010300: 2e61 7373 6572 744c 6f67 7328 276f 7073  .assertLogs('ops
+00010310: 272c 206c 6576 656c 3d27 4445 4255 4727  ', level='DEBUG'
+00010320: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00010330: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010340: 4661 6c73 6528 7365 6c66 2e63 6f6e 7461  False(self.conta
+00010350: 696e 6572 2e63 616e 5f63 6f6e 6e65 6374  iner.can_connect
+00010360: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
+00010370: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00010380: 2863 6d2e 6f75 7470 7574 292c 2031 290a  (cm.output), 1).
+00010390: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000103a0: 6572 7452 6567 6578 2863 6d2e 6f75 7470  ertRegex(cm.outp
+000103b0: 7574 5b30 5d2c 2072 2744 4542 5547 3a6f  ut[0], r'DEBUG:o
+000103c0: 7073 2e6d 6f64 656c 3a2e 2a3a 2066 696c  ps.model:.*: fil
+000103d0: 6520 6e6f 7420 666f 756e 6421 2729 0a0a  e not found!')..
+000103e0: 2020 2020 6465 6620 7465 7374 5f63 616e      def test_can
+000103f0: 5f63 6f6e 6e65 6374 5f61 7069 5f65 7272  _connect_api_err
+00010400: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
+00010410: 2020 6465 6620 7261 6973 655f 6572 726f    def raise_erro
+00010420: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
+00010430: 2072 6169 7365 2070 6562 626c 652e 4150   raise pebble.AP
+00010440: 4945 7272 6f72 2827 626f 6479 272c 2034  IError('body', 4
+00010450: 3034 2c20 2773 7461 7475 7327 2c20 2761  04, 'status', 'a
+00010460: 7069 2065 7272 6f72 2127 290a 2020 2020  pi error!').    
+00010470: 2020 2020 7365 6c66 2e70 6562 626c 652e      self.pebble.
+00010480: 6765 745f 7379 7374 656d 5f69 6e66 6f20  get_system_info 
+00010490: 3d20 7261 6973 655f 6572 726f 720a 2020  = raise_error.  
+000104a0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000104b0: 6173 7365 7274 4c6f 6773 2827 6f70 7327  assertLogs('ops'
+000104c0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+000104d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000104e0: 4661 6c73 6528 7365 6c66 2e63 6f6e 7461  False(self.conta
+000104f0: 696e 6572 2e63 616e 5f63 6f6e 6e65 6374  iner.can_connect
+00010500: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
+00010510: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00010520: 2863 6d2e 6f75 7470 7574 292c 2031 290a  (cm.output), 1).
+00010530: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00010540: 6572 7452 6567 6578 2863 6d2e 6f75 7470  ertRegex(cm.outp
+00010550: 7574 5b30 5d2c 2072 2757 4152 4e49 4e47  ut[0], r'WARNING
+00010560: 3a6f 7073 2e6d 6f64 656c 3a2e 2a3a 2061  :ops.model:.*: a
+00010570: 7069 2065 7272 6f72 2127 290a 0a20 2020  pi error!')..   
+00010580: 2064 6566 2074 6573 745f 6578 6563 2873   def test_exec(s
+00010590: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+000105a0: 6c66 2e70 6562 626c 652e 7265 7370 6f6e  lf.pebble.respon
+000105b0: 7365 732e 6170 7065 6e64 2827 6661 6b65  ses.append('fake
+000105c0: 5f65 7865 635f 7072 6f63 6573 7327 290a  _exec_process').
+000105d0: 2020 2020 2020 2020 7020 3d20 7365 6c66          p = self
+000105e0: 2e63 6f6e 7461 696e 6572 2e65 7865 6328  .container.exec(
+000105f0: 0a20 2020 2020 2020 2020 2020 205b 2765  .            ['e
+00010600: 6368 6f27 2c20 2766 6f6f 275d 2c0a 2020  cho', 'foo'],.  
+00010610: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
+00010620: 6e6d 656e 743d 7b27 4b31 273a 2027 5631  nment={'K1': 'V1
+00010630: 272c 2027 4b32 273a 2027 5632 277d 2c0a  ', 'K2': 'V2'},.
+00010640: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00010650: 696e 675f 6469 723d 2757 4427 2c0a 2020  ing_dir='WD',.  
+00010660: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
+00010670: 743d 3130 2e35 2c0a 2020 2020 2020 2020  t=10.5,.        
+00010680: 2020 2020 7573 6572 5f69 643d 3130 3030      user_id=1000
+00010690: 2c0a 2020 2020 2020 2020 2020 2020 7573  ,.            us
+000106a0: 6572 3d27 626f 6227 2c0a 2020 2020 2020  er='bob',.      
+000106b0: 2020 2020 2020 6772 6f75 705f 6964 3d31        group_id=1
+000106c0: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
+000106d0: 2067 726f 7570 3d27 7374 6166 6627 2c0a   group='staff',.
+000106e0: 2020 2020 2020 2020 2020 2020 7374 6469              stdi
+000106f0: 6e3d 2753 5444 494e 272c 0a20 2020 2020  n='STDIN',.     
+00010700: 2020 2020 2020 2073 7464 6f75 743d 2753         stdout='S
+00010710: 5444 4f55 5427 2c0a 2020 2020 2020 2020  TDOUT',.        
+00010720: 2020 2020 7374 6465 7272 3d27 5354 4445      stderr='STDE
+00010730: 5252 272c 0a20 2020 2020 2020 2020 2020  RR',.           
+00010740: 2065 6e63 6f64 696e 673d 4e6f 6e65 2c0a   encoding=None,.
+00010750: 2020 2020 2020 2020 2020 2020 636f 6d62              comb
+00010760: 696e 655f 7374 6465 7272 3d54 7275 652c  ine_stderr=True,
+00010770: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00010780: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00010790: 7561 6c28 7365 6c66 2e70 6562 626c 652e  ual(self.pebble.
+000107a0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
+000107b0: 2020 2020 2020 2020 2827 6578 6563 272c          ('exec',
+000107c0: 205b 2765 6368 6f27 2c20 2766 6f6f 275d   ['echo', 'foo']
+000107d0: 2c20 6469 6374 280a 2020 2020 2020 2020  , dict(.        
+000107e0: 2020 2020 2020 2020 656e 7669 726f 6e6d          environm
+000107f0: 656e 743d 7b27 4b31 273a 2027 5631 272c  ent={'K1': 'V1',
+00010800: 2027 4b32 273a 2027 5632 277d 2c0a 2020   'K2': 'V2'},.  
+00010810: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+00010820: 726b 696e 675f 6469 723d 2757 4427 2c0a  rking_dir='WD',.
+00010830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010840: 7469 6d65 6f75 743d 3130 2e35 2c0a 2020  timeout=10.5,.  
+00010850: 2020 2020 2020 2020 2020 2020 2020 7573                us
+00010860: 6572 5f69 643d 3130 3030 2c0a 2020 2020  er_id=1000,.    
+00010870: 2020 2020 2020 2020 2020 2020 7573 6572              user
+00010880: 3d27 626f 6227 2c0a 2020 2020 2020 2020  ='bob',.        
+00010890: 2020 2020 2020 2020 6772 6f75 705f 6964          group_id
+000108a0: 3d31 3030 302c 0a20 2020 2020 2020 2020  =1000,.         
+000108b0: 2020 2020 2020 2067 726f 7570 3d27 7374         group='st
+000108c0: 6166 6627 2c0a 2020 2020 2020 2020 2020  aff',.          
+000108d0: 2020 2020 2020 7374 6469 6e3d 2753 5444        stdin='STD
+000108e0: 494e 272c 0a20 2020 2020 2020 2020 2020  IN',.           
+000108f0: 2020 2020 2073 7464 6f75 743d 2753 5444       stdout='STD
+00010900: 4f55 5427 2c0a 2020 2020 2020 2020 2020  OUT',.          
+00010910: 2020 2020 2020 7374 6465 7272 3d27 5354        stderr='ST
+00010920: 4445 5252 272c 0a20 2020 2020 2020 2020  DERR',.         
+00010930: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+00010940: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00010950: 2020 2020 2020 636f 6d62 696e 655f 7374        combine_st
+00010960: 6465 7272 3d54 7275 652c 0a20 2020 2020  derr=True,.     
+00010970: 2020 2020 2020 2029 290a 2020 2020 2020         )).      
+00010980: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
+00010990: 662e 6173 7365 7274 4571 7561 6c28 702c  f.assertEqual(p,
+000109a0: 2027 6661 6b65 5f65 7865 635f 7072 6f63   'fake_exec_proc
+000109b0: 6573 7327 290a 0a20 2020 2064 6566 2074  ess')..    def t
+000109c0: 6573 745f 7365 6e64 5f73 6967 6e61 6c28  est_send_signal(
+000109d0: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
+000109e0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+000109f0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+00010a00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00010a10: 6c66 2e63 6f6e 7461 696e 6572 2e73 656e  lf.container.sen
+00010a20: 645f 7369 676e 616c 2827 5349 4748 5550  d_signal('SIGHUP
+00010a30: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+00010a40: 2e63 6f6e 7461 696e 6572 2e73 656e 645f  .container.send_
+00010a50: 7369 676e 616c 2827 5349 4748 5550 272c  signal('SIGHUP',
+00010a60: 2027 7331 2729 0a20 2020 2020 2020 2073   's1').        s
+00010a70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010a80: 7365 6c66 2e70 6562 626c 652e 7265 7175  self.pebble.requ
+00010a90: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+00010aa0: 2020 2020 2827 7365 6e64 5f73 6967 6e61      ('send_signa
+00010ab0: 6c27 2c20 2753 4947 4855 5027 2c20 2827  l', 'SIGHUP', ('
+00010ac0: 7331 272c 2929 2c0a 2020 2020 2020 2020  s1',)),.        
+00010ad0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00010ae0: 7065 6262 6c65 2e72 6571 7565 7374 7320  pebble.requests 
+00010af0: 3d20 5b5d 0a0a 2020 2020 2020 2020 7365  = []..        se
+00010b00: 6c66 2e63 6f6e 7461 696e 6572 2e73 656e  lf.container.sen
+00010b10: 645f 7369 676e 616c 2827 5349 4748 5550  d_signal('SIGHUP
+00010b20: 272c 2027 7331 272c 2027 7332 2729 0a20  ', 's1', 's2'). 
+00010b30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00010b40: 7274 4571 7561 6c28 7365 6c66 2e70 6562  rtEqual(self.peb
+00010b50: 626c 652e 7265 7175 6573 7473 2c20 5b0a  ble.requests, [.
+00010b60: 2020 2020 2020 2020 2020 2020 2827 7365              ('se
+00010b70: 6e64 5f73 6967 6e61 6c27 2c20 2753 4947  nd_signal', 'SIG
+00010b80: 4855 5027 2c20 2827 7331 272c 2027 7332  HUP', ('s1', 's2
+00010b90: 2729 292c 0a20 2020 2020 2020 205d 290a  ')),.        ]).
+00010ba0: 2020 2020 2020 2020 7365 6c66 2e70 6562          self.peb
+00010bb0: 626c 652e 7265 7175 6573 7473 203d 205b  ble.requests = [
+00010bc0: 5d0a 0a0a 636c 6173 7320 4d6f 636b 5065  ]...class MockPe
+00010bd0: 6262 6c65 4261 636b 656e 6428 5f4d 6f64  bbleBackend(_Mod
+00010be0: 656c 4261 636b 656e 6429 3a0a 2020 2020  elBackend):.    
+00010bf0: 6465 6620 6765 745f 7065 6262 6c65 2873  def get_pebble(s
+00010c00: 656c 662c 2073 6f63 6b65 745f 7061 7468  elf, socket_path
+00010c10: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00010c20: 6e20 4d6f 636b 5065 6262 6c65 436c 6965  n MockPebbleClie
+00010c30: 6e74 2873 6f63 6b65 745f 7061 7468 290a  nt(socket_path).
+00010c40: 0a0a 636c 6173 7320 4d6f 636b 5065 6262  ..class MockPebb
+00010c50: 6c65 436c 6965 6e74 3a0a 2020 2020 6465  leClient:.    de
+00010c60: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00010c70: 2073 6f63 6b65 745f 7061 7468 293a 0a20   socket_path):. 
+00010c80: 2020 2020 2020 2073 656c 662e 736f 636b         self.sock
+00010c90: 6574 5f70 6174 6820 3d20 736f 636b 6574  et_path = socket
+00010ca0: 5f70 6174 680a 2020 2020 2020 2020 7365  _path.        se
+00010cb0: 6c66 2e72 6571 7565 7374 7320 3d20 5b5d  lf.requests = []
+00010cc0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00010cd0: 7370 6f6e 7365 7320 3d20 5b5d 0a0a 2020  sponses = []..  
+00010ce0: 2020 6465 6620 6175 746f 7374 6172 745f    def autostart_
+00010cf0: 7365 7276 6963 6573 2873 656c 6629 3a0a  services(self):.
+00010d00: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
+00010d10: 7565 7374 732e 6170 7065 6e64 2828 2761  uests.append(('a
+00010d20: 7574 6f73 7461 7274 272c 2929 0a0a 2020  utostart',))..  
+00010d30: 2020 6465 6620 6765 745f 7379 7374 656d    def get_system
+00010d40: 5f69 6e66 6f28 7365 6c66 293a 0a20 2020  _info(self):.   
+00010d50: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+00010d60: 7473 2e61 7070 656e 6428 2827 6765 745f  ts.append(('get_
+00010d70: 7379 7374 656d 5f69 6e66 6f27 2c29 290a  system_info',)).
+00010d80: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00010d90: 656c 662e 7265 7370 6f6e 7365 732e 706f  elf.responses.po
+00010da0: 7028 3029 0a0a 2020 2020 6465 6620 7265  p(0)..    def re
+00010db0: 706c 616e 5f73 6572 7669 6365 7328 7365  plan_services(se
+00010dc0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00010dd0: 662e 7265 7175 6573 7473 2e61 7070 656e  f.requests.appen
+00010de0: 6428 2827 7265 706c 616e 272c 2929 0a0a  d(('replan',))..
+00010df0: 2020 2020 6465 6620 7374 6172 745f 7365      def start_se
+00010e00: 7276 6963 6573 2873 656c 662c 2073 6572  rvices(self, ser
+00010e10: 7669 6365 5f6e 616d 6573 293a 0a20 2020  vice_names):.   
+00010e20: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+00010e30: 7473 2e61 7070 656e 6428 2827 7374 6172  ts.append(('star
+00010e40: 7427 2c20 7365 7276 6963 655f 6e61 6d65  t', service_name
+00010e50: 7329 290a 0a20 2020 2064 6566 2073 746f  s))..    def sto
+00010e60: 705f 7365 7276 6963 6573 2873 656c 662c  p_services(self,
+00010e70: 2073 6572 7669 6365 5f6e 616d 6573 293a   service_names):
+00010e80: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00010e90: 7175 6573 7473 2e61 7070 656e 6428 2827  quests.append(('
+00010ea0: 7374 6f70 272c 2073 6572 7669 6365 5f6e  stop', service_n
+00010eb0: 616d 6573 2929 0a0a 2020 2020 6465 6620  ames))..    def 
+00010ec0: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
+00010ed0: 2873 656c 662c 2073 6572 7669 6365 5f6e  (self, service_n
+00010ee0: 616d 6573 293a 0a20 2020 2020 2020 2073  ames):.        s
+00010ef0: 656c 662e 7265 7175 6573 7473 2e61 7070  elf.requests.app
+00010f00: 656e 6428 2827 7265 7374 6172 7427 2c20  end(('restart', 
+00010f10: 7365 7276 6963 655f 6e61 6d65 7329 290a  service_names)).
+00010f20: 0a20 2020 2064 6566 2061 6464 5f6c 6179  .    def add_lay
+00010f30: 6572 2873 656c 662c 206c 6162 656c 2c20  er(self, label, 
+00010f40: 6c61 7965 722c 2063 6f6d 6269 6e65 3d46  layer, combine=F
+00010f50: 616c 7365 293a 0a20 2020 2020 2020 2069  alse):.        i
+00010f60: 6620 6973 696e 7374 616e 6365 286c 6179  f isinstance(lay
+00010f70: 6572 2c20 6469 6374 293a 0a20 2020 2020  er, dict):.     
+00010f80: 2020 2020 2020 206c 6179 6572 203d 2070         layer = p
+00010f90: 6562 626c 652e 4c61 7965 7228 6c61 7965  ebble.Layer(laye
+00010fa0: 7229 2e74 6f5f 7961 6d6c 2829 0a20 2020  r).to_yaml().   
+00010fb0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00010fc0: 616e 6365 286c 6179 6572 2c20 7065 6262  ance(layer, pebb
+00010fd0: 6c65 2e4c 6179 6572 293a 0a20 2020 2020  le.Layer):.     
+00010fe0: 2020 2020 2020 206c 6179 6572 203d 206c         layer = l
+00010ff0: 6179 6572 2e74 6f5f 7961 6d6c 2829 0a20  ayer.to_yaml(). 
+00011000: 2020 2020 2020 2073 656c 662e 7265 7175         self.requ
+00011010: 6573 7473 2e61 7070 656e 6428 2827 6164  ests.append(('ad
+00011020: 645f 6c61 7965 7227 2c20 6c61 6265 6c2c  d_layer', label,
+00011030: 206c 6179 6572 2c20 636f 6d62 696e 6529   layer, combine)
+00011040: 290a 0a20 2020 2064 6566 2067 6574 5f70  )..    def get_p
+00011050: 6c61 6e28 7365 6c66 293a 0a20 2020 2020  lan(self):.     
+00011060: 2020 2073 656c 662e 7265 7175 6573 7473     self.requests
+00011070: 2e61 7070 656e 6428 2827 6765 745f 706c  .append(('get_pl
+00011080: 616e 272c 2929 0a20 2020 2020 2020 2072  an',)).        r
+00011090: 6574 7572 6e20 7365 6c66 2e72 6573 706f  eturn self.respo
+000110a0: 6e73 6573 2e70 6f70 2830 290a 0a20 2020  nses.pop(0)..   
+000110b0: 2064 6566 2067 6574 5f73 6572 7669 6365   def get_service
+000110c0: 7328 7365 6c66 2c20 6e61 6d65 733d 4e6f  s(self, names=No
+000110d0: 6e65 293a 0a20 2020 2020 2020 2073 656c  ne):.        sel
+000110e0: 662e 7265 7175 6573 7473 2e61 7070 656e  f.requests.appen
+000110f0: 6428 2827 6765 745f 7365 7276 6963 6573  d(('get_services
+00011100: 272c 206e 616d 6573 2929 0a20 2020 2020  ', names)).     
+00011110: 2020 2072 6574 7572 6e20 7365 6c66 2e72     return self.r
+00011120: 6573 706f 6e73 6573 2e70 6f70 2830 290a  esponses.pop(0).
+00011130: 0a20 2020 2064 6566 2067 6574 5f63 6865  .    def get_che
+00011140: 636b 7328 7365 6c66 2c20 6c65 7665 6c3d  cks(self, level=
+00011150: 4e6f 6e65 2c20 6e61 6d65 733d 4e6f 6e65  None, names=None
+00011160: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00011170: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
+00011180: 2827 6765 745f 6368 6563 6b73 272c 206c  ('get_checks', l
+00011190: 6576 656c 2c20 6e61 6d65 7329 290a 2020  evel, names)).  
+000111a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000111b0: 662e 7265 7370 6f6e 7365 732e 706f 7028  f.responses.pop(
+000111c0: 3029 0a0a 2020 2020 6465 6620 7075 6c6c  0)..    def pull
+000111d0: 2873 656c 662c 2070 6174 682c 202a 2c20  (self, path, *, 
+000111e0: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
+000111f0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00011200: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
+00011210: 2827 7075 6c6c 272c 2070 6174 682c 2065  ('pull', path, e
+00011220: 6e63 6f64 696e 6729 290a 2020 2020 2020  ncoding)).      
+00011230: 2020 7265 7475 726e 2073 656c 662e 7265    return self.re
+00011240: 7370 6f6e 7365 732e 706f 7028 3029 0a0a  sponses.pop(0)..
+00011250: 2020 2020 6465 6620 7075 7368 2873 656c      def push(sel
+00011260: 662c 2070 6174 682c 2073 6f75 7263 652c  f, path, source,
+00011270: 202a 2c20 656e 636f 6469 6e67 3d27 7574   *, encoding='ut
+00011280: 662d 3827 2c20 6d61 6b65 5f64 6972 733d  f-8', make_dirs=
+00011290: 4661 6c73 652c 2070 6572 6d69 7373 696f  False, permissio
+000112a0: 6e73 3d4e 6f6e 652c 0a20 2020 2020 2020  ns=None,.       
+000112b0: 2020 2020 2020 7573 6572 5f69 643d 4e6f        user_id=No
+000112c0: 6e65 2c20 7573 6572 3d4e 6f6e 652c 2067  ne, user=None, g
+000112d0: 726f 7570 5f69 643d 4e6f 6e65 2c20 6772  roup_id=None, gr
+000112e0: 6f75 703d 4e6f 6e65 293a 0a20 2020 2020  oup=None):.     
+000112f0: 2020 2073 656c 662e 7265 7175 6573 7473     self.requests
+00011300: 2e61 7070 656e 6428 2827 7075 7368 272c  .append(('push',
+00011310: 2070 6174 682c 2073 6f75 7263 652c 2065   path, source, e
+00011320: 6e63 6f64 696e 672c 206d 616b 655f 6469  ncoding, make_di
+00011330: 7273 2c20 7065 726d 6973 7369 6f6e 732c  rs, permissions,
+00011340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011350: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00011360: 7365 725f 6964 2c20 7573 6572 2c20 6772  ser_id, user, gr
+00011370: 6f75 705f 6964 2c20 6772 6f75 7029 290a  oup_id, group)).
+00011380: 0a20 2020 2064 6566 206c 6973 745f 6669  .    def list_fi
+00011390: 6c65 7328 7365 6c66 2c20 7061 7468 2c20  les(self, path, 
+000113a0: 2a2c 2070 6174 7465 726e 3d4e 6f6e 652c  *, pattern=None,
+000113b0: 2069 7473 656c 663d 4661 6c73 6529 3a0a   itself=False):.
+000113c0: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
+000113d0: 7565 7374 732e 6170 7065 6e64 2828 276c  uests.append(('l
+000113e0: 6973 745f 6669 6c65 7327 2c20 7061 7468  ist_files', path
+000113f0: 2c20 7061 7474 6572 6e2c 2069 7473 656c  , pattern, itsel
+00011400: 6629 290a 2020 2020 2020 2020 7265 7475  f)).        retu
+00011410: 726e 2073 656c 662e 7265 7370 6f6e 7365  rn self.response
+00011420: 732e 706f 7028 3029 0a0a 2020 2020 6465  s.pop(0)..    de
+00011430: 6620 6d61 6b65 5f64 6972 2873 656c 662c  f make_dir(self,
+00011440: 2070 6174 682c 202a 2c20 6d61 6b65 5f70   path, *, make_p
+00011450: 6172 656e 7473 3d46 616c 7365 2c20 7065  arents=False, pe
+00011460: 726d 6973 7369 6f6e 733d 4e6f 6e65 2c20  rmissions=None, 
+00011470: 7573 6572 5f69 643d 4e6f 6e65 2c20 7573  user_id=None, us
+00011480: 6572 3d4e 6f6e 652c 0a20 2020 2020 2020  er=None,.       
+00011490: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
+000114a0: 6964 3d4e 6f6e 652c 2067 726f 7570 3d4e  id=None, group=N
+000114b0: 6f6e 6529 3a0a 2020 2020 2020 2020 7365  one):.        se
 000114c0: 6c66 2e72 6571 7565 7374 732e 6170 7065  lf.requests.appe
-000114d0: 6e64 2828 2770 756c 6c27 2c20 7061 7468  nd(('pull', path
-000114e0: 2c20 656e 636f 6469 6e67 2929 0a20 2020  , encoding)).   
-000114f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00011500: 2e72 6573 706f 6e73 6573 2e70 6f70 2830  .responses.pop(0
-00011510: 290a 0a20 2020 2064 6566 2070 7573 6828  )..    def push(
-00011520: 7365 6c66 2c20 7061 7468 2c20 736f 7572  self, path, sour
-00011530: 6365 2c20 2a2c 2065 6e63 6f64 696e 673d  ce, *, encoding=
-00011540: 2775 7466 2d38 272c 206d 616b 655f 6469  'utf-8', make_di
-00011550: 7273 3d46 616c 7365 2c20 7065 726d 6973  rs=False, permis
-00011560: 7369 6f6e 733d 4e6f 6e65 2c0a 2020 2020  sions=None,.    
-00011570: 2020 2020 2020 2020 2075 7365 725f 6964           user_id
-00011580: 3d4e 6f6e 652c 2075 7365 723d 4e6f 6e65  =None, user=None
-00011590: 2c20 6772 6f75 705f 6964 3d4e 6f6e 652c  , group_id=None,
-000115a0: 2067 726f 7570 3d4e 6f6e 6529 3a0a 2020   group=None):.  
-000115b0: 2020 2020 2020 7365 6c66 2e72 6571 7565        self.reque
-000115c0: 7374 732e 6170 7065 6e64 2828 2770 7573  sts.append(('pus
-000115d0: 6827 2c20 7061 7468 2c20 736f 7572 6365  h', path, source
-000115e0: 2c20 656e 636f 6469 6e67 2c20 6d61 6b65  , encoding, make
-000115f0: 5f64 6972 732c 2070 6572 6d69 7373 696f  _dirs, permissio
-00011600: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-00011610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011620: 2020 7573 6572 5f69 642c 2075 7365 722c    user_id, user,
-00011630: 2067 726f 7570 5f69 642c 2067 726f 7570   group_id, group
-00011640: 2929 0a0a 2020 2020 6465 6620 6c69 7374  ))..    def list
-00011650: 5f66 696c 6573 2873 656c 662c 2070 6174  _files(self, pat
-00011660: 682c 202a 2c20 7061 7474 6572 6e3d 4e6f  h, *, pattern=No
-00011670: 6e65 2c20 6974 7365 6c66 3d46 616c 7365  ne, itself=False
-00011680: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00011690: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
-000116a0: 2827 6c69 7374 5f66 696c 6573 272c 2070  ('list_files', p
-000116b0: 6174 682c 2070 6174 7465 726e 2c20 6974  ath, pattern, it
-000116c0: 7365 6c66 2929 0a20 2020 2020 2020 2072  self)).        r
-000116d0: 6574 7572 6e20 7365 6c66 2e72 6573 706f  eturn self.respo
-000116e0: 6e73 6573 2e70 6f70 2830 290a 0a20 2020  nses.pop(0)..   
-000116f0: 2064 6566 206d 616b 655f 6469 7228 7365   def make_dir(se
-00011700: 6c66 2c20 7061 7468 2c20 2a2c 206d 616b  lf, path, *, mak
-00011710: 655f 7061 7265 6e74 733d 4661 6c73 652c  e_parents=False,
-00011720: 2070 6572 6d69 7373 696f 6e73 3d4e 6f6e   permissions=Non
-00011730: 652c 2075 7365 725f 6964 3d4e 6f6e 652c  e, user_id=None,
-00011740: 2075 7365 723d 4e6f 6e65 2c0a 2020 2020   user=None,.    
-00011750: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00011760: 7570 5f69 643d 4e6f 6e65 2c20 6772 6f75  up_id=None, grou
-00011770: 703d 4e6f 6e65 293a 0a20 2020 2020 2020  p=None):.       
-00011780: 2073 656c 662e 7265 7175 6573 7473 2e61   self.requests.a
-00011790: 7070 656e 6428 2827 6d61 6b65 5f64 6972  ppend(('make_dir
-000117a0: 272c 2070 6174 682c 206d 616b 655f 7061  ', path, make_pa
-000117b0: 7265 6e74 732c 2070 6572 6d69 7373 696f  rents, permissio
-000117c0: 6e73 2c20 7573 6572 5f69 642c 2075 7365  ns, user_id, use
-000117d0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-000117e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117f0: 2067 726f 7570 5f69 642c 2067 726f 7570   group_id, group
-00011800: 2929 0a0a 2020 2020 6465 6620 7265 6d6f  ))..    def remo
-00011810: 7665 5f70 6174 6828 7365 6c66 2c20 7061  ve_path(self, pa
-00011820: 7468 2c20 2a2c 2072 6563 7572 7369 7665  th, *, recursive
-00011830: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-00011840: 2073 656c 662e 7265 7175 6573 7473 2e61   self.requests.a
-00011850: 7070 656e 6428 2827 7265 6d6f 7665 5f70  ppend(('remove_p
-00011860: 6174 6827 2c20 7061 7468 2c20 7265 6375  ath', path, recu
-00011870: 7273 6976 6529 290a 0a20 2020 2064 6566  rsive))..    def
-00011880: 2065 7865 6328 7365 6c66 2c20 636f 6d6d   exec(self, comm
-00011890: 616e 642c 202a 2a6b 7761 7267 7329 3a0a  and, **kwargs):.
-000118a0: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
-000118b0: 7565 7374 732e 6170 7065 6e64 2828 2765  uests.append(('e
-000118c0: 7865 6327 2c20 636f 6d6d 616e 642c 206b  xec', command, k
-000118d0: 7761 7267 7329 290a 2020 2020 2020 2020  wargs)).        
-000118e0: 7265 7475 726e 2073 656c 662e 7265 7370  return self.resp
-000118f0: 6f6e 7365 732e 706f 7028 3029 0a0a 2020  onses.pop(0)..  
-00011900: 2020 6465 6620 7365 6e64 5f73 6967 6e61    def send_signa
-00011910: 6c28 7365 6c66 2c20 7369 676e 616c 2c20  l(self, signal, 
-00011920: 7365 7276 6963 655f 6e61 6d65 7329 3a0a  service_names):.
-00011930: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
-00011940: 7565 7374 732e 6170 7065 6e64 2828 2773  uests.append(('s
-00011950: 656e 645f 7369 676e 616c 272c 2073 6967  end_signal', sig
-00011960: 6e61 6c2c 2073 6572 7669 6365 5f6e 616d  nal, service_nam
-00011970: 6573 2929 0a0a 0a63 6c61 7373 2054 6573  es))...class Tes
-00011980: 744d 6f64 656c 4269 6e64 696e 6773 2875  tModelBindings(u
-00011990: 6e69 7474 6573 742e 5465 7374 4361 7365  nittest.TestCase
-000119a0: 293a 0a0a 2020 2020 6465 6620 7365 7455  ):..    def setU
-000119b0: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
-000119c0: 206d 6574 6120 3d20 6f70 732e 6368 6172   meta = ops.char
-000119d0: 6d2e 4368 6172 6d4d 6574 6128 290a 2020  m.CharmMeta().  
-000119e0: 2020 2020 2020 6d65 7461 2e72 656c 6174        meta.relat
-000119f0: 696f 6e73 203d 207b 0a20 2020 2020 2020  ions = {.       
-00011a00: 2020 2020 2027 6462 3027 3a20 5265 6c61       'db0': Rela
-00011a10: 7469 6f6e 4d65 7461 280a 2020 2020 2020  tionMeta(.      
-00011a20: 2020 2020 2020 2020 2020 5265 6c61 7469            Relati
-00011a30: 6f6e 526f 6c65 2e70 726f 7669 6465 732c  onRole.provides,
-00011a40: 2027 6462 3027 2c20 7b27 696e 7465 7266   'db0', {'interf
-00011a50: 6163 6527 3a20 2764 6230 272c 2027 7363  ace': 'db0', 'sc
-00011a60: 6f70 6527 3a20 2767 6c6f 6261 6c27 7d29  ope': 'global'})
-00011a70: 2c0a 2020 2020 2020 2020 2020 2020 2764  ,.            'd
-00011a80: 6231 273a 2052 656c 6174 696f 6e4d 6574  b1': RelationMet
-00011a90: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
-00011aa0: 2020 2052 656c 6174 696f 6e52 6f6c 652e     RelationRole.
-00011ab0: 7265 7175 6972 6573 2c20 2764 6231 272c  requires, 'db1',
-00011ac0: 207b 2769 6e74 6572 6661 6365 273a 2027   {'interface': '
-00011ad0: 6462 3127 2c20 2773 636f 7065 273a 2027  db1', 'scope': '
-00011ae0: 676c 6f62 616c 277d 292c 0a20 2020 2020  global'}),.     
-00011af0: 2020 2020 2020 2027 6462 3227 3a20 5265         'db2': Re
-00011b00: 6c61 7469 6f6e 4d65 7461 280a 2020 2020  lationMeta(.    
-00011b10: 2020 2020 2020 2020 2020 2020 5265 6c61              Rela
-00011b20: 7469 6f6e 526f 6c65 2e70 6565 722c 2027  tionRole.peer, '
-00011b30: 6462 3227 2c20 7b27 696e 7465 7266 6163  db2', {'interfac
-00011b40: 6527 3a20 2764 6232 272c 2027 7363 6f70  e': 'db2', 'scop
-00011b50: 6527 3a20 2767 6c6f 6261 6c27 7d29 2c0a  e': 'global'}),.
-00011b60: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00011b70: 2020 7365 6c66 2e62 6163 6b65 6e64 203d    self.backend =
-00011b80: 206f 7073 2e6d 6f64 656c 2e5f 4d6f 6465   ops.model._Mode
-00011b90: 6c42 6163 6b65 6e64 2827 6d79 6170 702f  lBackend('myapp/
-00011ba0: 3027 290a 2020 2020 2020 2020 7365 6c66  0').        self
-00011bb0: 2e6d 6f64 656c 203d 206f 7073 2e6d 6f64  .model = ops.mod
-00011bc0: 656c 2e4d 6f64 656c 286d 6574 612c 2073  el.Model(meta, s
-00011bd0: 656c 662e 6261 636b 656e 6429 0a0a 2020  elf.backend)..  
-00011be0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00011bf0: 7428 7365 6c66 2c20 2772 656c 6174 696f  t(self, 'relatio
-00011c00: 6e2d 6964 7327 2c0a 2020 2020 2020 2020  n-ids',.        
-00011c10: 2020 2020 2020 2020 2020 2020 2222 2228              """(
-00011c20: 5b20 2224 3122 203d 2064 6230 205d 2026  [ "$1" = db0 ] &
-00011c30: 2620 6563 686f 2027 5b22 6462 303a 3422  & echo '["db0:4"
-00011c40: 5d27 2920 7c7c 2065 6368 6f20 275b 5d27  ]') || echo '[]'
-00011c50: 2222 2229 0a20 2020 2020 2020 2066 616b  """).        fak
-00011c60: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00011c70: 7265 6c61 7469 6f6e 2d6c 6973 7427 2c20  relation-list', 
-00011c80: 2222 225b 2022 2432 2220 3d20 3420 5d20  """[ "$2" = 4 ] 
-00011c90: 2626 2065 6368 6f20 275b 2272 656d 6f74  && echo '["remot
-00011ca0: 6561 7070 312f 3022 5d27 207c 7c20 6578  eapp1/0"]' || ex
-00011cb0: 6974 2032 2222 2229 0a20 2020 2020 2020  it 2""").       
-00011cc0: 2073 656c 662e 6e65 7477 6f72 6b5f 6765   self.network_ge
-00011cd0: 745f 6f75 7420 3d20 2727 277b 0a20 2022  t_out = '''{.  "
-00011ce0: 6269 6e64 2d61 6464 7265 7373 6573 223a  bind-addresses":
-00011cf0: 205b 0a20 2020 207b 0a20 2020 2020 2022   [.    {.      "
-00011d00: 6d61 632d 6164 6472 6573 7322 3a20 2264  mac-address": "d
-00011d10: 653a 6164 3a62 653a 6566 3a63 613a 6665  e:ad:be:ef:ca:fe
-00011d20: 222c 0a20 2020 2020 2022 696e 7465 7266  ",.      "interf
-00011d30: 6163 652d 6e61 6d65 223a 2022 6c6f 222c  ace-name": "lo",
-00011d40: 0a20 2020 2020 2022 6164 6472 6573 7365  .      "addresse
-00011d50: 7322 3a20 5b0a 2020 2020 2020 2020 7b0a  s": [.        {.
-00011d60: 2020 2020 2020 2020 2020 2268 6f73 746e            "hostn
-00011d70: 616d 6522 3a20 2222 2c0a 2020 2020 2020  ame": "",.      
-00011d80: 2020 2020 2276 616c 7565 223a 2022 3139      "value": "19
-00011d90: 322e 302e 322e 3222 2c0a 2020 2020 2020  2.0.2.2",.      
-00011da0: 2020 2020 2263 6964 7222 3a20 2231 3932      "cidr": "192
-00011db0: 2e30 2e32 2e30 2f32 3422 0a20 2020 2020  .0.2.0/24".     
-00011dc0: 2020 207d 2c0a 2020 2020 2020 2020 7b0a     },.        {.
-00011dd0: 2020 2020 2020 2020 2020 2268 6f73 746e            "hostn
-00011de0: 616d 6522 3a20 2264 6561 6462 6565 662e  ame": "deadbeef.
-00011df0: 6578 616d 706c 6522 2c0a 2020 2020 2020  example",.      
-00011e00: 2020 2020 2276 616c 7565 223a 2022 6465      "value": "de
-00011e10: 6164 3a62 6565 663a 3a31 222c 0a20 2020  ad:beef::1",.   
-00011e20: 2020 2020 2020 2022 6369 6472 223a 2022         "cidr": "
-00011e30: 6465 6164 3a62 6565 663a 3a2f 3634 220a  dead:beef::/64".
-00011e40: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00011e50: 5d0a 2020 2020 7d2c 0a20 2020 207b 0a20  ].    },.    {. 
-00011e60: 2020 2020 2022 6d61 632d 6164 6472 6573       "mac-addres
-00011e70: 7322 3a20 2222 2c0a 2020 2020 2020 2269  s": "",.      "i
-00011e80: 6e74 6572 6661 6365 2d6e 616d 6522 3a20  nterface-name": 
-00011e90: 2274 756e 222c 0a20 2020 2020 2022 6164  "tun",.      "ad
-00011ea0: 6472 6573 7365 7322 3a20 5b0a 2020 2020  dresses": [.    
-00011eb0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00011ec0: 2268 6f73 746e 616d 6522 3a20 2222 2c0a  "hostname": "",.
-00011ed0: 2020 2020 2020 2020 2020 2276 616c 7565            "value
-00011ee0: 223a 2022 3139 322e 302e 332e 3322 2c0a  ": "192.0.3.3",.
-00011ef0: 2020 2020 2020 2020 2020 2263 6964 7222            "cidr"
-00011f00: 3a20 2222 0a20 2020 2020 2020 207d 2c0a  : "".        },.
-00011f10: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00011f20: 2020 2020 2268 6f73 746e 616d 6522 3a20      "hostname": 
-00011f30: 2222 2c0a 2020 2020 2020 2020 2020 2276  "",.          "v
-00011f40: 616c 7565 223a 2022 3230 3031 3a64 6238  alue": "2001:db8
-00011f50: 3a3a 3322 2c0a 2020 2020 2020 2020 2020  ::3",.          
-00011f60: 2263 6964 7222 3a20 2222 0a20 2020 2020  "cidr": "".     
-00011f70: 2020 207d 2c0a 2020 2020 2020 2020 7b0a     },.        {.
-00011f80: 2020 2020 2020 2020 2020 2268 6f73 746e            "hostn
-00011f90: 616d 6522 3a20 2264 6561 6462 6565 662e  ame": "deadbeef.
-00011fa0: 6c6f 6361 6c22 2c0a 2020 2020 2020 2020  local",.        
-00011fb0: 2020 2276 616c 7565 223a 2022 6665 3830    "value": "fe80
-00011fc0: 3a3a 313a 3122 2c0a 2020 2020 2020 2020  ::1:1",.        
-00011fd0: 2020 2263 6964 7222 3a20 2266 6538 303a    "cidr": "fe80:
-00011fe0: 3a2f 3634 220a 2020 2020 2020 2020 7d0a  :/64".        }.
-00011ff0: 2020 2020 2020 5d0a 2020 2020 7d0a 2020        ].    }.  
-00012000: 5d2c 0a20 2022 6567 7265 7373 2d73 7562  ],.  "egress-sub
-00012010: 6e65 7473 223a 205b 0a20 2020 2022 3139  nets": [.    "19
-00012020: 322e 302e 322e 322f 3332 222c 0a20 2020  2.0.2.2/32",.   
-00012030: 2022 3139 322e 302e 332e 302f 3234 222c   "192.0.3.0/24",
-00012040: 0a20 2020 2022 6465 6164 3a62 6565 663a  .    "dead:beef:
-00012050: 3a2f 3634 222c 0a20 2020 2022 3230 3031  :/64",.    "2001
-00012060: 3a64 6238 3a3a 332f 3132 3822 0a20 205d  :db8::3/128".  ]
-00012070: 2c0a 2020 2269 6e67 7265 7373 2d61 6464  ,.  "ingress-add
-00012080: 7265 7373 6573 223a 205b 0a20 2020 2022  resses": [.    "
-00012090: 3139 322e 302e 322e 3222 2c0a 2020 2020  192.0.2.2",.    
-000120a0: 2231 3932 2e30 2e33 2e33 222c 0a20 2020  "192.0.3.3",.   
-000120b0: 2022 6465 6164 3a62 6565 663a 3a31 222c   "dead:beef::1",
-000120c0: 0a20 2020 2022 3230 3031 3a64 6238 3a3a  .    "2001:db8::
-000120d0: 3322 0a20 205d 0a7d 2727 270a 0a20 2020  3".  ].}'''..   
-000120e0: 2064 6566 205f 6368 6563 6b5f 6269 6e64   def _check_bind
-000120f0: 696e 675f 6461 7461 2873 656c 662c 2062  ing_data(self, b
-00012100: 696e 6469 6e67 5f6e 616d 652c 2062 696e  inding_name, bin
-00012110: 6469 6e67 293a 0a20 2020 2020 2020 2073  ding):.        s
-00012120: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012130: 6269 6e64 696e 672e 6e61 6d65 2c20 6269  binding.name, bi
-00012140: 6e64 696e 675f 6e61 6d65 290a 2020 2020  nding_name).    
-00012150: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00012160: 7175 616c 2862 696e 6469 6e67 2e6e 6574  qual(binding.net
-00012170: 776f 726b 2e62 696e 645f 6164 6472 6573  work.bind_addres
-00012180: 732c 2069 7061 6464 7265 7373 2e69 705f  s, ipaddress.ip_
-00012190: 6164 6472 6573 7328 2731 3932 2e30 2e32  address('192.0.2
-000121a0: 2e32 2729 290a 2020 2020 2020 2020 7365  .2')).        se
-000121b0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-000121c0: 696e 6469 6e67 2e6e 6574 776f 726b 2e69  inding.network.i
-000121d0: 6e67 7265 7373 5f61 6464 7265 7373 2c20  ngress_address, 
-000121e0: 6970 6164 6472 6573 732e 6970 5f61 6464  ipaddress.ip_add
-000121f0: 7265 7373 2827 3139 322e 302e 322e 3227  ress('192.0.2.2'
-00012200: 2929 0a20 2020 2020 2020 2023 202f 3332  )).        # /32
-00012210: 2061 6e64 202f 3132 3820 4349 4452 7320   and /128 CIDRs 
-00012220: 6172 6520 7661 6c69 6420 6f6e 652d 6164  are valid one-ad
-00012230: 6472 6573 7320 6e65 7477 6f72 6b73 2066  dress networks f
-00012240: 6f72 2049 5076 7b34 2c36 7d4e 6574 776f  or IPv{4,6}Netwo
-00012250: 726b 2074 7970 6573 2072 6573 7065 6374  rk types respect
-00012260: 6976 656c 792e 0a20 2020 2020 2020 2073  ively..        s
-00012270: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012280: 6269 6e64 696e 672e 6e65 7477 6f72 6b2e  binding.network.
-00012290: 6567 7265 7373 5f73 7562 6e65 7473 2c20  egress_subnets, 
-000122a0: 5b69 7061 6464 7265 7373 2e69 705f 6e65  [ipaddress.ip_ne
-000122b0: 7477 6f72 6b28 2731 3932 2e30 2e32 2e32  twork('192.0.2.2
-000122c0: 2f33 3227 292c 0a20 2020 2020 2020 2020  /32'),.         
-000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012300: 2069 7061 6464 7265 7373 2e69 705f 6e65   ipaddress.ip_ne
-00012310: 7477 6f72 6b28 2731 3932 2e30 2e33 2e30  twork('192.0.3.0
-00012320: 2f32 3427 292c 0a20 2020 2020 2020 2020  /24'),.         
-00012330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012360: 2069 7061 6464 7265 7373 2e69 705f 6e65   ipaddress.ip_ne
-00012370: 7477 6f72 6b28 2764 6561 643a 6265 6566  twork('dead:beef
-00012380: 3a3a 2f36 3427 292c 0a20 2020 2020 2020  ::/64'),.       
-00012390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123c0: 2020 2069 7061 6464 7265 7373 2e69 705f     ipaddress.ip_
-000123d0: 6e65 7477 6f72 6b28 2732 3030 313a 6462  network('2001:db
-000123e0: 383a 3a33 2f31 3238 2729 5d29 0a0a 2020  8::3/128')])..  
-000123f0: 2020 2020 2020 666f 7220 2869 2c20 286e        for (i, (n
-00012400: 616d 652c 2061 6464 7265 7373 2c20 7375  ame, address, su
-00012410: 626e 6574 2929 2069 6e20 656e 756d 6572  bnet)) in enumer
-00012420: 6174 6528 5b0a 2020 2020 2020 2020 2020  ate([.          
-00012430: 2020 2020 2020 2827 6c6f 272c 2027 3139        ('lo', '19
-00012440: 322e 302e 322e 3227 2c20 2731 3932 2e30  2.0.2.2', '192.0
-00012450: 2e32 2e30 2f32 3427 292c 0a20 2020 2020  .2.0/24'),.     
-00012460: 2020 2020 2020 2020 2020 2028 276c 6f27             ('lo'
-00012470: 2c20 2764 6561 643a 6265 6566 3a3a 3127  , 'dead:beef::1'
-00012480: 2c20 2764 6561 643a 6265 6566 3a3a 2f36  , 'dead:beef::/6
-00012490: 3427 292c 0a20 2020 2020 2020 2020 2020  4'),.           
-000124a0: 2020 2020 2028 2774 756e 272c 2027 3139       ('tun', '19
-000124b0: 322e 302e 332e 3327 2c20 2731 3932 2e30  2.0.3.3', '192.0
-000124c0: 2e33 2e33 2f33 3227 292c 0a20 2020 2020  .3.3/32'),.     
-000124d0: 2020 2020 2020 2020 2020 2028 2774 756e             ('tun
-000124e0: 272c 2027 3230 3031 3a64 6238 3a3a 3327  ', '2001:db8::3'
-000124f0: 2c20 2732 3030 313a 6462 383a 3a33 2f31  , '2001:db8::3/1
-00012500: 3238 2729 2c0a 2020 2020 2020 2020 2020  28'),.          
-00012510: 2020 2020 2020 2827 7475 6e27 2c20 2766        ('tun', 'f
-00012520: 6538 303a 3a31 3a31 272c 2027 6665 3830  e80::1:1', 'fe80
-00012530: 3a3a 2f36 3427 295d 293a 0a20 2020 2020  ::/64')]):.     
-00012540: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00012550: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
-00012560: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
-00012570: 6573 5b69 5d2e 6e61 6d65 2c20 6e61 6d65  es[i].name, name
-00012580: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00012590: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-000125a0: 696e 6469 6e67 2e6e 6574 776f 726b 2e69  inding.network.i
-000125b0: 6e74 6572 6661 6365 735b 695d 2e61 6464  nterfaces[i].add
-000125c0: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
-000125d0: 6970 5f61 6464 7265 7373 2861 6464 7265  ip_address(addre
-000125e0: 7373 2929 0a20 2020 2020 2020 2020 2020  ss)).           
-000125f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00012600: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
-00012610: 6b2e 696e 7465 7266 6163 6573 5b69 5d2e  k.interfaces[i].
-00012620: 7375 626e 6574 2c20 6970 6164 6472 6573  subnet, ipaddres
-00012630: 732e 6970 5f6e 6574 776f 726b 2873 7562  s.ip_network(sub
-00012640: 6e65 7429 290a 0a20 2020 2020 2020 2066  net))..        f
-00012650: 6f72 2028 692c 2028 6e61 6d65 2c20 6164  or (i, (name, ad
-00012660: 6472 6573 732c 2073 7562 6e65 7429 2920  dress, subnet)) 
-00012670: 696e 2065 6e75 6d65 7261 7465 285b 0a20  in enumerate([. 
-00012680: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00012690: 276c 6f27 2c20 2731 3932 2e30 2e32 2e32  'lo', '192.0.2.2
-000126a0: 272c 2027 3139 322e 302e 322e 302f 3234  ', '192.0.2.0/24
-000126b0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-000126c0: 2020 2020 2827 6c6f 272c 2027 6465 6164      ('lo', 'dead
-000126d0: 3a62 6565 663a 3a31 272c 2027 6465 6164  :beef::1', 'dead
-000126e0: 3a62 6565 663a 3a2f 3634 2729 2c0a 2020  :beef::/64'),.  
-000126f0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-00012700: 7475 6e27 2c20 2731 3932 2e30 2e33 2e33  tun', '192.0.3.3
-00012710: 272c 2027 3139 322e 302e 332e 332f 3332  ', '192.0.3.3/32
-00012720: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00012730: 2020 2020 2827 7475 6e27 2c20 2732 3030      ('tun', '200
-00012740: 313a 6462 383a 3a33 272c 2027 3230 3031  1:db8::3', '2001
-00012750: 3a64 6238 3a3a 332f 3132 3827 292c 0a20  :db8::3/128'),. 
-00012760: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00012770: 2774 756e 272c 2027 6665 3830 3a3a 313a  'tun', 'fe80::1:
-00012780: 3127 2c20 2766 6538 303a 3a2f 3634 2729  1', 'fe80::/64')
-00012790: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-000127a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000127b0: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
-000127c0: 2e69 6e74 6572 6661 6365 735b 695d 2e6e  .interfaces[i].n
-000127d0: 616d 652c 206e 616d 6529 0a20 2020 2020  ame, name).     
-000127e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000127f0: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
-00012800: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
-00012810: 6573 5b69 5d2e 6164 6472 6573 732c 2069  es[i].address, i
-00012820: 7061 6464 7265 7373 2e69 705f 6164 6472  paddress.ip_addr
-00012830: 6573 7328 6164 6472 6573 7329 290a 2020  ess(address)).  
-00012840: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00012850: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
-00012860: 6e67 2e6e 6574 776f 726b 2e69 6e74 6572  ng.network.inter
-00012870: 6661 6365 735b 695d 2e73 7562 6e65 742c  faces[i].subnet,
-00012880: 2069 7061 6464 7265 7373 2e69 705f 6e65   ipaddress.ip_ne
-00012890: 7477 6f72 6b28 7375 626e 6574 2929 0a0a  twork(subnet))..
-000128a0: 2020 2020 6465 6620 7465 7374 5f69 6e76      def test_inv
-000128b0: 616c 6964 5f6b 6579 7328 7365 6c66 293a  alid_keys(self):
-000128c0: 0a20 2020 2020 2020 2023 2042 6173 6963  .        # Basic
-000128d0: 2076 616c 6964 6174 696f 6e20 666f 7220   validation for 
-000128e0: 7061 7373 696e 6720 696e 7661 6c69 6420  passing invalid 
-000128f0: 6b65 7973 2e0a 2020 2020 2020 2020 666f  keys..        fo
-00012900: 7220 6e61 6d65 2069 6e20 286f 626a 6563  r name in (objec
-00012910: 742c 2030 293a 0a20 2020 2020 2020 2020  t, 0):.         
-00012920: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00012930: 6572 7452 6169 7365 7328 6f70 732e 6d6f  ertRaises(ops.mo
-00012940: 6465 6c2e 4d6f 6465 6c45 7272 6f72 293a  del.ModelError):
-00012950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012960: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-00012970: 6269 6e64 696e 6728 6e61 6d65 290a 0a20  binding(name).. 
-00012980: 2020 2064 6566 2074 6573 745f 6465 6164     def test_dead
-00012990: 5f72 656c 6174 696f 6e73 2873 656c 6629  _relations(self)
-000129a0: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
-000129b0: 6372 6970 7428 0a20 2020 2020 2020 2020  cript(.         
-000129c0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-000129d0: 2020 2020 2027 6e65 7477 6f72 6b2d 6765       'network-ge
-000129e0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-000129f0: 6627 2727 0a20 2020 2020 2020 2020 2020  f'''.           
-00012a00: 2020 2020 2069 6620 5b20 2224 3122 203d       if [ "$1" =
-00012a10: 2064 6230 205d 2026 2620 5b20 2224 3222   db0 ] && [ "$2"
-00012a20: 203d 202d 2d66 6f72 6d61 743d 6a73 6f6e   = --format=json
-00012a30: 205d 3b20 7468 656e 0a20 2020 2020 2020   ]; then.       
-00012a40: 2020 2020 2020 2020 2020 2020 2065 6368               ech
-00012a50: 6f20 277b 7365 6c66 2e6e 6574 776f 726b  o '{self.network
-00012a60: 5f67 6574 5f6f 7574 7d27 0a20 2020 2020  _get_out}'.     
-00012a70: 2020 2020 2020 2020 2020 2065 6c73 650a             else.
-00012a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a90: 2020 2020 6563 686f 2045 5252 4f52 2069      echo ERROR i
-00012aa0: 6e76 616c 6964 2076 616c 7565 2022 2432  nvalid value "$2
-00012ab0: 2220 666f 7220 6f70 7469 6f6e 202d 723a  " for option -r:
-00012ac0: 2072 656c 6174 696f 6e20 6e6f 7420 666f   relation not fo
-00012ad0: 756e 6420 3e26 320a 2020 2020 2020 2020  und >&2.        
-00012ae0: 2020 2020 2020 2020 2020 2020 6578 6974              exit
-00012af0: 2032 0a20 2020 2020 2020 2020 2020 2020   2.             
-00012b00: 2020 2066 690a 2020 2020 2020 2020 2020     fi.          
-00012b10: 2020 2727 2729 0a20 2020 2020 2020 2023    ''').        #
-00012b20: 2056 616c 6964 6174 6520 7468 6520 6265   Validate the be
-00012b30: 6861 7669 6f72 2066 6f72 2064 6561 6420  havior for dead 
-00012b40: 7265 6c61 7469 6f6e 732e 0a20 2020 2020  relations..     
-00012b50: 2020 2062 696e 6469 6e67 203d 206f 7073     binding = ops
-00012b60: 2e6d 6f64 656c 2e42 696e 6469 6e67 2827  .model.Binding('
-00012b70: 6462 3027 2c20 3432 2c20 7365 6c66 2e6d  db0', 42, self.m
-00012b80: 6f64 656c 2e5f 6261 636b 656e 6429 0a20  odel._backend). 
-00012b90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00012ba0: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
-00012bb0: 6e65 7477 6f72 6b2e 6269 6e64 5f61 6464  network.bind_add
-00012bc0: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
-00012bd0: 6970 5f61 6464 7265 7373 2827 3139 322e  ip_address('192.
-00012be0: 302e 322e 3227 2929 0a20 2020 2020 2020  0.2.2')).       
-00012bf0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00012c00: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-00012c10: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-00012c20: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
-00012c30: 2020 2020 205b 276e 6574 776f 726b 2d67       ['network-g
-00012c40: 6574 272c 2027 6462 3027 2c20 272d 7227  et', 'db0', '-r'
-00012c50: 2c20 2734 3227 2c20 272d 2d66 6f72 6d61  , '42', '--forma
-00012c60: 743d 6a73 6f6e 275d 2c0a 2020 2020 2020  t=json'],.      
-00012c70: 2020 2020 2020 5b27 6e65 7477 6f72 6b2d        ['network-
-00012c80: 6765 7427 2c20 2764 6230 272c 2027 2d2d  get', 'db0', '--
-00012c90: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
-00012ca0: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-00012cb0: 6566 2074 6573 745f 6269 6e64 696e 675f  ef test_binding_
-00012cc0: 6279 5f72 656c 6174 696f 6e5f 6e61 6d65  by_relation_name
-00012cd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00012ce0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00012cf0: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
-00012d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d10: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
-00012d20: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
-00012d30: 277b 7365 6c66 2e6e 6574 776f 726b 5f67  '{self.network_g
-00012d40: 6574 5f6f 7574 7d27 207c 7c20 6578 6974  et_out}' || exit
-00012d50: 2031 2727 2729 0a20 2020 2020 2020 2062   1''').        b
-00012d60: 696e 6469 6e67 5f6e 616d 6520 3d20 2764  inding_name = 'd
-00012d70: 6230 270a 2020 2020 2020 2020 6578 7065  b0'.        expe
-00012d80: 6374 6564 5f63 616c 6c73 203d 205b 5b27  cted_calls = [['
-00012d90: 6e65 7477 6f72 6b2d 6765 7427 2c20 2764  network-get', 'd
-00012da0: 6230 272c 2027 2d2d 666f 726d 6174 3d6a  b0', '--format=j
-00012db0: 736f 6e27 5d5d 0a0a 2020 2020 2020 2020  son']]..        
-00012dc0: 6269 6e64 696e 6720 3d20 7365 6c66 2e6d  binding = self.m
-00012dd0: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
-00012de0: 2862 696e 6469 6e67 5f6e 616d 6529 0a20  (binding_name). 
-00012df0: 2020 2020 2020 2073 656c 662e 5f63 6865         self._che
-00012e00: 636b 5f62 696e 6469 6e67 5f64 6174 6128  ck_binding_data(
-00012e10: 6269 6e64 696e 675f 6e61 6d65 2c20 6269  binding_name, bi
-00012e20: 6e64 696e 6729 0a20 2020 2020 2020 2073  nding).        s
-00012e30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012e40: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-00012e50: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-00012e60: 7565 292c 2065 7870 6563 7465 645f 6361  ue), expected_ca
-00012e70: 6c6c 7329 0a0a 2020 2020 6465 6620 7465  lls)..    def te
-00012e80: 7374 5f62 696e 6469 6e67 5f62 795f 7265  st_binding_by_re
-00012e90: 6c61 7469 6f6e 2873 656c 6629 3a0a 2020  lation(self):.  
-00012ea0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00012eb0: 7428 7365 6c66 2c20 276e 6574 776f 726b  t(self, 'network
-00012ec0: 2d67 6574 272c 0a20 2020 2020 2020 2020  -get',.         
-00012ed0: 2020 2020 2020 2020 2020 2066 2727 275b             f'''[
-00012ee0: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
-00012ef0: 2065 6368 6f20 277b 7365 6c66 2e6e 6574   echo '{self.net
-00012f00: 776f 726b 5f67 6574 5f6f 7574 7d27 207c  work_get_out}' |
-00012f10: 7c20 6578 6974 2031 2727 2729 0a20 2020  | exit 1''').   
-00012f20: 2020 2020 2062 696e 6469 6e67 5f6e 616d       binding_nam
-00012f30: 6520 3d20 2764 6230 270a 2020 2020 2020  e = 'db0'.      
-00012f40: 2020 6578 7065 6374 6564 5f63 616c 6c73    expected_calls
-00012f50: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00012f60: 205b 2772 656c 6174 696f 6e2d 6964 7327   ['relation-ids'
-00012f70: 2c20 2764 6230 272c 2027 2d2d 666f 726d  , 'db0', '--form
-00012f80: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-00012f90: 2020 2020 2020 2023 2054 6865 2074 776f         # The two
-00012fa0: 2069 6e76 6f63 6174 696f 6e73 2062 656c   invocations bel
-00012fb0: 6f77 2061 7265 2064 7565 2074 6f20 7468  ow are due to th
-00012fc0: 6520 6765 745f 7265 6c61 7469 6f6e 2063  e get_relation c
-00012fd0: 616c 6c2e 0a20 2020 2020 2020 2020 2020  all..           
-00012fe0: 205b 2772 656c 6174 696f 6e2d 6c69 7374   ['relation-list
-00012ff0: 272c 2027 2d72 272c 2027 3427 2c20 272d  ', '-r', '4', '-
-00013000: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
-00013010: 2020 2020 2020 2020 2020 2020 5b27 6e65              ['ne
-00013020: 7477 6f72 6b2d 6765 7427 2c20 2764 6230  twork-get', 'db0
-00013030: 272c 2027 2d72 272c 2027 3427 2c20 272d  ', '-r', '4', '-
-00013040: 2d66 6f72 6d61 743d 6a73 6f6e 275d 2c0a  -format=json'],.
-00013050: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00013060: 2020 6269 6e64 696e 6720 3d20 7365 6c66    binding = self
-00013070: 2e6d 6f64 656c 2e67 6574 5f62 696e 6469  .model.get_bindi
-00013080: 6e67 2873 656c 662e 6d6f 6465 6c2e 6765  ng(self.model.ge
-00013090: 745f 7265 6c61 7469 6f6e 2862 696e 6469  t_relation(bindi
-000130a0: 6e67 5f6e 616d 6529 290a 2020 2020 2020  ng_name)).      
-000130b0: 2020 7365 6c66 2e5f 6368 6563 6b5f 6269    self._check_bi
-000130c0: 6e64 696e 675f 6461 7461 2862 696e 6469  nding_data(bindi
-000130d0: 6e67 5f6e 616d 652c 2062 696e 6469 6e67  ng_name, binding
-000130e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000130f0: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-00013100: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-00013110: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
-00013120: 6578 7065 6374 6564 5f63 616c 6c73 290a  expected_calls).
-00013130: 0a20 2020 2064 6566 2074 6573 745f 6269  .    def test_bi
-00013140: 6e64 696e 675f 6e6f 5f69 6661 6365 5f6e  nding_no_iface_n
-00013150: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
-00013160: 2020 206e 6574 776f 726b 5f67 6574 5f6f     network_get_o
-00013170: 7574 5f6f 626a 203d 207b 0a20 2020 2020  ut_obj = {.     
-00013180: 2020 2020 2020 2027 6269 6e64 2d61 6464         'bind-add
-00013190: 7265 7373 6573 273a 205b 0a20 2020 2020  resses': [.     
-000131a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000131b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131c0: 2027 6d61 632d 6164 6472 6573 7327 3a20   'mac-address': 
-000131d0: 2727 2c0a 2020 2020 2020 2020 2020 2020  '',.            
-000131e0: 2020 2020 2020 2020 2769 6e74 6572 6661          'interfa
-000131f0: 6365 2d6e 616d 6527 3a20 2727 2c0a 2020  ce-name': '',.  
-00013200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013210: 2020 2761 6464 7265 7373 6573 273a 205b    'addresses': [
-00013220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013230: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00013240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013250: 2020 2020 2020 2027 686f 7374 6e61 6d65         'hostname
-00013260: 273a 2027 272c 0a20 2020 2020 2020 2020  ': '',.         
-00013270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013280: 2020 2027 7661 6c75 6527 3a20 2731 302e     'value': '10.
-00013290: 312e 3839 2e33 3527 2c0a 2020 2020 2020  1.89.35',.      
-000132a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132b0: 2020 2020 2020 2763 6964 7227 3a20 2727        'cidr': ''
-000132c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000132d0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000132e0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-000132f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013300: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
-00013310: 2c0a 2020 2020 2020 2020 2020 2020 2765  ,.            'e
-00013320: 6772 6573 732d 7375 626e 6574 7327 3a20  gress-subnets': 
-00013330: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00013340: 2020 2731 302e 3135 322e 3138 332e 3135    '10.152.183.15
-00013350: 382f 3332 270a 2020 2020 2020 2020 2020  8/32'.          
-00013360: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
-00013370: 2027 696e 6772 6573 732d 6164 6472 6573   'ingress-addres
-00013380: 7365 7327 3a20 5b0a 2020 2020 2020 2020  ses': [.        
-00013390: 2020 2020 2020 2020 2731 302e 3135 322e          '10.152.
-000133a0: 3138 332e 3135 3827 0a20 2020 2020 2020  183.158'.       
-000133b0: 2020 2020 205d 0a20 2020 2020 2020 207d       ].        }
-000133c0: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
-000133d0: 5f67 6574 5f6f 7574 203d 206a 736f 6e2e  _get_out = json.
-000133e0: 6475 6d70 7328 6e65 7477 6f72 6b5f 6765  dumps(network_ge
-000133f0: 745f 6f75 745f 6f62 6a29 0a20 2020 2020  t_out_obj).     
-00013400: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00013410: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
-00013420: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-00013430: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
-00013440: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
-00013450: 686f 2027 7b6e 6574 776f 726b 5f67 6574  ho '{network_get
-00013460: 5f6f 7574 7d27 207c 7c20 6578 6974 2031  _out}' || exit 1
-00013470: 2727 2729 0a20 2020 2020 2020 2062 696e  ''').        bin
-00013480: 6469 6e67 5f6e 616d 6520 3d20 2764 6230  ding_name = 'db0
-00013490: 270a 2020 2020 2020 2020 6578 7065 6374  '.        expect
-000134a0: 6564 5f63 616c 6c73 203d 205b 5b27 6e65  ed_calls = [['ne
-000134b0: 7477 6f72 6b2d 6765 7427 2c20 2764 6230  twork-get', 'db0
-000134c0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-000134d0: 6e27 5d5d 0a0a 2020 2020 2020 2020 6269  n']]..        bi
-000134e0: 6e64 696e 6720 3d20 7365 6c66 2e6d 6f64  nding = self.mod
-000134f0: 656c 2e67 6574 5f62 696e 6469 6e67 2862  el.get_binding(b
-00013500: 696e 6469 6e67 5f6e 616d 6529 0a20 2020  inding_name).   
-00013510: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00013520: 4571 7561 6c28 6269 6e64 696e 672e 6e61  Equal(binding.na
-00013530: 6d65 2c20 2764 6230 2729 0a20 2020 2020  me, 'db0').     
-00013540: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00013550: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
-00013560: 6f72 6b2e 6269 6e64 5f61 6464 7265 7373  ork.bind_address
-00013570: 2c20 6970 6164 6472 6573 732e 6970 5f61  , ipaddress.ip_a
-00013580: 6464 7265 7373 2827 3130 2e31 2e38 392e  ddress('10.1.89.
-00013590: 3335 2729 290a 2020 2020 2020 2020 7365  35')).        se
-000135a0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-000135b0: 696e 6469 6e67 2e6e 6574 776f 726b 2e69  inding.network.i
-000135c0: 6e67 7265 7373 5f61 6464 7265 7373 2c20  ngress_address, 
-000135d0: 6970 6164 6472 6573 732e 6970 5f61 6464  ipaddress.ip_add
-000135e0: 7265 7373 2827 3130 2e31 3532 2e31 3833  ress('10.152.183
-000135f0: 2e31 3538 2729 290a 2020 2020 2020 2020  .158')).        
-00013600: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00013610: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-00013620: 6c73 2873 656c 662c 2063 6c65 6172 3d54  ls(self, clear=T
-00013630: 7275 6529 2c20 6578 7065 6374 6564 5f63  rue), expected_c
-00013640: 616c 6c73 290a 0a20 2020 2064 6566 2074  alls)..    def t
-00013650: 6573 745f 6d69 7373 696e 675f 6269 6e64  est_missing_bind
-00013660: 5f61 6464 7265 7373 6573 2873 656c 6629  _addresses(self)
-00013670: 3a0a 2020 2020 2020 2020 6e65 7477 6f72  :.        networ
-00013680: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
-00013690: 6d70 7328 7b7d 290a 2020 2020 2020 2020  mps({}).        
-000136a0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-000136b0: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
-000136c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000136d0: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
-000136e0: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
-000136f0: 277b 6e65 7477 6f72 6b5f 6461 7461 7d27  '{network_data}'
-00013700: 207c 7c20 6578 6974 2031 2727 2729 0a20   || exit 1'''). 
-00013710: 2020 2020 2020 2062 696e 6469 6e67 5f6e         binding_n
-00013720: 616d 6520 3d20 2764 6230 270a 2020 2020  ame = 'db0'.    
-00013730: 2020 2020 6269 6e64 696e 6720 3d20 7365      binding = se
-00013740: 6c66 2e6d 6f64 656c 2e67 6574 5f62 696e  lf.model.get_bin
-00013750: 6469 6e67 2873 656c 662e 6d6f 6465 6c2e  ding(self.model.
-00013760: 6765 745f 7265 6c61 7469 6f6e 2862 696e  get_relation(bin
-00013770: 6469 6e67 5f6e 616d 6529 290a 2020 2020  ding_name)).    
-00013780: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013790: 7175 616c 2862 696e 6469 6e67 2e6e 6574  qual(binding.net
-000137a0: 776f 726b 2e69 6e74 6572 6661 6365 732c  work.interfaces,
-000137b0: 205b 5d29 0a0a 2020 2020 6465 6620 7465   [])..    def te
-000137c0: 7374 5f65 6d70 7479 5f62 696e 645f 6164  st_empty_bind_ad
-000137d0: 6472 6573 7365 7328 7365 6c66 293a 0a20  dresses(self):. 
-000137e0: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
-000137f0: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
-00013800: 287b 2762 696e 642d 6164 6472 6573 7365  ({'bind-addresse
-00013810: 7327 3a20 5b7b 7d5d 7d29 0a20 2020 2020  s': [{}]}).     
-00013820: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-00013830: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
-00013840: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-00013850: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
-00013860: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
-00013870: 686f 2027 7b6e 6574 776f 726b 5f64 6174  ho '{network_dat
-00013880: 617d 2720 7c7c 2065 7869 7420 3127 2727  a}' || exit 1'''
-00013890: 290a 2020 2020 2020 2020 6269 6e64 696e  ).        bindin
-000138a0: 675f 6e61 6d65 203d 2027 6462 3027 0a20  g_name = 'db0'. 
-000138b0: 2020 2020 2020 2062 696e 6469 6e67 203d         binding =
-000138c0: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
-000138d0: 6269 6e64 696e 6728 7365 6c66 2e6d 6f64  binding(self.mod
-000138e0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-000138f0: 6269 6e64 696e 675f 6e61 6d65 2929 0a20  binding_name)). 
-00013900: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00013910: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
-00013920: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
-00013930: 6573 2c20 5b5d 290a 0a20 2020 2064 6566  es, [])..    def
-00013940: 2074 6573 745f 6e6f 5f62 696e 645f 6164   test_no_bind_ad
-00013950: 6472 6573 7365 7328 7365 6c66 293a 0a20  dresses(self):. 
-00013960: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
-00013970: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
-00013980: 287b 2762 696e 642d 6164 6472 6573 7365  ({'bind-addresse
-00013990: 7327 3a20 5b7b 2761 6464 7265 7373 6573  s': [{'addresses
-000139a0: 273a 204e 6f6e 657d 5d7d 290a 2020 2020  ': None}]}).    
-000139b0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-000139c0: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
-000139d0: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
-000139e0: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
-000139f0: 2431 2220 3d20 6462 3020 5d20 2626 2065  $1" = db0 ] && e
-00013a00: 6368 6f20 277b 6e65 7477 6f72 6b5f 6461  cho '{network_da
-00013a10: 7461 7d27 207c 7c20 6578 6974 2031 2727  ta}' || exit 1''
-00013a20: 2729 0a20 2020 2020 2020 2062 696e 6469  ').        bindi
-00013a30: 6e67 5f6e 616d 6520 3d20 2764 6230 270a  ng_name = 'db0'.
-00013a40: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
-00013a50: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-00013a60: 5f62 696e 6469 6e67 2873 656c 662e 6d6f  _binding(self.mo
-00013a70: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-00013a80: 2862 696e 6469 6e67 5f6e 616d 6529 290a  (binding_name)).
-00013a90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00013aa0: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-00013ab0: 2e6e 6574 776f 726b 2e69 6e74 6572 6661  .network.interfa
-00013ac0: 6365 732c 205b 5d29 0a0a 2020 2020 6465  ces, [])..    de
-00013ad0: 6620 7465 7374 5f65 6d70 7479 5f69 6e74  f test_empty_int
-00013ae0: 6572 6661 6365 5f69 6e66 6f28 7365 6c66  erface_info(self
-00013af0: 293a 0a20 2020 2020 2020 206e 6574 776f  ):.        netwo
-00013b00: 726b 5f64 6174 6120 3d20 6a73 6f6e 2e64  rk_data = json.d
-00013b10: 756d 7073 287b 0a20 2020 2020 2020 2020  umps({.         
-00013b20: 2020 2027 6269 6e64 2d61 6464 7265 7373     'bind-address
-00013b30: 6573 273a 205b 7b0a 2020 2020 2020 2020  es': [{.        
-00013b40: 2020 2020 2020 2020 2769 6e74 6572 6661          'interfa
-00013b50: 6365 2d6e 616d 6527 3a20 2765 7468 3027  ce-name': 'eth0'
-00013b60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013b70: 2020 2761 6464 7265 7373 6573 273a 205b    'addresses': [
-00013b80: 7b7d 5d2c 0a20 2020 2020 2020 2020 2020  {}],.           
-00013b90: 207d 5d2c 0a20 2020 2020 2020 207d 290a   }],.        }).
-00013ba0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00013bb0: 6970 7428 7365 6c66 2c20 276e 6574 776f  ipt(self, 'netwo
-00013bc0: 726b 2d67 6574 272c 0a20 2020 2020 2020  rk-get',.       
-00013bd0: 2020 2020 2020 2020 2020 2020 2066 2727               f''
-00013be0: 275b 2022 2431 2220 3d20 6462 3020 5d20  '[ "$1" = db0 ] 
-00013bf0: 2626 2065 6368 6f20 277b 6e65 7477 6f72  && echo '{networ
-00013c00: 6b5f 6461 7461 7d27 207c 7c20 6578 6974  k_data}' || exit
-00013c10: 2031 2727 2729 0a20 2020 2020 2020 2062   1''').        b
-00013c20: 696e 6469 6e67 5f6e 616d 6520 3d20 2764  inding_name = 'd
-00013c30: 6230 270a 2020 2020 2020 2020 6269 6e64  b0'.        bind
-00013c40: 696e 6720 3d20 7365 6c66 2e6d 6f64 656c  ing = self.model
-00013c50: 2e67 6574 5f62 696e 6469 6e67 2873 656c  .get_binding(sel
-00013c60: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
-00013c70: 7469 6f6e 2862 696e 6469 6e67 5f6e 616d  tion(binding_nam
-00013c80: 6529 290a 2020 2020 2020 2020 7365 6c66  e)).        self
-00013c90: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-00013ca0: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
-00013cb0: 2e69 6e74 6572 6661 6365 7329 2c20 3129  .interfaces), 1)
-00013cc0: 0a20 2020 2020 2020 2069 6e74 6572 6661  .        interfa
-00013cd0: 6365 203d 2062 696e 6469 6e67 2e6e 6574  ce = binding.net
-00013ce0: 776f 726b 2e69 6e74 6572 6661 6365 735b  work.interfaces[
-00013cf0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-00013d00: 6173 7365 7274 4973 4e6f 6e65 2869 6e74  assertIsNone(int
-00013d10: 6572 6661 6365 2e61 6464 7265 7373 290a  erface.address).
-00013d20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00013d30: 6572 7449 734e 6f6e 6528 696e 7465 7266  ertIsNone(interf
-00013d40: 6163 652e 7375 626e 6574 290a 0a20 2020  ace.subnet)..   
-00013d50: 2064 6566 2074 6573 745f 6d69 7373 696e   def test_missin
-00013d60: 675f 696e 6772 6573 735f 6164 6472 6573  g_ingress_addres
-00013d70: 7365 7328 7365 6c66 293a 0a20 2020 2020  ses(self):.     
-00013d80: 2020 206e 6574 776f 726b 5f64 6174 6120     network_data 
-00013d90: 3d20 6a73 6f6e 2e64 756d 7073 287b 0a20  = json.dumps({. 
-00013da0: 2020 2020 2020 2020 2020 2027 6269 6e64             'bind
-00013db0: 2d61 6464 7265 7373 6573 273a 205b 5d2c  -addresses': [],
-00013dc0: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-00013dd0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-00013de0: 7365 6c66 2c20 276e 6574 776f 726b 2d67  self, 'network-g
-00013df0: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
-00013e00: 2020 2020 2020 2020 2066 2727 275b 2022           f'''[ "
-00013e10: 2431 2220 3d20 6462 3020 5d20 2626 2065  $1" = db0 ] && e
-00013e20: 6368 6f20 277b 6e65 7477 6f72 6b5f 6461  cho '{network_da
-00013e30: 7461 7d27 207c 7c20 6578 6974 2031 2727  ta}' || exit 1''
-00013e40: 2729 0a20 2020 2020 2020 2062 696e 6469  ').        bindi
-00013e50: 6e67 5f6e 616d 6520 3d20 2764 6230 270a  ng_name = 'db0'.
-00013e60: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
-00013e70: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-00013e80: 5f62 696e 6469 6e67 2873 656c 662e 6d6f  _binding(self.mo
-00013e90: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-00013ea0: 2862 696e 6469 6e67 5f6e 616d 6529 290a  (binding_name)).
-00013eb0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00013ec0: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-00013ed0: 2e6e 6574 776f 726b 2e69 6e67 7265 7373  .network.ingress
-00013ee0: 5f61 6464 7265 7373 6573 2c20 5b5d 290a  _addresses, []).
-00013ef0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00013f00: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
-00013f10: 2e6e 6574 776f 726b 2e69 6e67 7265 7373  .network.ingress
-00013f20: 5f61 6464 7265 7373 2c20 4e6f 6e65 290a  _address, None).
-00013f30: 0a20 2020 2064 6566 2074 6573 745f 6d69  .    def test_mi
-00013f40: 7373 696e 675f 6567 7265 7373 5f73 7562  ssing_egress_sub
-00013f50: 6e65 7473 2873 656c 6629 3a0a 2020 2020  nets(self):.    
-00013f60: 2020 2020 6e65 7477 6f72 6b5f 6461 7461      network_data
-00013f70: 203d 206a 736f 6e2e 6475 6d70 7328 7b0a   = json.dumps({.
-00013f80: 2020 2020 2020 2020 2020 2020 2762 696e              'bin
-00013f90: 642d 6164 6472 6573 7365 7327 3a20 5b5d  d-addresses': []
-00013fa0: 2c0a 2020 2020 2020 2020 2020 2020 2769  ,.            'i
-00013fb0: 6e67 7265 7373 2d61 6464 7265 7373 6573  ngress-addresses
-00013fc0: 273a 205b 5d2c 0a20 2020 2020 2020 207d  ': [],.        }
-00013fd0: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
-00013fe0: 6372 6970 7428 7365 6c66 2c20 276e 6574  cript(self, 'net
-00013ff0: 776f 726b 2d67 6574 272c 0a20 2020 2020  work-get',.     
-00014000: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014010: 2727 275b 2022 2431 2220 3d20 6462 3020  '''[ "$1" = db0 
-00014020: 5d20 2626 2065 6368 6f20 277b 6e65 7477  ] && echo '{netw
-00014030: 6f72 6b5f 6461 7461 7d27 207c 7c20 6578  ork_data}' || ex
-00014040: 6974 2031 2727 2729 0a20 2020 2020 2020  it 1''').       
-00014050: 2062 696e 6469 6e67 5f6e 616d 6520 3d20   binding_name = 
-00014060: 2764 6230 270a 2020 2020 2020 2020 6269  'db0'.        bi
-00014070: 6e64 696e 6720 3d20 7365 6c66 2e6d 6f64  nding = self.mod
-00014080: 656c 2e67 6574 5f62 696e 6469 6e67 2873  el.get_binding(s
-00014090: 656c 662e 6d6f 6465 6c2e 6765 745f 7265  elf.model.get_re
-000140a0: 6c61 7469 6f6e 2862 696e 6469 6e67 5f6e  lation(binding_n
-000140b0: 616d 6529 290a 2020 2020 2020 2020 7365  ame)).        se
-000140c0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-000140d0: 696e 6469 6e67 2e6e 6574 776f 726b 2e65  inding.network.e
-000140e0: 6772 6573 735f 7375 626e 6574 732c 205b  gress_subnets, [
-000140f0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00014100: 5f75 6e72 6573 6f6c 7665 645f 696e 6772  _unresolved_ingr
-00014110: 6573 735f 6164 6472 6573 7365 7328 7365  ess_addresses(se
-00014120: 6c66 293a 0a20 2020 2020 2020 2023 2073  lf):.        # s
-00014130: 6f6d 6574 696d 6573 206a 756a 7520 6661  ometimes juju fa
-00014140: 696c 7320 746f 2072 6573 6f6c 7665 2061  ils to resolve a
-00014150: 6e20 7572 6c20 746f 2061 6e20 4950 2c20  n url to an IP, 
-00014160: 696e 2077 6869 6368 2063 6173 650a 2020  in which case.  
-00014170: 2020 2020 2020 2320 696e 6772 6573 732d        # ingress-
-00014180: 6164 6472 6573 7365 7320 7769 6c6c 2062  addresses will b
-00014190: 6520 7468 6520 2772 6177 2720 7572 6c20  e the 'raw' url 
-000141a0: 696e 7374 6561 6420 6f66 2061 6e20 4950  instead of an IP
-000141b0: 2e0a 2020 2020 2020 2020 6e65 7477 6f72  ..        networ
-000141c0: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
-000141d0: 6d70 7328 7b0a 2020 2020 2020 2020 2020  mps({.          
-000141e0: 2020 2769 6e67 7265 7373 2d61 6464 7265    'ingress-addre
-000141f0: 7373 6573 273a 205b 0a20 2020 2020 2020  sses': [.       
-00014200: 2020 2020 2020 2020 2027 666f 6f2e 6261           'foo.ba
-00014210: 722e 6261 7a2e 636f 6d27 0a20 2020 2020  r.baz.com'.     
-00014220: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00014230: 2020 7d29 0a20 2020 2020 2020 2066 616b    }).        fak
-00014240: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00014250: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
-00014260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014270: 2020 6627 2727 5b20 2224 3122 203d 2064    f'''[ "$1" = d
-00014280: 6230 205d 2026 2620 6563 686f 2027 7b6e  b0 ] && echo '{n
-00014290: 6574 776f 726b 5f64 6174 617d 2720 7c7c  etwork_data}' ||
-000142a0: 2065 7869 7420 3127 2727 290a 2020 2020   exit 1''').    
-000142b0: 2020 2020 6269 6e64 696e 675f 6e61 6d65      binding_name
-000142c0: 203d 2027 6462 3027 0a20 2020 2020 2020   = 'db0'.       
-000142d0: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
-000142e0: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
-000142f0: 6728 7365 6c66 2e6d 6f64 656c 2e67 6574  g(self.model.get
-00014300: 5f72 656c 6174 696f 6e28 6269 6e64 696e  _relation(bindin
-00014310: 675f 6e61 6d65 2929 0a20 2020 2020 2020  g_name)).       
-00014320: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00014330: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
-00014340: 6b2e 696e 6772 6573 735f 6164 6472 6573  k.ingress_addres
-00014350: 7365 732c 205b 2766 6f6f 2e62 6172 2e62  ses, ['foo.bar.b
-00014360: 617a 2e63 6f6d 275d 290a 0a0a 636c 6173  az.com'])...clas
-00014370: 7320 5465 7374 4d6f 6465 6c42 6163 6b65  s TestModelBacke
-00014380: 6e64 2875 6e69 7474 6573 742e 5465 7374  nd(unittest.Test
-00014390: 4361 7365 293a 0a0a 2020 2020 6465 6620  Case):..    def 
-000143a0: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
-000143b0: 2020 2020 2073 656c 662e 5f62 6163 6b65       self._backe
-000143c0: 6e64 203d 204e 6f6e 650a 0a20 2020 2040  nd = None..    @
-000143d0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-000143e0: 2062 6163 6b65 6e64 2873 656c 6629 3a0a   backend(self):.
-000143f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00014400: 5f62 6163 6b65 6e64 2069 7320 4e6f 6e65  _backend is None
-00014410: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00014420: 6c66 2e5f 6261 636b 656e 6420 3d20 6f70  lf._backend = op
-00014430: 732e 6d6f 6465 6c2e 5f4d 6f64 656c 4261  s.model._ModelBa
-00014440: 636b 656e 6428 276d 7961 7070 2f30 2729  ckend('myapp/0')
-00014450: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00014460: 7365 6c66 2e5f 6261 636b 656e 640a 0a20  self._backend.. 
-00014470: 2020 2064 6566 2074 6573 745f 7265 6c61     def test_rela
-00014480: 7469 6f6e 5f67 6574 5f73 6574 5f69 735f  tion_get_set_is_
-00014490: 6170 705f 6172 6728 7365 6c66 293a 0a20  app_arg(self):. 
-000144a0: 2020 2020 2020 2023 204e 6f20 6973 5f61         # No is_a
-000144b0: 7070 2070 726f 7669 6465 642e 0a20 2020  pp provided..   
-000144c0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000144d0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
-000144e0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-000144f0: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
-00014500: 2e72 656c 6174 696f 6e5f 7365 7428 312c  .relation_set(1,
-00014510: 2027 666f 6f6b 6579 272c 2027 6261 7276   'fookey', 'barv
-00014520: 616c 2729 0a0a 2020 2020 2020 2020 7769  al')..        wi
-00014530: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00014540: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-00014550: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00014560: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
-00014570: 6f6e 5f67 6574 2831 2c20 2766 6f6f 656e  on_get(1, 'fooen
-00014580: 7469 7479 2729 0a0a 2020 2020 2020 2020  tity')..        
-00014590: 2320 496e 7661 6c69 6420 7479 7065 7320  # Invalid types 
-000145a0: 666f 7220 6973 5f61 7070 2e0a 2020 2020  for is_app..    
-000145b0: 2020 2020 666f 7220 6973 5f61 7070 5f76      for is_app_v
-000145c0: 2069 6e20 5b4e 6f6e 652c 2031 2c20 322e   in [None, 1, 2.
-000145d0: 302c 2027 6127 2c20 6227 6265 6566 275d  0, 'a', b'beef']
-000145e0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-000145f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00014600: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-00014610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014620: 2073 656c 662e 6261 636b 656e 642e 7265   self.backend.re
-00014630: 6c61 7469 6f6e 5f73 6574 2831 2c20 2766  lation_set(1, 'f
-00014640: 6f6f 6b65 7927 2c20 2762 6172 7661 6c27  ookey', 'barval'
-00014650: 2c20 6973 5f61 7070 3d69 735f 6170 705f  , is_app=is_app_
-00014660: 7629 0a0a 2020 2020 2020 2020 2020 2020  v)..            
-00014670: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00014680: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-00014690: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000146a0: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-000146b0: 7265 6c61 7469 6f6e 5f67 6574 2831 2c20  relation_get(1, 
-000146c0: 2766 6f6f 656e 7469 7479 272c 2069 735f  'fooentity', is_
-000146d0: 6170 703d 6973 5f61 7070 5f76 290a 0a20  app=is_app_v).. 
-000146e0: 2020 2064 6566 2074 6573 745f 6973 5f6c     def test_is_l
-000146f0: 6561 6465 725f 7265 6672 6573 6828 7365  eader_refresh(se
-00014700: 6c66 293a 0a20 2020 2020 2020 206d 6574  lf):.        met
-00014710: 6120 3d20 6f70 732e 6368 6172 6d2e 4368  a = ops.charm.Ch
-00014720: 6172 6d4d 6574 612e 6672 6f6d 5f79 616d  armMeta.from_yam
-00014730: 6c28 2727 270a 2020 2020 2020 2020 2020  l('''.          
-00014740: 2020 6e61 6d65 3a20 6d79 6170 700a 2020    name: myapp.  
-00014750: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00014760: 2020 206d 6f64 656c 203d 206f 7073 2e6d     model = ops.m
-00014770: 6f64 656c 2e4d 6f64 656c 286d 6574 612c  odel.Model(meta,
-00014780: 2073 656c 662e 6261 636b 656e 6429 0a20   self.backend). 
-00014790: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-000147a0: 7074 2873 656c 662c 2027 6973 2d6c 6561  pt(self, 'is-lea
-000147b0: 6465 7227 2c20 2765 6368 6f20 6661 6c73  der', 'echo fals
-000147c0: 6527 290a 2020 2020 2020 2020 7365 6c66  e').        self
-000147d0: 2e61 7373 6572 7446 616c 7365 286d 6f64  .assertFalse(mod
-000147e0: 656c 2e75 6e69 742e 6973 5f6c 6561 6465  el.unit.is_leade
-000147f0: 7228 2929 0a0a 2020 2020 2020 2020 2320  r())..        # 
-00014800: 4368 616e 6765 2074 6865 206c 6561 6465  Change the leade
-00014810: 7273 6869 7020 7374 6174 7573 0a20 2020  rship status.   
-00014820: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00014830: 2873 656c 662c 2027 6973 2d6c 6561 6465  (self, 'is-leade
-00014840: 7227 2c20 2765 6368 6f20 7472 7565 2729  r', 'echo true')
-00014850: 0a20 2020 2020 2020 2023 2049 6620 796f  .        # If yo
-00014860: 7520 646f 6e27 7420 666f 7263 6520 6974  u don't force it
-00014870: 2c20 7765 2064 6f6e 2774 2063 6865 636b  , we don't check
-00014880: 2c20 736f 2077 6520 776f 6e27 7420 7365  , so we won't se
-00014890: 6520 7468 6520 6368 616e 6765 0a20 2020  e the change.   
-000148a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000148b0: 4661 6c73 6528 6d6f 6465 6c2e 756e 6974  False(model.unit
-000148c0: 2e69 735f 6c65 6164 6572 2829 290a 2020  .is_leader()).  
-000148d0: 2020 2020 2020 2320 4966 2077 6520 666f        # If we fo
-000148e0: 7263 6520 6120 7265 6368 6563 6b2c 2074  rce a recheck, t
-000148f0: 6865 6e20 7765 206e 6f74 6963 650a 2020  hen we notice.  
-00014900: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
-00014910: 6e64 2e5f 6c65 6164 6572 5f63 6865 636b  nd._leader_check
-00014920: 5f74 696d 6520 3d20 4e6f 6e65 0a20 2020  _time = None.   
-00014930: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00014940: 5472 7565 286d 6f64 656c 2e75 6e69 742e  True(model.unit.
-00014950: 6973 5f6c 6561 6465 7228 2929 0a0a 2020  is_leader())..  
-00014960: 2020 2020 2020 2320 466f 7263 6520 6120        # Force a 
-00014970: 7265 6368 6563 6b20 7769 7468 6f75 7420  recheck without 
-00014980: 6368 616e 6769 6e67 2074 6865 206c 6561  changing the lea
-00014990: 6465 7273 6869 7020 7374 6174 7573 2e0a  dership status..
-000149a0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-000149b0: 6970 7428 7365 6c66 2c20 2769 732d 6c65  ipt(self, 'is-le
-000149c0: 6164 6572 272c 2027 6563 686f 2074 7275  ader', 'echo tru
-000149d0: 6527 290a 2020 2020 2020 2020 7365 6c66  e').        self
-000149e0: 2e62 6163 6b65 6e64 2e5f 6c65 6164 6572  .backend._leader
-000149f0: 5f63 6865 636b 5f74 696d 6520 3d20 4e6f  _check_time = No
-00014a00: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-00014a10: 6173 7365 7274 5472 7565 286d 6f64 656c  assertTrue(model
-00014a20: 2e75 6e69 742e 6973 5f6c 6561 6465 7228  .unit.is_leader(
-00014a30: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-00014a40: 5f72 656c 6174 696f 6e5f 746f 6f6c 5f65  _relation_tool_e
-00014a50: 7272 6f72 7328 7365 6c66 293a 0a20 2020  rrors(self):.   
-00014a60: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00014a70: 616e 7570 286f 732e 656e 7669 726f 6e2e  anup(os.environ.
-00014a80: 706f 702c 2027 4a55 4a55 5f56 4552 5349  pop, 'JUJU_VERSI
-00014a90: 4f4e 272c 204e 6f6e 6529 0a20 2020 2020  ON', None).     
-00014aa0: 2020 206f 732e 656e 7669 726f 6e5b 274a     os.environ['J
-00014ab0: 554a 555f 5645 5253 494f 4e27 5d20 3d20  UJU_VERSION'] = 
-00014ac0: 2732 2e38 2e30 270a 2020 2020 2020 2020  '2.8.0'.        
-00014ad0: 6572 725f 6d73 6720 3d20 2745 5252 4f52  err_msg = 'ERROR
-00014ae0: 2069 6e76 616c 6964 2076 616c 7565 2022   invalid value "
-00014af0: 2432 2220 666f 7220 6f70 7469 6f6e 202d  $2" for option -
-00014b00: 723a 2072 656c 6174 696f 6e20 6e6f 7420  r: relation not 
-00014b10: 666f 756e 6427 0a0a 2020 2020 2020 2020  found'..        
-00014b20: 7465 7374 5f63 6173 6573 203d 205b 280a  test_cases = [(.
-00014b30: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-00014b40: 6461 3a20 6661 6b65 5f73 6372 6970 7428  da: fake_script(
-00014b50: 7365 6c66 2c20 2772 656c 6174 696f 6e2d  self, 'relation-
-00014b60: 6c69 7374 272c 2027 6563 686f 2066 6f6f  list', 'echo foo
-00014b70: 6572 726f 7220 3e26 3220 3b20 6578 6974  error >&2 ; exit
-00014b80: 2031 2729 2c0a 2020 2020 2020 2020 2020   1'),.          
-00014b90: 2020 6c61 6d62 6461 3a20 7365 6c66 2e62    lambda: self.b
-00014ba0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00014bb0: 6c69 7374 2833 292c 0a20 2020 2020 2020  list(3),.       
-00014bc0: 2020 2020 206f 7073 2e6d 6f64 656c 2e4d       ops.model.M
-00014bd0: 6f64 656c 4572 726f 722c 0a20 2020 2020  odelError,.     
-00014be0: 2020 2020 2020 205b 5b27 7265 6c61 7469         [['relati
-00014bf0: 6f6e 2d6c 6973 7427 2c20 272d 7227 2c20  on-list', '-r', 
-00014c00: 2733 272c 2027 2d2d 666f 726d 6174 3d6a  '3', '--format=j
-00014c10: 736f 6e27 5d5d 2c0a 2020 2020 2020 2020  son']],.        
-00014c20: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-00014c30: 206c 616d 6264 613a 2066 616b 655f 7363   lambda: fake_sc
-00014c40: 7269 7074 2873 656c 662c 2027 7265 6c61  ript(self, 'rela
-00014c50: 7469 6f6e 2d6c 6973 7427 2c20 6627 6563  tion-list', f'ec
-00014c60: 686f 207b 6572 725f 6d73 677d 203e 2632  ho {err_msg} >&2
-00014c70: 203b 2065 7869 7420 3227 292c 0a20 2020   ; exit 2'),.   
-00014c80: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-00014c90: 2073 656c 662e 6261 636b 656e 642e 7265   self.backend.re
-00014ca0: 6c61 7469 6f6e 5f6c 6973 7428 3329 2c0a  lation_list(3),.
-00014cb0: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-00014cc0: 6d6f 6465 6c2e 5265 6c61 7469 6f6e 4e6f  model.RelationNo
-00014cd0: 7446 6f75 6e64 4572 726f 722c 0a20 2020  tFoundError,.   
-00014ce0: 2020 2020 2020 2020 205b 5b27 7265 6c61           [['rela
-00014cf0: 7469 6f6e 2d6c 6973 7427 2c20 272d 7227  tion-list', '-r'
-00014d00: 2c20 2733 272c 2027 2d2d 666f 726d 6174  , '3', '--format
-00014d10: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
-00014d20: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
-00014d30: 2020 206c 616d 6264 613a 2066 616b 655f     lambda: fake_
-00014d40: 7363 7269 7074 2873 656c 662c 2027 7265  script(self, 're
-00014d50: 6c61 7469 6f6e 2d73 6574 272c 2027 6563  lation-set', 'ec
-00014d60: 686f 2066 6f6f 6572 726f 7220 3e26 3220  ho fooerror >&2 
-00014d70: 3b20 6578 6974 2031 2729 2c0a 2020 2020  ; exit 1'),.    
-00014d80: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-00014d90: 7365 6c66 2e62 6163 6b65 6e64 2e72 656c  self.backend.rel
-00014da0: 6174 696f 6e5f 7365 7428 332c 2027 666f  ation_set(3, 'fo
-00014db0: 6f27 2c20 2762 6172 272c 2069 735f 6170  o', 'bar', is_ap
-00014dc0: 703d 4661 6c73 6529 2c0a 2020 2020 2020  p=False),.      
-00014dd0: 2020 2020 2020 6f70 732e 6d6f 6465 6c2e        ops.model.
+000114d0: 6e64 2828 276d 616b 655f 6469 7227 2c20  nd(('make_dir', 
+000114e0: 7061 7468 2c20 6d61 6b65 5f70 6172 656e  path, make_paren
+000114f0: 7473 2c20 7065 726d 6973 7369 6f6e 732c  ts, permissions,
+00011500: 2075 7365 725f 6964 2c20 7573 6572 2c0a   user_id, user,.
+00011510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011520: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+00011530: 6f75 705f 6964 2c20 6772 6f75 7029 290a  oup_id, group)).
+00011540: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+00011550: 7061 7468 2873 656c 662c 2070 6174 682c  path(self, path,
+00011560: 202a 2c20 7265 6375 7273 6976 653d 4661   *, recursive=Fa
+00011570: 6c73 6529 3a0a 2020 2020 2020 2020 7365  lse):.        se
+00011580: 6c66 2e72 6571 7565 7374 732e 6170 7065  lf.requests.appe
+00011590: 6e64 2828 2772 656d 6f76 655f 7061 7468  nd(('remove_path
+000115a0: 272c 2070 6174 682c 2072 6563 7572 7369  ', path, recursi
+000115b0: 7665 2929 0a0a 2020 2020 6465 6620 6578  ve))..    def ex
+000115c0: 6563 2873 656c 662c 2063 6f6d 6d61 6e64  ec(self, command
+000115d0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+000115e0: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+000115f0: 7473 2e61 7070 656e 6428 2827 6578 6563  ts.append(('exec
+00011600: 272c 2063 6f6d 6d61 6e64 2c20 6b77 6172  ', command, kwar
+00011610: 6773 2929 0a20 2020 2020 2020 2072 6574  gs)).        ret
+00011620: 7572 6e20 7365 6c66 2e72 6573 706f 6e73  urn self.respons
+00011630: 6573 2e70 6f70 2830 290a 0a20 2020 2064  es.pop(0)..    d
+00011640: 6566 2073 656e 645f 7369 676e 616c 2873  ef send_signal(s
+00011650: 656c 662c 2073 6967 6e61 6c2c 2073 6572  elf, signal, ser
+00011660: 7669 6365 5f6e 616d 6573 293a 0a20 2020  vice_names):.   
+00011670: 2020 2020 2073 656c 662e 7265 7175 6573       self.reques
+00011680: 7473 2e61 7070 656e 6428 2827 7365 6e64  ts.append(('send
+00011690: 5f73 6967 6e61 6c27 2c20 7369 676e 616c  _signal', signal
+000116a0: 2c20 7365 7276 6963 655f 6e61 6d65 7329  , service_names)
+000116b0: 290a 0a0a 636c 6173 7320 5465 7374 4d6f  )...class TestMo
+000116c0: 6465 6c42 696e 6469 6e67 7328 756e 6974  delBindings(unit
+000116d0: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
+000116e0: 0a20 2020 2064 6566 2073 6574 5570 2873  .    def setUp(s
+000116f0: 656c 6629 3a0a 2020 2020 2020 2020 6d65  elf):.        me
+00011700: 7461 203d 206f 7073 2e43 6861 726d 4d65  ta = ops.CharmMe
+00011710: 7461 2829 0a20 2020 2020 2020 206d 6574  ta().        met
+00011720: 612e 7265 6c61 7469 6f6e 7320 3d20 7b0a  a.relations = {.
+00011730: 2020 2020 2020 2020 2020 2020 2764 6230              'db0
+00011740: 273a 206f 7073 2e52 656c 6174 696f 6e4d  ': ops.RelationM
+00011750: 6574 6128 0a20 2020 2020 2020 2020 2020  eta(.           
+00011760: 2020 2020 206f 7073 2e52 656c 6174 696f       ops.Relatio
+00011770: 6e52 6f6c 652e 7072 6f76 6964 6573 2c20  nRole.provides, 
+00011780: 2764 6230 272c 207b 2769 6e74 6572 6661  'db0', {'interfa
+00011790: 6365 273a 2027 6462 3027 2c20 2773 636f  ce': 'db0', 'sco
+000117a0: 7065 273a 2027 676c 6f62 616c 277d 292c  pe': 'global'}),
+000117b0: 0a20 2020 2020 2020 2020 2020 2027 6462  .            'db
+000117c0: 3127 3a20 6f70 732e 5265 6c61 7469 6f6e  1': ops.Relation
+000117d0: 4d65 7461 280a 2020 2020 2020 2020 2020  Meta(.          
+000117e0: 2020 2020 2020 6f70 732e 5265 6c61 7469        ops.Relati
+000117f0: 6f6e 526f 6c65 2e72 6571 7569 7265 732c  onRole.requires,
+00011800: 2027 6462 3127 2c20 7b27 696e 7465 7266   'db1', {'interf
+00011810: 6163 6527 3a20 2764 6231 272c 2027 7363  ace': 'db1', 'sc
+00011820: 6f70 6527 3a20 2767 6c6f 6261 6c27 7d29  ope': 'global'})
+00011830: 2c0a 2020 2020 2020 2020 2020 2020 2764  ,.            'd
+00011840: 6232 273a 206f 7073 2e52 656c 6174 696f  b2': ops.Relatio
+00011850: 6e4d 6574 6128 0a20 2020 2020 2020 2020  nMeta(.         
+00011860: 2020 2020 2020 206f 7073 2e52 656c 6174         ops.Relat
+00011870: 696f 6e52 6f6c 652e 7065 6572 2c20 2764  ionRole.peer, 'd
+00011880: 6232 272c 207b 2769 6e74 6572 6661 6365  b2', {'interface
+00011890: 273a 2027 6462 3227 2c20 2773 636f 7065  ': 'db2', 'scope
+000118a0: 273a 2027 676c 6f62 616c 277d 292c 0a20  ': 'global'}),. 
+000118b0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000118c0: 2073 656c 662e 6261 636b 656e 6420 3d20   self.backend = 
+000118d0: 5f4d 6f64 656c 4261 636b 656e 6428 276d  _ModelBackend('m
+000118e0: 7961 7070 2f30 2729 0a20 2020 2020 2020  yapp/0').       
+000118f0: 2073 656c 662e 6d6f 6465 6c20 3d20 6f70   self.model = op
+00011900: 732e 4d6f 6465 6c28 6d65 7461 2c20 7365  s.Model(meta, se
+00011910: 6c66 2e62 6163 6b65 6e64 290a 0a20 2020  lf.backend)..   
+00011920: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00011930: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
+00011940: 2d69 6473 272c 0a20 2020 2020 2020 2020  -ids',.         
+00011950: 2020 2020 2020 2020 2020 2022 2222 285b             """([
+00011960: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
+00011970: 2065 6368 6f20 275b 2264 6230 3a34 225d   echo '["db0:4"]
+00011980: 2729 207c 7c20 6563 686f 2027 5b5d 2722  ') || echo '[]'"
+00011990: 2222 290a 2020 2020 2020 2020 6661 6b65  "").        fake
+000119a0: 5f73 6372 6970 7428 7365 6c66 2c20 2772  _script(self, 'r
+000119b0: 656c 6174 696f 6e2d 6c69 7374 272c 2022  elation-list', "
+000119c0: 2222 5b20 2224 3222 203d 2034 205d 2026  ""[ "$2" = 4 ] &
+000119d0: 2620 6563 686f 2027 5b22 7265 6d6f 7465  & echo '["remote
+000119e0: 6170 7031 2f30 225d 2720 7c7c 2065 7869  app1/0"]' || exi
+000119f0: 7420 3222 2222 290a 2020 2020 2020 2020  t 2""").        
+00011a00: 7365 6c66 2e6e 6574 776f 726b 5f67 6574  self.network_get
+00011a10: 5f6f 7574 203d 2027 2727 7b0a 2020 2262  _out = '''{.  "b
+00011a20: 696e 642d 6164 6472 6573 7365 7322 3a20  ind-addresses": 
+00011a30: 5b0a 2020 2020 7b0a 2020 2020 2020 226d  [.    {.      "m
+00011a40: 6163 2d61 6464 7265 7373 223a 2022 6465  ac-address": "de
+00011a50: 3a61 643a 6265 3a65 663a 6361 3a66 6522  :ad:be:ef:ca:fe"
+00011a60: 2c0a 2020 2020 2020 2269 6e74 6572 6661  ,.      "interfa
+00011a70: 6365 2d6e 616d 6522 3a20 226c 6f22 2c0a  ce-name": "lo",.
+00011a80: 2020 2020 2020 2261 6464 7265 7373 6573        "addresses
+00011a90: 223a 205b 0a20 2020 2020 2020 207b 0a20  ": [.        {. 
+00011aa0: 2020 2020 2020 2020 2022 686f 7374 6e61           "hostna
+00011ab0: 6d65 223a 2022 222c 0a20 2020 2020 2020  me": "",.       
+00011ac0: 2020 2022 7661 6c75 6522 3a20 2231 3932     "value": "192
+00011ad0: 2e30 2e32 2e32 222c 0a20 2020 2020 2020  .0.2.2",.       
+00011ae0: 2020 2022 6369 6472 223a 2022 3139 322e     "cidr": "192.
+00011af0: 302e 322e 302f 3234 220a 2020 2020 2020  0.2.0/24".      
+00011b00: 2020 7d2c 0a20 2020 2020 2020 207b 0a20    },.        {. 
+00011b10: 2020 2020 2020 2020 2022 686f 7374 6e61           "hostna
+00011b20: 6d65 223a 2022 6465 6164 6265 6566 2e65  me": "deadbeef.e
+00011b30: 7861 6d70 6c65 222c 0a20 2020 2020 2020  xample",.       
+00011b40: 2020 2022 7661 6c75 6522 3a20 2264 6561     "value": "dea
+00011b50: 643a 6265 6566 3a3a 3122 2c0a 2020 2020  d:beef::1",.    
+00011b60: 2020 2020 2020 2263 6964 7222 3a20 2264        "cidr": "d
+00011b70: 6561 643a 6265 6566 3a3a 2f36 3422 0a20  ead:beef::/64". 
+00011b80: 2020 2020 2020 207d 0a20 2020 2020 205d         }.      ]
+00011b90: 0a20 2020 207d 2c0a 2020 2020 7b0a 2020  .    },.    {.  
+00011ba0: 2020 2020 226d 6163 2d61 6464 7265 7373      "mac-address
+00011bb0: 223a 2022 222c 0a20 2020 2020 2022 696e  ": "",.      "in
+00011bc0: 7465 7266 6163 652d 6e61 6d65 223a 2022  terface-name": "
+00011bd0: 7475 6e22 2c0a 2020 2020 2020 2261 6464  tun",.      "add
+00011be0: 7265 7373 6573 223a 205b 0a20 2020 2020  resses": [.     
+00011bf0: 2020 207b 0a20 2020 2020 2020 2020 2022     {.          "
+00011c00: 686f 7374 6e61 6d65 223a 2022 222c 0a20  hostname": "",. 
+00011c10: 2020 2020 2020 2020 2022 7661 6c75 6522           "value"
+00011c20: 3a20 2231 3932 2e30 2e33 2e33 222c 0a20  : "192.0.3.3",. 
+00011c30: 2020 2020 2020 2020 2022 6369 6472 223a           "cidr":
+00011c40: 2022 220a 2020 2020 2020 2020 7d2c 0a20   "".        },. 
+00011c50: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00011c60: 2020 2022 686f 7374 6e61 6d65 223a 2022     "hostname": "
+00011c70: 222c 0a20 2020 2020 2020 2020 2022 7661  ",.          "va
+00011c80: 6c75 6522 3a20 2232 3030 313a 6462 383a  lue": "2001:db8:
+00011c90: 3a33 222c 0a20 2020 2020 2020 2020 2022  :3",.          "
+00011ca0: 6369 6472 223a 2022 220a 2020 2020 2020  cidr": "".      
+00011cb0: 2020 7d2c 0a20 2020 2020 2020 207b 0a20    },.        {. 
+00011cc0: 2020 2020 2020 2020 2022 686f 7374 6e61           "hostna
+00011cd0: 6d65 223a 2022 6465 6164 6265 6566 2e6c  me": "deadbeef.l
+00011ce0: 6f63 616c 222c 0a20 2020 2020 2020 2020  ocal",.         
+00011cf0: 2022 7661 6c75 6522 3a20 2266 6538 303a   "value": "fe80:
+00011d00: 3a31 3a31 222c 0a20 2020 2020 2020 2020  :1:1",.         
+00011d10: 2022 6369 6472 223a 2022 6665 3830 3a3a   "cidr": "fe80::
+00011d20: 2f36 3422 0a20 2020 2020 2020 207d 0a20  /64".        }. 
+00011d30: 2020 2020 205d 0a20 2020 207d 0a20 205d       ].    }.  ]
+00011d40: 2c0a 2020 2265 6772 6573 732d 7375 626e  ,.  "egress-subn
+00011d50: 6574 7322 3a20 5b0a 2020 2020 2231 3932  ets": [.    "192
+00011d60: 2e30 2e32 2e32 2f33 3222 2c0a 2020 2020  .0.2.2/32",.    
+00011d70: 2231 3932 2e30 2e33 2e30 2f32 3422 2c0a  "192.0.3.0/24",.
+00011d80: 2020 2020 2264 6561 643a 6265 6566 3a3a      "dead:beef::
+00011d90: 2f36 3422 2c0a 2020 2020 2232 3030 313a  /64",.    "2001:
+00011da0: 6462 383a 3a33 2f31 3238 220a 2020 5d2c  db8::3/128".  ],
+00011db0: 0a20 2022 696e 6772 6573 732d 6164 6472  .  "ingress-addr
+00011dc0: 6573 7365 7322 3a20 5b0a 2020 2020 2231  esses": [.    "1
+00011dd0: 3932 2e30 2e32 2e32 222c 0a20 2020 2022  92.0.2.2",.    "
+00011de0: 3139 322e 302e 332e 3322 2c0a 2020 2020  192.0.3.3",.    
+00011df0: 2264 6561 643a 6265 6566 3a3a 3122 2c0a  "dead:beef::1",.
+00011e00: 2020 2020 2232 3030 313a 6462 383a 3a33      "2001:db8::3
+00011e10: 220a 2020 5d0a 7d27 2727 0a0a 2020 2020  ".  ].}'''..    
+00011e20: 6465 6620 5f63 6865 636b 5f62 696e 6469  def _check_bindi
+00011e30: 6e67 5f64 6174 6128 7365 6c66 2c20 6269  ng_data(self, bi
+00011e40: 6e64 696e 675f 6e61 6d65 2c20 6269 6e64  nding_name, bind
+00011e50: 696e 6729 3a0a 2020 2020 2020 2020 7365  ing):.        se
+00011e60: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
+00011e70: 696e 6469 6e67 2e6e 616d 652c 2062 696e  inding.name, bin
+00011e80: 6469 6e67 5f6e 616d 6529 0a20 2020 2020  ding_name).     
+00011e90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00011ea0: 7561 6c28 6269 6e64 696e 672e 6e65 7477  ual(binding.netw
+00011eb0: 6f72 6b2e 6269 6e64 5f61 6464 7265 7373  ork.bind_address
+00011ec0: 2c20 6970 6164 6472 6573 732e 6970 5f61  , ipaddress.ip_a
+00011ed0: 6464 7265 7373 2827 3139 322e 302e 322e  ddress('192.0.2.
+00011ee0: 3227 2929 0a20 2020 2020 2020 2073 656c  2')).        sel
+00011ef0: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
+00011f00: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
+00011f10: 6772 6573 735f 6164 6472 6573 732c 2069  gress_address, i
+00011f20: 7061 6464 7265 7373 2e69 705f 6164 6472  paddress.ip_addr
+00011f30: 6573 7328 2731 3932 2e30 2e32 2e32 2729  ess('192.0.2.2')
+00011f40: 290a 2020 2020 2020 2020 2320 2f33 3220  ).        # /32 
+00011f50: 616e 6420 2f31 3238 2043 4944 5273 2061  and /128 CIDRs a
+00011f60: 7265 2076 616c 6964 206f 6e65 2d61 6464  re valid one-add
+00011f70: 7265 7373 206e 6574 776f 726b 7320 666f  ress networks fo
+00011f80: 7220 4950 767b 342c 367d 4e65 7477 6f72  r IPv{4,6}Networ
+00011f90: 6b20 7479 7065 7320 7265 7370 6563 7469  k types respecti
+00011fa0: 7665 6c79 2e0a 2020 2020 2020 2020 7365  vely..        se
+00011fb0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
+00011fc0: 696e 6469 6e67 2e6e 6574 776f 726b 2e65  inding.network.e
+00011fd0: 6772 6573 735f 7375 626e 6574 732c 205b  gress_subnets, [
+00011fe0: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
+00011ff0: 776f 726b 2827 3139 322e 302e 322e 322f  work('192.0.2.2/
+00012000: 3332 2729 2c0a 2020 2020 2020 2020 2020  32'),.          
+00012010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012040: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
+00012050: 776f 726b 2827 3139 322e 302e 332e 302f  work('192.0.3.0/
+00012060: 3234 2729 2c0a 2020 2020 2020 2020 2020  24'),.          
+00012070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000120a0: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
+000120b0: 776f 726b 2827 6465 6164 3a62 6565 663a  work('dead:beef:
+000120c0: 3a2f 3634 2729 2c0a 2020 2020 2020 2020  :/64'),.        
+000120d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000120e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000120f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012100: 2020 6970 6164 6472 6573 732e 6970 5f6e    ipaddress.ip_n
+00012110: 6574 776f 726b 2827 3230 3031 3a64 6238  etwork('2001:db8
+00012120: 3a3a 332f 3132 3827 295d 290a 0a20 2020  ::3/128')])..   
+00012130: 2020 2020 2066 6f72 2028 692c 2028 6e61       for (i, (na
+00012140: 6d65 2c20 6164 6472 6573 732c 2073 7562  me, address, sub
+00012150: 6e65 7429 2920 696e 2065 6e75 6d65 7261  net)) in enumera
+00012160: 7465 285b 0a20 2020 2020 2020 2020 2020  te([.           
+00012170: 2020 2020 2028 276c 6f27 2c20 2731 3932       ('lo', '192
+00012180: 2e30 2e32 2e32 272c 2027 3139 322e 302e  .0.2.2', '192.0.
+00012190: 322e 302f 3234 2729 2c0a 2020 2020 2020  2.0/24'),.      
+000121a0: 2020 2020 2020 2020 2020 2827 6c6f 272c            ('lo',
+000121b0: 2027 6465 6164 3a62 6565 663a 3a31 272c   'dead:beef::1',
+000121c0: 2027 6465 6164 3a62 6565 663a 3a2f 3634   'dead:beef::/64
+000121d0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+000121e0: 2020 2020 2827 7475 6e27 2c20 2731 3932      ('tun', '192
+000121f0: 2e30 2e33 2e33 272c 2027 3139 322e 302e  .0.3.3', '192.0.
+00012200: 332e 332f 3332 2729 2c0a 2020 2020 2020  3.3/32'),.      
+00012210: 2020 2020 2020 2020 2020 2827 7475 6e27            ('tun'
+00012220: 2c20 2732 3030 313a 6462 383a 3a33 272c  , '2001:db8::3',
+00012230: 2027 3230 3031 3a64 6238 3a3a 332f 3132   '2001:db8::3/12
+00012240: 3827 292c 0a20 2020 2020 2020 2020 2020  8'),.           
+00012250: 2020 2020 2028 2774 756e 272c 2027 6665       ('tun', 'fe
+00012260: 3830 3a3a 313a 3127 2c20 2766 6538 303a  80::1:1', 'fe80:
+00012270: 3a2f 3634 2729 5d29 3a0a 2020 2020 2020  :/64')]):.      
+00012280: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00012290: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
+000122a0: 6574 776f 726b 2e69 6e74 6572 6661 6365  etwork.interface
+000122b0: 735b 695d 2e6e 616d 652c 206e 616d 6529  s[i].name, name)
+000122c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000122d0: 662e 6173 7365 7274 4571 7561 6c28 6269  f.assertEqual(bi
+000122e0: 6e64 696e 672e 6e65 7477 6f72 6b2e 696e  nding.network.in
+000122f0: 7465 7266 6163 6573 5b69 5d2e 6164 6472  terfaces[i].addr
+00012300: 6573 732c 2069 7061 6464 7265 7373 2e69  ess, ipaddress.i
+00012310: 705f 6164 6472 6573 7328 6164 6472 6573  p_address(addres
+00012320: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+00012330: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012340: 2862 696e 6469 6e67 2e6e 6574 776f 726b  (binding.network
+00012350: 2e69 6e74 6572 6661 6365 735b 695d 2e73  .interfaces[i].s
+00012360: 7562 6e65 742c 2069 7061 6464 7265 7373  ubnet, ipaddress
+00012370: 2e69 705f 6e65 7477 6f72 6b28 7375 626e  .ip_network(subn
+00012380: 6574 2929 0a0a 2020 2020 2020 2020 666f  et))..        fo
+00012390: 7220 2869 2c20 286e 616d 652c 2061 6464  r (i, (name, add
+000123a0: 7265 7373 2c20 7375 626e 6574 2929 2069  ress, subnet)) i
+000123b0: 6e20 656e 756d 6572 6174 6528 5b0a 2020  n enumerate([.  
+000123c0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+000123d0: 6c6f 272c 2027 3139 322e 302e 322e 3227  lo', '192.0.2.2'
+000123e0: 2c20 2731 3932 2e30 2e32 2e30 2f32 3427  , '192.0.2.0/24'
+000123f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00012400: 2020 2028 276c 6f27 2c20 2764 6561 643a     ('lo', 'dead:
+00012410: 6265 6566 3a3a 3127 2c20 2764 6561 643a  beef::1', 'dead:
+00012420: 6265 6566 3a3a 2f36 3427 292c 0a20 2020  beef::/64'),.   
+00012430: 2020 2020 2020 2020 2020 2020 2028 2774               ('t
+00012440: 756e 272c 2027 3139 322e 302e 332e 3327  un', '192.0.3.3'
+00012450: 2c20 2731 3932 2e30 2e33 2e33 2f33 3227  , '192.0.3.3/32'
+00012460: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00012470: 2020 2028 2774 756e 272c 2027 3230 3031     ('tun', '2001
+00012480: 3a64 6238 3a3a 3327 2c20 2732 3030 313a  :db8::3', '2001:
+00012490: 6462 383a 3a33 2f31 3238 2729 2c0a 2020  db8::3/128'),.  
+000124a0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+000124b0: 7475 6e27 2c20 2766 6538 303a 3a31 3a31  tun', 'fe80::1:1
+000124c0: 272c 2027 6665 3830 3a3a 2f36 3427 295d  ', 'fe80::/64')]
+000124d0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000124e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000124f0: 6269 6e64 696e 672e 6e65 7477 6f72 6b2e  binding.network.
+00012500: 696e 7465 7266 6163 6573 5b69 5d2e 6e61  interfaces[i].na
+00012510: 6d65 2c20 6e61 6d65 290a 2020 2020 2020  me, name).      
+00012520: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00012530: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
+00012540: 6574 776f 726b 2e69 6e74 6572 6661 6365  etwork.interface
+00012550: 735b 695d 2e61 6464 7265 7373 2c20 6970  s[i].address, ip
+00012560: 6164 6472 6573 732e 6970 5f61 6464 7265  address.ip_addre
+00012570: 7373 2861 6464 7265 7373 2929 0a20 2020  ss(address)).   
+00012580: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+00012590: 7365 7274 4571 7561 6c28 6269 6e64 696e  sertEqual(bindin
+000125a0: 672e 6e65 7477 6f72 6b2e 696e 7465 7266  g.network.interf
+000125b0: 6163 6573 5b69 5d2e 7375 626e 6574 2c20  aces[i].subnet, 
+000125c0: 6970 6164 6472 6573 732e 6970 5f6e 6574  ipaddress.ip_net
+000125d0: 776f 726b 2873 7562 6e65 7429 290a 0a20  work(subnet)).. 
+000125e0: 2020 2064 6566 2074 6573 745f 696e 7661     def test_inva
+000125f0: 6c69 645f 6b65 7973 2873 656c 6629 3a0a  lid_keys(self):.
+00012600: 2020 2020 2020 2020 2320 4261 7369 6320          # Basic 
+00012610: 7661 6c69 6461 7469 6f6e 2066 6f72 2070  validation for p
+00012620: 6173 7369 6e67 2069 6e76 616c 6964 206b  assing invalid k
+00012630: 6579 732e 0a20 2020 2020 2020 2066 6f72  eys..        for
+00012640: 206e 616d 6520 696e 2028 6f62 6a65 6374   name in (object
+00012650: 2c20 3029 3a0a 2020 2020 2020 2020 2020  , 0):.          
+00012660: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00012670: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
+00012680: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
+00012690: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+000126a0: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
+000126b0: 286e 616d 6529 0a0a 2020 2020 6465 6620  (name)..    def 
+000126c0: 7465 7374 5f64 6561 645f 7265 6c61 7469  test_dead_relati
+000126d0: 6f6e 7328 7365 6c66 293a 0a20 2020 2020  ons(self):.     
+000126e0: 2020 2066 616b 655f 7363 7269 7074 280a     fake_script(.
+000126f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012700: 2c0a 2020 2020 2020 2020 2020 2020 276e  ,.            'n
+00012710: 6574 776f 726b 2d67 6574 272c 0a20 2020  etwork-get',.   
+00012720: 2020 2020 2020 2020 2066 2727 270a 2020           f'''.  
+00012730: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00012740: 205b 2022 2431 2220 3d20 6462 3020 5d20   [ "$1" = db0 ] 
+00012750: 2626 205b 2022 2432 2220 3d20 2d2d 666f  && [ "$2" = --fo
+00012760: 726d 6174 3d6a 736f 6e20 5d3b 2074 6865  rmat=json ]; the
+00012770: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00012780: 2020 2020 2020 6563 686f 2027 7b73 656c        echo '{sel
+00012790: 662e 6e65 7477 6f72 6b5f 6765 745f 6f75  f.network_get_ou
+000127a0: 747d 270a 2020 2020 2020 2020 2020 2020  t}'.            
+000127b0: 2020 2020 656c 7365 0a20 2020 2020 2020      else.       
+000127c0: 2020 2020 2020 2020 2020 2020 2065 6368               ech
+000127d0: 6f20 4552 524f 5220 696e 7661 6c69 6420  o ERROR invalid 
+000127e0: 7661 6c75 6520 2224 3222 2066 6f72 206f  value "$2" for o
+000127f0: 7074 696f 6e20 2d72 3a20 7265 6c61 7469  ption -r: relati
+00012800: 6f6e 206e 6f74 2066 6f75 6e64 203e 2632  on not found >&2
+00012810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012820: 2020 2020 2065 7869 7420 320a 2020 2020       exit 2.    
+00012830: 2020 2020 2020 2020 2020 2020 6669 0a20              fi. 
+00012840: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00012850: 2020 2020 2020 2020 2320 5661 6c69 6461          # Valida
+00012860: 7465 2074 6865 2062 6568 6176 696f 7220  te the behavior 
+00012870: 666f 7220 6465 6164 2072 656c 6174 696f  for dead relatio
+00012880: 6e73 2e0a 2020 2020 2020 2020 6269 6e64  ns..        bind
+00012890: 696e 6720 3d20 6f70 732e 4269 6e64 696e  ing = ops.Bindin
+000128a0: 6728 2764 6230 272c 2034 322c 2073 656c  g('db0', 42, sel
+000128b0: 662e 6d6f 6465 6c2e 5f62 6163 6b65 6e64  f.model._backend
+000128c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000128d0: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
+000128e0: 6e67 2e6e 6574 776f 726b 2e62 696e 645f  ng.network.bind_
+000128f0: 6164 6472 6573 732c 2069 7061 6464 7265  address, ipaddre
+00012900: 7373 2e69 705f 6164 6472 6573 7328 2731  ss.ip_address('1
+00012910: 3932 2e30 2e32 2e32 2729 290a 2020 2020  92.0.2.2')).    
+00012920: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00012930: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+00012940: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+00012950: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
+00012960: 2020 2020 2020 2020 5b27 6e65 7477 6f72          ['networ
+00012970: 6b2d 6765 7427 2c20 2764 6230 272c 2027  k-get', 'db0', '
+00012980: 2d72 272c 2027 3432 272c 2027 2d2d 666f  -r', '42', '--fo
+00012990: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
+000129a0: 2020 2020 2020 2020 205b 276e 6574 776f           ['netwo
+000129b0: 726b 2d67 6574 272c 2027 6462 3027 2c20  rk-get', 'db0', 
+000129c0: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
+000129d0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+000129e0: 2020 6465 6620 7465 7374 5f62 696e 6469    def test_bindi
+000129f0: 6e67 5f62 795f 7265 6c61 7469 6f6e 5f6e  ng_by_relation_n
+00012a00: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
+00012a10: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00012a20: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
+00012a30: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+00012a40: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
+00012a50: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
+00012a60: 686f 2027 7b73 656c 662e 6e65 7477 6f72  ho '{self.networ
+00012a70: 6b5f 6765 745f 6f75 747d 2720 7c7c 2065  k_get_out}' || e
+00012a80: 7869 7420 3127 2727 290a 2020 2020 2020  xit 1''').      
+00012a90: 2020 6269 6e64 696e 675f 6e61 6d65 203d    binding_name =
+00012aa0: 2027 6462 3027 0a20 2020 2020 2020 2065   'db0'.        e
+00012ab0: 7870 6563 7465 645f 6361 6c6c 7320 3d20  xpected_calls = 
+00012ac0: 5b5b 276e 6574 776f 726b 2d67 6574 272c  [['network-get',
+00012ad0: 2027 6462 3027 2c20 272d 2d66 6f72 6d61   'db0', '--forma
+00012ae0: 743d 6a73 6f6e 275d 5d0a 0a20 2020 2020  t=json']]..     
+00012af0: 2020 2062 696e 6469 6e67 203d 2073 656c     binding = sel
+00012b00: 662e 6d6f 6465 6c2e 6765 745f 6269 6e64  f.model.get_bind
+00012b10: 696e 6728 6269 6e64 696e 675f 6e61 6d65  ing(binding_name
+00012b20: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+00012b30: 6368 6563 6b5f 6269 6e64 696e 675f 6461  check_binding_da
+00012b40: 7461 2862 696e 6469 6e67 5f6e 616d 652c  ta(binding_name,
+00012b50: 2062 696e 6469 6e67 290a 2020 2020 2020   binding).      
+00012b60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00012b70: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+00012b80: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+00012b90: 3d54 7275 6529 2c20 6578 7065 6374 6564  =True), expected
+00012ba0: 5f63 616c 6c73 290a 0a20 2020 2064 6566  _calls)..    def
+00012bb0: 2074 6573 745f 6269 6e64 696e 675f 6279   test_binding_by
+00012bc0: 5f72 656c 6174 696f 6e28 7365 6c66 293a  _relation(self):
+00012bd0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00012be0: 7269 7074 2873 656c 662c 2027 6e65 7477  ript(self, 'netw
+00012bf0: 6f72 6b2d 6765 7427 2c0a 2020 2020 2020  ork-get',.      
+00012c00: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00012c10: 2727 5b20 2224 3122 203d 2064 6230 205d  ''[ "$1" = db0 ]
+00012c20: 2026 2620 6563 686f 2027 7b73 656c 662e   && echo '{self.
+00012c30: 6e65 7477 6f72 6b5f 6765 745f 6f75 747d  network_get_out}
+00012c40: 2720 7c7c 2065 7869 7420 3127 2727 290a  ' || exit 1''').
+00012c50: 2020 2020 2020 2020 6269 6e64 696e 675f          binding_
+00012c60: 6e61 6d65 203d 2027 6462 3027 0a20 2020  name = 'db0'.   
+00012c70: 2020 2020 2065 7870 6563 7465 645f 6361       expected_ca
+00012c80: 6c6c 7320 3d20 5b0a 2020 2020 2020 2020  lls = [.        
+00012c90: 2020 2020 5b27 7265 6c61 7469 6f6e 2d69      ['relation-i
+00012ca0: 6473 272c 2027 6462 3027 2c20 272d 2d66  ds', 'db0', '--f
+00012cb0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
+00012cc0: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00012cd0: 7477 6f20 696e 766f 6361 7469 6f6e 7320  two invocations 
+00012ce0: 6265 6c6f 7720 6172 6520 6475 6520 746f  below are due to
+00012cf0: 2074 6865 2067 6574 5f72 656c 6174 696f   the get_relatio
+00012d00: 6e20 6361 6c6c 2e0a 2020 2020 2020 2020  n call..        
+00012d10: 2020 2020 5b27 7265 6c61 7469 6f6e 2d6c      ['relation-l
+00012d20: 6973 7427 2c20 272d 7227 2c20 2734 272c  ist', '-r', '4',
+00012d30: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
+00012d40: 5d2c 0a20 2020 2020 2020 2020 2020 205b  ],.            [
+00012d50: 276e 6574 776f 726b 2d67 6574 272c 2027  'network-get', '
+00012d60: 6462 3027 2c20 272d 7227 2c20 2734 272c  db0', '-r', '4',
+00012d70: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
+00012d80: 5d2c 0a20 2020 2020 2020 205d 0a20 2020  ],.        ].   
+00012d90: 2020 2020 2062 696e 6469 6e67 203d 2073       binding = s
+00012da0: 656c 662e 6d6f 6465 6c2e 6765 745f 6269  elf.model.get_bi
+00012db0: 6e64 696e 6728 7365 6c66 2e6d 6f64 656c  nding(self.model
+00012dc0: 2e67 6574 5f72 656c 6174 696f 6e28 6269  .get_relation(bi
+00012dd0: 6e64 696e 675f 6e61 6d65 2929 0a20 2020  nding_name)).   
+00012de0: 2020 2020 2073 656c 662e 5f63 6865 636b       self._check
+00012df0: 5f62 696e 6469 6e67 5f64 6174 6128 6269  _binding_data(bi
+00012e00: 6e64 696e 675f 6e61 6d65 2c20 6269 6e64  nding_name, bind
+00012e10: 696e 6729 0a20 2020 2020 2020 2073 656c  ing).        sel
+00012e20: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+00012e30: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00012e40: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+00012e50: 292c 2065 7870 6563 7465 645f 6361 6c6c  ), expected_call
+00012e60: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
+00012e70: 5f62 696e 6469 6e67 5f6e 6f5f 6966 6163  _binding_no_ifac
+00012e80: 655f 6e61 6d65 2873 656c 6629 3a0a 2020  e_name(self):.  
+00012e90: 2020 2020 2020 6e65 7477 6f72 6b5f 6765        network_ge
+00012ea0: 745f 6f75 745f 6f62 6a20 3d20 7b0a 2020  t_out_obj = {.  
+00012eb0: 2020 2020 2020 2020 2020 2762 696e 642d            'bind-
+00012ec0: 6164 6472 6573 7365 7327 3a20 5b0a 2020  addresses': [.  
+00012ed0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+00012ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ef0: 2020 2020 276d 6163 2d61 6464 7265 7373      'mac-address
+00012f00: 273a 2027 272c 0a20 2020 2020 2020 2020  ': '',.         
+00012f10: 2020 2020 2020 2020 2020 2027 696e 7465             'inte
+00012f20: 7266 6163 652d 6e61 6d65 273a 2027 272c  rface-name': '',
+00012f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012f40: 2020 2020 2027 6164 6472 6573 7365 7327       'addresses'
+00012f50: 3a20 5b0a 2020 2020 2020 2020 2020 2020  : [.            
+00012f60: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f80: 2020 2020 2020 2020 2020 2768 6f73 746e            'hostn
+00012f90: 616d 6527 3a20 2727 2c0a 2020 2020 2020  ame': '',.      
+00012fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012fb0: 2020 2020 2020 2776 616c 7565 273a 2027        'value': '
+00012fc0: 3130 2e31 2e38 392e 3335 272c 0a20 2020  10.1.89.35',.   
+00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012fe0: 2020 2020 2020 2020 2027 6369 6472 273a           'cidr':
+00012ff0: 2027 270a 2020 2020 2020 2020 2020 2020   ''.            
+00013000: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00013010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013020: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00013030: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00013040: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00013050: 2027 6567 7265 7373 2d73 7562 6e65 7473   'egress-subnets
+00013060: 273a 205b 0a20 2020 2020 2020 2020 2020  ': [.           
+00013070: 2020 2020 2027 3130 2e31 3532 2e31 3833       '10.152.183
+00013080: 2e31 3538 2f33 3227 0a20 2020 2020 2020  .158/32'.       
+00013090: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000130a0: 2020 2020 2769 6e67 7265 7373 2d61 6464      'ingress-add
+000130b0: 7265 7373 6573 273a 205b 0a20 2020 2020  resses': [.     
+000130c0: 2020 2020 2020 2020 2020 2027 3130 2e31             '10.1
+000130d0: 3532 2e31 3833 2e31 3538 270a 2020 2020  52.183.158'.    
+000130e0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+000130f0: 2020 7d0a 2020 2020 2020 2020 6e65 7477    }.        netw
+00013100: 6f72 6b5f 6765 745f 6f75 7420 3d20 6a73  ork_get_out = js
+00013110: 6f6e 2e64 756d 7073 286e 6574 776f 726b  on.dumps(network
+00013120: 5f67 6574 5f6f 7574 5f6f 626a 290a 2020  _get_out_obj).  
+00013130: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+00013140: 7428 7365 6c66 2c20 276e 6574 776f 726b  t(self, 'network
+00013150: 2d67 6574 272c 0a20 2020 2020 2020 2020  -get',.         
+00013160: 2020 2020 2020 2020 2020 2066 2727 275b             f'''[
+00013170: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
+00013180: 2065 6368 6f20 277b 6e65 7477 6f72 6b5f   echo '{network_
+00013190: 6765 745f 6f75 747d 2720 7c7c 2065 7869  get_out}' || exi
+000131a0: 7420 3127 2727 290a 2020 2020 2020 2020  t 1''').        
+000131b0: 6269 6e64 696e 675f 6e61 6d65 203d 2027  binding_name = '
+000131c0: 6462 3027 0a20 2020 2020 2020 2065 7870  db0'.        exp
+000131d0: 6563 7465 645f 6361 6c6c 7320 3d20 5b5b  ected_calls = [[
+000131e0: 276e 6574 776f 726b 2d67 6574 272c 2027  'network-get', '
+000131f0: 6462 3027 2c20 272d 2d66 6f72 6d61 743d  db0', '--format=
+00013200: 6a73 6f6e 275d 5d0a 0a20 2020 2020 2020  json']]..       
+00013210: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
+00013220: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
+00013230: 6728 6269 6e64 696e 675f 6e61 6d65 290a  g(binding_name).
+00013240: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00013250: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+00013260: 2e6e 616d 652c 2027 6462 3027 290a 2020  .name, 'db0').  
+00013270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013280: 7445 7175 616c 2862 696e 6469 6e67 2e6e  tEqual(binding.n
+00013290: 6574 776f 726b 2e62 696e 645f 6164 6472  etwork.bind_addr
+000132a0: 6573 732c 2069 7061 6464 7265 7373 2e69  ess, ipaddress.i
+000132b0: 705f 6164 6472 6573 7328 2731 302e 312e  p_address('10.1.
+000132c0: 3839 2e33 3527 2929 0a20 2020 2020 2020  89.35')).       
+000132d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000132e0: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
+000132f0: 6b2e 696e 6772 6573 735f 6164 6472 6573  k.ingress_addres
+00013300: 732c 2069 7061 6464 7265 7373 2e69 705f  s, ipaddress.ip_
+00013310: 6164 6472 6573 7328 2731 302e 3135 322e  address('10.152.
+00013320: 3138 332e 3135 3827 2929 0a20 2020 2020  183.158')).     
+00013330: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00013340: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+00013350: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+00013360: 723d 5472 7565 292c 2065 7870 6563 7465  r=True), expecte
+00013370: 645f 6361 6c6c 7329 0a0a 2020 2020 6465  d_calls)..    de
+00013380: 6620 7465 7374 5f6d 6973 7369 6e67 5f62  f test_missing_b
+00013390: 696e 645f 6164 6472 6573 7365 7328 7365  ind_addresses(se
+000133a0: 6c66 293a 0a20 2020 2020 2020 206e 6574  lf):.        net
+000133b0: 776f 726b 5f64 6174 6120 3d20 6a73 6f6e  work_data = json
+000133c0: 2e64 756d 7073 287b 7d29 0a20 2020 2020  .dumps({}).     
+000133d0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+000133e0: 656c 662c 2027 6e65 7477 6f72 6b2d 6765  elf, 'network-ge
+000133f0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+00013400: 2020 2020 2020 2020 6627 2727 5b20 2224          f'''[ "$
+00013410: 3122 203d 2064 6230 205d 2026 2620 6563  1" = db0 ] && ec
+00013420: 686f 2027 7b6e 6574 776f 726b 5f64 6174  ho '{network_dat
+00013430: 617d 2720 7c7c 2065 7869 7420 3127 2727  a}' || exit 1'''
+00013440: 290a 2020 2020 2020 2020 6269 6e64 696e  ).        bindin
+00013450: 675f 6e61 6d65 203d 2027 6462 3027 0a20  g_name = 'db0'. 
+00013460: 2020 2020 2020 2062 696e 6469 6e67 203d         binding =
+00013470: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+00013480: 6269 6e64 696e 6728 7365 6c66 2e6d 6f64  binding(self.mod
+00013490: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
+000134a0: 6269 6e64 696e 675f 6e61 6d65 2929 0a20  binding_name)). 
+000134b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000134c0: 7274 4571 7561 6c28 6269 6e64 696e 672e  rtEqual(binding.
+000134d0: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
+000134e0: 6573 2c20 5b5d 290a 0a20 2020 2064 6566  es, [])..    def
+000134f0: 2074 6573 745f 656d 7074 795f 6269 6e64   test_empty_bind
+00013500: 5f61 6464 7265 7373 6573 2873 656c 6629  _addresses(self)
+00013510: 3a0a 2020 2020 2020 2020 6e65 7477 6f72  :.        networ
+00013520: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
+00013530: 6d70 7328 7b27 6269 6e64 2d61 6464 7265  mps({'bind-addre
+00013540: 7373 6573 273a 205b 7b7d 5d7d 290a 2020  sses': [{}]}).  
+00013550: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+00013560: 7428 7365 6c66 2c20 276e 6574 776f 726b  t(self, 'network
+00013570: 2d67 6574 272c 0a20 2020 2020 2020 2020  -get',.         
+00013580: 2020 2020 2020 2020 2020 2066 2727 275b             f'''[
+00013590: 2022 2431 2220 3d20 6462 3020 5d20 2626   "$1" = db0 ] &&
+000135a0: 2065 6368 6f20 277b 6e65 7477 6f72 6b5f   echo '{network_
+000135b0: 6461 7461 7d27 207c 7c20 6578 6974 2031  data}' || exit 1
+000135c0: 2727 2729 0a20 2020 2020 2020 2062 696e  ''').        bin
+000135d0: 6469 6e67 5f6e 616d 6520 3d20 2764 6230  ding_name = 'db0
+000135e0: 270a 2020 2020 2020 2020 6269 6e64 696e  '.        bindin
+000135f0: 6720 3d20 7365 6c66 2e6d 6f64 656c 2e67  g = self.model.g
+00013600: 6574 5f62 696e 6469 6e67 2873 656c 662e  et_binding(self.
+00013610: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
+00013620: 6f6e 2862 696e 6469 6e67 5f6e 616d 6529  on(binding_name)
+00013630: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00013640: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
+00013650: 6e67 2e6e 6574 776f 726b 2e69 6e74 6572  ng.network.inter
+00013660: 6661 6365 732c 205b 5d29 0a0a 2020 2020  faces, [])..    
+00013670: 6465 6620 7465 7374 5f6e 6f5f 6269 6e64  def test_no_bind
+00013680: 5f61 6464 7265 7373 6573 2873 656c 6629  _addresses(self)
+00013690: 3a0a 2020 2020 2020 2020 6e65 7477 6f72  :.        networ
+000136a0: 6b5f 6461 7461 203d 206a 736f 6e2e 6475  k_data = json.du
+000136b0: 6d70 7328 7b27 6269 6e64 2d61 6464 7265  mps({'bind-addre
+000136c0: 7373 6573 273a 205b 7b27 6164 6472 6573  sses': [{'addres
+000136d0: 7365 7327 3a20 4e6f 6e65 7d5d 7d29 0a20  ses': None}]}). 
+000136e0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+000136f0: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
+00013700: 6b2d 6765 7427 2c0a 2020 2020 2020 2020  k-get',.        
+00013710: 2020 2020 2020 2020 2020 2020 6627 2727              f'''
+00013720: 5b20 2224 3122 203d 2064 6230 205d 2026  [ "$1" = db0 ] &
+00013730: 2620 6563 686f 2027 7b6e 6574 776f 726b  & echo '{network
+00013740: 5f64 6174 617d 2720 7c7c 2065 7869 7420  _data}' || exit 
+00013750: 3127 2727 290a 2020 2020 2020 2020 6269  1''').        bi
+00013760: 6e64 696e 675f 6e61 6d65 203d 2027 6462  nding_name = 'db
+00013770: 3027 0a20 2020 2020 2020 2062 696e 6469  0'.        bindi
+00013780: 6e67 203d 2073 656c 662e 6d6f 6465 6c2e  ng = self.model.
+00013790: 6765 745f 6269 6e64 696e 6728 7365 6c66  get_binding(self
+000137a0: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
+000137b0: 696f 6e28 6269 6e64 696e 675f 6e61 6d65  ion(binding_name
+000137c0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+000137d0: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
+000137e0: 696e 672e 6e65 7477 6f72 6b2e 696e 7465  ing.network.inte
+000137f0: 7266 6163 6573 2c20 5b5d 290a 0a20 2020  rfaces, [])..   
+00013800: 2064 6566 2074 6573 745f 656d 7074 795f   def test_empty_
+00013810: 696e 7465 7266 6163 655f 696e 666f 2873  interface_info(s
+00013820: 656c 6629 3a0a 2020 2020 2020 2020 6e65  elf):.        ne
+00013830: 7477 6f72 6b5f 6461 7461 203d 206a 736f  twork_data = jso
+00013840: 6e2e 6475 6d70 7328 7b0a 2020 2020 2020  n.dumps({.      
+00013850: 2020 2020 2020 2762 696e 642d 6164 6472        'bind-addr
+00013860: 6573 7365 7327 3a20 5b7b 0a20 2020 2020  esses': [{.     
+00013870: 2020 2020 2020 2020 2020 2027 696e 7465             'inte
+00013880: 7266 6163 652d 6e61 6d65 273a 2027 6574  rface-name': 'et
+00013890: 6830 272c 0a20 2020 2020 2020 2020 2020  h0',.           
+000138a0: 2020 2020 2027 6164 6472 6573 7365 7327       'addresses'
+000138b0: 3a20 5b7b 7d5d 2c0a 2020 2020 2020 2020  : [{}],.        
+000138c0: 2020 2020 7d5d 2c0a 2020 2020 2020 2020      }],.        
+000138d0: 7d29 0a20 2020 2020 2020 2066 616b 655f  }).        fake_
+000138e0: 7363 7269 7074 2873 656c 662c 2027 6e65  script(self, 'ne
+000138f0: 7477 6f72 6b2d 6765 7427 2c0a 2020 2020  twork-get',.    
+00013900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013910: 6627 2727 5b20 2224 3122 203d 2064 6230  f'''[ "$1" = db0
+00013920: 205d 2026 2620 6563 686f 2027 7b6e 6574   ] && echo '{net
+00013930: 776f 726b 5f64 6174 617d 2720 7c7c 2065  work_data}' || e
+00013940: 7869 7420 3127 2727 290a 2020 2020 2020  xit 1''').      
+00013950: 2020 6269 6e64 696e 675f 6e61 6d65 203d    binding_name =
+00013960: 2027 6462 3027 0a20 2020 2020 2020 2062   'db0'.        b
+00013970: 696e 6469 6e67 203d 2073 656c 662e 6d6f  inding = self.mo
+00013980: 6465 6c2e 6765 745f 6269 6e64 696e 6728  del.get_binding(
+00013990: 7365 6c66 2e6d 6f64 656c 2e67 6574 5f72  self.model.get_r
+000139a0: 656c 6174 696f 6e28 6269 6e64 696e 675f  elation(binding_
+000139b0: 6e61 6d65 2929 0a20 2020 2020 2020 2073  name)).        s
+000139c0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000139d0: 6c65 6e28 6269 6e64 696e 672e 6e65 7477  len(binding.netw
+000139e0: 6f72 6b2e 696e 7465 7266 6163 6573 292c  ork.interfaces),
+000139f0: 2031 290a 2020 2020 2020 2020 696e 7465   1).        inte
+00013a00: 7266 6163 6520 3d20 6269 6e64 696e 672e  rface = binding.
+00013a10: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
+00013a20: 6573 5b30 5d0a 2020 2020 2020 2020 7365  es[0].        se
+00013a30: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
+00013a40: 696e 7465 7266 6163 652e 6164 6472 6573  interface.addres
+00013a50: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+00013a60: 6173 7365 7274 4973 4e6f 6e65 2869 6e74  assertIsNone(int
+00013a70: 6572 6661 6365 2e73 7562 6e65 7429 0a0a  erface.subnet)..
+00013a80: 2020 2020 6465 6620 7465 7374 5f6d 6973      def test_mis
+00013a90: 7369 6e67 5f69 6e67 7265 7373 5f61 6464  sing_ingress_add
+00013aa0: 7265 7373 6573 2873 656c 6629 3a0a 2020  resses(self):.  
+00013ab0: 2020 2020 2020 6e65 7477 6f72 6b5f 6461        network_da
+00013ac0: 7461 203d 206a 736f 6e2e 6475 6d70 7328  ta = json.dumps(
+00013ad0: 7b0a 2020 2020 2020 2020 2020 2020 2762  {.            'b
+00013ae0: 696e 642d 6164 6472 6573 7365 7327 3a20  ind-addresses': 
+00013af0: 5b5d 2c0a 2020 2020 2020 2020 7d29 0a20  [],.        }). 
+00013b00: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00013b10: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
+00013b20: 6b2d 6765 7427 2c0a 2020 2020 2020 2020  k-get',.        
+00013b30: 2020 2020 2020 2020 2020 2020 6627 2727              f'''
+00013b40: 5b20 2224 3122 203d 2064 6230 205d 2026  [ "$1" = db0 ] &
+00013b50: 2620 6563 686f 2027 7b6e 6574 776f 726b  & echo '{network
+00013b60: 5f64 6174 617d 2720 7c7c 2065 7869 7420  _data}' || exit 
+00013b70: 3127 2727 290a 2020 2020 2020 2020 6269  1''').        bi
+00013b80: 6e64 696e 675f 6e61 6d65 203d 2027 6462  nding_name = 'db
+00013b90: 3027 0a20 2020 2020 2020 2062 696e 6469  0'.        bindi
+00013ba0: 6e67 203d 2073 656c 662e 6d6f 6465 6c2e  ng = self.model.
+00013bb0: 6765 745f 6269 6e64 696e 6728 7365 6c66  get_binding(self
+00013bc0: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
+00013bd0: 696f 6e28 6269 6e64 696e 675f 6e61 6d65  ion(binding_name
+00013be0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+00013bf0: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
+00013c00: 696e 672e 6e65 7477 6f72 6b2e 696e 6772  ing.network.ingr
+00013c10: 6573 735f 6164 6472 6573 7365 732c 205b  ess_addresses, [
+00013c20: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00013c30: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
+00013c40: 696e 672e 6e65 7477 6f72 6b2e 696e 6772  ing.network.ingr
+00013c50: 6573 735f 6164 6472 6573 732c 204e 6f6e  ess_address, Non
+00013c60: 6529 0a0a 2020 2020 6465 6620 7465 7374  e)..    def test
+00013c70: 5f6d 6973 7369 6e67 5f65 6772 6573 735f  _missing_egress_
+00013c80: 7375 626e 6574 7328 7365 6c66 293a 0a20  subnets(self):. 
+00013c90: 2020 2020 2020 206e 6574 776f 726b 5f64         network_d
+00013ca0: 6174 6120 3d20 6a73 6f6e 2e64 756d 7073  ata = json.dumps
+00013cb0: 287b 0a20 2020 2020 2020 2020 2020 2027  ({.            '
+00013cc0: 6269 6e64 2d61 6464 7265 7373 6573 273a  bind-addresses':
+00013cd0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00013ce0: 2027 696e 6772 6573 732d 6164 6472 6573   'ingress-addres
+00013cf0: 7365 7327 3a20 5b5d 2c0a 2020 2020 2020  ses': [],.      
+00013d00: 2020 7d29 0a20 2020 2020 2020 2066 616b    }).        fak
+00013d10: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00013d20: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
+00013d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d40: 2020 6627 2727 5b20 2224 3122 203d 2064    f'''[ "$1" = d
+00013d50: 6230 205d 2026 2620 6563 686f 2027 7b6e  b0 ] && echo '{n
+00013d60: 6574 776f 726b 5f64 6174 617d 2720 7c7c  etwork_data}' ||
+00013d70: 2065 7869 7420 3127 2727 290a 2020 2020   exit 1''').    
+00013d80: 2020 2020 6269 6e64 696e 675f 6e61 6d65      binding_name
+00013d90: 203d 2027 6462 3027 0a20 2020 2020 2020   = 'db0'.       
+00013da0: 2062 696e 6469 6e67 203d 2073 656c 662e   binding = self.
+00013db0: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
+00013dc0: 6728 7365 6c66 2e6d 6f64 656c 2e67 6574  g(self.model.get
+00013dd0: 5f72 656c 6174 696f 6e28 6269 6e64 696e  _relation(bindin
+00013de0: 675f 6e61 6d65 2929 0a20 2020 2020 2020  g_name)).       
+00013df0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00013e00: 6c28 6269 6e64 696e 672e 6e65 7477 6f72  l(binding.networ
+00013e10: 6b2e 6567 7265 7373 5f73 7562 6e65 7473  k.egress_subnets
+00013e20: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+00013e30: 6573 745f 756e 7265 736f 6c76 6564 5f69  est_unresolved_i
+00013e40: 6e67 7265 7373 5f61 6464 7265 7373 6573  ngress_addresses
+00013e50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00013e60: 2320 736f 6d65 7469 6d65 7320 6a75 6a75  # sometimes juju
+00013e70: 2066 6169 6c73 2074 6f20 7265 736f 6c76   fails to resolv
+00013e80: 6520 616e 2075 726c 2074 6f20 616e 2049  e an url to an I
+00013e90: 502c 2069 6e20 7768 6963 6820 6361 7365  P, in which case
+00013ea0: 0a20 2020 2020 2020 2023 2069 6e67 7265  .        # ingre
+00013eb0: 7373 2d61 6464 7265 7373 6573 2077 696c  ss-addresses wil
+00013ec0: 6c20 6265 2074 6865 2027 7261 7727 2075  l be the 'raw' u
+00013ed0: 726c 2069 6e73 7465 6164 206f 6620 616e  rl instead of an
+00013ee0: 2049 502e 0a20 2020 2020 2020 206e 6574   IP..        net
+00013ef0: 776f 726b 5f64 6174 6120 3d20 6a73 6f6e  work_data = json
+00013f00: 2e64 756d 7073 287b 0a20 2020 2020 2020  .dumps({.       
+00013f10: 2020 2020 2027 696e 6772 6573 732d 6164       'ingress-ad
+00013f20: 6472 6573 7365 7327 3a20 5b0a 2020 2020  dresses': [.    
+00013f30: 2020 2020 2020 2020 2020 2020 2766 6f6f              'foo
+00013f40: 2e62 6172 2e62 617a 2e63 6f6d 270a 2020  .bar.baz.com'.  
+00013f50: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00013f60: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
+00013f70: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00013f80: 2c20 276e 6574 776f 726b 2d67 6574 272c  , 'network-get',
+00013f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013fa0: 2020 2020 2066 2727 275b 2022 2431 2220       f'''[ "$1" 
+00013fb0: 3d20 6462 3020 5d20 2626 2065 6368 6f20  = db0 ] && echo 
+00013fc0: 277b 6e65 7477 6f72 6b5f 6461 7461 7d27  '{network_data}'
+00013fd0: 207c 7c20 6578 6974 2031 2727 2729 0a20   || exit 1'''). 
+00013fe0: 2020 2020 2020 2062 696e 6469 6e67 5f6e         binding_n
+00013ff0: 616d 6520 3d20 2764 6230 270a 2020 2020  ame = 'db0'.    
+00014000: 2020 2020 6269 6e64 696e 6720 3d20 7365      binding = se
+00014010: 6c66 2e6d 6f64 656c 2e67 6574 5f62 696e  lf.model.get_bin
+00014020: 6469 6e67 2873 656c 662e 6d6f 6465 6c2e  ding(self.model.
+00014030: 6765 745f 7265 6c61 7469 6f6e 2862 696e  get_relation(bin
+00014040: 6469 6e67 5f6e 616d 6529 290a 2020 2020  ding_name)).    
+00014050: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00014060: 7175 616c 2862 696e 6469 6e67 2e6e 6574  qual(binding.net
+00014070: 776f 726b 2e69 6e67 7265 7373 5f61 6464  work.ingress_add
+00014080: 7265 7373 6573 2c20 5b27 666f 6f2e 6261  resses, ['foo.ba
+00014090: 722e 6261 7a2e 636f 6d27 5d29 0a0a 0a63  r.baz.com'])...c
+000140a0: 6c61 7373 2054 6573 744d 6f64 656c 4261  lass TestModelBa
+000140b0: 636b 656e 6428 756e 6974 7465 7374 2e54  ckend(unittest.T
+000140c0: 6573 7443 6173 6529 3a0a 0a20 2020 2064  estCase):..    d
+000140d0: 6566 2073 6574 5570 2873 656c 6629 3a0a  ef setUp(self):.
+000140e0: 2020 2020 2020 2020 7365 6c66 2e5f 6261          self._ba
+000140f0: 636b 656e 6420 3d20 4e6f 6e65 0a0a 2020  ckend = None..  
+00014100: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00014110: 6465 6620 6261 636b 656e 6428 7365 6c66  def backend(self
+00014120: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+00014130: 6c66 2e5f 6261 636b 656e 6420 6973 204e  lf._backend is N
+00014140: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00014150: 2073 656c 662e 5f62 6163 6b65 6e64 203d   self._backend =
+00014160: 205f 4d6f 6465 6c42 6163 6b65 6e64 2827   _ModelBackend('
+00014170: 6d79 6170 702f 3027 290a 2020 2020 2020  myapp/0').      
+00014180: 2020 7265 7475 726e 2073 656c 662e 5f62    return self._b
+00014190: 6163 6b65 6e64 0a0a 2020 2020 6465 6620  ackend..    def 
+000141a0: 7465 7374 5f72 656c 6174 696f 6e5f 6765  test_relation_ge
+000141b0: 745f 7365 745f 6973 5f61 7070 5f61 7267  t_set_is_app_arg
+000141c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000141d0: 2320 4e6f 2069 735f 6170 7020 7072 6f76  # No is_app prov
+000141e0: 6964 6564 2e0a 2020 2020 2020 2020 7769  ided..        wi
+000141f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00014200: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+00014210: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00014220: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
+00014230: 6f6e 5f73 6574 2831 2c20 2766 6f6f 6b65  on_set(1, 'fooke
+00014240: 7927 2c20 2762 6172 7661 6c27 290a 0a20  y', 'barval').. 
+00014250: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00014260: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
+00014270: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
+00014280: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
+00014290: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
+000142a0: 312c 2027 666f 6f65 6e74 6974 7927 290a  1, 'fooentity').
+000142b0: 0a20 2020 2020 2020 2023 2049 6e76 616c  .        # Inval
+000142c0: 6964 2074 7970 6573 2066 6f72 2069 735f  id types for is_
+000142d0: 6170 702e 0a20 2020 2020 2020 2066 6f72  app..        for
+000142e0: 2069 735f 6170 705f 7620 696e 205b 4e6f   is_app_v in [No
+000142f0: 6e65 2c20 312c 2032 2e30 2c20 2761 272c  ne, 1, 2.0, 'a',
+00014300: 2062 2762 6565 6627 5d3a 0a20 2020 2020   b'beef']:.     
+00014310: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00014320: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
+00014330: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
+00014340: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+00014350: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00014360: 7365 7428 312c 2027 666f 6f6b 6579 272c  set(1, 'fookey',
+00014370: 2027 6261 7276 616c 272c 2069 735f 6170   'barval', is_ap
+00014380: 703d 6973 5f61 7070 5f76 290a 0a20 2020  p=is_app_v)..   
+00014390: 2020 2020 2020 2020 2077 6974 6820 7365           with se
+000143a0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+000143b0: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+000143c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000143d0: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
+000143e0: 6e5f 6765 7428 312c 2027 666f 6f65 6e74  n_get(1, 'fooent
+000143f0: 6974 7927 2c20 6973 5f61 7070 3d69 735f  ity', is_app=is_
+00014400: 6170 705f 7629 0a0a 2020 2020 6465 6620  app_v)..    def 
+00014410: 7465 7374 5f69 735f 6c65 6164 6572 5f72  test_is_leader_r
+00014420: 6566 7265 7368 2873 656c 6629 3a0a 2020  efresh(self):.  
+00014430: 2020 2020 2020 6d65 7461 203d 206f 7073        meta = ops
+00014440: 2e43 6861 726d 4d65 7461 2e66 726f 6d5f  .CharmMeta.from_
+00014450: 7961 6d6c 2827 2727 0a20 2020 2020 2020  yaml('''.       
+00014460: 2020 2020 206e 616d 653a 206d 7961 7070       name: myapp
+00014470: 0a20 2020 2020 2020 2027 2727 290a 2020  .        ''').  
+00014480: 2020 2020 2020 6d6f 6465 6c20 3d20 6f70        model = op
+00014490: 732e 4d6f 6465 6c28 6d65 7461 2c20 7365  s.Model(meta, se
+000144a0: 6c66 2e62 6163 6b65 6e64 290a 2020 2020  lf.backend).    
+000144b0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+000144c0: 7365 6c66 2c20 2769 732d 6c65 6164 6572  self, 'is-leader
+000144d0: 272c 2027 6563 686f 2066 616c 7365 2729  ', 'echo false')
+000144e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000144f0: 7365 7274 4661 6c73 6528 6d6f 6465 6c2e  sertFalse(model.
+00014500: 756e 6974 2e69 735f 6c65 6164 6572 2829  unit.is_leader()
+00014510: 290a 0a20 2020 2020 2020 2023 2043 6861  )..        # Cha
+00014520: 6e67 6520 7468 6520 6c65 6164 6572 7368  nge the leadersh
+00014530: 6970 2073 7461 7475 730a 2020 2020 2020  ip status.      
+00014540: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00014550: 6c66 2c20 2769 732d 6c65 6164 6572 272c  lf, 'is-leader',
+00014560: 2027 6563 686f 2074 7275 6527 290a 2020   'echo true').  
+00014570: 2020 2020 2020 2320 4966 2079 6f75 2064        # If you d
+00014580: 6f6e 2774 2066 6f72 6365 2069 742c 2077  on't force it, w
+00014590: 6520 646f 6e27 7420 6368 6563 6b2c 2073  e don't check, s
+000145a0: 6f20 7765 2077 6f6e 2774 2073 6565 2074  o we won't see t
+000145b0: 6865 2063 6861 6e67 650a 2020 2020 2020  he change.      
+000145c0: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
+000145d0: 7365 286d 6f64 656c 2e75 6e69 742e 6973  se(model.unit.is
+000145e0: 5f6c 6561 6465 7228 2929 0a20 2020 2020  _leader()).     
+000145f0: 2020 2023 2049 6620 7765 2066 6f72 6365     # If we force
+00014600: 2061 2072 6563 6865 636b 2c20 7468 656e   a recheck, then
+00014610: 2077 6520 6e6f 7469 6365 0a20 2020 2020   we notice.     
+00014620: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
+00014630: 5f6c 6561 6465 725f 6368 6563 6b5f 7469  _leader_check_ti
+00014640: 6d65 203d 204e 6f6e 650a 2020 2020 2020  me = None.      
+00014650: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+00014660: 6528 6d6f 6465 6c2e 756e 6974 2e69 735f  e(model.unit.is_
+00014670: 6c65 6164 6572 2829 290a 0a20 2020 2020  leader())..     
+00014680: 2020 2023 2046 6f72 6365 2061 2072 6563     # Force a rec
+00014690: 6865 636b 2077 6974 686f 7574 2063 6861  heck without cha
+000146a0: 6e67 696e 6720 7468 6520 6c65 6164 6572  nging the leader
+000146b0: 7368 6970 2073 7461 7475 732e 0a20 2020  ship status..   
+000146c0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+000146d0: 2873 656c 662c 2027 6973 2d6c 6561 6465  (self, 'is-leade
+000146e0: 7227 2c20 2765 6368 6f20 7472 7565 2729  r', 'echo true')
+000146f0: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00014700: 636b 656e 642e 5f6c 6561 6465 725f 6368  ckend._leader_ch
+00014710: 6563 6b5f 7469 6d65 203d 204e 6f6e 650a  eck_time = None.
+00014720: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00014730: 6572 7454 7275 6528 6d6f 6465 6c2e 756e  ertTrue(model.un
+00014740: 6974 2e69 735f 6c65 6164 6572 2829 290a  it.is_leader()).
+00014750: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+00014760: 6c61 7469 6f6e 5f74 6f6f 6c5f 6572 726f  lation_tool_erro
+00014770: 7273 2873 656c 6629 3a0a 2020 2020 2020  rs(self):.      
+00014780: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00014790: 7028 6f73 2e65 6e76 6972 6f6e 2e70 6f70  p(os.environ.pop
+000147a0: 2c20 274a 554a 555f 5645 5253 494f 4e27  , 'JUJU_VERSION'
+000147b0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+000147c0: 6f73 2e65 6e76 6972 6f6e 5b27 4a55 4a55  os.environ['JUJU
+000147d0: 5f56 4552 5349 4f4e 275d 203d 2027 322e  _VERSION'] = '2.
+000147e0: 382e 3027 0a20 2020 2020 2020 2065 7272  8.0'.        err
+000147f0: 5f6d 7367 203d 2027 4552 524f 5220 696e  _msg = 'ERROR in
+00014800: 7661 6c69 6420 7661 6c75 6520 2224 3222  valid value "$2"
+00014810: 2066 6f72 206f 7074 696f 6e20 2d72 3a20   for option -r: 
+00014820: 7265 6c61 7469 6f6e 206e 6f74 2066 6f75  relation not fou
+00014830: 6e64 270a 0a20 2020 2020 2020 2074 6573  nd'..        tes
+00014840: 745f 6361 7365 7320 3d20 5b28 0a20 2020  t_cases = [(.   
+00014850: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+00014860: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00014870: 662c 2027 7265 6c61 7469 6f6e 2d6c 6973  f, 'relation-lis
+00014880: 7427 2c20 2765 6368 6f20 666f 6f65 7272  t', 'echo fooerr
+00014890: 6f72 203e 2632 203b 2065 7869 7420 3127  or >&2 ; exit 1'
+000148a0: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
+000148b0: 616d 6264 613a 2073 656c 662e 6261 636b  ambda: self.back
+000148c0: 656e 642e 7265 6c61 7469 6f6e 5f6c 6973  end.relation_lis
+000148d0: 7428 3329 2c0a 2020 2020 2020 2020 2020  t(3),.          
+000148e0: 2020 6f70 732e 4d6f 6465 6c45 7272 6f72    ops.ModelError
+000148f0: 2c0a 2020 2020 2020 2020 2020 2020 5b5b  ,.            [[
+00014900: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
+00014910: 2027 2d72 272c 2027 3327 2c20 272d 2d66   '-r', '3', '--f
+00014920: 6f72 6d61 743d 6a73 6f6e 275d 5d2c 0a20  ormat=json']],. 
+00014930: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
+00014940: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+00014950: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+00014960: 2c20 2772 656c 6174 696f 6e2d 6c69 7374  , 'relation-list
+00014970: 272c 2066 2765 6368 6f20 7b65 7272 5f6d  ', f'echo {err_m
+00014980: 7367 7d20 3e26 3220 3b20 6578 6974 2032  sg} >&2 ; exit 2
+00014990: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+000149a0: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
+000149b0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
+000149c0: 7374 2833 292c 0a20 2020 2020 2020 2020  st(3),.         
+000149d0: 2020 206f 7073 2e52 656c 6174 696f 6e4e     ops.RelationN
+000149e0: 6f74 466f 756e 6445 7272 6f72 2c0a 2020  otFoundError,.  
+000149f0: 2020 2020 2020 2020 2020 5b5b 2772 656c            [['rel
+00014a00: 6174 696f 6e2d 6c69 7374 272c 2027 2d72  ation-list', '-r
+00014a10: 272c 2027 3327 2c20 272d 2d66 6f72 6d61  ', '3', '--forma
+00014a20: 743d 6a73 6f6e 275d 5d2c 0a20 2020 2020  t=json']],.     
+00014a30: 2020 2029 2c20 280a 2020 2020 2020 2020     ), (.        
+00014a40: 2020 2020 6c61 6d62 6461 3a20 6661 6b65      lambda: fake
+00014a50: 5f73 6372 6970 7428 7365 6c66 2c20 2772  _script(self, 'r
+00014a60: 656c 6174 696f 6e2d 7365 7427 2c20 2765  elation-set', 'e
+00014a70: 6368 6f20 666f 6f65 7272 6f72 203e 2632  cho fooerror >&2
+00014a80: 203b 2065 7869 7420 3127 292c 0a20 2020   ; exit 1'),.   
+00014a90: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+00014aa0: 2073 656c 662e 6261 636b 656e 642e 7265   self.backend.re
+00014ab0: 6c61 7469 6f6e 5f73 6574 2833 2c20 2766  lation_set(3, 'f
+00014ac0: 6f6f 272c 2027 6261 7227 2c20 6973 5f61  oo', 'bar', is_a
+00014ad0: 7070 3d46 616c 7365 292c 0a20 2020 2020  pp=False),.     
+00014ae0: 2020 2020 2020 206f 7073 2e4d 6f64 656c         ops.Model
+00014af0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+00014b00: 2020 205b 5b27 7265 6c61 7469 6f6e 2d73     [['relation-s
+00014b10: 6574 272c 2027 2d72 272c 2027 3327 2c20  et', '-r', '3', 
+00014b20: 272d 2d66 696c 6527 2c20 272d 275d 5d2c  '--file', '-']],
+00014b30: 0a20 2020 2020 2020 2029 2c20 280a 2020  .        ), (.  
+00014b40: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+00014b50: 3a20 6661 6b65 5f73 6372 6970 7428 7365  : fake_script(se
+00014b60: 6c66 2c20 2772 656c 6174 696f 6e2d 7365  lf, 'relation-se
+00014b70: 7427 2c20 6627 6563 686f 207b 6572 725f  t', f'echo {err_
+00014b80: 6d73 677d 203e 2632 203b 2065 7869 7420  msg} >&2 ; exit 
+00014b90: 3227 292c 0a20 2020 2020 2020 2020 2020  2'),.           
+00014ba0: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
+00014bb0: 636b 656e 642e 7265 6c61 7469 6f6e 5f73  ckend.relation_s
+00014bc0: 6574 2833 2c20 2766 6f6f 272c 2027 6261  et(3, 'foo', 'ba
+00014bd0: 7227 2c20 6973 5f61 7070 3d46 616c 7365  r', is_app=False
+00014be0: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
+00014bf0: 7073 2e52 656c 6174 696f 6e4e 6f74 466f  ps.RelationNotFo
+00014c00: 756e 6445 7272 6f72 2c0a 2020 2020 2020  undError,.      
+00014c10: 2020 2020 2020 5b5b 2772 656c 6174 696f        [['relatio
+00014c20: 6e2d 7365 7427 2c20 272d 7227 2c20 2733  n-set', '-r', '3
+00014c30: 272c 2027 2d2d 6669 6c65 272c 2027 2d27  ', '--file', '-'
+00014c40: 5d5d 2c0a 2020 2020 2020 2020 292c 2028  ]],.        ), (
+00014c50: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00014c60: 6264 613a 204e 6f6e 652c 0a20 2020 2020  bda: None,.     
+00014c70: 2020 2020 2020 206c 616d 6264 613a 2073         lambda: s
+00014c80: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
+00014c90: 7469 6f6e 5f73 6574 2833 2c20 2766 6f6f  tion_set(3, 'foo
+00014ca0: 272c 2027 6261 7227 2c20 6973 5f61 7070  ', 'bar', is_app
+00014cb0: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
+00014cc0: 2020 2020 6f70 732e 5265 6c61 7469 6f6e      ops.Relation
+00014cd0: 4e6f 7446 6f75 6e64 4572 726f 722c 0a20  NotFoundError,. 
+00014ce0: 2020 2020 2020 2020 2020 205b 5b27 7265             [['re
+00014cf0: 6c61 7469 6f6e 2d73 6574 272c 2027 2d72  lation-set', '-r
+00014d00: 272c 2027 3327 2c20 272d 2d61 7070 272c  ', '3', '--app',
+00014d10: 2027 2d2d 6669 6c65 272c 2027 2d27 5d5d   '--file', '-']]
+00014d20: 2c0a 2020 2020 2020 2020 292c 2028 0a20  ,.        ), (. 
+00014d30: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+00014d40: 613a 2066 616b 655f 7363 7269 7074 2873  a: fake_script(s
+00014d50: 656c 662c 2027 7265 6c61 7469 6f6e 2d67  elf, 'relation-g
+00014d60: 6574 272c 2027 6563 686f 2066 6f6f 6572  et', 'echo fooer
+00014d70: 726f 7220 3e26 3220 3b20 6578 6974 2031  ror >&2 ; exit 1
+00014d80: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00014d90: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
+00014da0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00014db0: 7428 332c 2027 7265 6d6f 7465 2f30 272c  t(3, 'remote/0',
+00014dc0: 2069 735f 6170 703d 4661 6c73 6529 2c0a   is_app=False),.
+00014dd0: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
 00014de0: 4d6f 6465 6c45 7272 6f72 2c0a 2020 2020  ModelError,.    
 00014df0: 2020 2020 2020 2020 5b5b 2772 656c 6174          [['relat
-00014e00: 696f 6e2d 7365 7427 2c20 272d 7227 2c20  ion-set', '-r', 
-00014e10: 2733 272c 2027 2d2d 6669 6c65 272c 2027  '3', '--file', '
-00014e20: 2d27 5d5d 2c0a 2020 2020 2020 2020 292c  -']],.        ),
-00014e30: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
-00014e40: 616d 6264 613a 2066 616b 655f 7363 7269  ambda: fake_scri
-00014e50: 7074 2873 656c 662c 2027 7265 6c61 7469  pt(self, 'relati
-00014e60: 6f6e 2d73 6574 272c 2066 2765 6368 6f20  on-set', f'echo 
-00014e70: 7b65 7272 5f6d 7367 7d20 3e26 3220 3b20  {err_msg} >&2 ; 
-00014e80: 6578 6974 2032 2729 2c0a 2020 2020 2020  exit 2'),.      
-00014e90: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
-00014ea0: 6c66 2e62 6163 6b65 6e64 2e72 656c 6174  lf.backend.relat
-00014eb0: 696f 6e5f 7365 7428 332c 2027 666f 6f27  ion_set(3, 'foo'
-00014ec0: 2c20 2762 6172 272c 2069 735f 6170 703d  , 'bar', is_app=
-00014ed0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
-00014ee0: 2020 2020 6f70 732e 6d6f 6465 6c2e 5265      ops.model.Re
-00014ef0: 6c61 7469 6f6e 4e6f 7446 6f75 6e64 4572  lationNotFoundEr
-00014f00: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
-00014f10: 205b 5b27 7265 6c61 7469 6f6e 2d73 6574   [['relation-set
-00014f20: 272c 2027 2d72 272c 2027 3327 2c20 272d  ', '-r', '3', '-
-00014f30: 2d66 696c 6527 2c20 272d 275d 5d2c 0a20  -file', '-']],. 
-00014f40: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
-00014f50: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-00014f60: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00014f70: 2020 6c61 6d62 6461 3a20 7365 6c66 2e62    lambda: self.b
-00014f80: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00014f90: 7365 7428 332c 2027 666f 6f27 2c20 2762  set(3, 'foo', 'b
-00014fa0: 6172 272c 2069 735f 6170 703d 5472 7565  ar', is_app=True
-00014fb0: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
-00014fc0: 7073 2e6d 6f64 656c 2e52 656c 6174 696f  ps.model.Relatio
-00014fd0: 6e4e 6f74 466f 756e 6445 7272 6f72 2c0a  nNotFoundError,.
-00014fe0: 2020 2020 2020 2020 2020 2020 5b5b 2772              [['r
-00014ff0: 656c 6174 696f 6e2d 7365 7427 2c20 272d  elation-set', '-
-00015000: 7227 2c20 2733 272c 2027 2d2d 6170 7027  r', '3', '--app'
-00015010: 2c20 272d 2d66 696c 6527 2c20 272d 275d  , '--file', '-']
-00015020: 5d2c 0a20 2020 2020 2020 2029 2c20 280a  ],.        ), (.
-00015030: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-00015040: 6461 3a20 6661 6b65 5f73 6372 6970 7428  da: fake_script(
-00015050: 7365 6c66 2c20 2772 656c 6174 696f 6e2d  self, 'relation-
-00015060: 6765 7427 2c20 2765 6368 6f20 666f 6f65  get', 'echo fooe
-00015070: 7272 6f72 203e 2632 203b 2065 7869 7420  rror >&2 ; exit 
-00015080: 3127 292c 0a20 2020 2020 2020 2020 2020  1'),.           
-00015090: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
-000150a0: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-000150b0: 6574 2833 2c20 2772 656d 6f74 652f 3027  et(3, 'remote/0'
-000150c0: 2c20 6973 5f61 7070 3d46 616c 7365 292c  , is_app=False),
-000150d0: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
-000150e0: 2e6d 6f64 656c 2e4d 6f64 656c 4572 726f  .model.ModelErro
-000150f0: 722c 0a20 2020 2020 2020 2020 2020 205b  r,.            [
-00015100: 5b27 7265 6c61 7469 6f6e 2d67 6574 272c  ['relation-get',
-00015110: 2027 2d72 272c 2027 3327 2c20 272d 272c   '-r', '3', '-',
-00015120: 2027 7265 6d6f 7465 2f30 272c 2027 2d2d   'remote/0', '--
-00015130: 666f 726d 6174 3d6a 736f 6e27 5d5d 2c0a  format=json']],.
-00015140: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
-00015150: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-00015160: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00015170: 662c 2027 7265 6c61 7469 6f6e 2d67 6574  f, 'relation-get
-00015180: 272c 2066 2765 6368 6f20 7b65 7272 5f6d  ', f'echo {err_m
-00015190: 7367 7d20 3e26 3220 3b20 6578 6974 2032  sg} >&2 ; exit 2
-000151a0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-000151b0: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
-000151c0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-000151d0: 7428 332c 2027 7265 6d6f 7465 2f30 272c  t(3, 'remote/0',
-000151e0: 2069 735f 6170 703d 4661 6c73 6529 2c0a   is_app=False),.
-000151f0: 2020 2020 2020 2020 2020 2020 6f70 732e              ops.
-00015200: 6d6f 6465 6c2e 5265 6c61 7469 6f6e 4e6f  model.RelationNo
-00015210: 7446 6f75 6e64 4572 726f 722c 0a20 2020  tFoundError,.   
-00015220: 2020 2020 2020 2020 205b 5b27 7265 6c61           [['rela
-00015230: 7469 6f6e 2d67 6574 272c 2027 2d72 272c  tion-get', '-r',
-00015240: 2027 3327 2c20 272d 272c 2027 7265 6d6f   '3', '-', 'remo
-00015250: 7465 2f30 272c 2027 2d2d 666f 726d 6174  te/0', '--format
-00015260: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
-00015270: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
-00015280: 2020 206c 616d 6264 613a 204e 6f6e 652c     lambda: None,
-00015290: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-000152a0: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
-000152b0: 642e 7265 6c61 7469 6f6e 5f67 6574 2833  d.relation_get(3
-000152c0: 2c20 2772 656d 6f74 652f 3027 2c20 6973  , 'remote/0', is
-000152d0: 5f61 7070 3d54 7275 6529 2c0a 2020 2020  _app=True),.    
-000152e0: 2020 2020 2020 2020 6f70 732e 6d6f 6465          ops.mode
-000152f0: 6c2e 5265 6c61 7469 6f6e 4e6f 7446 6f75  l.RelationNotFou
-00015300: 6e64 4572 726f 722c 0a20 2020 2020 2020  ndError,.       
-00015310: 2020 2020 205b 5b27 7265 6c61 7469 6f6e       [['relation
-00015320: 2d67 6574 272c 2027 2d72 272c 2027 3327  -get', '-r', '3'
-00015330: 2c20 272d 272c 2027 7265 6d6f 7465 2f30  , '-', 'remote/0
-00015340: 272c 2027 2d2d 6170 7027 2c20 272d 2d66  ', '--app', '--f
-00015350: 6f72 6d61 743d 6a73 6f6e 275d 5d2c 0a20  ormat=json']],. 
-00015360: 2020 2020 2020 2029 5d0a 0a20 2020 2020         )]..     
-00015370: 2020 2066 6f72 2069 2c20 2864 6f5f 6661     for i, (do_fa
-00015380: 6b65 2c20 7275 6e2c 2065 7863 6570 7469  ke, run, excepti
-00015390: 6f6e 2c20 6361 6c6c 7329 2069 6e20 656e  on, calls) in en
-000153a0: 756d 6572 6174 6528 7465 7374 5f63 6173  umerate(test_cas
-000153b0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
-000153c0: 2077 6974 6820 7365 6c66 2e73 7562 5465   with self.subTe
-000153d0: 7374 2869 293a 0a20 2020 2020 2020 2020  st(i):.         
-000153e0: 2020 2020 2020 2064 6f5f 6661 6b65 2829         do_fake()
-000153f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015400: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00015410: 7452 6169 7365 7328 6578 6365 7074 696f  tRaises(exceptio
-00015420: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-00015430: 2020 2020 2020 2020 7275 6e28 290a 2020          run().  
-00015440: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00015450: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00015460: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00015470: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-00015480: 6529 2c20 6361 6c6c 7329 0a0a 2020 2020  e), calls)..    
-00015490: 6465 6620 7465 7374 5f72 656c 6174 696f  def test_relatio
-000154a0: 6e5f 6765 745f 6a75 6a75 5f76 6572 7369  n_get_juju_versi
-000154b0: 6f6e 5f71 7569 726b 7328 7365 6c66 293a  on_quirks(self):
-000154c0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-000154d0: 6443 6c65 616e 7570 286f 732e 656e 7669  dCleanup(os.envi
-000154e0: 726f 6e2e 706f 702c 2027 4a55 4a55 5f56  ron.pop, 'JUJU_V
-000154f0: 4552 5349 4f4e 272c 204e 6f6e 6529 0a0a  ERSION', None)..
-00015500: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00015510: 6970 7428 7365 6c66 2c20 2772 656c 6174  ipt(self, 'relat
-00015520: 696f 6e2d 6765 7427 2c20 2727 2765 6368  ion-get', '''ech
-00015530: 6f20 277b 2266 6f6f 223a 2022 6261 7222  o '{"foo": "bar"
-00015540: 7d27 2027 2727 290a 0a20 2020 2020 2020  }' ''')..       
-00015550: 2023 206f 6e20 322e 372e 302b 2c20 7468   # on 2.7.0+, th
-00015560: 696e 6773 2070 726f 6365 6564 2061 7320  ings proceed as 
-00015570: 6578 7065 6374 6564 0a20 2020 2020 2020  expected.       
-00015580: 2066 6f72 2076 2069 6e20 5b27 322e 382e   for v in ['2.8.
-00015590: 3027 2c20 2732 2e37 2e30 275d 3a0a 2020  0', '2.7.0']:.  
-000155a0: 2020 2020 2020 2020 2020 7769 7468 2073            with s
-000155b0: 656c 662e 7375 6254 6573 7428 7629 3a0a  elf.subTest(v):.
-000155c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155d0: 6f73 2e65 6e76 6972 6f6e 5b27 4a55 4a55  os.environ['JUJU
-000155e0: 5f56 4552 5349 4f4e 275d 203d 2076 0a20  _VERSION'] = v. 
-000155f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00015600: 656c 5f64 6174 6120 3d20 7365 6c66 2e62  el_data = self.b
-00015610: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00015620: 6765 7428 312c 2027 666f 6f2f 3027 2c20  get(1, 'foo/0', 
-00015630: 6973 5f61 7070 3d54 7275 6529 0a20 2020  is_app=True).   
-00015640: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00015650: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
-00015660: 6c5f 6461 7461 2c20 7b22 666f 6f22 3a20  l_data, {"foo": 
-00015670: 2262 6172 227d 290a 2020 2020 2020 2020  "bar"}).        
-00015680: 2020 2020 2020 2020 6361 6c6c 7320 3d20          calls = 
-00015690: 5b27 2027 2e6a 6f69 6e28 6929 2066 6f72  [' '.join(i) for
-000156a0: 2069 2069 6e20 6661 6b65 5f73 6372 6970   i in fake_scrip
-000156b0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
-000156c0: 6561 723d 5472 7565 295d 0a20 2020 2020  ear=True)].     
-000156d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000156e0: 6173 7365 7274 4571 7561 6c28 6361 6c6c  assertEqual(call
-000156f0: 732c 205b 2772 656c 6174 696f 6e2d 6765  s, ['relation-ge
-00015700: 7420 2d72 2031 202d 2066 6f6f 2f30 202d  t -r 1 - foo/0 -
-00015710: 2d61 7070 202d 2d66 6f72 6d61 743d 6a73  -app --format=js
-00015720: 6f6e 275d 290a 0a20 2020 2020 2020 2023  on'])..        #
-00015730: 2062 6566 6f72 6520 322e 372e 302c 2069   before 2.7.0, i
-00015740: 7420 6a75 7374 2066 6169 6c73 2028 6e6f  t just fails (no
-00015750: 202d 2d61 7070 2073 7570 706f 7274 290a   --app support).
-00015760: 2020 2020 2020 2020 6f73 2e65 6e76 6972          os.envir
-00015770: 6f6e 5b27 4a55 4a55 5f56 4552 5349 4f4e  on['JUJU_VERSION
-00015780: 275d 203d 2027 322e 362e 3927 0a20 2020  '] = '2.6.9'.   
-00015790: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000157a0: 7373 6572 7452 6169 7365 7352 6567 6578  ssertRaisesRegex
-000157b0: 2852 756e 7469 6d65 4572 726f 722c 2027  (RuntimeError, '
-000157c0: 6e6f 7420 7375 7070 6f72 7465 6420 6f6e  not supported on
-000157d0: 204a 756a 7520 7665 7273 696f 6e20 322e   Juju version 2.
-000157e0: 362e 3927 293a 0a20 2020 2020 2020 2020  6.9'):.         
-000157f0: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-00015800: 7265 6c61 7469 6f6e 5f67 6574 2831 2c20  relation_get(1, 
-00015810: 2766 6f6f 2f30 272c 2069 735f 6170 703d  'foo/0', is_app=
-00015820: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-00015830: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00015840: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00015850: 2873 656c 6629 2c20 5b5d 290a 0a20 2020  (self), [])..   
-00015860: 2064 6566 2074 6573 745f 7265 6c61 7469   def test_relati
-00015870: 6f6e 5f73 6574 5f6a 756a 755f 7665 7273  on_set_juju_vers
-00015880: 696f 6e5f 7175 6972 6b73 2873 656c 6629  ion_quirks(self)
-00015890: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-000158a0: 6464 436c 6561 6e75 7028 6f73 2e65 6e76  ddCleanup(os.env
-000158b0: 6972 6f6e 2e70 6f70 2c20 274a 554a 555f  iron.pop, 'JUJU_
-000158c0: 5645 5253 494f 4e27 2c20 4e6f 6e65 290a  VERSION', None).
-000158d0: 0a20 2020 2020 2020 2023 206f 6e20 322e  .        # on 2.
-000158e0: 372e 302b 2c20 7468 696e 6773 2070 726f  7.0+, things pro
-000158f0: 6365 6564 2061 7320 6578 7065 6374 6564  ceed as expected
-00015900: 0a20 2020 2020 2020 2066 6f72 2076 2069  .        for v i
-00015910: 6e20 5b27 322e 382e 3027 2c20 2732 2e37  n ['2.8.0', '2.7
-00015920: 2e30 275d 3a0a 2020 2020 2020 2020 2020  .0']:.          
-00015930: 2020 7769 7468 2073 656c 662e 7375 6254    with self.subT
-00015940: 6573 7428 7629 3a0a 2020 2020 2020 2020  est(v):.        
-00015950: 2020 2020 2020 2020 7420 3d20 7465 6d70          t = temp
-00015960: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
-00015970: 6172 7946 696c 6528 290a 2020 2020 2020  aryFile().      
-00015980: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00015990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159a0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-000159b0: 656c 662c 2027 7265 6c61 7469 6f6e 2d73  elf, 'relation-s
-000159c0: 6574 272c 2064 6564 656e 7428 2222 220a  et', dedent(""".
-000159d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159e0: 2020 2020 2020 2020 6361 7420 3e3e 207b          cat >> {
-000159f0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00015a00: 2020 2020 2020 2020 2020 2222 2229 2e66            """).f
-00015a10: 6f72 6d61 7428 7061 7468 6c69 622e 5061  ormat(pathlib.Pa
-00015a20: 7468 2874 2e6e 616d 6529 2e61 735f 706f  th(t.name).as_po
-00015a30: 7369 7828 2929 290a 2020 2020 2020 2020  six())).        
-00015a40: 2020 2020 2020 2020 2020 2020 6f73 2e65              os.e
-00015a50: 6e76 6972 6f6e 5b27 4a55 4a55 5f56 4552  nviron['JUJU_VER
-00015a60: 5349 4f4e 275d 203d 2076 0a20 2020 2020  SION'] = v.     
-00015a70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00015a80: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
-00015a90: 7469 6f6e 5f73 6574 2831 2c20 2766 6f6f  tion_set(1, 'foo
-00015aa0: 272c 2027 6261 7227 2c20 6973 5f61 7070  ', 'bar', is_app
-00015ab0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00015ac0: 2020 2020 2020 2020 2020 2063 616c 6c73             calls
-00015ad0: 203d 205b 2720 272e 6a6f 696e 2869 2920   = [' '.join(i) 
-00015ae0: 666f 7220 6920 696e 2066 616b 655f 7363  for i in fake_sc
-00015af0: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
-00015b00: 2063 6c65 6172 3d54 7275 6529 5d0a 2020   clear=True)].  
-00015b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b20: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015b30: 616c 2863 616c 6c73 2c20 5b27 7265 6c61  al(calls, ['rela
-00015b40: 7469 6f6e 2d73 6574 202d 7220 3120 2d2d  tion-set -r 1 --
-00015b50: 6170 7020 2d2d 6669 6c65 202d 275d 290a  app --file -']).
-00015b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b70: 2020 2020 742e 7365 656b 2830 290a 2020      t.seek(0).  
-00015b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b90: 2020 636f 6e74 656e 7420 3d20 742e 7265    content = t.re
-00015ba0: 6164 2829 0a20 2020 2020 2020 2020 2020  ad().           
-00015bb0: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
-00015bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bd0: 2020 742e 636c 6f73 6528 290a 2020 2020    t.close().    
-00015be0: 2020 2020 2020 2020 2020 2020 6465 636f              deco
-00015bf0: 6465 6420 3d20 636f 6e74 656e 742e 6465  ded = content.de
-00015c00: 636f 6465 2827 7574 662d 3827 292e 7265  code('utf-8').re
-00015c10: 706c 6163 6528 275c 725c 6e27 2c20 275c  place('\r\n', '\
-00015c20: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
-00015c30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00015c40: 7175 616c 2864 6563 6f64 6564 2c20 2766  qual(decoded, 'f
-00015c50: 6f6f 3a20 6261 725c 6e27 290a 0a20 2020  oo: bar\n')..   
-00015c60: 2020 2020 2023 2062 6566 6f72 6520 322e       # before 2.
-00015c70: 372e 302c 2069 7420 6a75 7374 2066 6169  7.0, it just fai
-00015c80: 6c73 2061 6c77 6179 7320 286e 6f20 2d2d  ls always (no --
-00015c90: 6170 7020 7375 7070 6f72 7429 0a20 2020  app support).   
-00015ca0: 2020 2020 206f 732e 656e 7669 726f 6e5b       os.environ[
-00015cb0: 274a 554a 555f 5645 5253 494f 4e27 5d20  'JUJU_VERSION'] 
-00015cc0: 3d20 2732 2e36 2e39 270a 2020 2020 2020  = '2.6.9'.      
-00015cd0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00015ce0: 7274 5261 6973 6573 5265 6765 7828 5275  rtRaisesRegex(Ru
-00015cf0: 6e74 696d 6545 7272 6f72 2c20 276e 6f74  ntimeError, 'not
-00015d00: 2073 7570 706f 7274 6564 206f 6e20 4a75   supported on Ju
-00015d10: 6a75 2076 6572 7369 6f6e 2032 2e36 2e39  ju version 2.6.9
-00015d20: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00015d30: 7365 6c66 2e62 6163 6b65 6e64 2e72 656c  self.backend.rel
-00015d40: 6174 696f 6e5f 7365 7428 312c 2027 666f  ation_set(1, 'fo
-00015d50: 6f27 2c20 2762 6172 272c 2069 735f 6170  o', 'bar', is_ap
-00015d60: 703d 5472 7565 290a 2020 2020 2020 2020  p=True).        
-00015d70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00015d80: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
-00015d90: 6c73 2873 656c 6629 2c20 5b5d 290a 0a20  ls(self), []).. 
-00015da0: 2020 2064 6566 2074 6573 745f 7374 6174     def test_stat
-00015db0: 7573 5f67 6574 2873 656c 6629 3a0a 2020  us_get(self):.  
-00015dc0: 2020 2020 2020 2320 7461 6b65 6e20 6672        # taken fr
-00015dd0: 6f6d 2061 6374 7561 6c20 4a75 6a75 206f  om actual Juju o
-00015de0: 7574 7075 740a 2020 2020 2020 2020 636f  utput.        co
-00015df0: 6e74 656e 7420 3d20 277b 226d 6573 7361  ntent = '{"messa
-00015e00: 6765 223a 2022 222c 2022 7374 6174 7573  ge": "", "status
-00015e10: 223a 2022 756e 6b6e 6f77 6e22 2c20 2273  ": "unknown", "s
-00015e20: 7461 7475 732d 6461 7461 223a 207b 7d7d  tatus-data": {}}
-00015e30: 270a 2020 2020 2020 2020 6661 6b65 5f73  '.        fake_s
-00015e40: 6372 6970 7428 7365 6c66 2c20 2773 7461  cript(self, 'sta
-00015e50: 7475 732d 6765 7427 2c20 6622 6563 686f  tus-get', f"echo
-00015e60: 2027 7b63 6f6e 7465 6e74 7d27 2229 0a20   '{content}'"). 
-00015e70: 2020 2020 2020 2073 203d 2073 656c 662e         s = self.
-00015e80: 6261 636b 656e 642e 7374 6174 7573 5f67  backend.status_g
-00015e90: 6574 2869 735f 6170 703d 4661 6c73 6529  et(is_app=False)
-00015ea0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00015eb0: 7365 7274 4571 7561 6c28 735b 2773 7461  sertEqual(s['sta
-00015ec0: 7475 7327 5d2c 2022 756e 6b6e 6f77 6e22  tus'], "unknown"
-00015ed0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00015ee0: 7373 6572 7445 7175 616c 2873 5b27 6d65  ssertEqual(s['me
-00015ef0: 7373 6167 6527 5d2c 2022 2229 0a20 2020  ssage'], "").   
-00015f00: 2020 2020 2023 2074 616b 656e 2066 726f       # taken fro
-00015f10: 6d20 6163 7475 616c 204a 756a 7520 6f75  m actual Juju ou
-00015f20: 7470 7574 0a20 2020 2020 2020 2063 6f6e  tput.        con
-00015f30: 7465 6e74 203d 2064 6564 656e 7428 2222  tent = dedent(""
-00015f40: 220a 2020 2020 2020 2020 2020 2020 7b0a  ".            {.
-00015f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f60: 2261 7070 6c69 6361 7469 6f6e 2d73 7461  "application-sta
-00015f70: 7475 7322 3a20 7b0a 2020 2020 2020 2020  tus": {.        
-00015f80: 2020 2020 2020 2020 2020 2020 226d 6573              "mes
-00015f90: 7361 6765 223a 2022 696e 7374 616c 6c69  sage": "installi
-00015fa0: 6e67 222c 0a20 2020 2020 2020 2020 2020  ng",.           
-00015fb0: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-00015fc0: 223a 2022 6d61 696e 7465 6e61 6e63 6522  ": "maintenance"
-00015fd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015fe0: 2020 2020 2020 2273 7461 7475 732d 6461        "status-da
-00015ff0: 7461 223a 207b 7d2c 0a20 2020 2020 2020  ta": {},.       
-00016000: 2020 2020 2020 2020 2020 2020 2022 756e               "un
-00016010: 6974 7322 3a20 7b0a 2020 2020 2020 2020  its": {.        
-00016020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016030: 2275 6f2f 3022 3a20 7b0a 2020 2020 2020  "uo/0": {.      
-00016040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016050: 2020 2020 2020 226d 6573 7361 6765 223a        "message":
-00016060: 2022 222c 0a20 2020 2020 2020 2020 2020   "",.           
-00016070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016080: 2022 7374 6174 7573 223a 2022 6163 7469   "status": "acti
-00016090: 7665 222c 0a20 2020 2020 2020 2020 2020  ve",.           
-000160a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160b0: 2022 7374 6174 7573 2d64 6174 6122 3a20   "status-data": 
-000160c0: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
-000160d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000160e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160f0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00016100: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00016110: 207d 0a20 2020 2020 2020 2020 2020 2022   }.            "
-00016120: 2222 290a 2020 2020 2020 2020 6661 6b65  "").        fake
-00016130: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-00016140: 7461 7475 732d 6765 7427 2c20 6622 6563  tatus-get', f"ec
-00016150: 686f 2027 7b63 6f6e 7465 6e74 7d27 2229  ho '{content}'")
-00016160: 0a20 2020 2020 2020 2073 203d 2073 656c  .        s = sel
-00016170: 662e 6261 636b 656e 642e 7374 6174 7573  f.backend.status
-00016180: 5f67 6574 2869 735f 6170 703d 5472 7565  _get(is_app=True
-00016190: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000161a0: 7373 6572 7445 7175 616c 2873 5b27 7374  ssertEqual(s['st
-000161b0: 6174 7573 275d 2c20 226d 6169 6e74 656e  atus'], "mainten
-000161c0: 616e 6365 2229 0a20 2020 2020 2020 2073  ance").        s
-000161d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000161e0: 735b 276d 6573 7361 6765 275d 2c20 2269  s['message'], "i
-000161f0: 6e73 7461 6c6c 696e 6722 290a 2020 2020  nstalling").    
-00016200: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00016210: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-00016220: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
-00016230: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
-00016240: 2020 2020 2020 2020 5b27 7374 6174 7573          ['status
-00016250: 2d67 6574 272c 2027 2d2d 696e 636c 7564  -get', '--includ
-00016260: 652d 6461 7461 272c 2027 2d2d 6170 706c  e-data', '--appl
-00016270: 6963 6174 696f 6e3d 4661 6c73 6527 2c20  ication=False', 
-00016280: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
-00016290: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
-000162a0: 7374 6174 7573 2d67 6574 272c 2027 2d2d  status-get', '--
-000162b0: 696e 636c 7564 652d 6461 7461 272c 2027  include-data', '
-000162c0: 2d2d 6170 706c 6963 6174 696f 6e3d 5472  --application=Tr
-000162d0: 7565 272c 2027 2d2d 666f 726d 6174 3d6a  ue', '--format=j
-000162e0: 736f 6e27 5d2c 0a20 2020 2020 2020 205d  son'],.        ]
-000162f0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00016300: 7374 6174 7573 5f69 735f 6170 705f 666f  status_is_app_fo
-00016310: 7263 6564 5f6b 7761 7267 7328 7365 6c66  rced_kwargs(self
-00016320: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
-00016330: 7363 7269 7074 2873 656c 662c 2027 7374  script(self, 'st
-00016340: 6174 7573 2d67 6574 272c 2027 6578 6974  atus-get', 'exit
-00016350: 2031 2729 0a20 2020 2020 2020 2066 616b   1').        fak
-00016360: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00016370: 7374 6174 7573 2d73 6574 272c 2027 6578  status-set', 'ex
-00016380: 6974 2031 2729 0a0a 2020 2020 2020 2020  it 1')..        
-00016390: 7465 7374 5f63 6173 6573 203d 2028 0a20  test_cases = (. 
-000163a0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-000163b0: 613a 2073 656c 662e 6261 636b 656e 642e  a: self.backend.
-000163c0: 7374 6174 7573 5f67 6574 2846 616c 7365  status_get(False
-000163d0: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
-000163e0: 616d 6264 613a 2073 656c 662e 6261 636b  ambda: self.back
-000163f0: 656e 642e 7374 6174 7573 5f67 6574 2854  end.status_get(T
-00016400: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
-00016410: 2020 6c61 6d62 6461 3a20 7365 6c66 2e62    lambda: self.b
-00016420: 6163 6b65 6e64 2e73 7461 7475 735f 7365  ackend.status_se
-00016430: 7428 2761 6374 6976 6527 2c20 2727 2c20  t('active', '', 
-00016440: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
-00016450: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
-00016460: 2e62 6163 6b65 6e64 2e73 7461 7475 735f  .backend.status_
-00016470: 7365 7428 2761 6374 6976 6527 2c20 2727  set('active', ''
-00016480: 2c20 5472 7565 292c 0a20 2020 2020 2020  , True),.       
-00016490: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
-000164a0: 6361 7365 2069 6e20 7465 7374 5f63 6173  case in test_cas
-000164b0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000164c0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-000164d0: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-000164e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000164f0: 2020 2063 6173 6528 290a 0a20 2020 2064     case()..    d
-00016500: 6566 2074 6573 745f 6c6f 6361 6c5f 7365  ef test_local_se
-00016510: 745f 696e 7661 6c69 645f 7374 6174 7573  t_invalid_status
-00016520: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00016530: 2320 6a75 6a75 2072 6574 7572 6e73 2065  # juju returns e
-00016540: 7869 7420 636f 6465 2031 2069 6620 796f  xit code 1 if yo
-00016550: 7520 6173 6b20 746f 2073 6574 2073 7461  u ask to set sta
-00016560: 7475 7320 746f 2027 756e 6b6e 6f77 6e27  tus to 'unknown'
-00016570: 206f 7220 2765 7272 6f72 270a 2020 2020   or 'error'.    
-00016580: 2020 2020 6d65 7461 203d 206f 7073 2e63      meta = ops.c
-00016590: 6861 726d 2e43 6861 726d 4d65 7461 2e66  harm.CharmMeta.f
-000165a0: 726f 6d5f 7961 6d6c 2827 2727 0a20 2020  rom_yaml('''.   
-000165b0: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
-000165c0: 7961 7070 0a20 2020 2020 2020 2027 2727  yapp.        '''
-000165d0: 290a 2020 2020 2020 2020 6d6f 6465 6c20  ).        model 
-000165e0: 3d20 6f70 732e 6d6f 6465 6c2e 4d6f 6465  = ops.model.Mode
-000165f0: 6c28 6d65 7461 2c20 7365 6c66 2e62 6163  l(meta, self.bac
-00016600: 6b65 6e64 290a 2020 2020 2020 2020 6661  kend).        fa
-00016610: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00016620: 2773 7461 7475 732d 7365 7427 2c20 2765  'status-set', 'e
-00016630: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
-00016640: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00016650: 2c20 2769 732d 6c65 6164 6572 272c 2027  , 'is-leader', '
-00016660: 6563 686f 2074 7275 6527 290a 0a20 2020  echo true')..   
-00016670: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00016680: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00016690: 6d6f 6465 6c2e 4d6f 6465 6c45 7272 6f72  model.ModelError
-000166a0: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
-000166b0: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
-000166c0: 203d 206f 7073 2e6d 6f64 656c 2e55 6e6b   = ops.model.Unk
-000166d0: 6e6f 776e 5374 6174 7573 2829 0a20 2020  nownStatus().   
-000166e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-000166f0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00016700: 6d6f 6465 6c2e 4d6f 6465 6c45 7272 6f72  model.ModelError
-00016710: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
-00016720: 6f64 656c 2e75 6e69 742e 7374 6174 7573  odel.unit.status
-00016730: 203d 206f 7073 2e6d 6f64 656c 2e45 7272   = ops.model.Err
-00016740: 6f72 5374 6174 7573 2829 0a0a 2020 2020  orStatus()..    
-00016750: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00016760: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-00016770: 5f63 616c 6c73 2873 656c 662c 2054 7275  _calls(self, Tru
-00016780: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
-00016790: 2020 5b27 7374 6174 7573 2d73 6574 272c    ['status-set',
-000167a0: 2027 2d2d 6170 706c 6963 6174 696f 6e3d   '--application=
-000167b0: 4661 6c73 6527 2c20 2775 6e6b 6e6f 776e  False', 'unknown
-000167c0: 272c 2027 275d 2c0a 2020 2020 2020 2020  ', ''],.        
-000167d0: 2020 2020 5b27 7374 6174 7573 2d73 6574      ['status-set
-000167e0: 272c 2027 2d2d 6170 706c 6963 6174 696f  ', '--applicatio
-000167f0: 6e3d 4661 6c73 6527 2c20 2765 7272 6f72  n=False', 'error
-00016800: 272c 2027 275d 2c0a 2020 2020 2020 2020  ', ''],.        
-00016810: 5d29 0a0a 2020 2020 2020 2020 7769 7468  ])..        with
-00016820: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00016830: 6573 286f 7073 2e6d 6f64 656c 2e4d 6f64  es(ops.model.Mod
-00016840: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
-00016850: 2020 2020 2020 6d6f 6465 6c2e 6170 702e        model.app.
-00016860: 7374 6174 7573 203d 206f 7073 2e6d 6f64  status = ops.mod
-00016870: 656c 2e55 6e6b 6e6f 776e 5374 6174 7573  el.UnknownStatus
-00016880: 2829 0a20 2020 2020 2020 2077 6974 6820  ().        with 
-00016890: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-000168a0: 7328 6f70 732e 6d6f 6465 6c2e 4d6f 6465  s(ops.model.Mode
-000168b0: 6c45 7272 6f72 293a 0a20 2020 2020 2020  lError):.       
-000168c0: 2020 2020 206d 6f64 656c 2e61 7070 2e73       model.app.s
-000168d0: 7461 7475 7320 3d20 6f70 732e 6d6f 6465  tatus = ops.mode
-000168e0: 6c2e 4572 726f 7253 7461 7475 7328 290a  l.ErrorStatus().
-000168f0: 0a20 2020 2020 2020 2023 2041 206c 6561  .        # A lea
-00016900: 6465 7273 6869 7020 6368 6563 6b20 6973  dership check is
-00016910: 206e 6565 6465 6420 666f 7220 6170 706c   needed for appl
-00016920: 6963 6174 696f 6e20 7374 6174 7573 2e0a  ication status..
-00016930: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00016940: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
-00016950: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
-00016960: 2054 7275 6529 2c20 5b0a 2020 2020 2020   True), [.      
-00016970: 2020 2020 2020 5b27 6973 2d6c 6561 6465        ['is-leade
-00016980: 7227 2c20 272d 2d66 6f72 6d61 743d 6a73  r', '--format=js
-00016990: 6f6e 275d 2c0a 2020 2020 2020 2020 2020  on'],.          
-000169a0: 2020 5b27 7374 6174 7573 2d73 6574 272c    ['status-set',
-000169b0: 2027 2d2d 6170 706c 6963 6174 696f 6e3d   '--application=
-000169c0: 5472 7565 272c 2027 756e 6b6e 6f77 6e27  True', 'unknown'
-000169d0: 2c20 2727 5d2c 0a20 2020 2020 2020 2020  , ''],.         
-000169e0: 2020 205b 2773 7461 7475 732d 7365 7427     ['status-set'
-000169f0: 2c20 272d 2d61 7070 6c69 6361 7469 6f6e  , '--application
-00016a00: 3d54 7275 6527 2c20 2765 7272 6f72 272c  =True', 'error',
-00016a10: 2027 275d 2c0a 2020 2020 2020 2020 5d29   ''],.        ])
-00016a20: 0a0a 2020 2020 6465 6620 7465 7374 5f6c  ..    def test_l
-00016a30: 6f63 616c 5f67 6574 5f73 7461 7475 7328  ocal_get_status(
-00016a40: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-00016a50: 6f72 206e 616d 652c 2065 7870 6563 7465  or name, expecte
-00016a60: 645f 636c 7320 696e 2028 0a20 2020 2020  d_cls in (.     
-00016a70: 2020 2020 2020 2028 2261 6374 6976 6522         ("active"
-00016a80: 2c20 6f70 732e 6d6f 6465 6c2e 4163 7469  , ops.model.Acti
-00016a90: 7665 5374 6174 7573 292c 0a20 2020 2020  veStatus),.     
-00016aa0: 2020 2020 2020 2028 2277 6169 7469 6e67         ("waiting
-00016ab0: 222c 206f 7073 2e6d 6f64 656c 2e57 6169  ", ops.model.Wai
-00016ac0: 7469 6e67 5374 6174 7573 292c 0a20 2020  tingStatus),.   
-00016ad0: 2020 2020 2020 2020 2028 2262 6c6f 636b           ("block
-00016ae0: 6564 222c 206f 7073 2e6d 6f64 656c 2e42  ed", ops.model.B
-00016af0: 6c6f 636b 6564 5374 6174 7573 292c 0a20  lockedStatus),. 
-00016b00: 2020 2020 2020 2020 2020 2028 226d 6169             ("mai
-00016b10: 6e74 656e 616e 6365 222c 206f 7073 2e6d  ntenance", ops.m
-00016b20: 6f64 656c 2e4d 6169 6e74 656e 616e 6365  odel.Maintenance
-00016b30: 5374 6174 7573 292c 0a20 2020 2020 2020  Status),.       
-00016b40: 2020 2020 2028 2265 7272 6f72 222c 206f       ("error", o
-00016b50: 7073 2e6d 6f64 656c 2e45 7272 6f72 5374  ps.model.ErrorSt
-00016b60: 6174 7573 292c 0a20 2020 2020 2020 2029  atus),.        )
-00016b70: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
-00016b80: 7461 203d 206f 7073 2e63 6861 726d 2e43  ta = ops.charm.C
-00016b90: 6861 726d 4d65 7461 2e66 726f 6d5f 7961  harmMeta.from_ya
-00016ba0: 6d6c 2827 2727 0a20 2020 2020 2020 2020  ml('''.         
-00016bb0: 2020 2020 2020 206e 616d 653a 206d 7961         name: mya
-00016bc0: 7070 0a20 2020 2020 2020 2020 2020 2027  pp.            '
-00016bd0: 2727 290a 2020 2020 2020 2020 2020 2020  '').            
-00016be0: 6d6f 6465 6c20 3d20 6f70 732e 6d6f 6465  model = ops.mode
-00016bf0: 6c2e 4d6f 6465 6c28 6d65 7461 2c20 7365  l.Model(meta, se
-00016c00: 6c66 2e62 6163 6b65 6e64 290a 0a20 2020  lf.backend)..   
-00016c10: 2020 2020 2020 2020 2077 6974 6820 7365           with se
-00016c20: 6c66 2e73 7562 5465 7374 286e 616d 6529  lf.subTest(name)
-00016c30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016c40: 2020 636f 6e74 656e 7420 3d20 6a73 6f6e    content = json
-00016c50: 2e64 756d 7073 287b 0a20 2020 2020 2020  .dumps({.       
-00016c60: 2020 2020 2020 2020 2020 2020 2022 6d65               "me
-00016c70: 7373 6167 6522 3a20 2266 6f6f 222c 0a20  ssage": "foo",. 
-00016c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c90: 2020 2022 7374 6174 7573 223a 206e 616d     "status": nam
-00016ca0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00016cb0: 2020 2020 2020 2022 7374 6174 7573 2d64         "status-d
-00016cc0: 6174 6122 3a20 7b7d 2c0a 2020 2020 2020  ata": {},.      
-00016cd0: 2020 2020 2020 2020 2020 7d29 0a20 2020            }).   
-00016ce0: 2020 2020 2020 2020 2020 2020 2066 616b               fak
-00016cf0: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00016d00: 7374 6174 7573 2d67 6574 272c 2066 2265  status-get', f"e
-00016d10: 6368 6f20 277b 636f 6e74 656e 747d 2722  cho '{content}'"
-00016d20: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00016d30: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-00016d40: 496e 7374 616e 6365 286d 6f64 656c 2e75  Instance(model.u
-00016d50: 6e69 742e 7374 6174 7573 2c20 6578 7065  nit.status, expe
-00016d60: 6374 6564 5f63 6c73 290a 2020 2020 2020  cted_cls).      
-00016d70: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00016d80: 7373 6572 7445 7175 616c 286d 6f64 656c  ssertEqual(model
-00016d90: 2e75 6e69 742e 7374 6174 7573 2e6e 616d  .unit.status.nam
-00016da0: 652c 206e 616d 6529 0a20 2020 2020 2020  e, name).       
-00016db0: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
-00016dc0: 7365 7274 4571 7561 6c28 6d6f 6465 6c2e  sertEqual(model.
-00016dd0: 756e 6974 2e73 7461 7475 732e 6d65 7373  unit.status.mess
-00016de0: 6167 652c 2022 666f 6f22 290a 0a20 2020  age, "foo")..   
-00016df0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00016e00: 7465 6e74 203d 206a 736f 6e2e 6475 6d70  tent = json.dump
-00016e10: 7328 7b0a 2020 2020 2020 2020 2020 2020  s({.            
-00016e20: 2020 2020 2020 2020 2261 7070 6c69 6361          "applica
-00016e30: 7469 6f6e 2d73 7461 7475 7322 3a20 7b0a  tion-status": {.
-00016e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e50: 2020 2020 2020 2020 226d 6573 7361 6765          "message
-00016e60: 223a 2022 6261 7222 2c0a 2020 2020 2020  ": "bar",.      
-00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e80: 2020 2273 7461 7475 7322 3a20 6e61 6d65    "status": name
-00016e90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016ea0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-00016eb0: 732d 6461 7461 223a 207b 7d2c 0a20 2020  s-data": {},.   
-00016ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ed0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00016ee0: 2020 207d 290a 2020 2020 2020 2020 2020     }).          
-00016ef0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
-00016f00: 7428 7365 6c66 2c20 2773 7461 7475 732d  t(self, 'status-
-00016f10: 6765 7427 2c20 6622 6563 686f 2027 7b63  get', f"echo '{c
-00016f20: 6f6e 7465 6e74 7d27 2229 0a20 2020 2020  ontent}'").     
-00016f30: 2020 2020 2020 2020 2020 2066 616b 655f             fake_
-00016f40: 7363 7269 7074 2873 656c 662c 2027 6973  script(self, 'is
-00016f50: 2d6c 6561 6465 7227 2c20 2765 6368 6f20  -leader', 'echo 
-00016f60: 7472 7565 2729 0a0a 2020 2020 2020 2020  true')..        
-00016f70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00016f80: 6572 7449 7349 6e73 7461 6e63 6528 6d6f  ertIsInstance(mo
-00016f90: 6465 6c2e 6170 702e 7374 6174 7573 2c20  del.app.status, 
-00016fa0: 6578 7065 6374 6564 5f63 6c73 290a 2020  expected_cls).  
-00016fb0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00016fc0: 6c66 2e61 7373 6572 7445 7175 616c 286d  lf.assertEqual(m
-00016fd0: 6f64 656c 2e61 7070 2e73 7461 7475 732e  odel.app.status.
-00016fe0: 6e61 6d65 2c20 6e61 6d65 290a 2020 2020  name, name).    
-00016ff0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017000: 2e61 7373 6572 7445 7175 616c 286d 6f64  .assertEqual(mod
-00017010: 656c 2e61 7070 2e73 7461 7475 732e 6d65  el.app.status.me
-00017020: 7373 6167 652c 2022 6261 7222 290a 0a20  ssage, "bar").. 
-00017030: 2020 2064 6566 2074 6573 745f 7374 6174     def test_stat
-00017040: 7573 5f73 6574 5f69 735f 6170 705f 6e6f  us_set_is_app_no
-00017050: 745f 626f 6f6c 5f72 6169 7365 7328 7365  t_bool_raises(se
-00017060: 6c66 293a 0a20 2020 2020 2020 2066 6f72  lf):.        for
-00017070: 2069 735f 6170 705f 7620 696e 205b 4e6f   is_app_v in [No
-00017080: 6e65 2c20 312c 2032 2e30 2c20 2761 272c  ne, 1, 2.0, 'a',
-00017090: 2062 2762 6565 6627 2c20 6f62 6a65 6374   b'beef', object
-000170a0: 5d3a 0a20 2020 2020 2020 2020 2020 2077  ]:.            w
-000170b0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000170c0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-000170d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000170e0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e73    self.backend.s
-000170f0: 7461 7475 735f 7365 7428 6f70 732e 6d6f  tatus_set(ops.mo
-00017100: 6465 6c2e 4163 7469 7665 5374 6174 7573  del.ActiveStatus
-00017110: 2c20 6973 5f61 7070 3d69 735f 6170 705f  , is_app=is_app_
-00017120: 7629 0a0a 2020 2020 6465 6620 7465 7374  v)..    def test
-00017130: 5f73 746f 7261 6765 5f74 6f6f 6c5f 6572  _storage_tool_er
-00017140: 726f 7273 2873 656c 6629 3a0a 2020 2020  rors(self):.    
-00017150: 2020 2020 7465 7374 5f63 6173 6573 203d      test_cases =
-00017160: 205b 280a 2020 2020 2020 2020 2020 2020   [(.            
-00017170: 6c61 6d62 6461 3a20 6661 6b65 5f73 6372  lambda: fake_scr
-00017180: 6970 7428 7365 6c66 2c20 2773 746f 7261  ipt(self, 'stora
-00017190: 6765 2d6c 6973 7427 2c20 2765 6368 6f20  ge-list', 'echo 
-000171a0: 666f 6f65 7272 6f72 203e 2632 203b 2065  fooerror >&2 ; e
-000171b0: 7869 7420 3127 292c 0a20 2020 2020 2020  xit 1'),.       
-000171c0: 2020 2020 206c 616d 6264 613a 2073 656c       lambda: sel
-000171d0: 662e 6261 636b 656e 642e 7374 6f72 6167  f.backend.storag
-000171e0: 655f 6c69 7374 2827 666f 6f62 6172 2729  e_list('foobar')
-000171f0: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
-00017200: 732e 6d6f 6465 6c2e 4d6f 6465 6c45 7272  s.model.ModelErr
-00017210: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-00017220: 5b5b 2773 746f 7261 6765 2d6c 6973 7427  [['storage-list'
-00017230: 2c20 2766 6f6f 6261 7227 2c20 272d 2d66  , 'foobar', '--f
-00017240: 6f72 6d61 743d 6a73 6f6e 275d 5d2c 0a20  ormat=json']],. 
-00017250: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
-00017260: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-00017270: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00017280: 2c20 2773 746f 7261 6765 2d67 6574 272c  , 'storage-get',
-00017290: 2027 6563 686f 2066 6f6f 6572 726f 7220   'echo fooerror 
-000172a0: 3e26 3220 3b20 6578 6974 2031 2729 2c0a  >&2 ; exit 1'),.
-000172b0: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-000172c0: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
-000172d0: 2e73 746f 7261 6765 5f67 6574 2827 666f  .storage_get('fo
-000172e0: 6f62 6172 272c 2027 736f 6d65 6174 7472  obar', 'someattr
-000172f0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00017300: 6f70 732e 6d6f 6465 6c2e 4d6f 6465 6c45  ops.model.ModelE
-00017310: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-00017320: 2020 5b5b 2773 746f 7261 6765 2d67 6574    [['storage-get
-00017330: 272c 2027 2d73 272c 2027 666f 6f62 6172  ', '-s', 'foobar
-00017340: 272c 2027 736f 6d65 6174 7472 272c 2027  ', 'someattr', '
-00017350: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d5d  --format=json']]
-00017360: 2c0a 2020 2020 2020 2020 292c 2028 0a20  ,.        ), (. 
-00017370: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00017380: 613a 2066 616b 655f 7363 7269 7074 2873  a: fake_script(s
-00017390: 656c 662c 2027 7374 6f72 6167 652d 6164  elf, 'storage-ad
-000173a0: 6427 2c20 2765 6368 6f20 666f 6f65 7272  d', 'echo fooerr
-000173b0: 6f72 203e 2632 203b 2065 7869 7420 3127  or >&2 ; exit 1'
-000173c0: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
-000173d0: 616d 6264 613a 2073 656c 662e 6261 636b  ambda: self.back
-000173e0: 656e 642e 7374 6f72 6167 655f 6164 6428  end.storage_add(
-000173f0: 2766 6f6f 6261 7227 2c20 636f 756e 743d  'foobar', count=
-00017400: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
-00017410: 6f70 732e 6d6f 6465 6c2e 4d6f 6465 6c45  ops.model.ModelE
-00017420: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-00017430: 2020 5b5b 2773 746f 7261 6765 2d61 6464    [['storage-add
-00017440: 272c 2027 666f 6f62 6172 3d32 275d 5d2c  ', 'foobar=2']],
-00017450: 0a20 2020 2020 2020 2029 2c20 280a 2020  .        ), (.  
-00017460: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-00017470: 3a20 6661 6b65 5f73 6372 6970 7428 7365  : fake_script(se
-00017480: 6c66 2c20 2773 746f 7261 6765 2d61 6464  lf, 'storage-add
-00017490: 272c 2027 6563 686f 2066 6f6f 6572 726f  ', 'echo fooerro
-000174a0: 7220 3e26 3220 3b20 6578 6974 2031 2729  r >&2 ; exit 1')
-000174b0: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-000174c0: 6d62 6461 3a20 7365 6c66 2e62 6163 6b65  mbda: self.backe
-000174d0: 6e64 2e73 746f 7261 6765 5f61 6464 2827  nd.storage_add('
-000174e0: 666f 6f62 6172 272c 2063 6f75 6e74 3d6f  foobar', count=o
-000174f0: 626a 6563 7429 2c0a 2020 2020 2020 2020  bject),.        
-00017500: 2020 2020 5479 7065 4572 726f 722c 0a20      TypeError,. 
-00017510: 2020 2020 2020 2020 2020 205b 5d2c 0a20             [],. 
-00017520: 2020 2020 2020 2029 2c20 280a 2020 2020         ), (.    
-00017530: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-00017540: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00017550: 2c20 2773 746f 7261 6765 2d61 6464 272c  , 'storage-add',
-00017560: 2027 6563 686f 2066 6f6f 6572 726f 7220   'echo fooerror 
-00017570: 3e26 3220 3b20 6578 6974 2031 2729 2c0a  >&2 ; exit 1'),.
-00017580: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-00017590: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
-000175a0: 2e73 746f 7261 6765 5f61 6464 2827 666f  .storage_add('fo
-000175b0: 6f62 6172 272c 2063 6f75 6e74 3d54 7275  obar', count=Tru
-000175c0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-000175d0: 5479 7065 4572 726f 722c 0a20 2020 2020  TypeError,.     
-000175e0: 2020 2020 2020 205b 5d2c 0a20 2020 2020         [],.     
-000175f0: 2020 2029 5d0a 2020 2020 2020 2020 666f     )].        fo
-00017600: 7220 646f 5f66 616b 652c 2072 756e 2c20  r do_fake, run, 
-00017610: 6578 6365 7074 696f 6e2c 2063 616c 6c73  exception, calls
-00017620: 2069 6e20 7465 7374 5f63 6173 6573 3a0a   in test_cases:.
-00017630: 2020 2020 2020 2020 2020 2020 646f 5f66              do_f
-00017640: 616b 6528 290a 2020 2020 2020 2020 2020  ake().          
-00017650: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00017660: 7274 5261 6973 6573 2865 7863 6570 7469  rtRaises(excepti
-00017670: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-00017680: 2020 2020 2072 756e 2829 0a20 2020 2020       run().     
-00017690: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000176a0: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-000176b0: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-000176c0: 636c 6561 723d 5472 7565 292c 2063 616c  clear=True), cal
-000176d0: 6c73 290a 0a20 2020 2064 6566 2074 6573  ls)..    def tes
-000176e0: 745f 6e65 7477 6f72 6b5f 6765 7428 7365  t_network_get(se
-000176f0: 6c66 293a 0a20 2020 2020 2020 206e 6574  lf):.        net
-00017700: 776f 726b 5f67 6574 5f6f 7574 203d 2027  work_get_out = '
-00017710: 2727 7b0a 2020 2262 696e 642d 6164 6472  ''{.  "bind-addr
-00017720: 6573 7365 7322 3a20 5b0a 2020 2020 7b0a  esses": [.    {.
-00017730: 2020 2020 2020 226d 6163 2d61 6464 7265        "mac-addre
-00017740: 7373 223a 2022 222c 0a20 2020 2020 2022  ss": "",.      "
-00017750: 696e 7465 7266 6163 652d 6e61 6d65 223a  interface-name":
-00017760: 2022 222c 0a20 2020 2020 2022 6164 6472   "",.      "addr
-00017770: 6573 7365 7322 3a20 5b0a 2020 2020 2020  esses": [.      
-00017780: 2020 7b0a 2020 2020 2020 2020 2020 2268    {.          "h
-00017790: 6f73 746e 616d 6522 3a20 2222 2c0a 2020  ostname": "",.  
-000177a0: 2020 2020 2020 2020 2276 616c 7565 223a          "value":
-000177b0: 2022 3139 322e 302e 322e 3222 2c0a 2020   "192.0.2.2",.  
-000177c0: 2020 2020 2020 2020 2263 6964 7222 3a20          "cidr": 
-000177d0: 2222 0a20 2020 2020 2020 207d 0a20 2020  "".        }.   
-000177e0: 2020 205d 0a20 2020 207d 0a20 205d 2c0a     ].    }.  ],.
-000177f0: 2020 2265 6772 6573 732d 7375 626e 6574    "egress-subnet
-00017800: 7322 3a20 5b0a 2020 2020 2231 3932 2e30  s": [.    "192.0
-00017810: 2e32 2e32 2f33 3222 0a20 205d 2c0a 2020  .2.2/32".  ],.  
-00017820: 2269 6e67 7265 7373 2d61 6464 7265 7373  "ingress-address
-00017830: 6573 223a 205b 0a20 2020 2022 3139 322e  es": [.    "192.
-00017840: 302e 322e 3222 0a20 205d 0a7d 2727 270a  0.2.2".  ].}'''.
-00017850: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-00017860: 6970 7428 7365 6c66 2c20 276e 6574 776f  ipt(self, 'netwo
-00017870: 726b 2d67 6574 272c 0a20 2020 2020 2020  rk-get',.       
-00017880: 2020 2020 2020 2020 2020 2020 2066 2727               f''
-00017890: 275b 2022 2431 2220 3d20 6465 6164 6265  '[ "$1" = deadbe
-000178a0: 6566 205d 2026 2620 6563 686f 2027 7b6e  ef ] && echo '{n
-000178b0: 6574 776f 726b 5f67 6574 5f6f 7574 7d27  etwork_get_out}'
-000178c0: 207c 7c20 6578 6974 2031 2727 2729 0a20   || exit 1'''). 
-000178d0: 2020 2020 2020 206e 6574 776f 726b 5f69         network_i
-000178e0: 6e66 6f20 3d20 7365 6c66 2e62 6163 6b65  nfo = self.backe
-000178f0: 6e64 2e6e 6574 776f 726b 5f67 6574 2827  nd.network_get('
-00017900: 6465 6164 6265 6566 2729 0a20 2020 2020  deadbeef').     
-00017910: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00017920: 7561 6c28 6e65 7477 6f72 6b5f 696e 666f  ual(network_info
-00017930: 2c20 6a73 6f6e 2e6c 6f61 6473 286e 6574  , json.loads(net
-00017940: 776f 726b 5f67 6574 5f6f 7574 2929 0a20  work_get_out)). 
-00017950: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00017960: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-00017970: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-00017980: 636c 6561 723d 5472 7565 292c 0a20 2020  clear=True),.   
-00017990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179a0: 2020 2020 2020 5b5b 276e 6574 776f 726b        [['network
-000179b0: 2d67 6574 272c 2027 6465 6164 6265 6566  -get', 'deadbeef
-000179c0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-000179d0: 6e27 5d5d 290a 0a20 2020 2020 2020 206e  n']])..        n
-000179e0: 6574 776f 726b 5f69 6e66 6f20 3d20 7365  etwork_info = se
-000179f0: 6c66 2e62 6163 6b65 6e64 2e6e 6574 776f  lf.backend.netwo
-00017a00: 726b 5f67 6574 2827 6465 6164 6265 6566  rk_get('deadbeef
-00017a10: 272c 2031 290a 2020 2020 2020 2020 7365  ', 1).        se
-00017a20: 6c66 2e61 7373 6572 7445 7175 616c 286e  lf.assertEqual(n
-00017a30: 6574 776f 726b 5f69 6e66 6f2c 206a 736f  etwork_info, jso
-00017a40: 6e2e 6c6f 6164 7328 6e65 7477 6f72 6b5f  n.loads(network_
-00017a50: 6765 745f 6f75 7429 290a 2020 2020 2020  get_out)).      
-00017a60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00017a70: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-00017a80: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-00017a90: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-00017aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ab0: 205b 5b27 6e65 7477 6f72 6b2d 6765 7427   [['network-get'
-00017ac0: 2c20 2764 6561 6462 6565 6627 2c20 272d  , 'deadbeef', '-
-00017ad0: 7227 2c20 2731 272c 2027 2d2d 666f 726d  r', '1', '--form
-00017ae0: 6174 3d6a 736f 6e27 5d5d 290a 0a20 2020  at=json']])..   
-00017af0: 2064 6566 2074 6573 745f 6e65 7477 6f72   def test_networ
-00017b00: 6b5f 6765 745f 6572 726f 7273 2873 656c  k_get_errors(sel
-00017b10: 6629 3a0a 2020 2020 2020 2020 6572 725f  f):.        err_
-00017b20: 6e6f 5f65 6e64 706f 696e 7420 3d20 2745  no_endpoint = 'E
-00017b30: 5252 4f52 206e 6f20 6e65 7477 6f72 6b20  RROR no network 
-00017b40: 636f 6e66 6967 2066 6f75 6e64 2066 6f72  config found for
-00017b50: 2062 696e 6469 6e67 2022 2432 2227 0a20   binding "$2"'. 
-00017b60: 2020 2020 2020 2065 7272 5f6e 6f5f 7265         err_no_re
-00017b70: 6c20 3d20 2745 5252 4f52 2069 6e76 616c  l = 'ERROR inval
-00017b80: 6964 2076 616c 7565 2022 2433 2220 666f  id value "$3" fo
-00017b90: 7220 6f70 7469 6f6e 202d 723a 2072 656c  r option -r: rel
-00017ba0: 6174 696f 6e20 6e6f 7420 666f 756e 6427  ation not found'
-00017bb0: 0a0a 2020 2020 2020 2020 7465 7374 5f63  ..        test_c
-00017bc0: 6173 6573 203d 205b 280a 2020 2020 2020  ases = [(.      
-00017bd0: 2020 2020 2020 6c61 6d62 6461 3a20 6661        lambda: fa
-00017be0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00017bf0: 276e 6574 776f 726b 2d67 6574 272c 0a20  'network-get',. 
-00017c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017c20: 2765 6368 6f20 7b65 7272 5f6e 6f5f 656e  'echo {err_no_en
-00017c30: 6470 6f69 6e74 7d20 3e26 3220 3b20 6578  dpoint} >&2 ; ex
-00017c40: 6974 2031 2729 2c0a 2020 2020 2020 2020  it 1'),.        
-00017c50: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
-00017c60: 2e62 6163 6b65 6e64 2e6e 6574 776f 726b  .backend.network
-00017c70: 5f67 6574 2822 6465 6164 6265 6566 2229  _get("deadbeef")
-00017c80: 2c0a 2020 2020 2020 2020 2020 2020 6f70  ,.            op
-00017c90: 732e 6d6f 6465 6c2e 4d6f 6465 6c45 7272  s.model.ModelErr
-00017ca0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-00017cb0: 5b5b 276e 6574 776f 726b 2d67 6574 272c  [['network-get',
-00017cc0: 2027 6465 6164 6265 6566 272c 2027 2d2d   'deadbeef', '--
-00017cd0: 666f 726d 6174 3d6a 736f 6e27 5d5d 2c0a  format=json']],.
-00017ce0: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
-00017cf0: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-00017d00: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00017d10: 662c 2027 6e65 7477 6f72 6b2d 6765 7427  f, 'network-get'
-00017d20: 2c20 6627 6563 686f 207b 6572 725f 6e6f  , f'echo {err_no
-00017d30: 5f72 656c 7d20 3e26 3220 3b20 6578 6974  _rel} >&2 ; exit
-00017d40: 2032 2729 2c0a 2020 2020 2020 2020 2020   2'),.          
-00017d50: 2020 6c61 6d62 6461 3a20 7365 6c66 2e62    lambda: self.b
-00017d60: 6163 6b65 6e64 2e6e 6574 776f 726b 5f67  ackend.network_g
-00017d70: 6574 2822 6465 6164 6265 6566 222c 2033  et("deadbeef", 3
-00017d80: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
-00017d90: 7073 2e6d 6f64 656c 2e52 656c 6174 696f  ps.model.Relatio
-00017da0: 6e4e 6f74 466f 756e 6445 7272 6f72 2c0a  nNotFoundError,.
-00017db0: 2020 2020 2020 2020 2020 2020 5b5b 276e              [['n
-00017dc0: 6574 776f 726b 2d67 6574 272c 2027 6465  etwork-get', 'de
-00017dd0: 6164 6265 6566 272c 2027 2d72 272c 2027  adbeef', '-r', '
-00017de0: 3327 2c20 272d 2d66 6f72 6d61 743d 6a73  3', '--format=js
-00017df0: 6f6e 275d 5d2c 0a20 2020 2020 2020 2029  on']],.        )
-00017e00: 5d0a 2020 2020 2020 2020 666f 7220 646f  ].        for do
-00017e10: 5f66 616b 652c 2072 756e 2c20 6578 6365  _fake, run, exce
-00017e20: 7074 696f 6e2c 2063 616c 6c73 2069 6e20  ption, calls in 
-00017e30: 7465 7374 5f63 6173 6573 3a0a 2020 2020  test_cases:.    
-00017e40: 2020 2020 2020 2020 646f 5f66 616b 6528          do_fake(
-00017e50: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
-00017e60: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00017e70: 6973 6573 2865 7863 6570 7469 6f6e 293a  ises(exception):
-00017e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017e90: 2072 756e 2829 0a20 2020 2020 2020 2020   run().         
-00017ea0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00017eb0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-00017ec0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-00017ed0: 723d 5472 7565 292c 2063 616c 6c73 290a  r=True), calls).
-00017ee0: 0a20 2020 2064 6566 2074 6573 745f 6163  .    def test_ac
-00017ef0: 7469 6f6e 5f67 6574 5f65 7272 6f72 2873  tion_get_error(s
-00017f00: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-00017f10: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00017f20: 2761 6374 696f 6e2d 6765 7427 2c20 2727  'action-get', ''
-00017f30: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
-00017f40: 6372 6970 7428 7365 6c66 2c20 2761 6374  cript(self, 'act
-00017f50: 696f 6e2d 6765 7427 2c20 2765 6368 6f20  ion-get', 'echo 
-00017f60: 666f 6f65 7272 6f72 203e 2632 203b 2065  fooerror >&2 ; e
-00017f70: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
-00017f80: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00017f90: 5261 6973 6573 286f 7073 2e6d 6f64 656c  Raises(ops.model
-00017fa0: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
-00017fb0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-00017fc0: 6163 6b65 6e64 2e61 6374 696f 6e5f 6765  ackend.action_ge
-00017fd0: 7428 290a 2020 2020 2020 2020 6361 6c6c  t().        call
-00017fe0: 7320 3d20 5b5b 2761 6374 696f 6e2d 6765  s = [['action-ge
-00017ff0: 7427 2c20 272d 2d66 6f72 6d61 743d 6a73  t', '--format=js
-00018000: 6f6e 275d 5d0a 2020 2020 2020 2020 7365  on']].        se
-00018010: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-00018020: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-00018030: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-00018040: 6529 2c20 6361 6c6c 7329 0a0a 2020 2020  e), calls)..    
-00018050: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
-00018060: 7365 745f 6572 726f 7228 7365 6c66 293a  set_error(self):
-00018070: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-00018080: 7269 7074 2873 656c 662c 2027 6163 7469  ript(self, 'acti
-00018090: 6f6e 2d67 6574 272c 2027 2729 0a20 2020  on-get', '').   
-000180a0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-000180b0: 2873 656c 662c 2027 6163 7469 6f6e 2d73  (self, 'action-s
-000180c0: 6574 272c 2027 6563 686f 2066 6f6f 6572  et', 'echo fooer
-000180d0: 726f 7220 3e26 3220 3b20 6578 6974 2031  ror >&2 ; exit 1
-000180e0: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
-000180f0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00018100: 7328 6f70 732e 6d6f 6465 6c2e 4d6f 6465  s(ops.model.Mode
-00018110: 6c45 7272 6f72 293a 0a20 2020 2020 2020  lError):.       
-00018120: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
-00018130: 642e 6163 7469 6f6e 5f73 6574 284f 7264  d.action_set(Ord
-00018140: 6572 6564 4469 6374 285b 2827 666f 6f27  eredDict([('foo'
-00018150: 2c20 2762 6172 2729 2c20 2827 6465 6164  , 'bar'), ('dead
-00018160: 272c 2027 6265 6566 2063 6166 6527 295d  ', 'beef cafe')]
-00018170: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00018180: 6173 7365 7274 436f 756e 7445 7175 616c  assertCountEqual
-00018190: 280a 2020 2020 2020 2020 2020 2020 5b22  (.            ["
-000181a0: 6163 7469 6f6e 2d73 6574 222c 2022 6465  action-set", "de
-000181b0: 6164 3d62 6565 6620 6361 6665 222c 2022  ad=beef cafe", "
-000181c0: 666f 6f3d 6261 7222 5d2c 2066 616b 655f  foo=bar"], fake_
-000181d0: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-000181e0: 662c 2063 6c65 6172 3d54 7275 6529 5b30  f, clear=True)[0
-000181f0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00018200: 5f61 6374 696f 6e5f 6c6f 675f 6572 726f  _action_log_erro
-00018210: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-00018220: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00018230: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
-00018240: 2027 2729 0a20 2020 2020 2020 2066 616b   '').        fak
-00018250: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00018260: 6163 7469 6f6e 2d6c 6f67 272c 2027 6563  action-log', 'ec
-00018270: 686f 2066 6f6f 6572 726f 7220 3e26 3220  ho fooerror >&2 
-00018280: 3b20 6578 6974 2031 2729 0a20 2020 2020  ; exit 1').     
-00018290: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-000182a0: 6572 7452 6169 7365 7328 6f70 732e 6d6f  ertRaises(ops.mo
-000182b0: 6465 6c2e 4d6f 6465 6c45 7272 6f72 293a  del.ModelError):
-000182c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000182d0: 662e 6261 636b 656e 642e 6163 7469 6f6e  f.backend.action
-000182e0: 5f6c 6f67 2827 6c6f 672d 6d65 7373 6167  _log('log-messag
-000182f0: 6527 290a 2020 2020 2020 2020 6361 6c6c  e').        call
-00018300: 7320 3d20 5b5b 2261 6374 696f 6e2d 6c6f  s = [["action-lo
-00018310: 6722 2c20 226c 6f67 2d6d 6573 7361 6765  g", "log-message
-00018320: 225d 5d0a 2020 2020 2020 2020 7365 6c66  "]].        self
-00018330: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-00018340: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-00018350: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
-00018360: 2c20 6361 6c6c 7329 0a0a 2020 2020 6465  , calls)..    de
-00018370: 6620 7465 7374 5f61 6374 696f 6e5f 6765  f test_action_ge
-00018380: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00018390: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-000183a0: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
-000183b0: 2022 2222 6563 686f 2027 7b22 666f 6f2d   """echo '{"foo-
-000183c0: 6e61 6d65 223a 2022 6261 7222 2c20 2273  name": "bar", "s
-000183d0: 696c 656e 7422 3a20 6661 6c73 657d 2722  ilent": false}'"
-000183e0: 2222 290a 2020 2020 2020 2020 7061 7261  "").        para
-000183f0: 6d73 203d 2073 656c 662e 6261 636b 656e  ms = self.backen
-00018400: 642e 6163 7469 6f6e 5f67 6574 2829 0a20  d.action_get(). 
-00018410: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00018420: 7274 4571 7561 6c28 7061 7261 6d73 5b27  rtEqual(params['
-00018430: 666f 6f2d 6e61 6d65 275d 2c20 2762 6172  foo-name'], 'bar
-00018440: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00018450: 6173 7365 7274 4571 7561 6c28 7061 7261  assertEqual(para
-00018460: 6d73 5b27 7369 6c65 6e74 275d 2c20 4661  ms['silent'], Fa
-00018470: 6c73 6529 0a20 2020 2020 2020 2073 656c  lse).        sel
-00018480: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00018490: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-000184a0: 7365 6c66 292c 205b 5b27 6163 7469 6f6e  self), [['action
-000184b0: 2d67 6574 272c 2027 2d2d 666f 726d 6174  -get', '--format
-000184c0: 3d6a 736f 6e27 5d5d 290a 0a20 2020 2064  =json']])..    d
-000184d0: 6566 2074 6573 745f 6163 7469 6f6e 5f73  ef test_action_s
-000184e0: 6574 2873 656c 6629 3a0a 2020 2020 2020  et(self):.      
-000184f0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00018500: 6c66 2c20 2761 6374 696f 6e2d 6765 7427  lf, 'action-get'
-00018510: 2c20 2765 7869 7420 3127 290a 2020 2020  , 'exit 1').    
-00018520: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-00018530: 7365 6c66 2c20 2761 6374 696f 6e2d 7365  self, 'action-se
-00018540: 7427 2c20 2765 7869 7420 3027 290a 2020  t', 'exit 0').  
-00018550: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
-00018560: 6e64 2e61 6374 696f 6e5f 7365 7428 7b27  nd.action_set({'
-00018570: 7827 3a20 2764 6561 6420 6265 6566 272c  x': 'dead beef',
-00018580: 2027 7927 3a20 317d 290a 2020 2020 2020   'y': 1}).      
-00018590: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
-000185a0: 6e74 4571 7561 6c28 5b27 6163 7469 6f6e  ntEqual(['action
-000185b0: 2d73 6574 272c 2027 783d 6465 6164 2062  -set', 'x=dead b
-000185c0: 6565 6627 2c20 2779 3d31 275d 2c20 6661  eef', 'y=1'], fa
-000185d0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-000185e0: 7365 6c66 295b 305d 290a 0a20 2020 2064  self)[0])..    d
-000185f0: 6566 2074 6573 745f 6163 7469 6f6e 5f73  ef test_action_s
-00018600: 6574 5f6b 6579 5f76 616c 6964 6174 696f  et_key_validatio
-00018610: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00018620: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00018630: 7452 6169 7365 7328 5661 6c75 6545 7272  tRaises(ValueErr
-00018640: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00018650: 2073 656c 662e 6261 636b 656e 642e 6163   self.backend.ac
-00018660: 7469 6f6e 5f73 6574 287b 2758 273a 2027  tion_set({'X': '
-00018670: 6465 6164 2062 6565 6627 2c20 2779 273a  dead beef', 'y':
-00018680: 2031 7d29 0a20 2020 2020 2020 2077 6974   1}).        wit
-00018690: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-000186a0: 7365 7328 5661 6c75 6545 7272 6f72 293a  ses(ValueError):
-000186b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000186c0: 662e 6261 636b 656e 642e 6163 7469 6f6e  f.backend.action
-000186d0: 5f73 6574 287b 2773 6f6d 6526 6b65 7927  _set({'some&key'
-000186e0: 3a20 2764 6561 6420 6265 6566 272c 2027  : 'dead beef', '
-000186f0: 7927 3a20 317d 290a 2020 2020 2020 2020  y': 1}).        
-00018700: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00018710: 5261 6973 6573 2856 616c 7565 4572 726f  Raises(ValueErro
-00018720: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00018730: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
-00018740: 696f 6e5f 7365 7428 7b27 736f 6d65 4b65  ion_set({'someKe
-00018750: 7927 3a20 2764 6561 6420 6265 6566 272c  y': 'dead beef',
-00018760: 2027 7927 3a20 317d 290a 2020 2020 2020   'y': 1}).      
-00018770: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00018780: 7274 5261 6973 6573 2856 616c 7565 4572  rtRaises(ValueEr
-00018790: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-000187a0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
-000187b0: 6374 696f 6e5f 7365 7428 7b27 736f 6d65  ction_set({'some
-000187c0: 5f6b 6579 273a 2027 6465 6164 2062 6565  _key': 'dead bee
-000187d0: 6627 2c20 2779 273a 2031 7d29 0a0a 2020  f', 'y': 1})..  
-000187e0: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
-000187f0: 6e5f 7365 745f 6e65 7374 6564 2873 656c  n_set_nested(sel
-00018800: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-00018810: 5f73 6372 6970 7428 7365 6c66 2c20 2761  _script(self, 'a
-00018820: 6374 696f 6e2d 6765 7427 2c20 2765 7869  ction-get', 'exi
-00018830: 7420 3127 290a 2020 2020 2020 2020 6661  t 1').        fa
-00018840: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-00018850: 2761 6374 696f 6e2d 7365 7427 2c20 2765  'action-set', 'e
-00018860: 7869 7420 3027 290a 2020 2020 2020 2020  xit 0').        
-00018870: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
-00018880: 696f 6e5f 7365 7428 7b27 6127 3a20 7b27  ion_set({'a': {'
-00018890: 6227 3a20 312c 2027 6327 3a20 327d 2c20  b': 1, 'c': 2}, 
-000188a0: 2764 273a 2033 7d29 0a20 2020 2020 2020  'd': 3}).       
-000188b0: 2073 656c 662e 6173 7365 7274 436f 756e   self.assertCoun
-000188c0: 7445 7175 616c 285b 2761 6374 696f 6e2d  tEqual(['action-
-000188d0: 7365 7427 2c20 2761 2e62 3d31 272c 2027  set', 'a.b=1', '
-000188e0: 612e 633d 3227 2c20 2764 3d33 275d 2c20  a.c=2', 'd=3'], 
-000188f0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-00018900: 7328 7365 6c66 295b 305d 290a 0a20 2020  s(self)[0])..   
-00018910: 2064 6566 2074 6573 745f 6163 7469 6f6e   def test_action
-00018920: 5f73 6574 5f6d 6f72 655f 6e65 7374 6564  _set_more_nested
-00018930: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00018940: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00018950: 2c20 2761 6374 696f 6e2d 6765 7427 2c20  , 'action-get', 
-00018960: 2765 7869 7420 3127 290a 2020 2020 2020  'exit 1').      
-00018970: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00018980: 6c66 2c20 2761 6374 696f 6e2d 7365 7427  lf, 'action-set'
-00018990: 2c20 2765 7869 7420 3027 290a 2020 2020  , 'exit 0').    
-000189a0: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
-000189b0: 2e61 6374 696f 6e5f 7365 7428 7b27 6127  .action_set({'a'
-000189c0: 3a20 7b27 6227 3a20 312c 2027 6327 3a20  : {'b': 1, 'c': 
-000189d0: 322c 2027 6427 3a20 7b27 6527 3a20 337d  2, 'd': {'e': 3}
-000189e0: 7d2c 2027 6627 3a20 347d 290a 2020 2020  }, 'f': 4}).    
-000189f0: 2020 2020 7365 6c66 2e61 7373 6572 7443      self.assertC
-00018a00: 6f75 6e74 4571 7561 6c28 0a20 2020 2020  ountEqual(.     
-00018a10: 2020 2020 2020 205b 2761 6374 696f 6e2d         ['action-
-00018a20: 7365 7427 2c20 2761 2e62 3d31 272c 2027  set', 'a.b=1', '
-00018a30: 612e 633d 3227 2c20 2761 2e64 2e65 3d33  a.c=2', 'a.d.e=3
-00018a40: 272c 2027 663d 3427 5d2c 2066 616b 655f  ', 'f=4'], fake_
-00018a50: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-00018a60: 6629 5b30 5d29 0a0a 2020 2020 6465 6620  f)[0])..    def 
-00018a70: 7465 7374 5f61 6374 696f 6e5f 7365 745f  test_action_set_
-00018a80: 646f 7474 6564 5f64 6963 7428 7365 6c66  dotted_dict(self
-00018a90: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
-00018aa0: 7363 7269 7074 2873 656c 662c 2027 6163  script(self, 'ac
-00018ab0: 7469 6f6e 2d67 6574 272c 2027 6578 6974  tion-get', 'exit
-00018ac0: 2031 2729 0a20 2020 2020 2020 2066 616b   1').        fak
-00018ad0: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00018ae0: 6163 7469 6f6e 2d73 6574 272c 2027 6578  action-set', 'ex
-00018af0: 6974 2030 2729 0a20 2020 2020 2020 2073  it 0').        s
-00018b00: 656c 662e 6261 636b 656e 642e 6163 7469  elf.backend.acti
-00018b10: 6f6e 5f73 6574 287b 2761 2e62 273a 2031  on_set({'a.b': 1
-00018b20: 2c20 2761 273a 207b 2763 273a 2032 7d2c  , 'a': {'c': 2},
-00018b30: 2027 6427 3a20 337d 290a 2020 2020 2020   'd': 3}).      
-00018b40: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
-00018b50: 6e74 4571 7561 6c28 5b27 6163 7469 6f6e  ntEqual(['action
-00018b60: 2d73 6574 272c 2027 612e 623d 3127 2c20  -set', 'a.b=1', 
-00018b70: 2761 2e63 3d32 272c 2027 643d 3327 5d2c  'a.c=2', 'd=3'],
-00018b80: 2066 616b 655f 7363 7269 7074 5f63 616c   fake_script_cal
-00018b90: 6c73 2873 656c 6629 5b30 5d29 0a0a 2020  ls(self)[0])..  
-00018ba0: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
-00018bb0: 6e5f 7365 745f 6475 706c 6963 6174 6564  n_set_duplicated
-00018bc0: 5f6b 6579 7328 7365 6c66 293a 0a20 2020  _keys(self):.   
-00018bd0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-00018be0: 2873 656c 662c 2027 6163 7469 6f6e 2d67  (self, 'action-g
-00018bf0: 6574 272c 2027 6578 6974 2031 2729 0a20  et', 'exit 1'). 
-00018c00: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-00018c10: 7074 2873 656c 662c 2027 6163 7469 6f6e  pt(self, 'action
-00018c20: 2d73 6574 272c 2027 6578 6974 2030 2729  -set', 'exit 0')
-00018c30: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00018c40: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00018c50: 5661 6c75 6545 7272 6f72 293a 0a20 2020  ValueError):.   
-00018c60: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-00018c70: 636b 656e 642e 6163 7469 6f6e 5f73 6574  ckend.action_set
-00018c80: 287b 2761 2e62 273a 2031 2c20 2761 273a  ({'a.b': 1, 'a':
-00018c90: 207b 2762 273a 2032 7d2c 2027 6427 3a20   {'b': 2}, 'd': 
-00018ca0: 337d 290a 2020 2020 2020 2020 7769 7468  3}).        with
-00018cb0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00018cc0: 6573 2856 616c 7565 4572 726f 7229 3a0a  es(ValueError):.
-00018cd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018ce0: 2e62 6163 6b65 6e64 2e61 6374 696f 6e5f  .backend.action_
-00018cf0: 7365 7428 7b27 6127 3a20 7b27 6227 3a20  set({'a': {'b': 
-00018d00: 312c 2027 6327 3a20 322c 2027 6427 3a20  1, 'c': 2, 'd': 
-00018d10: 7b27 6527 3a20 337d 7d2c 2027 6627 3a20  {'e': 3}}, 'f': 
-00018d20: 342c 2027 612e 642e 6527 3a20 2766 6f6f  4, 'a.d.e': 'foo
-00018d30: 277d 290a 0a20 2020 2064 6566 2074 6573  '})..    def tes
-00018d40: 745f 6163 7469 6f6e 5f66 6169 6c28 7365  t_action_fail(se
-00018d50: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
-00018d60: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
-00018d70: 6163 7469 6f6e 2d67 6574 272c 2027 6578  action-get', 'ex
-00018d80: 6974 2031 2729 0a20 2020 2020 2020 2066  it 1').        f
-00018d90: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-00018da0: 2027 6163 7469 6f6e 2d66 6169 6c27 2c20   'action-fail', 
-00018db0: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
-00018dc0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
-00018dd0: 6374 696f 6e5f 6661 696c 2827 6572 726f  ction_fail('erro
-00018de0: 7220 3432 2729 0a20 2020 2020 2020 2073  r 42').        s
-00018df0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00018e00: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-00018e10: 7328 7365 6c66 292c 205b 5b27 6163 7469  s(self), [['acti
-00018e20: 6f6e 2d66 6169 6c27 2c20 2765 7272 6f72  on-fail', 'error
-00018e30: 2034 3227 5d5d 290a 0a20 2020 2064 6566   42']])..    def
-00018e40: 2074 6573 745f 6163 7469 6f6e 5f6c 6f67   test_action_log
-00018e50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00018e60: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-00018e70: 2c20 2761 6374 696f 6e2d 6765 7427 2c20  , 'action-get', 
-00018e80: 2765 7869 7420 3127 290a 2020 2020 2020  'exit 1').      
-00018e90: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-00018ea0: 6c66 2c20 2761 6374 696f 6e2d 6c6f 6727  lf, 'action-log'
-00018eb0: 2c20 2765 7869 7420 3027 290a 2020 2020  , 'exit 0').    
-00018ec0: 2020 2020 7365 6c66 2e62 6163 6b65 6e64      self.backend
-00018ed0: 2e61 6374 696f 6e5f 6c6f 6728 2770 726f  .action_log('pro
-00018ee0: 6772 6573 733a 2034 3225 2729 0a20 2020  gress: 42%').   
-00018ef0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018f00: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
-00018f10: 745f 6361 6c6c 7328 7365 6c66 292c 205b  t_calls(self), [
-00018f20: 5b27 6163 7469 6f6e 2d6c 6f67 272c 2027  ['action-log', '
-00018f30: 7072 6f67 7265 7373 3a20 3432 2527 5d5d  progress: 42%']]
-00018f40: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00018f50: 6170 706c 6963 6174 696f 6e5f 7665 7273  application_vers
-00018f60: 696f 6e5f 7365 7428 7365 6c66 293a 0a20  ion_set(self):. 
-00018f70: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-00018f80: 7074 2873 656c 662c 2027 6170 706c 6963  pt(self, 'applic
-00018f90: 6174 696f 6e2d 7665 7273 696f 6e2d 7365  ation-version-se
-00018fa0: 7427 2c20 2765 7869 7420 3027 290a 2020  t', 'exit 0').  
-00018fb0: 2020 2020 2020 7365 6c66 2e62 6163 6b65        self.backe
-00018fc0: 6e64 2e61 7070 6c69 6361 7469 6f6e 5f76  nd.application_v
-00018fd0: 6572 7369 6f6e 5f73 6574 2827 312e 3262  ersion_set('1.2b
-00018fe0: 3327 290a 2020 2020 2020 2020 7365 6c66  3').        self
-00018ff0: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-00019000: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-00019010: 656c 6629 2c20 5b5b 2761 7070 6c69 6361  elf), [['applica
-00019020: 7469 6f6e 2d76 6572 7369 6f6e 2d73 6574  tion-version-set
-00019030: 272c 2027 2d2d 272c 2027 312e 3262 3327  ', '--', '1.2b3'
-00019040: 5d5d 290a 0a20 2020 2064 6566 2074 6573  ]])..    def tes
-00019050: 745f 6170 706c 6963 6174 696f 6e5f 7665  t_application_ve
-00019060: 7273 696f 6e5f 7365 745f 696e 7661 6c69  rsion_set_invali
-00019070: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00019080: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-00019090: 662c 2027 6170 706c 6963 6174 696f 6e2d  f, 'application-
-000190a0: 7665 7273 696f 6e2d 7365 7427 2c20 2765  version-set', 'e
-000190b0: 7869 7420 3027 290a 2020 2020 2020 2020  xit 0').        
-000190c0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-000190d0: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-000190e0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000190f0: 656c 662e 6261 636b 656e 642e 6170 706c  elf.backend.appl
-00019100: 6963 6174 696f 6e5f 7665 7273 696f 6e5f  ication_version_
-00019110: 7365 7428 3229 0a20 2020 2020 2020 2077  set(2).        w
-00019120: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00019130: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-00019140: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00019150: 6c66 2e62 6163 6b65 6e64 2e61 7070 6c69  lf.backend.appli
-00019160: 6361 7469 6f6e 5f76 6572 7369 6f6e 5f73  cation_version_s
-00019170: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-00019180: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-00019190: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-000191a0: 7365 6c66 292c 205b 5d29 0a0a 2020 2020  self), [])..    
-000191b0: 6465 6620 7465 7374 5f6a 756a 755f 6c6f  def test_juju_lo
-000191c0: 6728 7365 6c66 293a 0a20 2020 2020 2020  g(self):.       
-000191d0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-000191e0: 662c 2027 6a75 6a75 2d6c 6f67 272c 2027  f, 'juju-log', '
-000191f0: 6578 6974 2030 2729 0a20 2020 2020 2020  exit 0').       
-00019200: 2073 656c 662e 6261 636b 656e 642e 6a75   self.backend.ju
-00019210: 6a75 5f6c 6f67 2827 5741 524e 494e 4727  ju_log('WARNING'
-00019220: 2c20 2766 6f6f 2729 0a20 2020 2020 2020  , 'foo').       
-00019230: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00019240: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-00019250: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-00019260: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
-00019270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019280: 5b5b 276a 756a 752d 6c6f 6727 2c20 272d  [['juju-log', '-
-00019290: 2d6c 6f67 2d6c 6576 656c 272c 2027 5741  -log-level', 'WA
-000192a0: 524e 494e 4727 2c20 272d 2d27 2c20 2766  RNING', '--', 'f
-000192b0: 6f6f 275d 5d29 0a0a 2020 2020 2020 2020  oo']])..        
-000192c0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-000192d0: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-000192e0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000192f0: 656c 662e 6261 636b 656e 642e 6a75 6a75  elf.backend.juju
-00019300: 5f6c 6f67 2827 4445 4255 4727 290a 2020  _log('DEBUG').  
-00019310: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00019320: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-00019330: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
-00019340: 6c65 6172 3d54 7275 6529 2c20 5b5d 290a  lear=True), []).
-00019350: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-00019360: 7269 7074 2873 656c 662c 2027 6a75 6a75  ript(self, 'juju
-00019370: 2d6c 6f67 272c 2027 6578 6974 2031 2729  -log', 'exit 1')
-00019380: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00019390: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-000193a0: 6f70 732e 6d6f 6465 6c2e 4d6f 6465 6c45  ops.model.ModelE
-000193b0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000193c0: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-000193d0: 6a75 6a75 5f6c 6f67 2827 4241 5227 2c20  juju_log('BAR', 
-000193e0: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
-000193f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00019400: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-00019410: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-00019420: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-00019430: 2020 2020 2020 2020 2020 2020 2020 5b5b                [[
-00019440: 276a 756a 752d 6c6f 6727 2c20 272d 2d6c  'juju-log', '--l
-00019450: 6f67 2d6c 6576 656c 272c 2027 4241 5227  og-level', 'BAR'
-00019460: 2c20 272d 2d27 2c20 2766 6f6f 275d 5d29  , '--', 'foo']])
-00019470: 0a0a 2020 2020 6465 6620 7465 7374 5f76  ..    def test_v
-00019480: 616c 6964 5f6d 6574 7269 6373 2873 656c  alid_metrics(sel
-00019490: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-000194a0: 5f73 6372 6970 7428 7365 6c66 2c20 2761  _script(self, 'a
-000194b0: 6464 2d6d 6574 7269 6327 2c20 2765 7869  dd-metric', 'exi
-000194c0: 7420 3027 290a 2020 2020 2020 2020 7465  t 0').        te
-000194d0: 7374 5f63 6173 6573 203d 205b 280a 2020  st_cases = [(.  
-000194e0: 2020 2020 2020 2020 2020 4f72 6465 7265            Ordere
-000194f0: 6444 6963 7428 5b28 2766 6f6f 272c 2034  dDict([('foo', 4
-00019500: 3229 2c20 2827 622d 6172 272c 2034 2e35  2), ('b-ar', 4.5
-00019510: 292c 2028 2762 615f 2d7a 272c 2034 2e35  ), ('ba_-z', 4.5
-00019520: 292c 2028 2761 272c 2031 295d 292c 0a20  ), ('a', 1)]),. 
-00019530: 2020 2020 2020 2020 2020 204f 7264 6572             Order
-00019540: 6564 4469 6374 285b 2827 6465 272c 2027  edDict([('de', '
-00019550: 6164 2729 2c20 2827 6265 272c 2027 6566  ad'), ('be', 'ef
-00019560: 5f20 2d27 295d 292c 0a20 2020 2020 2020  _ -')]),.       
-00019570: 2020 2020 205b 5b27 6164 642d 6d65 7472       [['add-metr
-00019580: 6963 272c 2027 2d2d 6c61 6265 6c73 272c  ic', '--labels',
-00019590: 2027 6465 3d61 642c 6265 3d65 665f 202d   'de=ad,be=ef_ -
-000195a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000195b0: 2027 666f 6f3d 3432 272c 2027 622d 6172   'foo=42', 'b-ar
-000195c0: 3d34 2e35 272c 2027 6261 5f2d 7a3d 342e  =4.5', 'ba_-z=4.
-000195d0: 3527 2c20 2761 3d31 275d 5d0a 2020 2020  5', 'a=1']].    
-000195e0: 2020 2020 292c 2028 0a20 2020 2020 2020      ), (.       
-000195f0: 2020 2020 204f 7264 6572 6564 4469 6374       OrderedDict
-00019600: 285b 2827 666f 6f31 272c 2030 292c 2028  ([('foo1', 0), (
-00019610: 2762 3272 272c 2034 2e35 295d 292c 0a20  'b2r', 4.5)]),. 
-00019620: 2020 2020 2020 2020 2020 204f 7264 6572             Order
-00019630: 6564 4469 6374 285b 2827 6433 272c 2027  edDict([('d3', '
-00019640: 61d0 b427 292c 2028 2762 3333 6627 2c20  a..'), ('b33f', 
-00019650: 2733 5f20 2d27 295d 292c 0a20 2020 2020  '3_ -')]),.     
-00019660: 2020 2020 2020 205b 5b27 6164 642d 6d65         [['add-me
-00019670: 7472 6963 272c 2027 2d2d 6c61 6265 6c73  tric', '--labels
-00019680: 272c 2027 6433 3d61 d0b4 2c62 3333 663d  ', 'd3=a..,b33f=
-00019690: 335f 202d 272c 2027 666f 6f31 3d30 272c  3_ -', 'foo1=0',
-000196a0: 2027 6232 723d 342e 3527 5d5d 2c0a 2020   'b2r=4.5']],.  
-000196b0: 2020 2020 2020 295d 0a20 2020 2020 2020        )].       
-000196c0: 2066 6f72 206d 6574 7269 6373 2c20 6c61   for metrics, la
-000196d0: 6265 6c73 2c20 6578 7065 6374 6564 5f63  bels, expected_c
-000196e0: 616c 6c73 2069 6e20 7465 7374 5f63 6173  alls in test_cas
-000196f0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00019700: 7365 6c66 2e62 6163 6b65 6e64 2e61 6464  self.backend.add
-00019710: 5f6d 6574 7269 6373 286d 6574 7269 6373  _metrics(metrics
-00019720: 2c20 6c61 6265 6c73 290a 2020 2020 2020  , labels).      
-00019730: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00019740: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
-00019750: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
-00019760: 6c65 6172 3d54 7275 6529 2c20 6578 7065  lear=True), expe
-00019770: 6374 6564 5f63 616c 6c73 290a 0a20 2020  cted_calls)..   
-00019780: 2064 6566 2074 6573 745f 696e 7661 6c69   def test_invali
-00019790: 645f 6d65 7472 6963 5f6e 616d 6573 2873  d_metric_names(s
-000197a0: 656c 6629 3a0a 2020 2020 2020 2020 696e  elf):.        in
-000197b0: 7661 6c69 645f 696e 7075 7473 203d 205b  valid_inputs = [
-000197c0: 0a20 2020 2020 2020 2020 2020 2028 7b27  .            ({'
-000197d0: 273a 2034 2e32 7d2c 207b 7d29 2c0a 2020  ': 4.2}, {}),.  
-000197e0: 2020 2020 2020 2020 2020 287b 2731 273a            ({'1':
-000197f0: 2034 2e32 7d2c 207b 7d29 2c0a 2020 2020   4.2}, {}),.    
-00019800: 2020 2020 2020 2020 287b 2731 273a 202d          ({'1': -
-00019810: 342e 327d 2c20 7b7d 292c 0a20 2020 2020  4.2}, {}),.     
-00019820: 2020 2020 2020 2028 7b27 3132 3327 3a20         ({'123': 
-00019830: 342e 327d 2c20 7b7d 292c 0a20 2020 2020  4.2}, {}),.     
-00019840: 2020 2020 2020 2028 7b27 3166 6f6f 273a         ({'1foo':
-00019850: 2034 2e32 7d2c 207b 7d29 2c0a 2020 2020   4.2}, {}),.    
-00019860: 2020 2020 2020 2020 287b 272d 666f 6f27          ({'-foo'
-00019870: 3a20 342e 327d 2c20 7b7d 292c 0a20 2020  : 4.2}, {}),.   
-00019880: 2020 2020 2020 2020 2028 7b27 5f66 6f6f           ({'_foo
-00019890: 273a 2034 2e32 7d2c 207b 7d29 2c0a 2020  ': 4.2}, {}),.  
-000198a0: 2020 2020 2020 2020 2020 287b 2766 6f6f            ({'foo
-000198b0: 2d27 3a20 342e 327d 2c20 7b7d 292c 0a20  -': 4.2}, {}),. 
-000198c0: 2020 2020 2020 2020 2020 2028 7b27 666f             ({'fo
-000198d0: 6f5f 273a 2034 2e32 7d2c 207b 7d29 2c0a  o_': 4.2}, {}),.
-000198e0: 2020 2020 2020 2020 2020 2020 287b 2761              ({'a
-000198f0: 2d27 3a20 342e 327d 2c20 7b7d 292c 0a20  -': 4.2}, {}),. 
-00019900: 2020 2020 2020 2020 2020 2028 7b27 615f             ({'a_
-00019910: 273a 2034 2e32 7d2c 207b 7d29 2c0a 2020  ': 4.2}, {}),.  
-00019920: 2020 2020 2020 2020 2020 287b 2742 41d0            ({'BA.
-00019930: af27 3a20 342e 327d 2c20 7b7d 292c 0a20  .': 4.2}, {}),. 
-00019940: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00019950: 2066 6f72 206d 6574 7269 6373 2c20 6c61   for metrics, la
-00019960: 6265 6c73 2069 6e20 696e 7661 6c69 645f  bels in invalid_
-00019970: 696e 7075 7473 3a0a 2020 2020 2020 2020  inputs:.        
-00019980: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00019990: 7365 7274 5261 6973 6573 286f 7073 2e6d  sertRaises(ops.m
-000199a0: 6f64 656c 2e4d 6f64 656c 4572 726f 7229  odel.ModelError)
-000199b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000199c0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
-000199d0: 6464 5f6d 6574 7269 6373 286d 6574 7269  dd_metrics(metri
-000199e0: 6373 2c20 6c61 6265 6c73 290a 0a20 2020  cs, labels)..   
-000199f0: 2064 6566 2074 6573 745f 696e 7661 6c69   def test_invali
-00019a00: 645f 6d65 7472 6963 5f76 616c 7565 7328  d_metric_values(
-00019a10: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-00019a20: 6e76 616c 6964 5f69 6e70 7574 7320 3d20  nvalid_inputs = 
-00019a30: 5b0a 2020 2020 2020 2020 2020 2020 287b  [.            ({
-00019a40: 2761 273a 2066 6c6f 6174 2827 2b69 6e66  'a': float('+inf
-00019a50: 2729 7d2c 207b 7d29 2c0a 2020 2020 2020  ')}, {}),.      
-00019a60: 2020 2020 2020 287b 2761 273a 2066 6c6f        ({'a': flo
-00019a70: 6174 2827 2d69 6e66 2729 7d2c 207b 7d29  at('-inf')}, {})
-00019a80: 2c0a 2020 2020 2020 2020 2020 2020 287b  ,.            ({
-00019a90: 2761 273a 2066 6c6f 6174 2827 6e61 6e27  'a': float('nan'
-00019aa0: 297d 2c20 7b7d 292c 0a20 2020 2020 2020  )}, {}),.       
-00019ab0: 2020 2020 2028 7b27 666f 6f27 3a20 2762       ({'foo': 'b
-00019ac0: 6172 277d 2c20 7b7d 292c 0a20 2020 2020  ar'}, {}),.     
-00019ad0: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
-00019ae0: 2731 4f27 7d2c 207b 7d29 2c0a 2020 2020  '1O'}, {}),.    
-00019af0: 2020 2020 5d0a 2020 2020 2020 2020 666f      ].        fo
-00019b00: 7220 6d65 7472 6963 732c 206c 6162 656c  r metrics, label
-00019b10: 7320 696e 2069 6e76 616c 6964 5f69 6e70  s in invalid_inp
-00019b20: 7574 733a 0a20 2020 2020 2020 2020 2020  uts:.           
-00019b30: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00019b40: 7452 6169 7365 7328 6f70 732e 6d6f 6465  tRaises(ops.mode
-00019b50: 6c2e 4d6f 6465 6c45 7272 6f72 293a 0a20  l.ModelError):. 
-00019b60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00019b70: 656c 662e 6261 636b 656e 642e 6164 645f  elf.backend.add_
-00019b80: 6d65 7472 6963 7328 6d65 7472 6963 732c  metrics(metrics,
-00019b90: 206c 6162 656c 7329 0a0a 2020 2020 6465   labels)..    de
-00019ba0: 6620 7465 7374 5f69 6e76 616c 6964 5f6d  f test_invalid_m
-00019bb0: 6574 7269 635f 6c61 6265 6c73 2873 656c  etric_labels(sel
-00019bc0: 6629 3a0a 2020 2020 2020 2020 696e 7661  f):.        inva
-00019bd0: 6c69 645f 696e 7075 7473 203d 205b 0a20  lid_inputs = [. 
-00019be0: 2020 2020 2020 2020 2020 2028 7b27 666f             ({'fo
-00019bf0: 6f27 3a20 342e 327d 2c20 7b27 273a 2027  o': 4.2}, {'': '
-00019c00: 6261 7a27 7d29 2c0a 2020 2020 2020 2020  baz'}),.        
-00019c10: 2020 2020 287b 2766 6f6f 273a 2034 2e32      ({'foo': 4.2
-00019c20: 7d2c 207b 272c 6261 7227 3a20 2762 617a  }, {',bar': 'baz
-00019c30: 277d 292c 0a20 2020 2020 2020 2020 2020  '}),.           
-00019c40: 2028 7b27 666f 6f27 3a20 342e 327d 2c20   ({'foo': 4.2}, 
-00019c50: 7b27 623d 613d 7227 3a20 2762 617a 277d  {'b=a=r': 'baz'}
-00019c60: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00019c70: 7b27 666f 6f27 3a20 342e 327d 2c20 7b27  {'foo': 4.2}, {'
-00019c80: 4241 d0af 273a 2027 6261 7a27 7d29 2c0a  BA..': 'baz'}),.
-00019c90: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00019ca0: 2020 666f 7220 6d65 7472 6963 732c 206c    for metrics, l
-00019cb0: 6162 656c 7320 696e 2069 6e76 616c 6964  abels in invalid
-00019cc0: 5f69 6e70 7574 733a 0a20 2020 2020 2020  _inputs:.       
-00019cd0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00019ce0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
-00019cf0: 6d6f 6465 6c2e 4d6f 6465 6c45 7272 6f72  model.ModelError
-00019d00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00019d10: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
-00019d20: 6164 645f 6d65 7472 6963 7328 6d65 7472  add_metrics(metr
-00019d30: 6963 732c 206c 6162 656c 7329 0a0a 2020  ics, labels)..  
-00019d40: 2020 6465 6620 7465 7374 5f69 6e76 616c    def test_inval
-00019d50: 6964 5f6d 6574 7269 635f 6c61 6265 6c5f  id_metric_label_
-00019d60: 7661 6c75 6573 2873 656c 6629 3a0a 2020  values(self):.  
-00019d70: 2020 2020 2020 696e 7661 6c69 645f 696e        invalid_in
-00019d80: 7075 7473 203d 205b 0a20 2020 2020 2020  puts = [.       
-00019d90: 2020 2020 2028 7b27 666f 6f27 3a20 342e       ({'foo': 4.
-00019da0: 327d 2c20 7b27 6261 7227 3a20 2727 7d29  2}, {'bar': ''})
-00019db0: 2c0a 2020 2020 2020 2020 2020 2020 287b  ,.            ({
-00019dc0: 2766 6f6f 273a 2034 2e32 7d2c 207b 2762  'foo': 4.2}, {'b
-00019dd0: 6172 273a 2027 622c 617a 277d 292c 0a20  ar': 'b,az'}),. 
-00019de0: 2020 2020 2020 2020 2020 2028 7b27 666f             ({'fo
-00019df0: 6f27 3a20 342e 327d 2c20 7b27 6261 7227  o': 4.2}, {'bar'
-00019e00: 3a20 2762 3d61 7a27 7d29 2c0a 2020 2020  : 'b=az'}),.    
-00019e10: 2020 2020 5d0a 2020 2020 2020 2020 666f      ].        fo
-00019e20: 7220 6d65 7472 6963 732c 206c 6162 656c  r metrics, label
-00019e30: 7320 696e 2069 6e76 616c 6964 5f69 6e70  s in invalid_inp
-00019e40: 7574 733a 0a20 2020 2020 2020 2020 2020  uts:.           
-00019e50: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00019e60: 7452 6169 7365 7328 6f70 732e 6d6f 6465  tRaises(ops.mode
-00019e70: 6c2e 4d6f 6465 6c45 7272 6f72 293a 0a20  l.ModelError):. 
-00019e80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00019e90: 656c 662e 6261 636b 656e 642e 6164 645f  elf.backend.add_
-00019ea0: 6d65 7472 6963 7328 6d65 7472 6963 732c  metrics(metrics,
-00019eb0: 206c 6162 656c 7329 0a0a 2020 2020 6465   labels)..    de
-00019ec0: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
-00019ed0: 7265 6d6f 7465 5f61 7070 5f6e 616d 655f  remote_app_name_
-00019ee0: 656e 7628 7365 6c66 293a 0a20 2020 2020  env(self):.     
-00019ef0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00019f00: 7570 286f 732e 656e 7669 726f 6e2e 706f  up(os.environ.po
-00019f10: 702c 2027 4a55 4a55 5f52 454c 4154 494f  p, 'JUJU_RELATIO
-00019f20: 4e5f 4944 272c 204e 6f6e 6529 0a20 2020  N_ID', None).   
-00019f30: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00019f40: 616e 7570 286f 732e 656e 7669 726f 6e2e  anup(os.environ.
-00019f50: 706f 702c 2027 4a55 4a55 5f52 454d 4f54  pop, 'JUJU_REMOT
-00019f60: 455f 4150 5027 2c20 4e6f 6e65 290a 0a20  E_APP', None).. 
-00019f70: 2020 2020 2020 206f 732e 656e 7669 726f         os.enviro
-00019f80: 6e5b 274a 554a 555f 5245 4c41 5449 4f4e  n['JUJU_RELATION
-00019f90: 5f49 4427 5d20 3d20 2778 3a35 270a 2020  _ID'] = 'x:5'.  
-00019fa0: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
-00019fb0: 5b27 4a55 4a55 5f52 454d 4f54 455f 4150  ['JUJU_REMOTE_AP
-00019fc0: 5027 5d20 3d20 2772 656d 6f74 6561 7070  P'] = 'remoteapp
-00019fd0: 3127 0a20 2020 2020 2020 2073 656c 662e  1'.        self.
-00019fe0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-00019ff0: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
-0001a000: 6e5f 7265 6d6f 7465 5f61 7070 5f6e 616d  n_remote_app_nam
-0001a010: 6528 3529 2c20 2772 656d 6f74 6561 7070  e(5), 'remoteapp
-0001a020: 3127 290a 2020 2020 2020 2020 6f73 2e65  1').        os.e
-0001a030: 6e76 6972 6f6e 5b27 4a55 4a55 5f52 454c  nviron['JUJU_REL
-0001a040: 4154 494f 4e5f 4944 275d 203d 2027 3527  ATION_ID'] = '5'
-0001a050: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a060: 7365 7274 4571 7561 6c28 7365 6c66 2e62  sertEqual(self.b
-0001a070: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-0001a080: 7265 6d6f 7465 5f61 7070 5f6e 616d 6528  remote_app_name(
-0001a090: 3529 2c20 2772 656d 6f74 6561 7070 3127  5), 'remoteapp1'
-0001a0a0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001a0b0: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
-0001a0c0: 6170 705f 6e61 6d65 5f73 6372 6970 745f  app_name_script_
-0001a0d0: 7375 6363 6573 7328 7365 6c66 293a 0a20  success(self):. 
-0001a0e0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0001a0f0: 6c65 616e 7570 286f 732e 656e 7669 726f  leanup(os.enviro
-0001a100: 6e2e 706f 702c 2027 4a55 4a55 5f52 454c  n.pop, 'JUJU_REL
-0001a110: 4154 494f 4e5f 4944 272c 204e 6f6e 6529  ATION_ID', None)
-0001a120: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001a130: 6443 6c65 616e 7570 286f 732e 656e 7669  dCleanup(os.envi
-0001a140: 726f 6e2e 706f 702c 2027 4a55 4a55 5f52  ron.pop, 'JUJU_R
-0001a150: 454d 4f54 455f 4150 5027 2c20 4e6f 6e65  EMOTE_APP', None
-0001a160: 290a 0a20 2020 2020 2020 2023 204a 554a  )..        # JUJ
-0001a170: 555f 5245 4c41 5449 4f4e 5f49 4420 616e  U_RELATION_ID an
-0001a180: 6420 4a55 4a55 5f52 454d 4f54 455f 4150  d JUJU_REMOTE_AP
-0001a190: 5020 626f 7468 2075 6e73 6574 0a20 2020  P both unset.   
-0001a1a0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001a1b0: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
-0001a1c0: 2d6c 6973 7427 2c20 7222 2222 0a65 6368  -list', r""".ech
-0001a1d0: 6f20 2722 7265 6d6f 7465 6170 7032 2227  o '"remoteapp2"'
-0001a1e0: 0a22 2222 290a 2020 2020 2020 2020 7365  .""").        se
-0001a1f0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0001a200: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
-0001a210: 7469 6f6e 5f72 656d 6f74 655f 6170 705f  tion_remote_app_
-0001a220: 6e61 6d65 2831 292c 2027 7265 6d6f 7465  name(1), 'remote
-0001a230: 6170 7032 2729 0a20 2020 2020 2020 2073  app2').        s
-0001a240: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001a250: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001a260: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001a270: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
-0001a280: 2020 205b 2772 656c 6174 696f 6e2d 6c69     ['relation-li
-0001a290: 7374 272c 2027 2d72 272c 2027 3127 2c20  st', '-r', '1', 
-0001a2a0: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
-0001a2b0: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-0001a2c0: 2020 205d 290a 0a20 2020 2020 2020 2023     ])..        #
-0001a2d0: 204a 554a 555f 5245 4c41 5449 4f4e 5f49   JUJU_RELATION_I
-0001a2e0: 4420 7365 7420 6275 7420 4a55 4a55 5f52  D set but JUJU_R
-0001a2f0: 454d 4f54 455f 4150 5020 756e 7365 740a  EMOTE_APP unset.
-0001a300: 2020 2020 2020 2020 6f73 2e65 6e76 6972          os.envir
-0001a310: 6f6e 5b27 4a55 4a55 5f52 454c 4154 494f  on['JUJU_RELATIO
-0001a320: 4e5f 4944 275d 203d 2027 783a 3527 0a20  N_ID'] = 'x:5'. 
-0001a330: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001a340: 7274 4571 7561 6c28 7365 6c66 2e62 6163  rtEqual(self.bac
-0001a350: 6b65 6e64 2e72 656c 6174 696f 6e5f 7265  kend.relation_re
-0001a360: 6d6f 7465 5f61 7070 5f6e 616d 6528 3529  mote_app_name(5)
-0001a370: 2c20 2772 656d 6f74 6561 7070 3227 290a  , 'remoteapp2').
-0001a380: 0a20 2020 2020 2020 2023 204a 554a 555f  .        # JUJU_
-0001a390: 5245 4c41 5449 4f4e 5f49 4420 756e 7365  RELATION_ID unse
-0001a3a0: 7420 6275 7420 4a55 4a55 5f52 454d 4f54  t but JUJU_REMOT
-0001a3b0: 455f 4150 5020 7365 740a 2020 2020 2020  E_APP set.      
-0001a3c0: 2020 6465 6c20 6f73 2e65 6e76 6972 6f6e    del os.environ
-0001a3d0: 5b27 4a55 4a55 5f52 454c 4154 494f 4e5f  ['JUJU_RELATION_
-0001a3e0: 4944 275d 0a20 2020 2020 2020 206f 732e  ID'].        os.
-0001a3f0: 656e 7669 726f 6e5b 274a 554a 555f 5245  environ['JUJU_RE
-0001a400: 4d4f 5445 5f41 5050 275d 203d 2027 7265  MOTE_APP'] = 're
-0001a410: 6d6f 7465 6170 7031 270a 2020 2020 2020  moteapp1'.      
-0001a420: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001a430: 616c 2873 656c 662e 6261 636b 656e 642e  al(self.backend.
-0001a440: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
-0001a450: 6170 705f 6e61 6d65 2835 292c 2027 7265  app_name(5), 're
-0001a460: 6d6f 7465 6170 7032 2729 0a0a 2020 2020  moteapp2')..    
-0001a470: 2020 2020 2320 426f 7468 2073 6574 2c20      # Both set, 
-0001a480: 6275 7420 4a55 4a55 5f52 454c 4154 494f  but JUJU_RELATIO
-0001a490: 4e5f 4944 2061 2064 6966 6665 7265 6e74  N_ID a different
-0001a4a0: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
-0001a4b0: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
-0001a4c0: 4a55 5f52 454c 4154 494f 4e5f 4944 275d  JU_RELATION_ID']
-0001a4d0: 203d 2027 783a 3627 0a20 2020 2020 2020   = 'x:6'.       
-0001a4e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001a4f0: 6c28 7365 6c66 2e62 6163 6b65 6e64 2e72  l(self.backend.r
-0001a500: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
-0001a510: 7070 5f6e 616d 6528 3529 2c20 2772 656d  pp_name(5), 'rem
-0001a520: 6f74 6561 7070 3227 290a 0a20 2020 2064  oteapp2')..    d
-0001a530: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
-0001a540: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
-0001a550: 5f73 6372 6970 745f 6572 726f 7273 2873  _script_errors(s
-0001a560: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001a570: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001a580: 2772 656c 6174 696f 6e2d 6c69 7374 272c  'relation-list',
-0001a590: 2072 2222 220a 6563 686f 2022 4552 524f   r""".echo "ERRO
-0001a5a0: 5220 696e 7661 6c69 6420 7661 6c75 6520  R invalid value 
-0001a5b0: 5c22 365c 2220 666f 7220 6f70 7469 6f6e  \"6\" for option
-0001a5c0: 202d 723a 2072 656c 6174 696f 6e20 6e6f   -r: relation no
-0001a5d0: 7420 666f 756e 6422 203e 2632 2020 2320  t found" >&2  # 
-0001a5e0: 4e4f 5141 0a65 7869 7420 320a 2222 2229  NOQA.exit 2.""")
-0001a5f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a600: 7365 7274 4973 2873 656c 662e 6261 636b  sertIs(self.back
-0001a610: 656e 642e 7265 6c61 7469 6f6e 5f72 656d  end.relation_rem
-0001a620: 6f74 655f 6170 705f 6e61 6d65 2836 292c  ote_app_name(6),
-0001a630: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
+00014e00: 696f 6e2d 6765 7427 2c20 272d 7227 2c20  ion-get', '-r', 
+00014e10: 2733 272c 2027 2d27 2c20 2772 656d 6f74  '3', '-', 'remot
+00014e20: 652f 3027 2c20 272d 2d66 6f72 6d61 743d  e/0', '--format=
+00014e30: 6a73 6f6e 275d 5d2c 0a20 2020 2020 2020  json']],.       
+00014e40: 2029 2c20 280a 2020 2020 2020 2020 2020   ), (.          
+00014e50: 2020 6c61 6d62 6461 3a20 6661 6b65 5f73    lambda: fake_s
+00014e60: 6372 6970 7428 7365 6c66 2c20 2772 656c  cript(self, 'rel
+00014e70: 6174 696f 6e2d 6765 7427 2c20 6627 6563  ation-get', f'ec
+00014e80: 686f 207b 6572 725f 6d73 677d 203e 2632  ho {err_msg} >&2
+00014e90: 203b 2065 7869 7420 3227 292c 0a20 2020   ; exit 2'),.   
+00014ea0: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+00014eb0: 2073 656c 662e 6261 636b 656e 642e 7265   self.backend.re
+00014ec0: 6c61 7469 6f6e 5f67 6574 2833 2c20 2772  lation_get(3, 'r
+00014ed0: 656d 6f74 652f 3027 2c20 6973 5f61 7070  emote/0', is_app
+00014ee0: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+00014ef0: 2020 2020 206f 7073 2e52 656c 6174 696f       ops.Relatio
+00014f00: 6e4e 6f74 466f 756e 6445 7272 6f72 2c0a  nNotFoundError,.
+00014f10: 2020 2020 2020 2020 2020 2020 5b5b 2772              [['r
+00014f20: 656c 6174 696f 6e2d 6765 7427 2c20 272d  elation-get', '-
+00014f30: 7227 2c20 2733 272c 2027 2d27 2c20 2772  r', '3', '-', 'r
+00014f40: 656d 6f74 652f 3027 2c20 272d 2d66 6f72  emote/0', '--for
+00014f50: 6d61 743d 6a73 6f6e 275d 5d2c 0a20 2020  mat=json']],.   
+00014f60: 2020 2020 2029 2c20 280a 2020 2020 2020       ), (.      
+00014f70: 2020 2020 2020 6c61 6d62 6461 3a20 4e6f        lambda: No
+00014f80: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00014f90: 6c61 6d62 6461 3a20 7365 6c66 2e62 6163  lambda: self.bac
+00014fa0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00014fb0: 7428 332c 2027 7265 6d6f 7465 2f30 272c  t(3, 'remote/0',
+00014fc0: 2069 735f 6170 703d 5472 7565 292c 0a20   is_app=True),. 
+00014fd0: 2020 2020 2020 2020 2020 206f 7073 2e52             ops.R
+00014fe0: 656c 6174 696f 6e4e 6f74 466f 756e 6445  elationNotFoundE
+00014ff0: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
+00015000: 2020 5b5b 2772 656c 6174 696f 6e2d 6765    [['relation-ge
+00015010: 7427 2c20 272d 7227 2c20 2733 272c 2027  t', '-r', '3', '
+00015020: 2d27 2c20 2772 656d 6f74 652f 3027 2c20  -', 'remote/0', 
+00015030: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
+00015040: 6174 3d6a 736f 6e27 5d5d 2c0a 2020 2020  at=json']],.    
+00015050: 2020 2020 295d 0a0a 2020 2020 2020 2020      )]..        
+00015060: 666f 7220 692c 2028 646f 5f66 616b 652c  for i, (do_fake,
+00015070: 2072 756e 2c20 6578 6365 7074 696f 6e2c   run, exception,
+00015080: 2063 616c 6c73 2920 696e 2065 6e75 6d65   calls) in enume
+00015090: 7261 7465 2874 6573 745f 6361 7365 7329  rate(test_cases)
+000150a0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+000150b0: 7468 2073 656c 662e 7375 6254 6573 7428  th self.subTest(
+000150c0: 6929 3a0a 2020 2020 2020 2020 2020 2020  i):.            
+000150d0: 2020 2020 646f 5f66 616b 6528 290a 2020      do_fake().  
+000150e0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+000150f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00015100: 6973 6573 2865 7863 6570 7469 6f6e 293a  ises(exception):
+00015110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015120: 2020 2020 2072 756e 2829 0a20 2020 2020       run().     
+00015130: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00015140: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+00015150: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+00015160: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
+00015170: 2063 616c 6c73 290a 0a20 2020 2064 6566   calls)..    def
+00015180: 2074 6573 745f 7265 6c61 7469 6f6e 5f67   test_relation_g
+00015190: 6574 5f6a 756a 755f 7665 7273 696f 6e5f  et_juju_version_
+000151a0: 7175 6972 6b73 2873 656c 6629 3a0a 2020  quirks(self):.  
+000151b0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+000151c0: 6561 6e75 7028 6f73 2e65 6e76 6972 6f6e  eanup(os.environ
+000151d0: 2e70 6f70 2c20 274a 554a 555f 5645 5253  .pop, 'JUJU_VERS
+000151e0: 494f 4e27 2c20 4e6f 6e65 290a 0a20 2020  ION', None)..   
+000151f0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00015200: 2873 656c 662c 2027 7265 6c61 7469 6f6e  (self, 'relation
+00015210: 2d67 6574 272c 2027 2727 6563 686f 2027  -get', '''echo '
+00015220: 7b22 666f 6f22 3a20 2262 6172 227d 2720  {"foo": "bar"}' 
+00015230: 2727 2729 0a0a 2020 2020 2020 2020 2320  ''')..        # 
+00015240: 6f6e 2032 2e37 2e30 2b2c 2074 6869 6e67  on 2.7.0+, thing
+00015250: 7320 7072 6f63 6565 6420 6173 2065 7870  s proceed as exp
+00015260: 6563 7465 640a 2020 2020 2020 2020 666f  ected.        fo
+00015270: 7220 7620 696e 205b 2732 2e38 2e30 272c  r v in ['2.8.0',
+00015280: 2027 322e 372e 3027 5d3a 0a20 2020 2020   '2.7.0']:.     
+00015290: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000152a0: 2e73 7562 5465 7374 2876 293a 0a20 2020  .subTest(v):.   
+000152b0: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+000152c0: 656e 7669 726f 6e5b 274a 554a 555f 5645  environ['JUJU_VE
+000152d0: 5253 494f 4e27 5d20 3d20 760a 2020 2020  RSION'] = v.    
+000152e0: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
+000152f0: 6461 7461 203d 2073 656c 662e 6261 636b  data = self.back
+00015300: 656e 642e 7265 6c61 7469 6f6e 5f67 6574  end.relation_get
+00015310: 2831 2c20 2766 6f6f 2f30 272c 2069 735f  (1, 'foo/0', is_
+00015320: 6170 703d 5472 7565 290a 2020 2020 2020  app=True).      
+00015330: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00015340: 7373 6572 7445 7175 616c 2872 656c 5f64  ssertEqual(rel_d
+00015350: 6174 612c 207b 2266 6f6f 223a 2022 6261  ata, {"foo": "ba
+00015360: 7222 7d29 0a20 2020 2020 2020 2020 2020  r"}).           
+00015370: 2020 2020 2063 616c 6c73 203d 205b 2720       calls = [' 
+00015380: 272e 6a6f 696e 2869 2920 666f 7220 6920  '.join(i) for i 
+00015390: 696e 2066 616b 655f 7363 7269 7074 5f63  in fake_script_c
+000153a0: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+000153b0: 3d54 7275 6529 5d0a 2020 2020 2020 2020  =True)].        
+000153c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000153d0: 6572 7445 7175 616c 2863 616c 6c73 2c20  ertEqual(calls, 
+000153e0: 5b27 7265 6c61 7469 6f6e 2d67 6574 202d  ['relation-get -
+000153f0: 7220 3120 2d20 666f 6f2f 3020 2d2d 6170  r 1 - foo/0 --ap
+00015400: 7020 2d2d 666f 726d 6174 3d6a 736f 6e27  p --format=json'
+00015410: 5d29 0a0a 2020 2020 2020 2020 2320 6265  ])..        # be
+00015420: 666f 7265 2032 2e37 2e30 2c20 6974 206a  fore 2.7.0, it j
+00015430: 7573 7420 6661 696c 7320 286e 6f20 2d2d  ust fails (no --
+00015440: 6170 7020 7375 7070 6f72 7429 0a20 2020  app support).   
+00015450: 2020 2020 206f 732e 656e 7669 726f 6e5b       os.environ[
+00015460: 274a 554a 555f 5645 5253 494f 4e27 5d20  'JUJU_VERSION'] 
+00015470: 3d20 2732 2e36 2e39 270a 2020 2020 2020  = '2.6.9'.      
+00015480: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00015490: 7274 5261 6973 6573 5265 6765 7828 5275  rtRaisesRegex(Ru
+000154a0: 6e74 696d 6545 7272 6f72 2c20 276e 6f74  ntimeError, 'not
+000154b0: 2073 7570 706f 7274 6564 206f 6e20 4a75   supported on Ju
+000154c0: 6a75 2076 6572 7369 6f6e 2032 2e36 2e39  ju version 2.6.9
+000154d0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+000154e0: 7365 6c66 2e62 6163 6b65 6e64 2e72 656c  self.backend.rel
+000154f0: 6174 696f 6e5f 6765 7428 312c 2027 666f  ation_get(1, 'fo
+00015500: 6f2f 3027 2c20 6973 5f61 7070 3d54 7275  o/0', is_app=Tru
+00015510: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00015520: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+00015530: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+00015540: 6c66 292c 205b 5d29 0a0a 2020 2020 6465  lf), [])..    de
+00015550: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
+00015560: 7365 745f 6a75 6a75 5f76 6572 7369 6f6e  set_juju_version
+00015570: 5f71 7569 726b 7328 7365 6c66 293a 0a20  _quirks(self):. 
+00015580: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+00015590: 6c65 616e 7570 286f 732e 656e 7669 726f  leanup(os.enviro
+000155a0: 6e2e 706f 702c 2027 4a55 4a55 5f56 4552  n.pop, 'JUJU_VER
+000155b0: 5349 4f4e 272c 204e 6f6e 6529 0a0a 2020  SION', None)..  
+000155c0: 2020 2020 2020 2320 6f6e 2032 2e37 2e30        # on 2.7.0
+000155d0: 2b2c 2074 6869 6e67 7320 7072 6f63 6565  +, things procee
+000155e0: 6420 6173 2065 7870 6563 7465 640a 2020  d as expected.  
+000155f0: 2020 2020 2020 666f 7220 7620 696e 205b        for v in [
+00015600: 2732 2e38 2e30 272c 2027 322e 372e 3027  '2.8.0', '2.7.0'
+00015610: 5d3a 0a20 2020 2020 2020 2020 2020 2077  ]:.            w
+00015620: 6974 6820 7365 6c66 2e73 7562 5465 7374  ith self.subTest
+00015630: 2876 293a 0a20 2020 2020 2020 2020 2020  (v):.           
+00015640: 2020 2020 2074 203d 2074 656d 7066 696c       t = tempfil
+00015650: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
+00015660: 4669 6c65 2829 0a20 2020 2020 2020 2020  File().         
+00015670: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00015680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015690: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+000156a0: 2c20 2772 656c 6174 696f 6e2d 7365 7427  , 'relation-set'
+000156b0: 2c20 6465 6465 6e74 2822 2222 0a20 2020  , dedent(""".   
+000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156d0: 2020 2020 2063 6174 203e 3e20 7b7d 0a20       cat >> {}. 
+000156e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156f0: 2020 2020 2020 2022 2222 292e 666f 726d         """).form
+00015700: 6174 2870 6174 686c 6962 2e50 6174 6828  at(pathlib.Path(
+00015710: 742e 6e61 6d65 292e 6173 5f70 6f73 6978  t.name).as_posix
+00015720: 2829 2929 0a20 2020 2020 2020 2020 2020  ())).           
+00015730: 2020 2020 2020 2020 206f 732e 656e 7669           os.envi
+00015740: 726f 6e5b 274a 554a 555f 5645 5253 494f  ron['JUJU_VERSIO
+00015750: 4e27 5d20 3d20 760a 2020 2020 2020 2020  N'] = v.        
+00015760: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015770: 2e62 6163 6b65 6e64 2e72 656c 6174 696f  .backend.relatio
+00015780: 6e5f 7365 7428 312c 2027 666f 6f27 2c20  n_set(1, 'foo', 
+00015790: 2762 6172 272c 2069 735f 6170 703d 5472  'bar', is_app=Tr
+000157a0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+000157b0: 2020 2020 2020 2020 6361 6c6c 7320 3d20          calls = 
+000157c0: 5b27 2027 2e6a 6f69 6e28 6929 2066 6f72  [' '.join(i) for
+000157d0: 2069 2069 6e20 6661 6b65 5f73 6372 6970   i in fake_scrip
+000157e0: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
+000157f0: 6561 723d 5472 7565 295d 0a20 2020 2020  ear=True)].     
+00015800: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00015810: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00015820: 6361 6c6c 732c 205b 2772 656c 6174 696f  calls, ['relatio
+00015830: 6e2d 7365 7420 2d72 2031 202d 2d61 7070  n-set -r 1 --app
+00015840: 202d 2d66 696c 6520 2d27 5d29 0a20 2020   --file -']).   
+00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015860: 2074 2e73 6565 6b28 3029 0a20 2020 2020   t.seek(0).     
+00015870: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00015880: 6f6e 7465 6e74 203d 2074 2e72 6561 6428  ontent = t.read(
+00015890: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000158a0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+000158b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000158c0: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+000158d0: 2020 2020 2020 2020 2064 6563 6f64 6564           decoded
+000158e0: 203d 2063 6f6e 7465 6e74 2e64 6563 6f64   = content.decod
+000158f0: 6528 2775 7466 2d38 2729 2e72 6570 6c61  e('utf-8').repla
+00015900: 6365 2827 5c72 5c6e 272c 2027 5c6e 2729  ce('\r\n', '\n')
+00015910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015920: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00015930: 6c28 6465 636f 6465 642c 2027 666f 6f3a  l(decoded, 'foo:
+00015940: 2062 6172 5c6e 2729 0a0a 2020 2020 2020   bar\n')..      
+00015950: 2020 2320 6265 666f 7265 2032 2e37 2e30    # before 2.7.0
+00015960: 2c20 6974 206a 7573 7420 6661 696c 7320  , it just fails 
+00015970: 616c 7761 7973 2028 6e6f 202d 2d61 7070  always (no --app
+00015980: 2073 7570 706f 7274 290a 2020 2020 2020   support).      
+00015990: 2020 6f73 2e65 6e76 6972 6f6e 5b27 4a55    os.environ['JU
+000159a0: 4a55 5f56 4552 5349 4f4e 275d 203d 2027  JU_VERSION'] = '
+000159b0: 322e 362e 3927 0a20 2020 2020 2020 2077  2.6.9'.        w
+000159c0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+000159d0: 6169 7365 7352 6567 6578 2852 756e 7469  aisesRegex(Runti
+000159e0: 6d65 4572 726f 722c 2027 6e6f 7420 7375  meError, 'not su
+000159f0: 7070 6f72 7465 6420 6f6e 204a 756a 7520  pported on Juju 
+00015a00: 7665 7273 696f 6e20 322e 362e 3927 293a  version 2.6.9'):
+00015a10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00015a20: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
+00015a30: 6f6e 5f73 6574 2831 2c20 2766 6f6f 272c  on_set(1, 'foo',
+00015a40: 2027 6261 7227 2c20 6973 5f61 7070 3d54   'bar', is_app=T
+00015a50: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00015a60: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+00015a70: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00015a80: 7365 6c66 292c 205b 5d29 0a0a 2020 2020  self), [])..    
+00015a90: 6465 6620 7465 7374 5f73 7461 7475 735f  def test_status_
+00015aa0: 6765 7428 7365 6c66 293a 0a20 2020 2020  get(self):.     
+00015ab0: 2020 2023 2074 616b 656e 2066 726f 6d20     # taken from 
+00015ac0: 6163 7475 616c 204a 756a 7520 6f75 7470  actual Juju outp
+00015ad0: 7574 0a20 2020 2020 2020 2063 6f6e 7465  ut.        conte
+00015ae0: 6e74 203d 2027 7b22 6d65 7373 6167 6522  nt = '{"message"
+00015af0: 3a20 2222 2c20 2273 7461 7475 7322 3a20  : "", "status": 
+00015b00: 2275 6e6b 6e6f 776e 222c 2022 7374 6174  "unknown", "stat
+00015b10: 7573 2d64 6174 6122 3a20 7b7d 7d27 0a20  us-data": {}}'. 
+00015b20: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+00015b30: 7074 2873 656c 662c 2027 7374 6174 7573  pt(self, 'status
+00015b40: 2d67 6574 272c 2066 2265 6368 6f20 277b  -get', f"echo '{
+00015b50: 636f 6e74 656e 747d 2722 290a 2020 2020  content}'").    
+00015b60: 2020 2020 7320 3d20 7365 6c66 2e62 6163      s = self.bac
+00015b70: 6b65 6e64 2e73 7461 7475 735f 6765 7428  kend.status_get(
+00015b80: 6973 5f61 7070 3d46 616c 7365 290a 2020  is_app=False).  
+00015b90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00015ba0: 7445 7175 616c 2873 5b27 7374 6174 7573  tEqual(s['status
+00015bb0: 275d 2c20 2275 6e6b 6e6f 776e 2229 0a20  '], "unknown"). 
+00015bc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015bd0: 7274 4571 7561 6c28 735b 276d 6573 7361  rtEqual(s['messa
+00015be0: 6765 275d 2c20 2222 290a 2020 2020 2020  ge'], "").      
+00015bf0: 2020 2320 7461 6b65 6e20 6672 6f6d 2061    # taken from a
+00015c00: 6374 7561 6c20 4a75 6a75 206f 7574 7075  ctual Juju outpu
+00015c10: 740a 2020 2020 2020 2020 636f 6e74 656e  t.        conten
+00015c20: 7420 3d20 6465 6465 6e74 2822 2222 0a20  t = dedent(""". 
+00015c30: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00015c40: 2020 2020 2020 2020 2020 2020 2022 6170               "ap
+00015c50: 706c 6963 6174 696f 6e2d 7374 6174 7573  plication-status
+00015c60: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+00015c70: 2020 2020 2020 2020 2022 6d65 7373 6167           "messag
+00015c80: 6522 3a20 2269 6e73 7461 6c6c 696e 6722  e": "installing"
+00015c90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015ca0: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+00015cb0: 226d 6169 6e74 656e 616e 6365 222c 0a20  "maintenance",. 
+00015cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015cd0: 2020 2022 7374 6174 7573 2d64 6174 6122     "status-data"
+00015ce0: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
+00015cf0: 2020 2020 2020 2020 2020 2275 6e69 7473            "units
+00015d00: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+00015d10: 2020 2020 2020 2020 2020 2020 2022 756f               "uo
+00015d20: 2f30 223a 207b 0a20 2020 2020 2020 2020  /0": {.         
+00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d40: 2020 2022 6d65 7373 6167 6522 3a20 2222     "message": ""
+00015d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015d60: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00015d70: 7461 7475 7322 3a20 2261 6374 6976 6522  tatus": "active"
+00015d80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015d90: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00015da0: 7461 7475 732d 6461 7461 223a 207b 7d0a  tatus-data": {}.
+00015db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015dc0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00015dd0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015df0: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+00015e00: 2020 2020 2020 2020 2020 2020 2222 2229              """)
+00015e10: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+00015e20: 7269 7074 2873 656c 662c 2027 7374 6174  ript(self, 'stat
+00015e30: 7573 2d67 6574 272c 2066 2265 6368 6f20  us-get', f"echo 
+00015e40: 277b 636f 6e74 656e 747d 2722 290a 2020  '{content}'").  
+00015e50: 2020 2020 2020 7320 3d20 7365 6c66 2e62        s = self.b
+00015e60: 6163 6b65 6e64 2e73 7461 7475 735f 6765  ackend.status_ge
+00015e70: 7428 6973 5f61 7070 3d54 7275 6529 0a20  t(is_app=True). 
+00015e80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015e90: 7274 4571 7561 6c28 735b 2773 7461 7475  rtEqual(s['statu
+00015ea0: 7327 5d2c 2022 6d61 696e 7465 6e61 6e63  s'], "maintenanc
+00015eb0: 6522 290a 2020 2020 2020 2020 7365 6c66  e").        self
+00015ec0: 2e61 7373 6572 7445 7175 616c 2873 5b27  .assertEqual(s['
+00015ed0: 6d65 7373 6167 6527 5d2c 2022 696e 7374  message'], "inst
+00015ee0: 616c 6c69 6e67 2229 0a20 2020 2020 2020  alling").       
+00015ef0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00015f00: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+00015f10: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+00015f20: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
+00015f30: 2020 2020 205b 2773 7461 7475 732d 6765       ['status-ge
+00015f40: 7427 2c20 272d 2d69 6e63 6c75 6465 2d64  t', '--include-d
+00015f50: 6174 6127 2c20 272d 2d61 7070 6c69 6361  ata', '--applica
+00015f60: 7469 6f6e 3d46 616c 7365 272c 2027 2d2d  tion=False', '--
+00015f70: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
+00015f80: 2020 2020 2020 2020 2020 205b 2773 7461             ['sta
+00015f90: 7475 732d 6765 7427 2c20 272d 2d69 6e63  tus-get', '--inc
+00015fa0: 6c75 6465 2d64 6174 6127 2c20 272d 2d61  lude-data', '--a
+00015fb0: 7070 6c69 6361 7469 6f6e 3d54 7275 6527  pplication=True'
+00015fc0: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
+00015fd0: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
+00015fe0: 2020 2020 6465 6620 7465 7374 5f73 7461      def test_sta
+00015ff0: 7475 735f 6973 5f61 7070 5f66 6f72 6365  tus_is_app_force
+00016000: 645f 6b77 6172 6773 2873 656c 6629 3a0a  d_kwargs(self):.
+00016010: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00016020: 6970 7428 7365 6c66 2c20 2773 7461 7475  ipt(self, 'statu
+00016030: 732d 6765 7427 2c20 2765 7869 7420 3127  s-get', 'exit 1'
+00016040: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
+00016050: 6372 6970 7428 7365 6c66 2c20 2773 7461  cript(self, 'sta
+00016060: 7475 732d 7365 7427 2c20 2765 7869 7420  tus-set', 'exit 
+00016070: 3127 290a 0a20 2020 2020 2020 2074 6573  1')..        tes
+00016080: 745f 6361 7365 7320 3d20 280a 2020 2020  t_cases = (.    
+00016090: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+000160a0: 7365 6c66 2e62 6163 6b65 6e64 2e73 7461  self.backend.sta
+000160b0: 7475 735f 6765 7428 4661 6c73 6529 2c0a  tus_get(False),.
+000160c0: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+000160d0: 6461 3a20 7365 6c66 2e62 6163 6b65 6e64  da: self.backend
+000160e0: 2e73 7461 7475 735f 6765 7428 5472 7565  .status_get(True
+000160f0: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
+00016100: 616d 6264 613a 2073 656c 662e 6261 636b  ambda: self.back
+00016110: 656e 642e 7374 6174 7573 5f73 6574 2827  end.status_set('
+00016120: 6163 7469 7665 272c 2027 272c 2046 616c  active', '', Fal
+00016130: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
+00016140: 206c 616d 6264 613a 2073 656c 662e 6261   lambda: self.ba
+00016150: 636b 656e 642e 7374 6174 7573 5f73 6574  ckend.status_set
+00016160: 2827 6163 7469 7665 272c 2027 272c 2054  ('active', '', T
+00016170: 7275 6529 2c0a 2020 2020 2020 2020 290a  rue),.        ).
+00016180: 0a20 2020 2020 2020 2066 6f72 2063 6173  .        for cas
+00016190: 6520 696e 2074 6573 745f 6361 7365 733a  e in test_cases:
+000161a0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+000161b0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+000161c0: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
+000161d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161e0: 6361 7365 2829 0a0a 2020 2020 6465 6620  case()..    def 
+000161f0: 7465 7374 5f6c 6f63 616c 5f73 6574 5f69  test_local_set_i
+00016200: 6e76 616c 6964 5f73 7461 7475 7328 7365  nvalid_status(se
+00016210: 6c66 293a 0a20 2020 2020 2020 2023 206a  lf):.        # j
+00016220: 756a 7520 7265 7475 726e 7320 6578 6974  uju returns exit
+00016230: 2063 6f64 6520 3120 6966 2079 6f75 2061   code 1 if you a
+00016240: 736b 2074 6f20 7365 7420 7374 6174 7573  sk to set status
+00016250: 2074 6f20 2775 6e6b 6e6f 776e 2720 6f72   to 'unknown' or
+00016260: 2027 6572 726f 7227 0a20 2020 2020 2020   'error'.       
+00016270: 206d 6574 6120 3d20 6f70 732e 4368 6172   meta = ops.Char
+00016280: 6d4d 6574 612e 6672 6f6d 5f79 616d 6c28  mMeta.from_yaml(
+00016290: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+000162a0: 6e61 6d65 3a20 6d79 6170 700a 2020 2020  name: myapp.    
+000162b0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
+000162c0: 206d 6f64 656c 203d 206f 7073 2e4d 6f64   model = ops.Mod
+000162d0: 656c 286d 6574 612c 2073 656c 662e 6261  el(meta, self.ba
+000162e0: 636b 656e 6429 0a20 2020 2020 2020 2066  ckend).        f
+000162f0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+00016300: 2027 7374 6174 7573 2d73 6574 272c 2027   'status-set', '
+00016310: 6578 6974 2031 2729 0a20 2020 2020 2020  exit 1').       
+00016320: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00016330: 662c 2027 6973 2d6c 6561 6465 7227 2c20  f, 'is-leader', 
+00016340: 2765 6368 6f20 7472 7565 2729 0a0a 2020  'echo true')..  
+00016350: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00016360: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00016370: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
+00016380: 2020 2020 2020 2020 2020 6d6f 6465 6c2e            model.
+00016390: 756e 6974 2e73 7461 7475 7320 3d20 6f70  unit.status = op
+000163a0: 732e 556e 6b6e 6f77 6e53 7461 7475 7328  s.UnknownStatus(
+000163b0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+000163c0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000163d0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+000163e0: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
+000163f0: 6465 6c2e 756e 6974 2e73 7461 7475 7320  del.unit.status 
+00016400: 3d20 6f70 732e 4572 726f 7253 7461 7475  = ops.ErrorStatu
+00016410: 7328 290a 0a20 2020 2020 2020 2073 656c  s()..        sel
+00016420: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+00016430: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00016440: 7365 6c66 2c20 5472 7565 292c 205b 0a20  self, True), [. 
+00016450: 2020 2020 2020 2020 2020 205b 2773 7461             ['sta
+00016460: 7475 732d 7365 7427 2c20 272d 2d61 7070  tus-set', '--app
+00016470: 6c69 6361 7469 6f6e 3d46 616c 7365 272c  lication=False',
+00016480: 2027 756e 6b6e 6f77 6e27 2c20 2727 5d2c   'unknown', ''],
+00016490: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
+000164a0: 7461 7475 732d 7365 7427 2c20 272d 2d61  tatus-set', '--a
+000164b0: 7070 6c69 6361 7469 6f6e 3d46 616c 7365  pplication=False
+000164c0: 272c 2027 6572 726f 7227 2c20 2727 5d2c  ', 'error', ''],
+000164d0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+000164e0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+000164f0: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+00016500: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
+00016510: 2020 2020 2020 2020 206d 6f64 656c 2e61           model.a
+00016520: 7070 2e73 7461 7475 7320 3d20 6f70 732e  pp.status = ops.
+00016530: 556e 6b6e 6f77 6e53 7461 7475 7328 290a  UnknownStatus().
+00016540: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00016550: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+00016560: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+00016570: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00016580: 6c2e 6170 702e 7374 6174 7573 203d 206f  l.app.status = o
+00016590: 7073 2e45 7272 6f72 5374 6174 7573 2829  ps.ErrorStatus()
+000165a0: 0a0a 2020 2020 2020 2020 2320 4120 6c65  ..        # A le
+000165b0: 6164 6572 7368 6970 2063 6865 636b 2069  adership check i
+000165c0: 7320 6e65 6564 6564 2066 6f72 2061 7070  s needed for app
+000165d0: 6c69 6361 7469 6f6e 2073 7461 7475 732e  lication status.
+000165e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000165f0: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
+00016600: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
+00016610: 2c20 5472 7565 292c 205b 0a20 2020 2020  , True), [.     
+00016620: 2020 2020 2020 205b 2769 732d 6c65 6164         ['is-lead
+00016630: 6572 272c 2027 2d2d 666f 726d 6174 3d6a  er', '--format=j
+00016640: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
+00016650: 2020 205b 2773 7461 7475 732d 7365 7427     ['status-set'
+00016660: 2c20 272d 2d61 7070 6c69 6361 7469 6f6e  , '--application
+00016670: 3d54 7275 6527 2c20 2775 6e6b 6e6f 776e  =True', 'unknown
+00016680: 272c 2027 275d 2c0a 2020 2020 2020 2020  ', ''],.        
+00016690: 2020 2020 5b27 7374 6174 7573 2d73 6574      ['status-set
+000166a0: 272c 2027 2d2d 6170 706c 6963 6174 696f  ', '--applicatio
+000166b0: 6e3d 5472 7565 272c 2027 6572 726f 7227  n=True', 'error'
+000166c0: 2c20 2727 5d2c 0a20 2020 2020 2020 205d  , ''],.        ]
+000166d0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000166e0: 6c6f 6361 6c5f 6765 745f 7374 6174 7573  local_get_status
+000166f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00016700: 666f 7220 6e61 6d65 2c20 6578 7065 6374  for name, expect
+00016710: 6564 5f63 6c73 2069 6e20 280a 2020 2020  ed_cls in (.    
+00016720: 2020 2020 2020 2020 2822 6163 7469 7665          ("active
+00016730: 222c 206f 7073 2e41 6374 6976 6553 7461  ", ops.ActiveSta
+00016740: 7475 7329 2c0a 2020 2020 2020 2020 2020  tus),.          
+00016750: 2020 2822 7761 6974 696e 6722 2c20 6f70    ("waiting", op
+00016760: 732e 5761 6974 696e 6753 7461 7475 7329  s.WaitingStatus)
+00016770: 2c0a 2020 2020 2020 2020 2020 2020 2822  ,.            ("
+00016780: 626c 6f63 6b65 6422 2c20 6f70 732e 426c  blocked", ops.Bl
+00016790: 6f63 6b65 6453 7461 7475 7329 2c0a 2020  ockedStatus),.  
+000167a0: 2020 2020 2020 2020 2020 2822 6d61 696e            ("main
+000167b0: 7465 6e61 6e63 6522 2c20 6f70 732e 4d61  tenance", ops.Ma
+000167c0: 696e 7465 6e61 6e63 6553 7461 7475 7329  intenanceStatus)
+000167d0: 2c0a 2020 2020 2020 2020 2020 2020 2822  ,.            ("
+000167e0: 6572 726f 7222 2c20 6f70 732e 4572 726f  error", ops.Erro
+000167f0: 7253 7461 7475 7329 2c0a 2020 2020 2020  rStatus),.      
+00016800: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00016810: 206d 6574 6120 3d20 6f70 732e 4368 6172   meta = ops.Char
+00016820: 6d4d 6574 612e 6672 6f6d 5f79 616d 6c28  mMeta.from_yaml(
+00016830: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00016840: 2020 2020 6e61 6d65 3a20 6d79 6170 700a      name: myapp.
+00016850: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00016860: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+00016870: 656c 203d 206f 7073 2e4d 6f64 656c 286d  el = ops.Model(m
+00016880: 6574 612c 2073 656c 662e 6261 636b 656e  eta, self.backen
+00016890: 6429 0a0a 2020 2020 2020 2020 2020 2020  d)..            
+000168a0: 7769 7468 2073 656c 662e 7375 6254 6573  with self.subTes
+000168b0: 7428 6e61 6d65 293a 0a20 2020 2020 2020  t(name):.       
+000168c0: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
+000168d0: 203d 206a 736f 6e2e 6475 6d70 7328 7b0a   = json.dumps({.
+000168e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168f0: 2020 2020 226d 6573 7361 6765 223a 2022      "message": "
+00016900: 666f 6f22 2c0a 2020 2020 2020 2020 2020  foo",.          
+00016910: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+00016920: 7322 3a20 6e61 6d65 2c0a 2020 2020 2020  s": name,.      
+00016930: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00016940: 7461 7475 732d 6461 7461 223a 207b 7d2c  tatus-data": {},
+00016950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016960: 207d 290a 2020 2020 2020 2020 2020 2020   }).            
+00016970: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00016980: 7365 6c66 2c20 2773 7461 7475 732d 6765  self, 'status-ge
+00016990: 7427 2c20 6622 6563 686f 2027 7b63 6f6e  t', f"echo '{con
+000169a0: 7465 6e74 7d27 2229 0a0a 2020 2020 2020  tent}'")..      
+000169b0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+000169c0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+000169d0: 6d6f 6465 6c2e 756e 6974 2e73 7461 7475  model.unit.statu
+000169e0: 732c 2065 7870 6563 7465 645f 636c 7329  s, expected_cls)
+000169f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016a00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00016a10: 6c28 6d6f 6465 6c2e 756e 6974 2e73 7461  l(model.unit.sta
+00016a20: 7475 732e 6e61 6d65 2c20 6e61 6d65 290a  tus.name, name).
+00016a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00016a50: 286d 6f64 656c 2e75 6e69 742e 7374 6174  (model.unit.stat
+00016a60: 7573 2e6d 6573 7361 6765 2c20 2266 6f6f  us.message, "foo
+00016a70: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+00016a80: 2020 2020 636f 6e74 656e 7420 3d20 6a73      content = js
+00016a90: 6f6e 2e64 756d 7073 287b 0a20 2020 2020  on.dumps({.     
+00016aa0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00016ab0: 6170 706c 6963 6174 696f 6e2d 7374 6174  application-stat
+00016ac0: 7573 223a 207b 0a20 2020 2020 2020 2020  us": {.         
+00016ad0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00016ae0: 6d65 7373 6167 6522 3a20 2262 6172 222c  message": "bar",
+00016af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016b00: 2020 2020 2020 2020 2022 7374 6174 7573           "status
+00016b10: 223a 206e 616d 652c 0a20 2020 2020 2020  ": name,.       
+00016b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b30: 2022 7374 6174 7573 2d64 6174 6122 3a20   "status-data": 
+00016b40: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
+00016b50: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00016b60: 2020 2020 2020 2020 2020 7d29 0a20 2020            }).   
+00016b70: 2020 2020 2020 2020 2020 2020 2066 616b               fak
+00016b80: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00016b90: 7374 6174 7573 2d67 6574 272c 2066 2265  status-get', f"e
+00016ba0: 6368 6f20 277b 636f 6e74 656e 747d 2722  cho '{content}'"
+00016bb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016bc0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00016bd0: 6c66 2c20 2769 732d 6c65 6164 6572 272c  lf, 'is-leader',
+00016be0: 2027 6563 686f 2074 7275 6527 290a 0a20   'echo true').. 
+00016bf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016c00: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+00016c10: 616e 6365 286d 6f64 656c 2e61 7070 2e73  ance(model.app.s
+00016c20: 7461 7475 732c 2065 7870 6563 7465 645f  tatus, expected_
+00016c30: 636c 7329 0a20 2020 2020 2020 2020 2020  cls).           
+00016c40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00016c50: 4571 7561 6c28 6d6f 6465 6c2e 6170 702e  Equal(model.app.
+00016c60: 7374 6174 7573 2e6e 616d 652c 206e 616d  status.name, nam
+00016c70: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00016c80: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00016c90: 7561 6c28 6d6f 6465 6c2e 6170 702e 7374  ual(model.app.st
+00016ca0: 6174 7573 2e6d 6573 7361 6765 2c20 2262  atus.message, "b
+00016cb0: 6172 2229 0a0a 2020 2020 6465 6620 7465  ar")..    def te
+00016cc0: 7374 5f73 7461 7475 735f 7365 745f 6973  st_status_set_is
+00016cd0: 5f61 7070 5f6e 6f74 5f62 6f6f 6c5f 7261  _app_not_bool_ra
+00016ce0: 6973 6573 2873 656c 6629 3a0a 2020 2020  ises(self):.    
+00016cf0: 2020 2020 666f 7220 6973 5f61 7070 5f76      for is_app_v
+00016d00: 2069 6e20 5b4e 6f6e 652c 2031 2c20 322e   in [None, 1, 2.
+00016d10: 302c 2027 6127 2c20 6227 6265 6566 272c  0, 'a', b'beef',
+00016d20: 206f 626a 6563 745d 3a0a 2020 2020 2020   object]:.      
+00016d30: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00016d40: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
+00016d50: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00016d60: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+00016d70: 636b 656e 642e 7374 6174 7573 5f73 6574  ckend.status_set
+00016d80: 286f 7073 2e41 6374 6976 6553 7461 7475  (ops.ActiveStatu
+00016d90: 732c 2069 735f 6170 703d 6973 5f61 7070  s, is_app=is_app
+00016da0: 5f76 290a 0a20 2020 2064 6566 2074 6573  _v)..    def tes
+00016db0: 745f 7374 6f72 6167 655f 746f 6f6c 5f65  t_storage_tool_e
+00016dc0: 7272 6f72 7328 7365 6c66 293a 0a20 2020  rrors(self):.   
+00016dd0: 2020 2020 2074 6573 745f 6361 7365 7320       test_cases 
+00016de0: 3d20 5b28 0a20 2020 2020 2020 2020 2020  = [(.           
+00016df0: 206c 616d 6264 613a 2066 616b 655f 7363   lambda: fake_sc
+00016e00: 7269 7074 2873 656c 662c 2027 7374 6f72  ript(self, 'stor
+00016e10: 6167 652d 6c69 7374 272c 2027 6563 686f  age-list', 'echo
+00016e20: 2066 6f6f 6572 726f 7220 3e26 3220 3b20   fooerror >&2 ; 
+00016e30: 6578 6974 2031 2729 2c0a 2020 2020 2020  exit 1'),.      
+00016e40: 2020 2020 2020 6c61 6d62 6461 3a20 7365        lambda: se
+00016e50: 6c66 2e62 6163 6b65 6e64 2e73 746f 7261  lf.backend.stora
+00016e60: 6765 5f6c 6973 7428 2766 6f6f 6261 7227  ge_list('foobar'
+00016e70: 292c 0a20 2020 2020 2020 2020 2020 206f  ),.            o
+00016e80: 7073 2e4d 6f64 656c 4572 726f 722c 0a20  ps.ModelError,. 
+00016e90: 2020 2020 2020 2020 2020 205b 5b27 7374             [['st
+00016ea0: 6f72 6167 652d 6c69 7374 272c 2027 666f  orage-list', 'fo
+00016eb0: 6f62 6172 272c 2027 2d2d 666f 726d 6174  obar', '--format
+00016ec0: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
+00016ed0: 2020 292c 2028 0a20 2020 2020 2020 2020    ), (.         
+00016ee0: 2020 206c 616d 6264 613a 2066 616b 655f     lambda: fake_
+00016ef0: 7363 7269 7074 2873 656c 662c 2027 7374  script(self, 'st
+00016f00: 6f72 6167 652d 6765 7427 2c20 2765 6368  orage-get', 'ech
+00016f10: 6f20 666f 6f65 7272 6f72 203e 2632 203b  o fooerror >&2 ;
+00016f20: 2065 7869 7420 3127 292c 0a20 2020 2020   exit 1'),.     
+00016f30: 2020 2020 2020 206c 616d 6264 613a 2073         lambda: s
+00016f40: 656c 662e 6261 636b 656e 642e 7374 6f72  elf.backend.stor
+00016f50: 6167 655f 6765 7428 2766 6f6f 6261 7227  age_get('foobar'
+00016f60: 2c20 2773 6f6d 6561 7474 7227 292c 0a20  , 'someattr'),. 
+00016f70: 2020 2020 2020 2020 2020 206f 7073 2e4d             ops.M
+00016f80: 6f64 656c 4572 726f 722c 0a20 2020 2020  odelError,.     
+00016f90: 2020 2020 2020 205b 5b27 7374 6f72 6167         [['storag
+00016fa0: 652d 6765 7427 2c20 272d 7327 2c20 2766  e-get', '-s', 'f
+00016fb0: 6f6f 6261 7227 2c20 2773 6f6d 6561 7474  oobar', 'someatt
+00016fc0: 7227 2c20 272d 2d66 6f72 6d61 743d 6a73  r', '--format=js
+00016fd0: 6f6e 275d 5d2c 0a20 2020 2020 2020 2029  on']],.        )
+00016fe0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00016ff0: 6c61 6d62 6461 3a20 6661 6b65 5f73 6372  lambda: fake_scr
+00017000: 6970 7428 7365 6c66 2c20 2773 746f 7261  ipt(self, 'stora
+00017010: 6765 2d61 6464 272c 2027 6563 686f 2066  ge-add', 'echo f
+00017020: 6f6f 6572 726f 7220 3e26 3220 3b20 6578  ooerror >&2 ; ex
+00017030: 6974 2031 2729 2c0a 2020 2020 2020 2020  it 1'),.        
+00017040: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
+00017050: 2e62 6163 6b65 6e64 2e73 746f 7261 6765  .backend.storage
+00017060: 5f61 6464 2827 666f 6f62 6172 272c 2063  _add('foobar', c
+00017070: 6f75 6e74 3d32 292c 0a20 2020 2020 2020  ount=2),.       
+00017080: 2020 2020 206f 7073 2e4d 6f64 656c 4572       ops.ModelEr
+00017090: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
+000170a0: 205b 5b27 7374 6f72 6167 652d 6164 6427   [['storage-add'
+000170b0: 2c20 2766 6f6f 6261 723d 3227 5d5d 2c0a  , 'foobar=2']],.
+000170c0: 2020 2020 2020 2020 292c 2028 0a20 2020          ), (.   
+000170d0: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+000170e0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+000170f0: 662c 2027 7374 6f72 6167 652d 6164 6427  f, 'storage-add'
+00017100: 2c20 2765 6368 6f20 666f 6f65 7272 6f72  , 'echo fooerror
+00017110: 203e 2632 203b 2065 7869 7420 3127 292c   >&2 ; exit 1'),
+00017120: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+00017130: 6264 613a 2073 656c 662e 6261 636b 656e  bda: self.backen
+00017140: 642e 7374 6f72 6167 655f 6164 6428 2766  d.storage_add('f
+00017150: 6f6f 6261 7227 2c20 636f 756e 743d 6f62  oobar', count=ob
+00017160: 6a65 6374 292c 0a20 2020 2020 2020 2020  ject),.         
+00017170: 2020 2054 7970 6545 7272 6f72 2c0a 2020     TypeError,.  
+00017180: 2020 2020 2020 2020 2020 5b5d 2c0a 2020            [],.  
+00017190: 2020 2020 2020 292c 2028 0a20 2020 2020        ), (.     
+000171a0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+000171b0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+000171c0: 2027 7374 6f72 6167 652d 6164 6427 2c20   'storage-add', 
+000171d0: 2765 6368 6f20 666f 6f65 7272 6f72 203e  'echo fooerror >
+000171e0: 2632 203b 2065 7869 7420 3127 292c 0a20  &2 ; exit 1'),. 
+000171f0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+00017200: 613a 2073 656c 662e 6261 636b 656e 642e  a: self.backend.
+00017210: 7374 6f72 6167 655f 6164 6428 2766 6f6f  storage_add('foo
+00017220: 6261 7227 2c20 636f 756e 743d 5472 7565  bar', count=True
+00017230: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
+00017240: 7970 6545 7272 6f72 2c0a 2020 2020 2020  ypeError,.      
+00017250: 2020 2020 2020 5b5d 2c0a 2020 2020 2020        [],.      
+00017260: 2020 295d 0a20 2020 2020 2020 2066 6f72    )].        for
+00017270: 2064 6f5f 6661 6b65 2c20 7275 6e2c 2065   do_fake, run, e
+00017280: 7863 6570 7469 6f6e 2c20 6361 6c6c 7320  xception, calls 
+00017290: 696e 2074 6573 745f 6361 7365 733a 0a20  in test_cases:. 
+000172a0: 2020 2020 2020 2020 2020 2064 6f5f 6661             do_fa
+000172b0: 6b65 2829 0a20 2020 2020 2020 2020 2020  ke().           
+000172c0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+000172d0: 7452 6169 7365 7328 6578 6365 7074 696f  tRaises(exceptio
+000172e0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+000172f0: 2020 2020 7275 6e28 290a 2020 2020 2020      run().      
+00017300: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00017310: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+00017320: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+00017330: 6c65 6172 3d54 7275 6529 2c20 6361 6c6c  lear=True), call
+00017340: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
+00017350: 5f6e 6574 776f 726b 5f67 6574 2873 656c  _network_get(sel
+00017360: 6629 3a0a 2020 2020 2020 2020 6e65 7477  f):.        netw
+00017370: 6f72 6b5f 6765 745f 6f75 7420 3d20 2727  ork_get_out = ''
+00017380: 277b 0a20 2022 6269 6e64 2d61 6464 7265  '{.  "bind-addre
+00017390: 7373 6573 223a 205b 0a20 2020 207b 0a20  sses": [.    {. 
+000173a0: 2020 2020 2022 6d61 632d 6164 6472 6573       "mac-addres
+000173b0: 7322 3a20 2222 2c0a 2020 2020 2020 2269  s": "",.      "i
+000173c0: 6e74 6572 6661 6365 2d6e 616d 6522 3a20  nterface-name": 
+000173d0: 2222 2c0a 2020 2020 2020 2261 6464 7265  "",.      "addre
+000173e0: 7373 6573 223a 205b 0a20 2020 2020 2020  sses": [.       
+000173f0: 207b 0a20 2020 2020 2020 2020 2022 686f   {.          "ho
+00017400: 7374 6e61 6d65 223a 2022 222c 0a20 2020  stname": "",.   
+00017410: 2020 2020 2020 2022 7661 6c75 6522 3a20         "value": 
+00017420: 2231 3932 2e30 2e32 2e32 222c 0a20 2020  "192.0.2.2",.   
+00017430: 2020 2020 2020 2022 6369 6472 223a 2022         "cidr": "
+00017440: 220a 2020 2020 2020 2020 7d0a 2020 2020  ".        }.    
+00017450: 2020 5d0a 2020 2020 7d0a 2020 5d2c 0a20    ].    }.  ],. 
+00017460: 2022 6567 7265 7373 2d73 7562 6e65 7473   "egress-subnets
+00017470: 223a 205b 0a20 2020 2022 3139 322e 302e  ": [.    "192.0.
+00017480: 322e 322f 3332 220a 2020 5d2c 0a20 2022  2.2/32".  ],.  "
+00017490: 696e 6772 6573 732d 6164 6472 6573 7365  ingress-addresse
+000174a0: 7322 3a20 5b0a 2020 2020 2231 3932 2e30  s": [.    "192.0
+000174b0: 2e32 2e32 220a 2020 5d0a 7d27 2727 0a20  .2.2".  ].}'''. 
+000174c0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+000174d0: 7074 2873 656c 662c 2027 6e65 7477 6f72  pt(self, 'networ
+000174e0: 6b2d 6765 7427 2c0a 2020 2020 2020 2020  k-get',.        
+000174f0: 2020 2020 2020 2020 2020 2020 6627 2727              f'''
+00017500: 5b20 2224 3122 203d 2064 6561 6462 6565  [ "$1" = deadbee
+00017510: 6620 5d20 2626 2065 6368 6f20 277b 6e65  f ] && echo '{ne
+00017520: 7477 6f72 6b5f 6765 745f 6f75 747d 2720  twork_get_out}' 
+00017530: 7c7c 2065 7869 7420 3127 2727 290a 2020  || exit 1''').  
+00017540: 2020 2020 2020 6e65 7477 6f72 6b5f 696e        network_in
+00017550: 666f 203d 2073 656c 662e 6261 636b 656e  fo = self.backen
+00017560: 642e 6e65 7477 6f72 6b5f 6765 7428 2764  d.network_get('d
+00017570: 6561 6462 6565 6627 290a 2020 2020 2020  eadbeef').      
+00017580: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00017590: 616c 286e 6574 776f 726b 5f69 6e66 6f2c  al(network_info,
+000175a0: 206a 736f 6e2e 6c6f 6164 7328 6e65 7477   json.loads(netw
+000175b0: 6f72 6b5f 6765 745f 6f75 7429 290a 2020  ork_get_out)).  
+000175c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000175d0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+000175e0: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+000175f0: 6c65 6172 3d54 7275 6529 2c0a 2020 2020  lear=True),.    
+00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017610: 2020 2020 205b 5b27 6e65 7477 6f72 6b2d       [['network-
+00017620: 6765 7427 2c20 2764 6561 6462 6565 6627  get', 'deadbeef'
+00017630: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
+00017640: 275d 5d29 0a0a 2020 2020 2020 2020 6e65  ']])..        ne
+00017650: 7477 6f72 6b5f 696e 666f 203d 2073 656c  twork_info = sel
+00017660: 662e 6261 636b 656e 642e 6e65 7477 6f72  f.backend.networ
+00017670: 6b5f 6765 7428 2764 6561 6462 6565 6627  k_get('deadbeef'
+00017680: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
+00017690: 662e 6173 7365 7274 4571 7561 6c28 6e65  f.assertEqual(ne
+000176a0: 7477 6f72 6b5f 696e 666f 2c20 6a73 6f6e  twork_info, json
+000176b0: 2e6c 6f61 6473 286e 6574 776f 726b 5f67  .loads(network_g
+000176c0: 6574 5f6f 7574 2929 0a20 2020 2020 2020  et_out)).       
+000176d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000176e0: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+000176f0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+00017700: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
+00017710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017720: 5b5b 276e 6574 776f 726b 2d67 6574 272c  [['network-get',
+00017730: 2027 6465 6164 6265 6566 272c 2027 2d72   'deadbeef', '-r
+00017740: 272c 2027 3127 2c20 272d 2d66 6f72 6d61  ', '1', '--forma
+00017750: 743d 6a73 6f6e 275d 5d29 0a0a 2020 2020  t=json']])..    
+00017760: 6465 6620 7465 7374 5f6e 6574 776f 726b  def test_network
+00017770: 5f67 6574 5f65 7272 6f72 7328 7365 6c66  _get_errors(self
+00017780: 293a 0a20 2020 2020 2020 2065 7272 5f6e  ):.        err_n
+00017790: 6f5f 656e 6470 6f69 6e74 203d 2027 4552  o_endpoint = 'ER
+000177a0: 524f 5220 6e6f 206e 6574 776f 726b 2063  ROR no network c
+000177b0: 6f6e 6669 6720 666f 756e 6420 666f 7220  onfig found for 
+000177c0: 6269 6e64 696e 6720 2224 3222 270a 2020  binding "$2"'.  
+000177d0: 2020 2020 2020 6572 725f 6e6f 5f72 656c        err_no_rel
+000177e0: 203d 2027 4552 524f 5220 696e 7661 6c69   = 'ERROR invali
+000177f0: 6420 7661 6c75 6520 2224 3322 2066 6f72  d value "$3" for
+00017800: 206f 7074 696f 6e20 2d72 3a20 7265 6c61   option -r: rela
+00017810: 7469 6f6e 206e 6f74 2066 6f75 6e64 270a  tion not found'.
+00017820: 0a20 2020 2020 2020 2074 6573 745f 6361  .        test_ca
+00017830: 7365 7320 3d20 5b28 0a20 2020 2020 2020  ses = [(.       
+00017840: 2020 2020 206c 616d 6264 613a 2066 616b       lambda: fak
+00017850: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00017860: 6e65 7477 6f72 6b2d 6765 7427 2c0a 2020  network-get',.  
+00017870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017880: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00017890: 6563 686f 207b 6572 725f 6e6f 5f65 6e64  echo {err_no_end
+000178a0: 706f 696e 747d 203e 2632 203b 2065 7869  point} >&2 ; exi
+000178b0: 7420 3127 292c 0a20 2020 2020 2020 2020  t 1'),.         
+000178c0: 2020 206c 616d 6264 613a 2073 656c 662e     lambda: self.
+000178d0: 6261 636b 656e 642e 6e65 7477 6f72 6b5f  backend.network_
+000178e0: 6765 7428 2264 6561 6462 6565 6622 292c  get("deadbeef"),
+000178f0: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
+00017900: 2e4d 6f64 656c 4572 726f 722c 0a20 2020  .ModelError,.   
+00017910: 2020 2020 2020 2020 205b 5b27 6e65 7477           [['netw
+00017920: 6f72 6b2d 6765 7427 2c20 2764 6561 6462  ork-get', 'deadb
+00017930: 6565 6627 2c20 272d 2d66 6f72 6d61 743d  eef', '--format=
+00017940: 6a73 6f6e 275d 5d2c 0a20 2020 2020 2020  json']],.       
+00017950: 2029 2c20 280a 2020 2020 2020 2020 2020   ), (.          
+00017960: 2020 6c61 6d62 6461 3a20 6661 6b65 5f73    lambda: fake_s
+00017970: 6372 6970 7428 7365 6c66 2c20 276e 6574  cript(self, 'net
+00017980: 776f 726b 2d67 6574 272c 2066 2765 6368  work-get', f'ech
+00017990: 6f20 7b65 7272 5f6e 6f5f 7265 6c7d 203e  o {err_no_rel} >
+000179a0: 2632 203b 2065 7869 7420 3227 292c 0a20  &2 ; exit 2'),. 
+000179b0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+000179c0: 613a 2073 656c 662e 6261 636b 656e 642e  a: self.backend.
+000179d0: 6e65 7477 6f72 6b5f 6765 7428 2264 6561  network_get("dea
+000179e0: 6462 6565 6622 2c20 3329 2c0a 2020 2020  dbeef", 3),.    
+000179f0: 2020 2020 2020 2020 6f70 732e 5265 6c61          ops.Rela
+00017a00: 7469 6f6e 4e6f 7446 6f75 6e64 4572 726f  tionNotFoundErro
+00017a10: 722c 0a20 2020 2020 2020 2020 2020 205b  r,.            [
+00017a20: 5b27 6e65 7477 6f72 6b2d 6765 7427 2c20  ['network-get', 
+00017a30: 2764 6561 6462 6565 6627 2c20 272d 7227  'deadbeef', '-r'
+00017a40: 2c20 2733 272c 2027 2d2d 666f 726d 6174  , '3', '--format
+00017a50: 3d6a 736f 6e27 5d5d 2c0a 2020 2020 2020  =json']],.      
+00017a60: 2020 295d 0a20 2020 2020 2020 2066 6f72    )].        for
+00017a70: 2064 6f5f 6661 6b65 2c20 7275 6e2c 2065   do_fake, run, e
+00017a80: 7863 6570 7469 6f6e 2c20 6361 6c6c 7320  xception, calls 
+00017a90: 696e 2074 6573 745f 6361 7365 733a 0a20  in test_cases:. 
+00017aa0: 2020 2020 2020 2020 2020 2064 6f5f 6661             do_fa
+00017ab0: 6b65 2829 0a20 2020 2020 2020 2020 2020  ke().           
+00017ac0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00017ad0: 7452 6169 7365 7328 6578 6365 7074 696f  tRaises(exceptio
+00017ae0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+00017af0: 2020 2020 7275 6e28 290a 2020 2020 2020      run().      
+00017b00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00017b10: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+00017b20: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+00017b30: 6c65 6172 3d54 7275 6529 2c20 6361 6c6c  lear=True), call
+00017b40: 7329 0a0a 2020 2020 6465 6620 7465 7374  s)..    def test
+00017b50: 5f61 6374 696f 6e5f 6765 745f 6572 726f  _action_get_erro
+00017b60: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+00017b70: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00017b80: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
+00017b90: 2027 2729 0a20 2020 2020 2020 2066 616b   '').        fak
+00017ba0: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00017bb0: 6163 7469 6f6e 2d67 6574 272c 2027 6563  action-get', 'ec
+00017bc0: 686f 2066 6f6f 6572 726f 7220 3e26 3220  ho fooerror >&2 
+00017bd0: 3b20 6578 6974 2031 2729 0a20 2020 2020  ; exit 1').     
+00017be0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00017bf0: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
+00017c00: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
+00017c10: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+00017c20: 656e 642e 6163 7469 6f6e 5f67 6574 2829  end.action_get()
+00017c30: 0a20 2020 2020 2020 2063 616c 6c73 203d  .        calls =
+00017c40: 205b 5b27 6163 7469 6f6e 2d67 6574 272c   [['action-get',
+00017c50: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
+00017c60: 5d5d 0a20 2020 2020 2020 2073 656c 662e  ]].        self.
+00017c70: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+00017c80: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+00017c90: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
+00017ca0: 2063 616c 6c73 290a 0a20 2020 2064 6566   calls)..    def
+00017cb0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
+00017cc0: 5f65 7272 6f72 2873 656c 6629 3a0a 2020  _error(self):.  
+00017cd0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+00017ce0: 7428 7365 6c66 2c20 2761 6374 696f 6e2d  t(self, 'action-
+00017cf0: 6765 7427 2c20 2727 290a 2020 2020 2020  get', '').      
+00017d00: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00017d10: 6c66 2c20 2761 6374 696f 6e2d 7365 7427  lf, 'action-set'
+00017d20: 2c20 2765 6368 6f20 666f 6f65 7272 6f72  , 'echo fooerror
+00017d30: 203e 2632 203b 2065 7869 7420 3127 290a   >&2 ; exit 1').
+00017d40: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00017d50: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+00017d60: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+00017d70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00017d80: 2e62 6163 6b65 6e64 2e61 6374 696f 6e5f  .backend.action_
+00017d90: 7365 7428 4f72 6465 7265 6444 6963 7428  set(OrderedDict(
+00017da0: 5b28 2766 6f6f 272c 2027 6261 7227 292c  [('foo', 'bar'),
+00017db0: 2028 2764 6561 6427 2c20 2762 6565 6620   ('dead', 'beef 
+00017dc0: 6361 6665 2729 5d29 290a 2020 2020 2020  cafe')])).      
+00017dd0: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
+00017de0: 6e74 4571 7561 6c28 0a20 2020 2020 2020  ntEqual(.       
+00017df0: 2020 2020 205b 2261 6374 696f 6e2d 7365       ["action-se
+00017e00: 7422 2c20 2264 6561 643d 6265 6566 2063  t", "dead=beef c
+00017e10: 6166 6522 2c20 2266 6f6f 3d62 6172 225d  afe", "foo=bar"]
+00017e20: 2c20 6661 6b65 5f73 6372 6970 745f 6361  , fake_script_ca
+00017e30: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+00017e40: 5472 7565 295b 305d 290a 0a20 2020 2064  True)[0])..    d
+00017e50: 6566 2074 6573 745f 6163 7469 6f6e 5f6c  ef test_action_l
+00017e60: 6f67 5f65 7272 6f72 2873 656c 6629 3a0a  og_error(self):.
+00017e70: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00017e80: 6970 7428 7365 6c66 2c20 2761 6374 696f  ipt(self, 'actio
+00017e90: 6e2d 6765 7427 2c20 2727 290a 2020 2020  n-get', '').    
+00017ea0: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+00017eb0: 7365 6c66 2c20 2761 6374 696f 6e2d 6c6f  self, 'action-lo
+00017ec0: 6727 2c20 2765 6368 6f20 666f 6f65 7272  g', 'echo fooerr
+00017ed0: 6f72 203e 2632 203b 2065 7869 7420 3127  or >&2 ; exit 1'
+00017ee0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00017ef0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00017f00: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+00017f10: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00017f20: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
+00017f30: 6e5f 6c6f 6728 276c 6f67 2d6d 6573 7361  n_log('log-messa
+00017f40: 6765 2729 0a20 2020 2020 2020 2063 616c  ge').        cal
+00017f50: 6c73 203d 205b 5b22 6163 7469 6f6e 2d6c  ls = [["action-l
+00017f60: 6f67 222c 2022 6c6f 672d 6d65 7373 6167  og", "log-messag
+00017f70: 6522 5d5d 0a20 2020 2020 2020 2073 656c  e"]].        sel
+00017f80: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+00017f90: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00017fa0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+00017fb0: 292c 2063 616c 6c73 290a 0a20 2020 2064  ), calls)..    d
+00017fc0: 6566 2074 6573 745f 6163 7469 6f6e 5f67  ef test_action_g
+00017fd0: 6574 2873 656c 6629 3a0a 2020 2020 2020  et(self):.      
+00017fe0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00017ff0: 6c66 2c20 2761 6374 696f 6e2d 6765 7427  lf, 'action-get'
+00018000: 2c20 2222 2265 6368 6f20 277b 2266 6f6f  , """echo '{"foo
+00018010: 2d6e 616d 6522 3a20 2262 6172 222c 2022  -name": "bar", "
+00018020: 7369 6c65 6e74 223a 2066 616c 7365 7d27  silent": false}'
+00018030: 2222 2229 0a20 2020 2020 2020 2070 6172  """).        par
+00018040: 616d 7320 3d20 7365 6c66 2e62 6163 6b65  ams = self.backe
+00018050: 6e64 2e61 6374 696f 6e5f 6765 7428 290a  nd.action_get().
+00018060: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00018070: 6572 7445 7175 616c 2870 6172 616d 735b  ertEqual(params[
+00018080: 2766 6f6f 2d6e 616d 6527 5d2c 2027 6261  'foo-name'], 'ba
+00018090: 7227 290a 2020 2020 2020 2020 7365 6c66  r').        self
+000180a0: 2e61 7373 6572 7445 7175 616c 2870 6172  .assertEqual(par
+000180b0: 616d 735b 2773 696c 656e 7427 5d2c 2046  ams['silent'], F
+000180c0: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
+000180d0: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+000180e0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+000180f0: 2873 656c 6629 2c20 5b5b 2761 6374 696f  (self), [['actio
+00018100: 6e2d 6765 7427 2c20 272d 2d66 6f72 6d61  n-get', '--forma
+00018110: 743d 6a73 6f6e 275d 5d29 0a0a 2020 2020  t=json']])..    
+00018120: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
+00018130: 7365 7428 7365 6c66 293a 0a20 2020 2020  set(self):.     
+00018140: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00018150: 656c 662c 2027 6163 7469 6f6e 2d67 6574  elf, 'action-get
+00018160: 272c 2027 6578 6974 2031 2729 0a20 2020  ', 'exit 1').   
+00018170: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+00018180: 2873 656c 662c 2027 6163 7469 6f6e 2d73  (self, 'action-s
+00018190: 6574 272c 2027 6578 6974 2030 2729 0a20  et', 'exit 0'). 
+000181a0: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+000181b0: 656e 642e 6163 7469 6f6e 5f73 6574 287b  end.action_set({
+000181c0: 2778 273a 2027 6465 6164 2062 6565 6627  'x': 'dead beef'
+000181d0: 2c20 2779 273a 2031 7d29 0a20 2020 2020  , 'y': 1}).     
+000181e0: 2020 2073 656c 662e 6173 7365 7274 436f     self.assertCo
+000181f0: 756e 7445 7175 616c 285b 2761 6374 696f  untEqual(['actio
+00018200: 6e2d 7365 7427 2c20 2778 3d64 6561 6420  n-set', 'x=dead 
+00018210: 6265 6566 272c 2027 793d 3127 5d2c 2066  beef', 'y=1'], f
+00018220: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+00018230: 2873 656c 6629 5b30 5d29 0a0a 2020 2020  (self)[0])..    
+00018240: 6465 6620 7465 7374 5f61 6374 696f 6e5f  def test_action_
+00018250: 7365 745f 6b65 795f 7661 6c69 6461 7469  set_key_validati
+00018260: 6f6e 2873 656c 6629 3a0a 2020 2020 2020  on(self):.      
+00018270: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00018280: 7274 5261 6973 6573 2856 616c 7565 4572  rtRaises(ValueEr
+00018290: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000182a0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
+000182b0: 6374 696f 6e5f 7365 7428 7b27 5827 3a20  ction_set({'X': 
+000182c0: 2764 6561 6420 6265 6566 272c 2027 7927  'dead beef', 'y'
+000182d0: 3a20 317d 290a 2020 2020 2020 2020 7769  : 1}).        wi
+000182e0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+000182f0: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
+00018300: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00018310: 6c66 2e62 6163 6b65 6e64 2e61 6374 696f  lf.backend.actio
+00018320: 6e5f 7365 7428 7b27 736f 6d65 266b 6579  n_set({'some&key
+00018330: 273a 2027 6465 6164 2062 6565 6627 2c20  ': 'dead beef', 
+00018340: 2779 273a 2031 7d29 0a20 2020 2020 2020  'y': 1}).       
+00018350: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00018360: 7452 6169 7365 7328 5661 6c75 6545 7272  tRaises(ValueErr
+00018370: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00018380: 2073 656c 662e 6261 636b 656e 642e 6163   self.backend.ac
+00018390: 7469 6f6e 5f73 6574 287b 2773 6f6d 654b  tion_set({'someK
+000183a0: 6579 273a 2027 6465 6164 2062 6565 6627  ey': 'dead beef'
+000183b0: 2c20 2779 273a 2031 7d29 0a20 2020 2020  , 'y': 1}).     
+000183c0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+000183d0: 6572 7452 6169 7365 7328 5661 6c75 6545  ertRaises(ValueE
+000183e0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+000183f0: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
+00018400: 6163 7469 6f6e 5f73 6574 287b 2773 6f6d  action_set({'som
+00018410: 655f 6b65 7927 3a20 2764 6561 6420 6265  e_key': 'dead be
+00018420: 6566 272c 2027 7927 3a20 317d 290a 0a20  ef', 'y': 1}).. 
+00018430: 2020 2064 6566 2074 6573 745f 6163 7469     def test_acti
+00018440: 6f6e 5f73 6574 5f6e 6573 7465 6428 7365  on_set_nested(se
+00018450: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
+00018460: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+00018470: 6163 7469 6f6e 2d67 6574 272c 2027 6578  action-get', 'ex
+00018480: 6974 2031 2729 0a20 2020 2020 2020 2066  it 1').        f
+00018490: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+000184a0: 2027 6163 7469 6f6e 2d73 6574 272c 2027   'action-set', '
+000184b0: 6578 6974 2030 2729 0a20 2020 2020 2020  exit 0').       
+000184c0: 2073 656c 662e 6261 636b 656e 642e 6163   self.backend.ac
+000184d0: 7469 6f6e 5f73 6574 287b 2761 273a 207b  tion_set({'a': {
+000184e0: 2762 273a 2031 2c20 2763 273a 2032 7d2c  'b': 1, 'c': 2},
+000184f0: 2027 6427 3a20 337d 290a 2020 2020 2020   'd': 3}).      
+00018500: 2020 7365 6c66 2e61 7373 6572 7443 6f75    self.assertCou
+00018510: 6e74 4571 7561 6c28 5b27 6163 7469 6f6e  ntEqual(['action
+00018520: 2d73 6574 272c 2027 612e 623d 3127 2c20  -set', 'a.b=1', 
+00018530: 2761 2e63 3d32 272c 2027 643d 3327 5d2c  'a.c=2', 'd=3'],
+00018540: 2066 616b 655f 7363 7269 7074 5f63 616c   fake_script_cal
+00018550: 6c73 2873 656c 6629 5b30 5d29 0a0a 2020  ls(self)[0])..  
+00018560: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
+00018570: 6e5f 7365 745f 6d6f 7265 5f6e 6573 7465  n_set_more_neste
+00018580: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+00018590: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+000185a0: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
+000185b0: 2027 6578 6974 2031 2729 0a20 2020 2020   'exit 1').     
+000185c0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+000185d0: 656c 662c 2027 6163 7469 6f6e 2d73 6574  elf, 'action-set
+000185e0: 272c 2027 6578 6974 2030 2729 0a20 2020  ', 'exit 0').   
+000185f0: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
+00018600: 642e 6163 7469 6f6e 5f73 6574 287b 2761  d.action_set({'a
+00018610: 273a 207b 2762 273a 2031 2c20 2763 273a  ': {'b': 1, 'c':
+00018620: 2032 2c20 2764 273a 207b 2765 273a 2033   2, 'd': {'e': 3
+00018630: 7d7d 2c20 2766 273a 2034 7d29 0a20 2020  }}, 'f': 4}).   
+00018640: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00018650: 436f 756e 7445 7175 616c 280a 2020 2020  CountEqual(.    
+00018660: 2020 2020 2020 2020 5b27 6163 7469 6f6e          ['action
+00018670: 2d73 6574 272c 2027 612e 623d 3127 2c20  -set', 'a.b=1', 
+00018680: 2761 2e63 3d32 272c 2027 612e 642e 653d  'a.c=2', 'a.d.e=
+00018690: 3327 2c20 2766 3d34 275d 2c20 6661 6b65  3', 'f=4'], fake
+000186a0: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+000186b0: 6c66 295b 305d 290a 0a20 2020 2064 6566  lf)[0])..    def
+000186c0: 2074 6573 745f 6163 7469 6f6e 5f73 6574   test_action_set
+000186d0: 5f64 6f74 7465 645f 6469 6374 2873 656c  _dotted_dict(sel
+000186e0: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
+000186f0: 5f73 6372 6970 7428 7365 6c66 2c20 2761  _script(self, 'a
+00018700: 6374 696f 6e2d 6765 7427 2c20 2765 7869  ction-get', 'exi
+00018710: 7420 3127 290a 2020 2020 2020 2020 6661  t 1').        fa
+00018720: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+00018730: 2761 6374 696f 6e2d 7365 7427 2c20 2765  'action-set', 'e
+00018740: 7869 7420 3027 290a 2020 2020 2020 2020  xit 0').        
+00018750: 7365 6c66 2e62 6163 6b65 6e64 2e61 6374  self.backend.act
+00018760: 696f 6e5f 7365 7428 7b27 612e 6227 3a20  ion_set({'a.b': 
+00018770: 312c 2027 6127 3a20 7b27 6327 3a20 327d  1, 'a': {'c': 2}
+00018780: 2c20 2764 273a 2033 7d29 0a20 2020 2020  , 'd': 3}).     
+00018790: 2020 2073 656c 662e 6173 7365 7274 436f     self.assertCo
+000187a0: 756e 7445 7175 616c 285b 2761 6374 696f  untEqual(['actio
+000187b0: 6e2d 7365 7427 2c20 2761 2e62 3d31 272c  n-set', 'a.b=1',
+000187c0: 2027 612e 633d 3227 2c20 2764 3d33 275d   'a.c=2', 'd=3']
+000187d0: 2c20 6661 6b65 5f73 6372 6970 745f 6361  , fake_script_ca
+000187e0: 6c6c 7328 7365 6c66 295b 305d 290a 0a20  lls(self)[0]).. 
+000187f0: 2020 2064 6566 2074 6573 745f 6163 7469     def test_acti
+00018800: 6f6e 5f73 6574 5f64 7570 6c69 6361 7465  on_set_duplicate
+00018810: 645f 6b65 7973 2873 656c 6629 3a0a 2020  d_keys(self):.  
+00018820: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+00018830: 7428 7365 6c66 2c20 2761 6374 696f 6e2d  t(self, 'action-
+00018840: 6765 7427 2c20 2765 7869 7420 3127 290a  get', 'exit 1').
+00018850: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00018860: 6970 7428 7365 6c66 2c20 2761 6374 696f  ipt(self, 'actio
+00018870: 6e2d 7365 7427 2c20 2765 7869 7420 3027  n-set', 'exit 0'
+00018880: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00018890: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000188a0: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
+000188b0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+000188c0: 6163 6b65 6e64 2e61 6374 696f 6e5f 7365  ackend.action_se
+000188d0: 7428 7b27 612e 6227 3a20 312c 2027 6127  t({'a.b': 1, 'a'
+000188e0: 3a20 7b27 6227 3a20 327d 2c20 2764 273a  : {'b': 2}, 'd':
+000188f0: 2033 7d29 0a20 2020 2020 2020 2077 6974   3}).        wit
+00018900: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00018910: 7365 7328 5661 6c75 6545 7272 6f72 293a  ses(ValueError):
+00018920: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00018930: 662e 6261 636b 656e 642e 6163 7469 6f6e  f.backend.action
+00018940: 5f73 6574 287b 2761 273a 207b 2762 273a  _set({'a': {'b':
+00018950: 2031 2c20 2763 273a 2032 2c20 2764 273a   1, 'c': 2, 'd':
+00018960: 207b 2765 273a 2033 7d7d 2c20 2766 273a   {'e': 3}}, 'f':
+00018970: 2034 2c20 2761 2e64 2e65 273a 2027 666f   4, 'a.d.e': 'fo
+00018980: 6f27 7d29 0a0a 2020 2020 6465 6620 7465  o'})..    def te
+00018990: 7374 5f61 6374 696f 6e5f 6661 696c 2873  st_action_fail(s
+000189a0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+000189b0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+000189c0: 2761 6374 696f 6e2d 6765 7427 2c20 2765  'action-get', 'e
+000189d0: 7869 7420 3127 290a 2020 2020 2020 2020  xit 1').        
+000189e0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+000189f0: 2c20 2761 6374 696f 6e2d 6661 696c 272c  , 'action-fail',
+00018a00: 2027 6578 6974 2030 2729 0a20 2020 2020   'exit 0').     
+00018a10: 2020 2073 656c 662e 6261 636b 656e 642e     self.backend.
+00018a20: 6163 7469 6f6e 5f66 6169 6c28 2765 7272  action_fail('err
+00018a30: 6f72 2034 3227 290a 2020 2020 2020 2020  or 42').        
+00018a40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00018a50: 2866 616b 655f 7363 7269 7074 5f63 616c  (fake_script_cal
+00018a60: 6c73 2873 656c 6629 2c20 5b5b 2761 6374  ls(self), [['act
+00018a70: 696f 6e2d 6661 696c 272c 2027 6572 726f  ion-fail', 'erro
+00018a80: 7220 3432 275d 5d29 0a0a 2020 2020 6465  r 42']])..    de
+00018a90: 6620 7465 7374 5f61 6374 696f 6e5f 6c6f  f test_action_lo
+00018aa0: 6728 7365 6c66 293a 0a20 2020 2020 2020  g(self):.       
+00018ab0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+00018ac0: 662c 2027 6163 7469 6f6e 2d67 6574 272c  f, 'action-get',
+00018ad0: 2027 6578 6974 2031 2729 0a20 2020 2020   'exit 1').     
+00018ae0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+00018af0: 656c 662c 2027 6163 7469 6f6e 2d6c 6f67  elf, 'action-log
+00018b00: 272c 2027 6578 6974 2030 2729 0a20 2020  ', 'exit 0').   
+00018b10: 2020 2020 2073 656c 662e 6261 636b 656e       self.backen
+00018b20: 642e 6163 7469 6f6e 5f6c 6f67 2827 7072  d.action_log('pr
+00018b30: 6f67 7265 7373 3a20 3432 2527 290a 2020  ogress: 42%').  
+00018b40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00018b50: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+00018b60: 7074 5f63 616c 6c73 2873 656c 6629 2c20  pt_calls(self), 
+00018b70: 5b5b 2761 6374 696f 6e2d 6c6f 6727 2c20  [['action-log', 
+00018b80: 2770 726f 6772 6573 733a 2034 3225 275d  'progress: 42%']
+00018b90: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+00018ba0: 5f61 7070 6c69 6361 7469 6f6e 5f76 6572  _application_ver
+00018bb0: 7369 6f6e 5f73 6574 2873 656c 6629 3a0a  sion_set(self):.
+00018bc0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00018bd0: 6970 7428 7365 6c66 2c20 2761 7070 6c69  ipt(self, 'appli
+00018be0: 6361 7469 6f6e 2d76 6572 7369 6f6e 2d73  cation-version-s
+00018bf0: 6574 272c 2027 6578 6974 2030 2729 0a20  et', 'exit 0'). 
+00018c00: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+00018c10: 656e 642e 6170 706c 6963 6174 696f 6e5f  end.application_
+00018c20: 7665 7273 696f 6e5f 7365 7428 2731 2e32  version_set('1.2
+00018c30: 6233 2729 0a20 2020 2020 2020 2073 656c  b3').        sel
+00018c40: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+00018c50: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+00018c60: 7365 6c66 292c 205b 5b27 6170 706c 6963  self), [['applic
+00018c70: 6174 696f 6e2d 7665 7273 696f 6e2d 7365  ation-version-se
+00018c80: 7427 2c20 272d 2d27 2c20 2731 2e32 6233  t', '--', '1.2b3
+00018c90: 275d 5d29 0a0a 2020 2020 6465 6620 7465  ']])..    def te
+00018ca0: 7374 5f61 7070 6c69 6361 7469 6f6e 5f76  st_application_v
+00018cb0: 6572 7369 6f6e 5f73 6574 5f69 6e76 616c  ersion_set_inval
+00018cc0: 6964 2873 656c 6629 3a0a 2020 2020 2020  id(self):.      
+00018cd0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00018ce0: 6c66 2c20 2761 7070 6c69 6361 7469 6f6e  lf, 'application
+00018cf0: 2d76 6572 7369 6f6e 2d73 6574 272c 2027  -version-set', '
+00018d00: 6578 6974 2030 2729 0a20 2020 2020 2020  exit 0').       
+00018d10: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00018d20: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+00018d30: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00018d40: 7365 6c66 2e62 6163 6b65 6e64 2e61 7070  self.backend.app
+00018d50: 6c69 6361 7469 6f6e 5f76 6572 7369 6f6e  lication_version
+00018d60: 5f73 6574 2832 290a 2020 2020 2020 2020  _set(2).        
+00018d70: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00018d80: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
+00018d90: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00018da0: 656c 662e 6261 636b 656e 642e 6170 706c  elf.backend.appl
+00018db0: 6963 6174 696f 6e5f 7665 7273 696f 6e5f  ication_version_
+00018dc0: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
+00018dd0: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+00018de0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+00018df0: 2873 656c 6629 2c20 5b5d 290a 0a20 2020  (self), [])..   
+00018e00: 2064 6566 2074 6573 745f 6a75 6a75 5f6c   def test_juju_l
+00018e10: 6f67 2873 656c 6629 3a0a 2020 2020 2020  og(self):.      
+00018e20: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+00018e30: 6c66 2c20 276a 756a 752d 6c6f 6727 2c20  lf, 'juju-log', 
+00018e40: 2765 7869 7420 3027 290a 2020 2020 2020  'exit 0').      
+00018e50: 2020 7365 6c66 2e62 6163 6b65 6e64 2e6a    self.backend.j
+00018e60: 756a 755f 6c6f 6728 2757 4152 4e49 4e47  uju_log('WARNING
+00018e70: 272c 2027 666f 6f27 290a 2020 2020 2020  ', 'foo').      
+00018e80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00018e90: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+00018ea0: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+00018eb0: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
+00018ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ed0: 205b 5b27 6a75 6a75 2d6c 6f67 272c 2027   [['juju-log', '
+00018ee0: 2d2d 6c6f 672d 6c65 7665 6c27 2c20 2757  --log-level', 'W
+00018ef0: 4152 4e49 4e47 272c 2027 2d2d 272c 2027  ARNING', '--', '
+00018f00: 666f 6f27 5d5d 290a 0a20 2020 2020 2020  foo']])..       
+00018f10: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00018f20: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+00018f30: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00018f40: 7365 6c66 2e62 6163 6b65 6e64 2e6a 756a  self.backend.juj
+00018f50: 755f 6c6f 6728 2744 4542 5547 2729 0a20  u_log('DEBUG'). 
+00018f60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00018f70: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
+00018f80: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
+00018f90: 636c 6561 723d 5472 7565 292c 205b 5d29  clear=True), [])
+00018fa0: 0a0a 2020 2020 2020 2020 6661 6b65 5f73  ..        fake_s
+00018fb0: 6372 6970 7428 7365 6c66 2c20 276a 756a  cript(self, 'juj
+00018fc0: 752d 6c6f 6727 2c20 2765 7869 7420 3127  u-log', 'exit 1'
+00018fd0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00018fe0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00018ff0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+00019000: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00019010: 6c66 2e62 6163 6b65 6e64 2e6a 756a 755f  lf.backend.juju_
+00019020: 6c6f 6728 2742 4152 272c 2027 666f 6f27  log('BAR', 'foo'
+00019030: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00019040: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
+00019050: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
+00019060: 662c 2063 6c65 6172 3d54 7275 6529 2c0a  f, clear=True),.
+00019070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019080: 2020 2020 2020 2020 205b 5b27 6a75 6a75           [['juju
+00019090: 2d6c 6f67 272c 2027 2d2d 6c6f 672d 6c65  -log', '--log-le
+000190a0: 7665 6c27 2c20 2742 4152 272c 2027 2d2d  vel', 'BAR', '--
+000190b0: 272c 2027 666f 6f27 5d5d 290a 0a20 2020  ', 'foo']])..   
+000190c0: 2064 6566 2074 6573 745f 7661 6c69 645f   def test_valid_
+000190d0: 6d65 7472 6963 7328 7365 6c66 293a 0a20  metrics(self):. 
+000190e0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+000190f0: 7074 2873 656c 662c 2027 6164 642d 6d65  pt(self, 'add-me
+00019100: 7472 6963 272c 2027 6578 6974 2030 2729  tric', 'exit 0')
+00019110: 0a20 2020 2020 2020 2074 6573 745f 6361  .        test_ca
+00019120: 7365 7320 3d20 5b28 0a20 2020 2020 2020  ses = [(.       
+00019130: 2020 2020 204f 7264 6572 6564 4469 6374       OrderedDict
+00019140: 285b 2827 666f 6f27 2c20 3432 292c 2028  ([('foo', 42), (
+00019150: 2762 2d61 7227 2c20 342e 3529 2c20 2827  'b-ar', 4.5), ('
+00019160: 6261 5f2d 7a27 2c20 342e 3529 2c20 2827  ba_-z', 4.5), ('
+00019170: 6127 2c20 3129 5d29 2c0a 2020 2020 2020  a', 1)]),.      
+00019180: 2020 2020 2020 4f72 6465 7265 6444 6963        OrderedDic
+00019190: 7428 5b28 2764 6527 2c20 2761 6427 292c  t([('de', 'ad'),
+000191a0: 2028 2762 6527 2c20 2765 665f 202d 2729   ('be', 'ef_ -')
+000191b0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+000191c0: 5b5b 2761 6464 2d6d 6574 7269 6327 2c20  [['add-metric', 
+000191d0: 272d 2d6c 6162 656c 7327 2c20 2764 653d  '--labels', 'de=
+000191e0: 6164 2c62 653d 6566 5f20 2d27 2c0a 2020  ad,be=ef_ -',.  
+000191f0: 2020 2020 2020 2020 2020 2020 2766 6f6f              'foo
+00019200: 3d34 3227 2c20 2762 2d61 723d 342e 3527  =42', 'b-ar=4.5'
+00019210: 2c20 2762 615f 2d7a 3d34 2e35 272c 2027  , 'ba_-z=4.5', '
+00019220: 613d 3127 5d5d 0a20 2020 2020 2020 2029  a=1']].        )
+00019230: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00019240: 4f72 6465 7265 6444 6963 7428 5b28 2766  OrderedDict([('f
+00019250: 6f6f 3127 2c20 3029 2c20 2827 6232 7227  oo1', 0), ('b2r'
+00019260: 2c20 342e 3529 5d29 2c0a 2020 2020 2020  , 4.5)]),.      
+00019270: 2020 2020 2020 4f72 6465 7265 6444 6963        OrderedDic
+00019280: 7428 5b28 2764 3327 2c20 2761 d0b4 2729  t([('d3', 'a..')
+00019290: 2c20 2827 6233 3366 272c 2027 335f 202d  , ('b33f', '3_ -
+000192a0: 2729 5d29 2c0a 2020 2020 2020 2020 2020  ')]),.          
+000192b0: 2020 5b5b 2761 6464 2d6d 6574 7269 6327    [['add-metric'
+000192c0: 2c20 272d 2d6c 6162 656c 7327 2c20 2764  , '--labels', 'd
+000192d0: 333d 61d0 b42c 6233 3366 3d33 5f20 2d27  3=a..,b33f=3_ -'
+000192e0: 2c20 2766 6f6f 313d 3027 2c20 2762 3272  , 'foo1=0', 'b2r
+000192f0: 3d34 2e35 275d 5d2c 0a20 2020 2020 2020  =4.5']],.       
+00019300: 2029 5d0a 2020 2020 2020 2020 666f 7220   )].        for 
+00019310: 6d65 7472 6963 732c 206c 6162 656c 732c  metrics, labels,
+00019320: 2065 7870 6563 7465 645f 6361 6c6c 7320   expected_calls 
+00019330: 696e 2074 6573 745f 6361 7365 733a 0a20  in test_cases:. 
+00019340: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019350: 6261 636b 656e 642e 6164 645f 6d65 7472  backend.add_metr
+00019360: 6963 7328 6d65 7472 6963 732c 206c 6162  ics(metrics, lab
+00019370: 656c 7329 0a20 2020 2020 2020 2020 2020  els).           
+00019380: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00019390: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+000193a0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+000193b0: 5472 7565 292c 2065 7870 6563 7465 645f  True), expected_
+000193c0: 6361 6c6c 7329 0a0a 2020 2020 6465 6620  calls)..    def 
+000193d0: 7465 7374 5f69 6e76 616c 6964 5f6d 6574  test_invalid_met
+000193e0: 7269 635f 6e61 6d65 7328 7365 6c66 293a  ric_names(self):
+000193f0: 0a20 2020 2020 2020 2069 6e76 616c 6964  .        invalid
+00019400: 5f69 6e70 7574 7320 3d20 5b0a 2020 2020  _inputs = [.    
+00019410: 2020 2020 2020 2020 287b 2727 3a20 342e          ({'': 4.
+00019420: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
+00019430: 2020 2020 2028 7b27 3127 3a20 342e 327d       ({'1': 4.2}
+00019440: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
+00019450: 2020 2028 7b27 3127 3a20 2d34 2e32 7d2c     ({'1': -4.2},
+00019460: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
+00019470: 2020 287b 2731 3233 273a 2034 2e32 7d2c    ({'123': 4.2},
+00019480: 207b 7d29 2c0a 2020 2020 2020 2020 2020   {}),.          
+00019490: 2020 287b 2731 666f 6f27 3a20 342e 327d    ({'1foo': 4.2}
+000194a0: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
+000194b0: 2020 2028 7b27 2d66 6f6f 273a 2034 2e32     ({'-foo': 4.2
+000194c0: 7d2c 207b 7d29 2c0a 2020 2020 2020 2020  }, {}),.        
+000194d0: 2020 2020 287b 275f 666f 6f27 3a20 342e      ({'_foo': 4.
+000194e0: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
+000194f0: 2020 2020 2028 7b27 666f 6f2d 273a 2034       ({'foo-': 4
+00019500: 2e32 7d2c 207b 7d29 2c0a 2020 2020 2020  .2}, {}),.      
+00019510: 2020 2020 2020 287b 2766 6f6f 5f27 3a20        ({'foo_': 
+00019520: 342e 327d 2c20 7b7d 292c 0a20 2020 2020  4.2}, {}),.     
+00019530: 2020 2020 2020 2028 7b27 612d 273a 2034         ({'a-': 4
+00019540: 2e32 7d2c 207b 7d29 2c0a 2020 2020 2020  .2}, {}),.      
+00019550: 2020 2020 2020 287b 2761 5f27 3a20 342e        ({'a_': 4.
+00019560: 327d 2c20 7b7d 292c 0a20 2020 2020 2020  2}, {}),.       
+00019570: 2020 2020 2028 7b27 4241 d0af 273a 2034       ({'BA..': 4
+00019580: 2e32 7d2c 207b 7d29 2c0a 2020 2020 2020  .2}, {}),.      
+00019590: 2020 5d0a 2020 2020 2020 2020 666f 7220    ].        for 
+000195a0: 6d65 7472 6963 732c 206c 6162 656c 7320  metrics, labels 
+000195b0: 696e 2069 6e76 616c 6964 5f69 6e70 7574  in invalid_input
+000195c0: 733a 0a20 2020 2020 2020 2020 2020 2077  s:.            w
+000195d0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+000195e0: 6169 7365 7328 6f70 732e 4d6f 6465 6c45  aises(ops.ModelE
+000195f0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00019600: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+00019610: 656e 642e 6164 645f 6d65 7472 6963 7328  end.add_metrics(
+00019620: 6d65 7472 6963 732c 206c 6162 656c 7329  metrics, labels)
+00019630: 0a0a 2020 2020 6465 6620 7465 7374 5f69  ..    def test_i
+00019640: 6e76 616c 6964 5f6d 6574 7269 635f 7661  nvalid_metric_va
+00019650: 6c75 6573 2873 656c 6629 3a0a 2020 2020  lues(self):.    
+00019660: 2020 2020 696e 7661 6c69 645f 696e 7075      invalid_inpu
+00019670: 7473 203d 205b 0a20 2020 2020 2020 2020  ts = [.         
+00019680: 2020 2028 7b27 6127 3a20 666c 6f61 7428     ({'a': float(
+00019690: 272b 696e 6627 297d 2c20 7b7d 292c 0a20  '+inf')}, {}),. 
+000196a0: 2020 2020 2020 2020 2020 2028 7b27 6127             ({'a'
+000196b0: 3a20 666c 6f61 7428 272d 696e 6627 297d  : float('-inf')}
+000196c0: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
+000196d0: 2020 2028 7b27 6127 3a20 666c 6f61 7428     ({'a': float(
+000196e0: 276e 616e 2729 7d2c 207b 7d29 2c0a 2020  'nan')}, {}),.  
+000196f0: 2020 2020 2020 2020 2020 287b 2766 6f6f            ({'foo
+00019700: 273a 2027 6261 7227 7d2c 207b 7d29 2c0a  ': 'bar'}, {}),.
+00019710: 2020 2020 2020 2020 2020 2020 287b 2766              ({'f
+00019720: 6f6f 273a 2027 314f 277d 2c20 7b7d 292c  oo': '1O'}, {}),
+00019730: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+00019740: 2020 2066 6f72 206d 6574 7269 6373 2c20     for metrics, 
+00019750: 6c61 6265 6c73 2069 6e20 696e 7661 6c69  labels in invali
+00019760: 645f 696e 7075 7473 3a0a 2020 2020 2020  d_inputs:.      
+00019770: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00019780: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00019790: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
+000197a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000197b0: 6c66 2e62 6163 6b65 6e64 2e61 6464 5f6d  lf.backend.add_m
+000197c0: 6574 7269 6373 286d 6574 7269 6373 2c20  etrics(metrics, 
+000197d0: 6c61 6265 6c73 290a 0a20 2020 2064 6566  labels)..    def
+000197e0: 2074 6573 745f 696e 7661 6c69 645f 6d65   test_invalid_me
+000197f0: 7472 6963 5f6c 6162 656c 7328 7365 6c66  tric_labels(self
+00019800: 293a 0a20 2020 2020 2020 2069 6e76 616c  ):.        inval
+00019810: 6964 5f69 6e70 7574 7320 3d20 5b0a 2020  id_inputs = [.  
+00019820: 2020 2020 2020 2020 2020 287b 2766 6f6f            ({'foo
+00019830: 273a 2034 2e32 7d2c 207b 2727 3a20 2762  ': 4.2}, {'': 'b
+00019840: 617a 277d 292c 0a20 2020 2020 2020 2020  az'}),.         
+00019850: 2020 2028 7b27 666f 6f27 3a20 342e 327d     ({'foo': 4.2}
+00019860: 2c20 7b27 2c62 6172 273a 2027 6261 7a27  , {',bar': 'baz'
+00019870: 7d29 2c0a 2020 2020 2020 2020 2020 2020  }),.            
+00019880: 287b 2766 6f6f 273a 2034 2e32 7d2c 207b  ({'foo': 4.2}, {
+00019890: 2762 3d61 3d72 273a 2027 6261 7a27 7d29  'b=a=r': 'baz'})
+000198a0: 2c0a 2020 2020 2020 2020 2020 2020 287b  ,.            ({
+000198b0: 2766 6f6f 273a 2034 2e32 7d2c 207b 2742  'foo': 4.2}, {'B
+000198c0: 41d0 af27 3a20 2762 617a 277d 292c 0a20  A..': 'baz'}),. 
+000198d0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+000198e0: 2066 6f72 206d 6574 7269 6373 2c20 6c61   for metrics, la
+000198f0: 6265 6c73 2069 6e20 696e 7661 6c69 645f  bels in invalid_
+00019900: 696e 7075 7473 3a0a 2020 2020 2020 2020  inputs:.        
+00019910: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00019920: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+00019930: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+00019940: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019950: 2e62 6163 6b65 6e64 2e61 6464 5f6d 6574  .backend.add_met
+00019960: 7269 6373 286d 6574 7269 6373 2c20 6c61  rics(metrics, la
+00019970: 6265 6c73 290a 0a20 2020 2064 6566 2074  bels)..    def t
+00019980: 6573 745f 696e 7661 6c69 645f 6d65 7472  est_invalid_metr
+00019990: 6963 5f6c 6162 656c 5f76 616c 7565 7328  ic_label_values(
+000199a0: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
+000199b0: 6e76 616c 6964 5f69 6e70 7574 7320 3d20  nvalid_inputs = 
+000199c0: 5b0a 2020 2020 2020 2020 2020 2020 287b  [.            ({
+000199d0: 2766 6f6f 273a 2034 2e32 7d2c 207b 2762  'foo': 4.2}, {'b
+000199e0: 6172 273a 2027 277d 292c 0a20 2020 2020  ar': ''}),.     
+000199f0: 2020 2020 2020 2028 7b27 666f 6f27 3a20         ({'foo': 
+00019a00: 342e 327d 2c20 7b27 6261 7227 3a20 2762  4.2}, {'bar': 'b
+00019a10: 2c61 7a27 7d29 2c0a 2020 2020 2020 2020  ,az'}),.        
+00019a20: 2020 2020 287b 2766 6f6f 273a 2034 2e32      ({'foo': 4.2
+00019a30: 7d2c 207b 2762 6172 273a 2027 623d 617a  }, {'bar': 'b=az
+00019a40: 277d 292c 0a20 2020 2020 2020 205d 0a20  '}),.        ]. 
+00019a50: 2020 2020 2020 2066 6f72 206d 6574 7269         for metri
+00019a60: 6373 2c20 6c61 6265 6c73 2069 6e20 696e  cs, labels in in
+00019a70: 7661 6c69 645f 696e 7075 7473 3a0a 2020  valid_inputs:.  
+00019a80: 2020 2020 2020 2020 2020 7769 7468 2073            with s
+00019a90: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00019aa0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+00019ab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019ac0: 2020 7365 6c66 2e62 6163 6b65 6e64 2e61    self.backend.a
+00019ad0: 6464 5f6d 6574 7269 6373 286d 6574 7269  dd_metrics(metri
+00019ae0: 6373 2c20 6c61 6265 6c73 290a 0a20 2020  cs, labels)..   
+00019af0: 2064 6566 2074 6573 745f 7265 6c61 7469   def test_relati
+00019b00: 6f6e 5f72 656d 6f74 655f 6170 705f 6e61  on_remote_app_na
+00019b10: 6d65 5f65 6e76 2873 656c 6629 3a0a 2020  me_env(self):.  
+00019b20: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+00019b30: 6561 6e75 7028 6f73 2e65 6e76 6972 6f6e  eanup(os.environ
+00019b40: 2e70 6f70 2c20 274a 554a 555f 5245 4c41  .pop, 'JUJU_RELA
+00019b50: 5449 4f4e 5f49 4427 2c20 4e6f 6e65 290a  TION_ID', None).
+00019b60: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00019b70: 436c 6561 6e75 7028 6f73 2e65 6e76 6972  Cleanup(os.envir
+00019b80: 6f6e 2e70 6f70 2c20 274a 554a 555f 5245  on.pop, 'JUJU_RE
+00019b90: 4d4f 5445 5f41 5050 272c 204e 6f6e 6529  MOTE_APP', None)
+00019ba0: 0a0a 2020 2020 2020 2020 6f73 2e65 6e76  ..        os.env
+00019bb0: 6972 6f6e 5b27 4a55 4a55 5f52 454c 4154  iron['JUJU_RELAT
+00019bc0: 494f 4e5f 4944 275d 203d 2027 783a 3527  ION_ID'] = 'x:5'
+00019bd0: 0a20 2020 2020 2020 206f 732e 656e 7669  .        os.envi
+00019be0: 726f 6e5b 274a 554a 555f 5245 4d4f 5445  ron['JUJU_REMOTE
+00019bf0: 5f41 5050 275d 203d 2027 7265 6d6f 7465  _APP'] = 'remote
+00019c00: 6170 7031 270a 2020 2020 2020 2020 7365  app1'.        se
+00019c10: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00019c20: 656c 662e 6261 636b 656e 642e 7265 6c61  elf.backend.rela
+00019c30: 7469 6f6e 5f72 656d 6f74 655f 6170 705f  tion_remote_app_
+00019c40: 6e61 6d65 2835 292c 2027 7265 6d6f 7465  name(5), 'remote
+00019c50: 6170 7031 2729 0a20 2020 2020 2020 206f  app1').        o
+00019c60: 732e 656e 7669 726f 6e5b 274a 554a 555f  s.environ['JUJU_
+00019c70: 5245 4c41 5449 4f4e 5f49 4427 5d20 3d20  RELATION_ID'] = 
+00019c80: 2735 270a 2020 2020 2020 2020 7365 6c66  '5'.        self
+00019c90: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+00019ca0: 662e 6261 636b 656e 642e 7265 6c61 7469  f.backend.relati
+00019cb0: 6f6e 5f72 656d 6f74 655f 6170 705f 6e61  on_remote_app_na
+00019cc0: 6d65 2835 292c 2027 7265 6d6f 7465 6170  me(5), 'remoteap
+00019cd0: 7031 2729 0a0a 2020 2020 6465 6620 7465  p1')..    def te
+00019ce0: 7374 5f72 656c 6174 696f 6e5f 7265 6d6f  st_relation_remo
+00019cf0: 7465 5f61 7070 5f6e 616d 655f 7363 7269  te_app_name_scri
+00019d00: 7074 5f73 7563 6365 7373 2873 656c 6629  pt_success(self)
+00019d10: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
+00019d20: 6464 436c 6561 6e75 7028 6f73 2e65 6e76  ddCleanup(os.env
+00019d30: 6972 6f6e 2e70 6f70 2c20 274a 554a 555f  iron.pop, 'JUJU_
+00019d40: 5245 4c41 5449 4f4e 5f49 4427 2c20 4e6f  RELATION_ID', No
+00019d50: 6e65 290a 2020 2020 2020 2020 7365 6c66  ne).        self
+00019d60: 2e61 6464 436c 6561 6e75 7028 6f73 2e65  .addCleanup(os.e
+00019d70: 6e76 6972 6f6e 2e70 6f70 2c20 274a 554a  nviron.pop, 'JUJ
+00019d80: 555f 5245 4d4f 5445 5f41 5050 272c 204e  U_REMOTE_APP', N
+00019d90: 6f6e 6529 0a0a 2020 2020 2020 2020 2320  one)..        # 
+00019da0: 4a55 4a55 5f52 454c 4154 494f 4e5f 4944  JUJU_RELATION_ID
+00019db0: 2061 6e64 204a 554a 555f 5245 4d4f 5445   and JUJU_REMOTE
+00019dc0: 5f41 5050 2062 6f74 6820 756e 7365 740a  _APP both unset.
+00019dd0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+00019de0: 6970 7428 7365 6c66 2c20 2772 656c 6174  ipt(self, 'relat
+00019df0: 696f 6e2d 6c69 7374 272c 2072 2222 220a  ion-list', r""".
+00019e00: 6563 686f 2027 2272 656d 6f74 6561 7070  echo '"remoteapp
+00019e10: 3222 270a 2222 2229 0a20 2020 2020 2020  2"'.""").       
+00019e20: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00019e30: 6c28 7365 6c66 2e62 6163 6b65 6e64 2e72  l(self.backend.r
+00019e40: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
+00019e50: 7070 5f6e 616d 6528 3129 2c20 2772 656d  pp_name(1), 'rem
+00019e60: 6f74 6561 7070 3227 290a 2020 2020 2020  oteapp2').      
+00019e70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00019e80: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+00019e90: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+00019ea0: 3d54 7275 6529 2c20 5b0a 2020 2020 2020  =True), [.      
+00019eb0: 2020 2020 2020 5b27 7265 6c61 7469 6f6e        ['relation
+00019ec0: 2d6c 6973 7427 2c20 272d 7227 2c20 2731  -list', '-r', '1
+00019ed0: 272c 2027 2d2d 6170 7027 2c20 272d 2d66  ', '--app', '--f
+00019ee0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
+00019ef0: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
+00019f00: 2020 2320 4a55 4a55 5f52 454c 4154 494f    # JUJU_RELATIO
+00019f10: 4e5f 4944 2073 6574 2062 7574 204a 554a  N_ID set but JUJ
+00019f20: 555f 5245 4d4f 5445 5f41 5050 2075 6e73  U_REMOTE_APP uns
+00019f30: 6574 0a20 2020 2020 2020 206f 732e 656e  et.        os.en
+00019f40: 7669 726f 6e5b 274a 554a 555f 5245 4c41  viron['JUJU_RELA
+00019f50: 5449 4f4e 5f49 4427 5d20 3d20 2778 3a35  TION_ID'] = 'x:5
+00019f60: 270a 2020 2020 2020 2020 7365 6c66 2e61  '.        self.a
+00019f70: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00019f80: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
+00019f90: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
+00019fa0: 2835 292c 2027 7265 6d6f 7465 6170 7032  (5), 'remoteapp2
+00019fb0: 2729 0a0a 2020 2020 2020 2020 2320 4a55  ')..        # JU
+00019fc0: 4a55 5f52 454c 4154 494f 4e5f 4944 2075  JU_RELATION_ID u
+00019fd0: 6e73 6574 2062 7574 204a 554a 555f 5245  nset but JUJU_RE
+00019fe0: 4d4f 5445 5f41 5050 2073 6574 0a20 2020  MOTE_APP set.   
+00019ff0: 2020 2020 2064 656c 206f 732e 656e 7669       del os.envi
+0001a000: 726f 6e5b 274a 554a 555f 5245 4c41 5449  ron['JUJU_RELATI
+0001a010: 4f4e 5f49 4427 5d0a 2020 2020 2020 2020  ON_ID'].        
+0001a020: 6f73 2e65 6e76 6972 6f6e 5b27 4a55 4a55  os.environ['JUJU
+0001a030: 5f52 454d 4f54 455f 4150 5027 5d20 3d20  _REMOTE_APP'] = 
+0001a040: 2772 656d 6f74 6561 7070 3127 0a20 2020  'remoteapp1'.   
+0001a050: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001a060: 4571 7561 6c28 7365 6c66 2e62 6163 6b65  Equal(self.backe
+0001a070: 6e64 2e72 656c 6174 696f 6e5f 7265 6d6f  nd.relation_remo
+0001a080: 7465 5f61 7070 5f6e 616d 6528 3529 2c20  te_app_name(5), 
+0001a090: 2772 656d 6f74 6561 7070 3227 290a 0a20  'remoteapp2').. 
+0001a0a0: 2020 2020 2020 2023 2042 6f74 6820 7365         # Both se
+0001a0b0: 742c 2062 7574 204a 554a 555f 5245 4c41  t, but JUJU_RELA
+0001a0c0: 5449 4f4e 5f49 4420 6120 6469 6666 6572  TION_ID a differ
+0001a0d0: 656e 7420 7265 6c61 7469 6f6e 0a20 2020  ent relation.   
+0001a0e0: 2020 2020 206f 732e 656e 7669 726f 6e5b       os.environ[
+0001a0f0: 274a 554a 555f 5245 4c41 5449 4f4e 5f49  'JUJU_RELATION_I
+0001a100: 4427 5d20 3d20 2778 3a36 270a 2020 2020  D'] = 'x:6'.    
+0001a110: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001a120: 7175 616c 2873 656c 662e 6261 636b 656e  qual(self.backen
+0001a130: 642e 7265 6c61 7469 6f6e 5f72 656d 6f74  d.relation_remot
+0001a140: 655f 6170 705f 6e61 6d65 2835 292c 2027  e_app_name(5), '
+0001a150: 7265 6d6f 7465 6170 7032 2729 0a0a 2020  remoteapp2')..  
+0001a160: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
+0001a170: 696f 6e5f 7265 6d6f 7465 5f61 7070 5f6e  ion_remote_app_n
+0001a180: 616d 655f 7363 7269 7074 5f65 7272 6f72  ame_script_error
+0001a190: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001a1a0: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+0001a1b0: 662c 2027 7265 6c61 7469 6f6e 2d6c 6973  f, 'relation-lis
+0001a1c0: 7427 2c20 7222 2222 0a65 6368 6f20 2245  t', r""".echo "E
+0001a1d0: 5252 4f52 2069 6e76 616c 6964 2076 616c  RROR invalid val
+0001a1e0: 7565 205c 2236 5c22 2066 6f72 206f 7074  ue \"6\" for opt
+0001a1f0: 696f 6e20 2d72 3a20 7265 6c61 7469 6f6e  ion -r: relation
+0001a200: 206e 6f74 2066 6f75 6e64 2220 3e26 3220   not found" >&2 
+0001a210: 2023 204e 4f51 410a 6578 6974 2032 0a22   # NOQA.exit 2."
+0001a220: 2222 290a 2020 2020 2020 2020 7365 6c66  "").        self
+0001a230: 2e61 7373 6572 7449 7328 7365 6c66 2e62  .assertIs(self.b
+0001a240: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+0001a250: 7265 6d6f 7465 5f61 7070 5f6e 616d 6528  remote_app_name(
+0001a260: 3629 2c20 4e6f 6e65 290a 2020 2020 2020  6), None).      
+0001a270: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001a280: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+0001a290: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+0001a2a0: 3d54 7275 6529 2c20 5b0a 2020 2020 2020  =True), [.      
+0001a2b0: 2020 2020 2020 5b27 7265 6c61 7469 6f6e        ['relation
+0001a2c0: 2d6c 6973 7427 2c20 272d 7227 2c20 2736  -list', '-r', '6
+0001a2d0: 272c 2027 2d2d 6170 7027 2c20 272d 2d66  ', '--app', '--f
+0001a2e0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
+0001a2f0: 2020 2020 2020 5d29 0a0a 2020 2020 2020        ])..      
+0001a300: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+0001a310: 6c66 2c20 2772 656c 6174 696f 6e2d 6c69  lf, 'relation-li
+0001a320: 7374 272c 2072 2222 220a 6563 686f 2022  st', r""".echo "
+0001a330: 4552 524f 5220 6f70 7469 6f6e 2070 726f  ERROR option pro
+0001a340: 7669 6465 6420 6275 7420 6e6f 7420 6465  vided but not de
+0001a350: 6669 6e65 643a 202d 2d61 7070 2220 3e26  fined: --app" >&
+0001a360: 320a 6578 6974 2032 0a22 2222 290a 2020  2.exit 2.""").  
+0001a370: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001a380: 7449 7328 7365 6c66 2e62 6163 6b65 6e64  tIs(self.backend
+0001a390: 2e72 656c 6174 696f 6e5f 7265 6d6f 7465  .relation_remote
+0001a3a0: 5f61 7070 5f6e 616d 6528 3629 2c20 4e6f  _app_name(6), No
+0001a3b0: 6e65 290a 2020 2020 2020 2020 7365 6c66  ne).        self
+0001a3c0: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+0001a3d0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+0001a3e0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+0001a3f0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0001a400: 5b27 7265 6c61 7469 6f6e 2d6c 6973 7427  ['relation-list'
+0001a410: 2c20 272d 7227 2c20 2736 272c 2027 2d2d  , '-r', '6', '--
+0001a420: 6170 7027 2c20 272d 2d66 6f72 6d61 743d  app', '--format=
+0001a430: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
+0001a440: 5d29 0a0a 0a63 6c61 7373 2054 6573 744c  ])...class TestL
+0001a450: 617a 794d 6170 7069 6e67 2875 6e69 7474  azyMapping(unitt
+0001a460: 6573 742e 5465 7374 4361 7365 293a 0a0a  est.TestCase):..
+0001a470: 2020 2020 6465 6620 7465 7374 5f69 6e76      def test_inv
+0001a480: 616c 6964 6174 6528 7365 6c66 293a 0a20  alidate(self):. 
+0001a490: 2020 2020 2020 206c 6f61 6465 6420 3d20         loaded = 
+0001a4a0: 5b5d 0a0a 2020 2020 2020 2020 636c 6173  []..        clas
+0001a4b0: 7320 4d79 4c61 7a79 4d61 7028 6f70 732e  s MyLazyMap(ops.
+0001a4c0: 4c61 7a79 4d61 7070 696e 6729 3a0a 2020  LazyMapping):.  
+0001a4d0: 2020 2020 2020 2020 2020 6465 6620 5f6c            def _l
+0001a4e0: 6f61 6428 7365 6c66 293a 0a20 2020 2020  oad(self):.     
+0001a4f0: 2020 2020 2020 2020 2020 206c 6f61 6465             loade
+0001a500: 642e 6170 7065 6e64 2831 290a 2020 2020  d.append(1).    
+0001a510: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001a520: 726e 207b 2766 6f6f 273a 2027 6261 7227  rn {'foo': 'bar'
+0001a530: 7d0a 0a20 2020 2020 2020 206d 6170 203d  }..        map =
+0001a540: 204d 794c 617a 794d 6170 2829 0a20 2020   MyLazyMap().   
+0001a550: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001a560: 4571 7561 6c28 6d61 705b 2766 6f6f 275d  Equal(map['foo']
+0001a570: 2c20 2762 6172 2729 0a20 2020 2020 2020  , 'bar').       
+0001a580: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001a590: 6c28 6c6f 6164 6564 2c20 5b31 5d29 0a20  l(loaded, [1]). 
+0001a5a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001a5b0: 7274 4571 7561 6c28 6d61 705b 2766 6f6f  rtEqual(map['foo
+0001a5c0: 275d 2c20 2762 6172 2729 0a20 2020 2020  '], 'bar').     
+0001a5d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001a5e0: 7561 6c28 6c6f 6164 6564 2c20 5b31 5d29  ual(loaded, [1])
+0001a5f0: 0a20 2020 2020 2020 206d 6170 2e5f 696e  .        map._in
+0001a600: 7661 6c69 6461 7465 2829 0a20 2020 2020  validate().     
+0001a610: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001a620: 7561 6c28 6d61 705b 2766 6f6f 275d 2c20  ual(map['foo'], 
+0001a630: 2762 6172 2729 0a20 2020 2020 2020 2073  'bar').        s
 0001a640: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001a650: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
-0001a660: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
-0001a670: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
-0001a680: 2020 205b 2772 656c 6174 696f 6e2d 6c69     ['relation-li
-0001a690: 7374 272c 2027 2d72 272c 2027 3627 2c20  st', '-r', '6', 
-0001a6a0: 272d 2d61 7070 272c 2027 2d2d 666f 726d  '--app', '--form
-0001a6b0: 6174 3d6a 736f 6e27 5d2c 0a20 2020 2020  at=json'],.     
-0001a6c0: 2020 205d 290a 0a20 2020 2020 2020 2066     ])..        f
-0001a6d0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001a6e0: 2027 7265 6c61 7469 6f6e 2d6c 6973 7427   'relation-list'
-0001a6f0: 2c20 7222 2222 0a65 6368 6f20 2245 5252  , r""".echo "ERR
-0001a700: 4f52 206f 7074 696f 6e20 7072 6f76 6964  OR option provid
-0001a710: 6564 2062 7574 206e 6f74 2064 6566 696e  ed but not defin
-0001a720: 6564 3a20 2d2d 6170 7022 203e 2632 0a65  ed: --app" >&2.e
-0001a730: 7869 7420 320a 2222 2229 0a20 2020 2020  xit 2.""").     
-0001a740: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001a750: 2873 656c 662e 6261 636b 656e 642e 7265  (self.backend.re
-0001a760: 6c61 7469 6f6e 5f72 656d 6f74 655f 6170  lation_remote_ap
-0001a770: 705f 6e61 6d65 2836 292c 204e 6f6e 6529  p_name(6), None)
-0001a780: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a790: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001a7a0: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001a7b0: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
-0001a7c0: 0a20 2020 2020 2020 2020 2020 205b 2772  .            ['r
-0001a7d0: 656c 6174 696f 6e2d 6c69 7374 272c 2027  elation-list', '
-0001a7e0: 2d72 272c 2027 3627 2c20 272d 2d61 7070  -r', '6', '--app
-0001a7f0: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
-0001a800: 6e27 5d2c 0a20 2020 2020 2020 205d 290a  n'],.        ]).
-0001a810: 0a0a 636c 6173 7320 5465 7374 4c61 7a79  ..class TestLazy
-0001a820: 4d61 7070 696e 6728 756e 6974 7465 7374  Mapping(unittest
-0001a830: 2e54 6573 7443 6173 6529 3a0a 0a20 2020  .TestCase):..   
-0001a840: 2064 6566 2074 6573 745f 696e 7661 6c69   def test_invali
-0001a850: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
-0001a860: 2020 2020 6c6f 6164 6564 203d 205b 5d0a      loaded = [].
-0001a870: 0a20 2020 2020 2020 2063 6c61 7373 204d  .        class M
-0001a880: 794c 617a 794d 6170 286f 7073 2e6d 6f64  yLazyMap(ops.mod
-0001a890: 656c 2e4c 617a 794d 6170 7069 6e67 293a  el.LazyMapping):
-0001a8a0: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
-0001a8b0: 205f 6c6f 6164 2873 656c 6629 3a0a 2020   _load(self):.  
-0001a8c0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0001a8d0: 6164 6564 2e61 7070 656e 6428 3129 0a20  aded.append(1). 
-0001a8e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001a8f0: 6574 7572 6e20 7b27 666f 6f27 3a20 2762  eturn {'foo': 'b
-0001a900: 6172 277d 0a0a 2020 2020 2020 2020 6d61  ar'}..        ma
-0001a910: 7020 3d20 4d79 4c61 7a79 4d61 7028 290a  p = MyLazyMap().
-0001a920: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001a930: 6572 7445 7175 616c 286d 6170 5b27 666f  ertEqual(map['fo
-0001a940: 6f27 5d2c 2027 6261 7227 290a 2020 2020  o'], 'bar').    
-0001a950: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001a960: 7175 616c 286c 6f61 6465 642c 205b 315d  qual(loaded, [1]
-0001a970: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001a980: 7373 6572 7445 7175 616c 286d 6170 5b27  ssertEqual(map['
-0001a990: 666f 6f27 5d2c 2027 6261 7227 290a 2020  foo'], 'bar').  
-0001a9a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001a9b0: 7445 7175 616c 286c 6f61 6465 642c 205b  tEqual(loaded, [
-0001a9c0: 315d 290a 2020 2020 2020 2020 6d61 702e  1]).        map.
-0001a9d0: 5f69 6e76 616c 6964 6174 6528 290a 2020  _invalidate().  
-0001a9e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001a9f0: 7445 7175 616c 286d 6170 5b27 666f 6f27  tEqual(map['foo'
-0001aa00: 5d2c 2027 6261 7227 290a 2020 2020 2020  ], 'bar').      
-0001aa10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001aa20: 616c 286c 6f61 6465 642c 205b 312c 2031  al(loaded, [1, 1
-0001aa30: 5d29 0a0a 0a63 6c61 7373 2054 6573 7453  ])...class TestS
-0001aa40: 6563 7265 7473 2875 6e69 7474 6573 742e  ecrets(unittest.
-0001aa50: 5465 7374 4361 7365 293a 0a20 2020 2064  TestCase):.    d
-0001aa60: 6566 2073 6574 5570 2873 656c 6629 3a0a  ef setUp(self):.
-0001aa70: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-0001aa80: 656c 203d 206f 7073 2e6d 6f64 656c 2e4d  el = ops.model.M
-0001aa90: 6f64 656c 286f 7073 2e63 6861 726d 2e43  odel(ops.charm.C
-0001aaa0: 6861 726d 4d65 7461 2829 2c20 6f70 732e  harmMeta(), ops.
-0001aab0: 6d6f 6465 6c2e 5f4d 6f64 656c 4261 636b  model._ModelBack
-0001aac0: 656e 6428 276d 7961 7070 2f30 2729 290a  end('myapp/0')).
-0001aad0: 2020 2020 2020 2020 7365 6c66 2e61 7070          self.app
-0001aae0: 203d 2073 656c 662e 6d6f 6465 6c2e 6170   = self.model.ap
-0001aaf0: 700a 2020 2020 2020 2020 7365 6c66 2e75  p.        self.u
-0001ab00: 6e69 7420 3d20 7365 6c66 2e6d 6f64 656c  nit = self.model
-0001ab10: 2e75 6e69 740a 0a20 2020 2064 6566 2074  .unit..    def t
-0001ab20: 6573 745f 6170 705f 6164 645f 7365 6372  est_app_add_secr
-0001ab30: 6574 5f73 696d 706c 6528 7365 6c66 293a  et_simple(self):
-0001ab40: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-0001ab50: 7269 7074 2873 656c 662c 2027 7365 6372  ript(self, 'secr
-0001ab60: 6574 2d61 6464 272c 2027 6563 686f 2073  et-add', 'echo s
-0001ab70: 6563 7265 743a 3132 3327 290a 0a20 2020  ecret:123')..   
-0001ab80: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
-0001ab90: 6c66 2e61 7070 2e61 6464 5f73 6563 7265  lf.app.add_secre
-0001aba0: 7428 7b27 666f 6f27 3a20 2778 277d 290a  t({'foo': 'x'}).
-0001abb0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001abc0: 6572 7449 7349 6e73 7461 6e63 6528 7365  ertIsInstance(se
-0001abd0: 6372 6574 2c20 6d6f 6465 6c2e 5365 6372  cret, model.Secr
-0001abe0: 6574 290a 2020 2020 2020 2020 7365 6c66  et).        self
-0001abf0: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001ac00: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
-0001ac10: 3132 3327 290a 2020 2020 2020 2020 7365  123').        se
-0001ac20: 6c66 2e61 7373 6572 7449 734e 6f6e 6528  lf.assertIsNone(
-0001ac30: 7365 6372 6574 2e6c 6162 656c 290a 0a20  secret.label).. 
-0001ac40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001ac50: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-0001ac60: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-0001ac70: 636c 6561 723d 5472 7565 292c 0a20 2020  clear=True),.   
-0001ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac90: 2020 2020 2020 5b5b 2773 6563 7265 742d        [['secret-
-0001aca0: 6164 6427 2c20 272d 2d6f 776e 6572 272c  add', '--owner',
-0001acb0: 2027 6170 706c 6963 6174 696f 6e27 2c20   'application', 
-0001acc0: 2766 6f6f 3d78 275d 5d29 0a0a 2020 2020  'foo=x']])..    
-0001acd0: 6465 6620 7465 7374 5f61 7070 5f61 6464  def test_app_add
-0001ace0: 5f73 6563 7265 745f 6172 6773 2873 656c  _secret_args(sel
-0001acf0: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-0001ad00: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-0001ad10: 6563 7265 742d 6164 6427 2c20 2765 6368  ecret-add', 'ech
-0001ad20: 6f20 7365 6372 6574 3a32 3334 2729 0a0a  o secret:234')..
-0001ad30: 2020 2020 2020 2020 6578 7069 7265 203d          expire =
-0001ad40: 2064 6174 6574 696d 652e 6461 7465 7469   datetime.dateti
-0001ad50: 6d65 2832 3032 322c 2031 322c 2039 2c20  me(2022, 12, 9, 
-0001ad60: 3136 2c20 3137 2c20 3029 0a20 2020 2020  16, 17, 0).     
-0001ad70: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001ad80: 2e61 7070 2e61 6464 5f73 6563 7265 7428  .app.add_secret(
-0001ad90: 7b27 666f 6f27 3a20 2778 272c 2027 6261  {'foo': 'x', 'ba
-0001ada0: 7227 3a20 2779 277d 2c20 6c61 6265 6c3d  r': 'y'}, label=
-0001adb0: 276c 626c 272c 2064 6573 6372 6970 7469  'lbl', descripti
-0001adc0: 6f6e 3d27 6465 7363 272c 0a20 2020 2020  on='desc',.     
-0001add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001adf0: 6578 7069 7265 3d65 7870 6972 652c 2072  expire=expire, r
-0001ae00: 6f74 6174 653d 6d6f 6465 6c2e 5365 6372  otate=model.Secr
-0001ae10: 6574 526f 7461 7465 2e48 4f55 524c 5929  etRotate.HOURLY)
-0001ae20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ae30: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001ae40: 2e69 642c 2027 7365 6372 6574 3a32 3334  .id, 'secret:234
-0001ae50: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001ae60: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
-0001ae70: 6574 2e6c 6162 656c 2c20 276c 626c 2729  et.label, 'lbl')
-0001ae80: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001ae90: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001aea0: 2e67 6574 5f63 6f6e 7465 6e74 2829 2c20  .get_content(), 
-0001aeb0: 7b27 666f 6f27 3a20 2778 272c 2027 6261  {'foo': 'x', 'ba
-0001aec0: 7227 3a20 2779 277d 290a 0a20 2020 2020  r': 'y'})..     
-0001aed0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001aee0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-0001aef0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-0001af00: 723d 5472 7565 292c 0a20 2020 2020 2020  r=True),.       
-0001af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af20: 2020 5b5b 2773 6563 7265 742d 6164 6427    [['secret-add'
-0001af30: 2c20 272d 2d6c 6162 656c 272c 2027 6c62  , '--label', 'lb
-0001af40: 6c27 2c20 272d 2d64 6573 6372 6970 7469  l', '--descripti
-0001af50: 6f6e 272c 2027 6465 7363 272c 0a20 2020  on', 'desc',.   
-0001af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af70: 2020 2020 2020 2020 272d 2d65 7870 6972          '--expir
-0001af80: 6527 2c20 2732 3032 322d 3132 2d30 3954  e', '2022-12-09T
-0001af90: 3136 3a31 373a 3030 272c 2027 2d2d 726f  16:17:00', '--ro
-0001afa0: 7461 7465 272c 2027 686f 7572 6c79 272c  tate', 'hourly',
-0001afb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001afc0: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
-0001afd0: 776e 6572 272c 2027 6170 706c 6963 6174  wner', 'applicat
-0001afe0: 696f 6e27 2c20 2766 6f6f 3d78 272c 2027  ion', 'foo=x', '
-0001aff0: 6261 723d 7927 5d5d 290a 0a20 2020 2064  bar=y']])..    d
-0001b000: 6566 2074 6573 745f 756e 6974 5f61 6464  ef test_unit_add
-0001b010: 5f73 6563 7265 745f 7369 6d70 6c65 2873  _secret_simple(s
-0001b020: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
-0001b030: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001b040: 2773 6563 7265 742d 6164 6427 2c20 2765  'secret-add', 'e
-0001b050: 6368 6f20 7365 6372 6574 3a33 3435 2729  cho secret:345')
-0001b060: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-0001b070: 203d 2073 656c 662e 756e 6974 2e61 6464   = self.unit.add
-0001b080: 5f73 6563 7265 7428 7b27 666f 6f27 3a20  _secret({'foo': 
-0001b090: 2778 277d 290a 2020 2020 2020 2020 7365  'x'}).        se
-0001b0a0: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-0001b0b0: 6e63 6528 7365 6372 6574 2c20 6d6f 6465  nce(secret, mode
-0001b0c0: 6c2e 5365 6372 6574 290a 2020 2020 2020  l.Secret).      
-0001b0d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001b0e0: 616c 2873 6563 7265 742e 6964 2c20 2773  al(secret.id, 's
-0001b0f0: 6563 7265 743a 3334 3527 290a 2020 2020  ecret:345').    
-0001b100: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0001b110: 734e 6f6e 6528 7365 6372 6574 2e6c 6162  sNone(secret.lab
-0001b120: 656c 290a 0a20 2020 2020 2020 2073 656c  el)..        sel
-0001b130: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001b140: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001b150: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001b160: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001b170: 2020 2020 2020 2020 2020 2020 5b5b 2773              [['s
-0001b180: 6563 7265 742d 6164 6427 2c20 272d 2d6f  ecret-add', '--o
-0001b190: 776e 6572 272c 2027 756e 6974 272c 2027  wner', 'unit', '
-0001b1a0: 666f 6f3d 7827 5d5d 290a 0a20 2020 2064  foo=x']])..    d
-0001b1b0: 6566 2074 6573 745f 756e 6974 5f61 6464  ef test_unit_add
-0001b1c0: 5f73 6563 7265 745f 6172 6773 2873 656c  _secret_args(sel
-0001b1d0: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-0001b1e0: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-0001b1f0: 6563 7265 742d 6164 6427 2c20 2765 6368  ecret-add', 'ech
-0001b200: 6f20 7365 6372 6574 3a34 3536 2729 0a0a  o secret:456')..
-0001b210: 2020 2020 2020 2020 6578 7069 7265 203d          expire =
-0001b220: 2064 6174 6574 696d 652e 6461 7465 7469   datetime.dateti
-0001b230: 6d65 2832 3032 322c 2031 322c 2039 2c20  me(2022, 12, 9, 
-0001b240: 3136 2c20 3232 2c20 3029 0a20 2020 2020  16, 22, 0).     
-0001b250: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001b260: 2e75 6e69 742e 6164 645f 7365 6372 6574  .unit.add_secret
-0001b270: 287b 2766 6f6f 273a 2027 7727 2c20 2762  ({'foo': 'w', 'b
-0001b280: 6172 273a 2027 7a27 7d2c 206c 6162 656c  ar': 'z'}, label
-0001b290: 3d27 6c32 272c 2064 6573 6372 6970 7469  ='l2', descripti
-0001b2a0: 6f6e 3d27 7879 7a27 2c0a 2020 2020 2020  on='xyz',.      
-0001b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2d0: 6578 7069 7265 3d65 7870 6972 652c 2072  expire=expire, r
-0001b2e0: 6f74 6174 653d 6d6f 6465 6c2e 5365 6372  otate=model.Secr
-0001b2f0: 6574 526f 7461 7465 2e59 4541 524c 5929  etRotate.YEARLY)
-0001b300: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001b310: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001b320: 2e69 642c 2027 7365 6372 6574 3a34 3536  .id, 'secret:456
-0001b330: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001b340: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
-0001b350: 6574 2e6c 6162 656c 2c20 276c 3227 290a  et.label, 'l2').
-0001b360: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001b370: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
-0001b380: 6765 745f 636f 6e74 656e 7428 292c 207b  get_content(), {
-0001b390: 2766 6f6f 273a 2027 7727 2c20 2762 6172  'foo': 'w', 'bar
-0001b3a0: 273a 2027 7a27 7d29 0a0a 2020 2020 2020  ': 'z'})..      
-0001b3b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001b3c0: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
-0001b3d0: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
-0001b3e0: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-0001b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b400: 205b 5b27 7365 6372 6574 2d61 6464 272c   [['secret-add',
-0001b410: 2027 2d2d 6c61 6265 6c27 2c20 276c 3227   '--label', 'l2'
-0001b420: 2c20 272d 2d64 6573 6372 6970 7469 6f6e  , '--description
-0001b430: 272c 2027 7879 7a27 2c0a 2020 2020 2020  ', 'xyz',.      
-0001b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b450: 2020 2020 2027 2d2d 6578 7069 7265 272c       '--expire',
-0001b460: 2027 3230 3232 2d31 322d 3039 5431 363a   '2022-12-09T16:
-0001b470: 3232 3a30 3027 2c20 272d 2d72 6f74 6174  22:00', '--rotat
-0001b480: 6527 2c20 2779 6561 726c 7927 2c0a 2020  e', 'yearly',.  
-0001b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4a0: 2020 2020 2020 2020 2027 2d2d 6f77 6e65           '--owne
-0001b4b0: 7227 2c20 2775 6e69 7427 2c20 2766 6f6f  r', 'unit', 'foo
-0001b4c0: 3d77 272c 2027 6261 723d 7a27 5d5d 290a  =w', 'bar=z']]).
-0001b4d0: 0a20 2020 2064 6566 2074 6573 745f 756e  .    def test_un
-0001b4e0: 6974 5f61 6464 5f73 6563 7265 745f 6572  it_add_secret_er
-0001b4f0: 726f 7273 2873 656c 6629 3a0a 2020 2020  rors(self):.    
-0001b500: 2020 2020 2320 4164 6469 7469 6f6e 616c      # Additional
-0001b510: 2061 6464 5f73 6563 7265 7420 7465 7374   add_secret test
-0001b520: 7320 6172 6520 646f 6e65 2069 6e20 5465  s are done in Te
-0001b530: 7374 4170 706c 6963 6174 696f 6e0a 2020  stApplication.  
-0001b540: 2020 2020 2020 6572 726f 7273 203d 205b        errors = [
-0001b550: 0a20 2020 2020 2020 2020 2020 2028 7b27  .            ({'
-0001b560: 7879 273a 2027 6261 7227 7d2c 207b 7d2c  xy': 'bar'}, {},
-0001b570: 2056 616c 7565 4572 726f 7229 2c0a 2020   ValueError),.  
-0001b580: 2020 2020 2020 2020 2020 287b 2766 6f6f            ({'foo
-0001b590: 273a 2027 7827 7d2c 207b 2765 7870 6972  ': 'x'}, {'expir
-0001b5a0: 6527 3a20 377d 2c20 5479 7065 4572 726f  e': 7}, TypeErro
-0001b5b0: 7229 2c0a 2020 2020 2020 2020 5d0a 2020  r),.        ].  
-0001b5c0: 2020 2020 2020 666f 7220 636f 6e74 656e        for conten
-0001b5d0: 742c 206b 7761 7267 732c 2065 7863 5f74  t, kwargs, exc_t
-0001b5e0: 7970 6520 696e 2065 7272 6f72 733a 0a20  ype in errors:. 
-0001b5f0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0001b600: 2066 2765 7870 6563 7465 6420 7b65 7863   f'expected {exc
-0001b610: 5f74 7970 652e 5f5f 6e61 6d65 5f5f 7d20  _type.__name__} 
-0001b620: 7768 656e 2061 6464 696e 6720 7365 6372  when adding secr
-0001b630: 6574 2063 6f6e 7465 6e74 207b 636f 6e74  et content {cont
-0001b640: 656e 747d 270a 2020 2020 2020 2020 2020  ent}'.          
-0001b650: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0001b660: 7274 5261 6973 6573 2865 7863 5f74 7970  rtRaises(exc_typ
-0001b670: 652c 206d 7367 3d6d 7367 293a 0a20 2020  e, msg=msg):.   
-0001b680: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001b690: 662e 756e 6974 2e61 6464 5f73 6563 7265  f.unit.add_secre
-0001b6a0: 7428 636f 6e74 656e 742c 202a 2a6b 7761  t(content, **kwa
-0001b6b0: 7267 7329 0a0a 2020 2020 6465 6620 7465  rgs)..    def te
-0001b6c0: 7374 5f61 6464 5f73 6563 7265 745f 6572  st_add_secret_er
-0001b6d0: 726f 7273 2873 656c 6629 3a0a 2020 2020  rors(self):.    
-0001b6e0: 2020 2020 6572 726f 7273 203d 205b 0a20      errors = [. 
-0001b6f0: 2020 2020 2020 2020 2020 2023 2049 6e76             # Inv
-0001b700: 616c 6964 2063 6f6e 7465 6e74 2064 6963  alid content dic
-0001b710: 7420 6f72 2074 7970 6573 0a20 2020 2020  t or types.     
-0001b720: 2020 2020 2020 2028 4e6f 6e65 2c20 7b7d         (None, {}
-0001b730: 2c20 5479 7065 4572 726f 7229 2c0a 2020  , TypeError),.  
-0001b740: 2020 2020 2020 2020 2020 287b 7d2c 207b            ({}, {
-0001b750: 7d2c 2056 616c 7565 4572 726f 7229 2c0a  }, ValueError),.
-0001b760: 2020 2020 2020 2020 2020 2020 287b 6227              ({b'
-0001b770: 666f 6f27 2c20 2762 6172 277d 2c20 7b7d  foo', 'bar'}, {}
-0001b780: 2c20 5479 7065 4572 726f 7229 2c0a 2020  , TypeError),.  
-0001b790: 2020 2020 2020 2020 2020 287b 333a 2027            ({3: '
-0001b7a0: 6261 7227 7d2c 207b 7d2c 2054 7970 6545  bar'}, {}, TypeE
-0001b7b0: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
-0001b7c0: 2020 2028 7b27 666f 6f27 3a20 312c 2027     ({'foo': 1, '
-0001b7d0: 6261 7227 3a20 327d 2c20 7b7d 2c20 5479  bar': 2}, {}, Ty
-0001b7e0: 7065 4572 726f 7229 2c0a 2020 2020 2020  peError),.      
-0001b7f0: 2020 2020 2020 2320 496e 7661 6c69 6420        # Invalid 
-0001b800: 636f 6e74 656e 7420 6b65 7973 0a20 2020  content keys.   
-0001b810: 2020 2020 2020 2020 2028 7b27 7879 273a           ({'xy':
-0001b820: 2027 6261 7227 7d2c 207b 7d2c 2056 616c   'bar'}, {}, Val
-0001b830: 7565 4572 726f 7229 2c0a 2020 2020 2020  ueError),.      
-0001b840: 2020 2020 2020 287b 2746 4f4f 273a 2027        ({'FOO': '
-0001b850: 6261 7227 7d2c 207b 7d2c 2056 616c 7565  bar'}, {}, Value
-0001b860: 4572 726f 7229 2c0a 2020 2020 2020 2020  Error),.        
-0001b870: 2020 2020 287b 2766 6f6f 2d27 3a20 2762      ({'foo-': 'b
-0001b880: 6172 277d 2c20 7b7d 2c20 5661 6c75 6545  ar'}, {}, ValueE
-0001b890: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
-0001b8a0: 2020 2028 7b27 2d66 6f6f 273a 2027 6261     ({'-foo': 'ba
-0001b8b0: 7227 7d2c 207b 7d2c 2056 616c 7565 4572  r'}, {}, ValueEr
-0001b8c0: 726f 7229 2c0a 2020 2020 2020 2020 2020  ror),.          
-0001b8d0: 2020 2320 496e 7661 6c69 6420 2265 7870    # Invalid "exp
-0001b8e0: 6972 6522 2074 7970 650a 2020 2020 2020  ire" type.      
-0001b8f0: 2020 2020 2020 287b 2766 6f6f 273a 2027        ({'foo': '
-0001b900: 7827 7d2c 207b 2765 7870 6972 6527 3a20  x'}, {'expire': 
-0001b910: 377d 2c20 5479 7065 4572 726f 7229 2c0a  7}, TypeError),.
-0001b920: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0001b930: 2020 666f 7220 636f 6e74 656e 742c 206b    for content, k
-0001b940: 7761 7267 732c 2065 7863 5f74 7970 6520  wargs, exc_type 
-0001b950: 696e 2065 7272 6f72 733a 0a20 2020 2020  in errors:.     
-0001b960: 2020 2020 2020 206d 7367 203d 2066 2765         msg = f'e
-0001b970: 7870 6563 7465 6420 7b65 7863 5f74 7970  xpected {exc_typ
-0001b980: 652e 5f5f 6e61 6d65 5f5f 7d20 7768 656e  e.__name__} when
-0001b990: 2061 6464 696e 6720 7365 6372 6574 2063   adding secret c
-0001b9a0: 6f6e 7465 6e74 207b 636f 6e74 656e 747d  ontent {content}
-0001b9b0: 270a 2020 2020 2020 2020 2020 2020 7769  '.            wi
-0001b9c0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0001b9d0: 6973 6573 2865 7863 5f74 7970 652c 206d  ises(exc_type, m
-0001b9e0: 7367 3d6d 7367 293a 0a20 2020 2020 2020  sg=msg):.       
-0001b9f0: 2020 2020 2020 2020 2073 656c 662e 6170           self.ap
-0001ba00: 702e 6164 645f 7365 6372 6574 2863 6f6e  p.add_secret(con
-0001ba10: 7465 6e74 2c20 2a2a 6b77 6172 6773 290a  tent, **kwargs).
-0001ba20: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0001ba30: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0001ba40: 6573 2865 7863 5f74 7970 652c 206d 7367  es(exc_type, msg
-0001ba50: 3d6d 7367 293a 0a20 2020 2020 2020 2020  =msg):.         
-0001ba60: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
-0001ba70: 2e61 6464 5f73 6563 7265 7428 636f 6e74  .add_secret(cont
-0001ba80: 656e 742c 202a 2a6b 7761 7267 7329 0a0a  ent, **kwargs)..
-0001ba90: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0001baa0: 5f73 6563 7265 745f 6964 2873 656c 6629  _secret_id(self)
-0001bab0: 3a0a 2020 2020 2020 2020 6661 6b65 5f73  :.        fake_s
-0001bac0: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
-0001bad0: 7265 742d 6765 7427 2c20 2222 2265 6368  ret-get', """ech
-0001bae0: 6f20 277b 2266 6f6f 223a 2022 6722 7d27  o '{"foo": "g"}'
-0001baf0: 2222 2229 0a0a 2020 2020 2020 2020 7365  """)..        se
-0001bb00: 6372 6574 203d 2073 656c 662e 6d6f 6465  cret = self.mode
-0001bb10: 6c2e 6765 745f 7365 6372 6574 2869 643d  l.get_secret(id=
-0001bb20: 2731 3233 2729 0a20 2020 2020 2020 2073  '123').        s
-0001bb30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001bb40: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
-0001bb50: 6574 3a31 3233 2729 0a20 2020 2020 2020  et:123').       
-0001bb60: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-0001bb70: 6e65 2873 6563 7265 742e 6c61 6265 6c29  ne(secret.label)
-0001bb80: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001bb90: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001bba0: 2e67 6574 5f63 6f6e 7465 6e74 2829 2c20  .get_content(), 
-0001bbb0: 7b27 666f 6f27 3a20 2767 277d 290a 0a20  {'foo': 'g'}).. 
-0001bbc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001bbd0: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-0001bbe0: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-0001bbf0: 636c 6561 723d 5472 7565 292c 0a20 2020  clear=True),.   
-0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc10: 2020 2020 2020 5b5b 2773 6563 7265 742d        [['secret-
-0001bc20: 6765 7427 2c20 2773 6563 7265 743a 3132  get', 'secret:12
-0001bc30: 3327 2c20 272d 2d66 6f72 6d61 743d 6a73  3', '--format=js
-0001bc40: 6f6e 275d 5d29 0a0a 2020 2020 6465 6620  on']])..    def 
-0001bc50: 7465 7374 5f67 6574 5f73 6563 7265 745f  test_get_secret_
-0001bc60: 6c61 6265 6c28 7365 6c66 293a 0a20 2020  label(self):.   
-0001bc70: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001bc80: 2873 656c 662c 2027 7365 6372 6574 2d67  (self, 'secret-g
-0001bc90: 6574 272c 2022 2222 6563 686f 2027 7b22  et', """echo '{"
-0001bca0: 666f 6f22 3a20 2267 227d 2722 2222 290a  foo": "g"}'""").
-0001bcb0: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
-0001bcc0: 3d20 7365 6c66 2e6d 6f64 656c 2e67 6574  = self.model.get
-0001bcd0: 5f73 6563 7265 7428 6c61 6265 6c3d 276c  _secret(label='l
-0001bce0: 626c 2729 0a20 2020 2020 2020 2073 656c  bl').        sel
-0001bcf0: 662e 6173 7365 7274 4973 4e6f 6e65 2873  f.assertIsNone(s
-0001bd00: 6563 7265 742e 6964 290a 2020 2020 2020  ecret.id).      
-0001bd10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001bd20: 616c 2873 6563 7265 742e 6c61 6265 6c2c  al(secret.label,
-0001bd30: 2027 6c62 6c27 290a 2020 2020 2020 2020   'lbl').        
-0001bd40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001bd50: 2873 6563 7265 742e 6765 745f 636f 6e74  (secret.get_cont
-0001bd60: 656e 7428 292c 207b 2766 6f6f 273a 2027  ent(), {'foo': '
-0001bd70: 6727 7d29 0a0a 2020 2020 2020 2020 7365  g'})..        se
-0001bd80: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-0001bd90: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-0001bda0: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-0001bdb0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0001bdc0: 2020 2020 2020 2020 2020 2020 205b 5b27               [['
-0001bdd0: 7365 6372 6574 2d67 6574 272c 2027 2d2d  secret-get', '--
-0001bde0: 6c61 6265 6c27 2c20 276c 626c 272c 2027  label', 'lbl', '
-0001bdf0: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d5d  --format=json']]
-0001be00: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001be10: 6765 745f 7365 6372 6574 5f69 645f 616e  get_secret_id_an
-0001be20: 645f 6c61 6265 6c28 7365 6c66 293a 0a20  d_label(self):. 
-0001be30: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
-0001be40: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
-0001be50: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
-0001be60: 7b22 666f 6f22 3a20 2268 227d 2722 2222  {"foo": "h"}'"""
-0001be70: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0001be80: 7420 3d20 7365 6c66 2e6d 6f64 656c 2e67  t = self.model.g
-0001be90: 6574 5f73 6563 7265 7428 6964 3d27 3132  et_secret(id='12
-0001bea0: 3327 2c20 6c61 6265 6c3d 276c 2729 0a20  3', label='l'). 
-0001beb0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001bec0: 7274 4571 7561 6c28 7365 6372 6574 2e69  rtEqual(secret.i
-0001bed0: 642c 2027 7365 6372 6574 3a31 3233 2729  d, 'secret:123')
-0001bee0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001bef0: 7365 7274 4571 7561 6c28 7365 6372 6574  sertEqual(secret
-0001bf00: 2e6c 6162 656c 2c20 276c 2729 0a20 2020  .label, 'l').   
-0001bf10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001bf20: 4571 7561 6c28 7365 6372 6574 2e67 6574  Equal(secret.get
-0001bf30: 5f63 6f6e 7465 6e74 2829 2c20 7b27 666f  _content(), {'fo
-0001bf40: 6f27 3a20 2768 277d 290a 0a20 2020 2020  o': 'h'})..     
-0001bf50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001bf60: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-0001bf70: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-0001bf80: 723d 5472 7565 292c 0a20 2020 2020 2020  r=True),.       
-0001bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfa0: 2020 5b5b 2773 6563 7265 742d 6765 7427    [['secret-get'
-0001bfb0: 2c20 2773 6563 7265 743a 3132 3327 2c20  , 'secret:123', 
-0001bfc0: 272d 2d6c 6162 656c 272c 2027 6c27 2c20  '--label', 'l', 
-0001bfd0: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
-0001bfe0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001bff0: 5f67 6574 5f73 6563 7265 745f 6e6f 5f61  _get_secret_no_a
-0001c000: 7267 7328 7365 6c66 293a 0a20 2020 2020  rgs(self):.     
-0001c010: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0001c020: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-0001c030: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0001c040: 2020 7365 6c66 2e6d 6f64 656c 2e67 6574    self.model.get
-0001c050: 5f73 6563 7265 7428 290a 0a20 2020 2064  _secret()..    d
-0001c060: 6566 2074 6573 745f 6765 745f 7365 6372  ef test_get_secr
-0001c070: 6574 5f6e 6f74 5f66 6f75 6e64 2873 656c  et_not_found(sel
-0001c080: 6629 3a0a 2020 2020 2020 2020 7363 7269  f):.        scri
-0001c090: 7074 203d 2022 2222 6563 686f 2027 4552  pt = """echo 'ER
-0001c0a0: 524f 5220 7365 6372 6574 2022 3132 3322  ROR secret "123"
-0001c0b0: 206e 6f74 2066 6f75 6e64 2720 3e26 323b   not found' >&2;
-0001c0c0: 2065 7869 7420 3122 2222 0a20 2020 2020   exit 1""".     
-0001c0d0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001c0e0: 656c 662c 2027 7365 6372 6574 2d67 6574  elf, 'secret-get
-0001c0f0: 272c 2073 6372 6970 7429 0a20 2020 2020  ', script).     
-0001c100: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001c110: 656c 662c 2027 7365 6372 6574 2d69 6e66  elf, 'secret-inf
-0001c120: 6f2d 6765 7427 2c20 7363 7269 7074 290a  o-get', script).
-0001c130: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0001c140: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0001c150: 6d6f 6465 6c2e 5365 6372 6574 4e6f 7446  model.SecretNotF
-0001c160: 6f75 6e64 4572 726f 7229 3a0a 2020 2020  oundError):.    
-0001c170: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-0001c180: 656c 2e67 6574 5f73 6563 7265 7428 6964  el.get_secret(id
-0001c190: 3d27 3132 3327 290a 0a20 2020 2064 6566  ='123')..    def
-0001c1a0: 2074 6573 745f 6765 745f 7365 6372 6574   test_get_secret
-0001c1b0: 5f6f 7468 6572 5f65 7272 6f72 2873 656c  _other_error(sel
-0001c1c0: 6629 3a0a 2020 2020 2020 2020 7363 7269  f):.        scri
-0001c1d0: 7074 203d 2022 2222 6563 686f 2027 4552  pt = """echo 'ER
-0001c1e0: 524f 5220 6f74 6865 7220 6572 726f 7227  ROR other error'
-0001c1f0: 203e 2632 3b20 6578 6974 2031 2222 220a   >&2; exit 1""".
-0001c200: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-0001c210: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
-0001c220: 742d 6765 7427 2c20 7363 7269 7074 290a  t-get', script).
-0001c230: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-0001c240: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
-0001c250: 742d 696e 666f 2d67 6574 272c 2073 6372  t-info-get', scr
-0001c260: 6970 7429 0a0a 2020 2020 2020 2020 7769  ipt)..        wi
-0001c270: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0001c280: 6973 6573 286d 6f64 656c 2e4d 6f64 656c  ises(model.Model
-0001c290: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
-0001c2a0: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-0001c2b0: 6f64 656c 2e67 6574 5f73 6563 7265 7428  odel.get_secret(
-0001c2c0: 6964 3d27 3132 3327 290a 2020 2020 2020  id='123').      
-0001c2d0: 2020 7365 6c66 2e61 7373 6572 744e 6f74    self.assertNot
-0001c2e0: 4973 496e 7374 616e 6365 2863 6d2e 6578  IsInstance(cm.ex
-0001c2f0: 6365 7074 696f 6e2c 206d 6f64 656c 2e53  ception, model.S
-0001c300: 6563 7265 744e 6f74 466f 756e 6445 7272  ecretNotFoundErr
-0001c310: 6f72 290a 0a0a 636c 6173 7320 5465 7374  or)...class Test
-0001c320: 5365 6372 6574 496e 666f 2875 6e69 7474  SecretInfo(unitt
-0001c330: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
-0001c340: 2020 2064 6566 2074 6573 745f 696e 6974     def test_init
-0001c350: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001c360: 696e 666f 203d 206d 6f64 656c 2e53 6563  info = model.Sec
-0001c370: 7265 7449 6e66 6f28 0a20 2020 2020 2020  retInfo(.       
-0001c380: 2020 2020 2069 643d 2733 272c 0a20 2020       id='3',.   
-0001c390: 2020 2020 2020 2020 206c 6162 656c 3d27           label='
-0001c3a0: 6c62 6c27 2c0a 2020 2020 2020 2020 2020  lbl',.          
-0001c3b0: 2020 7265 7669 7369 6f6e 3d37 2c0a 2020    revision=7,.  
-0001c3c0: 2020 2020 2020 2020 2020 6578 7069 7265            expire
-0001c3d0: 733d 6461 7465 7469 6d65 2e64 6174 6574  s=datetime.datet
-0001c3e0: 696d 6528 3230 3232 2c20 3132 2c20 392c  ime(2022, 12, 9,
-0001c3f0: 2031 342c 2031 302c 2030 292c 0a20 2020   14, 10, 0),.   
-0001c400: 2020 2020 2020 2020 2072 6f74 6174 696f           rotatio
-0001c410: 6e3d 6d6f 6465 6c2e 5365 6372 6574 526f  n=model.SecretRo
-0001c420: 7461 7465 2e4d 4f4e 5448 4c59 2c0a 2020  tate.MONTHLY,.  
-0001c430: 2020 2020 2020 2020 2020 726f 7461 7465            rotate
-0001c440: 733d 6461 7465 7469 6d65 2e64 6174 6574  s=datetime.datet
-0001c450: 696d 6528 3230 3233 2c20 312c 2039 2c20  ime(2023, 1, 9, 
-0001c460: 3134 2c20 3130 2c20 3029 2c0a 2020 2020  14, 10, 0),.    
-0001c470: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0001c480: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-0001c490: 6e66 6f2e 6964 2c20 2773 6563 7265 743a  nfo.id, 'secret:
-0001c4a0: 3327 290a 2020 2020 2020 2020 7365 6c66  3').        self
-0001c4b0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-0001c4c0: 6f2e 6c61 6265 6c2c 2027 6c62 6c27 290a  o.label, 'lbl').
-0001c4d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001c4e0: 6572 7445 7175 616c 2869 6e66 6f2e 7265  ertEqual(info.re
-0001c4f0: 7669 7369 6f6e 2c20 3729 0a20 2020 2020  vision, 7).     
-0001c500: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001c510: 7561 6c28 696e 666f 2e65 7870 6972 6573  ual(info.expires
-0001c520: 2c20 6461 7465 7469 6d65 2e64 6174 6574  , datetime.datet
-0001c530: 696d 6528 3230 3232 2c20 3132 2c20 392c  ime(2022, 12, 9,
-0001c540: 2031 342c 2031 302c 2030 2929 0a20 2020   14, 10, 0)).   
-0001c550: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001c560: 4571 7561 6c28 696e 666f 2e72 6f74 6174  Equal(info.rotat
-0001c570: 696f 6e2c 206d 6f64 656c 2e53 6563 7265  ion, model.Secre
-0001c580: 7452 6f74 6174 652e 4d4f 4e54 484c 5929  tRotate.MONTHLY)
-0001c590: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001c5a0: 7365 7274 4571 7561 6c28 696e 666f 2e72  sertEqual(info.r
-0001c5b0: 6f74 6174 6573 2c20 6461 7465 7469 6d65  otates, datetime
-0001c5c0: 2e64 6174 6574 696d 6528 3230 3233 2c20  .datetime(2023, 
-0001c5d0: 312c 2039 2c20 3134 2c20 3130 2c20 3029  1, 9, 14, 10, 0)
-0001c5e0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001c5f0: 6173 7365 7274 5472 7565 2872 6570 7228  assertTrue(repr(
-0001c600: 696e 666f 292e 7374 6172 7473 7769 7468  info).startswith
-0001c610: 2827 5365 6372 6574 496e 666f 2827 2929  ('SecretInfo('))
-0001c620: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001c630: 7365 7274 5472 7565 2872 6570 7228 696e  sertTrue(repr(in
-0001c640: 666f 292e 656e 6473 7769 7468 2827 2927  fo).endswith(')'
-0001c650: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-0001c660: 5f66 726f 6d5f 6469 6374 2873 656c 6629  _from_dict(self)
-0001c670: 3a0a 2020 2020 2020 2020 7574 6320 3d20  :.        utc = 
-0001c680: 6461 7465 7469 6d65 2e74 696d 657a 6f6e  datetime.timezon
-0001c690: 652e 7574 630a 2020 2020 2020 2020 696e  e.utc.        in
-0001c6a0: 666f 203d 206d 6f64 656c 2e53 6563 7265  fo = model.Secre
-0001c6b0: 7449 6e66 6f2e 6672 6f6d 5f64 6963 7428  tInfo.from_dict(
-0001c6c0: 2773 6563 7265 743a 3427 2c20 7b0a 2020  'secret:4', {.  
-0001c6d0: 2020 2020 2020 2020 2020 276c 6162 656c            'label
-0001c6e0: 273a 2027 6672 6f6d 6469 6374 272c 0a20  ': 'fromdict',. 
-0001c6f0: 2020 2020 2020 2020 2020 2027 7265 7669             'revi
-0001c700: 7369 6f6e 273a 2038 2c0a 2020 2020 2020  sion': 8,.      
-0001c710: 2020 2020 2020 2765 7870 6972 6573 273a        'expires':
-0001c720: 2027 3230 3232 2d31 322d 3039 5431 343a   '2022-12-09T14:
-0001c730: 3130 3a30 305a 272c 0a20 2020 2020 2020  10:00Z',.       
-0001c740: 2020 2020 2027 726f 7461 7469 6f6e 273a       'rotation':
-0001c750: 2027 7965 6172 6c79 272c 0a20 2020 2020   'yearly',.     
-0001c760: 2020 2020 2020 2027 726f 7461 7465 7327         'rotates'
-0001c770: 3a20 2732 3032 332d 3031 2d30 3954 3134  : '2023-01-09T14
-0001c780: 3a31 303a 3030 5a27 2c0a 2020 2020 2020  :10:00Z',.      
-0001c790: 2020 7d29 0a20 2020 2020 2020 2073 656c    }).        sel
-0001c7a0: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-0001c7b0: 666f 2e69 642c 2027 7365 6372 6574 3a34  fo.id, 'secret:4
-0001c7c0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001c7d0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-0001c7e0: 2e6c 6162 656c 2c20 2766 726f 6d64 6963  .label, 'fromdic
-0001c7f0: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
-0001c800: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-0001c810: 6f2e 7265 7669 7369 6f6e 2c20 3829 0a20  o.revision, 8). 
-0001c820: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001c830: 7274 4571 7561 6c28 696e 666f 2e65 7870  rtEqual(info.exp
-0001c840: 6972 6573 2c20 6461 7465 7469 6d65 2e64  ires, datetime.d
-0001c850: 6174 6574 696d 6528 3230 3232 2c20 3132  atetime(2022, 12
-0001c860: 2c20 392c 2031 342c 2031 302c 2030 2c20  , 9, 14, 10, 0, 
-0001c870: 747a 696e 666f 3d75 7463 2929 0a20 2020  tzinfo=utc)).   
-0001c880: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001c890: 4571 7561 6c28 696e 666f 2e72 6f74 6174  Equal(info.rotat
-0001c8a0: 696f 6e2c 206d 6f64 656c 2e53 6563 7265  ion, model.Secre
-0001c8b0: 7452 6f74 6174 652e 5945 4152 4c59 290a  tRotate.YEARLY).
-0001c8c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001c8d0: 6572 7445 7175 616c 2869 6e66 6f2e 726f  ertEqual(info.ro
-0001c8e0: 7461 7465 732c 2064 6174 6574 696d 652e  tates, datetime.
-0001c8f0: 6461 7465 7469 6d65 2832 3032 332c 2031  datetime(2023, 1
-0001c900: 2c20 392c 2031 342c 2031 302c 2030 2c20  , 9, 14, 10, 0, 
-0001c910: 747a 696e 666f 3d75 7463 2929 0a0a 2020  tzinfo=utc))..  
-0001c920: 2020 2020 2020 696e 666f 203d 206d 6f64        info = mod
-0001c930: 656c 2e53 6563 7265 7449 6e66 6f2e 6672  el.SecretInfo.fr
-0001c940: 6f6d 5f64 6963 7428 2773 6563 7265 743a  om_dict('secret:
-0001c950: 3427 2c20 7b0a 2020 2020 2020 2020 2020  4', {.          
-0001c960: 2020 276c 6162 656c 273a 2027 6672 6f6d    'label': 'from
-0001c970: 6469 6374 272c 0a20 2020 2020 2020 2020  dict',.         
-0001c980: 2020 2027 7265 7669 7369 6f6e 273a 2038     'revision': 8
-0001c990: 2c0a 2020 2020 2020 2020 2020 2020 2772  ,.            'r
-0001c9a0: 6f74 6174 696f 6e27 3a20 2762 6164 7661  otation': 'badva
-0001c9b0: 6c75 6527 2c0a 2020 2020 2020 2020 7d29  lue',.        })
-0001c9c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001c9d0: 7365 7274 4571 7561 6c28 696e 666f 2e69  sertEqual(info.i
-0001c9e0: 642c 2027 7365 6372 6574 3a34 2729 0a20  d, 'secret:4'). 
-0001c9f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001ca00: 7274 4571 7561 6c28 696e 666f 2e6c 6162  rtEqual(info.lab
-0001ca10: 656c 2c20 2766 726f 6d64 6963 7427 290a  el, 'fromdict').
-0001ca20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ca30: 6572 7445 7175 616c 2869 6e66 6f2e 7265  ertEqual(info.re
-0001ca40: 7669 7369 6f6e 2c20 3829 0a20 2020 2020  vision, 8).     
-0001ca50: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001ca60: 4e6f 6e65 2869 6e66 6f2e 6578 7069 7265  None(info.expire
-0001ca70: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-0001ca80: 6173 7365 7274 4973 4e6f 6e65 2869 6e66  assertIsNone(inf
-0001ca90: 6f2e 726f 7461 7469 6f6e 290a 2020 2020  o.rotation).    
-0001caa0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0001cab0: 734e 6f6e 6528 696e 666f 2e72 6f74 6174  sNone(info.rotat
-0001cac0: 6573 290a 0a20 2020 2020 2020 2069 6e66  es)..        inf
-0001cad0: 6f20 3d20 6d6f 6465 6c2e 5365 6372 6574  o = model.Secret
-0001cae0: 496e 666f 2e66 726f 6d5f 6469 6374 2827  Info.from_dict('
-0001caf0: 3527 2c20 7b27 7265 7669 7369 6f6e 273a  5', {'revision':
-0001cb00: 2039 7d29 0a20 2020 2020 2020 2073 656c   9}).        sel
-0001cb10: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-0001cb20: 666f 2e69 642c 2027 7365 6372 6574 3a35  fo.id, 'secret:5
-0001cb30: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001cb40: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-0001cb50: 2e72 6576 6973 696f 6e2c 2039 290a 0a0a  .revision, 9)...
-0001cb60: 636c 6173 7320 5465 7374 5365 6372 6574  class TestSecret
-0001cb70: 436c 6173 7328 756e 6974 7465 7374 2e54  Class(unittest.T
-0001cb80: 6573 7443 6173 6529 3a0a 2020 2020 6d61  estCase):.    ma
-0001cb90: 7844 6966 6620 3d20 3634 202a 2031 3032  xDiff = 64 * 102
-0001cba0: 340a 0a20 2020 2064 6566 2073 6574 5570  4..    def setUp
-0001cbb0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001cbc0: 7365 6c66 2e6d 6f64 656c 203d 206f 7073  self.model = ops
-0001cbd0: 2e6d 6f64 656c 2e4d 6f64 656c 286f 7073  .model.Model(ops
-0001cbe0: 2e63 6861 726d 2e43 6861 726d 4d65 7461  .charm.CharmMeta
-0001cbf0: 2829 2c20 6f70 732e 6d6f 6465 6c2e 5f4d  (), ops.model._M
-0001cc00: 6f64 656c 4261 636b 656e 6428 276d 7961  odelBackend('mya
-0001cc10: 7070 2f30 2729 290a 0a20 2020 2064 6566  pp/0'))..    def
-0001cc20: 206d 616b 655f 7365 6372 6574 2873 656c   make_secret(sel
-0001cc30: 662c 2069 643d 4e6f 6e65 2c20 6c61 6265  f, id=None, labe
-0001cc40: 6c3d 4e6f 6e65 2c20 636f 6e74 656e 743d  l=None, content=
-0001cc50: 4e6f 6e65 293a 0a20 2020 2020 2020 2072  None):.        r
-0001cc60: 6574 7572 6e20 6d6f 6465 6c2e 5365 6372  eturn model.Secr
-0001cc70: 6574 2873 656c 662e 6d6f 6465 6c2e 5f62  et(self.model._b
-0001cc80: 6163 6b65 6e64 2c20 6964 3d69 642c 206c  ackend, id=id, l
-0001cc90: 6162 656c 3d6c 6162 656c 2c20 636f 6e74  abel=label, cont
-0001cca0: 656e 743d 636f 6e74 656e 7429 0a0a 2020  ent=content)..  
-0001ccb0: 2020 6465 6620 7465 7374 5f69 645f 616e    def test_id_an
-0001ccc0: 645f 6c61 6265 6c28 7365 6c66 293a 0a20  d_label(self):. 
-0001ccd0: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-0001cce0: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
-0001ccf0: 2869 643d 2720 6162 6320 272c 206c 6162  (id=' abc ', lab
-0001cd00: 656c 3d27 6c62 6c27 290a 2020 2020 2020  el='lbl').      
-0001cd10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001cd20: 616c 2873 6563 7265 742e 6964 2c20 2773  al(secret.id, 's
-0001cd30: 6563 7265 743a 6162 6327 290a 2020 2020  ecret:abc').    
-0001cd40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001cd50: 7175 616c 2873 6563 7265 742e 6c61 6265  qual(secret.labe
-0001cd60: 6c2c 2027 6c62 6c27 290a 0a20 2020 2020  l, 'lbl')..     
-0001cd70: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001cd80: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
-0001cd90: 2778 2729 0a20 2020 2020 2020 2073 656c  'x').        sel
-0001cda0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001cdb0: 6372 6574 2e69 642c 2027 7365 6372 6574  cret.id, 'secret
-0001cdc0: 3a78 2729 0a20 2020 2020 2020 2073 656c  :x').        sel
-0001cdd0: 662e 6173 7365 7274 4973 4e6f 6e65 2873  f.assertIsNone(s
-0001cde0: 6563 7265 742e 6c61 6265 6c29 0a0a 2020  ecret.label)..  
-0001cdf0: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001ce00: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
-0001ce10: 6c61 6265 6c3d 2779 2729 0a20 2020 2020  label='y').     
-0001ce20: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001ce30: 4e6f 6e65 2873 6563 7265 742e 6964 290a  None(secret.id).
-0001ce40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ce50: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
-0001ce60: 6c61 6265 6c2c 2027 7927 290a 0a20 2020  label, 'y')..   
-0001ce70: 2064 6566 2074 6573 745f 6765 745f 636f   def test_get_co
-0001ce80: 6e74 656e 745f 6361 6368 6564 2873 656c  ntent_cached(sel
-0001ce90: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-0001cea0: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-0001ceb0: 6563 7265 742d 6765 7427 2c20 2222 2265  ecret-get', """e
-0001cec0: 7869 7420 3122 2222 290a 0a20 2020 2020  xit 1""")..     
-0001ced0: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001cee0: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
-0001cef0: 2778 272c 206c 6162 656c 3d27 7927 2c20  'x', label='y', 
-0001cf00: 636f 6e74 656e 743d 7b27 666f 6f27 3a20  content={'foo': 
-0001cf10: 2762 6172 277d 290a 2020 2020 2020 2020  'bar'}).        
-0001cf20: 636f 6e74 656e 7420 3d20 7365 6372 6574  content = secret
-0001cf30: 2e67 6574 5f63 6f6e 7465 6e74 2829 2020  .get_content()  
-0001cf40: 2320 7769 6c6c 2075 7365 2063 6163 6865  # will use cache
-0001cf50: 6420 636f 6e74 656e 742c 206e 6f74 2072  d content, not r
-0001cf60: 756e 2073 6563 7265 742d 6765 740a 2020  un secret-get.  
-0001cf70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001cf80: 7445 7175 616c 2863 6f6e 7465 6e74 2c20  tEqual(content, 
-0001cf90: 7b27 666f 6f27 3a20 2762 6172 277d 290a  {'foo': 'bar'}).
-0001cfa0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001cfb0: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001cfc0: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001cfd0: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
-0001cfe0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001cff0: 5f67 6574 5f63 6f6e 7465 6e74 5f72 6566  _get_content_ref
-0001d000: 7265 7368 2873 656c 6629 3a0a 2020 2020  resh(self):.    
-0001d010: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-0001d020: 7365 6c66 2c20 2773 6563 7265 742d 6765  self, 'secret-ge
-0001d030: 7427 2c20 2222 2265 6368 6f20 277b 2266  t', """echo '{"f
-0001d040: 6f6f 223a 2022 7265 6672 6573 6865 6422  oo": "refreshed"
-0001d050: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
-0001d060: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
-0001d070: 6b65 5f73 6563 7265 7428 6964 3d27 7927  ke_secret(id='y'
-0001d080: 2c20 636f 6e74 656e 743d 7b27 666f 6f27  , content={'foo'
-0001d090: 3a20 2762 6172 277d 290a 2020 2020 2020  : 'bar'}).      
-0001d0a0: 2020 636f 6e74 656e 7420 3d20 7365 6372    content = secr
-0001d0b0: 6574 2e67 6574 5f63 6f6e 7465 6e74 2872  et.get_content(r
-0001d0c0: 6566 7265 7368 3d54 7275 6529 0a20 2020  efresh=True).   
-0001d0d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d0e0: 4571 7561 6c28 636f 6e74 656e 742c 207b  Equal(content, {
-0001d0f0: 2766 6f6f 273a 2027 7265 6672 6573 6865  'foo': 'refreshe
-0001d100: 6427 7d29 0a0a 2020 2020 2020 2020 7365  d'})..        se
-0001d110: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-0001d120: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-0001d130: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-0001d140: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0001d150: 2020 2020 2020 2020 2020 2020 205b 5b27               [['
-0001d160: 7365 6372 6574 2d67 6574 272c 2027 7365  secret-get', 'se
-0001d170: 6372 6574 3a79 272c 2027 2d2d 7265 6672  cret:y', '--refr
-0001d180: 6573 6827 2c20 272d 2d66 6f72 6d61 743d  esh', '--format=
-0001d190: 6a73 6f6e 275d 5d29 0a0a 2020 2020 6465  json']])..    de
-0001d1a0: 6620 7465 7374 5f67 6574 5f63 6f6e 7465  f test_get_conte
-0001d1b0: 6e74 5f75 6e63 6163 6865 6428 7365 6c66  nt_uncached(self
-0001d1c0: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
-0001d1d0: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
-0001d1e0: 6372 6574 2d67 6574 272c 2022 2222 6563  cret-get', """ec
-0001d1f0: 686f 2027 7b22 666f 6f22 3a20 226e 6f74  ho '{"foo": "not
-0001d200: 6361 6368 6564 227d 2722 2222 290a 0a20  cached"}'""").. 
-0001d210: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-0001d220: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
-0001d230: 2869 643d 277a 2729 0a20 2020 2020 2020  (id='z').       
-0001d240: 2063 6f6e 7465 6e74 203d 2073 6563 7265   content = secre
-0001d250: 742e 6765 745f 636f 6e74 656e 7428 290a  t.get_content().
-0001d260: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001d270: 6572 7445 7175 616c 2863 6f6e 7465 6e74  ertEqual(content
-0001d280: 2c20 7b27 666f 6f27 3a20 276e 6f74 6361  , {'foo': 'notca
-0001d290: 6368 6564 277d 290a 0a20 2020 2020 2020  ched'})..       
-0001d2a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d2b0: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-0001d2c0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-0001d2d0: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
-0001d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2f0: 5b5b 2773 6563 7265 742d 6765 7427 2c20  [['secret-get', 
-0001d300: 2773 6563 7265 743a 7a27 2c20 272d 2d66  'secret:z', '--f
-0001d310: 6f72 6d61 743d 6a73 6f6e 275d 5d29 0a0a  ormat=json']])..
-0001d320: 2020 2020 6465 6620 7465 7374 5f70 6565      def test_pee
-0001d330: 6b5f 636f 6e74 656e 7428 7365 6c66 293a  k_content(self):
-0001d340: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-0001d350: 7269 7074 2873 656c 662c 2027 7365 6372  ript(self, 'secr
-0001d360: 6574 2d67 6574 272c 2022 2222 6563 686f  et-get', """echo
-0001d370: 2027 7b22 666f 6f22 3a20 2270 6565 6b65   '{"foo": "peeke
-0001d380: 6422 7d27 2222 2229 0a0a 2020 2020 2020  d"}'""")..      
-0001d390: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
-0001d3a0: 6d61 6b65 5f73 6563 7265 7428 6964 3d27  make_secret(id='
-0001d3b0: 6127 2c20 6c61 6265 6c3d 2762 2729 0a20  a', label='b'). 
-0001d3c0: 2020 2020 2020 2063 6f6e 7465 6e74 203d         content =
-0001d3d0: 2073 6563 7265 742e 7065 656b 5f63 6f6e   secret.peek_con
-0001d3e0: 7465 6e74 2829 0a20 2020 2020 2020 2073  tent().        s
-0001d3f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d400: 636f 6e74 656e 742c 207b 2766 6f6f 273a  content, {'foo':
-0001d410: 2027 7065 656b 6564 277d 290a 0a20 2020   'peeked'})..   
-0001d420: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d430: 4571 7561 6c28 6661 6b65 5f73 6372 6970  Equal(fake_scrip
-0001d440: 745f 6361 6c6c 7328 7365 6c66 2c20 636c  t_calls(self, cl
-0001d450: 6561 723d 5472 7565 292c 0a20 2020 2020  ear=True),.     
-0001d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d470: 2020 2020 5b5b 2773 6563 7265 742d 6765      [['secret-ge
-0001d480: 7427 2c20 2773 6563 7265 743a 6127 2c20  t', 'secret:a', 
-0001d490: 272d 2d6c 6162 656c 272c 2027 6227 2c20  '--label', 'b', 
-0001d4a0: 272d 2d70 6565 6b27 2c20 272d 2d66 6f72  '--peek', '--for
-0001d4b0: 6d61 743d 6a73 6f6e 275d 5d29 0a0a 2020  mat=json']])..  
-0001d4c0: 2020 6465 6620 7465 7374 5f67 6574 5f69    def test_get_i
-0001d4d0: 6e66 6f28 7365 6c66 293a 0a20 2020 2020  nfo(self):.     
-0001d4e0: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001d4f0: 656c 662c 2027 7365 6372 6574 2d69 6e66  elf, 'secret-inf
-0001d500: 6f2d 6765 7427 2c20 2222 2265 6368 6f20  o-get', """echo 
-0001d510: 277b 2278 223a 207b 226c 6162 656c 223a  '{"x": {"label":
-0001d520: 2022 7922 2c20 2272 6576 6973 696f 6e22   "y", "revision"
-0001d530: 3a20 377d 7d27 2222 2229 0a0a 2020 2020  : 7}}'""")..    
-0001d540: 2020 2020 2320 5365 6372 6574 2077 6974      # Secret wit
-0001d550: 6820 4944 206f 6e6c 790a 2020 2020 2020  h ID only.      
-0001d560: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
-0001d570: 6d61 6b65 5f73 6563 7265 7428 6964 3d27  make_secret(id='
-0001d580: 7827 290a 2020 2020 2020 2020 696e 666f  x').        info
-0001d590: 203d 2073 6563 7265 742e 6765 745f 696e   = secret.get_in
-0001d5a0: 666f 2829 0a20 2020 2020 2020 2073 656c  fo().        sel
-0001d5b0: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-0001d5c0: 666f 2e69 642c 2027 7365 6372 6574 3a78  fo.id, 'secret:x
-0001d5d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001d5e0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-0001d5f0: 2e6c 6162 656c 2c20 2779 2729 0a20 2020  .label, 'y').   
-0001d600: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d610: 4571 7561 6c28 696e 666f 2e72 6576 6973  Equal(info.revis
-0001d620: 696f 6e2c 2037 290a 0a20 2020 2020 2020  ion, 7)..       
-0001d630: 2023 2053 6563 7265 7420 7769 7468 206c   # Secret with l
-0001d640: 6162 656c 206f 6e6c 790a 2020 2020 2020  abel only.      
-0001d650: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
-0001d660: 6d61 6b65 5f73 6563 7265 7428 6c61 6265  make_secret(labe
-0001d670: 6c3d 2779 2729 0a20 2020 2020 2020 2069  l='y').        i
-0001d680: 6e66 6f20 3d20 7365 6372 6574 2e67 6574  nfo = secret.get
-0001d690: 5f69 6e66 6f28 290a 2020 2020 2020 2020  _info().        
-0001d6a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001d6b0: 2869 6e66 6f2e 6964 2c20 2773 6563 7265  (info.id, 'secre
-0001d6c0: 743a 7827 290a 2020 2020 2020 2020 7365  t:x').        se
-0001d6d0: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-0001d6e0: 6e66 6f2e 6c61 6265 6c2c 2027 7927 290a  nfo.label, 'y').
-0001d6f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001d700: 6572 7445 7175 616c 2869 6e66 6f2e 7265  ertEqual(info.re
-0001d710: 7669 7369 6f6e 2c20 3729 0a0a 2020 2020  vision, 7)..    
-0001d720: 2020 2020 2320 5365 6372 6574 2077 6974      # Secret wit
-0001d730: 6820 4944 2061 6e64 206c 6162 656c 0a20  h ID and label. 
-0001d740: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-0001d750: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
-0001d760: 2869 643d 2778 272c 206c 6162 656c 3d27  (id='x', label='
-0001d770: 7927 290a 2020 2020 2020 2020 696e 666f  y').        info
-0001d780: 203d 2073 6563 7265 742e 6765 745f 696e   = secret.get_in
-0001d790: 666f 2829 0a20 2020 2020 2020 2073 656c  fo().        sel
-0001d7a0: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-0001d7b0: 666f 2e69 642c 2027 7365 6372 6574 3a78  fo.id, 'secret:x
-0001d7c0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001d7d0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-0001d7e0: 2e6c 6162 656c 2c20 2779 2729 0a20 2020  .label, 'y').   
-0001d7f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001d800: 4571 7561 6c28 696e 666f 2e72 6576 6973  Equal(info.revis
-0001d810: 696f 6e2c 2037 290a 0a20 2020 2020 2020  ion, 7)..       
-0001d820: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d830: 6c28 0a20 2020 2020 2020 2020 2020 2066  l(.            f
-0001d840: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-0001d850: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-0001d860: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0001d870: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0001d880: 2020 5b27 7365 6372 6574 2d69 6e66 6f2d    ['secret-info-
-0001d890: 6765 7427 2c20 2773 6563 7265 743a 7827  get', 'secret:x'
-0001d8a0: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
-0001d8b0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0001d8c0: 2020 2020 5b27 7365 6372 6574 2d69 6e66      ['secret-inf
-0001d8d0: 6f2d 6765 7427 2c20 272d 2d6c 6162 656c  o-get', '--label
-0001d8e0: 272c 2027 7927 2c20 272d 2d66 6f72 6d61  ', 'y', '--forma
-0001d8f0: 743d 6a73 6f6e 275d 2c0a 2020 2020 2020  t=json'],.      
-0001d900: 2020 2020 2020 2020 2020 5b27 7365 6372            ['secr
-0001d910: 6574 2d69 6e66 6f2d 6765 7427 2c20 2773  et-info-get', 's
-0001d920: 6563 7265 743a 7827 2c20 272d 2d66 6f72  ecret:x', '--for
-0001d930: 6d61 743d 6a73 6f6e 275d 2c0a 2020 2020  mat=json'],.    
-0001d940: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-0001d950: 6465 6620 7465 7374 5f73 6574 5f63 6f6e  def test_set_con
-0001d960: 7465 6e74 2873 656c 6629 3a0a 2020 2020  tent(self):.    
-0001d970: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
-0001d980: 7365 6c66 2c20 2773 6563 7265 742d 7365  self, 'secret-se
-0001d990: 7427 2c20 2222 2265 7869 7420 3022 2222  t', """exit 0"""
-0001d9a0: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
-0001d9b0: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
-0001d9c0: 7265 742d 696e 666f 2d67 6574 272c 2022  ret-info-get', "
-0001d9d0: 2222 6563 686f 2027 7b22 7a22 3a20 7b22  ""echo '{"z": {"
-0001d9e0: 6c61 6265 6c22 3a20 2279 222c 2022 7265  label": "y", "re
-0001d9f0: 7669 7369 6f6e 223a 2037 7d7d 2722 2222  vision": 7}}'"""
-0001da00: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0001da10: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
-0001da20: 6372 6574 2869 643d 2778 2729 0a20 2020  cret(id='x').   
-0001da30: 2020 2020 2073 6563 7265 742e 7365 745f       secret.set_
-0001da40: 636f 6e74 656e 7428 7b27 666f 6f27 3a20  content({'foo': 
-0001da50: 2762 6172 277d 290a 0a20 2020 2020 2020  'bar'})..       
-0001da60: 2023 2049 6620 7365 6372 6574 2064 6f65   # If secret doe
-0001da70: 736e 2774 2068 6176 6520 616e 2049 442c  sn't have an ID,
-0001da80: 2077 6527 6c6c 2072 756e 2073 6563 7265   we'll run secre
-0001da90: 742d 696e 666f 2d67 6574 2074 6f20 6665  t-info-get to fe
-0001daa0: 7463 6820 6974 0a20 2020 2020 2020 2073  tch it.        s
-0001dab0: 6563 7265 7420 3d20 7365 6c66 2e6d 616b  ecret = self.mak
-0001dac0: 655f 7365 6372 6574 286c 6162 656c 3d27  e_secret(label='
-0001dad0: 7927 290a 2020 2020 2020 2020 7365 6c66  y').        self
-0001dae0: 2e61 7373 6572 7449 734e 6f6e 6528 7365  .assertIsNone(se
-0001daf0: 6372 6574 2e69 6429 0a20 2020 2020 2020  cret.id).       
-0001db00: 2073 6563 7265 742e 7365 745f 636f 6e74   secret.set_cont
-0001db10: 656e 7428 7b27 6261 7227 3a20 2766 6f6f  ent({'bar': 'foo
-0001db20: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-0001db30: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
-0001db40: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
-0001db50: 7a27 290a 0a20 2020 2020 2020 2077 6974  z')..        wit
-0001db60: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0001db70: 7365 7328 5661 6c75 6545 7272 6f72 293a  ses(ValueError):
-0001db80: 0a20 2020 2020 2020 2020 2020 2073 6563  .            sec
-0001db90: 7265 742e 7365 745f 636f 6e74 656e 7428  ret.set_content(
-0001dba0: 7b27 7327 3a20 2774 277d 2920 2023 2065  {'s': 't'})  # e
-0001dbb0: 6e73 7572 6520 6974 2076 616c 6964 6174  nsure it validat
-0001dbc0: 6573 2063 6f6e 7465 6e74 2028 6b65 7920  es content (key 
-0001dbd0: 746f 6f20 7368 6f72 7429 0a0a 2020 2020  too short)..    
-0001dbe0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001dbf0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
-0001dc00: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
-0001dc10: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
-0001dc20: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
-0001dc30: 2d73 6574 272c 2027 7365 6372 6574 3a78  -set', 'secret:x
-0001dc40: 272c 2027 666f 6f3d 6261 7227 5d2c 0a20  ', 'foo=bar'],. 
-0001dc50: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
-0001dc60: 7265 742d 696e 666f 2d67 6574 272c 2027  ret-info-get', '
-0001dc70: 2d2d 6c61 6265 6c27 2c20 2779 272c 2027  --label', 'y', '
-0001dc80: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d2c  --format=json'],
-0001dc90: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
-0001dca0: 6563 7265 742d 7365 7427 2c20 2773 6563  ecret-set', 'sec
-0001dcb0: 7265 743a 7a27 2c20 2762 6172 3d66 6f6f  ret:z', 'bar=foo
-0001dcc0: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
-0001dcd0: 2020 2020 6465 6620 7465 7374 5f73 6574      def test_set
-0001dce0: 5f69 6e66 6f28 7365 6c66 293a 0a20 2020  _info(self):.   
-0001dcf0: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001dd00: 2873 656c 662c 2027 7365 6372 6574 2d73  (self, 'secret-s
-0001dd10: 6574 272c 2022 2222 6578 6974 2030 2222  et', """exit 0""
-0001dd20: 2229 0a20 2020 2020 2020 2066 616b 655f  ").        fake_
-0001dd30: 7363 7269 7074 2873 656c 662c 2027 7365  script(self, 'se
-0001dd40: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
-0001dd50: 2222 2265 6368 6f20 277b 227a 223a 207b  """echo '{"z": {
-0001dd60: 226c 6162 656c 223a 2022 7922 2c20 2272  "label": "y", "r
-0001dd70: 6576 6973 696f 6e22 3a20 377d 7d27 2222  evision": 7}}'""
-0001dd80: 2229 0a0a 2020 2020 2020 2020 7365 6372  ")..        secr
-0001dd90: 6574 203d 2073 656c 662e 6d61 6b65 5f73  et = self.make_s
-0001dda0: 6563 7265 7428 6964 3d27 7827 290a 2020  ecret(id='x').  
-0001ddb0: 2020 2020 2020 6578 7069 7265 203d 2064        expire = d
-0001ddc0: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
-0001ddd0: 2832 3032 322c 2031 322c 2039 2c20 3136  (2022, 12, 9, 16
-0001dde0: 2c20 3539 2c20 3029 0a20 2020 2020 2020  , 59, 0).       
-0001ddf0: 2073 6563 7265 742e 7365 745f 696e 666f   secret.set_info
-0001de00: 280a 2020 2020 2020 2020 2020 2020 6c61  (.            la
-0001de10: 6265 6c3d 276c 6162 272c 0a20 2020 2020  bel='lab',.     
-0001de20: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-0001de30: 6f6e 3d27 6465 7363 272c 0a20 2020 2020  on='desc',.     
-0001de40: 2020 2020 2020 2065 7870 6972 653d 6578         expire=ex
-0001de50: 7069 7265 2c0a 2020 2020 2020 2020 2020  pire,.          
-0001de60: 2020 726f 7461 7465 3d6d 6f64 656c 2e53    rotate=model.S
-0001de70: 6563 7265 7452 6f74 6174 652e 4d4f 4e54  ecretRotate.MONT
-0001de80: 484c 592c 0a20 2020 2020 2020 2029 0a0a  HLY,.        )..
-0001de90: 2020 2020 2020 2020 2320 4966 2073 6563          # If sec
-0001dea0: 7265 7420 646f 6573 6e27 7420 6861 7665  ret doesn't have
-0001deb0: 2061 6e20 4944 2c20 7765 276c 6c20 7275   an ID, we'll ru
-0001dec0: 6e20 7365 6372 6574 2d69 6e66 6f2d 6765  n secret-info-ge
-0001ded0: 7420 746f 2066 6574 6368 2069 740a 2020  t to fetch it.  
-0001dee0: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001def0: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
-0001df00: 6c61 6265 6c3d 2779 2729 0a20 2020 2020  label='y').     
-0001df10: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001df20: 4e6f 6e65 2873 6563 7265 742e 6964 290a  None(secret.id).
-0001df30: 2020 2020 2020 2020 7365 6372 6574 2e73          secret.s
-0001df40: 6574 5f69 6e66 6f28 6c61 6265 6c3d 276c  et_info(label='l
-0001df50: 626c 2729 0a20 2020 2020 2020 2073 656c  bl').        sel
-0001df60: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001df70: 6372 6574 2e69 642c 2027 7365 6372 6574  cret.id, 'secret
-0001df80: 3a7a 2729 0a0a 2020 2020 2020 2020 7365  :z')..        se
-0001df90: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-0001dfa0: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-0001dfb0: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-0001dfc0: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
-0001dfd0: 2020 5b27 7365 6372 6574 2d73 6574 272c    ['secret-set',
-0001dfe0: 2027 7365 6372 6574 3a78 272c 2027 2d2d   'secret:x', '--
-0001dff0: 6c61 6265 6c27 2c20 276c 6162 272c 2027  label', 'lab', '
-0001e000: 2d2d 6465 7363 7269 7074 696f 6e27 2c20  --description', 
-0001e010: 2764 6573 6327 2c0a 2020 2020 2020 2020  'desc',.        
-0001e020: 2020 2020 2027 2d2d 6578 7069 7265 272c       '--expire',
-0001e030: 2027 3230 3232 2d31 322d 3039 5431 363a   '2022-12-09T16:
-0001e040: 3539 3a30 3027 2c20 272d 2d72 6f74 6174  59:00', '--rotat
-0001e050: 6527 2c20 276d 6f6e 7468 6c79 275d 2c0a  e', 'monthly'],.
-0001e060: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
-0001e070: 6372 6574 2d69 6e66 6f2d 6765 7427 2c20  cret-info-get', 
-0001e080: 272d 2d6c 6162 656c 272c 2027 7927 2c20  '--label', 'y', 
-0001e090: 272d 2d66 6f72 6d61 743d 6a73 6f6e 275d  '--format=json']
-0001e0a0: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
-0001e0b0: 7365 6372 6574 2d73 6574 272c 2027 7365  secret-set', 'se
-0001e0c0: 6372 6574 3a7a 272c 2027 2d2d 6c61 6265  cret:z', '--labe
-0001e0d0: 6c27 2c20 276c 626c 275d 2c0a 2020 2020  l', 'lbl'],.    
-0001e0e0: 2020 2020 5d29 0a0a 2020 2020 2020 2020      ])..        
-0001e0f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0001e100: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
-0001e110: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-0001e120: 6563 7265 742e 7365 745f 696e 666f 2829  ecret.set_info()
-0001e130: 2020 2320 6e6f 2061 7267 7320 7072 6f76    # no args prov
-0001e140: 6964 6564 0a0a 2020 2020 6465 6620 7465  ided..    def te
-0001e150: 7374 5f67 7261 6e74 2873 656c 6629 3a0a  st_grant(self):.
-0001e160: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-0001e170: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
-0001e180: 742d 6772 616e 7427 2c20 2222 2265 7869  t-grant', """exi
-0001e190: 7420 3022 2222 290a 2020 2020 2020 2020  t 0""").        
-0001e1a0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-0001e1b0: 2c20 2773 6563 7265 742d 696e 666f 2d67  , 'secret-info-g
-0001e1c0: 6574 272c 2022 2222 6563 686f 2027 7b22  et', """echo '{"
-0001e1d0: 7a22 3a20 7b22 6c61 6265 6c22 3a20 2279  z": {"label": "y
-0001e1e0: 222c 2022 7265 7669 7369 6f6e 223a 2037  ", "revision": 7
-0001e1f0: 7d7d 2722 2222 290a 0a20 2020 2020 2020  }}'""")..       
-0001e200: 2073 6563 7265 7420 3d20 7365 6c66 2e6d   secret = self.m
-0001e210: 616b 655f 7365 6372 6574 2869 643d 2778  ake_secret(id='x
-0001e220: 2729 0a20 2020 2020 2020 2073 6563 7265  ').        secre
-0001e230: 742e 6772 616e 7428 7479 7065 732e 5369  t.grant(types.Si
-0001e240: 6d70 6c65 4e61 6d65 7370 6163 6528 6964  mpleNamespace(id
-0001e250: 3d31 3233 2929 0a20 2020 2020 2020 2073  =123)).        s
-0001e260: 6563 7265 742e 6772 616e 7428 7479 7065  ecret.grant(type
-0001e270: 732e 5369 6d70 6c65 4e61 6d65 7370 6163  s.SimpleNamespac
-0001e280: 6528 6964 3d32 3334 292c 2075 6e69 743d  e(id=234), unit=
-0001e290: 7479 7065 732e 5369 6d70 6c65 4e61 6d65  types.SimpleName
-0001e2a0: 7370 6163 6528 6e61 6d65 3d27 6170 702f  space(name='app/
-0001e2b0: 3027 2929 0a0a 2020 2020 2020 2020 2320  0'))..        # 
-0001e2c0: 4966 2073 6563 7265 7420 646f 6573 6e27  If secret doesn'
-0001e2d0: 7420 6861 7665 2061 6e20 4944 2c20 7765  t have an ID, we
-0001e2e0: 276c 6c20 7275 6e20 7365 6372 6574 2d69  'll run secret-i
-0001e2f0: 6e66 6f2d 6765 7420 746f 2066 6574 6368  nfo-get to fetch
-0001e300: 2069 740a 2020 2020 2020 2020 7365 6372   it.        secr
-0001e310: 6574 203d 2073 656c 662e 6d61 6b65 5f73  et = self.make_s
-0001e320: 6563 7265 7428 6c61 6265 6c3d 2779 2729  ecret(label='y')
-0001e330: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001e340: 7365 7274 4973 4e6f 6e65 2873 6563 7265  sertIsNone(secre
-0001e350: 742e 6964 290a 2020 2020 2020 2020 7365  t.id).        se
-0001e360: 6372 6574 2e67 7261 6e74 2874 7970 6573  cret.grant(types
-0001e370: 2e53 696d 706c 654e 616d 6573 7061 6365  .SimpleNamespace
-0001e380: 2869 643d 3334 3529 290a 2020 2020 2020  (id=345)).      
-0001e390: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001e3a0: 616c 2873 6563 7265 742e 6964 2c20 2773  al(secret.id, 's
-0001e3b0: 6563 7265 743a 7a27 290a 0a20 2020 2020  ecret:z')..     
-0001e3c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001e3d0: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
-0001e3e0: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
-0001e3f0: 723d 5472 7565 292c 205b 0a20 2020 2020  r=True), [.     
-0001e400: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
-0001e410: 6772 616e 7427 2c20 2773 6563 7265 743a  grant', 'secret:
-0001e420: 7827 2c20 272d 2d72 656c 6174 696f 6e27  x', '--relation'
-0001e430: 2c20 2731 3233 275d 2c0a 2020 2020 2020  , '123'],.      
-0001e440: 2020 2020 2020 5b27 7365 6372 6574 2d67        ['secret-g
-0001e450: 7261 6e74 272c 2027 7365 6372 6574 3a78  rant', 'secret:x
-0001e460: 272c 2027 2d2d 7265 6c61 7469 6f6e 272c  ', '--relation',
-0001e470: 2027 3233 3427 2c20 272d 2d75 6e69 7427   '234', '--unit'
-0001e480: 2c20 2761 7070 2f30 275d 2c0a 2020 2020  , 'app/0'],.    
-0001e490: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
-0001e4a0: 2d69 6e66 6f2d 6765 7427 2c20 272d 2d6c  -info-get', '--l
-0001e4b0: 6162 656c 272c 2027 7927 2c20 272d 2d66  abel', 'y', '--f
-0001e4c0: 6f72 6d61 743d 6a73 6f6e 275d 2c0a 2020  ormat=json'],.  
-0001e4d0: 2020 2020 2020 2020 2020 5b27 7365 6372            ['secr
-0001e4e0: 6574 2d67 7261 6e74 272c 2027 7365 6372  et-grant', 'secr
-0001e4f0: 6574 3a7a 272c 2027 2d2d 7265 6c61 7469  et:z', '--relati
-0001e500: 6f6e 272c 2027 3334 3527 5d2c 0a20 2020  on', '345'],.   
-0001e510: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-0001e520: 2074 6573 745f 7265 766f 6b65 2873 656c   test_revoke(sel
-0001e530: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
-0001e540: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
-0001e550: 6563 7265 742d 7265 766f 6b65 272c 2022  ecret-revoke', "
-0001e560: 2222 6578 6974 2030 2222 2229 0a20 2020  ""exit 0""").   
-0001e570: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001e580: 2873 656c 662c 2027 7365 6372 6574 2d69  (self, 'secret-i
-0001e590: 6e66 6f2d 6765 7427 2c20 2222 2265 6368  nfo-get', """ech
-0001e5a0: 6f20 277b 227a 223a 207b 226c 6162 656c  o '{"z": {"label
-0001e5b0: 223a 2022 7922 2c20 2272 6576 6973 696f  ": "y", "revisio
-0001e5c0: 6e22 3a20 377d 7d27 2222 2229 0a0a 2020  n": 7}}'""")..  
-0001e5d0: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
-0001e5e0: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
-0001e5f0: 6964 3d27 7827 290a 2020 2020 2020 2020  id='x').        
-0001e600: 7365 6372 6574 2e72 6576 6f6b 6528 7479  secret.revoke(ty
-0001e610: 7065 732e 5369 6d70 6c65 4e61 6d65 7370  pes.SimpleNamesp
-0001e620: 6163 6528 6964 3d31 3233 2929 0a20 2020  ace(id=123)).   
-0001e630: 2020 2020 2073 6563 7265 742e 7265 766f       secret.revo
-0001e640: 6b65 2874 7970 6573 2e53 696d 706c 654e  ke(types.SimpleN
-0001e650: 616d 6573 7061 6365 2869 643d 3233 3429  amespace(id=234)
-0001e660: 2c20 756e 6974 3d74 7970 6573 2e53 696d  , unit=types.Sim
-0001e670: 706c 654e 616d 6573 7061 6365 286e 616d  pleNamespace(nam
-0001e680: 653d 2761 7070 2f30 2729 290a 0a20 2020  e='app/0'))..   
-0001e690: 2020 2020 2023 2049 6620 7365 6372 6574       # If secret
-0001e6a0: 2064 6f65 736e 2774 2068 6176 6520 616e   doesn't have an
-0001e6b0: 2049 442c 2077 6527 6c6c 2072 756e 2073   ID, we'll run s
-0001e6c0: 6563 7265 742d 696e 666f 2d67 6574 2074  ecret-info-get t
-0001e6d0: 6f20 6665 7463 6820 6974 0a20 2020 2020  o fetch it.     
-0001e6e0: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
-0001e6f0: 2e6d 616b 655f 7365 6372 6574 286c 6162  .make_secret(lab
-0001e700: 656c 3d27 7927 290a 2020 2020 2020 2020  el='y').        
-0001e710: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
-0001e720: 6528 7365 6372 6574 2e69 6429 0a20 2020  e(secret.id).   
-0001e730: 2020 2020 2073 6563 7265 742e 7265 766f       secret.revo
-0001e740: 6b65 2874 7970 6573 2e53 696d 706c 654e  ke(types.SimpleN
-0001e750: 616d 6573 7061 6365 2869 643d 3334 3529  amespace(id=345)
-0001e760: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001e770: 7373 6572 7445 7175 616c 2873 6563 7265  ssertEqual(secre
-0001e780: 742e 6964 2c20 2773 6563 7265 743a 7a27  t.id, 'secret:z'
-0001e790: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001e7a0: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
-0001e7b0: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
-0001e7c0: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
-0001e7d0: 205b 0a20 2020 2020 2020 2020 2020 205b   [.            [
-0001e7e0: 2773 6563 7265 742d 7265 766f 6b65 272c  'secret-revoke',
-0001e7f0: 2027 7365 6372 6574 3a78 272c 2027 2d2d   'secret:x', '--
-0001e800: 7265 6c61 7469 6f6e 272c 2027 3132 3327  relation', '123'
-0001e810: 5d2c 0a20 2020 2020 2020 2020 2020 205b  ],.            [
-0001e820: 2773 6563 7265 742d 7265 766f 6b65 272c  'secret-revoke',
-0001e830: 2027 7365 6372 6574 3a78 272c 2027 2d2d   'secret:x', '--
-0001e840: 7265 6c61 7469 6f6e 272c 2027 3233 3427  relation', '234'
-0001e850: 2c20 272d 2d75 6e69 7427 2c20 2761 7070  , '--unit', 'app
-0001e860: 2f30 275d 2c0a 2020 2020 2020 2020 2020  /0'],.          
-0001e870: 2020 5b27 7365 6372 6574 2d69 6e66 6f2d    ['secret-info-
-0001e880: 6765 7427 2c20 272d 2d6c 6162 656c 272c  get', '--label',
-0001e890: 2027 7927 2c20 272d 2d66 6f72 6d61 743d   'y', '--format=
-0001e8a0: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
-0001e8b0: 2020 2020 5b27 7365 6372 6574 2d72 6576      ['secret-rev
-0001e8c0: 6f6b 6527 2c20 2773 6563 7265 743a 7a27  oke', 'secret:z'
-0001e8d0: 2c20 272d 2d72 656c 6174 696f 6e27 2c20  , '--relation', 
-0001e8e0: 2733 3435 275d 2c0a 2020 2020 2020 2020  '345'],.        
-0001e8f0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001e900: 5f72 656d 6f76 655f 7265 7669 7369 6f6e  _remove_revision
-0001e910: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001e920: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
-0001e930: 2c20 2773 6563 7265 742d 7265 6d6f 7665  , 'secret-remove
-0001e940: 272c 2022 2222 6578 6974 2030 2222 2229  ', """exit 0""")
-0001e950: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
-0001e960: 7269 7074 2873 656c 662c 2027 7365 6372  ript(self, 'secr
-0001e970: 6574 2d69 6e66 6f2d 6765 7427 2c20 2222  et-info-get', ""
-0001e980: 2265 6368 6f20 277b 227a 223a 207b 226c  "echo '{"z": {"l
-0001e990: 6162 656c 223a 2022 7922 2c20 2272 6576  abel": "y", "rev
-0001e9a0: 6973 696f 6e22 3a20 377d 7d27 2222 2229  ision": 7}}'""")
-0001e9b0: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-0001e9c0: 203d 2073 656c 662e 6d61 6b65 5f73 6563   = self.make_sec
-0001e9d0: 7265 7428 6964 3d27 7827 290a 2020 2020  ret(id='x').    
-0001e9e0: 2020 2020 7365 6372 6574 2e72 656d 6f76      secret.remov
-0001e9f0: 655f 7265 7669 7369 6f6e 2831 3233 290a  e_revision(123).
-0001ea00: 0a20 2020 2020 2020 2023 2049 6620 7365  .        # If se
-0001ea10: 6372 6574 2064 6f65 736e 2774 2068 6176  cret doesn't hav
-0001ea20: 6520 616e 2049 442c 2077 6527 6c6c 2072  e an ID, we'll r
-0001ea30: 756e 2073 6563 7265 742d 696e 666f 2d67  un secret-info-g
-0001ea40: 6574 2074 6f20 6665 7463 6820 6974 0a20  et to fetch it. 
-0001ea50: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-0001ea60: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
-0001ea70: 286c 6162 656c 3d27 7927 290a 2020 2020  (label='y').    
-0001ea80: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0001ea90: 734e 6f6e 6528 7365 6372 6574 2e69 6429  sNone(secret.id)
-0001eaa0: 0a20 2020 2020 2020 2073 6563 7265 742e  .        secret.
-0001eab0: 7265 6d6f 7665 5f72 6576 6973 696f 6e28  remove_revision(
-0001eac0: 3233 3429 0a20 2020 2020 2020 2073 656c  234).        sel
-0001ead0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001eae0: 6372 6574 2e69 642c 2027 7365 6372 6574  cret.id, 'secret
-0001eaf0: 3a7a 2729 0a0a 2020 2020 2020 2020 7365  :z')..        se
-0001eb00: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-0001eb10: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-0001eb20: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-0001eb30: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
-0001eb40: 2020 5b27 7365 6372 6574 2d72 656d 6f76    ['secret-remov
-0001eb50: 6527 2c20 2773 6563 7265 743a 7827 2c20  e', 'secret:x', 
-0001eb60: 272d 2d72 6576 6973 696f 6e27 2c20 2731  '--revision', '1
-0001eb70: 3233 275d 2c0a 2020 2020 2020 2020 2020  23'],.          
-0001eb80: 2020 5b27 7365 6372 6574 2d69 6e66 6f2d    ['secret-info-
-0001eb90: 6765 7427 2c20 272d 2d6c 6162 656c 272c  get', '--label',
-0001eba0: 2027 7927 2c20 272d 2d66 6f72 6d61 743d   'y', '--format=
-0001ebb0: 6a73 6f6e 275d 2c0a 2020 2020 2020 2020  json'],.        
-0001ebc0: 2020 2020 5b27 7365 6372 6574 2d72 656d      ['secret-rem
-0001ebd0: 6f76 6527 2c20 2773 6563 7265 743a 7a27  ove', 'secret:z'
-0001ebe0: 2c20 272d 2d72 6576 6973 696f 6e27 2c20  , '--revision', 
-0001ebf0: 2732 3334 275d 2c0a 2020 2020 2020 2020  '234'],.        
-0001ec00: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001ec10: 5f72 656d 6f76 655f 616c 6c5f 7265 7669  _remove_all_revi
-0001ec20: 7369 6f6e 7328 7365 6c66 293a 0a20 2020  sions(self):.   
-0001ec30: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
-0001ec40: 2873 656c 662c 2027 7365 6372 6574 2d72  (self, 'secret-r
-0001ec50: 656d 6f76 6527 2c20 2222 2265 7869 7420  emove', """exit 
-0001ec60: 3022 2222 290a 2020 2020 2020 2020 6661  0""").        fa
-0001ec70: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
-0001ec80: 2773 6563 7265 742d 696e 666f 2d67 6574  'secret-info-get
-0001ec90: 272c 2022 2222 6563 686f 2027 7b22 7a22  ', """echo '{"z"
-0001eca0: 3a20 7b22 6c61 6265 6c22 3a20 2279 222c  : {"label": "y",
-0001ecb0: 2022 7265 7669 7369 6f6e 223a 2037 7d7d   "revision": 7}}
-0001ecc0: 2722 2222 290a 0a20 2020 2020 2020 2073  '""")..        s
-0001ecd0: 6563 7265 7420 3d20 7365 6c66 2e6d 616b  ecret = self.mak
-0001ece0: 655f 7365 6372 6574 2869 643d 2778 2729  e_secret(id='x')
-0001ecf0: 0a20 2020 2020 2020 2073 6563 7265 742e  .        secret.
-0001ed00: 7265 6d6f 7665 5f61 6c6c 5f72 6576 6973  remove_all_revis
-0001ed10: 696f 6e73 2829 0a0a 2020 2020 2020 2020  ions()..        
-0001ed20: 2320 4966 2073 6563 7265 7420 646f 6573  # If secret does
-0001ed30: 6e27 7420 6861 7665 2061 6e20 4944 2c20  n't have an ID, 
-0001ed40: 7765 276c 6c20 7275 6e20 7365 6372 6574  we'll run secret
-0001ed50: 2d69 6e66 6f2d 6765 7420 746f 2066 6574  -info-get to fet
-0001ed60: 6368 2069 740a 2020 2020 2020 2020 7365  ch it.        se
-0001ed70: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
-0001ed80: 5f73 6563 7265 7428 6c61 6265 6c3d 2779  _secret(label='y
-0001ed90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001eda0: 6173 7365 7274 4973 4e6f 6e65 2873 6563  assertIsNone(sec
-0001edb0: 7265 742e 6964 290a 2020 2020 2020 2020  ret.id).        
-0001edc0: 7365 6372 6574 2e72 656d 6f76 655f 616c  secret.remove_al
-0001edd0: 6c5f 7265 7669 7369 6f6e 7328 290a 2020  l_revisions().  
-0001ede0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001edf0: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
-0001ee00: 2c20 2773 6563 7265 743a 7a27 290a 0a20  , 'secret:z').. 
-0001ee10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001ee20: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
-0001ee30: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
-0001ee40: 636c 6561 723d 5472 7565 292c 205b 0a20  clear=True), [. 
-0001ee50: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
-0001ee60: 7265 742d 7265 6d6f 7665 272c 2027 7365  ret-remove', 'se
-0001ee70: 6372 6574 3a78 275d 2c0a 2020 2020 2020  cret:x'],.      
-0001ee80: 2020 2020 2020 5b27 7365 6372 6574 2d69        ['secret-i
-0001ee90: 6e66 6f2d 6765 7427 2c20 272d 2d6c 6162  nfo-get', '--lab
-0001eea0: 656c 272c 2027 7927 2c20 272d 2d66 6f72  el', 'y', '--for
-0001eeb0: 6d61 743d 6a73 6f6e 275d 2c0a 2020 2020  mat=json'],.    
-0001eec0: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
-0001eed0: 2d72 656d 6f76 6527 2c20 2773 6563 7265  -remove', 'secre
-0001eee0: 743a 7a27 5d2c 0a20 2020 2020 2020 205d  t:z'],.        ]
-0001eef0: 290a 0a0a 636c 6173 7320 5465 7374 506f  )...class TestPo
-0001ef00: 7274 7328 756e 6974 7465 7374 2e54 6573  rts(unittest.Tes
-0001ef10: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
-0001ef20: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
-0001ef30: 2020 2020 2073 656c 662e 6d6f 6465 6c20       self.model 
-0001ef40: 3d20 6f70 732e 6d6f 6465 6c2e 4d6f 6465  = ops.model.Mode
-0001ef50: 6c28 6f70 732e 6368 6172 6d2e 4368 6172  l(ops.charm.Char
-0001ef60: 6d4d 6574 6128 292c 206f 7073 2e6d 6f64  mMeta(), ops.mod
-0001ef70: 656c 2e5f 4d6f 6465 6c42 6163 6b65 6e64  el._ModelBackend
-0001ef80: 2827 6d79 6170 702f 3027 2929 0a20 2020  ('myapp/0')).   
-0001ef90: 2020 2020 2073 656c 662e 756e 6974 203d       self.unit =
-0001efa0: 2073 656c 662e 6d6f 6465 6c2e 756e 6974   self.model.unit
-0001efb0: 0a0a 2020 2020 6465 6620 7465 7374 5f6f  ..    def test_o
-0001efc0: 7065 6e5f 706f 7274 2873 656c 6629 3a0a  pen_port(self):.
-0001efd0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
-0001efe0: 6970 7428 7365 6c66 2c20 276f 7065 6e2d  ipt(self, 'open-
-0001eff0: 706f 7274 272c 2027 6578 6974 2030 2729  port', 'exit 0')
-0001f000: 0a0a 2020 2020 2020 2020 7365 6c66 2e75  ..        self.u
-0001f010: 6e69 742e 6f70 656e 5f70 6f72 7428 2774  nit.open_port('t
-0001f020: 6370 272c 2038 3038 3029 0a20 2020 2020  cp', 8080).     
-0001f030: 2020 2073 656c 662e 756e 6974 2e6f 7065     self.unit.ope
-0001f040: 6e5f 706f 7274 2827 5544 5027 2c20 3430  n_port('UDP', 40
-0001f050: 3030 290a 2020 2020 2020 2020 7365 6c66  00).        self
-0001f060: 2e75 6e69 742e 6f70 656e 5f70 6f72 7428  .unit.open_port(
-0001f070: 2769 636d 7027 290a 0a20 2020 2020 2020  'icmp')..       
-0001f080: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001f090: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
-0001f0a0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
-0001f0b0: 5472 7565 292c 205b 0a20 2020 2020 2020  True), [.       
-0001f0c0: 2020 2020 205b 276f 7065 6e2d 706f 7274       ['open-port
-0001f0d0: 272c 2027 3830 3830 2f74 6370 275d 2c0a  ', '8080/tcp'],.
-0001f0e0: 2020 2020 2020 2020 2020 2020 5b27 6f70              ['op
-0001f0f0: 656e 2d70 6f72 7427 2c20 2734 3030 302f  en-port', '4000/
-0001f100: 7564 7027 5d2c 0a20 2020 2020 2020 2020  udp'],.         
-0001f110: 2020 205b 276f 7065 6e2d 706f 7274 272c     ['open-port',
-0001f120: 2027 6963 6d70 275d 2c0a 2020 2020 2020   'icmp'],.      
-0001f130: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0001f140: 7374 5f6f 7065 6e5f 706f 7274 5f65 7272  st_open_port_err
-0001f150: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
-0001f160: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001f170: 6c66 2c20 276f 7065 6e2d 706f 7274 272c  lf, 'open-port',
-0001f180: 2022 6563 686f 2027 4552 524f 5220 6261   "echo 'ERROR ba
-0001f190: 6420 7072 6f74 6f63 6f6c 2720 3e26 323b  d protocol' >&2;
-0001f1a0: 2065 7869 7420 3122 290a 0a20 2020 2020   exit 1")..     
-0001f1b0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0001f1c0: 6572 7452 6169 7365 7328 6d6f 6465 6c2e  ertRaises(model.
-0001f1d0: 4d6f 6465 6c45 7272 6f72 2920 6173 2063  ModelError) as c
-0001f1e0: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-0001f1f0: 656c 662e 756e 6974 2e6f 7065 6e5f 706f  elf.unit.open_po
-0001f200: 7274 2827 6674 7027 2c20 3830 3830 290a  rt('ftp', 8080).
-0001f210: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001f220: 6572 7445 7175 616c 2873 7472 2863 6d2e  ertEqual(str(cm.
-0001f230: 6578 6365 7074 696f 6e29 2c20 2745 5252  exception), 'ERR
-0001f240: 4f52 2062 6164 2070 726f 746f 636f 6c5c  OR bad protocol\
-0001f250: 6e27 290a 0a20 2020 2020 2020 2073 656c  n')..        sel
-0001f260: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
-0001f270: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
-0001f280: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
-0001f290: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-0001f2a0: 205b 276f 7065 6e2d 706f 7274 272c 2027   ['open-port', '
-0001f2b0: 3830 3830 2f66 7470 275d 2c0a 2020 2020  8080/ftp'],.    
-0001f2c0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0001f2d0: 7465 7374 5f63 6c6f 7365 5f70 6f72 7428  test_close_port(
-0001f2e0: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0001f2f0: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
-0001f300: 2027 636c 6f73 652d 706f 7274 272c 2027   'close-port', '
-0001f310: 6578 6974 2030 2729 0a0a 2020 2020 2020  exit 0')..      
-0001f320: 2020 7365 6c66 2e75 6e69 742e 636c 6f73    self.unit.clos
-0001f330: 655f 706f 7274 2827 7463 7027 2c20 3830  e_port('tcp', 80
-0001f340: 3830 290a 2020 2020 2020 2020 7365 6c66  80).        self
-0001f350: 2e75 6e69 742e 636c 6f73 655f 706f 7274  .unit.close_port
-0001f360: 2827 5544 5027 2c20 3430 3030 290a 2020  ('UDP', 4000).  
-0001f370: 2020 2020 2020 7365 6c66 2e75 6e69 742e        self.unit.
-0001f380: 636c 6f73 655f 706f 7274 2827 6963 6d70  close_port('icmp
-0001f390: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-0001f3a0: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
-0001f3b0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
-0001f3c0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
-0001f3d0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0001f3e0: 5b27 636c 6f73 652d 706f 7274 272c 2027  ['close-port', '
-0001f3f0: 3830 3830 2f74 6370 275d 2c0a 2020 2020  8080/tcp'],.    
-0001f400: 2020 2020 2020 2020 5b27 636c 6f73 652d          ['close-
-0001f410: 706f 7274 272c 2027 3430 3030 2f75 6470  port', '4000/udp
-0001f420: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0001f430: 5b27 636c 6f73 652d 706f 7274 272c 2027  ['close-port', '
-0001f440: 6963 6d70 275d 2c0a 2020 2020 2020 2020  icmp'],.        
-0001f450: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001f460: 5f63 6c6f 7365 5f70 6f72 745f 6572 726f  _close_port_erro
-0001f470: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-0001f480: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
-0001f490: 662c 2027 636c 6f73 652d 706f 7274 272c  f, 'close-port',
-0001f4a0: 2022 6563 686f 2027 4552 524f 5220 6261   "echo 'ERROR ba
-0001f4b0: 6420 7072 6f74 6f63 6f6c 2720 3e26 323b  d protocol' >&2;
-0001f4c0: 2065 7869 7420 3122 290a 0a20 2020 2020   exit 1")..     
-0001f4d0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0001f4e0: 6572 7452 6169 7365 7328 6d6f 6465 6c2e  ertRaises(model.
-0001f4f0: 4d6f 6465 6c45 7272 6f72 2920 6173 2063  ModelError) as c
-0001f500: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-0001f510: 656c 662e 756e 6974 2e63 6c6f 7365 5f70  elf.unit.close_p
-0001f520: 6f72 7428 2766 7470 272c 2038 3038 3029  ort('ftp', 8080)
-0001f530: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001f540: 7365 7274 4571 7561 6c28 7374 7228 636d  sertEqual(str(cm
-0001f550: 2e65 7863 6570 7469 6f6e 292c 2027 4552  .exception), 'ER
-0001f560: 524f 5220 6261 6420 7072 6f74 6f63 6f6c  ROR bad protocol
-0001f570: 5c6e 2729 0a0a 2020 2020 2020 2020 7365  \n')..        se
-0001f580: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
-0001f590: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
-0001f5a0: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
-0001f5b0: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
-0001f5c0: 2020 5b27 636c 6f73 652d 706f 7274 272c    ['close-port',
-0001f5d0: 2027 3830 3830 2f66 7470 275d 2c0a 2020   '8080/ftp'],.  
-0001f5e0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
-0001f5f0: 6620 7465 7374 5f6f 7065 6e65 645f 706f  f test_opened_po
-0001f600: 7274 7328 7365 6c66 293a 0a20 2020 2020  rts(self):.     
-0001f610: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
-0001f620: 656c 662c 2027 6f70 656e 6564 2d70 6f72  elf, 'opened-por
-0001f630: 7473 272c 2022 2222 6563 686f 2038 3038  ts', """echo 808
-0001f640: 302f 7463 703b 2065 6368 6f20 6963 6d70  0/tcp; echo icmp
-0001f650: 2222 2229 0a0a 2020 2020 2020 2020 706f  """)..        po
-0001f660: 7274 735f 7365 7420 3d20 7365 6c66 2e75  rts_set = self.u
-0001f670: 6e69 742e 6f70 656e 6564 5f70 6f72 7473  nit.opened_ports
-0001f680: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0001f690: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
-0001f6a0: 2870 6f72 7473 5f73 6574 2c20 7365 7429  (ports_set, set)
-0001f6b0: 0a20 2020 2020 2020 2070 6f72 7473 203d  .        ports =
-0001f6c0: 2073 6f72 7465 6428 706f 7274 735f 7365   sorted(ports_se
-0001f6d0: 742c 206b 6579 3d6c 616d 6264 6120 703a  t, key=lambda p:
-0001f6e0: 2028 702e 7072 6f74 6f63 6f6c 2c20 702e   (p.protocol, p.
-0001f6f0: 706f 7274 2929 0a20 2020 2020 2020 2073  port)).        s
-0001f700: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001f710: 6c65 6e28 706f 7274 7329 2c20 3229 0a20  len(ports), 2). 
-0001f720: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001f730: 7274 4973 496e 7374 616e 6365 2870 6f72  rtIsInstance(por
-0001f740: 7473 5b30 5d2c 206d 6f64 656c 2e4f 7065  ts[0], model.Ope
-0001f750: 6e65 6450 6f72 7429 0a20 2020 2020 2020  nedPort).       
-0001f760: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001f770: 6c28 706f 7274 735b 305d 2e70 726f 746f  l(ports[0].proto
-0001f780: 636f 6c2c 2027 6963 6d70 2729 0a20 2020  col, 'icmp').   
-0001f790: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001f7a0: 4973 4e6f 6e65 2870 6f72 7473 5b30 5d2e  IsNone(ports[0].
-0001f7b0: 706f 7274 290a 2020 2020 2020 2020 7365  port).        se
-0001f7c0: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-0001f7d0: 6e63 6528 706f 7274 735b 315d 2c20 6d6f  nce(ports[1], mo
-0001f7e0: 6465 6c2e 4f70 656e 6564 506f 7274 290a  del.OpenedPort).
-0001f7f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001f800: 6572 7445 7175 616c 2870 6f72 7473 5b31  ertEqual(ports[1
-0001f810: 5d2e 7072 6f74 6f63 6f6c 2c20 2774 6370  ].protocol, 'tcp
-0001f820: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001f830: 6173 7365 7274 4571 7561 6c28 706f 7274  assertEqual(port
-0001f840: 735b 315d 2e70 6f72 742c 2038 3038 3029  s[1].port, 8080)
-0001f850: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0001f860: 7373 6572 7445 7175 616c 2866 616b 655f  ssertEqual(fake_
-0001f870: 7363 7269 7074 5f63 616c 6c73 2873 656c  script_calls(sel
-0001f880: 662c 2063 6c65 6172 3d54 7275 6529 2c20  f, clear=True), 
-0001f890: 5b0a 2020 2020 2020 2020 2020 2020 5b27  [.            ['
-0001f8a0: 6f70 656e 6564 2d70 6f72 7473 272c 2027  opened-ports', '
-0001f8b0: 275d 2c0a 2020 2020 2020 2020 5d29 0a0a  '],.        ])..
-0001f8c0: 2020 2020 6465 6620 7465 7374 5f6f 7065      def test_ope
-0001f8d0: 6e65 645f 706f 7274 735f 7761 726e 696e  ned_ports_warnin
-0001f8e0: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
-0001f8f0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
-0001f900: 6c66 2c20 276f 7065 6e65 642d 706f 7274  lf, 'opened-port
-0001f910: 7327 2c20 2222 2265 6368 6f20 3830 3830  s', """echo 8080
-0001f920: 2f74 6370 3b20 6563 686f 2031 3233 342f  /tcp; echo 1234/
-0001f930: 6674 703b 2065 6368 6f20 3130 3030 2d32  ftp; echo 1000-2
-0001f940: 3030 302f 7564 7022 2222 290a 0a20 2020  000/udp""")..   
-0001f950: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0001f960: 7373 6572 744c 6f67 7328 276f 7073 2e6d  ssertLogs('ops.m
-0001f970: 6f64 656c 272c 206c 6576 656c 3d27 5741  odel', level='WA
-0001f980: 524e 494e 4727 2920 6173 2063 6d3a 0a20  RNING') as cm:. 
-0001f990: 2020 2020 2020 2020 2020 2070 6f72 7473             ports
-0001f9a0: 5f73 6574 203d 2073 656c 662e 756e 6974  _set = self.unit
-0001f9b0: 2e6f 7065 6e65 645f 706f 7274 7328 290a  .opened_ports().
-0001f9c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001f9d0: 6572 7445 7175 616c 286c 656e 2863 6d2e  ertEqual(len(cm.
-0001f9e0: 6f75 7470 7574 292c 2032 290a 2020 2020  output), 2).    
-0001f9f0: 2020 2020 7365 6c66 2e61 7373 6572 7452      self.assertR
-0001fa00: 6567 6578 2863 6d2e 6f75 7470 7574 5b30  egex(cm.output[0
-0001fa10: 5d2c 2072 2757 4152 4e49 4e47 3a6f 7073  ], r'WARNING:ops
-0001fa20: 2e6d 6f64 656c 3a2e 2a70 726f 746f 636f  .model:.*protoco
-0001fa30: 6c2e 2a27 290a 2020 2020 2020 2020 7365  l.*').        se
-0001fa40: 6c66 2e61 7373 6572 7452 6567 6578 2863  lf.assertRegex(c
-0001fa50: 6d2e 6f75 7470 7574 5b31 5d2c 2072 2757  m.output[1], r'W
-0001fa60: 4152 4e49 4e47 3a6f 7073 2e6d 6f64 656c  ARNING:ops.model
-0001fa70: 3a2e 2a72 616e 6765 2e2a 2729 0a0a 2020  :.*range.*')..  
-0001fa80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001fa90: 7449 7349 6e73 7461 6e63 6528 706f 7274  tIsInstance(port
-0001faa0: 735f 7365 742c 2073 6574 290a 2020 2020  s_set, set).    
-0001fab0: 2020 2020 706f 7274 7320 3d20 736f 7274      ports = sort
-0001fac0: 6564 2870 6f72 7473 5f73 6574 2c20 6b65  ed(ports_set, ke
-0001fad0: 793d 6c61 6d62 6461 2070 3a20 2870 2e70  y=lambda p: (p.p
-0001fae0: 726f 746f 636f 6c2c 2070 2e70 6f72 7429  rotocol, p.port)
-0001faf0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001fb00: 7373 6572 7445 7175 616c 286c 656e 2870  ssertEqual(len(p
-0001fb10: 6f72 7473 292c 2032 290a 2020 2020 2020  orts), 2).      
-0001fb20: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0001fb30: 6e73 7461 6e63 6528 706f 7274 735b 305d  nstance(ports[0]
-0001fb40: 2c20 6d6f 6465 6c2e 4f70 656e 6564 506f  , model.OpenedPo
-0001fb50: 7274 290a 2020 2020 2020 2020 7365 6c66  rt).        self
-0001fb60: 2e61 7373 6572 7445 7175 616c 2870 6f72  .assertEqual(por
-0001fb70: 7473 5b30 5d2e 7072 6f74 6f63 6f6c 2c20  ts[0].protocol, 
-0001fb80: 2774 6370 2729 0a20 2020 2020 2020 2073  'tcp').        s
-0001fb90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001fba0: 706f 7274 735b 305d 2e70 6f72 742c 2038  ports[0].port, 8
-0001fbb0: 3038 3029 0a20 2020 2020 2020 2073 656c  080).        sel
-0001fbc0: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
-0001fbd0: 6365 2870 6f72 7473 5b31 5d2c 206d 6f64  ce(ports[1], mod
-0001fbe0: 656c 2e4f 7065 6e65 6450 6f72 7429 0a20  el.OpenedPort). 
-0001fbf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001fc00: 7274 4571 7561 6c28 706f 7274 735b 315d  rtEqual(ports[1]
-0001fc10: 2e70 726f 746f 636f 6c2c 2027 7564 7027  .protocol, 'udp'
-0001fc20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001fc30: 7373 6572 7445 7175 616c 2870 6f72 7473  ssertEqual(ports
-0001fc40: 5b31 5d2e 706f 7274 2c20 3130 3030 290a  [1].port, 1000).
-0001fc50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001fc60: 7365 7274 4571 7561 6c28 6661 6b65 5f73  sertEqual(fake_s
-0001fc70: 6372 6970 745f 6361 6c6c 7328 7365 6c66  cript_calls(self
-0001fc80: 2c20 636c 6561 723d 5472 7565 292c 205b  , clear=True), [
-0001fc90: 0a20 2020 2020 2020 2020 2020 205b 276f  .            ['o
-0001fca0: 7065 6e65 642d 706f 7274 7327 2c20 2727  pened-ports', ''
-0001fcb0: 5d2c 0a20 2020 2020 2020 205d 290a 0a0a  ],.        ])...
-0001fcc0: 6966 205f 5f6e 616d 655f 5f20 3d3d 2022  if __name__ == "
-0001fcd0: 5f5f 6d61 696e 5f5f 223a 0a20 2020 2075  __main__":.    u
-0001fce0: 6e69 7474 6573 742e 6d61 696e 2829 0a    nittest.main().
+0001a650: 6c6f 6164 6564 2c20 5b31 2c20 315d 290a  loaded, [1, 1]).
+0001a660: 0a0a 636c 6173 7320 5465 7374 5365 6372  ..class TestSecr
+0001a670: 6574 7328 756e 6974 7465 7374 2e54 6573  ets(unittest.Tes
+0001a680: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
+0001a690: 7365 7455 7028 7365 6c66 293a 0a20 2020  setUp(self):.   
+0001a6a0: 2020 2020 2073 656c 662e 6d6f 6465 6c20       self.model 
+0001a6b0: 3d20 6f70 732e 4d6f 6465 6c28 6f70 732e  = ops.Model(ops.
+0001a6c0: 4368 6172 6d4d 6574 6128 292c 205f 4d6f  CharmMeta(), _Mo
+0001a6d0: 6465 6c42 6163 6b65 6e64 2827 6d79 6170  delBackend('myap
+0001a6e0: 702f 3027 2929 0a20 2020 2020 2020 2073  p/0')).        s
+0001a6f0: 656c 662e 6170 7020 3d20 7365 6c66 2e6d  elf.app = self.m
+0001a700: 6f64 656c 2e61 7070 0a20 2020 2020 2020  odel.app.       
+0001a710: 2073 656c 662e 756e 6974 203d 2073 656c   self.unit = sel
+0001a720: 662e 6d6f 6465 6c2e 756e 6974 0a0a 2020  f.model.unit..  
+0001a730: 2020 6465 6620 7465 7374 5f61 7070 5f61    def test_app_a
+0001a740: 6464 5f73 6563 7265 745f 7369 6d70 6c65  dd_secret_simple
+0001a750: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001a760: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001a770: 2c20 2773 6563 7265 742d 6164 6427 2c20  , 'secret-add', 
+0001a780: 2765 6368 6f20 7365 6372 6574 3a31 3233  'echo secret:123
+0001a790: 2729 0a0a 2020 2020 2020 2020 7365 6372  ')..        secr
+0001a7a0: 6574 203d 2073 656c 662e 6170 702e 6164  et = self.app.ad
+0001a7b0: 645f 7365 6372 6574 287b 2766 6f6f 273a  d_secret({'foo':
+0001a7c0: 2027 7827 7d29 0a20 2020 2020 2020 2073   'x'}).        s
+0001a7d0: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0001a7e0: 616e 6365 2873 6563 7265 742c 206f 7073  ance(secret, ops
+0001a7f0: 2e53 6563 7265 7429 0a20 2020 2020 2020  .Secret).       
+0001a800: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001a810: 6c28 7365 6372 6574 2e69 642c 2027 7365  l(secret.id, 'se
+0001a820: 6372 6574 3a31 3233 2729 0a20 2020 2020  cret:123').     
+0001a830: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001a840: 4e6f 6e65 2873 6563 7265 742e 6c61 6265  None(secret.labe
+0001a850: 6c29 0a0a 2020 2020 2020 2020 7365 6c66  l)..        self
+0001a860: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+0001a870: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+0001a880: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+0001a890: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a8a0: 2020 2020 2020 2020 2020 205b 5b27 7365             [['se
+0001a8b0: 6372 6574 2d61 6464 272c 2027 2d2d 6f77  cret-add', '--ow
+0001a8c0: 6e65 7227 2c20 2761 7070 6c69 6361 7469  ner', 'applicati
+0001a8d0: 6f6e 272c 2027 666f 6f3d 7827 5d5d 290a  on', 'foo=x']]).
+0001a8e0: 0a20 2020 2064 6566 2074 6573 745f 6170  .    def test_ap
+0001a8f0: 705f 6164 645f 7365 6372 6574 5f61 7267  p_add_secret_arg
+0001a900: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001a910: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+0001a920: 662c 2027 7365 6372 6574 2d61 6464 272c  f, 'secret-add',
+0001a930: 2027 6563 686f 2073 6563 7265 743a 3233   'echo secret:23
+0001a940: 3427 290a 0a20 2020 2020 2020 2065 7870  4')..        exp
+0001a950: 6972 6520 3d20 6461 7465 7469 6d65 2e64  ire = datetime.d
+0001a960: 6174 6574 696d 6528 3230 3232 2c20 3132  atetime(2022, 12
+0001a970: 2c20 392c 2031 362c 2031 372c 2030 290a  , 9, 16, 17, 0).
+0001a980: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001a990: 2073 656c 662e 6170 702e 6164 645f 7365   self.app.add_se
+0001a9a0: 6372 6574 287b 2766 6f6f 273a 2027 7827  cret({'foo': 'x'
+0001a9b0: 2c20 2762 6172 273a 2027 7927 7d2c 206c  , 'bar': 'y'}, l
+0001a9c0: 6162 656c 3d27 6c62 6c27 2c20 6465 7363  abel='lbl', desc
+0001a9d0: 7269 7074 696f 6e3d 2764 6573 6327 2c0a  ription='desc',.
+0001a9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa00: 2020 2020 2065 7870 6972 653d 6578 7069       expire=expi
+0001aa10: 7265 2c20 726f 7461 7465 3d6f 7073 2e53  re, rotate=ops.S
+0001aa20: 6563 7265 7452 6f74 6174 652e 484f 5552  ecretRotate.HOUR
+0001aa30: 4c59 290a 2020 2020 2020 2020 7365 6c66  LY).        self
+0001aa40: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0001aa50: 7265 742e 6964 2c20 2773 6563 7265 743a  ret.id, 'secret:
+0001aa60: 3233 3427 290a 2020 2020 2020 2020 7365  234').        se
+0001aa70: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001aa80: 6563 7265 742e 6c61 6265 6c2c 2027 6c62  ecret.label, 'lb
+0001aa90: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+0001aaa0: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0001aab0: 7265 742e 6765 745f 636f 6e74 656e 7428  ret.get_content(
+0001aac0: 292c 207b 2766 6f6f 273a 2027 7827 2c20  ), {'foo': 'x', 
+0001aad0: 2762 6172 273a 2027 7927 7d29 0a0a 2020  'bar': 'y'})..  
+0001aae0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001aaf0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+0001ab00: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+0001ab10: 6c65 6172 3d54 7275 6529 2c0a 2020 2020  lear=True),.    
+0001ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab30: 2020 2020 205b 5b27 7365 6372 6574 2d61       [['secret-a
+0001ab40: 6464 272c 2027 2d2d 6c61 6265 6c27 2c20  dd', '--label', 
+0001ab50: 276c 626c 272c 2027 2d2d 6465 7363 7269  'lbl', '--descri
+0001ab60: 7074 696f 6e27 2c20 2764 6573 6327 2c0a  ption', 'desc',.
+0001ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab80: 2020 2020 2020 2020 2020 2027 2d2d 6578             '--ex
+0001ab90: 7069 7265 272c 2027 3230 3232 2d31 322d  pire', '2022-12-
+0001aba0: 3039 5431 363a 3137 3a30 3027 2c20 272d  09T16:17:00', '-
+0001abb0: 2d72 6f74 6174 6527 2c20 2768 6f75 726c  -rotate', 'hourl
+0001abc0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+0001abd0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001abe0: 2d2d 6f77 6e65 7227 2c20 2761 7070 6c69  --owner', 'appli
+0001abf0: 6361 7469 6f6e 272c 2027 666f 6f3d 7827  cation', 'foo=x'
+0001ac00: 2c20 2762 6172 3d79 275d 5d29 0a0a 2020  , 'bar=y']])..  
+0001ac10: 2020 6465 6620 7465 7374 5f75 6e69 745f    def test_unit_
+0001ac20: 6164 645f 7365 6372 6574 5f73 696d 706c  add_secret_simpl
+0001ac30: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0001ac40: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+0001ac50: 662c 2027 7365 6372 6574 2d61 6464 272c  f, 'secret-add',
+0001ac60: 2027 6563 686f 2073 6563 7265 743a 3334   'echo secret:34
+0001ac70: 3527 290a 0a20 2020 2020 2020 2073 6563  5')..        sec
+0001ac80: 7265 7420 3d20 7365 6c66 2e75 6e69 742e  ret = self.unit.
+0001ac90: 6164 645f 7365 6372 6574 287b 2766 6f6f  add_secret({'foo
+0001aca0: 273a 2027 7827 7d29 0a20 2020 2020 2020  ': 'x'}).       
+0001acb0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+0001acc0: 7374 616e 6365 2873 6563 7265 742c 206f  stance(secret, o
+0001acd0: 7073 2e53 6563 7265 7429 0a20 2020 2020  ps.Secret).     
+0001ace0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001acf0: 7561 6c28 7365 6372 6574 2e69 642c 2027  ual(secret.id, '
+0001ad00: 7365 6372 6574 3a33 3435 2729 0a20 2020  secret:345').   
+0001ad10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001ad20: 4973 4e6f 6e65 2873 6563 7265 742e 6c61  IsNone(secret.la
+0001ad30: 6265 6c29 0a0a 2020 2020 2020 2020 7365  bel)..        se
+0001ad40: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+0001ad50: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+0001ad60: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
+0001ad70: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0001ad80: 2020 2020 2020 2020 2020 2020 205b 5b27               [['
+0001ad90: 7365 6372 6574 2d61 6464 272c 2027 2d2d  secret-add', '--
+0001ada0: 6f77 6e65 7227 2c20 2775 6e69 7427 2c20  owner', 'unit', 
+0001adb0: 2766 6f6f 3d78 275d 5d29 0a0a 2020 2020  'foo=x']])..    
+0001adc0: 6465 6620 7465 7374 5f75 6e69 745f 6164  def test_unit_ad
+0001add0: 645f 7365 6372 6574 5f61 7267 7328 7365  d_secret_args(se
+0001ade0: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
+0001adf0: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+0001ae00: 7365 6372 6574 2d61 6464 272c 2027 6563  secret-add', 'ec
+0001ae10: 686f 2073 6563 7265 743a 3435 3627 290a  ho secret:456').
+0001ae20: 0a20 2020 2020 2020 2065 7870 6972 6520  .        expire 
+0001ae30: 3d20 6461 7465 7469 6d65 2e64 6174 6574  = datetime.datet
+0001ae40: 696d 6528 3230 3232 2c20 3132 2c20 392c  ime(2022, 12, 9,
+0001ae50: 2031 362c 2032 322c 2030 290a 2020 2020   16, 22, 0).    
+0001ae60: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
+0001ae70: 662e 756e 6974 2e61 6464 5f73 6563 7265  f.unit.add_secre
+0001ae80: 7428 7b27 666f 6f27 3a20 2777 272c 2027  t({'foo': 'w', '
+0001ae90: 6261 7227 3a20 277a 277d 2c20 6c61 6265  bar': 'z'}, labe
+0001aea0: 6c3d 276c 3227 2c20 6465 7363 7269 7074  l='l2', descript
+0001aeb0: 696f 6e3d 2778 797a 272c 0a20 2020 2020  ion='xyz',.     
+0001aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aee0: 2065 7870 6972 653d 6578 7069 7265 2c20   expire=expire, 
+0001aef0: 726f 7461 7465 3d6f 7073 2e53 6563 7265  rotate=ops.Secre
+0001af00: 7452 6f74 6174 652e 5945 4152 4c59 290a  tRotate.YEARLY).
+0001af10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001af20: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
+0001af30: 6964 2c20 2773 6563 7265 743a 3435 3627  id, 'secret:456'
+0001af40: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001af50: 7373 6572 7445 7175 616c 2873 6563 7265  ssertEqual(secre
+0001af60: 742e 6c61 6265 6c2c 2027 6c32 2729 0a20  t.label, 'l2'). 
+0001af70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001af80: 7274 4571 7561 6c28 7365 6372 6574 2e67  rtEqual(secret.g
+0001af90: 6574 5f63 6f6e 7465 6e74 2829 2c20 7b27  et_content(), {'
+0001afa0: 666f 6f27 3a20 2777 272c 2027 6261 7227  foo': 'w', 'bar'
+0001afb0: 3a20 277a 277d 290a 0a20 2020 2020 2020  : 'z'})..       
+0001afc0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001afd0: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+0001afe0: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+0001aff0: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
+0001b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b010: 5b5b 2773 6563 7265 742d 6164 6427 2c20  [['secret-add', 
+0001b020: 272d 2d6c 6162 656c 272c 2027 6c32 272c  '--label', 'l2',
+0001b030: 2027 2d2d 6465 7363 7269 7074 696f 6e27   '--description'
+0001b040: 2c20 2778 797a 272c 0a20 2020 2020 2020  , 'xyz',.       
+0001b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b060: 2020 2020 272d 2d65 7870 6972 6527 2c20      '--expire', 
+0001b070: 2732 3032 322d 3132 2d30 3954 3136 3a32  '2022-12-09T16:2
+0001b080: 323a 3030 272c 2027 2d2d 726f 7461 7465  2:00', '--rotate
+0001b090: 272c 2027 7965 6172 6c79 272c 0a20 2020  ', 'yearly',.   
+0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0b0: 2020 2020 2020 2020 272d 2d6f 776e 6572          '--owner
+0001b0c0: 272c 2027 756e 6974 272c 2027 666f 6f3d  ', 'unit', 'foo=
+0001b0d0: 7727 2c20 2762 6172 3d7a 275d 5d29 0a0a  w', 'bar=z']])..
+0001b0e0: 2020 2020 6465 6620 7465 7374 5f75 6e69      def test_uni
+0001b0f0: 745f 6164 645f 7365 6372 6574 5f65 7272  t_add_secret_err
+0001b100: 6f72 7328 7365 6c66 293a 0a20 2020 2020  ors(self):.     
+0001b110: 2020 2023 2041 6464 6974 696f 6e61 6c20     # Additional 
+0001b120: 6164 645f 7365 6372 6574 2074 6573 7473  add_secret tests
+0001b130: 2061 7265 2064 6f6e 6520 696e 2054 6573   are done in Tes
+0001b140: 7441 7070 6c69 6361 7469 6f6e 0a20 2020  tApplication.   
+0001b150: 2020 2020 2065 7272 6f72 7320 3d20 5b0a       errors = [.
+0001b160: 2020 2020 2020 2020 2020 2020 287b 2778              ({'x
+0001b170: 7927 3a20 2762 6172 277d 2c20 7b7d 2c20  y': 'bar'}, {}, 
+0001b180: 5661 6c75 6545 7272 6f72 292c 0a20 2020  ValueError),.   
+0001b190: 2020 2020 2020 2020 2028 7b27 666f 6f27           ({'foo'
+0001b1a0: 3a20 2778 277d 2c20 7b27 6578 7069 7265  : 'x'}, {'expire
+0001b1b0: 273a 2037 7d2c 2054 7970 6545 7272 6f72  ': 7}, TypeError
+0001b1c0: 292c 0a20 2020 2020 2020 205d 0a20 2020  ),.        ].   
+0001b1d0: 2020 2020 2066 6f72 2063 6f6e 7465 6e74       for content
+0001b1e0: 2c20 6b77 6172 6773 2c20 6578 635f 7479  , kwargs, exc_ty
+0001b1f0: 7065 2069 6e20 6572 726f 7273 3a0a 2020  pe in errors:.  
+0001b200: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+0001b210: 6627 6578 7065 6374 6564 207b 6578 635f  f'expected {exc_
+0001b220: 7479 7065 2e5f 5f6e 616d 655f 5f7d 2077  type.__name__} w
+0001b230: 6865 6e20 6164 6469 6e67 2073 6563 7265  hen adding secre
+0001b240: 7420 636f 6e74 656e 7420 7b63 6f6e 7465  t content {conte
+0001b250: 6e74 7d27 0a20 2020 2020 2020 2020 2020  nt}'.           
+0001b260: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0001b270: 7452 6169 7365 7328 6578 635f 7479 7065  tRaises(exc_type
+0001b280: 2c20 6d73 673d 6d73 6729 3a0a 2020 2020  , msg=msg):.    
+0001b290: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001b2a0: 2e75 6e69 742e 6164 645f 7365 6372 6574  .unit.add_secret
+0001b2b0: 2863 6f6e 7465 6e74 2c20 2a2a 6b77 6172  (content, **kwar
+0001b2c0: 6773 290a 0a20 2020 2064 6566 2074 6573  gs)..    def tes
+0001b2d0: 745f 6164 645f 7365 6372 6574 5f65 7272  t_add_secret_err
+0001b2e0: 6f72 7328 7365 6c66 293a 0a20 2020 2020  ors(self):.     
+0001b2f0: 2020 2065 7272 6f72 7320 3d20 5b0a 2020     errors = [.  
+0001b300: 2020 2020 2020 2020 2020 2320 496e 7661            # Inva
+0001b310: 6c69 6420 636f 6e74 656e 7420 6469 6374  lid content dict
+0001b320: 206f 7220 7479 7065 730a 2020 2020 2020   or types.      
+0001b330: 2020 2020 2020 284e 6f6e 652c 207b 7d2c        (None, {},
+0001b340: 2054 7970 6545 7272 6f72 292c 0a20 2020   TypeError),.   
+0001b350: 2020 2020 2020 2020 2028 7b7d 2c20 7b7d           ({}, {}
+0001b360: 2c20 5661 6c75 6545 7272 6f72 292c 0a20  , ValueError),. 
+0001b370: 2020 2020 2020 2020 2020 2028 7b62 2766             ({b'f
+0001b380: 6f6f 272c 2027 6261 7227 7d2c 207b 7d2c  oo', 'bar'}, {},
+0001b390: 2054 7970 6545 7272 6f72 292c 0a20 2020   TypeError),.   
+0001b3a0: 2020 2020 2020 2020 2028 7b33 3a20 2762           ({3: 'b
+0001b3b0: 6172 277d 2c20 7b7d 2c20 5479 7065 4572  ar'}, {}, TypeEr
+0001b3c0: 726f 7229 2c0a 2020 2020 2020 2020 2020  ror),.          
+0001b3d0: 2020 287b 2766 6f6f 273a 2031 2c20 2762    ({'foo': 1, 'b
+0001b3e0: 6172 273a 2032 7d2c 207b 7d2c 2054 7970  ar': 2}, {}, Typ
+0001b3f0: 6545 7272 6f72 292c 0a20 2020 2020 2020  eError),.       
+0001b400: 2020 2020 2023 2049 6e76 616c 6964 2063       # Invalid c
+0001b410: 6f6e 7465 6e74 206b 6579 730a 2020 2020  ontent keys.    
+0001b420: 2020 2020 2020 2020 287b 2778 7927 3a20          ({'xy': 
+0001b430: 2762 6172 277d 2c20 7b7d 2c20 5661 6c75  'bar'}, {}, Valu
+0001b440: 6545 7272 6f72 292c 0a20 2020 2020 2020  eError),.       
+0001b450: 2020 2020 2028 7b27 464f 4f27 3a20 2762       ({'FOO': 'b
+0001b460: 6172 277d 2c20 7b7d 2c20 5661 6c75 6545  ar'}, {}, ValueE
+0001b470: 7272 6f72 292c 0a20 2020 2020 2020 2020  rror),.         
+0001b480: 2020 2028 7b27 666f 6f2d 273a 2027 6261     ({'foo-': 'ba
+0001b490: 7227 7d2c 207b 7d2c 2056 616c 7565 4572  r'}, {}, ValueEr
+0001b4a0: 726f 7229 2c0a 2020 2020 2020 2020 2020  ror),.          
+0001b4b0: 2020 287b 272d 666f 6f27 3a20 2762 6172    ({'-foo': 'bar
+0001b4c0: 277d 2c20 7b7d 2c20 5661 6c75 6545 7272  '}, {}, ValueErr
+0001b4d0: 6f72 292c 0a20 2020 2020 2020 2020 2020  or),.           
+0001b4e0: 2023 2049 6e76 616c 6964 2022 6578 7069   # Invalid "expi
+0001b4f0: 7265 2220 7479 7065 0a20 2020 2020 2020  re" type.       
+0001b500: 2020 2020 2028 7b27 666f 6f27 3a20 2778       ({'foo': 'x
+0001b510: 277d 2c20 7b27 6578 7069 7265 273a 2037  '}, {'expire': 7
+0001b520: 7d2c 2054 7970 6545 7272 6f72 292c 0a20  }, TypeError),. 
+0001b530: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0001b540: 2066 6f72 2063 6f6e 7465 6e74 2c20 6b77   for content, kw
+0001b550: 6172 6773 2c20 6578 635f 7479 7065 2069  args, exc_type i
+0001b560: 6e20 6572 726f 7273 3a0a 2020 2020 2020  n errors:.      
+0001b570: 2020 2020 2020 6d73 6720 3d20 6627 6578        msg = f'ex
+0001b580: 7065 6374 6564 207b 6578 635f 7479 7065  pected {exc_type
+0001b590: 2e5f 5f6e 616d 655f 5f7d 2077 6865 6e20  .__name__} when 
+0001b5a0: 6164 6469 6e67 2073 6563 7265 7420 636f  adding secret co
+0001b5b0: 6e74 656e 7420 7b63 6f6e 7465 6e74 7d27  ntent {content}'
+0001b5c0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+0001b5d0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0001b5e0: 7365 7328 6578 635f 7479 7065 2c20 6d73  ses(exc_type, ms
+0001b5f0: 673d 6d73 6729 3a0a 2020 2020 2020 2020  g=msg):.        
+0001b600: 2020 2020 2020 2020 7365 6c66 2e61 7070          self.app
+0001b610: 2e61 6464 5f73 6563 7265 7428 636f 6e74  .add_secret(cont
+0001b620: 656e 742c 202a 2a6b 7761 7267 7329 0a20  ent, **kwargs). 
+0001b630: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+0001b640: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0001b650: 7328 6578 635f 7479 7065 2c20 6d73 673d  s(exc_type, msg=
+0001b660: 6d73 6729 3a0a 2020 2020 2020 2020 2020  msg):.          
+0001b670: 2020 2020 2020 7365 6c66 2e75 6e69 742e        self.unit.
+0001b680: 6164 645f 7365 6372 6574 2863 6f6e 7465  add_secret(conte
+0001b690: 6e74 2c20 2a2a 6b77 6172 6773 290a 0a20  nt, **kwargs).. 
+0001b6a0: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
+0001b6b0: 7365 6372 6574 5f69 6428 7365 6c66 293a  secret_id(self):
+0001b6c0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+0001b6d0: 7269 7074 2873 656c 662c 2027 7365 6372  ript(self, 'secr
+0001b6e0: 6574 2d67 6574 272c 2022 2222 6563 686f  et-get', """echo
+0001b6f0: 2027 7b22 666f 6f22 3a20 2267 227d 2722   '{"foo": "g"}'"
+0001b700: 2222 290a 0a20 2020 2020 2020 2073 6563  "")..        sec
+0001b710: 7265 7420 3d20 7365 6c66 2e6d 6f64 656c  ret = self.model
+0001b720: 2e67 6574 5f73 6563 7265 7428 6964 3d27  .get_secret(id='
+0001b730: 3132 3327 290a 2020 2020 2020 2020 7365  123').        se
+0001b740: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001b750: 6563 7265 742e 6964 2c20 2773 6563 7265  ecret.id, 'secre
+0001b760: 743a 3132 3327 290a 2020 2020 2020 2020  t:123').        
+0001b770: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
+0001b780: 6528 7365 6372 6574 2e6c 6162 656c 290a  e(secret.label).
+0001b790: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001b7a0: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
+0001b7b0: 6765 745f 636f 6e74 656e 7428 292c 207b  get_content(), {
+0001b7c0: 2766 6f6f 273a 2027 6727 7d29 0a0a 2020  'foo': 'g'})..  
+0001b7d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b7e0: 7445 7175 616c 2866 616b 655f 7363 7269  tEqual(fake_scri
+0001b7f0: 7074 5f63 616c 6c73 2873 656c 662c 2063  pt_calls(self, c
+0001b800: 6c65 6172 3d54 7275 6529 2c0a 2020 2020  lear=True),.    
+0001b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b820: 2020 2020 205b 5b27 7365 6372 6574 2d67       [['secret-g
+0001b830: 6574 272c 2027 7365 6372 6574 3a31 3233  et', 'secret:123
+0001b840: 272c 2027 2d2d 666f 726d 6174 3d6a 736f  ', '--format=jso
+0001b850: 6e27 5d5d 290a 0a20 2020 2064 6566 2074  n']])..    def t
+0001b860: 6573 745f 6765 745f 7365 6372 6574 5f6c  est_get_secret_l
+0001b870: 6162 656c 2873 656c 6629 3a0a 2020 2020  abel(self):.    
+0001b880: 2020 2020 6661 6b65 5f73 6372 6970 7428      fake_script(
+0001b890: 7365 6c66 2c20 2773 6563 7265 742d 6765  self, 'secret-ge
+0001b8a0: 7427 2c20 2222 2265 6368 6f20 277b 2266  t', """echo '{"f
+0001b8b0: 6f6f 223a 2022 6722 7d27 2222 2229 0a0a  oo": "g"}'""")..
+0001b8c0: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001b8d0: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+0001b8e0: 7365 6372 6574 286c 6162 656c 3d27 6c62  secret(label='lb
+0001b8f0: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+0001b900: 2e61 7373 6572 7449 734e 6f6e 6528 7365  .assertIsNone(se
+0001b910: 6372 6574 2e69 6429 0a20 2020 2020 2020  cret.id).       
+0001b920: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001b930: 6c28 7365 6372 6574 2e6c 6162 656c 2c20  l(secret.label, 
+0001b940: 276c 626c 2729 0a20 2020 2020 2020 2073  'lbl').        s
+0001b950: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001b960: 7365 6372 6574 2e67 6574 5f63 6f6e 7465  secret.get_conte
+0001b970: 6e74 2829 2c20 7b27 666f 6f27 3a20 2767  nt(), {'foo': 'g
+0001b980: 277d 290a 0a20 2020 2020 2020 2073 656c  '})..        sel
+0001b990: 662e 6173 7365 7274 4571 7561 6c28 6661  f.assertEqual(fa
+0001b9a0: 6b65 5f73 6372 6970 745f 6361 6c6c 7328  ke_script_calls(
+0001b9b0: 7365 6c66 2c20 636c 6561 723d 5472 7565  self, clear=True
+0001b9c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001b9d0: 2020 2020 2020 2020 2020 2020 5b5b 2773              [['s
+0001b9e0: 6563 7265 742d 6765 7427 2c20 272d 2d6c  ecret-get', '--l
+0001b9f0: 6162 656c 272c 2027 6c62 6c27 2c20 272d  abel', 'lbl', '-
+0001ba00: 2d66 6f72 6d61 743d 6a73 6f6e 275d 5d29  -format=json']])
+0001ba10: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+0001ba20: 6574 5f73 6563 7265 745f 6964 5f61 6e64  et_secret_id_and
+0001ba30: 5f6c 6162 656c 2873 656c 6629 3a0a 2020  _label(self):.  
+0001ba40: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+0001ba50: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
+0001ba60: 6765 7427 2c20 2222 2265 6368 6f20 277b  get', """echo '{
+0001ba70: 2266 6f6f 223a 2022 6822 7d27 2222 2229  "foo": "h"}'""")
+0001ba80: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
+0001ba90: 203d 2073 656c 662e 6d6f 6465 6c2e 6765   = self.model.ge
+0001baa0: 745f 7365 6372 6574 2869 643d 2731 3233  t_secret(id='123
+0001bab0: 272c 206c 6162 656c 3d27 6c27 290a 2020  ', label='l').  
+0001bac0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001bad0: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
+0001bae0: 2c20 2773 6563 7265 743a 3132 3327 290a  , 'secret:123').
+0001baf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001bb00: 6572 7445 7175 616c 2873 6563 7265 742e  ertEqual(secret.
+0001bb10: 6c61 6265 6c2c 2027 6c27 290a 2020 2020  label, 'l').    
+0001bb20: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001bb30: 7175 616c 2873 6563 7265 742e 6765 745f  qual(secret.get_
+0001bb40: 636f 6e74 656e 7428 292c 207b 2766 6f6f  content(), {'foo
+0001bb50: 273a 2027 6827 7d29 0a0a 2020 2020 2020  ': 'h'})..      
+0001bb60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001bb70: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+0001bb80: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+0001bb90: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
+0001bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbb0: 205b 5b27 7365 6372 6574 2d67 6574 272c   [['secret-get',
+0001bbc0: 2027 7365 6372 6574 3a31 3233 272c 2027   'secret:123', '
+0001bbd0: 2d2d 6c61 6265 6c27 2c20 276c 272c 2027  --label', 'l', '
+0001bbe0: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d5d  --format=json']]
+0001bbf0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001bc00: 6765 745f 7365 6372 6574 5f6e 6f5f 6172  get_secret_no_ar
+0001bc10: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
+0001bc20: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0001bc30: 7274 5261 6973 6573 2854 7970 6545 7272  rtRaises(TypeErr
+0001bc40: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0001bc50: 2073 656c 662e 6d6f 6465 6c2e 6765 745f   self.model.get_
+0001bc60: 7365 6372 6574 2829 0a0a 2020 2020 6465  secret()..    de
+0001bc70: 6620 7465 7374 5f67 6574 5f73 6563 7265  f test_get_secre
+0001bc80: 745f 6e6f 745f 666f 756e 6428 7365 6c66  t_not_found(self
+0001bc90: 293a 0a20 2020 2020 2020 2073 6372 6970  ):.        scrip
+0001bca0: 7420 3d20 2222 2265 6368 6f20 2745 5252  t = """echo 'ERR
+0001bcb0: 4f52 2073 6563 7265 7420 2231 3233 2220  OR secret "123" 
+0001bcc0: 6e6f 7420 666f 756e 6427 203e 2632 3b20  not found' >&2; 
+0001bcd0: 6578 6974 2031 2222 220a 2020 2020 2020  exit 1""".      
+0001bce0: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+0001bcf0: 6c66 2c20 2773 6563 7265 742d 6765 7427  lf, 'secret-get'
+0001bd00: 2c20 7363 7269 7074 290a 2020 2020 2020  , script).      
+0001bd10: 2020 6661 6b65 5f73 6372 6970 7428 7365    fake_script(se
+0001bd20: 6c66 2c20 2773 6563 7265 742d 696e 666f  lf, 'secret-info
+0001bd30: 2d67 6574 272c 2073 6372 6970 7429 0a0a  -get', script)..
+0001bd40: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0001bd50: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+0001bd60: 7073 2e53 6563 7265 744e 6f74 466f 756e  ps.SecretNotFoun
+0001bd70: 6445 7272 6f72 293a 0a20 2020 2020 2020  dError):.       
+0001bd80: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+0001bd90: 6765 745f 7365 6372 6574 2869 643d 2731  get_secret(id='1
+0001bda0: 3233 2729 0a0a 2020 2020 6465 6620 7465  23')..    def te
+0001bdb0: 7374 5f67 6574 5f73 6563 7265 745f 6f74  st_get_secret_ot
+0001bdc0: 6865 725f 6572 726f 7228 7365 6c66 293a  her_error(self):
+0001bdd0: 0a20 2020 2020 2020 2073 6372 6970 7420  .        script 
+0001bde0: 3d20 2222 2265 6368 6f20 2745 5252 4f52  = """echo 'ERROR
+0001bdf0: 206f 7468 6572 2065 7272 6f72 2720 3e26   other error' >&
+0001be00: 323b 2065 7869 7420 3122 2222 0a20 2020  2; exit 1""".   
+0001be10: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+0001be20: 2873 656c 662c 2027 7365 6372 6574 2d67  (self, 'secret-g
+0001be30: 6574 272c 2073 6372 6970 7429 0a20 2020  et', script).   
+0001be40: 2020 2020 2066 616b 655f 7363 7269 7074       fake_script
+0001be50: 2873 656c 662c 2027 7365 6372 6574 2d69  (self, 'secret-i
+0001be60: 6e66 6f2d 6765 7427 2c20 7363 7269 7074  nfo-get', script
+0001be70: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+0001be80: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0001be90: 7328 6f70 732e 4d6f 6465 6c45 7272 6f72  s(ops.ModelError
+0001bea0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+0001beb0: 2020 2020 2073 656c 662e 6d6f 6465 6c2e       self.model.
+0001bec0: 6765 745f 7365 6372 6574 2869 643d 2731  get_secret(id='1
+0001bed0: 3233 2729 0a20 2020 2020 2020 2073 656c  23').        sel
+0001bee0: 662e 6173 7365 7274 4e6f 7449 7349 6e73  f.assertNotIsIns
+0001bef0: 7461 6e63 6528 636d 2e65 7863 6570 7469  tance(cm.excepti
+0001bf00: 6f6e 2c20 6f70 732e 5365 6372 6574 4e6f  on, ops.SecretNo
+0001bf10: 7446 6f75 6e64 4572 726f 7229 0a0a 0a63  tFoundError)...c
+0001bf20: 6c61 7373 2054 6573 7453 6563 7265 7449  lass TestSecretI
+0001bf30: 6e66 6f28 756e 6974 7465 7374 2e54 6573  nfo(unittest.Tes
+0001bf40: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
+0001bf50: 7465 7374 5f69 6e69 7428 7365 6c66 293a  test_init(self):
+0001bf60: 0a20 2020 2020 2020 2069 6e66 6f20 3d20  .        info = 
+0001bf70: 6f70 732e 5365 6372 6574 496e 666f 280a  ops.SecretInfo(.
+0001bf80: 2020 2020 2020 2020 2020 2020 6964 3d27              id='
+0001bf90: 3327 2c0a 2020 2020 2020 2020 2020 2020  3',.            
+0001bfa0: 6c61 6265 6c3d 276c 626c 272c 0a20 2020  label='lbl',.   
+0001bfb0: 2020 2020 2020 2020 2072 6576 6973 696f           revisio
+0001bfc0: 6e3d 372c 0a20 2020 2020 2020 2020 2020  n=7,.           
+0001bfd0: 2065 7870 6972 6573 3d64 6174 6574 696d   expires=datetim
+0001bfe0: 652e 6461 7465 7469 6d65 2832 3032 322c  e.datetime(2022,
+0001bff0: 2031 322c 2039 2c20 3134 2c20 3130 2c20   12, 9, 14, 10, 
+0001c000: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
+0001c010: 726f 7461 7469 6f6e 3d6f 7073 2e53 6563  rotation=ops.Sec
+0001c020: 7265 7452 6f74 6174 652e 4d4f 4e54 484c  retRotate.MONTHL
+0001c030: 592c 0a20 2020 2020 2020 2020 2020 2072  Y,.            r
+0001c040: 6f74 6174 6573 3d64 6174 6574 696d 652e  otates=datetime.
+0001c050: 6461 7465 7469 6d65 2832 3032 332c 2031  datetime(2023, 1
+0001c060: 2c20 392c 2031 342c 2031 302c 2030 292c  , 9, 14, 10, 0),
+0001c070: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001c080: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001c090: 7561 6c28 696e 666f 2e69 642c 2027 7365  ual(info.id, 'se
+0001c0a0: 6372 6574 3a33 2729 0a20 2020 2020 2020  cret:3').       
+0001c0b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001c0c0: 6c28 696e 666f 2e6c 6162 656c 2c20 276c  l(info.label, 'l
+0001c0d0: 626c 2729 0a20 2020 2020 2020 2073 656c  bl').        sel
+0001c0e0: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
+0001c0f0: 666f 2e72 6576 6973 696f 6e2c 2037 290a  fo.revision, 7).
+0001c100: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001c110: 6572 7445 7175 616c 2869 6e66 6f2e 6578  ertEqual(info.ex
+0001c120: 7069 7265 732c 2064 6174 6574 696d 652e  pires, datetime.
+0001c130: 6461 7465 7469 6d65 2832 3032 322c 2031  datetime(2022, 1
+0001c140: 322c 2039 2c20 3134 2c20 3130 2c20 3029  2, 9, 14, 10, 0)
+0001c150: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001c160: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
+0001c170: 726f 7461 7469 6f6e 2c20 6f70 732e 5365  rotation, ops.Se
+0001c180: 6372 6574 526f 7461 7465 2e4d 4f4e 5448  cretRotate.MONTH
+0001c190: 4c59 290a 2020 2020 2020 2020 7365 6c66  LY).        self
+0001c1a0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+0001c1b0: 6f2e 726f 7461 7465 732c 2064 6174 6574  o.rotates, datet
+0001c1c0: 696d 652e 6461 7465 7469 6d65 2832 3032  ime.datetime(202
+0001c1d0: 332c 2031 2c20 392c 2031 342c 2031 302c  3, 1, 9, 14, 10,
+0001c1e0: 2030 2929 0a0a 2020 2020 2020 2020 7365   0))..        se
+0001c1f0: 6c66 2e61 7373 6572 7454 7275 6528 7265  lf.assertTrue(re
+0001c200: 7072 2869 6e66 6f29 2e73 7461 7274 7377  pr(info).startsw
+0001c210: 6974 6828 2753 6563 7265 7449 6e66 6f28  ith('SecretInfo(
+0001c220: 2729 290a 2020 2020 2020 2020 7365 6c66  ')).        self
+0001c230: 2e61 7373 6572 7454 7275 6528 7265 7072  .assertTrue(repr
+0001c240: 2869 6e66 6f29 2e65 6e64 7377 6974 6828  (info).endswith(
+0001c250: 2729 2729 290a 0a20 2020 2064 6566 2074  ')'))..    def t
+0001c260: 6573 745f 6672 6f6d 5f64 6963 7428 7365  est_from_dict(se
+0001c270: 6c66 293a 0a20 2020 2020 2020 2075 7463  lf):.        utc
+0001c280: 203d 2064 6174 6574 696d 652e 7469 6d65   = datetime.time
+0001c290: 7a6f 6e65 2e75 7463 0a20 2020 2020 2020  zone.utc.       
+0001c2a0: 2069 6e66 6f20 3d20 6f70 732e 5365 6372   info = ops.Secr
+0001c2b0: 6574 496e 666f 2e66 726f 6d5f 6469 6374  etInfo.from_dict
+0001c2c0: 2827 7365 6372 6574 3a34 272c 207b 0a20  ('secret:4', {. 
+0001c2d0: 2020 2020 2020 2020 2020 2027 6c61 6265             'labe
+0001c2e0: 6c27 3a20 2766 726f 6d64 6963 7427 2c0a  l': 'fromdict',.
+0001c2f0: 2020 2020 2020 2020 2020 2020 2772 6576              'rev
+0001c300: 6973 696f 6e27 3a20 382c 0a20 2020 2020  ision': 8,.     
+0001c310: 2020 2020 2020 2027 6578 7069 7265 7327         'expires'
+0001c320: 3a20 2732 3032 322d 3132 2d30 3954 3134  : '2022-12-09T14
+0001c330: 3a31 303a 3030 5a27 2c0a 2020 2020 2020  :10:00Z',.      
+0001c340: 2020 2020 2020 2772 6f74 6174 696f 6e27        'rotation'
+0001c350: 3a20 2779 6561 726c 7927 2c0a 2020 2020  : 'yearly',.    
+0001c360: 2020 2020 2020 2020 2772 6f74 6174 6573          'rotates
+0001c370: 273a 2027 3230 3233 2d30 312d 3039 5431  ': '2023-01-09T1
+0001c380: 343a 3130 3a30 305a 272c 0a20 2020 2020  4:10:00Z',.     
+0001c390: 2020 207d 290a 2020 2020 2020 2020 7365     }).        se
+0001c3a0: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+0001c3b0: 6e66 6f2e 6964 2c20 2773 6563 7265 743a  nfo.id, 'secret:
+0001c3c0: 3427 290a 2020 2020 2020 2020 7365 6c66  4').        self
+0001c3d0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+0001c3e0: 6f2e 6c61 6265 6c2c 2027 6672 6f6d 6469  o.label, 'fromdi
+0001c3f0: 6374 2729 0a20 2020 2020 2020 2073 656c  ct').        sel
+0001c400: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
+0001c410: 666f 2e72 6576 6973 696f 6e2c 2038 290a  fo.revision, 8).
+0001c420: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001c430: 6572 7445 7175 616c 2869 6e66 6f2e 6578  ertEqual(info.ex
+0001c440: 7069 7265 732c 2064 6174 6574 696d 652e  pires, datetime.
+0001c450: 6461 7465 7469 6d65 2832 3032 322c 2031  datetime(2022, 1
+0001c460: 322c 2039 2c20 3134 2c20 3130 2c20 302c  2, 9, 14, 10, 0,
+0001c470: 2074 7a69 6e66 6f3d 7574 6329 290a 2020   tzinfo=utc)).  
+0001c480: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001c490: 7445 7175 616c 2869 6e66 6f2e 726f 7461  tEqual(info.rota
+0001c4a0: 7469 6f6e 2c20 6f70 732e 5365 6372 6574  tion, ops.Secret
+0001c4b0: 526f 7461 7465 2e59 4541 524c 5929 0a20  Rotate.YEARLY). 
+0001c4c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001c4d0: 7274 4571 7561 6c28 696e 666f 2e72 6f74  rtEqual(info.rot
+0001c4e0: 6174 6573 2c20 6461 7465 7469 6d65 2e64  ates, datetime.d
+0001c4f0: 6174 6574 696d 6528 3230 3233 2c20 312c  atetime(2023, 1,
+0001c500: 2039 2c20 3134 2c20 3130 2c20 302c 2074   9, 14, 10, 0, t
+0001c510: 7a69 6e66 6f3d 7574 6329 290a 0a20 2020  zinfo=utc))..   
+0001c520: 2020 2020 2069 6e66 6f20 3d20 6f70 732e       info = ops.
+0001c530: 5365 6372 6574 496e 666f 2e66 726f 6d5f  SecretInfo.from_
+0001c540: 6469 6374 2827 7365 6372 6574 3a34 272c  dict('secret:4',
+0001c550: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+0001c560: 6c61 6265 6c27 3a20 2766 726f 6d64 6963  label': 'fromdic
+0001c570: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+0001c580: 2772 6576 6973 696f 6e27 3a20 382c 0a20  'revision': 8,. 
+0001c590: 2020 2020 2020 2020 2020 2027 726f 7461             'rota
+0001c5a0: 7469 6f6e 273a 2027 6261 6476 616c 7565  tion': 'badvalue
+0001c5b0: 272c 0a20 2020 2020 2020 207d 290a 2020  ',.        }).  
+0001c5c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001c5d0: 7445 7175 616c 2869 6e66 6f2e 6964 2c20  tEqual(info.id, 
+0001c5e0: 2773 6563 7265 743a 3427 290a 2020 2020  'secret:4').    
+0001c5f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001c600: 7175 616c 2869 6e66 6f2e 6c61 6265 6c2c  qual(info.label,
+0001c610: 2027 6672 6f6d 6469 6374 2729 0a20 2020   'fromdict').   
+0001c620: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001c630: 4571 7561 6c28 696e 666f 2e72 6576 6973  Equal(info.revis
+0001c640: 696f 6e2c 2038 290a 2020 2020 2020 2020  ion, 8).        
+0001c650: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
+0001c660: 6528 696e 666f 2e65 7870 6972 6573 290a  e(info.expires).
+0001c670: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001c680: 6572 7449 734e 6f6e 6528 696e 666f 2e72  ertIsNone(info.r
+0001c690: 6f74 6174 696f 6e29 0a20 2020 2020 2020  otation).       
+0001c6a0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+0001c6b0: 6e65 2869 6e66 6f2e 726f 7461 7465 7329  ne(info.rotates)
+0001c6c0: 0a0a 2020 2020 2020 2020 696e 666f 203d  ..        info =
+0001c6d0: 206f 7073 2e53 6563 7265 7449 6e66 6f2e   ops.SecretInfo.
+0001c6e0: 6672 6f6d 5f64 6963 7428 2735 272c 207b  from_dict('5', {
+0001c6f0: 2772 6576 6973 696f 6e27 3a20 397d 290a  'revision': 9}).
+0001c700: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001c710: 6572 7445 7175 616c 2869 6e66 6f2e 6964  ertEqual(info.id
+0001c720: 2c20 2773 6563 7265 743a 3527 290a 2020  , 'secret:5').  
+0001c730: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001c740: 7445 7175 616c 2869 6e66 6f2e 7265 7669  tEqual(info.revi
+0001c750: 7369 6f6e 2c20 3929 0a0a 0a63 6c61 7373  sion, 9)...class
+0001c760: 2054 6573 7453 6563 7265 7443 6c61 7373   TestSecretClass
+0001c770: 2875 6e69 7474 6573 742e 5465 7374 4361  (unittest.TestCa
+0001c780: 7365 293a 0a20 2020 206d 6178 4469 6666  se):.    maxDiff
+0001c790: 203d 2036 3420 2a20 3130 3234 0a0a 2020   = 64 * 1024..  
+0001c7a0: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
+0001c7b0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0001c7c0: 6d6f 6465 6c20 3d20 6f70 732e 4d6f 6465  model = ops.Mode
+0001c7d0: 6c28 6f70 732e 4368 6172 6d4d 6574 6128  l(ops.CharmMeta(
+0001c7e0: 292c 205f 4d6f 6465 6c42 6163 6b65 6e64  ), _ModelBackend
+0001c7f0: 2827 6d79 6170 702f 3027 2929 0a0a 2020  ('myapp/0'))..  
+0001c800: 2020 6465 6620 6d61 6b65 5f73 6563 7265    def make_secre
+0001c810: 7428 7365 6c66 2c20 6964 3d4e 6f6e 652c  t(self, id=None,
+0001c820: 206c 6162 656c 3d4e 6f6e 652c 2063 6f6e   label=None, con
+0001c830: 7465 6e74 3d4e 6f6e 6529 3a0a 2020 2020  tent=None):.    
+0001c840: 2020 2020 7265 7475 726e 206f 7073 2e53      return ops.S
+0001c850: 6563 7265 7428 7365 6c66 2e6d 6f64 656c  ecret(self.model
+0001c860: 2e5f 6261 636b 656e 642c 2069 643d 6964  ._backend, id=id
+0001c870: 2c20 6c61 6265 6c3d 6c61 6265 6c2c 2063  , label=label, c
+0001c880: 6f6e 7465 6e74 3d63 6f6e 7465 6e74 290a  ontent=content).
+0001c890: 0a20 2020 2064 6566 2074 6573 745f 6964  .    def test_id
+0001c8a0: 5f61 6e64 5f6c 6162 656c 2873 656c 6629  _and_label(self)
+0001c8b0: 3a0a 2020 2020 2020 2020 7365 6372 6574  :.        secret
+0001c8c0: 203d 2073 656c 662e 6d61 6b65 5f73 6563   = self.make_sec
+0001c8d0: 7265 7428 6964 3d27 2061 6263 2027 2c20  ret(id=' abc ', 
+0001c8e0: 6c61 6265 6c3d 276c 626c 2729 0a20 2020  label='lbl').   
+0001c8f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001c900: 4571 7561 6c28 7365 6372 6574 2e69 642c  Equal(secret.id,
+0001c910: 2027 7365 6372 6574 3a61 6263 2729 0a20   'secret:abc'). 
+0001c920: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001c930: 7274 4571 7561 6c28 7365 6372 6574 2e6c  rtEqual(secret.l
+0001c940: 6162 656c 2c20 276c 626c 2729 0a0a 2020  abel, 'lbl')..  
+0001c950: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
+0001c960: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
+0001c970: 6964 3d27 7827 290a 2020 2020 2020 2020  id='x').        
+0001c980: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001c990: 2873 6563 7265 742e 6964 2c20 2773 6563  (secret.id, 'sec
+0001c9a0: 7265 743a 7827 290a 2020 2020 2020 2020  ret:x').        
+0001c9b0: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
+0001c9c0: 6528 7365 6372 6574 2e6c 6162 656c 290a  e(secret.label).
+0001c9d0: 0a20 2020 2020 2020 2073 6563 7265 7420  .        secret 
+0001c9e0: 3d20 7365 6c66 2e6d 616b 655f 7365 6372  = self.make_secr
+0001c9f0: 6574 286c 6162 656c 3d27 7927 290a 2020  et(label='y').  
+0001ca00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001ca10: 7449 734e 6f6e 6528 7365 6372 6574 2e69  tIsNone(secret.i
+0001ca20: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+0001ca30: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
+0001ca40: 6574 2e6c 6162 656c 2c20 2779 2729 0a0a  et.label, 'y')..
+0001ca50: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+0001ca60: 5f63 6f6e 7465 6e74 5f63 6163 6865 6428  _content_cached(
+0001ca70: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0001ca80: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001ca90: 2027 7365 6372 6574 2d67 6574 272c 2022   'secret-get', "
+0001caa0: 2222 6578 6974 2031 2222 2229 0a0a 2020  ""exit 1""")..  
+0001cab0: 2020 2020 2020 7365 6372 6574 203d 2073        secret = s
+0001cac0: 656c 662e 6d61 6b65 5f73 6563 7265 7428  elf.make_secret(
+0001cad0: 6964 3d27 7827 2c20 6c61 6265 6c3d 2779  id='x', label='y
+0001cae0: 272c 2063 6f6e 7465 6e74 3d7b 2766 6f6f  ', content={'foo
+0001caf0: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
+0001cb00: 2020 2063 6f6e 7465 6e74 203d 2073 6563     content = sec
+0001cb10: 7265 742e 6765 745f 636f 6e74 656e 7428  ret.get_content(
+0001cb20: 2920 2023 2077 696c 6c20 7573 6520 6361  )  # will use ca
+0001cb30: 6368 6564 2063 6f6e 7465 6e74 2c20 6e6f  ched content, no
+0001cb40: 7420 7275 6e20 7365 6372 6574 2d67 6574  t run secret-get
+0001cb50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001cb60: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
+0001cb70: 742c 207b 2766 6f6f 273a 2027 6261 7227  t, {'foo': 'bar'
+0001cb80: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
+0001cb90: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+0001cba0: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+0001cbb0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+0001cbc0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+0001cbd0: 6573 745f 6765 745f 636f 6e74 656e 745f  est_get_content_
+0001cbe0: 7265 6672 6573 6828 7365 6c66 293a 0a20  refresh(self):. 
+0001cbf0: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001cc00: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
+0001cc10: 2d67 6574 272c 2022 2222 6563 686f 2027  -get', """echo '
+0001cc20: 7b22 666f 6f22 3a20 2272 6566 7265 7368  {"foo": "refresh
+0001cc30: 6564 227d 2722 2222 290a 0a20 2020 2020  ed"}'""")..     
+0001cc40: 2020 2073 6563 7265 7420 3d20 7365 6c66     secret = self
+0001cc50: 2e6d 616b 655f 7365 6372 6574 2869 643d  .make_secret(id=
+0001cc60: 2779 272c 2063 6f6e 7465 6e74 3d7b 2766  'y', content={'f
+0001cc70: 6f6f 273a 2027 6261 7227 7d29 0a20 2020  oo': 'bar'}).   
+0001cc80: 2020 2020 2063 6f6e 7465 6e74 203d 2073       content = s
+0001cc90: 6563 7265 742e 6765 745f 636f 6e74 656e  ecret.get_conten
+0001cca0: 7428 7265 6672 6573 683d 5472 7565 290a  t(refresh=True).
+0001ccb0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001ccc0: 6572 7445 7175 616c 2863 6f6e 7465 6e74  ertEqual(content
+0001ccd0: 2c20 7b27 666f 6f27 3a20 2772 6566 7265  , {'foo': 'refre
+0001cce0: 7368 6564 277d 290a 0a20 2020 2020 2020  shed'})..       
+0001ccf0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001cd00: 6c28 6661 6b65 5f73 6372 6970 745f 6361  l(fake_script_ca
+0001cd10: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+0001cd20: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
+0001cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd40: 5b5b 2773 6563 7265 742d 6765 7427 2c20  [['secret-get', 
+0001cd50: 2773 6563 7265 743a 7927 2c20 272d 2d72  'secret:y', '--r
+0001cd60: 6566 7265 7368 272c 2027 2d2d 666f 726d  efresh', '--form
+0001cd70: 6174 3d6a 736f 6e27 5d5d 290a 0a20 2020  at=json']])..   
+0001cd80: 2064 6566 2074 6573 745f 6765 745f 636f   def test_get_co
+0001cd90: 6e74 656e 745f 756e 6361 6368 6564 2873  ntent_uncached(s
+0001cda0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+0001cdb0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001cdc0: 2773 6563 7265 742d 6765 7427 2c20 2222  'secret-get', ""
+0001cdd0: 2265 6368 6f20 277b 2266 6f6f 223a 2022  "echo '{"foo": "
+0001cde0: 6e6f 7463 6163 6865 6422 7d27 2222 2229  notcached"}'""")
+0001cdf0: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
+0001ce00: 203d 2073 656c 662e 6d61 6b65 5f73 6563   = self.make_sec
+0001ce10: 7265 7428 6964 3d27 7a27 290a 2020 2020  ret(id='z').    
+0001ce20: 2020 2020 636f 6e74 656e 7420 3d20 7365      content = se
+0001ce30: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
+0001ce40: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0001ce50: 6173 7365 7274 4571 7561 6c28 636f 6e74  assertEqual(cont
+0001ce60: 656e 742c 207b 2766 6f6f 273a 2027 6e6f  ent, {'foo': 'no
+0001ce70: 7463 6163 6865 6427 7d29 0a0a 2020 2020  tcached'})..    
+0001ce80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001ce90: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001cea0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001ceb0: 6172 3d54 7275 6529 2c0a 2020 2020 2020  ar=True),.      
+0001cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ced0: 2020 205b 5b27 7365 6372 6574 2d67 6574     [['secret-get
+0001cee0: 272c 2027 7365 6372 6574 3a7a 272c 2027  ', 'secret:z', '
+0001cef0: 2d2d 666f 726d 6174 3d6a 736f 6e27 5d5d  --format=json']]
+0001cf00: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001cf10: 7065 656b 5f63 6f6e 7465 6e74 2873 656c  peek_content(sel
+0001cf20: 6629 3a0a 2020 2020 2020 2020 6661 6b65  f):.        fake
+0001cf30: 5f73 6372 6970 7428 7365 6c66 2c20 2773  _script(self, 's
+0001cf40: 6563 7265 742d 6765 7427 2c20 2222 2265  ecret-get', """e
+0001cf50: 6368 6f20 277b 2266 6f6f 223a 2022 7065  cho '{"foo": "pe
+0001cf60: 656b 6564 227d 2722 2222 290a 0a20 2020  eked"}'""")..   
+0001cf70: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
+0001cf80: 6c66 2e6d 616b 655f 7365 6372 6574 2869  lf.make_secret(i
+0001cf90: 643d 2761 272c 206c 6162 656c 3d27 6227  d='a', label='b'
+0001cfa0: 290a 2020 2020 2020 2020 636f 6e74 656e  ).        conten
+0001cfb0: 7420 3d20 7365 6372 6574 2e70 6565 6b5f  t = secret.peek_
+0001cfc0: 636f 6e74 656e 7428 290a 2020 2020 2020  content().      
+0001cfd0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001cfe0: 616c 2863 6f6e 7465 6e74 2c20 7b27 666f  al(content, {'fo
+0001cff0: 6f27 3a20 2770 6565 6b65 6427 7d29 0a0a  o': 'peeked'})..
+0001d000: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001d010: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+0001d020: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+0001d030: 2063 6c65 6172 3d54 7275 6529 2c0a 2020   clear=True),.  
+0001d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d050: 2020 2020 2020 205b 5b27 7365 6372 6574         [['secret
+0001d060: 2d67 6574 272c 2027 7365 6372 6574 3a61  -get', 'secret:a
+0001d070: 272c 2027 2d2d 6c61 6265 6c27 2c20 2762  ', '--label', 'b
+0001d080: 272c 2027 2d2d 7065 656b 272c 2027 2d2d  ', '--peek', '--
+0001d090: 666f 726d 6174 3d6a 736f 6e27 5d5d 290a  format=json']]).
+0001d0a0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
+0001d0b0: 745f 696e 666f 2873 656c 6629 3a0a 2020  t_info(self):.  
+0001d0c0: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+0001d0d0: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
+0001d0e0: 696e 666f 2d67 6574 272c 2022 2222 6563  info-get', """ec
+0001d0f0: 686f 2027 7b22 7822 3a20 7b22 6c61 6265  ho '{"x": {"labe
+0001d100: 6c22 3a20 2279 222c 2022 7265 7669 7369  l": "y", "revisi
+0001d110: 6f6e 223a 2037 7d7d 2722 2222 290a 0a20  on": 7}}'""").. 
+0001d120: 2020 2020 2020 2023 2053 6563 7265 7420         # Secret 
+0001d130: 7769 7468 2049 4420 6f6e 6c79 0a20 2020  with ID only.   
+0001d140: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
+0001d150: 6c66 2e6d 616b 655f 7365 6372 6574 2869  lf.make_secret(i
+0001d160: 643d 2778 2729 0a20 2020 2020 2020 2069  d='x').        i
+0001d170: 6e66 6f20 3d20 7365 6372 6574 2e67 6574  nfo = secret.get
+0001d180: 5f69 6e66 6f28 290a 2020 2020 2020 2020  _info().        
+0001d190: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001d1a0: 2869 6e66 6f2e 6964 2c20 2773 6563 7265  (info.id, 'secre
+0001d1b0: 743a 7827 290a 2020 2020 2020 2020 7365  t:x').        se
+0001d1c0: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+0001d1d0: 6e66 6f2e 6c61 6265 6c2c 2027 7927 290a  nfo.label, 'y').
+0001d1e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001d1f0: 6572 7445 7175 616c 2869 6e66 6f2e 7265  ertEqual(info.re
+0001d200: 7669 7369 6f6e 2c20 3729 0a0a 2020 2020  vision, 7)..    
+0001d210: 2020 2020 2320 5365 6372 6574 2077 6974      # Secret wit
+0001d220: 6820 6c61 6265 6c20 6f6e 6c79 0a20 2020  h label only.   
+0001d230: 2020 2020 2073 6563 7265 7420 3d20 7365       secret = se
+0001d240: 6c66 2e6d 616b 655f 7365 6372 6574 286c  lf.make_secret(l
+0001d250: 6162 656c 3d27 7927 290a 2020 2020 2020  abel='y').      
+0001d260: 2020 696e 666f 203d 2073 6563 7265 742e    info = secret.
+0001d270: 6765 745f 696e 666f 2829 0a20 2020 2020  get_info().     
+0001d280: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001d290: 7561 6c28 696e 666f 2e69 642c 2027 7365  ual(info.id, 'se
+0001d2a0: 6372 6574 3a78 2729 0a20 2020 2020 2020  cret:x').       
+0001d2b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d2c0: 6c28 696e 666f 2e6c 6162 656c 2c20 2779  l(info.label, 'y
+0001d2d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001d2e0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
+0001d2f0: 2e72 6576 6973 696f 6e2c 2037 290a 0a20  .revision, 7).. 
+0001d300: 2020 2020 2020 2023 2053 6563 7265 7420         # Secret 
+0001d310: 7769 7468 2049 4420 616e 6420 6c61 6265  with ID and labe
+0001d320: 6c0a 2020 2020 2020 2020 7365 6372 6574  l.        secret
+0001d330: 203d 2073 656c 662e 6d61 6b65 5f73 6563   = self.make_sec
+0001d340: 7265 7428 6964 3d27 7827 2c20 6c61 6265  ret(id='x', labe
+0001d350: 6c3d 2779 2729 0a20 2020 2020 2020 2069  l='y').        i
+0001d360: 6e66 6f20 3d20 7365 6372 6574 2e67 6574  nfo = secret.get
+0001d370: 5f69 6e66 6f28 290a 2020 2020 2020 2020  _info().        
+0001d380: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001d390: 2869 6e66 6f2e 6964 2c20 2773 6563 7265  (info.id, 'secre
+0001d3a0: 743a 7827 290a 2020 2020 2020 2020 7365  t:x').        se
+0001d3b0: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+0001d3c0: 6e66 6f2e 6c61 6265 6c2c 2027 7927 290a  nfo.label, 'y').
+0001d3d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001d3e0: 6572 7445 7175 616c 2869 6e66 6f2e 7265  ertEqual(info.re
+0001d3f0: 7669 7369 6f6e 2c20 3729 0a0a 2020 2020  vision, 7)..    
+0001d400: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001d410: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+0001d420: 2020 6661 6b65 5f73 6372 6970 745f 6361    fake_script_ca
+0001d430: 6c6c 7328 7365 6c66 2c20 636c 6561 723d  lls(self, clear=
+0001d440: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
+0001d450: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0001d460: 2020 2020 205b 2773 6563 7265 742d 696e       ['secret-in
+0001d470: 666f 2d67 6574 272c 2027 7365 6372 6574  fo-get', 'secret
+0001d480: 3a78 272c 2027 2d2d 666f 726d 6174 3d6a  :x', '--format=j
+0001d490: 736f 6e27 5d2c 0a20 2020 2020 2020 2020  son'],.         
+0001d4a0: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
+0001d4b0: 696e 666f 2d67 6574 272c 2027 2d2d 6c61  info-get', '--la
+0001d4c0: 6265 6c27 2c20 2779 272c 2027 2d2d 666f  bel', 'y', '--fo
+0001d4d0: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
+0001d4e0: 2020 2020 2020 2020 2020 2020 205b 2773               ['s
+0001d4f0: 6563 7265 742d 696e 666f 2d67 6574 272c  ecret-info-get',
+0001d500: 2027 7365 6372 6574 3a78 272c 2027 2d2d   'secret:x', '--
+0001d510: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
+0001d520: 2020 2020 2020 2020 2020 205d 290a 0a20             ]).. 
+0001d530: 2020 2064 6566 2074 6573 745f 7365 745f     def test_set_
+0001d540: 636f 6e74 656e 7428 7365 6c66 293a 0a20  content(self):. 
+0001d550: 2020 2020 2020 2066 616b 655f 7363 7269         fake_scri
+0001d560: 7074 2873 656c 662c 2027 7365 6372 6574  pt(self, 'secret
+0001d570: 2d73 6574 272c 2022 2222 6578 6974 2030  -set', """exit 0
+0001d580: 2222 2229 0a20 2020 2020 2020 2066 616b  """).        fak
+0001d590: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+0001d5a0: 7365 6372 6574 2d69 6e66 6f2d 6765 7427  secret-info-get'
+0001d5b0: 2c20 2222 2265 6368 6f20 277b 227a 223a  , """echo '{"z":
+0001d5c0: 207b 226c 6162 656c 223a 2022 7922 2c20   {"label": "y", 
+0001d5d0: 2272 6576 6973 696f 6e22 3a20 377d 7d27  "revision": 7}}'
+0001d5e0: 2222 2229 0a0a 2020 2020 2020 2020 7365  """)..        se
+0001d5f0: 6372 6574 203d 2073 656c 662e 6d61 6b65  cret = self.make
+0001d600: 5f73 6563 7265 7428 6964 3d27 7827 290a  _secret(id='x').
+0001d610: 2020 2020 2020 2020 7365 6372 6574 2e73          secret.s
+0001d620: 6574 5f63 6f6e 7465 6e74 287b 2766 6f6f  et_content({'foo
+0001d630: 273a 2027 6261 7227 7d29 0a0a 2020 2020  ': 'bar'})..    
+0001d640: 2020 2020 2320 4966 2073 6563 7265 7420      # If secret 
+0001d650: 646f 6573 6e27 7420 6861 7665 2061 6e20  doesn't have an 
+0001d660: 4944 2c20 7765 276c 6c20 7275 6e20 7365  ID, we'll run se
+0001d670: 6372 6574 2d69 6e66 6f2d 6765 7420 746f  cret-info-get to
+0001d680: 2066 6574 6368 2069 740a 2020 2020 2020   fetch it.      
+0001d690: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
+0001d6a0: 6d61 6b65 5f73 6563 7265 7428 6c61 6265  make_secret(labe
+0001d6b0: 6c3d 2779 2729 0a20 2020 2020 2020 2073  l='y').        s
+0001d6c0: 656c 662e 6173 7365 7274 4973 4e6f 6e65  elf.assertIsNone
+0001d6d0: 2873 6563 7265 742e 6964 290a 2020 2020  (secret.id).    
+0001d6e0: 2020 2020 7365 6372 6574 2e73 6574 5f63      secret.set_c
+0001d6f0: 6f6e 7465 6e74 287b 2762 6172 273a 2027  ontent({'bar': '
+0001d700: 666f 6f27 7d29 0a20 2020 2020 2020 2073  foo'}).        s
+0001d710: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001d720: 7365 6372 6574 2e69 642c 2027 7365 6372  secret.id, 'secr
+0001d730: 6574 3a7a 2729 0a0a 2020 2020 2020 2020  et:z')..        
+0001d740: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0001d750: 5261 6973 6573 2856 616c 7565 4572 726f  Raises(ValueErro
+0001d760: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0001d770: 7365 6372 6574 2e73 6574 5f63 6f6e 7465  secret.set_conte
+0001d780: 6e74 287b 2773 273a 2027 7427 7d29 2020  nt({'s': 't'})  
+0001d790: 2320 656e 7375 7265 2069 7420 7661 6c69  # ensure it vali
+0001d7a0: 6461 7465 7320 636f 6e74 656e 7420 286b  dates content (k
+0001d7b0: 6579 2074 6f6f 2073 686f 7274 290a 0a20  ey too short).. 
+0001d7c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001d7d0: 7274 4571 7561 6c28 6661 6b65 5f73 6372  rtEqual(fake_scr
+0001d7e0: 6970 745f 6361 6c6c 7328 7365 6c66 2c20  ipt_calls(self, 
+0001d7f0: 636c 6561 723d 5472 7565 292c 205b 0a20  clear=True), [. 
+0001d800: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
+0001d810: 7265 742d 7365 7427 2c20 2773 6563 7265  ret-set', 'secre
+0001d820: 743a 7827 2c20 2766 6f6f 3d62 6172 275d  t:x', 'foo=bar']
+0001d830: 2c0a 2020 2020 2020 2020 2020 2020 5b27  ,.            ['
+0001d840: 7365 6372 6574 2d69 6e66 6f2d 6765 7427  secret-info-get'
+0001d850: 2c20 272d 2d6c 6162 656c 272c 2027 7927  , '--label', 'y'
+0001d860: 2c20 272d 2d66 6f72 6d61 743d 6a73 6f6e  , '--format=json
+0001d870: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0001d880: 5b27 7365 6372 6574 2d73 6574 272c 2027  ['secret-set', '
+0001d890: 7365 6372 6574 3a7a 272c 2027 6261 723d  secret:z', 'bar=
+0001d8a0: 666f 6f27 5d2c 0a20 2020 2020 2020 205d  foo'],.        ]
+0001d8b0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001d8c0: 7365 745f 696e 666f 2873 656c 6629 3a0a  set_info(self):.
+0001d8d0: 2020 2020 2020 2020 6661 6b65 5f73 6372          fake_scr
+0001d8e0: 6970 7428 7365 6c66 2c20 2773 6563 7265  ipt(self, 'secre
+0001d8f0: 742d 7365 7427 2c20 2222 2265 7869 7420  t-set', """exit 
+0001d900: 3022 2222 290a 2020 2020 2020 2020 6661  0""").        fa
+0001d910: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001d920: 2773 6563 7265 742d 696e 666f 2d67 6574  'secret-info-get
+0001d930: 272c 2022 2222 6563 686f 2027 7b22 7a22  ', """echo '{"z"
+0001d940: 3a20 7b22 6c61 6265 6c22 3a20 2279 222c  : {"label": "y",
+0001d950: 2022 7265 7669 7369 6f6e 223a 2037 7d7d   "revision": 7}}
+0001d960: 2722 2222 290a 0a20 2020 2020 2020 2073  '""")..        s
+0001d970: 6563 7265 7420 3d20 7365 6c66 2e6d 616b  ecret = self.mak
+0001d980: 655f 7365 6372 6574 2869 643d 2778 2729  e_secret(id='x')
+0001d990: 0a20 2020 2020 2020 2065 7870 6972 6520  .        expire 
+0001d9a0: 3d20 6461 7465 7469 6d65 2e64 6174 6574  = datetime.datet
+0001d9b0: 696d 6528 3230 3232 2c20 3132 2c20 392c  ime(2022, 12, 9,
+0001d9c0: 2031 362c 2035 392c 2030 290a 2020 2020   16, 59, 0).    
+0001d9d0: 2020 2020 7365 6372 6574 2e73 6574 5f69      secret.set_i
+0001d9e0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+0001d9f0: 206c 6162 656c 3d27 6c61 6227 2c0a 2020   label='lab',.  
+0001da00: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+0001da10: 7074 696f 6e3d 2764 6573 6327 2c0a 2020  ption='desc',.  
+0001da20: 2020 2020 2020 2020 2020 6578 7069 7265            expire
+0001da30: 3d65 7870 6972 652c 0a20 2020 2020 2020  =expire,.       
+0001da40: 2020 2020 2072 6f74 6174 653d 6f70 732e       rotate=ops.
+0001da50: 5365 6372 6574 526f 7461 7465 2e4d 4f4e  SecretRotate.MON
+0001da60: 5448 4c59 2c0a 2020 2020 2020 2020 290a  THLY,.        ).
+0001da70: 0a20 2020 2020 2020 2023 2049 6620 7365  .        # If se
+0001da80: 6372 6574 2064 6f65 736e 2774 2068 6176  cret doesn't hav
+0001da90: 6520 616e 2049 442c 2077 6527 6c6c 2072  e an ID, we'll r
+0001daa0: 756e 2073 6563 7265 742d 696e 666f 2d67  un secret-info-g
+0001dab0: 6574 2074 6f20 6665 7463 6820 6974 0a20  et to fetch it. 
+0001dac0: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
+0001dad0: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
+0001dae0: 286c 6162 656c 3d27 7927 290a 2020 2020  (label='y').    
+0001daf0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+0001db00: 734e 6f6e 6528 7365 6372 6574 2e69 6429  sNone(secret.id)
+0001db10: 0a20 2020 2020 2020 2073 6563 7265 742e  .        secret.
+0001db20: 7365 745f 696e 666f 286c 6162 656c 3d27  set_info(label='
+0001db30: 6c62 6c27 290a 2020 2020 2020 2020 7365  lbl').        se
+0001db40: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001db50: 6563 7265 742e 6964 2c20 2773 6563 7265  ecret.id, 'secre
+0001db60: 743a 7a27 290a 0a20 2020 2020 2020 2073  t:z')..        s
+0001db70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001db80: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001db90: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001dba0: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
+0001dbb0: 2020 205b 2773 6563 7265 742d 7365 7427     ['secret-set'
+0001dbc0: 2c20 2773 6563 7265 743a 7827 2c20 272d  , 'secret:x', '-
+0001dbd0: 2d6c 6162 656c 272c 2027 6c61 6227 2c20  -label', 'lab', 
+0001dbe0: 272d 2d64 6573 6372 6970 7469 6f6e 272c  '--description',
+0001dbf0: 2027 6465 7363 272c 0a20 2020 2020 2020   'desc',.       
+0001dc00: 2020 2020 2020 272d 2d65 7870 6972 6527        '--expire'
+0001dc10: 2c20 2732 3032 322d 3132 2d30 3954 3136  , '2022-12-09T16
+0001dc20: 3a35 393a 3030 272c 2027 2d2d 726f 7461  :59:00', '--rota
+0001dc30: 7465 272c 2027 6d6f 6e74 686c 7927 5d2c  te', 'monthly'],
+0001dc40: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
+0001dc50: 6563 7265 742d 696e 666f 2d67 6574 272c  ecret-info-get',
+0001dc60: 2027 2d2d 6c61 6265 6c27 2c20 2779 272c   '--label', 'y',
+0001dc70: 2027 2d2d 666f 726d 6174 3d6a 736f 6e27   '--format=json'
+0001dc80: 5d2c 0a20 2020 2020 2020 2020 2020 205b  ],.            [
+0001dc90: 2773 6563 7265 742d 7365 7427 2c20 2773  'secret-set', 's
+0001dca0: 6563 7265 743a 7a27 2c20 272d 2d6c 6162  ecret:z', '--lab
+0001dcb0: 656c 272c 2027 6c62 6c27 5d2c 0a20 2020  el', 'lbl'],.   
+0001dcc0: 2020 2020 205d 290a 0a20 2020 2020 2020       ])..       
+0001dcd0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0001dce0: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+0001dcf0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0001dd00: 7365 6372 6574 2e73 6574 5f69 6e66 6f28  secret.set_info(
+0001dd10: 2920 2023 206e 6f20 6172 6773 2070 726f  )  # no args pro
+0001dd20: 7669 6465 640a 0a20 2020 2064 6566 2074  vided..    def t
+0001dd30: 6573 745f 6772 616e 7428 7365 6c66 293a  est_grant(self):
+0001dd40: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+0001dd50: 7269 7074 2873 656c 662c 2027 7365 6372  ript(self, 'secr
+0001dd60: 6574 2d67 7261 6e74 272c 2022 2222 6578  et-grant', """ex
+0001dd70: 6974 2030 2222 2229 0a20 2020 2020 2020  it 0""").       
+0001dd80: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+0001dd90: 662c 2027 7365 6372 6574 2d69 6e66 6f2d  f, 'secret-info-
+0001dda0: 6765 7427 2c20 2222 2265 6368 6f20 277b  get', """echo '{
+0001ddb0: 227a 223a 207b 226c 6162 656c 223a 2022  "z": {"label": "
+0001ddc0: 7922 2c20 2272 6576 6973 696f 6e22 3a20  y", "revision": 
+0001ddd0: 377d 7d27 2222 2229 0a0a 2020 2020 2020  7}}'""")..      
+0001dde0: 2020 7365 6372 6574 203d 2073 656c 662e    secret = self.
+0001ddf0: 6d61 6b65 5f73 6563 7265 7428 6964 3d27  make_secret(id='
+0001de00: 7827 290a 2020 2020 2020 2020 7365 6372  x').        secr
+0001de10: 6574 2e67 7261 6e74 2874 7970 6573 2e53  et.grant(types.S
+0001de20: 696d 706c 654e 616d 6573 7061 6365 2869  impleNamespace(i
+0001de30: 643d 3132 3329 290a 2020 2020 2020 2020  d=123)).        
+0001de40: 7365 6372 6574 2e67 7261 6e74 2874 7970  secret.grant(typ
+0001de50: 6573 2e53 696d 706c 654e 616d 6573 7061  es.SimpleNamespa
+0001de60: 6365 2869 643d 3233 3429 2c20 756e 6974  ce(id=234), unit
+0001de70: 3d74 7970 6573 2e53 696d 706c 654e 616d  =types.SimpleNam
+0001de80: 6573 7061 6365 286e 616d 653d 2761 7070  espace(name='app
+0001de90: 2f30 2729 290a 0a20 2020 2020 2020 2023  /0'))..        #
+0001dea0: 2049 6620 7365 6372 6574 2064 6f65 736e   If secret doesn
+0001deb0: 2774 2068 6176 6520 616e 2049 442c 2077  't have an ID, w
+0001dec0: 6527 6c6c 2072 756e 2073 6563 7265 742d  e'll run secret-
+0001ded0: 696e 666f 2d67 6574 2074 6f20 6665 7463  info-get to fetc
+0001dee0: 6820 6974 0a20 2020 2020 2020 2073 6563  h it.        sec
+0001def0: 7265 7420 3d20 7365 6c66 2e6d 616b 655f  ret = self.make_
+0001df00: 7365 6372 6574 286c 6162 656c 3d27 7927  secret(label='y'
+0001df10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001df20: 7373 6572 7449 734e 6f6e 6528 7365 6372  ssertIsNone(secr
+0001df30: 6574 2e69 6429 0a20 2020 2020 2020 2073  et.id).        s
+0001df40: 6563 7265 742e 6772 616e 7428 7479 7065  ecret.grant(type
+0001df50: 732e 5369 6d70 6c65 4e61 6d65 7370 6163  s.SimpleNamespac
+0001df60: 6528 6964 3d33 3435 2929 0a20 2020 2020  e(id=345)).     
+0001df70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001df80: 7561 6c28 7365 6372 6574 2e69 642c 2027  ual(secret.id, '
+0001df90: 7365 6372 6574 3a7a 2729 0a0a 2020 2020  secret:z')..    
+0001dfa0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001dfb0: 7175 616c 2866 616b 655f 7363 7269 7074  qual(fake_script
+0001dfc0: 5f63 616c 6c73 2873 656c 662c 2063 6c65  _calls(self, cle
+0001dfd0: 6172 3d54 7275 6529 2c20 5b0a 2020 2020  ar=True), [.    
+0001dfe0: 2020 2020 2020 2020 5b27 7365 6372 6574          ['secret
+0001dff0: 2d67 7261 6e74 272c 2027 7365 6372 6574  -grant', 'secret
+0001e000: 3a78 272c 2027 2d2d 7265 6c61 7469 6f6e  :x', '--relation
+0001e010: 272c 2027 3132 3327 5d2c 0a20 2020 2020  ', '123'],.     
+0001e020: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
+0001e030: 6772 616e 7427 2c20 2773 6563 7265 743a  grant', 'secret:
+0001e040: 7827 2c20 272d 2d72 656c 6174 696f 6e27  x', '--relation'
+0001e050: 2c20 2732 3334 272c 2027 2d2d 756e 6974  , '234', '--unit
+0001e060: 272c 2027 6170 702f 3027 5d2c 0a20 2020  ', 'app/0'],.   
+0001e070: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
+0001e080: 742d 696e 666f 2d67 6574 272c 2027 2d2d  t-info-get', '--
+0001e090: 6c61 6265 6c27 2c20 2779 272c 2027 2d2d  label', 'y', '--
+0001e0a0: 666f 726d 6174 3d6a 736f 6e27 5d2c 0a20  format=json'],. 
+0001e0b0: 2020 2020 2020 2020 2020 205b 2773 6563             ['sec
+0001e0c0: 7265 742d 6772 616e 7427 2c20 2773 6563  ret-grant', 'sec
+0001e0d0: 7265 743a 7a27 2c20 272d 2d72 656c 6174  ret:z', '--relat
+0001e0e0: 696f 6e27 2c20 2733 3435 275d 2c0a 2020  ion', '345'],.  
+0001e0f0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+0001e100: 6620 7465 7374 5f72 6576 6f6b 6528 7365  f test_revoke(se
+0001e110: 6c66 293a 0a20 2020 2020 2020 2066 616b  lf):.        fak
+0001e120: 655f 7363 7269 7074 2873 656c 662c 2027  e_script(self, '
+0001e130: 7365 6372 6574 2d72 6576 6f6b 6527 2c20  secret-revoke', 
+0001e140: 2222 2265 7869 7420 3022 2222 290a 2020  """exit 0""").  
+0001e150: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+0001e160: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
+0001e170: 696e 666f 2d67 6574 272c 2022 2222 6563  info-get', """ec
+0001e180: 686f 2027 7b22 7a22 3a20 7b22 6c61 6265  ho '{"z": {"labe
+0001e190: 6c22 3a20 2279 222c 2022 7265 7669 7369  l": "y", "revisi
+0001e1a0: 6f6e 223a 2037 7d7d 2722 2222 290a 0a20  on": 7}}'""").. 
+0001e1b0: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
+0001e1c0: 7365 6c66 2e6d 616b 655f 7365 6372 6574  self.make_secret
+0001e1d0: 2869 643d 2778 2729 0a20 2020 2020 2020  (id='x').       
+0001e1e0: 2073 6563 7265 742e 7265 766f 6b65 2874   secret.revoke(t
+0001e1f0: 7970 6573 2e53 696d 706c 654e 616d 6573  ypes.SimpleNames
+0001e200: 7061 6365 2869 643d 3132 3329 290a 2020  pace(id=123)).  
+0001e210: 2020 2020 2020 7365 6372 6574 2e72 6576        secret.rev
+0001e220: 6f6b 6528 7479 7065 732e 5369 6d70 6c65  oke(types.Simple
+0001e230: 4e61 6d65 7370 6163 6528 6964 3d32 3334  Namespace(id=234
+0001e240: 292c 2075 6e69 743d 7479 7065 732e 5369  ), unit=types.Si
+0001e250: 6d70 6c65 4e61 6d65 7370 6163 6528 6e61  mpleNamespace(na
+0001e260: 6d65 3d27 6170 702f 3027 2929 0a0a 2020  me='app/0'))..  
+0001e270: 2020 2020 2020 2320 4966 2073 6563 7265        # If secre
+0001e280: 7420 646f 6573 6e27 7420 6861 7665 2061  t doesn't have a
+0001e290: 6e20 4944 2c20 7765 276c 6c20 7275 6e20  n ID, we'll run 
+0001e2a0: 7365 6372 6574 2d69 6e66 6f2d 6765 7420  secret-info-get 
+0001e2b0: 746f 2066 6574 6368 2069 740a 2020 2020  to fetch it.    
+0001e2c0: 2020 2020 7365 6372 6574 203d 2073 656c      secret = sel
+0001e2d0: 662e 6d61 6b65 5f73 6563 7265 7428 6c61  f.make_secret(la
+0001e2e0: 6265 6c3d 2779 2729 0a20 2020 2020 2020  bel='y').       
+0001e2f0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+0001e300: 6e65 2873 6563 7265 742e 6964 290a 2020  ne(secret.id).  
+0001e310: 2020 2020 2020 7365 6372 6574 2e72 6576        secret.rev
+0001e320: 6f6b 6528 7479 7065 732e 5369 6d70 6c65  oke(types.Simple
+0001e330: 4e61 6d65 7370 6163 6528 6964 3d33 3435  Namespace(id=345
+0001e340: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0001e350: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
+0001e360: 6574 2e69 642c 2027 7365 6372 6574 3a7a  et.id, 'secret:z
+0001e370: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+0001e380: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+0001e390: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+0001e3a0: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+0001e3b0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0001e3c0: 5b27 7365 6372 6574 2d72 6576 6f6b 6527  ['secret-revoke'
+0001e3d0: 2c20 2773 6563 7265 743a 7827 2c20 272d  , 'secret:x', '-
+0001e3e0: 2d72 656c 6174 696f 6e27 2c20 2731 3233  -relation', '123
+0001e3f0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0001e400: 5b27 7365 6372 6574 2d72 6576 6f6b 6527  ['secret-revoke'
+0001e410: 2c20 2773 6563 7265 743a 7827 2c20 272d  , 'secret:x', '-
+0001e420: 2d72 656c 6174 696f 6e27 2c20 2732 3334  -relation', '234
+0001e430: 272c 2027 2d2d 756e 6974 272c 2027 6170  ', '--unit', 'ap
+0001e440: 702f 3027 5d2c 0a20 2020 2020 2020 2020  p/0'],.         
+0001e450: 2020 205b 2773 6563 7265 742d 696e 666f     ['secret-info
+0001e460: 2d67 6574 272c 2027 2d2d 6c61 6265 6c27  -get', '--label'
+0001e470: 2c20 2779 272c 2027 2d2d 666f 726d 6174  , 'y', '--format
+0001e480: 3d6a 736f 6e27 5d2c 0a20 2020 2020 2020  =json'],.       
+0001e490: 2020 2020 205b 2773 6563 7265 742d 7265       ['secret-re
+0001e4a0: 766f 6b65 272c 2027 7365 6372 6574 3a7a  voke', 'secret:z
+0001e4b0: 272c 2027 2d2d 7265 6c61 7469 6f6e 272c  ', '--relation',
+0001e4c0: 2027 3334 3527 5d2c 0a20 2020 2020 2020   '345'],.       
+0001e4d0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+0001e4e0: 745f 7265 6d6f 7665 5f72 6576 6973 696f  t_remove_revisio
+0001e4f0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+0001e500: 2066 616b 655f 7363 7269 7074 2873 656c   fake_script(sel
+0001e510: 662c 2027 7365 6372 6574 2d72 656d 6f76  f, 'secret-remov
+0001e520: 6527 2c20 2222 2265 7869 7420 3022 2222  e', """exit 0"""
+0001e530: 290a 2020 2020 2020 2020 6661 6b65 5f73  ).        fake_s
+0001e540: 6372 6970 7428 7365 6c66 2c20 2773 6563  cript(self, 'sec
+0001e550: 7265 742d 696e 666f 2d67 6574 272c 2022  ret-info-get', "
+0001e560: 2222 6563 686f 2027 7b22 7a22 3a20 7b22  ""echo '{"z": {"
+0001e570: 6c61 6265 6c22 3a20 2279 222c 2022 7265  label": "y", "re
+0001e580: 7669 7369 6f6e 223a 2037 7d7d 2722 2222  vision": 7}}'"""
+0001e590: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
+0001e5a0: 7420 3d20 7365 6c66 2e6d 616b 655f 7365  t = self.make_se
+0001e5b0: 6372 6574 2869 643d 2778 2729 0a20 2020  cret(id='x').   
+0001e5c0: 2020 2020 2073 6563 7265 742e 7265 6d6f       secret.remo
+0001e5d0: 7665 5f72 6576 6973 696f 6e28 3132 3329  ve_revision(123)
+0001e5e0: 0a0a 2020 2020 2020 2020 2320 4966 2073  ..        # If s
+0001e5f0: 6563 7265 7420 646f 6573 6e27 7420 6861  ecret doesn't ha
+0001e600: 7665 2061 6e20 4944 2c20 7765 276c 6c20  ve an ID, we'll 
+0001e610: 7275 6e20 7365 6372 6574 2d69 6e66 6f2d  run secret-info-
+0001e620: 6765 7420 746f 2066 6574 6368 2069 740a  get to fetch it.
+0001e630: 2020 2020 2020 2020 7365 6372 6574 203d          secret =
+0001e640: 2073 656c 662e 6d61 6b65 5f73 6563 7265   self.make_secre
+0001e650: 7428 6c61 6265 6c3d 2779 2729 0a20 2020  t(label='y').   
+0001e660: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001e670: 4973 4e6f 6e65 2873 6563 7265 742e 6964  IsNone(secret.id
+0001e680: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
+0001e690: 2e72 656d 6f76 655f 7265 7669 7369 6f6e  .remove_revision
+0001e6a0: 2832 3334 290a 2020 2020 2020 2020 7365  (234).        se
+0001e6b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001e6c0: 6563 7265 742e 6964 2c20 2773 6563 7265  ecret.id, 'secre
+0001e6d0: 743a 7a27 290a 0a20 2020 2020 2020 2073  t:z')..        s
+0001e6e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001e6f0: 6661 6b65 5f73 6372 6970 745f 6361 6c6c  fake_script_call
+0001e700: 7328 7365 6c66 2c20 636c 6561 723d 5472  s(self, clear=Tr
+0001e710: 7565 292c 205b 0a20 2020 2020 2020 2020  ue), [.         
+0001e720: 2020 205b 2773 6563 7265 742d 7265 6d6f     ['secret-remo
+0001e730: 7665 272c 2027 7365 6372 6574 3a78 272c  ve', 'secret:x',
+0001e740: 2027 2d2d 7265 7669 7369 6f6e 272c 2027   '--revision', '
+0001e750: 3132 3327 5d2c 0a20 2020 2020 2020 2020  123'],.         
+0001e760: 2020 205b 2773 6563 7265 742d 696e 666f     ['secret-info
+0001e770: 2d67 6574 272c 2027 2d2d 6c61 6265 6c27  -get', '--label'
+0001e780: 2c20 2779 272c 2027 2d2d 666f 726d 6174  , 'y', '--format
+0001e790: 3d6a 736f 6e27 5d2c 0a20 2020 2020 2020  =json'],.       
+0001e7a0: 2020 2020 205b 2773 6563 7265 742d 7265       ['secret-re
+0001e7b0: 6d6f 7665 272c 2027 7365 6372 6574 3a7a  move', 'secret:z
+0001e7c0: 272c 2027 2d2d 7265 7669 7369 6f6e 272c  ', '--revision',
+0001e7d0: 2027 3233 3427 5d2c 0a20 2020 2020 2020   '234'],.       
+0001e7e0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+0001e7f0: 745f 7265 6d6f 7665 5f61 6c6c 5f72 6576  t_remove_all_rev
+0001e800: 6973 696f 6e73 2873 656c 6629 3a0a 2020  isions(self):.  
+0001e810: 2020 2020 2020 6661 6b65 5f73 6372 6970        fake_scrip
+0001e820: 7428 7365 6c66 2c20 2773 6563 7265 742d  t(self, 'secret-
+0001e830: 7265 6d6f 7665 272c 2022 2222 6578 6974  remove', """exit
+0001e840: 2030 2222 2229 0a20 2020 2020 2020 2066   0""").        f
+0001e850: 616b 655f 7363 7269 7074 2873 656c 662c  ake_script(self,
+0001e860: 2027 7365 6372 6574 2d69 6e66 6f2d 6765   'secret-info-ge
+0001e870: 7427 2c20 2222 2265 6368 6f20 277b 227a  t', """echo '{"z
+0001e880: 223a 207b 226c 6162 656c 223a 2022 7922  ": {"label": "y"
+0001e890: 2c20 2272 6576 6973 696f 6e22 3a20 377d  , "revision": 7}
+0001e8a0: 7d27 2222 2229 0a0a 2020 2020 2020 2020  }'""")..        
+0001e8b0: 7365 6372 6574 203d 2073 656c 662e 6d61  secret = self.ma
+0001e8c0: 6b65 5f73 6563 7265 7428 6964 3d27 7827  ke_secret(id='x'
+0001e8d0: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
+0001e8e0: 2e72 656d 6f76 655f 616c 6c5f 7265 7669  .remove_all_revi
+0001e8f0: 7369 6f6e 7328 290a 0a20 2020 2020 2020  sions()..       
+0001e900: 2023 2049 6620 7365 6372 6574 2064 6f65   # If secret doe
+0001e910: 736e 2774 2068 6176 6520 616e 2049 442c  sn't have an ID,
+0001e920: 2077 6527 6c6c 2072 756e 2073 6563 7265   we'll run secre
+0001e930: 742d 696e 666f 2d67 6574 2074 6f20 6665  t-info-get to fe
+0001e940: 7463 6820 6974 0a20 2020 2020 2020 2073  tch it.        s
+0001e950: 6563 7265 7420 3d20 7365 6c66 2e6d 616b  ecret = self.mak
+0001e960: 655f 7365 6372 6574 286c 6162 656c 3d27  e_secret(label='
+0001e970: 7927 290a 2020 2020 2020 2020 7365 6c66  y').        self
+0001e980: 2e61 7373 6572 7449 734e 6f6e 6528 7365  .assertIsNone(se
+0001e990: 6372 6574 2e69 6429 0a20 2020 2020 2020  cret.id).       
+0001e9a0: 2073 6563 7265 742e 7265 6d6f 7665 5f61   secret.remove_a
+0001e9b0: 6c6c 5f72 6576 6973 696f 6e73 2829 0a20  ll_revisions(). 
+0001e9c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001e9d0: 7274 4571 7561 6c28 7365 6372 6574 2e69  rtEqual(secret.i
+0001e9e0: 642c 2027 7365 6372 6574 3a7a 2729 0a0a  d, 'secret:z')..
+0001e9f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001ea00: 6572 7445 7175 616c 2866 616b 655f 7363  ertEqual(fake_sc
+0001ea10: 7269 7074 5f63 616c 6c73 2873 656c 662c  ript_calls(self,
+0001ea20: 2063 6c65 6172 3d54 7275 6529 2c20 5b0a   clear=True), [.
+0001ea30: 2020 2020 2020 2020 2020 2020 5b27 7365              ['se
+0001ea40: 6372 6574 2d72 656d 6f76 6527 2c20 2773  cret-remove', 's
+0001ea50: 6563 7265 743a 7827 5d2c 0a20 2020 2020  ecret:x'],.     
+0001ea60: 2020 2020 2020 205b 2773 6563 7265 742d         ['secret-
+0001ea70: 696e 666f 2d67 6574 272c 2027 2d2d 6c61  info-get', '--la
+0001ea80: 6265 6c27 2c20 2779 272c 2027 2d2d 666f  bel', 'y', '--fo
+0001ea90: 726d 6174 3d6a 736f 6e27 5d2c 0a20 2020  rmat=json'],.   
+0001eaa0: 2020 2020 2020 2020 205b 2773 6563 7265           ['secre
+0001eab0: 742d 7265 6d6f 7665 272c 2027 7365 6372  t-remove', 'secr
+0001eac0: 6574 3a7a 275d 2c0a 2020 2020 2020 2020  et:z'],.        
+0001ead0: 5d29 0a0a 0a63 6c61 7373 2054 6573 7450  ])...class TestP
+0001eae0: 6f72 7473 2875 6e69 7474 6573 742e 5465  orts(unittest.Te
+0001eaf0: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+0001eb00: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0001eb10: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
+0001eb20: 203d 206f 7073 2e6d 6f64 656c 2e4d 6f64   = ops.model.Mod
+0001eb30: 656c 286f 7073 2e63 6861 726d 2e43 6861  el(ops.charm.Cha
+0001eb40: 726d 4d65 7461 2829 2c20 6f70 732e 6d6f  rmMeta(), ops.mo
+0001eb50: 6465 6c2e 5f4d 6f64 656c 4261 636b 656e  del._ModelBacken
+0001eb60: 6428 276d 7961 7070 2f30 2729 290a 2020  d('myapp/0')).  
+0001eb70: 2020 2020 2020 7365 6c66 2e75 6e69 7420        self.unit 
+0001eb80: 3d20 7365 6c66 2e6d 6f64 656c 2e75 6e69  = self.model.uni
+0001eb90: 740a 0a20 2020 2064 6566 2074 6573 745f  t..    def test_
+0001eba0: 6f70 656e 5f70 6f72 7428 7365 6c66 293a  open_port(self):
+0001ebb0: 0a20 2020 2020 2020 2066 616b 655f 7363  .        fake_sc
+0001ebc0: 7269 7074 2873 656c 662c 2027 6f70 656e  ript(self, 'open
+0001ebd0: 2d70 6f72 7427 2c20 2765 7869 7420 3027  -port', 'exit 0'
+0001ebe0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001ebf0: 756e 6974 2e6f 7065 6e5f 706f 7274 2827  unit.open_port('
+0001ec00: 7463 7027 2c20 3830 3830 290a 2020 2020  tcp', 8080).    
+0001ec10: 2020 2020 7365 6c66 2e75 6e69 742e 6f70      self.unit.op
+0001ec20: 656e 5f70 6f72 7428 2755 4450 272c 2034  en_port('UDP', 4
+0001ec30: 3030 3029 0a20 2020 2020 2020 2073 656c  000).        sel
+0001ec40: 662e 756e 6974 2e6f 7065 6e5f 706f 7274  f.unit.open_port
+0001ec50: 2827 6963 6d70 2729 0a0a 2020 2020 2020  ('icmp')..      
+0001ec60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001ec70: 616c 2866 616b 655f 7363 7269 7074 5f63  al(fake_script_c
+0001ec80: 616c 6c73 2873 656c 662c 2063 6c65 6172  alls(self, clear
+0001ec90: 3d54 7275 6529 2c20 5b0a 2020 2020 2020  =True), [.      
+0001eca0: 2020 2020 2020 5b27 6f70 656e 2d70 6f72        ['open-por
+0001ecb0: 7427 2c20 2738 3038 302f 7463 7027 5d2c  t', '8080/tcp'],
+0001ecc0: 0a20 2020 2020 2020 2020 2020 205b 276f  .            ['o
+0001ecd0: 7065 6e2d 706f 7274 272c 2027 3430 3030  pen-port', '4000
+0001ece0: 2f75 6470 275d 2c0a 2020 2020 2020 2020  /udp'],.        
+0001ecf0: 2020 2020 5b27 6f70 656e 2d70 6f72 7427      ['open-port'
+0001ed00: 2c20 2769 636d 7027 5d2c 0a20 2020 2020  , 'icmp'],.     
+0001ed10: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+0001ed20: 6573 745f 6f70 656e 5f70 6f72 745f 6572  est_open_port_er
+0001ed30: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+0001ed40: 2020 2066 616b 655f 7363 7269 7074 2873     fake_script(s
+0001ed50: 656c 662c 2027 6f70 656e 2d70 6f72 7427  elf, 'open-port'
+0001ed60: 2c20 2265 6368 6f20 2745 5252 4f52 2062  , "echo 'ERROR b
+0001ed70: 6164 2070 726f 746f 636f 6c27 203e 2632  ad protocol' >&2
+0001ed80: 3b20 6578 6974 2031 2229 0a0a 2020 2020  ; exit 1")..    
+0001ed90: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0001eda0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+0001edb0: 6f64 656c 4572 726f 7229 2061 7320 636d  odelError) as cm
+0001edc0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001edd0: 6c66 2e75 6e69 742e 6f70 656e 5f70 6f72  lf.unit.open_por
+0001ede0: 7428 2766 7470 272c 2038 3038 3029 0a20  t('ftp', 8080). 
+0001edf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001ee00: 7274 4571 7561 6c28 7374 7228 636d 2e65  rtEqual(str(cm.e
+0001ee10: 7863 6570 7469 6f6e 292c 2027 4552 524f  xception), 'ERRO
+0001ee20: 5220 6261 6420 7072 6f74 6f63 6f6c 5c6e  R bad protocol\n
+0001ee30: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+0001ee40: 2e61 7373 6572 7445 7175 616c 2866 616b  .assertEqual(fak
+0001ee50: 655f 7363 7269 7074 5f63 616c 6c73 2873  e_script_calls(s
+0001ee60: 656c 662c 2063 6c65 6172 3d54 7275 6529  elf, clear=True)
+0001ee70: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0001ee80: 5b27 6f70 656e 2d70 6f72 7427 2c20 2738  ['open-port', '8
+0001ee90: 3038 302f 6674 7027 5d2c 0a20 2020 2020  080/ftp'],.     
+0001eea0: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+0001eeb0: 6573 745f 636c 6f73 655f 706f 7274 2873  est_close_port(s
+0001eec0: 656c 6629 3a0a 2020 2020 2020 2020 6661  elf):.        fa
+0001eed0: 6b65 5f73 6372 6970 7428 7365 6c66 2c20  ke_script(self, 
+0001eee0: 2763 6c6f 7365 2d70 6f72 7427 2c20 2765  'close-port', 'e
+0001eef0: 7869 7420 3027 290a 0a20 2020 2020 2020  xit 0')..       
+0001ef00: 2073 656c 662e 756e 6974 2e63 6c6f 7365   self.unit.close
+0001ef10: 5f70 6f72 7428 2774 6370 272c 2038 3038  _port('tcp', 808
+0001ef20: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+0001ef30: 756e 6974 2e63 6c6f 7365 5f70 6f72 7428  unit.close_port(
+0001ef40: 2755 4450 272c 2034 3030 3029 0a20 2020  'UDP', 4000).   
+0001ef50: 2020 2020 2073 656c 662e 756e 6974 2e63       self.unit.c
+0001ef60: 6c6f 7365 5f70 6f72 7428 2769 636d 7027  lose_port('icmp'
+0001ef70: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001ef80: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+0001ef90: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+0001efa0: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
+0001efb0: 205b 0a20 2020 2020 2020 2020 2020 205b   [.            [
+0001efc0: 2763 6c6f 7365 2d70 6f72 7427 2c20 2738  'close-port', '8
+0001efd0: 3038 302f 7463 7027 5d2c 0a20 2020 2020  080/tcp'],.     
+0001efe0: 2020 2020 2020 205b 2763 6c6f 7365 2d70         ['close-p
+0001eff0: 6f72 7427 2c20 2734 3030 302f 7564 7027  ort', '4000/udp'
+0001f000: 5d2c 0a20 2020 2020 2020 2020 2020 205b  ],.            [
+0001f010: 2763 6c6f 7365 2d70 6f72 7427 2c20 2769  'close-port', 'i
+0001f020: 636d 7027 5d2c 0a20 2020 2020 2020 205d  cmp'],.        ]
+0001f030: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001f040: 636c 6f73 655f 706f 7274 5f65 7272 6f72  close_port_error
+0001f050: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001f060: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001f070: 2c20 2763 6c6f 7365 2d70 6f72 7427 2c20  , 'close-port', 
+0001f080: 2265 6368 6f20 2745 5252 4f52 2062 6164  "echo 'ERROR bad
+0001f090: 2070 726f 746f 636f 6c27 203e 2632 3b20   protocol' >&2; 
+0001f0a0: 6578 6974 2031 2229 0a0a 2020 2020 2020  exit 1")..      
+0001f0b0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0001f0c0: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
+0001f0d0: 656c 4572 726f 7229 2061 7320 636d 3a0a  elError) as cm:.
+0001f0e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001f0f0: 2e75 6e69 742e 636c 6f73 655f 706f 7274  .unit.close_port
+0001f100: 2827 6674 7027 2c20 3830 3830 290a 2020  ('ftp', 8080).  
+0001f110: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001f120: 7445 7175 616c 2873 7472 2863 6d2e 6578  tEqual(str(cm.ex
+0001f130: 6365 7074 696f 6e29 2c20 2745 5252 4f52  ception), 'ERROR
+0001f140: 2062 6164 2070 726f 746f 636f 6c5c 6e27   bad protocol\n'
+0001f150: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001f160: 6173 7365 7274 4571 7561 6c28 6661 6b65  assertEqual(fake
+0001f170: 5f73 6372 6970 745f 6361 6c6c 7328 7365  _script_calls(se
+0001f180: 6c66 2c20 636c 6561 723d 5472 7565 292c  lf, clear=True),
+0001f190: 205b 0a20 2020 2020 2020 2020 2020 205b   [.            [
+0001f1a0: 2763 6c6f 7365 2d70 6f72 7427 2c20 2738  'close-port', '8
+0001f1b0: 3038 302f 6674 7027 5d2c 0a20 2020 2020  080/ftp'],.     
+0001f1c0: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
+0001f1d0: 6573 745f 6f70 656e 6564 5f70 6f72 7473  est_opened_ports
+0001f1e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001f1f0: 6661 6b65 5f73 6372 6970 7428 7365 6c66  fake_script(self
+0001f200: 2c20 276f 7065 6e65 642d 706f 7274 7327  , 'opened-ports'
+0001f210: 2c20 2222 2265 6368 6f20 3830 3830 2f74  , """echo 8080/t
+0001f220: 6370 3b20 6563 686f 2069 636d 7022 2222  cp; echo icmp"""
+0001f230: 290a 0a20 2020 2020 2020 2070 6f72 7473  )..        ports
+0001f240: 5f73 6574 203d 2073 656c 662e 756e 6974  _set = self.unit
+0001f250: 2e6f 7065 6e65 645f 706f 7274 7328 290a  .opened_ports().
+0001f260: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001f270: 6572 7449 7349 6e73 7461 6e63 6528 706f  ertIsInstance(po
+0001f280: 7274 735f 7365 742c 2073 6574 290a 2020  rts_set, set).  
+0001f290: 2020 2020 2020 706f 7274 7320 3d20 736f        ports = so
+0001f2a0: 7274 6564 2870 6f72 7473 5f73 6574 2c20  rted(ports_set, 
+0001f2b0: 6b65 793d 6c61 6d62 6461 2070 3a20 2870  key=lambda p: (p
+0001f2c0: 2e70 726f 746f 636f 6c2c 2070 2e70 6f72  .protocol, p.por
+0001f2d0: 7429 290a 2020 2020 2020 2020 7365 6c66  t)).        self
+0001f2e0: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+0001f2f0: 2870 6f72 7473 292c 2032 290a 2020 2020  (ports), 2).    
+0001f300: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+0001f310: 7349 6e73 7461 6e63 6528 706f 7274 735b  sInstance(ports[
+0001f320: 305d 2c20 6f70 732e 4f70 656e 6564 506f  0], ops.OpenedPo
+0001f330: 7274 290a 2020 2020 2020 2020 7365 6c66  rt).        self
+0001f340: 2e61 7373 6572 7445 7175 616c 2870 6f72  .assertEqual(por
+0001f350: 7473 5b30 5d2e 7072 6f74 6f63 6f6c 2c20  ts[0].protocol, 
+0001f360: 2769 636d 7027 290a 2020 2020 2020 2020  'icmp').        
+0001f370: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
+0001f380: 6528 706f 7274 735b 305d 2e70 6f72 7429  e(ports[0].port)
+0001f390: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001f3a0: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
+0001f3b0: 6f72 7473 5b31 5d2c 206f 7073 2e4f 7065  orts[1], ops.Ope
+0001f3c0: 6e65 6450 6f72 7429 0a20 2020 2020 2020  nedPort).       
+0001f3d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001f3e0: 6c28 706f 7274 735b 315d 2e70 726f 746f  l(ports[1].proto
+0001f3f0: 636f 6c2c 2027 7463 7027 290a 2020 2020  col, 'tcp').    
+0001f400: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001f410: 7175 616c 2870 6f72 7473 5b31 5d2e 706f  qual(ports[1].po
+0001f420: 7274 2c20 3830 3830 290a 0a20 2020 2020  rt, 8080)..     
+0001f430: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001f440: 7561 6c28 6661 6b65 5f73 6372 6970 745f  ual(fake_script_
+0001f450: 6361 6c6c 7328 7365 6c66 2c20 636c 6561  calls(self, clea
+0001f460: 723d 5472 7565 292c 205b 0a20 2020 2020  r=True), [.     
+0001f470: 2020 2020 2020 205b 276f 7065 6e65 642d         ['opened-
+0001f480: 706f 7274 7327 2c20 2727 5d2c 0a20 2020  ports', ''],.   
+0001f490: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+0001f4a0: 2074 6573 745f 6f70 656e 6564 5f70 6f72   test_opened_por
+0001f4b0: 7473 5f77 6172 6e69 6e67 7328 7365 6c66  ts_warnings(self
+0001f4c0: 293a 0a20 2020 2020 2020 2066 616b 655f  ):.        fake_
+0001f4d0: 7363 7269 7074 2873 656c 662c 2027 6f70  script(self, 'op
+0001f4e0: 656e 6564 2d70 6f72 7473 272c 2022 2222  ened-ports', """
+0001f4f0: 6563 686f 2038 3038 302f 7463 703b 2065  echo 8080/tcp; e
+0001f500: 6368 6f20 3132 3334 2f66 7470 3b20 6563  cho 1234/ftp; ec
+0001f510: 686f 2031 3030 302d 3230 3030 2f75 6470  ho 1000-2000/udp
+0001f520: 2222 2229 0a0a 2020 2020 2020 2020 7769  """)..        wi
+0001f530: 7468 2073 656c 662e 6173 7365 7274 4c6f  th self.assertLo
+0001f540: 6773 2827 6f70 732e 6d6f 6465 6c27 2c20  gs('ops.model', 
+0001f550: 6c65 7665 6c3d 2757 4152 4e49 4e47 2729  level='WARNING')
+0001f560: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
+0001f570: 2020 2020 706f 7274 735f 7365 7420 3d20      ports_set = 
+0001f580: 7365 6c66 2e75 6e69 742e 6f70 656e 6564  self.unit.opened
+0001f590: 5f70 6f72 7473 2829 0a20 2020 2020 2020  _ports().       
+0001f5a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001f5b0: 6c28 6c65 6e28 636d 2e6f 7574 7075 7429  l(len(cm.output)
+0001f5c0: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
+0001f5d0: 662e 6173 7365 7274 5265 6765 7828 636d  f.assertRegex(cm
+0001f5e0: 2e6f 7574 7075 745b 305d 2c20 7227 5741  .output[0], r'WA
+0001f5f0: 524e 494e 473a 6f70 732e 6d6f 6465 6c3a  RNING:ops.model:
+0001f600: 2e2a 7072 6f74 6f63 6f6c 2e2a 2729 0a20  .*protocol.*'). 
+0001f610: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001f620: 7274 5265 6765 7828 636d 2e6f 7574 7075  rtRegex(cm.outpu
+0001f630: 745b 315d 2c20 7227 5741 524e 494e 473a  t[1], r'WARNING:
+0001f640: 6f70 732e 6d6f 6465 6c3a 2e2a 7261 6e67  ops.model:.*rang
+0001f650: 652e 2a27 290a 0a20 2020 2020 2020 2073  e.*')..        s
+0001f660: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0001f670: 616e 6365 2870 6f72 7473 5f73 6574 2c20  ance(ports_set, 
+0001f680: 7365 7429 0a20 2020 2020 2020 2070 6f72  set).        por
+0001f690: 7473 203d 2073 6f72 7465 6428 706f 7274  ts = sorted(port
+0001f6a0: 735f 7365 742c 206b 6579 3d6c 616d 6264  s_set, key=lambd
+0001f6b0: 6120 703a 2028 702e 7072 6f74 6f63 6f6c  a p: (p.protocol
+0001f6c0: 2c20 702e 706f 7274 2929 0a20 2020 2020  , p.port)).     
+0001f6d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001f6e0: 7561 6c28 6c65 6e28 706f 7274 7329 2c20  ual(len(ports), 
+0001f6f0: 3229 0a20 2020 2020 2020 2073 656c 662e  2).        self.
+0001f700: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
+0001f710: 2870 6f72 7473 5b30 5d2c 206f 7073 2e4f  (ports[0], ops.O
+0001f720: 7065 6e65 6450 6f72 7429 0a20 2020 2020  penedPort).     
+0001f730: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001f740: 7561 6c28 706f 7274 735b 305d 2e70 726f  ual(ports[0].pro
+0001f750: 746f 636f 6c2c 2027 7463 7027 290a 2020  tocol, 'tcp').  
+0001f760: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001f770: 7445 7175 616c 2870 6f72 7473 5b30 5d2e  tEqual(ports[0].
+0001f780: 706f 7274 2c20 3830 3830 290a 2020 2020  port, 8080).    
+0001f790: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+0001f7a0: 7349 6e73 7461 6e63 6528 706f 7274 735b  sInstance(ports[
+0001f7b0: 315d 2c20 6f70 732e 4f70 656e 6564 506f  1], ops.OpenedPo
+0001f7c0: 7274 290a 2020 2020 2020 2020 7365 6c66  rt).        self
+0001f7d0: 2e61 7373 6572 7445 7175 616c 2870 6f72  .assertEqual(por
+0001f7e0: 7473 5b31 5d2e 7072 6f74 6f63 6f6c 2c20  ts[1].protocol, 
+0001f7f0: 2775 6470 2729 0a20 2020 2020 2020 2073  'udp').        s
+0001f800: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001f810: 706f 7274 735b 315d 2e70 6f72 742c 2031  ports[1].port, 1
+0001f820: 3030 3029 0a0a 2020 2020 2020 2020 7365  000)..        se
+0001f830: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+0001f840: 616b 655f 7363 7269 7074 5f63 616c 6c73  ake_script_calls
+0001f850: 2873 656c 662c 2063 6c65 6172 3d54 7275  (self, clear=Tru
+0001f860: 6529 2c20 5b0a 2020 2020 2020 2020 2020  e), [.          
+0001f870: 2020 5b27 6f70 656e 6564 2d70 6f72 7473    ['opened-ports
+0001f880: 272c 2027 275d 2c0a 2020 2020 2020 2020  ', ''],.        
+0001f890: 5d29 0a0a 0a69 6620 5f5f 6e61 6d65 5f5f  ])...if __name__
+0001f8a0: 203d 3d20 225f 5f6d 6169 6e5f 5f22 3a0a   == "__main__":.
+0001f8b0: 2020 2020 756e 6974 7465 7374 2e6d 6169      unittest.mai
+0001f8c0: 6e28 290a                                n().
```

### Comparing `ops-2.1.1/test/test_pebble.py` & `ops-2.2.0/test/test_pebble.py`

 * *Files 0% similar despite different names*

```diff
@@ -51,7726 +51,7769 @@
 00000320: 7374 2e6d 6f63 6b0a 696d 706f 7274 2075  st.mock.import u
 00000330: 6e69 7474 6573 742e 7574 696c 0a69 6d70  nittest.util.imp
 00000340: 6f72 7420 7572 6c6c 6962 2e65 7272 6f72  ort urllib.error
 00000350: 0a69 6d70 6f72 7420 7572 6c6c 6962 2e72  .import urllib.r
 00000360: 6571 7565 7374 0a69 6d70 6f72 7420 7575  equest.import uu
 00000370: 6964 0a0a 696d 706f 7274 2070 7974 6573  id..import pytes
 00000380: 740a 696d 706f 7274 2077 6562 736f 636b  t.import websock
-00000390: 6574 0a0a 696d 706f 7274 206f 7073 2e70  et..import ops.p
-000003a0: 6562 626c 6520 6173 2070 6562 626c 650a  ebble as pebble.
-000003b0: 6672 6f6d 206f 7073 2e5f 7072 6976 6174  from ops._privat
-000003c0: 6520 696d 706f 7274 2079 616d 6c0a 0a23  e import yaml..#
-000003d0: 2045 6e73 7572 6520 756e 6974 7465 7374   Ensure unittest
-000003e0: 2064 6966 6673 2064 6f6e 2774 2067 6574   diffs don't get
-000003f0: 2074 7275 6e63 6174 6564 206c 696b 6520   truncated like 
-00000400: 225b 3137 2063 6861 7273 5d22 0a75 6e69  "[17 chars]".uni
-00000410: 7474 6573 742e 7574 696c 2e5f 4d41 585f  ttest.util._MAX_
-00000420: 4c45 4e47 5448 203d 2031 3030 300a 0a0a  LENGTH = 1000...
-00000430: 6465 6620 6461 7465 7469 6d65 5f75 7463  def datetime_utc
-00000440: 2879 2c20 6d2c 2064 2c20 686f 7572 2c20  (y, m, d, hour, 
-00000450: 6d69 6e2c 2073 6563 2c20 6d69 6372 6f3d  min, sec, micro=
-00000460: 3029 3a0a 2020 2020 747a 203d 2064 6174  0):.    tz = dat
-00000470: 6574 696d 652e 7469 6d65 7a6f 6e65 2e75  etime.timezone.u
-00000480: 7463 0a20 2020 2072 6574 7572 6e20 6461  tc.    return da
-00000490: 7465 7469 6d65 2e64 6174 6574 696d 6528  tetime.datetime(
-000004a0: 792c 206d 2c20 642c 2068 6f75 722c 206d  y, m, d, hour, m
-000004b0: 696e 2c20 7365 632c 206d 6963 726f 2c20  in, sec, micro, 
-000004c0: 747a 696e 666f 3d74 7a29 0a0a 0a64 6566  tzinfo=tz)...def
-000004d0: 2064 6174 6574 696d 655f 6e7a 6474 2879   datetime_nzdt(y
-000004e0: 2c20 6d2c 2064 2c20 686f 7572 2c20 6d69  , m, d, hour, mi
-000004f0: 6e2c 2073 6563 2c20 6d69 6372 6f3d 3029  n, sec, micro=0)
-00000500: 3a0a 2020 2020 747a 203d 2064 6174 6574  :.    tz = datet
-00000510: 696d 652e 7469 6d65 7a6f 6e65 2864 6174  ime.timezone(dat
-00000520: 6574 696d 652e 7469 6d65 6465 6c74 6128  etime.timedelta(
-00000530: 686f 7572 733d 3133 2929 0a20 2020 2072  hours=13)).    r
-00000540: 6574 7572 6e20 6461 7465 7469 6d65 2e64  eturn datetime.d
-00000550: 6174 6574 696d 6528 792c 206d 2c20 642c  atetime(y, m, d,
-00000560: 2068 6f75 722c 206d 696e 2c20 7365 632c   hour, min, sec,
-00000570: 206d 6963 726f 2c20 747a 696e 666f 3d74   micro, tzinfo=t
-00000580: 7a29 0a0a 0a63 6c61 7373 2054 6573 7454  z)...class TestT
-00000590: 7970 6573 2875 6e69 7474 6573 742e 5465  ypes(unittest.Te
-000005a0: 7374 4361 7365 293a 0a20 2020 206d 6178  stCase):.    max
-000005b0: 4469 6666 203d 204e 6f6e 650a 0a20 2020  Diff = None..   
-000005c0: 2064 6566 2074 6573 745f 6572 726f 7228   def test_error(
-000005d0: 7365 6c66 293a 0a20 2020 2020 2020 2065  self):.        e
-000005e0: 7272 6f72 203d 2070 6562 626c 652e 4572  rror = pebble.Er
-000005f0: 726f 7228 2765 7272 6f72 2729 0a20 2020  ror('error').   
-00000600: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00000610: 4973 496e 7374 616e 6365 2865 7272 6f72  IsInstance(error
-00000620: 2c20 4578 6365 7074 696f 6e29 0a0a 2020  , Exception)..  
-00000630: 2020 6465 6620 7465 7374 5f74 696d 656f    def test_timeo
-00000640: 7574 5f65 7272 6f72 2873 656c 6629 3a0a  ut_error(self):.
-00000650: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
-00000660: 7065 6262 6c65 2e54 696d 656f 7574 4572  pebble.TimeoutEr
-00000670: 726f 7228 2774 696d 656f 7574 2127 290a  ror('timeout!').
-00000680: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00000690: 6572 7449 7349 6e73 7461 6e63 6528 6572  ertIsInstance(er
-000006a0: 726f 722c 2070 6562 626c 652e 4572 726f  ror, pebble.Erro
-000006b0: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
-000006c0: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
-000006d0: 2865 7272 6f72 2c20 5469 6d65 6f75 7445  (error, TimeoutE
-000006e0: 7272 6f72 290a 2020 2020 2020 2020 7365  rror).        se
-000006f0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00000700: 7472 2865 7272 6f72 292c 2027 7469 6d65  tr(error), 'time
-00000710: 6f75 7421 2729 0a0a 2020 2020 6465 6620  out!')..    def 
-00000720: 7465 7374 5f63 6f6e 6e65 6374 696f 6e5f  test_connection_
-00000730: 6572 726f 7228 7365 6c66 293a 0a20 2020  error(self):.   
-00000740: 2020 2020 2065 7272 6f72 203d 2070 6562       error = peb
-00000750: 626c 652e 436f 6e6e 6563 7469 6f6e 4572  ble.ConnectionEr
-00000760: 726f 7228 2763 6f6e 6e65 7272 2127 290a  ror('connerr!').
-00000770: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00000780: 6572 7449 7349 6e73 7461 6e63 6528 6572  ertIsInstance(er
-00000790: 726f 722c 2070 6562 626c 652e 4572 726f  ror, pebble.Erro
-000007a0: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
-000007b0: 6173 7365 7274 4571 7561 6c28 7374 7228  assertEqual(str(
-000007c0: 6572 726f 7229 2c20 2763 6f6e 6e65 7272  error), 'connerr
-000007d0: 2127 290a 0a20 2020 2064 6566 2074 6573  !')..    def tes
-000007e0: 745f 7072 6f74 6f63 6f6c 5f65 7272 6f72  t_protocol_error
-000007f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00000800: 6572 726f 7220 3d20 7065 6262 6c65 2e50  error = pebble.P
-00000810: 726f 746f 636f 6c45 7272 6f72 2827 7072  rotocolError('pr
-00000820: 6f74 6f65 7272 2127 290a 2020 2020 2020  otoerr!').      
-00000830: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-00000840: 6e73 7461 6e63 6528 6572 726f 722c 2070  nstance(error, p
-00000850: 6562 626c 652e 4572 726f 7229 0a20 2020  ebble.Error).   
-00000860: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00000870: 4571 7561 6c28 7374 7228 6572 726f 7229  Equal(str(error)
-00000880: 2c20 2770 726f 746f 6572 7221 2729 0a0a  , 'protoerr!')..
-00000890: 2020 2020 6465 6620 7465 7374 5f70 6174      def test_pat
-000008a0: 685f 6572 726f 7228 7365 6c66 293a 0a20  h_error(self):. 
-000008b0: 2020 2020 2020 2065 7272 6f72 203d 2070         error = p
-000008c0: 6562 626c 652e 5061 7468 4572 726f 7228  ebble.PathError(
-000008d0: 276e 6f74 2d66 6f75 6e64 272c 2027 7468  'not-found', 'th
-000008e0: 696e 6720 6e6f 7420 666f 756e 6427 290a  ing not found').
-000008f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00000900: 6572 7449 7349 6e73 7461 6e63 6528 6572  ertIsInstance(er
-00000910: 726f 722c 2070 6562 626c 652e 4572 726f  ror, pebble.Erro
-00000920: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
-00000930: 6173 7365 7274 4571 7561 6c28 6572 726f  assertEqual(erro
-00000940: 722e 6b69 6e64 2c20 276e 6f74 2d66 6f75  r.kind, 'not-fou
-00000950: 6e64 2729 0a20 2020 2020 2020 2073 656c  nd').        sel
-00000960: 662e 6173 7365 7274 4571 7561 6c28 6572  f.assertEqual(er
-00000970: 726f 722e 6d65 7373 6167 652c 2027 7468  ror.message, 'th
-00000980: 696e 6720 6e6f 7420 666f 756e 6427 290a  ing not found').
-00000990: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000009a0: 6572 7445 7175 616c 2873 7472 2865 7272  ertEqual(str(err
-000009b0: 6f72 292c 2027 6e6f 742d 666f 756e 6420  or), 'not-found 
-000009c0: 2d20 7468 696e 6720 6e6f 7420 666f 756e  - thing not foun
-000009d0: 6427 290a 0a20 2020 2064 6566 2074 6573  d')..    def tes
-000009e0: 745f 6170 695f 6572 726f 7228 7365 6c66  t_api_error(self
-000009f0: 293a 0a20 2020 2020 2020 2062 6f64 7920  ):.        body 
-00000a00: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00000a10: 2272 6573 756c 7422 3a20 7b0a 2020 2020  "result": {.    
-00000a20: 2020 2020 2020 2020 2020 2020 226d 6573              "mes
-00000a30: 7361 6765 223a 2022 6e6f 2073 6572 7669  sage": "no servi
-00000a40: 6365 7320 746f 2073 7461 7274 2070 726f  ces to start pro
-00000a50: 7669 6465 6422 0a20 2020 2020 2020 2020  vided".         
-00000a60: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-00000a70: 2020 2273 7461 7475 7322 3a20 2242 6164    "status": "Bad
-00000a80: 2052 6571 7565 7374 222c 0a20 2020 2020   Request",.     
-00000a90: 2020 2020 2020 2022 7374 6174 7573 2d63         "status-c
-00000aa0: 6f64 6522 3a20 3430 302c 0a20 2020 2020  ode": 400,.     
-00000ab0: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
-00000ac0: 6572 726f 7222 0a20 2020 2020 2020 207d  error".        }
-00000ad0: 0a20 2020 2020 2020 2065 7272 6f72 203d  .        error =
-00000ae0: 2070 6562 626c 652e 4150 4945 7272 6f72   pebble.APIError
-00000af0: 2862 6f64 792c 2034 3030 2c20 2242 6164  (body, 400, "Bad
-00000b00: 2052 6571 7565 7374 222c 2022 6e6f 2073   Request", "no s
-00000b10: 6572 7669 6365 7322 290a 2020 2020 2020  ervices").      
-00000b20: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-00000b30: 6e73 7461 6e63 6528 6572 726f 722c 2070  nstance(error, p
-00000b40: 6562 626c 652e 4572 726f 7229 0a20 2020  ebble.Error).   
-00000b50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00000b60: 4571 7561 6c28 6572 726f 722e 626f 6479  Equal(error.body
-00000b70: 2c20 626f 6479 290a 2020 2020 2020 2020  , body).        
-00000b80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00000b90: 2865 7272 6f72 2e63 6f64 652c 2034 3030  (error.code, 400
-00000ba0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00000bb0: 7373 6572 7445 7175 616c 2865 7272 6f72  ssertEqual(error
-00000bc0: 2e73 7461 7475 732c 2027 4261 6420 5265  .status, 'Bad Re
-00000bd0: 7175 6573 7427 290a 2020 2020 2020 2020  quest').        
-00000be0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00000bf0: 2865 7272 6f72 2e6d 6573 7361 6765 2c20  (error.message, 
-00000c00: 276e 6f20 7365 7276 6963 6573 2729 0a20  'no services'). 
-00000c10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00000c20: 7274 4571 7561 6c28 7374 7228 6572 726f  rtEqual(str(erro
-00000c30: 7229 2c20 276e 6f20 7365 7276 6963 6573  r), 'no services
-00000c40: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-00000c50: 5f63 6861 6e67 655f 6572 726f 7228 7365  _change_error(se
-00000c60: 6c66 293a 0a20 2020 2020 2020 2063 6861  lf):.        cha
-00000c70: 6e67 6520 3d20 7065 6262 6c65 2e43 6861  nge = pebble.Cha
-00000c80: 6e67 6528 0a20 2020 2020 2020 2020 2020  nge(.           
-00000c90: 2069 643d 7065 6262 6c65 2e43 6861 6e67   id=pebble.Chang
-00000ca0: 6549 4428 2731 3233 3427 292c 0a20 2020  eID('1234'),.   
-00000cb0: 2020 2020 2020 2020 206b 696e 643d 2773           kind='s
-00000cc0: 7461 7274 272c 0a20 2020 2020 2020 2020  tart',.         
-00000cd0: 2020 2073 756d 6d61 7279 3d27 5374 6172     summary='Star
-00000ce0: 7420 7365 7276 6963 6520 2266 6f6f 2227  t service "foo"'
-00000cf0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-00000d00: 6174 7573 3d27 446f 6e65 272c 0a20 2020  atus='Done',.   
-00000d10: 2020 2020 2020 2020 2074 6173 6b73 3d5b           tasks=[
-00000d20: 5d2c 0a20 2020 2020 2020 2020 2020 2072  ],.            r
-00000d30: 6561 6479 3d54 7275 652c 0a20 2020 2020  eady=True,.     
-00000d40: 2020 2020 2020 2065 7272 3d27 536f 6d65         err='Some
-00000d50: 2065 7272 6f72 272c 0a20 2020 2020 2020   error',.       
-00000d60: 2020 2020 2073 7061 776e 5f74 696d 653d       spawn_time=
-00000d70: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-00000d80: 652e 6e6f 7728 292c 0a20 2020 2020 2020  e.now(),.       
-00000d90: 2020 2020 2072 6561 6479 5f74 696d 653d       ready_time=
-00000da0: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-00000db0: 652e 6e6f 7728 292c 0a20 2020 2020 2020  e.now(),.       
-00000dc0: 2029 0a20 2020 2020 2020 2065 7272 6f72   ).        error
-00000dd0: 203d 2070 6562 626c 652e 4368 616e 6765   = pebble.Change
-00000de0: 4572 726f 7228 6368 616e 6765 2e65 7272  Error(change.err
-00000df0: 2c20 6368 616e 6765 290a 2020 2020 2020  , change).      
-00000e00: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-00000e10: 6e73 7461 6e63 6528 6572 726f 722c 2070  nstance(error, p
-00000e20: 6562 626c 652e 4572 726f 7229 0a20 2020  ebble.Error).   
-00000e30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00000e40: 4571 7561 6c28 6572 726f 722e 6572 722c  Equal(error.err,
-00000e50: 2027 536f 6d65 2065 7272 6f72 2729 0a20   'Some error'). 
-00000e60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00000e70: 7274 4571 7561 6c28 6572 726f 722e 6368  rtEqual(error.ch
-00000e80: 616e 6765 2c20 6368 616e 6765 290a 2020  ange, change).  
-00000e90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00000ea0: 7445 7175 616c 2873 7472 2865 7272 6f72  tEqual(str(error
-00000eb0: 292c 2027 536f 6d65 2065 7272 6f72 2729  ), 'Some error')
-00000ec0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-00000ed0: 6861 6e67 655f 6572 726f 725f 7769 7468  hange_error_with
-00000ee0: 5f74 6173 6b5f 6c6f 6773 2873 656c 6629  _task_logs(self)
-00000ef0: 3a0a 2020 2020 2020 2020 6368 616e 6765  :.        change
-00000f00: 203d 2070 6562 626c 652e 4368 616e 6765   = pebble.Change
-00000f10: 280a 2020 2020 2020 2020 2020 2020 6964  (.            id
-00000f20: 3d70 6562 626c 652e 4368 616e 6765 4944  =pebble.ChangeID
-00000f30: 2827 3132 3334 2729 2c0a 2020 2020 2020  ('1234'),.      
-00000f40: 2020 2020 2020 6b69 6e64 3d27 7374 6172        kind='star
-00000f50: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-00000f60: 7375 6d6d 6172 793d 2753 7461 7274 2073  summary='Start s
-00000f70: 6572 7669 6365 2022 666f 6f22 272c 0a20  ervice "foo"',. 
-00000f80: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00000f90: 733d 2744 6f6e 6527 2c0a 2020 2020 2020  s='Done',.      
-00000fa0: 2020 2020 2020 7461 736b 733d 5b0a 2020        tasks=[.  
-00000fb0: 2020 2020 2020 2020 2020 2020 2020 7065                pe
-00000fc0: 6262 6c65 2e54 6173 6b28 0a20 2020 2020  bble.Task(.     
-00000fd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00000fe0: 643d 7065 6262 6c65 2e54 6173 6b49 4428  d=pebble.TaskID(
-00000ff0: 2731 3233 3435 2729 2c0a 2020 2020 2020  '12345'),.      
-00001000: 2020 2020 2020 2020 2020 2020 2020 6b69                ki
-00001010: 6e64 3d27 7374 6172 7427 2c0a 2020 2020  nd='start',.    
-00001020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001030: 7375 6d6d 6172 793d 2753 7461 7274 2073  summary='Start s
-00001040: 6572 7669 6365 2022 666f 6f22 272c 0a20  ervice "foo"',. 
-00001050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001060: 2020 2073 7461 7475 733d 2745 7272 6f72     status='Error
-00001070: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00001080: 2020 2020 2020 206c 6f67 3d5b 274c 494e         log=['LIN
-00001090: 4531 272c 2027 4c49 4e45 3227 5d2c 0a20  E1', 'LINE2'],. 
-000010a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000010b0: 2020 2070 726f 6772 6573 733d 7065 6262     progress=pebb
-000010c0: 6c65 2e54 6173 6b50 726f 6772 6573 7328  le.TaskProgress(
-000010d0: 6c61 6265 6c3d 2766 6f6f 272c 2064 6f6e  label='foo', don
-000010e0: 653d 332c 2074 6f74 616c 3d37 292c 0a20  e=3, total=7),. 
-000010f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001100: 2020 2073 7061 776e 5f74 696d 653d 6461     spawn_time=da
-00001110: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
-00001120: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
-00001130: 2033 2c20 3237 3032 3138 292c 0a20 2020   3, 270218),.   
-00001140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001150: 2072 6561 6479 5f74 696d 653d 6461 7465   ready_time=date
-00001160: 7469 6d65 5f6e 7a64 7428 3230 3231 2c20  time_nzdt(2021, 
-00001170: 312c 2032 382c 2031 342c 2033 372c 2032  1, 28, 14, 37, 2
-00001180: 2c20 3234 3731 3538 292c 0a20 2020 2020  , 247158),.     
-00001190: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-000011a0: 2020 2020 2020 2020 2020 2020 2020 7065                pe
-000011b0: 6262 6c65 2e54 6173 6b28 0a20 2020 2020  bble.Task(.     
-000011c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000011d0: 643d 7065 6262 6c65 2e54 6173 6b49 4428  d=pebble.TaskID(
-000011e0: 2731 3233 3436 2729 2c0a 2020 2020 2020  '12346'),.      
-000011f0: 2020 2020 2020 2020 2020 2020 2020 6b69                ki
-00001200: 6e64 3d27 7374 6172 7427 2c0a 2020 2020  nd='start',.    
-00001210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001220: 7375 6d6d 6172 793d 2753 7461 7274 2073  summary='Start s
-00001230: 6572 7669 6365 2022 6261 7222 272c 0a20  ervice "bar"',. 
-00001240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001250: 2020 2073 7461 7475 733d 2745 7272 6f72     status='Error
-00001260: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00001270: 2020 2020 2020 206c 6f67 3d5b 5d2c 0a20         log=[],. 
-00001280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001290: 2020 2070 726f 6772 6573 733d 7065 6262     progress=pebb
-000012a0: 6c65 2e54 6173 6b50 726f 6772 6573 7328  le.TaskProgress(
-000012b0: 6c61 6265 6c3d 2766 6f6f 272c 2064 6f6e  label='foo', don
-000012c0: 653d 332c 2074 6f74 616c 3d37 292c 0a20  e=3, total=7),. 
-000012d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000012e0: 2020 2073 7061 776e 5f74 696d 653d 6461     spawn_time=da
-000012f0: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
-00001300: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
-00001310: 2033 2c20 3237 3032 3138 292c 0a20 2020   3, 270218),.   
-00001320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001330: 2072 6561 6479 5f74 696d 653d 6461 7465   ready_time=date
-00001340: 7469 6d65 5f6e 7a64 7428 3230 3231 2c20  time_nzdt(2021, 
-00001350: 312c 2032 382c 2031 342c 2033 372c 2032  1, 28, 14, 37, 2
-00001360: 2c20 3234 3731 3538 292c 0a20 2020 2020  , 247158),.     
-00001370: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00001380: 2020 2020 2020 2020 2020 2020 2020 7065                pe
-00001390: 6262 6c65 2e54 6173 6b28 0a20 2020 2020  bble.Task(.     
-000013a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000013b0: 643d 7065 6262 6c65 2e54 6173 6b49 4428  d=pebble.TaskID(
-000013c0: 2731 3233 3437 2729 2c0a 2020 2020 2020  '12347'),.      
-000013d0: 2020 2020 2020 2020 2020 2020 2020 6b69                ki
-000013e0: 6e64 3d27 7374 6172 7427 2c0a 2020 2020  nd='start',.    
-000013f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001400: 7375 6d6d 6172 793d 2753 7461 7274 2073  summary='Start s
-00001410: 6572 7669 6365 2022 6261 7a7a 2227 2c0a  ervice "bazz"',.
-00001420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001430: 2020 2020 7374 6174 7573 3d27 4572 726f      status='Erro
-00001440: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
-00001450: 2020 2020 2020 2020 6c6f 673d 5b27 7369          log=['si
-00001460: 6e67 6c65 206c 6f67 275d 2c0a 2020 2020  ngle log'],.    
-00001470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001480: 7072 6f67 7265 7373 3d70 6562 626c 652e  progress=pebble.
-00001490: 5461 736b 5072 6f67 7265 7373 286c 6162  TaskProgress(lab
-000014a0: 656c 3d27 666f 6f27 2c20 646f 6e65 3d33  el='foo', done=3
-000014b0: 2c20 746f 7461 6c3d 3729 2c0a 2020 2020  , total=7),.    
-000014c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000014d0: 7370 6177 6e5f 7469 6d65 3d64 6174 6574  spawn_time=datet
-000014e0: 696d 655f 6e7a 6474 2832 3032 312c 2031  ime_nzdt(2021, 1
-000014f0: 2c20 3238 2c20 3134 2c20 3337 2c20 332c  , 28, 14, 37, 3,
-00001500: 2032 3730 3231 3829 2c0a 2020 2020 2020   270218),.      
-00001510: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00001520: 6164 795f 7469 6d65 3d64 6174 6574 696d  ady_time=datetim
-00001530: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
-00001540: 3238 2c20 3134 2c20 3337 2c20 322c 2032  28, 14, 37, 2, 2
-00001550: 3437 3135 3829 2c0a 2020 2020 2020 2020  47158),.        
-00001560: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-00001570: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00001580: 2020 2020 2020 7265 6164 793d 5472 7565        ready=True
-00001590: 2c0a 2020 2020 2020 2020 2020 2020 6572  ,.            er
-000015a0: 723d 2753 6f6d 6520 6572 726f 7227 2c0a  r='Some error',.
-000015b0: 2020 2020 2020 2020 2020 2020 7370 6177              spaw
-000015c0: 6e5f 7469 6d65 3d64 6174 6574 696d 652e  n_time=datetime.
-000015d0: 6461 7465 7469 6d65 2e6e 6f77 2829 2c0a  datetime.now(),.
-000015e0: 2020 2020 2020 2020 2020 2020 7265 6164              read
-000015f0: 795f 7469 6d65 3d64 6174 6574 696d 652e  y_time=datetime.
-00001600: 6461 7465 7469 6d65 2e6e 6f77 2829 2c0a  datetime.now(),.
-00001610: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00001620: 2020 6572 726f 7220 3d20 7065 6262 6c65    error = pebble
-00001630: 2e43 6861 6e67 6545 7272 6f72 2863 6861  .ChangeError(cha
-00001640: 6e67 652e 6572 722c 2063 6861 6e67 6529  nge.err, change)
-00001650: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00001660: 7365 7274 4973 496e 7374 616e 6365 2865  sertIsInstance(e
-00001670: 7272 6f72 2c20 7065 6262 6c65 2e45 7272  rror, pebble.Err
-00001680: 6f72 290a 2020 2020 2020 2020 7365 6c66  or).        self
-00001690: 2e61 7373 6572 7445 7175 616c 2865 7272  .assertEqual(err
-000016a0: 6f72 2e65 7272 2c20 2753 6f6d 6520 6572  or.err, 'Some er
-000016b0: 726f 7227 290a 2020 2020 2020 2020 7365  ror').        se
-000016c0: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-000016d0: 7272 6f72 2e63 6861 6e67 652c 2063 6861  rror.change, cha
-000016e0: 6e67 6529 0a20 2020 2020 2020 2073 656c  nge).        sel
-000016f0: 662e 6173 7365 7274 4571 7561 6c28 7374  f.assertEqual(st
-00001700: 7228 6572 726f 7229 2c20 2222 2253 6f6d  r(error), """Som
-00001710: 6520 6572 726f 720a 2d2d 2d2d 2d20 4c6f  e error.----- Lo
-00001720: 6773 2066 726f 6d20 7461 736b 2030 202d  gs from task 0 -
-00001730: 2d2d 2d2d 0a4c 494e 4531 0a4c 494e 4532  ----.LINE1.LINE2
-00001740: 0a2d 2d2d 2d2d 204c 6f67 7320 6672 6f6d  .----- Logs from
-00001750: 2074 6173 6b20 3220 2d2d 2d2d 2d0a 7369   task 2 -----.si
-00001760: 6e67 6c65 206c 6f67 0a2d 2d2d 2d2d 2222  ngle log.-----""
-00001770: 2229 0a0a 2020 2020 6465 6620 7465 7374  ")..    def test
-00001780: 5f77 6172 6e69 6e67 5f73 7461 7465 2873  _warning_state(s
-00001790: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-000017a0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-000017b0: 6973 7428 7065 6262 6c65 2e57 6172 6e69  ist(pebble.Warni
-000017c0: 6e67 5374 6174 6529 2c20 5b0a 2020 2020  ngState), [.    
-000017d0: 2020 2020 2020 2020 7065 6262 6c65 2e57          pebble.W
-000017e0: 6172 6e69 6e67 5374 6174 652e 414c 4c2c  arningState.ALL,
-000017f0: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
-00001800: 626c 652e 5761 726e 696e 6753 7461 7465  ble.WarningState
-00001810: 2e50 454e 4449 4e47 2c0a 2020 2020 2020  .PENDING,.      
-00001820: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
-00001830: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00001840: 6262 6c65 2e57 6172 6e69 6e67 5374 6174  bble.WarningStat
-00001850: 652e 414c 4c2e 7661 6c75 652c 2027 616c  e.ALL.value, 'al
-00001860: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
-00001870: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-00001880: 626c 652e 5761 726e 696e 6753 7461 7465  ble.WarningState
-00001890: 2e50 454e 4449 4e47 2e76 616c 7565 2c20  .PENDING.value, 
-000018a0: 2770 656e 6469 6e67 2729 0a0a 2020 2020  'pending')..    
-000018b0: 6465 6620 7465 7374 5f63 6861 6e67 655f  def test_change_
-000018c0: 7374 6174 6528 7365 6c66 293a 0a20 2020  state(self):.   
-000018d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000018e0: 4571 7561 6c28 6c69 7374 2870 6562 626c  Equal(list(pebbl
-000018f0: 652e 4368 616e 6765 5374 6174 6529 2c20  e.ChangeState), 
-00001900: 5b0a 2020 2020 2020 2020 2020 2020 7065  [.            pe
-00001910: 6262 6c65 2e43 6861 6e67 6553 7461 7465  bble.ChangeState
-00001920: 2e41 4c4c 2c0a 2020 2020 2020 2020 2020  .ALL,.          
-00001930: 2020 7065 6262 6c65 2e43 6861 6e67 6553    pebble.ChangeS
-00001940: 7461 7465 2e49 4e5f 5052 4f47 5245 5353  tate.IN_PROGRESS
-00001950: 2c0a 2020 2020 2020 2020 2020 2020 7065  ,.            pe
-00001960: 6262 6c65 2e43 6861 6e67 6553 7461 7465  bble.ChangeState
-00001970: 2e52 4541 4459 2c0a 2020 2020 2020 2020  .READY,.        
-00001980: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-00001990: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
-000019a0: 6c65 2e43 6861 6e67 6553 7461 7465 2e41  le.ChangeState.A
-000019b0: 4c4c 2e76 616c 7565 2c20 2761 6c6c 2729  LL.value, 'all')
-000019c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000019d0: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
-000019e0: 2e43 6861 6e67 6553 7461 7465 2e49 4e5f  .ChangeState.IN_
-000019f0: 5052 4f47 5245 5353 2e76 616c 7565 2c20  PROGRESS.value, 
-00001a00: 2769 6e2d 7072 6f67 7265 7373 2729 0a20  'in-progress'). 
-00001a10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00001a20: 7274 4571 7561 6c28 7065 6262 6c65 2e43  rtEqual(pebble.C
-00001a30: 6861 6e67 6553 7461 7465 2e52 4541 4459  hangeState.READY
-00001a40: 2e76 616c 7565 2c20 2772 6561 6479 2729  .value, 'ready')
-00001a50: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-00001a60: 7973 7465 6d5f 696e 666f 5f69 6e69 7428  ystem_info_init(
-00001a70: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-00001a80: 6e66 6f20 3d20 7065 6262 6c65 2e53 7973  nfo = pebble.Sys
-00001a90: 7465 6d49 6e66 6f28 7665 7273 696f 6e3d  temInfo(version=
-00001aa0: 2731 2e32 2e33 2729 0a20 2020 2020 2020  '1.2.3').       
-00001ab0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00001ac0: 6c28 696e 666f 2e76 6572 7369 6f6e 2c20  l(info.version, 
-00001ad0: 2731 2e32 2e33 2729 0a0a 2020 2020 6465  '1.2.3')..    de
-00001ae0: 6620 7465 7374 5f73 7973 7465 6d5f 696e  f test_system_in
-00001af0: 666f 5f66 726f 6d5f 6469 6374 2873 656c  fo_from_dict(sel
-00001b00: 6629 3a0a 2020 2020 2020 2020 696e 666f  f):.        info
-00001b10: 203d 2070 6562 626c 652e 5379 7374 656d   = pebble.System
-00001b20: 496e 666f 2e66 726f 6d5f 6469 6374 287b  Info.from_dict({
-00001b30: 2776 6572 7369 6f6e 273a 2027 332e 322e  'version': '3.2.
-00001b40: 3127 7d29 0a20 2020 2020 2020 2073 656c  1'}).        sel
-00001b50: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-00001b60: 666f 2e76 6572 7369 6f6e 2c20 2733 2e32  fo.version, '3.2
-00001b70: 2e31 2729 0a0a 2020 2020 6465 6620 7465  .1')..    def te
-00001b80: 7374 5f77 6172 6e69 6e67 5f69 6e69 7428  st_warning_init(
-00001b90: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-00001ba0: 6172 6e69 6e67 203d 2070 6562 626c 652e  arning = pebble.
-00001bb0: 5761 726e 696e 6728 0a20 2020 2020 2020  Warning(.       
-00001bc0: 2020 2020 206d 6573 7361 6765 3d27 4265       message='Be
-00001bd0: 7761 7265 2127 2c0a 2020 2020 2020 2020  ware!',.        
-00001be0: 2020 2020 6669 7273 745f 6164 6465 643d      first_added=
-00001bf0: 6461 7465 7469 6d65 5f75 7463 2832 3032  datetime_utc(202
-00001c00: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-00001c10: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
-00001c20: 6173 745f 6164 6465 643d 6461 7465 7469  ast_added=dateti
-00001c30: 6d65 5f75 7463 2832 3032 312c 2031 2c20  me_utc(2021, 1, 
-00001c40: 3236 2c20 322c 2033 2c20 3429 2c0a 2020  26, 2, 3, 4),.  
-00001c50: 2020 2020 2020 2020 2020 6c61 7374 5f73            last_s
-00001c60: 686f 776e 3d4e 6f6e 652c 0a20 2020 2020  hown=None,.     
-00001c70: 2020 2020 2020 2065 7870 6972 655f 6166         expire_af
-00001c80: 7465 723d 2731 7327 2c0a 2020 2020 2020  ter='1s',.      
-00001c90: 2020 2020 2020 7265 7065 6174 5f61 6674        repeat_aft
-00001ca0: 6572 3d27 3273 272c 0a20 2020 2020 2020  er='2s',.       
-00001cb0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-00001cc0: 6173 7365 7274 4571 7561 6c28 7761 726e  assertEqual(warn
-00001cd0: 696e 672e 6d65 7373 6167 652c 2027 4265  ing.message, 'Be
-00001ce0: 7761 7265 2127 290a 2020 2020 2020 2020  ware!').        
-00001cf0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00001d00: 2877 6172 6e69 6e67 2e66 6972 7374 5f61  (warning.first_a
-00001d10: 6464 6564 2c20 6461 7465 7469 6d65 5f75  dded, datetime_u
-00001d20: 7463 2832 3032 312c 2031 2c20 312c 2031  tc(2021, 1, 1, 1
-00001d30: 2c20 312c 2031 2929 0a20 2020 2020 2020  , 1, 1)).       
-00001d40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00001d50: 6c28 7761 726e 696e 672e 6c61 7374 5f61  l(warning.last_a
-00001d60: 6464 6564 2c20 6461 7465 7469 6d65 5f75  dded, datetime_u
-00001d70: 7463 2832 3032 312c 2031 2c20 3236 2c20  tc(2021, 1, 26, 
-00001d80: 322c 2033 2c20 3429 290a 2020 2020 2020  2, 3, 4)).      
-00001d90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00001da0: 616c 2877 6172 6e69 6e67 2e6c 6173 745f  al(warning.last_
-00001db0: 7368 6f77 6e2c 204e 6f6e 6529 0a20 2020  shown, None).   
-00001dc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00001dd0: 4571 7561 6c28 7761 726e 696e 672e 6578  Equal(warning.ex
-00001de0: 7069 7265 5f61 6674 6572 2c20 2731 7327  pire_after, '1s'
-00001df0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00001e00: 7373 6572 7445 7175 616c 2877 6172 6e69  ssertEqual(warni
-00001e10: 6e67 2e72 6570 6561 745f 6166 7465 722c  ng.repeat_after,
-00001e20: 2027 3273 2729 0a0a 2020 2020 6465 6620   '2s')..    def 
-00001e30: 7465 7374 5f77 6172 6e69 6e67 5f66 726f  test_warning_fro
-00001e40: 6d5f 6469 6374 2873 656c 6629 3a0a 2020  m_dict(self):.  
-00001e50: 2020 2020 2020 6420 3d20 7b0a 2020 2020        d = {.    
-00001e60: 2020 2020 2020 2020 276d 6573 7361 6765          'message
-00001e70: 273a 2027 4c6f 6f6b 206f 7574 2e2e 2e27  ': 'Look out...'
-00001e80: 2c0a 2020 2020 2020 2020 2020 2020 2766  ,.            'f
-00001e90: 6972 7374 2d61 6464 6564 273a 2027 3230  irst-added': '20
-00001ea0: 3230 2d31 322d 3235 5431 373a 3138 3a35  20-12-25T17:18:5
-00001eb0: 342e 3031 3632 3733 3737 382b 3133 3a30  4.016273778+13:0
-00001ec0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00001ed0: 276c 6173 742d 6164 6465 6427 3a20 2732  'last-added': '2
-00001ee0: 3032 312d 3031 2d32 3654 3137 3a30 313a  021-01-26T17:01:
-00001ef0: 3032 2e31 3233 3435 2b31 333a 3030 272c  02.12345+13:00',
-00001f00: 0a20 2020 2020 2020 2020 2020 2027 6578  .            'ex
-00001f10: 7069 7265 2d61 6674 6572 273a 2027 3173  pire-after': '1s
-00001f20: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00001f30: 7265 7065 6174 2d61 6674 6572 273a 2027  repeat-after': '
-00001f40: 3273 272c 0a20 2020 2020 2020 207d 0a20  2s',.        }. 
-00001f50: 2020 2020 2020 2077 6172 6e69 6e67 203d         warning =
-00001f60: 2070 6562 626c 652e 5761 726e 696e 672e   pebble.Warning.
-00001f70: 6672 6f6d 5f64 6963 7428 6429 0a20 2020  from_dict(d).   
-00001f80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00001f90: 4571 7561 6c28 7761 726e 696e 672e 6d65  Equal(warning.me
-00001fa0: 7373 6167 652c 2027 4c6f 6f6b 206f 7574  ssage, 'Look out
-00001fb0: 2e2e 2e27 290a 2020 2020 2020 2020 7365  ...').        se
-00001fc0: 6c66 2e61 7373 6572 7445 7175 616c 2877  lf.assertEqual(w
-00001fd0: 6172 6e69 6e67 2e66 6972 7374 5f61 6464  arning.first_add
-00001fe0: 6564 2c20 6461 7465 7469 6d65 5f6e 7a64  ed, datetime_nzd
-00001ff0: 7428 3230 3230 2c20 3132 2c20 3235 2c20  t(2020, 12, 25, 
-00002000: 3137 2c20 3138 2c20 3534 2c20 3136 3237  17, 18, 54, 1627
-00002010: 3429 290a 2020 2020 2020 2020 7365 6c66  4)).        self
-00002020: 2e61 7373 6572 7445 7175 616c 2877 6172  .assertEqual(war
-00002030: 6e69 6e67 2e6c 6173 745f 6164 6465 642c  ning.last_added,
-00002040: 2064 6174 6574 696d 655f 6e7a 6474 2832   datetime_nzdt(2
-00002050: 3032 312c 2031 2c20 3236 2c20 3137 2c20  021, 1, 26, 17, 
-00002060: 312c 2032 2c20 3132 3334 3530 2929 0a20  1, 2, 123450)). 
-00002070: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00002080: 7274 4571 7561 6c28 7761 726e 696e 672e  rtEqual(warning.
-00002090: 6c61 7374 5f73 686f 776e 2c20 4e6f 6e65  last_shown, None
-000020a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000020b0: 7373 6572 7445 7175 616c 2877 6172 6e69  ssertEqual(warni
-000020c0: 6e67 2e65 7870 6972 655f 6166 7465 722c  ng.expire_after,
-000020d0: 2027 3173 2729 0a20 2020 2020 2020 2073   '1s').        s
-000020e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000020f0: 7761 726e 696e 672e 7265 7065 6174 5f61  warning.repeat_a
-00002100: 6674 6572 2c20 2732 7327 290a 0a20 2020  fter, '2s')..   
-00002110: 2020 2020 2064 5b27 6c61 7374 2d73 686f       d['last-sho
-00002120: 776e 275d 203d 204e 6f6e 650a 2020 2020  wn'] = None.    
-00002130: 2020 2020 7761 726e 696e 6720 3d20 7065      warning = pe
-00002140: 6262 6c65 2e57 6172 6e69 6e67 2e66 726f  bble.Warning.fro
-00002150: 6d5f 6469 6374 2864 290a 2020 2020 2020  m_dict(d).      
-00002160: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00002170: 616c 2877 6172 6e69 6e67 2e6c 6173 745f  al(warning.last_
-00002180: 7368 6f77 6e2c 204e 6f6e 6529 0a0a 2020  shown, None)..  
-00002190: 2020 2020 2020 645b 276c 6173 742d 7368        d['last-sh
-000021a0: 6f77 6e27 5d20 3d20 2732 3032 312d 3038  own'] = '2021-08
-000021b0: 2d30 3454 3033 3a30 323a 3031 2e30 3030  -04T03:02:01.000
-000021c0: 3030 3030 3030 2b31 333a 3030 270a 2020  000000+13:00'.  
-000021d0: 2020 2020 2020 7761 726e 696e 6720 3d20        warning = 
-000021e0: 7065 6262 6c65 2e57 6172 6e69 6e67 2e66  pebble.Warning.f
-000021f0: 726f 6d5f 6469 6374 2864 290a 2020 2020  rom_dict(d).    
-00002200: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00002210: 7175 616c 2877 6172 6e69 6e67 2e6c 6173  qual(warning.las
-00002220: 745f 7368 6f77 6e2c 2064 6174 6574 696d  t_shown, datetim
-00002230: 655f 6e7a 6474 2832 3032 312c 2038 2c20  e_nzdt(2021, 8, 
-00002240: 342c 2033 2c20 322c 2031 2929 0a0a 2020  4, 3, 2, 1))..  
-00002250: 2020 2020 2020 645b 2766 6972 7374 2d61        d['first-a
-00002260: 6464 6564 275d 203d 2027 3230 3230 2d30  dded'] = '2020-0
-00002270: 322d 3033 5430 323a 3030 3a34 302e 3030  2-03T02:00:40.00
-00002280: 3030 3030 2b30 303a 3030 270a 2020 2020  0000+00:00'.    
-00002290: 2020 2020 645b 276c 6173 742d 6164 6465      d['last-adde
-000022a0: 6427 5d20 3d20 2732 3032 312d 3033 2d30  d'] = '2021-03-0
-000022b0: 3454 3033 3a30 313a 3431 2e31 3030 3030  4T03:01:41.10000
-000022c0: 302b 3030 3a30 3027 0a20 2020 2020 2020  0+00:00'.       
-000022d0: 2064 5b27 6c61 7374 2d73 686f 776e 275d   d['last-shown']
-000022e0: 203d 2027 3230 3232 2d30 342d 3035 5430   = '2022-04-05T0
-000022f0: 363a 3032 3a34 322e 3230 3030 3030 2b30  6:02:42.200000+0
-00002300: 303a 3030 270a 2020 2020 2020 2020 7761  0:00'.        wa
-00002310: 726e 696e 6720 3d20 7065 6262 6c65 2e57  rning = pebble.W
-00002320: 6172 6e69 6e67 2e66 726f 6d5f 6469 6374  arning.from_dict
-00002330: 2864 290a 2020 2020 2020 2020 7365 6c66  (d).        self
-00002340: 2e61 7373 6572 7445 7175 616c 2877 6172  .assertEqual(war
-00002350: 6e69 6e67 2e66 6972 7374 5f61 6464 6564  ning.first_added
-00002360: 2c20 6461 7465 7469 6d65 5f75 7463 2832  , datetime_utc(2
-00002370: 3032 302c 2032 2c20 332c 2032 2c20 302c  020, 2, 3, 2, 0,
-00002380: 2034 302c 2030 2929 0a20 2020 2020 2020   40, 0)).       
-00002390: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000023a0: 6c28 7761 726e 696e 672e 6c61 7374 5f61  l(warning.last_a
-000023b0: 6464 6564 2c20 6461 7465 7469 6d65 5f75  dded, datetime_u
-000023c0: 7463 2832 3032 312c 2033 2c20 342c 2033  tc(2021, 3, 4, 3
-000023d0: 2c20 312c 2034 312c 2031 3030 3030 3029  , 1, 41, 100000)
-000023e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000023f0: 7373 6572 7445 7175 616c 2877 6172 6e69  ssertEqual(warni
-00002400: 6e67 2e6c 6173 745f 7368 6f77 6e2c 2064  ng.last_shown, d
-00002410: 6174 6574 696d 655f 7574 6328 3230 3232  atetime_utc(2022
-00002420: 2c20 342c 2035 2c20 362c 2032 2c20 3432  , 4, 5, 6, 2, 42
-00002430: 2c20 3230 3030 3030 2929 0a0a 2020 2020  , 200000))..    
-00002440: 6465 6620 7465 7374 5f74 6173 6b5f 7072  def test_task_pr
-00002450: 6f67 7265 7373 5f69 6e69 7428 7365 6c66  ogress_init(self
-00002460: 293a 0a20 2020 2020 2020 2074 7020 3d20  ):.        tp = 
-00002470: 7065 6262 6c65 2e54 6173 6b50 726f 6772  pebble.TaskProgr
-00002480: 6573 7328 6c61 6265 6c3d 2766 6f6f 272c  ess(label='foo',
-00002490: 2064 6f6e 653d 332c 2074 6f74 616c 3d37   done=3, total=7
-000024a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000024b0: 7373 6572 7445 7175 616c 2874 702e 6c61  ssertEqual(tp.la
-000024c0: 6265 6c2c 2027 666f 6f27 290a 2020 2020  bel, 'foo').    
-000024d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000024e0: 7175 616c 2874 702e 646f 6e65 2c20 3329  qual(tp.done, 3)
-000024f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00002500: 7365 7274 4571 7561 6c28 7470 2e74 6f74  sertEqual(tp.tot
-00002510: 616c 2c20 3729 0a0a 2020 2020 6465 6620  al, 7)..    def 
-00002520: 7465 7374 5f74 6173 6b5f 7072 6f67 7265  test_task_progre
-00002530: 7373 5f66 726f 6d5f 6469 6374 2873 656c  ss_from_dict(sel
-00002540: 6629 3a0a 2020 2020 2020 2020 7470 203d  f):.        tp =
-00002550: 2070 6562 626c 652e 5461 736b 5072 6f67   pebble.TaskProg
-00002560: 7265 7373 2e66 726f 6d5f 6469 6374 287b  ress.from_dict({
-00002570: 0a20 2020 2020 2020 2020 2020 2027 6c61  .            'la
-00002580: 6265 6c27 3a20 2766 6f6f 272c 0a20 2020  bel': 'foo',.   
-00002590: 2020 2020 2020 2020 2027 646f 6e65 273a           'done':
-000025a0: 2033 2c0a 2020 2020 2020 2020 2020 2020   3,.            
-000025b0: 2774 6f74 616c 273a 2037 2c0a 2020 2020  'total': 7,.    
-000025c0: 2020 2020 7d29 0a20 2020 2020 2020 2073      }).        s
-000025d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000025e0: 7470 2e6c 6162 656c 2c20 2766 6f6f 2729  tp.label, 'foo')
-000025f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00002600: 7365 7274 4571 7561 6c28 7470 2e64 6f6e  sertEqual(tp.don
-00002610: 652c 2033 290a 2020 2020 2020 2020 7365  e, 3).        se
-00002620: 6c66 2e61 7373 6572 7445 7175 616c 2874  lf.assertEqual(t
-00002630: 702e 746f 7461 6c2c 2037 290a 0a20 2020  p.total, 7)..   
-00002640: 2064 6566 2074 6573 745f 7461 736b 5f69   def test_task_i
-00002650: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00002660: 2074 6173 6b5f 6964 203d 2070 6562 626c   task_id = pebbl
-00002670: 652e 5461 736b 4944 2827 3132 3334 2729  e.TaskID('1234')
-00002680: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00002690: 7365 7274 4571 7561 6c28 7461 736b 5f69  sertEqual(task_i
-000026a0: 642c 2027 3132 3334 2729 0a0a 2020 2020  d, '1234')..    
-000026b0: 6465 6620 7465 7374 5f74 6173 6b5f 696e  def test_task_in
-000026c0: 6974 2873 656c 6629 3a0a 2020 2020 2020  it(self):.      
-000026d0: 2020 7461 736b 203d 2070 6562 626c 652e    task = pebble.
-000026e0: 5461 736b 280a 2020 2020 2020 2020 2020  Task(.          
-000026f0: 2020 6964 3d70 6562 626c 652e 5461 736b    id=pebble.Task
-00002700: 4944 2827 3432 2729 2c0a 2020 2020 2020  ID('42'),.      
-00002710: 2020 2020 2020 6b69 6e64 3d27 7374 6172        kind='star
-00002720: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-00002730: 7375 6d6d 6172 793d 2753 7461 7274 2073  summary='Start s
-00002740: 6572 7669 6365 2022 7376 6322 272c 0a20  ervice "svc"',. 
-00002750: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00002760: 733d 2744 6f6e 6527 2c0a 2020 2020 2020  s='Done',.      
-00002770: 2020 2020 2020 6c6f 673d 5b5d 2c0a 2020        log=[],.  
-00002780: 2020 2020 2020 2020 2020 7072 6f67 7265            progre
-00002790: 7373 3d70 6562 626c 652e 5461 736b 5072  ss=pebble.TaskPr
-000027a0: 6f67 7265 7373 286c 6162 656c 3d27 666f  ogress(label='fo
-000027b0: 6f27 2c20 646f 6e65 3d33 2c20 746f 7461  o', done=3, tota
-000027c0: 6c3d 3729 2c0a 2020 2020 2020 2020 2020  l=7),.          
-000027d0: 2020 7370 6177 6e5f 7469 6d65 3d64 6174    spawn_time=dat
-000027e0: 6574 696d 655f 6e7a 6474 2832 3032 312c  etime_nzdt(2021,
-000027f0: 2031 2c20 3238 2c20 3134 2c20 3337 2c20   1, 28, 14, 37, 
-00002800: 332c 2032 3730 3231 3829 2c0a 2020 2020  3, 270218),.    
-00002810: 2020 2020 2020 2020 7265 6164 795f 7469          ready_ti
-00002820: 6d65 3d64 6174 6574 696d 655f 6e7a 6474  me=datetime_nzdt
-00002830: 2832 3032 312c 2031 2c20 3238 2c20 3134  (2021, 1, 28, 14
-00002840: 2c20 3337 2c20 322c 2032 3437 3135 3829  , 37, 2, 247158)
-00002850: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00002860: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00002870: 7175 616c 2874 6173 6b2e 6964 2c20 2734  qual(task.id, '4
-00002880: 3227 290a 2020 2020 2020 2020 7365 6c66  2').        self
-00002890: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
-000028a0: 6b2e 6b69 6e64 2c20 2773 7461 7274 2729  k.kind, 'start')
-000028b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000028c0: 7365 7274 4571 7561 6c28 7461 736b 2e73  sertEqual(task.s
-000028d0: 756d 6d61 7279 2c20 2753 7461 7274 2073  ummary, 'Start s
-000028e0: 6572 7669 6365 2022 7376 6322 2729 0a20  ervice "svc"'). 
-000028f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00002900: 7274 4571 7561 6c28 7461 736b 2e73 7461  rtEqual(task.sta
-00002910: 7475 732c 2027 446f 6e65 2729 0a20 2020  tus, 'Done').   
-00002920: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00002930: 4571 7561 6c28 7461 736b 2e6c 6f67 2c20  Equal(task.log, 
-00002940: 5b5d 290a 2020 2020 2020 2020 7365 6c66  []).        self
-00002950: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
-00002960: 6b2e 7072 6f67 7265 7373 2e6c 6162 656c  k.progress.label
-00002970: 2c20 2766 6f6f 2729 0a20 2020 2020 2020  , 'foo').       
-00002980: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00002990: 6c28 7461 736b 2e70 726f 6772 6573 732e  l(task.progress.
-000029a0: 646f 6e65 2c20 3329 0a20 2020 2020 2020  done, 3).       
-000029b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000029c0: 6c28 7461 736b 2e70 726f 6772 6573 732e  l(task.progress.
-000029d0: 746f 7461 6c2c 2037 290a 2020 2020 2020  total, 7).      
-000029e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000029f0: 616c 2874 6173 6b2e 7370 6177 6e5f 7469  al(task.spawn_ti
-00002a00: 6d65 2c20 6461 7465 7469 6d65 5f6e 7a64  me, datetime_nzd
-00002a10: 7428 3230 3231 2c20 312c 2032 382c 2031  t(2021, 1, 28, 1
-00002a20: 342c 2033 372c 2033 2c20 3237 3032 3138  4, 37, 3, 270218
-00002a30: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00002a40: 6173 7365 7274 4571 7561 6c28 7461 736b  assertEqual(task
-00002a50: 2e72 6561 6479 5f74 696d 652c 2064 6174  .ready_time, dat
-00002a60: 6574 696d 655f 6e7a 6474 2832 3032 312c  etime_nzdt(2021,
-00002a70: 2031 2c20 3238 2c20 3134 2c20 3337 2c20   1, 28, 14, 37, 
-00002a80: 322c 2032 3437 3135 3829 290a 2020 2020  2, 247158)).    
-00002a90: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00002aa0: 7175 616c 2874 6173 6b2e 6461 7461 2c20  qual(task.data, 
-00002ab0: 7b7d 290a 0a20 2020 2064 6566 2074 6573  {})..    def tes
-00002ac0: 745f 7461 736b 5f66 726f 6d5f 6469 6374  t_task_from_dict
-00002ad0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00002ae0: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
-00002af0: 2020 2269 6422 3a20 2237 3822 2c0a 2020    "id": "78",.  
-00002b00: 2020 2020 2020 2020 2020 226b 696e 6422            "kind"
-00002b10: 3a20 2273 7461 7274 222c 0a20 2020 2020  : "start",.     
-00002b20: 2020 2020 2020 2022 7072 6f67 7265 7373         "progress
-00002b30: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00002b40: 2020 2020 2022 646f 6e65 223a 2031 2c0a       "done": 1,.
-00002b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b60: 226c 6162 656c 223a 2022 222c 0a20 2020  "label": "",.   
-00002b70: 2020 2020 2020 2020 2020 2020 2022 746f               "to
-00002b80: 7461 6c22 3a20 312c 0a20 2020 2020 2020  tal": 1,.       
-00002b90: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00002ba0: 2020 2020 2272 6561 6479 2d74 696d 6522      "ready-time"
-00002bb0: 3a20 2232 3032 312d 3031 2d32 3854 3134  : "2021-01-28T14
-00002bc0: 3a33 373a 3033 2e32 3730 3231 3837 3738  :37:03.270218778
-00002bd0: 2b31 333a 3030 222c 0a20 2020 2020 2020  +13:00",.       
-00002be0: 2020 2020 2022 7370 6177 6e2d 7469 6d65       "spawn-time
-00002bf0: 223a 2022 3230 3231 2d30 312d 3238 5431  ": "2021-01-28T1
-00002c00: 343a 3337 3a30 322e 3234 3731 3538 3136  4:37:02.24715816
-00002c10: 322b 3133 3a30 3022 2c0a 2020 2020 2020  2+13:00",.      
-00002c20: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-00002c30: 2244 6f6e 6522 2c0a 2020 2020 2020 2020  "Done",.        
-00002c40: 2020 2020 2273 756d 6d61 7279 223a 2027      "summary": '
-00002c50: 5374 6172 7420 7365 7276 6963 6520 2273  Start service "s
-00002c60: 7663 2227 2c0a 2020 2020 2020 2020 2020  vc"',.          
-00002c70: 2020 2264 6174 6122 3a20 7b22 6578 6974    "data": {"exit
-00002c80: 2d63 6f64 6522 3a20 3432 7d2c 0a20 2020  -code": 42},.   
-00002c90: 2020 2020 207d 0a20 2020 2020 2020 2074       }.        t
-00002ca0: 6173 6b20 3d20 7065 6262 6c65 2e54 6173  ask = pebble.Tas
-00002cb0: 6b2e 6672 6f6d 5f64 6963 7428 6429 0a20  k.from_dict(d). 
-00002cc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00002cd0: 7274 4571 7561 6c28 7461 736b 2e69 642c  rtEqual(task.id,
-00002ce0: 2027 3738 2729 0a20 2020 2020 2020 2073   '78').        s
-00002cf0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00002d00: 7461 736b 2e6b 696e 642c 2027 7374 6172  task.kind, 'star
-00002d10: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
-00002d20: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
-00002d30: 6b2e 7375 6d6d 6172 792c 2027 5374 6172  k.summary, 'Star
-00002d40: 7420 7365 7276 6963 6520 2273 7663 2227  t service "svc"'
-00002d50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00002d60: 7373 6572 7445 7175 616c 2874 6173 6b2e  ssertEqual(task.
-00002d70: 7374 6174 7573 2c20 2744 6f6e 6527 290a  status, 'Done').
-00002d80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00002d90: 6572 7445 7175 616c 2874 6173 6b2e 6c6f  ertEqual(task.lo
-00002da0: 672c 205b 5d29 0a20 2020 2020 2020 2073  g, []).        s
-00002db0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00002dc0: 7461 736b 2e70 726f 6772 6573 732e 6c61  task.progress.la
-00002dd0: 6265 6c2c 2027 2729 0a20 2020 2020 2020  bel, '').       
-00002de0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00002df0: 6c28 7461 736b 2e70 726f 6772 6573 732e  l(task.progress.
-00002e00: 646f 6e65 2c20 3129 0a20 2020 2020 2020  done, 1).       
-00002e10: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00002e20: 6c28 7461 736b 2e70 726f 6772 6573 732e  l(task.progress.
-00002e30: 746f 7461 6c2c 2031 290a 2020 2020 2020  total, 1).      
-00002e40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00002e50: 616c 2874 6173 6b2e 7265 6164 795f 7469  al(task.ready_ti
-00002e60: 6d65 2c20 6461 7465 7469 6d65 5f6e 7a64  me, datetime_nzd
-00002e70: 7428 3230 3231 2c20 312c 2032 382c 2031  t(2021, 1, 28, 1
-00002e80: 342c 2033 372c 2033 2c20 3237 3032 3139  4, 37, 3, 270219
-00002e90: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00002ea0: 6173 7365 7274 4571 7561 6c28 7461 736b  assertEqual(task
-00002eb0: 2e73 7061 776e 5f74 696d 652c 2064 6174  .spawn_time, dat
-00002ec0: 6574 696d 655f 6e7a 6474 2832 3032 312c  etime_nzdt(2021,
-00002ed0: 2031 2c20 3238 2c20 3134 2c20 3337 2c20   1, 28, 14, 37, 
-00002ee0: 322c 2032 3437 3135 3829 290a 2020 2020  2, 247158)).    
-00002ef0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00002f00: 7175 616c 2874 6173 6b2e 6461 7461 2c20  qual(task.data, 
-00002f10: 7b27 6578 6974 2d63 6f64 6527 3a20 3432  {'exit-code': 42
-00002f20: 7d29 0a0a 2020 2020 2020 2020 645b 2772  })..        d['r
-00002f30: 6561 6479 2d74 696d 6527 5d20 3d20 2732  eady-time'] = '2
-00002f40: 3032 312d 3031 2d32 3854 3134 3a33 373a  021-01-28T14:37:
-00002f50: 3033 2e32 3730 3231 3837 3738 2b30 303a  03.270218778+00:
-00002f60: 3030 270a 2020 2020 2020 2020 645b 2773  00'.        d['s
-00002f70: 7061 776e 2d74 696d 6527 5d20 3d20 2732  pawn-time'] = '2
-00002f80: 3032 312d 3031 2d32 3854 3134 3a33 373a  021-01-28T14:37:
-00002f90: 3032 2e32 3437 3135 3831 3632 2b30 303a  02.247158162+00:
-00002fa0: 3030 270a 2020 2020 2020 2020 7461 736b  00'.        task
-00002fb0: 203d 2070 6562 626c 652e 5461 736b 2e66   = pebble.Task.f
-00002fc0: 726f 6d5f 6469 6374 2864 290a 2020 2020  rom_dict(d).    
-00002fd0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00002fe0: 7175 616c 2874 6173 6b2e 7265 6164 795f  qual(task.ready_
-00002ff0: 7469 6d65 2c20 6461 7465 7469 6d65 5f75  time, datetime_u
-00003000: 7463 2832 3032 312c 2031 2c20 3238 2c20  tc(2021, 1, 28, 
-00003010: 3134 2c20 3337 2c20 332c 2032 3730 3231  14, 37, 3, 27021
-00003020: 3929 290a 2020 2020 2020 2020 7365 6c66  9)).        self
-00003030: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
-00003040: 6b2e 7370 6177 6e5f 7469 6d65 2c20 6461  k.spawn_time, da
-00003050: 7465 7469 6d65 5f75 7463 2832 3032 312c  tetime_utc(2021,
-00003060: 2031 2c20 3238 2c20 3134 2c20 3337 2c20   1, 28, 14, 37, 
-00003070: 322c 2032 3437 3135 3829 290a 0a20 2020  2, 247158))..   
-00003080: 2064 6566 2074 6573 745f 6368 616e 6765   def test_change
-00003090: 5f69 6428 7365 6c66 293a 0a20 2020 2020  _id(self):.     
-000030a0: 2020 2063 6861 6e67 655f 6964 203d 2070     change_id = p
-000030b0: 6562 626c 652e 4368 616e 6765 4944 2827  ebble.ChangeID('
-000030c0: 3132 3334 2729 0a20 2020 2020 2020 2073  1234').        s
-000030d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000030e0: 6368 616e 6765 5f69 642c 2027 3132 3334  change_id, '1234
-000030f0: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-00003100: 5f63 6861 6e67 655f 696e 6974 2873 656c  _change_init(sel
-00003110: 6629 3a0a 2020 2020 2020 2020 6368 616e  f):.        chan
-00003120: 6765 203d 2070 6562 626c 652e 4368 616e  ge = pebble.Chan
-00003130: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
-00003140: 6964 3d70 6562 626c 652e 4368 616e 6765  id=pebble.Change
-00003150: 4944 2827 3730 2729 2c0a 2020 2020 2020  ID('70'),.      
-00003160: 2020 2020 2020 6b69 6e64 3d27 6175 746f        kind='auto
-00003170: 7374 6172 7427 2c0a 2020 2020 2020 2020  start',.        
-00003180: 2020 2020 6572 723d 2753 494c 4c59 272c      err='SILLY',
-00003190: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
-000031a0: 6479 3d54 7275 652c 0a20 2020 2020 2020  dy=True,.       
-000031b0: 2020 2020 2072 6561 6479 5f74 696d 653d       ready_time=
-000031c0: 6461 7465 7469 6d65 5f6e 7a64 7428 3230  datetime_nzdt(20
-000031d0: 3231 2c20 312c 2032 382c 2031 342c 2033  21, 1, 28, 14, 3
-000031e0: 372c 2034 2c20 3239 3135 3137 292c 0a20  7, 4, 291517),. 
-000031f0: 2020 2020 2020 2020 2020 2073 7061 776e             spawn
-00003200: 5f74 696d 653d 6461 7465 7469 6d65 5f6e  _time=datetime_n
-00003210: 7a64 7428 3230 3231 2c20 312c 2032 382c  zdt(2021, 1, 28,
-00003220: 2031 342c 2033 372c 2032 2c20 3234 3732   14, 37, 2, 2472
-00003230: 3032 292c 0a20 2020 2020 2020 2020 2020  02),.           
-00003240: 2073 7461 7475 733d 2744 6f6e 6527 2c0a   status='Done',.
-00003250: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-00003260: 6172 793d 2741 7574 6f73 7461 7274 2073  ary='Autostart s
-00003270: 6572 7669 6365 2022 7376 6322 272c 0a20  ervice "svc"',. 
-00003280: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
-00003290: 3d5b 5d2c 0a20 2020 2020 2020 2029 0a20  =[],.        ). 
-000032a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000032b0: 7274 4571 7561 6c28 6368 616e 6765 2e69  rtEqual(change.i
-000032c0: 642c 2027 3730 2729 0a20 2020 2020 2020  d, '70').       
-000032d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000032e0: 6c28 6368 616e 6765 2e6b 696e 642c 2027  l(change.kind, '
-000032f0: 6175 746f 7374 6172 7427 290a 2020 2020  autostart').    
-00003300: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00003310: 7175 616c 2863 6861 6e67 652e 6572 722c  qual(change.err,
-00003320: 2027 5349 4c4c 5927 290a 2020 2020 2020   'SILLY').      
-00003330: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00003340: 616c 2863 6861 6e67 652e 7265 6164 792c  al(change.ready,
-00003350: 2054 7275 6529 0a20 2020 2020 2020 2073   True).        s
-00003360: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00003370: 6368 616e 6765 2e72 6561 6479 5f74 696d  change.ready_tim
-00003380: 652c 2064 6174 6574 696d 655f 6e7a 6474  e, datetime_nzdt
-00003390: 2832 3032 312c 2031 2c20 3238 2c20 3134  (2021, 1, 28, 14
-000033a0: 2c20 3337 2c20 342c 2032 3931 3531 3729  , 37, 4, 291517)
-000033b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000033c0: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
-000033d0: 652e 7370 6177 6e5f 7469 6d65 2c20 6461  e.spawn_time, da
-000033e0: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
-000033f0: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
-00003400: 2032 2c20 3234 3732 3032 2929 0a20 2020   2, 247202)).   
-00003410: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003420: 4571 7561 6c28 6368 616e 6765 2e73 7461  Equal(change.sta
-00003430: 7475 732c 2027 446f 6e65 2729 0a20 2020  tus, 'Done').   
-00003440: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003450: 4571 7561 6c28 6368 616e 6765 2e73 756d  Equal(change.sum
-00003460: 6d61 7279 2c20 2741 7574 6f73 7461 7274  mary, 'Autostart
-00003470: 2073 6572 7669 6365 2022 7376 6322 2729   service "svc"')
-00003480: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00003490: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
-000034a0: 2e74 6173 6b73 2c20 5b5d 290a 2020 2020  .tasks, []).    
-000034b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000034c0: 7175 616c 2863 6861 6e67 652e 6461 7461  qual(change.data
-000034d0: 2c20 7b7d 290a 0a20 2020 2064 6566 2074  , {})..    def t
-000034e0: 6573 745f 6368 616e 6765 5f66 726f 6d5f  est_change_from_
-000034f0: 6469 6374 2873 656c 6629 3a0a 2020 2020  dict(self):.    
-00003500: 2020 2020 6420 3d20 7b0a 2020 2020 2020      d = {.      
-00003510: 2020 2020 2020 2269 6422 3a20 2237 3022        "id": "70"
-00003520: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-00003530: 696e 6422 3a20 2261 7574 6f73 7461 7274  ind": "autostart
-00003540: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00003550: 6572 7222 3a20 2253 494c 4c59 222c 0a20  err": "SILLY",. 
-00003560: 2020 2020 2020 2020 2020 2022 7265 6164             "read
-00003570: 7922 3a20 5472 7565 2c0a 2020 2020 2020  y": True,.      
-00003580: 2020 2020 2020 2272 6561 6479 2d74 696d        "ready-tim
-00003590: 6522 3a20 2232 3032 312d 3031 2d32 3854  e": "2021-01-28T
-000035a0: 3134 3a33 373a 3034 2e32 3931 3531 3737  14:37:04.2915177
-000035b0: 3638 2b31 333a 3030 222c 0a20 2020 2020  68+13:00",.     
-000035c0: 2020 2020 2020 2022 7370 6177 6e2d 7469         "spawn-ti
-000035d0: 6d65 223a 2022 3230 3231 2d30 312d 3238  me": "2021-01-28
-000035e0: 5431 343a 3337 3a30 322e 3234 3732 3032  T14:37:02.247202
-000035f0: 3130 352b 3133 3a30 3022 2c0a 2020 2020  105+13:00",.    
-00003600: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-00003610: 3a20 2244 6f6e 6522 2c0a 2020 2020 2020  : "Done",.      
-00003620: 2020 2020 2020 2273 756d 6d61 7279 223a        "summary":
-00003630: 2027 4175 746f 7374 6172 7420 7365 7276   'Autostart serv
-00003640: 6963 6520 2273 7663 2227 2c0a 2020 2020  ice "svc"',.    
-00003650: 2020 2020 2020 2020 2274 6173 6b73 223a          "tasks":
-00003660: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00003670: 2022 6461 7461 223a 207b 2265 7869 742d   "data": {"exit-
-00003680: 636f 6465 223a 2034 327d 2c0a 2020 2020  code": 42},.    
-00003690: 2020 2020 7d0a 2020 2020 2020 2020 6368      }.        ch
-000036a0: 616e 6765 203d 2070 6562 626c 652e 4368  ange = pebble.Ch
-000036b0: 616e 6765 2e66 726f 6d5f 6469 6374 2864  ange.from_dict(d
-000036c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000036d0: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
-000036e0: 652e 6964 2c20 2737 3027 290a 2020 2020  e.id, '70').    
-000036f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00003700: 7175 616c 2863 6861 6e67 652e 6b69 6e64  qual(change.kind
-00003710: 2c20 2761 7574 6f73 7461 7274 2729 0a20  , 'autostart'). 
-00003720: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00003730: 7274 4571 7561 6c28 6368 616e 6765 2e65  rtEqual(change.e
-00003740: 7272 2c20 2753 494c 4c59 2729 0a20 2020  rr, 'SILLY').   
-00003750: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003760: 4571 7561 6c28 6368 616e 6765 2e72 6561  Equal(change.rea
-00003770: 6479 2c20 5472 7565 290a 2020 2020 2020  dy, True).      
-00003780: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00003790: 616c 2863 6861 6e67 652e 7265 6164 795f  al(change.ready_
-000037a0: 7469 6d65 2c20 6461 7465 7469 6d65 5f6e  time, datetime_n
-000037b0: 7a64 7428 3230 3231 2c20 312c 2032 382c  zdt(2021, 1, 28,
-000037c0: 2031 342c 2033 372c 2034 2c20 3239 3135   14, 37, 4, 2915
-000037d0: 3138 2929 0a20 2020 2020 2020 2073 656c  18)).        sel
-000037e0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-000037f0: 616e 6765 2e73 7061 776e 5f74 696d 652c  ange.spawn_time,
-00003800: 2064 6174 6574 696d 655f 6e7a 6474 2832   datetime_nzdt(2
-00003810: 3032 312c 2031 2c20 3238 2c20 3134 2c20  021, 1, 28, 14, 
-00003820: 3337 2c20 322c 2032 3437 3230 3229 290a  37, 2, 247202)).
-00003830: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00003840: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
-00003850: 7374 6174 7573 2c20 2744 6f6e 6527 290a  status, 'Done').
-00003860: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00003870: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
-00003880: 7375 6d6d 6172 792c 2027 4175 746f 7374  summary, 'Autost
-00003890: 6172 7420 7365 7276 6963 6520 2273 7663  art service "svc
-000038a0: 2227 290a 2020 2020 2020 2020 7365 6c66  "').        self
-000038b0: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
-000038c0: 6e67 652e 7461 736b 732c 205b 5d29 0a20  nge.tasks, []). 
-000038d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000038e0: 7274 4571 7561 6c28 6368 616e 6765 2e64  rtEqual(change.d
-000038f0: 6174 612c 207b 2765 7869 742d 636f 6465  ata, {'exit-code
-00003900: 273a 2034 327d 290a 0a20 2020 2020 2020  ': 42})..       
-00003910: 2064 5b27 7265 6164 792d 7469 6d65 275d   d['ready-time']
-00003920: 203d 2027 3230 3231 2d30 312d 3238 5431   = '2021-01-28T1
-00003930: 343a 3337 3a30 342e 3239 3135 3137 3736  4:37:04.29151776
-00003940: 382b 3030 3a30 3027 0a20 2020 2020 2020  8+00:00'.       
-00003950: 2064 5b27 7370 6177 6e2d 7469 6d65 275d   d['spawn-time']
-00003960: 203d 2027 3230 3231 2d30 312d 3238 5431   = '2021-01-28T1
-00003970: 343a 3337 3a30 322e 3234 3732 3032 3130  4:37:02.24720210
-00003980: 352b 3030 3a30 3027 0a20 2020 2020 2020  5+00:00'.       
-00003990: 2063 6861 6e67 6520 3d20 7065 6262 6c65   change = pebble
-000039a0: 2e43 6861 6e67 652e 6672 6f6d 5f64 6963  .Change.from_dic
-000039b0: 7428 6429 0a20 2020 2020 2020 2073 656c  t(d).        sel
-000039c0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-000039d0: 616e 6765 2e72 6561 6479 5f74 696d 652c  ange.ready_time,
-000039e0: 2064 6174 6574 696d 655f 7574 6328 3230   datetime_utc(20
-000039f0: 3231 2c20 312c 2032 382c 2031 342c 2033  21, 1, 28, 14, 3
-00003a00: 372c 2034 2c20 3239 3135 3138 2929 0a20  7, 4, 291518)). 
-00003a10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00003a20: 7274 4571 7561 6c28 6368 616e 6765 2e73  rtEqual(change.s
-00003a30: 7061 776e 5f74 696d 652c 2064 6174 6574  pawn_time, datet
-00003a40: 696d 655f 7574 6328 3230 3231 2c20 312c  ime_utc(2021, 1,
-00003a50: 2032 382c 2031 342c 2033 372c 2032 2c20   28, 14, 37, 2, 
-00003a60: 3234 3732 3032 2929 0a0a 2020 2020 6465  247202))..    de
-00003a70: 6620 7465 7374 5f66 696c 655f 7479 7065  f test_file_type
-00003a80: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00003a90: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00003aa0: 286c 6973 7428 7065 6262 6c65 2e46 696c  (list(pebble.Fil
-00003ab0: 6554 7970 6529 2c20 5b0a 2020 2020 2020  eType), [.      
-00003ac0: 2020 2020 2020 7065 6262 6c65 2e46 696c        pebble.Fil
-00003ad0: 6554 7970 652e 4649 4c45 2c0a 2020 2020  eType.FILE,.    
-00003ae0: 2020 2020 2020 2020 7065 6262 6c65 2e46          pebble.F
-00003af0: 696c 6554 7970 652e 4449 5245 4354 4f52  ileType.DIRECTOR
-00003b00: 592c 0a20 2020 2020 2020 2020 2020 2070  Y,.            p
-00003b10: 6562 626c 652e 4669 6c65 5479 7065 2e53  ebble.FileType.S
-00003b20: 594d 4c49 4e4b 2c0a 2020 2020 2020 2020  YMLINK,.        
-00003b30: 2020 2020 7065 6262 6c65 2e46 696c 6554      pebble.FileT
-00003b40: 7970 652e 534f 434b 4554 2c0a 2020 2020  ype.SOCKET,.    
-00003b50: 2020 2020 2020 2020 7065 6262 6c65 2e46          pebble.F
-00003b60: 696c 6554 7970 652e 4e41 4d45 445f 5049  ileType.NAMED_PI
-00003b70: 5045 2c0a 2020 2020 2020 2020 2020 2020  PE,.            
-00003b80: 7065 6262 6c65 2e46 696c 6554 7970 652e  pebble.FileType.
-00003b90: 4445 5649 4345 2c0a 2020 2020 2020 2020  DEVICE,.        
-00003ba0: 2020 2020 7065 6262 6c65 2e46 696c 6554      pebble.FileT
-00003bb0: 7970 652e 554e 4b4e 4f57 4e2c 0a20 2020  ype.UNKNOWN,.   
-00003bc0: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
-00003bd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00003be0: 2870 6562 626c 652e 4669 6c65 5479 7065  (pebble.FileType
-00003bf0: 2e46 494c 452e 7661 6c75 652c 2027 6669  .FILE.value, 'fi
-00003c00: 6c65 2729 0a20 2020 2020 2020 2073 656c  le').        sel
-00003c10: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00003c20: 6262 6c65 2e46 696c 6554 7970 652e 4449  bble.FileType.DI
-00003c30: 5245 4354 4f52 592e 7661 6c75 652c 2027  RECTORY.value, '
-00003c40: 6469 7265 6374 6f72 7927 290a 2020 2020  directory').    
-00003c50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00003c60: 7175 616c 2870 6562 626c 652e 4669 6c65  qual(pebble.File
-00003c70: 5479 7065 2e53 594d 4c49 4e4b 2e76 616c  Type.SYMLINK.val
-00003c80: 7565 2c20 2773 796d 6c69 6e6b 2729 0a20  ue, 'symlink'). 
-00003c90: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00003ca0: 7274 4571 7561 6c28 7065 6262 6c65 2e46  rtEqual(pebble.F
-00003cb0: 696c 6554 7970 652e 534f 434b 4554 2e76  ileType.SOCKET.v
-00003cc0: 616c 7565 2c20 2773 6f63 6b65 7427 290a  alue, 'socket').
-00003cd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00003ce0: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
-00003cf0: 4669 6c65 5479 7065 2e4e 414d 4544 5f50  FileType.NAMED_P
-00003d00: 4950 452e 7661 6c75 652c 2027 6e61 6d65  IPE.value, 'name
-00003d10: 642d 7069 7065 2729 0a20 2020 2020 2020  d-pipe').       
-00003d20: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00003d30: 6c28 7065 6262 6c65 2e46 696c 6554 7970  l(pebble.FileTyp
-00003d40: 652e 4445 5649 4345 2e76 616c 7565 2c20  e.DEVICE.value, 
-00003d50: 2764 6576 6963 6527 290a 2020 2020 2020  'device').      
-00003d60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00003d70: 616c 2870 6562 626c 652e 4669 6c65 5479  al(pebble.FileTy
-00003d80: 7065 2e55 4e4b 4e4f 574e 2e76 616c 7565  pe.UNKNOWN.value
-00003d90: 2c20 2775 6e6b 6e6f 776e 2729 0a0a 2020  , 'unknown')..  
-00003da0: 2020 6465 6620 7465 7374 5f66 696c 655f    def test_file_
-00003db0: 696e 666f 5f69 6e69 7428 7365 6c66 293a  info_init(self):
-00003dc0: 0a20 2020 2020 2020 2069 6e66 6f20 3d20  .        info = 
-00003dd0: 7065 6262 6c65 2e46 696c 6549 6e66 6f28  pebble.FileInfo(
-00003de0: 272f 6574 632f 686f 7374 7327 2c20 2768  '/etc/hosts', 'h
-00003df0: 6f73 7473 272c 2070 6562 626c 652e 4669  osts', pebble.Fi
-00003e00: 6c65 5479 7065 2e46 494c 452c 2031 3233  leType.FILE, 123
-00003e10: 2c20 306f 3634 342c 0a20 2020 2020 2020  , 0o644,.       
+00000390: 6574 0a0a 6672 6f6d 206f 7073 2069 6d70  et..from ops imp
+000003a0: 6f72 7420 7065 6262 6c65 0a66 726f 6d20  ort pebble.from 
+000003b0: 6f70 732e 5f70 7269 7661 7465 2069 6d70  ops._private imp
+000003c0: 6f72 7420 7961 6d6c 0a0a 2320 456e 7375  ort yaml..# Ensu
+000003d0: 7265 2075 6e69 7474 6573 7420 6469 6666  re unittest diff
+000003e0: 7320 646f 6e27 7420 6765 7420 7472 756e  s don't get trun
+000003f0: 6361 7465 6420 6c69 6b65 2022 5b31 3720  cated like "[17 
+00000400: 6368 6172 735d 220a 756e 6974 7465 7374  chars]".unittest
+00000410: 2e75 7469 6c2e 5f4d 4158 5f4c 454e 4754  .util._MAX_LENGT
+00000420: 4820 3d20 3130 3030 0a0a 0a64 6566 2064  H = 1000...def d
+00000430: 6174 6574 696d 655f 7574 6328 792c 206d  atetime_utc(y, m
+00000440: 2c20 642c 2068 6f75 722c 206d 696e 2c20  , d, hour, min, 
+00000450: 7365 632c 206d 6963 726f 3d30 293a 0a20  sec, micro=0):. 
+00000460: 2020 2074 7a20 3d20 6461 7465 7469 6d65     tz = datetime
+00000470: 2e74 696d 657a 6f6e 652e 7574 630a 2020  .timezone.utc.  
+00000480: 2020 7265 7475 726e 2064 6174 6574 696d    return datetim
+00000490: 652e 6461 7465 7469 6d65 2879 2c20 6d2c  e.datetime(y, m,
+000004a0: 2064 2c20 686f 7572 2c20 6d69 6e2c 2073   d, hour, min, s
+000004b0: 6563 2c20 6d69 6372 6f2c 2074 7a69 6e66  ec, micro, tzinf
+000004c0: 6f3d 747a 290a 0a0a 6465 6620 6461 7465  o=tz)...def date
+000004d0: 7469 6d65 5f6e 7a64 7428 792c 206d 2c20  time_nzdt(y, m, 
+000004e0: 642c 2068 6f75 722c 206d 696e 2c20 7365  d, hour, min, se
+000004f0: 632c 206d 6963 726f 3d30 293a 0a20 2020  c, micro=0):.   
+00000500: 2074 7a20 3d20 6461 7465 7469 6d65 2e74   tz = datetime.t
+00000510: 696d 657a 6f6e 6528 6461 7465 7469 6d65  imezone(datetime
+00000520: 2e74 696d 6564 656c 7461 2868 6f75 7273  .timedelta(hours
+00000530: 3d31 3329 290a 2020 2020 7265 7475 726e  =13)).    return
+00000540: 2064 6174 6574 696d 652e 6461 7465 7469   datetime.dateti
+00000550: 6d65 2879 2c20 6d2c 2064 2c20 686f 7572  me(y, m, d, hour
+00000560: 2c20 6d69 6e2c 2073 6563 2c20 6d69 6372  , min, sec, micr
+00000570: 6f2c 2074 7a69 6e66 6f3d 747a 290a 0a0a  o, tzinfo=tz)...
+00000580: 636c 6173 7320 5465 7374 5479 7065 7328  class TestTypes(
+00000590: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
+000005a0: 6529 3a0a 2020 2020 6d61 7844 6966 6620  e):.    maxDiff 
+000005b0: 3d20 4e6f 6e65 0a0a 2020 2020 6465 6620  = None..    def 
+000005c0: 7465 7374 5f65 7272 6f72 2873 656c 6629  test_error(self)
+000005d0: 3a0a 2020 2020 2020 2020 6572 726f 7220  :.        error 
+000005e0: 3d20 7065 6262 6c65 2e45 7272 6f72 2827  = pebble.Error('
+000005f0: 6572 726f 7227 290a 2020 2020 2020 2020  error').        
+00000600: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+00000610: 7461 6e63 6528 6572 726f 722c 2045 7863  tance(error, Exc
+00000620: 6570 7469 6f6e 290a 0a20 2020 2064 6566  eption)..    def
+00000630: 2074 6573 745f 7469 6d65 6f75 745f 6572   test_timeout_er
+00000640: 726f 7228 7365 6c66 293a 0a20 2020 2020  ror(self):.     
+00000650: 2020 2065 7272 6f72 203d 2070 6562 626c     error = pebbl
+00000660: 652e 5469 6d65 6f75 7445 7272 6f72 2827  e.TimeoutError('
+00000670: 7469 6d65 6f75 7421 2729 0a20 2020 2020  timeout!').     
+00000680: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+00000690: 496e 7374 616e 6365 2865 7272 6f72 2c20  Instance(error, 
+000006a0: 7065 6262 6c65 2e45 7272 6f72 290a 2020  pebble.Error).  
+000006b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000006c0: 7449 7349 6e73 7461 6e63 6528 6572 726f  tIsInstance(erro
+000006d0: 722c 2054 696d 656f 7574 4572 726f 7229  r, TimeoutError)
+000006e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000006f0: 7365 7274 4571 7561 6c28 7374 7228 6572  sertEqual(str(er
+00000700: 726f 7229 2c20 2774 696d 656f 7574 2127  ror), 'timeout!'
+00000710: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00000720: 636f 6e6e 6563 7469 6f6e 5f65 7272 6f72  connection_error
+00000730: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00000740: 6572 726f 7220 3d20 7065 6262 6c65 2e43  error = pebble.C
+00000750: 6f6e 6e65 6374 696f 6e45 7272 6f72 2827  onnectionError('
+00000760: 636f 6e6e 6572 7221 2729 0a20 2020 2020  connerr!').     
+00000770: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+00000780: 496e 7374 616e 6365 2865 7272 6f72 2c20  Instance(error, 
+00000790: 7065 6262 6c65 2e45 7272 6f72 290a 2020  pebble.Error).  
+000007a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000007b0: 7445 7175 616c 2873 7472 2865 7272 6f72  tEqual(str(error
+000007c0: 292c 2027 636f 6e6e 6572 7221 2729 0a0a  ), 'connerr!')..
+000007d0: 2020 2020 6465 6620 7465 7374 5f70 726f      def test_pro
+000007e0: 746f 636f 6c5f 6572 726f 7228 7365 6c66  tocol_error(self
+000007f0: 293a 0a20 2020 2020 2020 2065 7272 6f72  ):.        error
+00000800: 203d 2070 6562 626c 652e 5072 6f74 6f63   = pebble.Protoc
+00000810: 6f6c 4572 726f 7228 2770 726f 746f 6572  olError('protoer
+00000820: 7221 2729 0a20 2020 2020 2020 2073 656c  r!').        sel
+00000830: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+00000840: 6365 2865 7272 6f72 2c20 7065 6262 6c65  ce(error, pebble
+00000850: 2e45 7272 6f72 290a 2020 2020 2020 2020  .Error).        
+00000860: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00000870: 2873 7472 2865 7272 6f72 292c 2027 7072  (str(error), 'pr
+00000880: 6f74 6f65 7272 2127 290a 0a20 2020 2064  otoerr!')..    d
+00000890: 6566 2074 6573 745f 7061 7468 5f65 7272  ef test_path_err
+000008a0: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
+000008b0: 2020 6572 726f 7220 3d20 7065 6262 6c65    error = pebble
+000008c0: 2e50 6174 6845 7272 6f72 2827 6e6f 742d  .PathError('not-
+000008d0: 666f 756e 6427 2c20 2774 6869 6e67 206e  found', 'thing n
+000008e0: 6f74 2066 6f75 6e64 2729 0a20 2020 2020  ot found').     
+000008f0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+00000900: 496e 7374 616e 6365 2865 7272 6f72 2c20  Instance(error, 
+00000910: 7065 6262 6c65 2e45 7272 6f72 290a 2020  pebble.Error).  
+00000920: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00000930: 7445 7175 616c 2865 7272 6f72 2e6b 696e  tEqual(error.kin
+00000940: 642c 2027 6e6f 742d 666f 756e 6427 290a  d, 'not-found').
+00000950: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00000960: 6572 7445 7175 616c 2865 7272 6f72 2e6d  ertEqual(error.m
+00000970: 6573 7361 6765 2c20 2774 6869 6e67 206e  essage, 'thing n
+00000980: 6f74 2066 6f75 6e64 2729 0a20 2020 2020  ot found').     
+00000990: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000009a0: 7561 6c28 7374 7228 6572 726f 7229 2c20  ual(str(error), 
+000009b0: 276e 6f74 2d66 6f75 6e64 202d 2074 6869  'not-found - thi
+000009c0: 6e67 206e 6f74 2066 6f75 6e64 2729 0a0a  ng not found')..
+000009d0: 2020 2020 6465 6620 7465 7374 5f61 7069      def test_api
+000009e0: 5f65 7272 6f72 2873 656c 6629 3a0a 2020  _error(self):.  
+000009f0: 2020 2020 2020 626f 6479 203d 207b 0a20        body = {. 
+00000a00: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
+00000a10: 6c74 223a 207b 0a20 2020 2020 2020 2020  lt": {.         
+00000a20: 2020 2020 2020 2022 6d65 7373 6167 6522         "message"
+00000a30: 3a20 226e 6f20 7365 7276 6963 6573 2074  : "no services t
+00000a40: 6f20 7374 6172 7420 7072 6f76 6964 6564  o start provided
+00000a50: 220a 2020 2020 2020 2020 2020 2020 7d2c  ".            },
+00000a60: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+00000a70: 6174 7573 223a 2022 4261 6420 5265 7175  atus": "Bad Requ
+00000a80: 6573 7422 2c0a 2020 2020 2020 2020 2020  est",.          
+00000a90: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
+00000aa0: 2034 3030 2c0a 2020 2020 2020 2020 2020   400,.          
+00000ab0: 2020 2274 7970 6522 3a20 2265 7272 6f72    "type": "error
+00000ac0: 220a 2020 2020 2020 2020 7d0a 2020 2020  ".        }.    
+00000ad0: 2020 2020 6572 726f 7220 3d20 7065 6262      error = pebb
+00000ae0: 6c65 2e41 5049 4572 726f 7228 626f 6479  le.APIError(body
+00000af0: 2c20 3430 302c 2022 4261 6420 5265 7175  , 400, "Bad Requ
+00000b00: 6573 7422 2c20 226e 6f20 7365 7276 6963  est", "no servic
+00000b10: 6573 2229 0a20 2020 2020 2020 2073 656c  es").        sel
+00000b20: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+00000b30: 6365 2865 7272 6f72 2c20 7065 6262 6c65  ce(error, pebble
+00000b40: 2e45 7272 6f72 290a 2020 2020 2020 2020  .Error).        
+00000b50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00000b60: 2865 7272 6f72 2e62 6f64 792c 2062 6f64  (error.body, bod
+00000b70: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
+00000b80: 6173 7365 7274 4571 7561 6c28 6572 726f  assertEqual(erro
+00000b90: 722e 636f 6465 2c20 3430 3029 0a20 2020  r.code, 400).   
+00000ba0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00000bb0: 4571 7561 6c28 6572 726f 722e 7374 6174  Equal(error.stat
+00000bc0: 7573 2c20 2742 6164 2052 6571 7565 7374  us, 'Bad Request
+00000bd0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00000be0: 6173 7365 7274 4571 7561 6c28 6572 726f  assertEqual(erro
+00000bf0: 722e 6d65 7373 6167 652c 2027 6e6f 2073  r.message, 'no s
+00000c00: 6572 7669 6365 7327 290a 2020 2020 2020  ervices').      
+00000c10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00000c20: 616c 2873 7472 2865 7272 6f72 292c 2027  al(str(error), '
+00000c30: 6e6f 2073 6572 7669 6365 7327 290a 0a20  no services').. 
+00000c40: 2020 2064 6566 2074 6573 745f 6368 616e     def test_chan
+00000c50: 6765 5f65 7272 6f72 2873 656c 6629 3a0a  ge_error(self):.
+00000c60: 2020 2020 2020 2020 6368 616e 6765 203d          change =
+00000c70: 2070 6562 626c 652e 4368 616e 6765 280a   pebble.Change(.
+00000c80: 2020 2020 2020 2020 2020 2020 6964 3d70              id=p
+00000c90: 6562 626c 652e 4368 616e 6765 4944 2827  ebble.ChangeID('
+00000ca0: 3132 3334 2729 2c0a 2020 2020 2020 2020  1234'),.        
+00000cb0: 2020 2020 6b69 6e64 3d27 7374 6172 7427      kind='start'
+00000cc0: 2c0a 2020 2020 2020 2020 2020 2020 7375  ,.            su
+00000cd0: 6d6d 6172 793d 2753 7461 7274 2073 6572  mmary='Start ser
+00000ce0: 7669 6365 2022 666f 6f22 272c 0a20 2020  vice "foo"',.   
+00000cf0: 2020 2020 2020 2020 2073 7461 7475 733d           status=
+00000d00: 2744 6f6e 6527 2c0a 2020 2020 2020 2020  'Done',.        
+00000d10: 2020 2020 7461 736b 733d 5b5d 2c0a 2020      tasks=[],.  
+00000d20: 2020 2020 2020 2020 2020 7265 6164 793d            ready=
+00000d30: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00000d40: 2020 6572 723d 2753 6f6d 6520 6572 726f    err='Some erro
+00000d50: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
+00000d60: 7370 6177 6e5f 7469 6d65 3d64 6174 6574  spawn_time=datet
+00000d70: 696d 652e 6461 7465 7469 6d65 2e6e 6f77  ime.datetime.now
+00000d80: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00000d90: 7265 6164 795f 7469 6d65 3d64 6174 6574  ready_time=datet
+00000da0: 696d 652e 6461 7465 7469 6d65 2e6e 6f77  ime.datetime.now
+00000db0: 2829 2c0a 2020 2020 2020 2020 290a 2020  (),.        ).  
+00000dc0: 2020 2020 2020 6572 726f 7220 3d20 7065        error = pe
+00000dd0: 6262 6c65 2e43 6861 6e67 6545 7272 6f72  bble.ChangeError
+00000de0: 2863 6861 6e67 652e 6572 722c 2063 6861  (change.err, cha
+00000df0: 6e67 6529 0a20 2020 2020 2020 2073 656c  nge).        sel
+00000e00: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+00000e10: 6365 2865 7272 6f72 2c20 7065 6262 6c65  ce(error, pebble
+00000e20: 2e45 7272 6f72 290a 2020 2020 2020 2020  .Error).        
+00000e30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00000e40: 2865 7272 6f72 2e65 7272 2c20 2753 6f6d  (error.err, 'Som
+00000e50: 6520 6572 726f 7227 290a 2020 2020 2020  e error').      
+00000e60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00000e70: 616c 2865 7272 6f72 2e63 6861 6e67 652c  al(error.change,
+00000e80: 2063 6861 6e67 6529 0a20 2020 2020 2020   change).       
+00000e90: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00000ea0: 6c28 7374 7228 6572 726f 7229 2c20 2753  l(str(error), 'S
+00000eb0: 6f6d 6520 6572 726f 7227 290a 0a20 2020  ome error')..   
+00000ec0: 2064 6566 2074 6573 745f 6368 616e 6765   def test_change
+00000ed0: 5f65 7272 6f72 5f77 6974 685f 7461 736b  _error_with_task
+00000ee0: 5f6c 6f67 7328 7365 6c66 293a 0a20 2020  _logs(self):.   
+00000ef0: 2020 2020 2063 6861 6e67 6520 3d20 7065       change = pe
+00000f00: 6262 6c65 2e43 6861 6e67 6528 0a20 2020  bble.Change(.   
+00000f10: 2020 2020 2020 2020 2069 643d 7065 6262           id=pebb
+00000f20: 6c65 2e43 6861 6e67 6549 4428 2731 3233  le.ChangeID('123
+00000f30: 3427 292c 0a20 2020 2020 2020 2020 2020  4'),.           
+00000f40: 206b 696e 643d 2773 7461 7274 272c 0a20   kind='start',. 
+00000f50: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00000f60: 7279 3d27 5374 6172 7420 7365 7276 6963  ry='Start servic
+00000f70: 6520 2266 6f6f 2227 2c0a 2020 2020 2020  e "foo"',.      
+00000f80: 2020 2020 2020 7374 6174 7573 3d27 446f        status='Do
+00000f90: 6e65 272c 0a20 2020 2020 2020 2020 2020  ne',.           
+00000fa0: 2074 6173 6b73 3d5b 0a20 2020 2020 2020   tasks=[.       
+00000fb0: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+00000fc0: 5461 736b 280a 2020 2020 2020 2020 2020  Task(.          
+00000fd0: 2020 2020 2020 2020 2020 6964 3d70 6562            id=peb
+00000fe0: 626c 652e 5461 736b 4944 2827 3132 3334  ble.TaskID('1234
+00000ff0: 3527 292c 0a20 2020 2020 2020 2020 2020  5'),.           
+00001000: 2020 2020 2020 2020 206b 696e 643d 2773           kind='s
+00001010: 7461 7274 272c 0a20 2020 2020 2020 2020  tart',.         
+00001020: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00001030: 7279 3d27 5374 6172 7420 7365 7276 6963  ry='Start servic
+00001040: 6520 2266 6f6f 2227 2c0a 2020 2020 2020  e "foo"',.      
+00001050: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00001060: 6174 7573 3d27 4572 726f 7227 2c0a 2020  atus='Error',.  
+00001070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001080: 2020 6c6f 673d 5b27 4c49 4e45 3127 2c20    log=['LINE1', 
+00001090: 274c 494e 4532 275d 2c0a 2020 2020 2020  'LINE2'],.      
+000010a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000010b0: 6f67 7265 7373 3d70 6562 626c 652e 5461  ogress=pebble.Ta
+000010c0: 736b 5072 6f67 7265 7373 286c 6162 656c  skProgress(label
+000010d0: 3d27 666f 6f27 2c20 646f 6e65 3d33 2c20  ='foo', done=3, 
+000010e0: 746f 7461 6c3d 3729 2c0a 2020 2020 2020  total=7),.      
+000010f0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+00001100: 6177 6e5f 7469 6d65 3d64 6174 6574 696d  awn_time=datetim
+00001110: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
+00001120: 3238 2c20 3134 2c20 3337 2c20 332c 2032  28, 14, 37, 3, 2
+00001130: 3730 3231 3829 2c0a 2020 2020 2020 2020  70218),.        
+00001140: 2020 2020 2020 2020 2020 2020 7265 6164              read
+00001150: 795f 7469 6d65 3d64 6174 6574 696d 655f  y_time=datetime_
+00001160: 6e7a 6474 2832 3032 312c 2031 2c20 3238  nzdt(2021, 1, 28
+00001170: 2c20 3134 2c20 3337 2c20 322c 2032 3437  , 14, 37, 2, 247
+00001180: 3135 3829 2c0a 2020 2020 2020 2020 2020  158),.          
+00001190: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+000011a0: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+000011b0: 5461 736b 280a 2020 2020 2020 2020 2020  Task(.          
+000011c0: 2020 2020 2020 2020 2020 6964 3d70 6562            id=peb
+000011d0: 626c 652e 5461 736b 4944 2827 3132 3334  ble.TaskID('1234
+000011e0: 3627 292c 0a20 2020 2020 2020 2020 2020  6'),.           
+000011f0: 2020 2020 2020 2020 206b 696e 643d 2773           kind='s
+00001200: 7461 7274 272c 0a20 2020 2020 2020 2020  tart',.         
+00001210: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00001220: 7279 3d27 5374 6172 7420 7365 7276 6963  ry='Start servic
+00001230: 6520 2262 6172 2227 2c0a 2020 2020 2020  e "bar"',.      
+00001240: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00001250: 6174 7573 3d27 4572 726f 7227 2c0a 2020  atus='Error',.  
+00001260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001270: 2020 6c6f 673d 5b5d 2c0a 2020 2020 2020    log=[],.      
+00001280: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00001290: 6f67 7265 7373 3d70 6562 626c 652e 5461  ogress=pebble.Ta
+000012a0: 736b 5072 6f67 7265 7373 286c 6162 656c  skProgress(label
+000012b0: 3d27 666f 6f27 2c20 646f 6e65 3d33 2c20  ='foo', done=3, 
+000012c0: 746f 7461 6c3d 3729 2c0a 2020 2020 2020  total=7),.      
+000012d0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+000012e0: 6177 6e5f 7469 6d65 3d64 6174 6574 696d  awn_time=datetim
+000012f0: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
+00001300: 3238 2c20 3134 2c20 3337 2c20 332c 2032  28, 14, 37, 3, 2
+00001310: 3730 3231 3829 2c0a 2020 2020 2020 2020  70218),.        
+00001320: 2020 2020 2020 2020 2020 2020 7265 6164              read
+00001330: 795f 7469 6d65 3d64 6174 6574 696d 655f  y_time=datetime_
+00001340: 6e7a 6474 2832 3032 312c 2031 2c20 3238  nzdt(2021, 1, 28
+00001350: 2c20 3134 2c20 3337 2c20 322c 2032 3437  , 14, 37, 2, 247
+00001360: 3135 3829 2c0a 2020 2020 2020 2020 2020  158),.          
+00001370: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+00001380: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+00001390: 5461 736b 280a 2020 2020 2020 2020 2020  Task(.          
+000013a0: 2020 2020 2020 2020 2020 6964 3d70 6562            id=peb
+000013b0: 626c 652e 5461 736b 4944 2827 3132 3334  ble.TaskID('1234
+000013c0: 3727 292c 0a20 2020 2020 2020 2020 2020  7'),.           
+000013d0: 2020 2020 2020 2020 206b 696e 643d 2773           kind='s
+000013e0: 7461 7274 272c 0a20 2020 2020 2020 2020  tart',.         
+000013f0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00001400: 7279 3d27 5374 6172 7420 7365 7276 6963  ry='Start servic
+00001410: 6520 2262 617a 7a22 272c 0a20 2020 2020  e "bazz"',.     
+00001420: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00001430: 7461 7475 733d 2745 7272 6f72 272c 0a20  tatus='Error',. 
+00001440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001450: 2020 206c 6f67 3d5b 2773 696e 676c 6520     log=['single 
+00001460: 6c6f 6727 5d2c 0a20 2020 2020 2020 2020  log'],.         
+00001470: 2020 2020 2020 2020 2020 2070 726f 6772             progr
+00001480: 6573 733d 7065 6262 6c65 2e54 6173 6b50  ess=pebble.TaskP
+00001490: 726f 6772 6573 7328 6c61 6265 6c3d 2766  rogress(label='f
+000014a0: 6f6f 272c 2064 6f6e 653d 332c 2074 6f74  oo', done=3, tot
+000014b0: 616c 3d37 292c 0a20 2020 2020 2020 2020  al=7),.         
+000014c0: 2020 2020 2020 2020 2020 2073 7061 776e             spawn
+000014d0: 5f74 696d 653d 6461 7465 7469 6d65 5f6e  _time=datetime_n
+000014e0: 7a64 7428 3230 3231 2c20 312c 2032 382c  zdt(2021, 1, 28,
+000014f0: 2031 342c 2033 372c 2033 2c20 3237 3032   14, 37, 3, 2702
+00001500: 3138 292c 0a20 2020 2020 2020 2020 2020  18),.           
+00001510: 2020 2020 2020 2020 2072 6561 6479 5f74           ready_t
+00001520: 696d 653d 6461 7465 7469 6d65 5f6e 7a64  ime=datetime_nzd
+00001530: 7428 3230 3231 2c20 312c 2032 382c 2031  t(2021, 1, 28, 1
+00001540: 342c 2033 372c 2032 2c20 3234 3731 3538  4, 37, 2, 247158
+00001550: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00001560: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00001570: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00001580: 2072 6561 6479 3d54 7275 652c 0a20 2020   ready=True,.   
+00001590: 2020 2020 2020 2020 2065 7272 3d27 536f           err='So
+000015a0: 6d65 2065 7272 6f72 272c 0a20 2020 2020  me error',.     
+000015b0: 2020 2020 2020 2073 7061 776e 5f74 696d         spawn_tim
+000015c0: 653d 6461 7465 7469 6d65 2e64 6174 6574  e=datetime.datet
+000015d0: 696d 652e 6e6f 7728 292c 0a20 2020 2020  ime.now(),.     
+000015e0: 2020 2020 2020 2072 6561 6479 5f74 696d         ready_tim
+000015f0: 653d 6461 7465 7469 6d65 2e64 6174 6574  e=datetime.datet
+00001600: 696d 652e 6e6f 7728 292c 0a20 2020 2020  ime.now(),.     
+00001610: 2020 2029 0a20 2020 2020 2020 2065 7272     ).        err
+00001620: 6f72 203d 2070 6562 626c 652e 4368 616e  or = pebble.Chan
+00001630: 6765 4572 726f 7228 6368 616e 6765 2e65  geError(change.e
+00001640: 7272 2c20 6368 616e 6765 290a 2020 2020  rr, change).    
+00001650: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+00001660: 7349 6e73 7461 6e63 6528 6572 726f 722c  sInstance(error,
+00001670: 2070 6562 626c 652e 4572 726f 7229 0a20   pebble.Error). 
+00001680: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00001690: 7274 4571 7561 6c28 6572 726f 722e 6572  rtEqual(error.er
+000016a0: 722c 2027 536f 6d65 2065 7272 6f72 2729  r, 'Some error')
+000016b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000016c0: 7365 7274 4571 7561 6c28 6572 726f 722e  sertEqual(error.
+000016d0: 6368 616e 6765 2c20 6368 616e 6765 290a  change, change).
+000016e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000016f0: 6572 7445 7175 616c 2873 7472 2865 7272  ertEqual(str(err
+00001700: 6f72 292c 2022 2222 536f 6d65 2065 7272  or), """Some err
+00001710: 6f72 0a2d 2d2d 2d2d 204c 6f67 7320 6672  or.----- Logs fr
+00001720: 6f6d 2074 6173 6b20 3020 2d2d 2d2d 2d0a  om task 0 -----.
+00001730: 4c49 4e45 310a 4c49 4e45 320a 2d2d 2d2d  LINE1.LINE2.----
+00001740: 2d20 4c6f 6773 2066 726f 6d20 7461 736b  - Logs from task
+00001750: 2032 202d 2d2d 2d2d 0a73 696e 676c 6520   2 -----.single 
+00001760: 6c6f 670a 2d2d 2d2d 2d22 2222 290a 0a20  log.-----""").. 
+00001770: 2020 2064 6566 2074 6573 745f 7761 726e     def test_warn
+00001780: 696e 675f 7374 6174 6528 7365 6c66 293a  ing_state(self):
+00001790: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000017a0: 7365 7274 4571 7561 6c28 6c69 7374 2870  sertEqual(list(p
+000017b0: 6562 626c 652e 5761 726e 696e 6753 7461  ebble.WarningSta
+000017c0: 7465 292c 205b 0a20 2020 2020 2020 2020  te), [.         
+000017d0: 2020 2070 6562 626c 652e 5761 726e 696e     pebble.Warnin
+000017e0: 6753 7461 7465 2e41 4c4c 2c0a 2020 2020  gState.ALL,.    
+000017f0: 2020 2020 2020 2020 7065 6262 6c65 2e57          pebble.W
+00001800: 6172 6e69 6e67 5374 6174 652e 5045 4e44  arningState.PEND
+00001810: 494e 472c 0a20 2020 2020 2020 205d 290a  ING,.        ]).
+00001820: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00001830: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+00001840: 5761 726e 696e 6753 7461 7465 2e41 4c4c  WarningState.ALL
+00001850: 2e76 616c 7565 2c20 2761 6c6c 2729 0a20  .value, 'all'). 
+00001860: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00001870: 7274 4571 7561 6c28 7065 6262 6c65 2e57  rtEqual(pebble.W
+00001880: 6172 6e69 6e67 5374 6174 652e 5045 4e44  arningState.PEND
+00001890: 494e 472e 7661 6c75 652c 2027 7065 6e64  ING.value, 'pend
+000018a0: 696e 6727 290a 0a20 2020 2064 6566 2074  ing')..    def t
+000018b0: 6573 745f 6368 616e 6765 5f73 7461 7465  est_change_state
+000018c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000018d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000018e0: 286c 6973 7428 7065 6262 6c65 2e43 6861  (list(pebble.Cha
+000018f0: 6e67 6553 7461 7465 292c 205b 0a20 2020  ngeState), [.   
+00001900: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+00001910: 4368 616e 6765 5374 6174 652e 414c 4c2c  ChangeState.ALL,
+00001920: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
+00001930: 626c 652e 4368 616e 6765 5374 6174 652e  ble.ChangeState.
+00001940: 494e 5f50 524f 4752 4553 532c 0a20 2020  IN_PROGRESS,.   
+00001950: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+00001960: 4368 616e 6765 5374 6174 652e 5245 4144  ChangeState.READ
+00001970: 592c 0a20 2020 2020 2020 205d 290a 2020  Y,.        ]).  
+00001980: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00001990: 7445 7175 616c 2870 6562 626c 652e 4368  tEqual(pebble.Ch
+000019a0: 616e 6765 5374 6174 652e 414c 4c2e 7661  angeState.ALL.va
+000019b0: 6c75 652c 2027 616c 6c27 290a 2020 2020  lue, 'all').    
+000019c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000019d0: 7175 616c 2870 6562 626c 652e 4368 616e  qual(pebble.Chan
+000019e0: 6765 5374 6174 652e 494e 5f50 524f 4752  geState.IN_PROGR
+000019f0: 4553 532e 7661 6c75 652c 2027 696e 2d70  ESS.value, 'in-p
+00001a00: 726f 6772 6573 7327 290a 2020 2020 2020  rogress').      
+00001a10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00001a20: 616c 2870 6562 626c 652e 4368 616e 6765  al(pebble.Change
+00001a30: 5374 6174 652e 5245 4144 592e 7661 6c75  State.READY.valu
+00001a40: 652c 2027 7265 6164 7927 290a 0a20 2020  e, 'ready')..   
+00001a50: 2064 6566 2074 6573 745f 7379 7374 656d   def test_system
+00001a60: 5f69 6e66 6f5f 696e 6974 2873 656c 6629  _info_init(self)
+00001a70: 3a0a 2020 2020 2020 2020 696e 666f 203d  :.        info =
+00001a80: 2070 6562 626c 652e 5379 7374 656d 496e   pebble.SystemIn
+00001a90: 666f 2876 6572 7369 6f6e 3d27 312e 322e  fo(version='1.2.
+00001aa0: 3327 290a 2020 2020 2020 2020 7365 6c66  3').        self
+00001ab0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+00001ac0: 6f2e 7665 7273 696f 6e2c 2027 312e 322e  o.version, '1.2.
+00001ad0: 3327 290a 0a20 2020 2064 6566 2074 6573  3')..    def tes
+00001ae0: 745f 7379 7374 656d 5f69 6e66 6f5f 6672  t_system_info_fr
+00001af0: 6f6d 5f64 6963 7428 7365 6c66 293a 0a20  om_dict(self):. 
+00001b00: 2020 2020 2020 2069 6e66 6f20 3d20 7065         info = pe
+00001b10: 6262 6c65 2e53 7973 7465 6d49 6e66 6f2e  bble.SystemInfo.
+00001b20: 6672 6f6d 5f64 6963 7428 7b27 7665 7273  from_dict({'vers
+00001b30: 696f 6e27 3a20 2733 2e32 2e31 277d 290a  ion': '3.2.1'}).
+00001b40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00001b50: 6572 7445 7175 616c 2869 6e66 6f2e 7665  ertEqual(info.ve
+00001b60: 7273 696f 6e2c 2027 332e 322e 3127 290a  rsion, '3.2.1').
+00001b70: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
+00001b80: 726e 696e 675f 696e 6974 2873 656c 6629  rning_init(self)
+00001b90: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
+00001ba0: 6720 3d20 7065 6262 6c65 2e57 6172 6e69  g = pebble.Warni
+00001bb0: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+00001bc0: 6d65 7373 6167 653d 2742 6577 6172 6521  message='Beware!
+00001bd0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00001be0: 6972 7374 5f61 6464 6564 3d64 6174 6574  irst_added=datet
+00001bf0: 696d 655f 7574 6328 3230 3231 2c20 312c  ime_utc(2021, 1,
+00001c00: 2031 2c20 312c 2031 2c20 3129 2c0a 2020   1, 1, 1, 1),.  
+00001c10: 2020 2020 2020 2020 2020 6c61 7374 5f61            last_a
+00001c20: 6464 6564 3d64 6174 6574 696d 655f 7574  dded=datetime_ut
+00001c30: 6328 3230 3231 2c20 312c 2032 362c 2032  c(2021, 1, 26, 2
+00001c40: 2c20 332c 2034 292c 0a20 2020 2020 2020  , 3, 4),.       
+00001c50: 2020 2020 206c 6173 745f 7368 6f77 6e3d       last_shown=
+00001c60: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00001c70: 2020 6578 7069 7265 5f61 6674 6572 3d27    expire_after='
+00001c80: 3173 272c 0a20 2020 2020 2020 2020 2020  1s',.           
+00001c90: 2072 6570 6561 745f 6166 7465 723d 2732   repeat_after='2
+00001ca0: 7327 2c0a 2020 2020 2020 2020 290a 2020  s',.        ).  
+00001cb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00001cc0: 7445 7175 616c 2877 6172 6e69 6e67 2e6d  tEqual(warning.m
+00001cd0: 6573 7361 6765 2c20 2742 6577 6172 6521  essage, 'Beware!
+00001ce0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00001cf0: 6173 7365 7274 4571 7561 6c28 7761 726e  assertEqual(warn
+00001d00: 696e 672e 6669 7273 745f 6164 6465 642c  ing.first_added,
+00001d10: 2064 6174 6574 696d 655f 7574 6328 3230   datetime_utc(20
+00001d20: 3231 2c20 312c 2031 2c20 312c 2031 2c20  21, 1, 1, 1, 1, 
+00001d30: 3129 290a 2020 2020 2020 2020 7365 6c66  1)).        self
+00001d40: 2e61 7373 6572 7445 7175 616c 2877 6172  .assertEqual(war
+00001d50: 6e69 6e67 2e6c 6173 745f 6164 6465 642c  ning.last_added,
+00001d60: 2064 6174 6574 696d 655f 7574 6328 3230   datetime_utc(20
+00001d70: 3231 2c20 312c 2032 362c 2032 2c20 332c  21, 1, 26, 2, 3,
+00001d80: 2034 2929 0a20 2020 2020 2020 2073 656c   4)).        sel
+00001d90: 662e 6173 7365 7274 4571 7561 6c28 7761  f.assertEqual(wa
+00001da0: 726e 696e 672e 6c61 7374 5f73 686f 776e  rning.last_shown
+00001db0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+00001dc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00001dd0: 2877 6172 6e69 6e67 2e65 7870 6972 655f  (warning.expire_
+00001de0: 6166 7465 722c 2027 3173 2729 0a20 2020  after, '1s').   
+00001df0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00001e00: 4571 7561 6c28 7761 726e 696e 672e 7265  Equal(warning.re
+00001e10: 7065 6174 5f61 6674 6572 2c20 2732 7327  peat_after, '2s'
+00001e20: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00001e30: 7761 726e 696e 675f 6672 6f6d 5f64 6963  warning_from_dic
+00001e40: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+00001e50: 2064 203d 207b 0a20 2020 2020 2020 2020   d = {.         
+00001e60: 2020 2027 6d65 7373 6167 6527 3a20 274c     'message': 'L
+00001e70: 6f6f 6b20 6f75 742e 2e2e 272c 0a20 2020  ook out...',.   
+00001e80: 2020 2020 2020 2020 2027 6669 7273 742d           'first-
+00001e90: 6164 6465 6427 3a20 2732 3032 302d 3132  added': '2020-12
+00001ea0: 2d32 3554 3137 3a31 383a 3534 2e30 3136  -25T17:18:54.016
+00001eb0: 3237 3337 3738 2b31 333a 3030 272c 0a20  273778+13:00',. 
+00001ec0: 2020 2020 2020 2020 2020 2027 6c61 7374             'last
+00001ed0: 2d61 6464 6564 273a 2027 3230 3231 2d30  -added': '2021-0
+00001ee0: 312d 3236 5431 373a 3031 3a30 322e 3132  1-26T17:01:02.12
+00001ef0: 3334 352b 3133 3a30 3027 2c0a 2020 2020  345+13:00',.    
+00001f00: 2020 2020 2020 2020 2765 7870 6972 652d          'expire-
+00001f10: 6166 7465 7227 3a20 2731 7327 2c0a 2020  after': '1s',.  
+00001f20: 2020 2020 2020 2020 2020 2772 6570 6561            'repea
+00001f30: 742d 6166 7465 7227 3a20 2732 7327 2c0a  t-after': '2s',.
+00001f40: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00001f50: 2020 7761 726e 696e 6720 3d20 7065 6262    warning = pebb
+00001f60: 6c65 2e57 6172 6e69 6e67 2e66 726f 6d5f  le.Warning.from_
+00001f70: 6469 6374 2864 290a 2020 2020 2020 2020  dict(d).        
+00001f80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00001f90: 2877 6172 6e69 6e67 2e6d 6573 7361 6765  (warning.message
+00001fa0: 2c20 274c 6f6f 6b20 6f75 742e 2e2e 2729  , 'Look out...')
+00001fb0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00001fc0: 7365 7274 4571 7561 6c28 7761 726e 696e  sertEqual(warnin
+00001fd0: 672e 6669 7273 745f 6164 6465 642c 2064  g.first_added, d
+00001fe0: 6174 6574 696d 655f 6e7a 6474 2832 3032  atetime_nzdt(202
+00001ff0: 302c 2031 322c 2032 352c 2031 372c 2031  0, 12, 25, 17, 1
+00002000: 382c 2035 342c 2031 3632 3734 2929 0a20  8, 54, 16274)). 
+00002010: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00002020: 7274 4571 7561 6c28 7761 726e 696e 672e  rtEqual(warning.
+00002030: 6c61 7374 5f61 6464 6564 2c20 6461 7465  last_added, date
+00002040: 7469 6d65 5f6e 7a64 7428 3230 3231 2c20  time_nzdt(2021, 
+00002050: 312c 2032 362c 2031 372c 2031 2c20 322c  1, 26, 17, 1, 2,
+00002060: 2031 3233 3435 3029 290a 2020 2020 2020   123450)).      
+00002070: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00002080: 616c 2877 6172 6e69 6e67 2e6c 6173 745f  al(warning.last_
+00002090: 7368 6f77 6e2c 204e 6f6e 6529 0a20 2020  shown, None).   
+000020a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000020b0: 4571 7561 6c28 7761 726e 696e 672e 6578  Equal(warning.ex
+000020c0: 7069 7265 5f61 6674 6572 2c20 2731 7327  pire_after, '1s'
+000020d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000020e0: 7373 6572 7445 7175 616c 2877 6172 6e69  ssertEqual(warni
+000020f0: 6e67 2e72 6570 6561 745f 6166 7465 722c  ng.repeat_after,
+00002100: 2027 3273 2729 0a0a 2020 2020 2020 2020   '2s')..        
+00002110: 645b 276c 6173 742d 7368 6f77 6e27 5d20  d['last-shown'] 
+00002120: 3d20 4e6f 6e65 0a20 2020 2020 2020 2077  = None.        w
+00002130: 6172 6e69 6e67 203d 2070 6562 626c 652e  arning = pebble.
+00002140: 5761 726e 696e 672e 6672 6f6d 5f64 6963  Warning.from_dic
+00002150: 7428 6429 0a20 2020 2020 2020 2073 656c  t(d).        sel
+00002160: 662e 6173 7365 7274 4571 7561 6c28 7761  f.assertEqual(wa
+00002170: 726e 696e 672e 6c61 7374 5f73 686f 776e  rning.last_shown
+00002180: 2c20 4e6f 6e65 290a 0a20 2020 2020 2020  , None)..       
+00002190: 2064 5b27 6c61 7374 2d73 686f 776e 275d   d['last-shown']
+000021a0: 203d 2027 3230 3231 2d30 382d 3034 5430   = '2021-08-04T0
+000021b0: 333a 3032 3a30 312e 3030 3030 3030 3030  3:02:01.00000000
+000021c0: 302b 3133 3a30 3027 0a20 2020 2020 2020  0+13:00'.       
+000021d0: 2077 6172 6e69 6e67 203d 2070 6562 626c   warning = pebbl
+000021e0: 652e 5761 726e 696e 672e 6672 6f6d 5f64  e.Warning.from_d
+000021f0: 6963 7428 6429 0a20 2020 2020 2020 2073  ict(d).        s
+00002200: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00002210: 7761 726e 696e 672e 6c61 7374 5f73 686f  warning.last_sho
+00002220: 776e 2c20 6461 7465 7469 6d65 5f6e 7a64  wn, datetime_nzd
+00002230: 7428 3230 3231 2c20 382c 2034 2c20 332c  t(2021, 8, 4, 3,
+00002240: 2032 2c20 3129 290a 0a20 2020 2020 2020   2, 1))..       
+00002250: 2064 5b27 6669 7273 742d 6164 6465 6427   d['first-added'
+00002260: 5d20 3d20 2732 3032 302d 3032 2d30 3354  ] = '2020-02-03T
+00002270: 3032 3a30 303a 3430 2e30 3030 3030 302b  02:00:40.000000+
+00002280: 3030 3a30 3027 0a20 2020 2020 2020 2064  00:00'.        d
+00002290: 5b27 6c61 7374 2d61 6464 6564 275d 203d  ['last-added'] =
+000022a0: 2027 3230 3231 2d30 332d 3034 5430 333a   '2021-03-04T03:
+000022b0: 3031 3a34 312e 3130 3030 3030 2b30 303a  01:41.100000+00:
+000022c0: 3030 270a 2020 2020 2020 2020 645b 276c  00'.        d['l
+000022d0: 6173 742d 7368 6f77 6e27 5d20 3d20 2732  ast-shown'] = '2
+000022e0: 3032 322d 3034 2d30 3554 3036 3a30 323a  022-04-05T06:02:
+000022f0: 3432 2e32 3030 3030 302b 3030 3a30 3027  42.200000+00:00'
+00002300: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
+00002310: 203d 2070 6562 626c 652e 5761 726e 696e   = pebble.Warnin
+00002320: 672e 6672 6f6d 5f64 6963 7428 6429 0a20  g.from_dict(d). 
+00002330: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00002340: 7274 4571 7561 6c28 7761 726e 696e 672e  rtEqual(warning.
+00002350: 6669 7273 745f 6164 6465 642c 2064 6174  first_added, dat
+00002360: 6574 696d 655f 7574 6328 3230 3230 2c20  etime_utc(2020, 
+00002370: 322c 2033 2c20 322c 2030 2c20 3430 2c20  2, 3, 2, 0, 40, 
+00002380: 3029 290a 2020 2020 2020 2020 7365 6c66  0)).        self
+00002390: 2e61 7373 6572 7445 7175 616c 2877 6172  .assertEqual(war
+000023a0: 6e69 6e67 2e6c 6173 745f 6164 6465 642c  ning.last_added,
+000023b0: 2064 6174 6574 696d 655f 7574 6328 3230   datetime_utc(20
+000023c0: 3231 2c20 332c 2034 2c20 332c 2031 2c20  21, 3, 4, 3, 1, 
+000023d0: 3431 2c20 3130 3030 3030 2929 0a20 2020  41, 100000)).   
+000023e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000023f0: 4571 7561 6c28 7761 726e 696e 672e 6c61  Equal(warning.la
+00002400: 7374 5f73 686f 776e 2c20 6461 7465 7469  st_shown, dateti
+00002410: 6d65 5f75 7463 2832 3032 322c 2034 2c20  me_utc(2022, 4, 
+00002420: 352c 2036 2c20 322c 2034 322c 2032 3030  5, 6, 2, 42, 200
+00002430: 3030 3029 290a 0a20 2020 2064 6566 2074  000))..    def t
+00002440: 6573 745f 7461 736b 5f70 726f 6772 6573  est_task_progres
+00002450: 735f 696e 6974 2873 656c 6629 3a0a 2020  s_init(self):.  
+00002460: 2020 2020 2020 7470 203d 2070 6562 626c        tp = pebbl
+00002470: 652e 5461 736b 5072 6f67 7265 7373 286c  e.TaskProgress(l
+00002480: 6162 656c 3d27 666f 6f27 2c20 646f 6e65  abel='foo', done
+00002490: 3d33 2c20 746f 7461 6c3d 3729 0a20 2020  =3, total=7).   
+000024a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000024b0: 4571 7561 6c28 7470 2e6c 6162 656c 2c20  Equal(tp.label, 
+000024c0: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
+000024d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000024e0: 7470 2e64 6f6e 652c 2033 290a 2020 2020  tp.done, 3).    
+000024f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00002500: 7175 616c 2874 702e 746f 7461 6c2c 2037  qual(tp.total, 7
+00002510: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00002520: 7461 736b 5f70 726f 6772 6573 735f 6672  task_progress_fr
+00002530: 6f6d 5f64 6963 7428 7365 6c66 293a 0a20  om_dict(self):. 
+00002540: 2020 2020 2020 2074 7020 3d20 7065 6262         tp = pebb
+00002550: 6c65 2e54 6173 6b50 726f 6772 6573 732e  le.TaskProgress.
+00002560: 6672 6f6d 5f64 6963 7428 7b0a 2020 2020  from_dict({.    
+00002570: 2020 2020 2020 2020 276c 6162 656c 273a          'label':
+00002580: 2027 666f 6f27 2c0a 2020 2020 2020 2020   'foo',.        
+00002590: 2020 2020 2764 6f6e 6527 3a20 332c 0a20      'done': 3,. 
+000025a0: 2020 2020 2020 2020 2020 2027 746f 7461             'tota
+000025b0: 6c27 3a20 372c 0a20 2020 2020 2020 207d  l': 7,.        }
+000025c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000025d0: 7373 6572 7445 7175 616c 2874 702e 6c61  ssertEqual(tp.la
+000025e0: 6265 6c2c 2027 666f 6f27 290a 2020 2020  bel, 'foo').    
+000025f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00002600: 7175 616c 2874 702e 646f 6e65 2c20 3329  qual(tp.done, 3)
+00002610: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00002620: 7365 7274 4571 7561 6c28 7470 2e74 6f74  sertEqual(tp.tot
+00002630: 616c 2c20 3729 0a0a 2020 2020 6465 6620  al, 7)..    def 
+00002640: 7465 7374 5f74 6173 6b5f 6964 2873 656c  test_task_id(sel
+00002650: 6629 3a0a 2020 2020 2020 2020 7461 736b  f):.        task
+00002660: 5f69 6420 3d20 7065 6262 6c65 2e54 6173  _id = pebble.Tas
+00002670: 6b49 4428 2731 3233 3427 290a 2020 2020  kID('1234').    
+00002680: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00002690: 7175 616c 2874 6173 6b5f 6964 2c20 2731  qual(task_id, '1
+000026a0: 3233 3427 290a 0a20 2020 2064 6566 2074  234')..    def t
+000026b0: 6573 745f 7461 736b 5f69 6e69 7428 7365  est_task_init(se
+000026c0: 6c66 293a 0a20 2020 2020 2020 2074 6173  lf):.        tas
+000026d0: 6b20 3d20 7065 6262 6c65 2e54 6173 6b28  k = pebble.Task(
+000026e0: 0a20 2020 2020 2020 2020 2020 2069 643d  .            id=
+000026f0: 7065 6262 6c65 2e54 6173 6b49 4428 2734  pebble.TaskID('4
+00002700: 3227 292c 0a20 2020 2020 2020 2020 2020  2'),.           
+00002710: 206b 696e 643d 2773 7461 7274 272c 0a20   kind='start',. 
+00002720: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00002730: 7279 3d27 5374 6172 7420 7365 7276 6963  ry='Start servic
+00002740: 6520 2273 7663 2227 2c0a 2020 2020 2020  e "svc"',.      
+00002750: 2020 2020 2020 7374 6174 7573 3d27 446f        status='Do
+00002760: 6e65 272c 0a20 2020 2020 2020 2020 2020  ne',.           
+00002770: 206c 6f67 3d5b 5d2c 0a20 2020 2020 2020   log=[],.       
+00002780: 2020 2020 2070 726f 6772 6573 733d 7065       progress=pe
+00002790: 6262 6c65 2e54 6173 6b50 726f 6772 6573  bble.TaskProgres
+000027a0: 7328 6c61 6265 6c3d 2766 6f6f 272c 2064  s(label='foo', d
+000027b0: 6f6e 653d 332c 2074 6f74 616c 3d37 292c  one=3, total=7),
+000027c0: 0a20 2020 2020 2020 2020 2020 2073 7061  .            spa
+000027d0: 776e 5f74 696d 653d 6461 7465 7469 6d65  wn_time=datetime
+000027e0: 5f6e 7a64 7428 3230 3231 2c20 312c 2032  _nzdt(2021, 1, 2
+000027f0: 382c 2031 342c 2033 372c 2033 2c20 3237  8, 14, 37, 3, 27
+00002800: 3032 3138 292c 0a20 2020 2020 2020 2020  0218),.         
+00002810: 2020 2072 6561 6479 5f74 696d 653d 6461     ready_time=da
+00002820: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
+00002830: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
+00002840: 2032 2c20 3234 3731 3538 292c 0a20 2020   2, 247158),.   
+00002850: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00002860: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00002870: 7461 736b 2e69 642c 2027 3432 2729 0a20  task.id, '42'). 
+00002880: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00002890: 7274 4571 7561 6c28 7461 736b 2e6b 696e  rtEqual(task.kin
+000028a0: 642c 2027 7374 6172 7427 290a 2020 2020  d, 'start').    
+000028b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000028c0: 7175 616c 2874 6173 6b2e 7375 6d6d 6172  qual(task.summar
+000028d0: 792c 2027 5374 6172 7420 7365 7276 6963  y, 'Start servic
+000028e0: 6520 2273 7663 2227 290a 2020 2020 2020  e "svc"').      
+000028f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00002900: 616c 2874 6173 6b2e 7374 6174 7573 2c20  al(task.status, 
+00002910: 2744 6f6e 6527 290a 2020 2020 2020 2020  'Done').        
+00002920: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00002930: 2874 6173 6b2e 6c6f 672c 205b 5d29 0a20  (task.log, []). 
+00002940: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00002950: 7274 4571 7561 6c28 7461 736b 2e70 726f  rtEqual(task.pro
+00002960: 6772 6573 732e 6c61 6265 6c2c 2027 666f  gress.label, 'fo
+00002970: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
+00002980: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
+00002990: 6b2e 7072 6f67 7265 7373 2e64 6f6e 652c  k.progress.done,
+000029a0: 2033 290a 2020 2020 2020 2020 7365 6c66   3).        self
+000029b0: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
+000029c0: 6b2e 7072 6f67 7265 7373 2e74 6f74 616c  k.progress.total
+000029d0: 2c20 3729 0a20 2020 2020 2020 2073 656c  , 7).        sel
+000029e0: 662e 6173 7365 7274 4571 7561 6c28 7461  f.assertEqual(ta
+000029f0: 736b 2e73 7061 776e 5f74 696d 652c 2064  sk.spawn_time, d
+00002a00: 6174 6574 696d 655f 6e7a 6474 2832 3032  atetime_nzdt(202
+00002a10: 312c 2031 2c20 3238 2c20 3134 2c20 3337  1, 1, 28, 14, 37
+00002a20: 2c20 332c 2032 3730 3231 3829 290a 2020  , 3, 270218)).  
+00002a30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00002a40: 7445 7175 616c 2874 6173 6b2e 7265 6164  tEqual(task.read
+00002a50: 795f 7469 6d65 2c20 6461 7465 7469 6d65  y_time, datetime
+00002a60: 5f6e 7a64 7428 3230 3231 2c20 312c 2032  _nzdt(2021, 1, 2
+00002a70: 382c 2031 342c 2033 372c 2032 2c20 3234  8, 14, 37, 2, 24
+00002a80: 3731 3538 2929 0a20 2020 2020 2020 2073  7158)).        s
+00002a90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00002aa0: 7461 736b 2e64 6174 612c 207b 7d29 0a0a  task.data, {})..
+00002ab0: 2020 2020 6465 6620 7465 7374 5f74 6173      def test_tas
+00002ac0: 6b5f 6672 6f6d 5f64 6963 7428 7365 6c66  k_from_dict(self
+00002ad0: 293a 0a20 2020 2020 2020 2064 203d 207b  ):.        d = {
+00002ae0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
+00002af0: 223a 2022 3738 222c 0a20 2020 2020 2020  ": "78",.       
+00002b00: 2020 2020 2022 6b69 6e64 223a 2022 7374       "kind": "st
+00002b10: 6172 7422 2c0a 2020 2020 2020 2020 2020  art",.          
+00002b20: 2020 2270 726f 6772 6573 7322 3a20 7b0a    "progress": {.
+00002b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b40: 2264 6f6e 6522 3a20 312c 0a20 2020 2020  "done": 1,.     
+00002b50: 2020 2020 2020 2020 2020 2022 6c61 6265             "labe
+00002b60: 6c22 3a20 2222 2c0a 2020 2020 2020 2020  l": "",.        
+00002b70: 2020 2020 2020 2020 2274 6f74 616c 223a          "total":
+00002b80: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+00002b90: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
+00002ba0: 7265 6164 792d 7469 6d65 223a 2022 3230  ready-time": "20
+00002bb0: 3231 2d30 312d 3238 5431 343a 3337 3a30  21-01-28T14:37:0
+00002bc0: 332e 3237 3032 3138 3737 382b 3133 3a30  3.270218778+13:0
+00002bd0: 3022 2c0a 2020 2020 2020 2020 2020 2020  0",.            
+00002be0: 2273 7061 776e 2d74 696d 6522 3a20 2232  "spawn-time": "2
+00002bf0: 3032 312d 3031 2d32 3854 3134 3a33 373a  021-01-28T14:37:
+00002c00: 3032 2e32 3437 3135 3831 3632 2b31 333a  02.247158162+13:
+00002c10: 3030 222c 0a20 2020 2020 2020 2020 2020  00",.           
+00002c20: 2022 7374 6174 7573 223a 2022 446f 6e65   "status": "Done
+00002c30: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00002c40: 7375 6d6d 6172 7922 3a20 2753 7461 7274  summary": 'Start
+00002c50: 2073 6572 7669 6365 2022 7376 6322 272c   service "svc"',
+00002c60: 0a20 2020 2020 2020 2020 2020 2022 6461  .            "da
+00002c70: 7461 223a 207b 2265 7869 742d 636f 6465  ta": {"exit-code
+00002c80: 223a 2034 327d 2c0a 2020 2020 2020 2020  ": 42},.        
+00002c90: 7d0a 2020 2020 2020 2020 7461 736b 203d  }.        task =
+00002ca0: 2070 6562 626c 652e 5461 736b 2e66 726f   pebble.Task.fro
+00002cb0: 6d5f 6469 6374 2864 290a 2020 2020 2020  m_dict(d).      
+00002cc0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00002cd0: 616c 2874 6173 6b2e 6964 2c20 2737 3827  al(task.id, '78'
+00002ce0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00002cf0: 7373 6572 7445 7175 616c 2874 6173 6b2e  ssertEqual(task.
+00002d00: 6b69 6e64 2c20 2773 7461 7274 2729 0a20  kind, 'start'). 
+00002d10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00002d20: 7274 4571 7561 6c28 7461 736b 2e73 756d  rtEqual(task.sum
+00002d30: 6d61 7279 2c20 2753 7461 7274 2073 6572  mary, 'Start ser
+00002d40: 7669 6365 2022 7376 6322 2729 0a20 2020  vice "svc"').   
+00002d50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00002d60: 4571 7561 6c28 7461 736b 2e73 7461 7475  Equal(task.statu
+00002d70: 732c 2027 446f 6e65 2729 0a20 2020 2020  s, 'Done').     
+00002d80: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00002d90: 7561 6c28 7461 736b 2e6c 6f67 2c20 5b5d  ual(task.log, []
+00002da0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00002db0: 7373 6572 7445 7175 616c 2874 6173 6b2e  ssertEqual(task.
+00002dc0: 7072 6f67 7265 7373 2e6c 6162 656c 2c20  progress.label, 
+00002dd0: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+00002de0: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
+00002df0: 6b2e 7072 6f67 7265 7373 2e64 6f6e 652c  k.progress.done,
+00002e00: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
+00002e10: 2e61 7373 6572 7445 7175 616c 2874 6173  .assertEqual(tas
+00002e20: 6b2e 7072 6f67 7265 7373 2e74 6f74 616c  k.progress.total
+00002e30: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
+00002e40: 662e 6173 7365 7274 4571 7561 6c28 7461  f.assertEqual(ta
+00002e50: 736b 2e72 6561 6479 5f74 696d 652c 2064  sk.ready_time, d
+00002e60: 6174 6574 696d 655f 6e7a 6474 2832 3032  atetime_nzdt(202
+00002e70: 312c 2031 2c20 3238 2c20 3134 2c20 3337  1, 1, 28, 14, 37
+00002e80: 2c20 332c 2032 3730 3231 3929 290a 2020  , 3, 270219)).  
+00002e90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00002ea0: 7445 7175 616c 2874 6173 6b2e 7370 6177  tEqual(task.spaw
+00002eb0: 6e5f 7469 6d65 2c20 6461 7465 7469 6d65  n_time, datetime
+00002ec0: 5f6e 7a64 7428 3230 3231 2c20 312c 2032  _nzdt(2021, 1, 2
+00002ed0: 382c 2031 342c 2033 372c 2032 2c20 3234  8, 14, 37, 2, 24
+00002ee0: 3731 3538 2929 0a20 2020 2020 2020 2073  7158)).        s
+00002ef0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00002f00: 7461 736b 2e64 6174 612c 207b 2765 7869  task.data, {'exi
+00002f10: 742d 636f 6465 273a 2034 327d 290a 0a20  t-code': 42}).. 
+00002f20: 2020 2020 2020 2064 5b27 7265 6164 792d         d['ready-
+00002f30: 7469 6d65 275d 203d 2027 3230 3231 2d30  time'] = '2021-0
+00002f40: 312d 3238 5431 343a 3337 3a30 332e 3237  1-28T14:37:03.27
+00002f50: 3032 3138 3737 382b 3030 3a30 3027 0a20  0218778+00:00'. 
+00002f60: 2020 2020 2020 2064 5b27 7370 6177 6e2d         d['spawn-
+00002f70: 7469 6d65 275d 203d 2027 3230 3231 2d30  time'] = '2021-0
+00002f80: 312d 3238 5431 343a 3337 3a30 322e 3234  1-28T14:37:02.24
+00002f90: 3731 3538 3136 322b 3030 3a30 3027 0a20  7158162+00:00'. 
+00002fa0: 2020 2020 2020 2074 6173 6b20 3d20 7065         task = pe
+00002fb0: 6262 6c65 2e54 6173 6b2e 6672 6f6d 5f64  bble.Task.from_d
+00002fc0: 6963 7428 6429 0a20 2020 2020 2020 2073  ict(d).        s
+00002fd0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00002fe0: 7461 736b 2e72 6561 6479 5f74 696d 652c  task.ready_time,
+00002ff0: 2064 6174 6574 696d 655f 7574 6328 3230   datetime_utc(20
+00003000: 3231 2c20 312c 2032 382c 2031 342c 2033  21, 1, 28, 14, 3
+00003010: 372c 2033 2c20 3237 3032 3139 2929 0a20  7, 3, 270219)). 
+00003020: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00003030: 7274 4571 7561 6c28 7461 736b 2e73 7061  rtEqual(task.spa
+00003040: 776e 5f74 696d 652c 2064 6174 6574 696d  wn_time, datetim
+00003050: 655f 7574 6328 3230 3231 2c20 312c 2032  e_utc(2021, 1, 2
+00003060: 382c 2031 342c 2033 372c 2032 2c20 3234  8, 14, 37, 2, 24
+00003070: 3731 3538 2929 0a0a 2020 2020 6465 6620  7158))..    def 
+00003080: 7465 7374 5f63 6861 6e67 655f 6964 2873  test_change_id(s
+00003090: 656c 6629 3a0a 2020 2020 2020 2020 6368  elf):.        ch
+000030a0: 616e 6765 5f69 6420 3d20 7065 6262 6c65  ange_id = pebble
+000030b0: 2e43 6861 6e67 6549 4428 2731 3233 3427  .ChangeID('1234'
+000030c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000030d0: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
+000030e0: 655f 6964 2c20 2731 3233 3427 290a 0a20  e_id, '1234').. 
+000030f0: 2020 2064 6566 2074 6573 745f 6368 616e     def test_chan
+00003100: 6765 5f69 6e69 7428 7365 6c66 293a 0a20  ge_init(self):. 
+00003110: 2020 2020 2020 2063 6861 6e67 6520 3d20         change = 
+00003120: 7065 6262 6c65 2e43 6861 6e67 6528 0a20  pebble.Change(. 
+00003130: 2020 2020 2020 2020 2020 2069 643d 7065             id=pe
+00003140: 6262 6c65 2e43 6861 6e67 6549 4428 2737  bble.ChangeID('7
+00003150: 3027 292c 0a20 2020 2020 2020 2020 2020  0'),.           
+00003160: 206b 696e 643d 2761 7574 6f73 7461 7274   kind='autostart
+00003170: 272c 0a20 2020 2020 2020 2020 2020 2065  ',.            e
+00003180: 7272 3d27 5349 4c4c 5927 2c0a 2020 2020  rr='SILLY',.    
+00003190: 2020 2020 2020 2020 7265 6164 793d 5472          ready=Tr
+000031a0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+000031b0: 7265 6164 795f 7469 6d65 3d64 6174 6574  ready_time=datet
+000031c0: 696d 655f 6e7a 6474 2832 3032 312c 2031  ime_nzdt(2021, 1
+000031d0: 2c20 3238 2c20 3134 2c20 3337 2c20 342c  , 28, 14, 37, 4,
+000031e0: 2032 3931 3531 3729 2c0a 2020 2020 2020   291517),.      
+000031f0: 2020 2020 2020 7370 6177 6e5f 7469 6d65        spawn_time
+00003200: 3d64 6174 6574 696d 655f 6e7a 6474 2832  =datetime_nzdt(2
+00003210: 3032 312c 2031 2c20 3238 2c20 3134 2c20  021, 1, 28, 14, 
+00003220: 3337 2c20 322c 2032 3437 3230 3229 2c0a  37, 2, 247202),.
+00003230: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00003240: 7573 3d27 446f 6e65 272c 0a20 2020 2020  us='Done',.     
+00003250: 2020 2020 2020 2073 756d 6d61 7279 3d27         summary='
+00003260: 4175 746f 7374 6172 7420 7365 7276 6963  Autostart servic
+00003270: 6520 2273 7663 2227 2c0a 2020 2020 2020  e "svc"',.      
+00003280: 2020 2020 2020 7461 736b 733d 5b5d 2c0a        tasks=[],.
+00003290: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000032a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000032b0: 616c 2863 6861 6e67 652e 6964 2c20 2737  al(change.id, '7
+000032c0: 3027 290a 2020 2020 2020 2020 7365 6c66  0').        self
+000032d0: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
+000032e0: 6e67 652e 6b69 6e64 2c20 2761 7574 6f73  nge.kind, 'autos
+000032f0: 7461 7274 2729 0a20 2020 2020 2020 2073  tart').        s
+00003300: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00003310: 6368 616e 6765 2e65 7272 2c20 2753 494c  change.err, 'SIL
+00003320: 4c59 2729 0a20 2020 2020 2020 2073 656c  LY').        sel
+00003330: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00003340: 616e 6765 2e72 6561 6479 2c20 5472 7565  ange.ready, True
+00003350: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00003360: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
+00003370: 652e 7265 6164 795f 7469 6d65 2c20 6461  e.ready_time, da
+00003380: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
+00003390: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
+000033a0: 2034 2c20 3239 3135 3137 2929 0a20 2020   4, 291517)).   
+000033b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000033c0: 4571 7561 6c28 6368 616e 6765 2e73 7061  Equal(change.spa
+000033d0: 776e 5f74 696d 652c 2064 6174 6574 696d  wn_time, datetim
+000033e0: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
+000033f0: 3238 2c20 3134 2c20 3337 2c20 322c 2032  28, 14, 37, 2, 2
+00003400: 3437 3230 3229 290a 2020 2020 2020 2020  47202)).        
+00003410: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00003420: 2863 6861 6e67 652e 7374 6174 7573 2c20  (change.status, 
+00003430: 2744 6f6e 6527 290a 2020 2020 2020 2020  'Done').        
+00003440: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00003450: 2863 6861 6e67 652e 7375 6d6d 6172 792c  (change.summary,
+00003460: 2027 4175 746f 7374 6172 7420 7365 7276   'Autostart serv
+00003470: 6963 6520 2273 7663 2227 290a 2020 2020  ice "svc"').    
+00003480: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00003490: 7175 616c 2863 6861 6e67 652e 7461 736b  qual(change.task
+000034a0: 732c 205b 5d29 0a20 2020 2020 2020 2073  s, []).        s
+000034b0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000034c0: 6368 616e 6765 2e64 6174 612c 207b 7d29  change.data, {})
+000034d0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
+000034e0: 6861 6e67 655f 6672 6f6d 5f64 6963 7428  hange_from_dict(
+000034f0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+00003500: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00003510: 2022 6964 223a 2022 3730 222c 0a20 2020   "id": "70",.   
+00003520: 2020 2020 2020 2020 2022 6b69 6e64 223a           "kind":
+00003530: 2022 6175 746f 7374 6172 7422 2c0a 2020   "autostart",.  
+00003540: 2020 2020 2020 2020 2020 2265 7272 223a            "err":
+00003550: 2022 5349 4c4c 5922 2c0a 2020 2020 2020   "SILLY",.      
+00003560: 2020 2020 2020 2272 6561 6479 223a 2054        "ready": T
+00003570: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00003580: 2022 7265 6164 792d 7469 6d65 223a 2022   "ready-time": "
+00003590: 3230 3231 2d30 312d 3238 5431 343a 3337  2021-01-28T14:37
+000035a0: 3a30 342e 3239 3135 3137 3736 382b 3133  :04.291517768+13
+000035b0: 3a30 3022 2c0a 2020 2020 2020 2020 2020  :00",.          
+000035c0: 2020 2273 7061 776e 2d74 696d 6522 3a20    "spawn-time": 
+000035d0: 2232 3032 312d 3031 2d32 3854 3134 3a33  "2021-01-28T14:3
+000035e0: 373a 3032 2e32 3437 3230 3231 3035 2b31  7:02.247202105+1
+000035f0: 333a 3030 222c 0a20 2020 2020 2020 2020  3:00",.         
+00003600: 2020 2022 7374 6174 7573 223a 2022 446f     "status": "Do
+00003610: 6e65 222c 0a20 2020 2020 2020 2020 2020  ne",.           
+00003620: 2022 7375 6d6d 6172 7922 3a20 2741 7574   "summary": 'Aut
+00003630: 6f73 7461 7274 2073 6572 7669 6365 2022  ostart service "
+00003640: 7376 6322 272c 0a20 2020 2020 2020 2020  svc"',.         
+00003650: 2020 2022 7461 736b 7322 3a20 5b5d 2c0a     "tasks": [],.
+00003660: 2020 2020 2020 2020 2020 2020 2264 6174              "dat
+00003670: 6122 3a20 7b22 6578 6974 2d63 6f64 6522  a": {"exit-code"
+00003680: 3a20 3432 7d2c 0a20 2020 2020 2020 207d  : 42},.        }
+00003690: 0a20 2020 2020 2020 2063 6861 6e67 6520  .        change 
+000036a0: 3d20 7065 6262 6c65 2e43 6861 6e67 652e  = pebble.Change.
+000036b0: 6672 6f6d 5f64 6963 7428 6429 0a20 2020  from_dict(d).   
+000036c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000036d0: 4571 7561 6c28 6368 616e 6765 2e69 642c  Equal(change.id,
+000036e0: 2027 3730 2729 0a20 2020 2020 2020 2073   '70').        s
+000036f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00003700: 6368 616e 6765 2e6b 696e 642c 2027 6175  change.kind, 'au
+00003710: 746f 7374 6172 7427 290a 2020 2020 2020  tostart').      
+00003720: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00003730: 616c 2863 6861 6e67 652e 6572 722c 2027  al(change.err, '
+00003740: 5349 4c4c 5927 290a 2020 2020 2020 2020  SILLY').        
+00003750: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00003760: 2863 6861 6e67 652e 7265 6164 792c 2054  (change.ready, T
+00003770: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00003780: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00003790: 616e 6765 2e72 6561 6479 5f74 696d 652c  ange.ready_time,
+000037a0: 2064 6174 6574 696d 655f 6e7a 6474 2832   datetime_nzdt(2
+000037b0: 3032 312c 2031 2c20 3238 2c20 3134 2c20  021, 1, 28, 14, 
+000037c0: 3337 2c20 342c 2032 3931 3531 3829 290a  37, 4, 291518)).
+000037d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000037e0: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
+000037f0: 7370 6177 6e5f 7469 6d65 2c20 6461 7465  spawn_time, date
+00003800: 7469 6d65 5f6e 7a64 7428 3230 3231 2c20  time_nzdt(2021, 
+00003810: 312c 2032 382c 2031 342c 2033 372c 2032  1, 28, 14, 37, 2
+00003820: 2c20 3234 3732 3032 2929 0a20 2020 2020  , 247202)).     
+00003830: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00003840: 7561 6c28 6368 616e 6765 2e73 7461 7475  ual(change.statu
+00003850: 732c 2027 446f 6e65 2729 0a20 2020 2020  s, 'Done').     
+00003860: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00003870: 7561 6c28 6368 616e 6765 2e73 756d 6d61  ual(change.summa
+00003880: 7279 2c20 2741 7574 6f73 7461 7274 2073  ry, 'Autostart s
+00003890: 6572 7669 6365 2022 7376 6322 2729 0a20  ervice "svc"'). 
+000038a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000038b0: 7274 4571 7561 6c28 6368 616e 6765 2e74  rtEqual(change.t
+000038c0: 6173 6b73 2c20 5b5d 290a 2020 2020 2020  asks, []).      
+000038d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000038e0: 616c 2863 6861 6e67 652e 6461 7461 2c20  al(change.data, 
+000038f0: 7b27 6578 6974 2d63 6f64 6527 3a20 3432  {'exit-code': 42
+00003900: 7d29 0a0a 2020 2020 2020 2020 645b 2772  })..        d['r
+00003910: 6561 6479 2d74 696d 6527 5d20 3d20 2732  eady-time'] = '2
+00003920: 3032 312d 3031 2d32 3854 3134 3a33 373a  021-01-28T14:37:
+00003930: 3034 2e32 3931 3531 3737 3638 2b30 303a  04.291517768+00:
+00003940: 3030 270a 2020 2020 2020 2020 645b 2773  00'.        d['s
+00003950: 7061 776e 2d74 696d 6527 5d20 3d20 2732  pawn-time'] = '2
+00003960: 3032 312d 3031 2d32 3854 3134 3a33 373a  021-01-28T14:37:
+00003970: 3032 2e32 3437 3230 3231 3035 2b30 303a  02.247202105+00:
+00003980: 3030 270a 2020 2020 2020 2020 6368 616e  00'.        chan
+00003990: 6765 203d 2070 6562 626c 652e 4368 616e  ge = pebble.Chan
+000039a0: 6765 2e66 726f 6d5f 6469 6374 2864 290a  ge.from_dict(d).
+000039b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000039c0: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
+000039d0: 7265 6164 795f 7469 6d65 2c20 6461 7465  ready_time, date
+000039e0: 7469 6d65 5f75 7463 2832 3032 312c 2031  time_utc(2021, 1
+000039f0: 2c20 3238 2c20 3134 2c20 3337 2c20 342c  , 28, 14, 37, 4,
+00003a00: 2032 3931 3531 3829 290a 2020 2020 2020   291518)).      
+00003a10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00003a20: 616c 2863 6861 6e67 652e 7370 6177 6e5f  al(change.spawn_
+00003a30: 7469 6d65 2c20 6461 7465 7469 6d65 5f75  time, datetime_u
+00003a40: 7463 2832 3032 312c 2031 2c20 3238 2c20  tc(2021, 1, 28, 
+00003a50: 3134 2c20 3337 2c20 322c 2032 3437 3230  14, 37, 2, 24720
+00003a60: 3229 290a 0a20 2020 2064 6566 2074 6573  2))..    def tes
+00003a70: 745f 6669 6c65 5f74 7970 6528 7365 6c66  t_file_type(self
+00003a80: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00003a90: 6173 7365 7274 4571 7561 6c28 6c69 7374  assertEqual(list
+00003aa0: 2870 6562 626c 652e 4669 6c65 5479 7065  (pebble.FileType
+00003ab0: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
+00003ac0: 2070 6562 626c 652e 4669 6c65 5479 7065   pebble.FileType
+00003ad0: 2e46 494c 452c 0a20 2020 2020 2020 2020  .FILE,.         
+00003ae0: 2020 2070 6562 626c 652e 4669 6c65 5479     pebble.FileTy
+00003af0: 7065 2e44 4952 4543 544f 5259 2c0a 2020  pe.DIRECTORY,.  
+00003b00: 2020 2020 2020 2020 2020 7065 6262 6c65            pebble
+00003b10: 2e46 696c 6554 7970 652e 5359 4d4c 494e  .FileType.SYMLIN
+00003b20: 4b2c 0a20 2020 2020 2020 2020 2020 2070  K,.            p
+00003b30: 6562 626c 652e 4669 6c65 5479 7065 2e53  ebble.FileType.S
+00003b40: 4f43 4b45 542c 0a20 2020 2020 2020 2020  OCKET,.         
+00003b50: 2020 2070 6562 626c 652e 4669 6c65 5479     pebble.FileTy
+00003b60: 7065 2e4e 414d 4544 5f50 4950 452c 0a20  pe.NAMED_PIPE,. 
+00003b70: 2020 2020 2020 2020 2020 2070 6562 626c             pebbl
+00003b80: 652e 4669 6c65 5479 7065 2e44 4556 4943  e.FileType.DEVIC
+00003b90: 452c 0a20 2020 2020 2020 2020 2020 2070  E,.            p
+00003ba0: 6562 626c 652e 4669 6c65 5479 7065 2e55  ebble.FileType.U
+00003bb0: 4e4b 4e4f 574e 2c0a 2020 2020 2020 2020  NKNOWN,.        
+00003bc0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00003bd0: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
+00003be0: 6c65 2e46 696c 6554 7970 652e 4649 4c45  le.FileType.FILE
+00003bf0: 2e76 616c 7565 2c20 2766 696c 6527 290a  .value, 'file').
+00003c00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00003c10: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+00003c20: 4669 6c65 5479 7065 2e44 4952 4543 544f  FileType.DIRECTO
+00003c30: 5259 2e76 616c 7565 2c20 2764 6972 6563  RY.value, 'direc
+00003c40: 746f 7279 2729 0a20 2020 2020 2020 2073  tory').        s
+00003c50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00003c60: 7065 6262 6c65 2e46 696c 6554 7970 652e  pebble.FileType.
+00003c70: 5359 4d4c 494e 4b2e 7661 6c75 652c 2027  SYMLINK.value, '
+00003c80: 7379 6d6c 696e 6b27 290a 2020 2020 2020  symlink').      
+00003c90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00003ca0: 616c 2870 6562 626c 652e 4669 6c65 5479  al(pebble.FileTy
+00003cb0: 7065 2e53 4f43 4b45 542e 7661 6c75 652c  pe.SOCKET.value,
+00003cc0: 2027 736f 636b 6574 2729 0a20 2020 2020   'socket').     
+00003cd0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00003ce0: 7561 6c28 7065 6262 6c65 2e46 696c 6554  ual(pebble.FileT
+00003cf0: 7970 652e 4e41 4d45 445f 5049 5045 2e76  ype.NAMED_PIPE.v
+00003d00: 616c 7565 2c20 276e 616d 6564 2d70 6970  alue, 'named-pip
+00003d10: 6527 290a 2020 2020 2020 2020 7365 6c66  e').        self
+00003d20: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
+00003d30: 626c 652e 4669 6c65 5479 7065 2e44 4556  ble.FileType.DEV
+00003d40: 4943 452e 7661 6c75 652c 2027 6465 7669  ICE.value, 'devi
+00003d50: 6365 2729 0a20 2020 2020 2020 2073 656c  ce').        sel
+00003d60: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
+00003d70: 6262 6c65 2e46 696c 6554 7970 652e 554e  bble.FileType.UN
+00003d80: 4b4e 4f57 4e2e 7661 6c75 652c 2027 756e  KNOWN.value, 'un
+00003d90: 6b6e 6f77 6e27 290a 0a20 2020 2064 6566  known')..    def
+00003da0: 2074 6573 745f 6669 6c65 5f69 6e66 6f5f   test_file_info_
+00003db0: 696e 6974 2873 656c 6629 3a0a 2020 2020  init(self):.    
+00003dc0: 2020 2020 696e 666f 203d 2070 6562 626c      info = pebbl
+00003dd0: 652e 4669 6c65 496e 666f 2827 2f65 7463  e.FileInfo('/etc
+00003de0: 2f68 6f73 7473 272c 2027 686f 7374 7327  /hosts', 'hosts'
+00003df0: 2c20 7065 6262 6c65 2e46 696c 6554 7970  , pebble.FileTyp
+00003e00: 652e 4649 4c45 2c20 3132 332c 2030 6f36  e.FILE, 123, 0o6
+00003e10: 3434 2c0a 2020 2020 2020 2020 2020 2020  44,.            
 00003e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e30: 2020 2020 2020 2020 6461 7465 7469 6d65          datetime
-00003e40: 5f6e 7a64 7428 3230 3231 2c20 312c 2032  _nzdt(2021, 1, 2
-00003e50: 382c 2031 342c 2033 372c 2034 2c20 3239  8, 14, 37, 4, 29
-00003e60: 3135 3138 292c 0a20 2020 2020 2020 2020  1518),.         
+00003e30: 2020 2064 6174 6574 696d 655f 6e7a 6474     datetime_nzdt
+00003e40: 2832 3032 312c 2031 2c20 3238 2c20 3134  (2021, 1, 28, 14
+00003e50: 2c20 3337 2c20 342c 2032 3931 3531 3829  , 37, 4, 291518)
+00003e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00003e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e80: 2020 2020 2020 3132 2c20 2762 6f62 272c        12, 'bob',
-00003e90: 2033 342c 2027 7374 6166 6627 290a 2020   34, 'staff').  
-00003ea0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00003eb0: 7445 7175 616c 2869 6e66 6f2e 7061 7468  tEqual(info.path
-00003ec0: 2c20 272f 6574 632f 686f 7374 7327 290a  , '/etc/hosts').
-00003ed0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00003ee0: 6572 7445 7175 616c 2869 6e66 6f2e 6e61  ertEqual(info.na
-00003ef0: 6d65 2c20 2768 6f73 7473 2729 0a20 2020  me, 'hosts').   
-00003f00: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003f10: 4571 7561 6c28 696e 666f 2e74 7970 652c  Equal(info.type,
-00003f20: 2070 6562 626c 652e 4669 6c65 5479 7065   pebble.FileType
-00003f30: 2e46 494c 4529 0a20 2020 2020 2020 2073  .FILE).        s
-00003f40: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00003f50: 696e 666f 2e73 697a 652c 2031 3233 290a  info.size, 123).
-00003f60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00003f70: 6572 7445 7175 616c 2869 6e66 6f2e 7065  ertEqual(info.pe
-00003f80: 726d 6973 7369 6f6e 732c 2030 6f36 3434  rmissions, 0o644
-00003f90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00003fa0: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
-00003fb0: 6c61 7374 5f6d 6f64 6966 6965 642c 2064  last_modified, d
-00003fc0: 6174 6574 696d 655f 6e7a 6474 2832 3032  atetime_nzdt(202
-00003fd0: 312c 2031 2c20 3238 2c20 3134 2c20 3337  1, 1, 28, 14, 37
-00003fe0: 2c20 342c 2032 3931 3531 3829 290a 2020  , 4, 291518)).  
-00003ff0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00004000: 7445 7175 616c 2869 6e66 6f2e 7573 6572  tEqual(info.user
-00004010: 5f69 642c 2031 3229 0a20 2020 2020 2020  _id, 12).       
-00004020: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00004030: 6c28 696e 666f 2e75 7365 722c 2027 626f  l(info.user, 'bo
-00004040: 6227 290a 2020 2020 2020 2020 7365 6c66  b').        self
-00004050: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-00004060: 6f2e 6772 6f75 705f 6964 2c20 3334 290a  o.group_id, 34).
-00004070: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00004080: 6572 7445 7175 616c 2869 6e66 6f2e 6772  ertEqual(info.gr
-00004090: 6f75 702c 2027 7374 6166 6627 290a 0a20  oup, 'staff').. 
-000040a0: 2020 2064 6566 2074 6573 745f 6669 6c65     def test_file
-000040b0: 5f69 6e66 6f5f 6672 6f6d 5f64 6963 7428  _info_from_dict(
-000040c0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-000040d0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-000040e0: 2027 7061 7468 273a 2027 2f65 7463 272c   'path': '/etc',
-000040f0: 0a20 2020 2020 2020 2020 2020 2027 6e61  .            'na
-00004100: 6d65 273a 2027 6574 6327 2c0a 2020 2020  me': 'etc',.    
-00004110: 2020 2020 2020 2020 2774 7970 6527 3a20          'type': 
-00004120: 2764 6972 6563 746f 7279 272c 0a20 2020  'directory',.   
-00004130: 2020 2020 2020 2020 2027 7065 726d 6973           'permis
-00004140: 7369 6f6e 7327 3a20 2736 3434 272c 0a20  sions': '644',. 
-00004150: 2020 2020 2020 2020 2020 2027 6c61 7374             'last
-00004160: 2d6d 6f64 6966 6965 6427 3a20 2732 3032  -modified': '202
-00004170: 312d 3031 2d32 3854 3134 3a33 373a 3034  1-01-28T14:37:04
-00004180: 2e32 3931 3531 3737 3638 2b31 333a 3030  .291517768+13:00
-00004190: 272c 0a20 2020 2020 2020 207d 0a20 2020  ',.        }.   
-000041a0: 2020 2020 2069 6e66 6f20 3d20 7065 6262       info = pebb
-000041b0: 6c65 2e46 696c 6549 6e66 6f2e 6672 6f6d  le.FileInfo.from
-000041c0: 5f64 6963 7428 6429 0a20 2020 2020 2020  _dict(d).       
-000041d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000041e0: 6c28 696e 666f 2e70 6174 682c 2027 2f65  l(info.path, '/e
-000041f0: 7463 2729 0a20 2020 2020 2020 2073 656c  tc').        sel
-00004200: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
-00004210: 666f 2e6e 616d 652c 2027 6574 6327 290a  fo.name, 'etc').
-00004220: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00004230: 6572 7445 7175 616c 2869 6e66 6f2e 7479  ertEqual(info.ty
-00004240: 7065 2c20 7065 6262 6c65 2e46 696c 6554  pe, pebble.FileT
-00004250: 7970 652e 4449 5245 4354 4f52 5929 0a20  ype.DIRECTORY). 
-00004260: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00004270: 7274 4571 7561 6c28 696e 666f 2e70 6572  rtEqual(info.per
-00004280: 6d69 7373 696f 6e73 2c20 306f 3634 3429  missions, 0o644)
-00004290: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000042a0: 7365 7274 4571 7561 6c28 696e 666f 2e6c  sertEqual(info.l
-000042b0: 6173 745f 6d6f 6469 6669 6564 2c20 6461  ast_modified, da
-000042c0: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
-000042d0: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
-000042e0: 2034 2c20 3239 3135 3138 2929 0a20 2020   4, 291518)).   
-000042f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00004300: 4973 2869 6e66 6f2e 7573 6572 5f69 642c  Is(info.user_id,
-00004310: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
-00004320: 656c 662e 6173 7365 7274 4973 2869 6e66  elf.assertIs(inf
-00004330: 6f2e 7573 6572 2c20 4e6f 6e65 290a 2020  o.user, None).  
-00004340: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00004350: 7449 7328 696e 666f 2e67 726f 7570 5f69  tIs(info.group_i
-00004360: 642c 204e 6f6e 6529 0a20 2020 2020 2020  d, None).       
-00004370: 2073 656c 662e 6173 7365 7274 4973 2869   self.assertIs(i
-00004380: 6e66 6f2e 6772 6f75 702c 204e 6f6e 6529  nfo.group, None)
-00004390: 0a0a 2020 2020 2020 2020 645b 2774 7970  ..        d['typ
-000043a0: 6527 5d20 3d20 2766 6f6f 6261 7227 0a20  e'] = 'foobar'. 
-000043b0: 2020 2020 2020 2064 5b27 7369 7a65 275d         d['size']
-000043c0: 203d 2031 3233 0a20 2020 2020 2020 2064   = 123.        d
-000043d0: 5b27 7573 6572 2d69 6427 5d20 3d20 3132  ['user-id'] = 12
-000043e0: 0a20 2020 2020 2020 2064 5b27 7573 6572  .        d['user
-000043f0: 275d 203d 2027 626f 6227 0a20 2020 2020  '] = 'bob'.     
-00004400: 2020 2064 5b27 6772 6f75 702d 6964 275d     d['group-id']
-00004410: 203d 2033 340a 2020 2020 2020 2020 645b   = 34.        d[
-00004420: 2767 726f 7570 275d 203d 2027 7374 6166  'group'] = 'staf
-00004430: 6627 0a20 2020 2020 2020 2069 6e66 6f20  f'.        info 
-00004440: 3d20 7065 6262 6c65 2e46 696c 6549 6e66  = pebble.FileInf
-00004450: 6f2e 6672 6f6d 5f64 6963 7428 6429 0a20  o.from_dict(d). 
-00004460: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00004470: 7274 4571 7561 6c28 696e 666f 2e74 7970  rtEqual(info.typ
-00004480: 652c 2027 666f 6f62 6172 2729 0a20 2020  e, 'foobar').   
-00004490: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000044a0: 4571 7561 6c28 696e 666f 2e73 697a 652c  Equal(info.size,
-000044b0: 2031 3233 290a 2020 2020 2020 2020 7365   123).        se
-000044c0: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-000044d0: 6e66 6f2e 7573 6572 5f69 642c 2031 3229  nfo.user_id, 12)
-000044e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000044f0: 7365 7274 4571 7561 6c28 696e 666f 2e75  sertEqual(info.u
-00004500: 7365 722c 2027 626f 6227 290a 2020 2020  ser, 'bob').    
-00004510: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00004520: 7175 616c 2869 6e66 6f2e 6772 6f75 705f  qual(info.group_
-00004530: 6964 2c20 3334 290a 2020 2020 2020 2020  id, 34).        
-00004540: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00004550: 2869 6e66 6f2e 6772 6f75 702c 2027 7374  (info.group, 'st
-00004560: 6166 6627 290a 0a0a 636c 6173 7320 5465  aff')...class Te
-00004570: 7374 506c 616e 2875 6e69 7474 6573 742e  stPlan(unittest.
-00004580: 5465 7374 4361 7365 293a 0a20 2020 2064  TestCase):.    d
-00004590: 6566 2074 6573 745f 6e6f 5f61 7267 7328  ef test_no_args(
-000045a0: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-000045b0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-000045c0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-000045d0: 3a0a 2020 2020 2020 2020 2020 2020 7065  :.            pe
-000045e0: 6262 6c65 2e50 6c61 6e28 290a 0a20 2020  bble.Plan()..   
-000045f0: 2064 6566 2074 6573 745f 7365 7276 6963   def test_servic
-00004600: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
-00004610: 2020 706c 616e 203d 2070 6562 626c 652e    plan = pebble.
-00004620: 506c 616e 2827 2729 0a20 2020 2020 2020  Plan('').       
-00004630: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00004640: 6c28 706c 616e 2e73 6572 7669 6365 732c  l(plan.services,
-00004650: 207b 7d29 0a0a 2020 2020 2020 2020 706c   {})..        pl
-00004660: 616e 203d 2070 6562 626c 652e 506c 616e  an = pebble.Plan
-00004670: 2827 7365 7276 6963 6573 3a5c 6e20 666f  ('services:\n fo
-00004680: 6f3a 5c6e 2020 6f76 6572 7269 6465 3a20  o:\n  override: 
-00004690: 7265 706c 6163 655c 6e20 2063 6f6d 6d61  replace\n  comma
-000046a0: 6e64 3a20 6563 686f 2066 6f6f 2729 0a0a  nd: echo foo')..
-000046b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000046c0: 6572 7445 7175 616c 286c 656e 2870 6c61  ertEqual(len(pla
-000046d0: 6e2e 7365 7276 6963 6573 292c 2031 290a  n.services), 1).
-000046e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000046f0: 6572 7445 7175 616c 2870 6c61 6e2e 7365  ertEqual(plan.se
-00004700: 7276 6963 6573 5b27 666f 6f27 5d2e 6e61  rvices['foo'].na
-00004710: 6d65 2c20 2766 6f6f 2729 0a20 2020 2020  me, 'foo').     
-00004720: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00004730: 7561 6c28 706c 616e 2e73 6572 7669 6365  ual(plan.service
-00004740: 735b 2766 6f6f 275d 2e6f 7665 7272 6964  s['foo'].overrid
-00004750: 652c 2027 7265 706c 6163 6527 290a 2020  e, 'replace').  
-00004760: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00004770: 7445 7175 616c 2870 6c61 6e2e 7365 7276  tEqual(plan.serv
-00004780: 6963 6573 5b27 666f 6f27 5d2e 636f 6d6d  ices['foo'].comm
-00004790: 616e 642c 2027 6563 686f 2066 6f6f 2729  and, 'echo foo')
-000047a0: 0a0a 2020 2020 2020 2020 2320 5368 6f75  ..        # Shou
-000047b0: 6c64 2062 6520 7265 6164 2d6f 6e6c 7920  ld be read-only 
-000047c0: 2822 6361 6e27 7420 7365 7420 6174 7472  ("can't set attr
-000047d0: 6962 7574 6522 290a 2020 2020 2020 2020  ibute").        
-000047e0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-000047f0: 5261 6973 6573 2841 7474 7269 6275 7465  Raises(Attribute
-00004800: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00004810: 2020 2020 706c 616e 2e73 6572 7669 6365      plan.service
-00004820: 7320 3d20 7b7d 0a0a 2020 2020 6465 6620  s = {}..    def 
-00004830: 7465 7374 5f63 6865 636b 7328 7365 6c66  test_checks(self
-00004840: 293a 0a20 2020 2020 2020 2070 6c61 6e20  ):.        plan 
-00004850: 3d20 7065 6262 6c65 2e50 6c61 6e28 2727  = pebble.Plan(''
-00004860: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00004870: 7373 6572 7445 7175 616c 2870 6c61 6e2e  ssertEqual(plan.
-00004880: 6368 6563 6b73 2c20 7b7d 290a 0a20 2020  checks, {})..   
-00004890: 2020 2020 2070 6c61 6e20 3d20 7065 6262       plan = pebb
-000048a0: 6c65 2e50 6c61 6e28 0a20 2020 2020 2020  le.Plan(.       
-000048b0: 2020 2020 2027 6368 6563 6b73 3a5c 6e20       'checks:\n 
-000048c0: 6261 723a 5c6e 2020 6f76 6572 7269 6465  bar:\n  override
-000048d0: 3a20 7265 706c 6163 655c 6e20 2068 7474  : replace\n  htt
-000048e0: 703a 5c6e 2020 2075 726c 3a20 6874 7470  p:\n   url: http
-000048f0: 733a 2f2f 6578 616d 706c 652e 636f 6d2f  s://example.com/
-00004900: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-00004910: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-00004920: 2870 6c61 6e2e 6368 6563 6b73 292c 2031  (plan.checks), 1
-00004930: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00004940: 7373 6572 7445 7175 616c 2870 6c61 6e2e  ssertEqual(plan.
-00004950: 6368 6563 6b73 5b27 6261 7227 5d2e 6e61  checks['bar'].na
-00004960: 6d65 2c20 2762 6172 2729 0a20 2020 2020  me, 'bar').     
-00004970: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00004980: 7561 6c28 706c 616e 2e63 6865 636b 735b  ual(plan.checks[
-00004990: 2762 6172 275d 2e6f 7665 7272 6964 652c  'bar'].override,
-000049a0: 2027 7265 706c 6163 6527 290a 2020 2020   'replace').    
-000049b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000049c0: 7175 616c 2870 6c61 6e2e 6368 6563 6b73  qual(plan.checks
-000049d0: 5b27 6261 7227 5d2e 6874 7470 2c20 7b27  ['bar'].http, {'
-000049e0: 7572 6c27 3a20 2768 7474 7073 3a2f 2f65  url': 'https://e
-000049f0: 7861 6d70 6c65 2e63 6f6d 2f27 7d29 0a0a  xample.com/'})..
-00004a00: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
-00004a10: 2062 6520 7265 6164 2d6f 6e6c 7920 2822   be read-only ("
-00004a20: 6361 6e27 7420 7365 7420 6174 7472 6962  can't set attrib
-00004a30: 7574 6522 290a 2020 2020 2020 2020 7769  ute").        wi
-00004a40: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00004a50: 6973 6573 2841 7474 7269 6275 7465 4572  ises(AttributeEr
-00004a60: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00004a70: 2020 706c 616e 2e63 6865 636b 7320 3d20    plan.checks = 
-00004a80: 7b7d 0a0a 2020 2020 6465 6620 7465 7374  {}..    def test
-00004a90: 5f79 616d 6c28 7365 6c66 293a 0a20 2020  _yaml(self):.   
-00004aa0: 2020 2020 2023 2053 7461 7274 696e 6720       # Starting 
-00004ab0: 7769 7468 206e 6f74 6869 6e67 2c20 7765  with nothing, we
-00004ac0: 2067 6574 2074 6865 2065 6d70 7479 2072   get the empty r
-00004ad0: 6573 756c 740a 2020 2020 2020 2020 706c  esult.        pl
-00004ae0: 616e 203d 2070 6562 626c 652e 506c 616e  an = pebble.Plan
-00004af0: 2827 2729 0a20 2020 2020 2020 2073 656c  ('').        sel
-00004b00: 662e 6173 7365 7274 4571 7561 6c28 706c  f.assertEqual(pl
-00004b10: 616e 2e74 6f5f 7961 6d6c 2829 2c20 277b  an.to_yaml(), '{
-00004b20: 7d5c 6e27 290a 2020 2020 2020 2020 7365  }\n').        se
-00004b30: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00004b40: 7472 2870 6c61 6e29 2c20 277b 7d5c 6e27  tr(plan), '{}\n'
-00004b50: 290a 0a20 2020 2020 2020 2023 2057 6974  )..        # Wit
-00004b60: 6820 6120 7365 7276 6963 652c 2077 6520  h a service, we 
-00004b70: 7265 7475 726e 2076 616c 6964 6174 6564  return validated
-00004b80: 2079 616d 6c20 636f 6e74 656e 742e 0a20   yaml content.. 
-00004b90: 2020 2020 2020 2072 6177 203d 2027 2727         raw = '''
-00004ba0: 5c0a 7365 7276 6963 6573 3a0a 2066 6f6f  \.services:. foo
-00004bb0: 3a0a 2020 6f76 6572 7269 6465 3a20 7265  :.  override: re
-00004bc0: 706c 6163 650a 2020 636f 6d6d 616e 643a  place.  command:
-00004bd0: 2065 6368 6f20 666f 6f0a 0a63 6865 636b   echo foo..check
-00004be0: 733a 0a20 6261 723a 0a20 2068 7474 703a  s:. bar:.  http:
-00004bf0: 0a20 2020 6874 7470 733a 2f2f 6578 616d  .   https://exam
-00004c00: 706c 652e 636f 6d2f 0a27 2727 0a20 2020  ple.com/.'''.   
-00004c10: 2020 2020 2070 6c61 6e20 3d20 7065 6262       plan = pebb
-00004c20: 6c65 2e50 6c61 6e28 7261 7729 0a20 2020  le.Plan(raw).   
-00004c30: 2020 2020 2072 6566 6f72 6d65 6420 3d20       reformed = 
-00004c40: 7961 6d6c 2e73 6166 655f 6475 6d70 2879  yaml.safe_dump(y
-00004c50: 616d 6c2e 7361 6665 5f6c 6f61 6428 7261  aml.safe_load(ra
-00004c60: 7729 290a 2020 2020 2020 2020 7365 6c66  w)).        self
-00004c70: 2e61 7373 6572 7445 7175 616c 2870 6c61  .assertEqual(pla
-00004c80: 6e2e 746f 5f79 616d 6c28 292c 2072 6566  n.to_yaml(), ref
-00004c90: 6f72 6d65 6429 0a20 2020 2020 2020 2073  ormed).        s
-00004ca0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00004cb0: 7374 7228 706c 616e 292c 2072 6566 6f72  str(plan), refor
-00004cc0: 6d65 6429 0a0a 2020 2020 6465 6620 7465  med)..    def te
-00004cd0: 7374 5f73 6572 7669 6365 5f65 7175 616c  st_service_equal
-00004ce0: 6974 7928 7365 6c66 293a 0a20 2020 2020  ity(self):.     
-00004cf0: 2020 2070 6c61 6e20 3d20 7065 6262 6c65     plan = pebble
-00004d00: 2e50 6c61 6e28 2773 6572 7669 6365 733a  .Plan('services:
-00004d10: 5c6e 2066 6f6f 3a5c 6e20 206f 7665 7272  \n foo:\n  overr
-00004d20: 6964 653a 2072 6570 6c61 6365 5c6e 2020  ide: replace\n  
-00004d30: 636f 6d6d 616e 643a 2065 6368 6f20 666f  command: echo fo
-00004d40: 6f27 290a 0a20 2020 2020 2020 206f 6c64  o')..        old
-00004d50: 5f73 6572 7669 6365 203d 2070 6562 626c  _service = pebbl
-00004d60: 652e 5365 7276 6963 6528 6e61 6d65 3d22  e.Service(name="
-00004d70: 666f 6f22 2c0a 2020 2020 2020 2020 2020  foo",.          
+00003e80: 2031 322c 2027 626f 6227 2c20 3334 2c20   12, 'bob', 34, 
+00003e90: 2773 7461 6666 2729 0a20 2020 2020 2020  'staff').       
+00003ea0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00003eb0: 6c28 696e 666f 2e70 6174 682c 2027 2f65  l(info.path, '/e
+00003ec0: 7463 2f68 6f73 7473 2729 0a20 2020 2020  tc/hosts').     
+00003ed0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00003ee0: 7561 6c28 696e 666f 2e6e 616d 652c 2027  ual(info.name, '
+00003ef0: 686f 7374 7327 290a 2020 2020 2020 2020  hosts').        
+00003f00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00003f10: 2869 6e66 6f2e 7479 7065 2c20 7065 6262  (info.type, pebb
+00003f20: 6c65 2e46 696c 6554 7970 652e 4649 4c45  le.FileType.FILE
+00003f30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00003f40: 7373 6572 7445 7175 616c 2869 6e66 6f2e  ssertEqual(info.
+00003f50: 7369 7a65 2c20 3132 3329 0a20 2020 2020  size, 123).     
+00003f60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00003f70: 7561 6c28 696e 666f 2e70 6572 6d69 7373  ual(info.permiss
+00003f80: 696f 6e73 2c20 306f 3634 3429 0a20 2020  ions, 0o644).   
+00003f90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00003fa0: 4571 7561 6c28 696e 666f 2e6c 6173 745f  Equal(info.last_
+00003fb0: 6d6f 6469 6669 6564 2c20 6461 7465 7469  modified, dateti
+00003fc0: 6d65 5f6e 7a64 7428 3230 3231 2c20 312c  me_nzdt(2021, 1,
+00003fd0: 2032 382c 2031 342c 2033 372c 2034 2c20   28, 14, 37, 4, 
+00003fe0: 3239 3135 3138 2929 0a20 2020 2020 2020  291518)).       
+00003ff0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00004000: 6c28 696e 666f 2e75 7365 725f 6964 2c20  l(info.user_id, 
+00004010: 3132 290a 2020 2020 2020 2020 7365 6c66  12).        self
+00004020: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+00004030: 6f2e 7573 6572 2c20 2762 6f62 2729 0a20  o.user, 'bob'). 
+00004040: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00004050: 7274 4571 7561 6c28 696e 666f 2e67 726f  rtEqual(info.gro
+00004060: 7570 5f69 642c 2033 3429 0a20 2020 2020  up_id, 34).     
+00004070: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00004080: 7561 6c28 696e 666f 2e67 726f 7570 2c20  ual(info.group, 
+00004090: 2773 7461 6666 2729 0a0a 2020 2020 6465  'staff')..    de
+000040a0: 6620 7465 7374 5f66 696c 655f 696e 666f  f test_file_info
+000040b0: 5f66 726f 6d5f 6469 6374 2873 656c 6629  _from_dict(self)
+000040c0: 3a0a 2020 2020 2020 2020 6420 3d20 7b0a  :.        d = {.
+000040d0: 2020 2020 2020 2020 2020 2020 2770 6174              'pat
+000040e0: 6827 3a20 272f 6574 6327 2c0a 2020 2020  h': '/etc',.    
+000040f0: 2020 2020 2020 2020 276e 616d 6527 3a20          'name': 
+00004100: 2765 7463 272c 0a20 2020 2020 2020 2020  'etc',.         
+00004110: 2020 2027 7479 7065 273a 2027 6469 7265     'type': 'dire
+00004120: 6374 6f72 7927 2c0a 2020 2020 2020 2020  ctory',.        
+00004130: 2020 2020 2770 6572 6d69 7373 696f 6e73      'permissions
+00004140: 273a 2027 3634 3427 2c0a 2020 2020 2020  ': '644',.      
+00004150: 2020 2020 2020 276c 6173 742d 6d6f 6469        'last-modi
+00004160: 6669 6564 273a 2027 3230 3231 2d30 312d  fied': '2021-01-
+00004170: 3238 5431 343a 3337 3a30 342e 3239 3135  28T14:37:04.2915
+00004180: 3137 3736 382b 3133 3a30 3027 2c0a 2020  17768+13:00',.  
+00004190: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000041a0: 696e 666f 203d 2070 6562 626c 652e 4669  info = pebble.Fi
+000041b0: 6c65 496e 666f 2e66 726f 6d5f 6469 6374  leInfo.from_dict
+000041c0: 2864 290a 2020 2020 2020 2020 7365 6c66  (d).        self
+000041d0: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+000041e0: 6f2e 7061 7468 2c20 272f 6574 6327 290a  o.path, '/etc').
+000041f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00004200: 6572 7445 7175 616c 2869 6e66 6f2e 6e61  ertEqual(info.na
+00004210: 6d65 2c20 2765 7463 2729 0a20 2020 2020  me, 'etc').     
+00004220: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00004230: 7561 6c28 696e 666f 2e74 7970 652c 2070  ual(info.type, p
+00004240: 6562 626c 652e 4669 6c65 5479 7065 2e44  ebble.FileType.D
+00004250: 4952 4543 544f 5259 290a 2020 2020 2020  IRECTORY).      
+00004260: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00004270: 616c 2869 6e66 6f2e 7065 726d 6973 7369  al(info.permissi
+00004280: 6f6e 732c 2030 6f36 3434 290a 2020 2020  ons, 0o644).    
+00004290: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000042a0: 7175 616c 2869 6e66 6f2e 6c61 7374 5f6d  qual(info.last_m
+000042b0: 6f64 6966 6965 642c 2064 6174 6574 696d  odified, datetim
+000042c0: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
+000042d0: 3238 2c20 3134 2c20 3337 2c20 342c 2032  28, 14, 37, 4, 2
+000042e0: 3931 3531 3829 290a 2020 2020 2020 2020  91518)).        
+000042f0: 7365 6c66 2e61 7373 6572 7449 7328 696e  self.assertIs(in
+00004300: 666f 2e75 7365 725f 6964 2c20 4e6f 6e65  fo.user_id, None
+00004310: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00004320: 7373 6572 7449 7328 696e 666f 2e75 7365  ssertIs(info.use
+00004330: 722c 204e 6f6e 6529 0a20 2020 2020 2020  r, None).       
+00004340: 2073 656c 662e 6173 7365 7274 4973 2869   self.assertIs(i
+00004350: 6e66 6f2e 6772 6f75 705f 6964 2c20 4e6f  nfo.group_id, No
+00004360: 6e65 290a 2020 2020 2020 2020 7365 6c66  ne).        self
+00004370: 2e61 7373 6572 7449 7328 696e 666f 2e67  .assertIs(info.g
+00004380: 726f 7570 2c20 4e6f 6e65 290a 0a20 2020  roup, None)..   
+00004390: 2020 2020 2064 5b27 7479 7065 275d 203d       d['type'] =
+000043a0: 2027 666f 6f62 6172 270a 2020 2020 2020   'foobar'.      
+000043b0: 2020 645b 2773 697a 6527 5d20 3d20 3132    d['size'] = 12
+000043c0: 330a 2020 2020 2020 2020 645b 2775 7365  3.        d['use
+000043d0: 722d 6964 275d 203d 2031 320a 2020 2020  r-id'] = 12.    
+000043e0: 2020 2020 645b 2775 7365 7227 5d20 3d20      d['user'] = 
+000043f0: 2762 6f62 270a 2020 2020 2020 2020 645b  'bob'.        d[
+00004400: 2767 726f 7570 2d69 6427 5d20 3d20 3334  'group-id'] = 34
+00004410: 0a20 2020 2020 2020 2064 5b27 6772 6f75  .        d['grou
+00004420: 7027 5d20 3d20 2773 7461 6666 270a 2020  p'] = 'staff'.  
+00004430: 2020 2020 2020 696e 666f 203d 2070 6562        info = peb
+00004440: 626c 652e 4669 6c65 496e 666f 2e66 726f  ble.FileInfo.fro
+00004450: 6d5f 6469 6374 2864 290a 2020 2020 2020  m_dict(d).      
+00004460: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00004470: 616c 2869 6e66 6f2e 7479 7065 2c20 2766  al(info.type, 'f
+00004480: 6f6f 6261 7227 290a 2020 2020 2020 2020  oobar').        
+00004490: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000044a0: 2869 6e66 6f2e 7369 7a65 2c20 3132 3329  (info.size, 123)
+000044b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000044c0: 7365 7274 4571 7561 6c28 696e 666f 2e75  sertEqual(info.u
+000044d0: 7365 725f 6964 2c20 3132 290a 2020 2020  ser_id, 12).    
+000044e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000044f0: 7175 616c 2869 6e66 6f2e 7573 6572 2c20  qual(info.user, 
+00004500: 2762 6f62 2729 0a20 2020 2020 2020 2073  'bob').        s
+00004510: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00004520: 696e 666f 2e67 726f 7570 5f69 642c 2033  info.group_id, 3
+00004530: 3429 0a20 2020 2020 2020 2073 656c 662e  4).        self.
+00004540: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
+00004550: 2e67 726f 7570 2c20 2773 7461 6666 2729  .group, 'staff')
+00004560: 0a0a 0a63 6c61 7373 2054 6573 7450 6c61  ...class TestPla
+00004570: 6e28 756e 6974 7465 7374 2e54 6573 7443  n(unittest.TestC
+00004580: 6173 6529 3a0a 2020 2020 6465 6620 7465  ase):.    def te
+00004590: 7374 5f6e 6f5f 6172 6773 2873 656c 6629  st_no_args(self)
+000045a0: 3a0a 2020 2020 2020 2020 7769 7468 2073  :.        with s
+000045b0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000045c0: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+000045d0: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+000045e0: 506c 616e 2829 0a0a 2020 2020 6465 6620  Plan()..    def 
+000045f0: 7465 7374 5f73 6572 7669 6365 7328 7365  test_services(se
+00004600: 6c66 293a 0a20 2020 2020 2020 2070 6c61  lf):.        pla
+00004610: 6e20 3d20 7065 6262 6c65 2e50 6c61 6e28  n = pebble.Plan(
+00004620: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+00004630: 2e61 7373 6572 7445 7175 616c 2870 6c61  .assertEqual(pla
+00004640: 6e2e 7365 7276 6963 6573 2c20 7b7d 290a  n.services, {}).
+00004650: 0a20 2020 2020 2020 2070 6c61 6e20 3d20  .        plan = 
+00004660: 7065 6262 6c65 2e50 6c61 6e28 2773 6572  pebble.Plan('ser
+00004670: 7669 6365 733a 5c6e 2066 6f6f 3a5c 6e20  vices:\n foo:\n 
+00004680: 206f 7665 7272 6964 653a 2072 6570 6c61   override: repla
+00004690: 6365 5c6e 2020 636f 6d6d 616e 643a 2065  ce\n  command: e
+000046a0: 6368 6f20 666f 6f27 290a 0a20 2020 2020  cho foo')..     
+000046b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000046c0: 7561 6c28 6c65 6e28 706c 616e 2e73 6572  ual(len(plan.ser
+000046d0: 7669 6365 7329 2c20 3129 0a20 2020 2020  vices), 1).     
+000046e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000046f0: 7561 6c28 706c 616e 2e73 6572 7669 6365  ual(plan.service
+00004700: 735b 2766 6f6f 275d 2e6e 616d 652c 2027  s['foo'].name, '
+00004710: 666f 6f27 290a 2020 2020 2020 2020 7365  foo').        se
+00004720: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00004730: 6c61 6e2e 7365 7276 6963 6573 5b27 666f  lan.services['fo
+00004740: 6f27 5d2e 6f76 6572 7269 6465 2c20 2772  o'].override, 'r
+00004750: 6570 6c61 6365 2729 0a20 2020 2020 2020  eplace').       
+00004760: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00004770: 6c28 706c 616e 2e73 6572 7669 6365 735b  l(plan.services[
+00004780: 2766 6f6f 275d 2e63 6f6d 6d61 6e64 2c20  'foo'].command, 
+00004790: 2765 6368 6f20 666f 6f27 290a 0a20 2020  'echo foo')..   
+000047a0: 2020 2020 2023 2053 686f 756c 6420 6265       # Should be
+000047b0: 2072 6561 642d 6f6e 6c79 2028 2263 616e   read-only ("can
+000047c0: 2774 2073 6574 2061 7474 7269 6275 7465  't set attribute
+000047d0: 2229 0a20 2020 2020 2020 2077 6974 6820  ").        with 
+000047e0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+000047f0: 7328 4174 7472 6962 7574 6545 7272 6f72  s(AttributeError
+00004800: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+00004810: 6c61 6e2e 7365 7276 6963 6573 203d 207b  lan.services = {
+00004820: 7d0a 0a20 2020 2064 6566 2074 6573 745f  }..    def test_
+00004830: 6368 6563 6b73 2873 656c 6629 3a0a 2020  checks(self):.  
+00004840: 2020 2020 2020 706c 616e 203d 2070 6562        plan = peb
+00004850: 626c 652e 506c 616e 2827 2729 0a20 2020  ble.Plan('').   
+00004860: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00004870: 4571 7561 6c28 706c 616e 2e63 6865 636b  Equal(plan.check
+00004880: 732c 207b 7d29 0a0a 2020 2020 2020 2020  s, {})..        
+00004890: 706c 616e 203d 2070 6562 626c 652e 506c  plan = pebble.Pl
+000048a0: 616e 280a 2020 2020 2020 2020 2020 2020  an(.            
+000048b0: 2763 6865 636b 733a 5c6e 2062 6172 3a5c  'checks:\n bar:\
+000048c0: 6e20 206f 7665 7272 6964 653a 2072 6570  n  override: rep
+000048d0: 6c61 6365 5c6e 2020 6874 7470 3a5c 6e20  lace\n  http:\n 
+000048e0: 2020 7572 6c3a 2068 7474 7073 3a2f 2f65    url: https://e
+000048f0: 7861 6d70 6c65 2e63 6f6d 2f27 290a 0a20  xample.com/').. 
+00004900: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00004910: 7274 4571 7561 6c28 6c65 6e28 706c 616e  rtEqual(len(plan
+00004920: 2e63 6865 636b 7329 2c20 3129 0a20 2020  .checks), 1).   
+00004930: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00004940: 4571 7561 6c28 706c 616e 2e63 6865 636b  Equal(plan.check
+00004950: 735b 2762 6172 275d 2e6e 616d 652c 2027  s['bar'].name, '
+00004960: 6261 7227 290a 2020 2020 2020 2020 7365  bar').        se
+00004970: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00004980: 6c61 6e2e 6368 6563 6b73 5b27 6261 7227  lan.checks['bar'
+00004990: 5d2e 6f76 6572 7269 6465 2c20 2772 6570  ].override, 'rep
+000049a0: 6c61 6365 2729 0a20 2020 2020 2020 2073  lace').        s
+000049b0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000049c0: 706c 616e 2e63 6865 636b 735b 2762 6172  plan.checks['bar
+000049d0: 275d 2e68 7474 702c 207b 2775 726c 273a  '].http, {'url':
+000049e0: 2027 6874 7470 733a 2f2f 6578 616d 706c   'https://exampl
+000049f0: 652e 636f 6d2f 277d 290a 0a20 2020 2020  e.com/'})..     
+00004a00: 2020 2023 2053 686f 756c 6420 6265 2072     # Should be r
+00004a10: 6561 642d 6f6e 6c79 2028 2263 616e 2774  ead-only ("can't
+00004a20: 2073 6574 2061 7474 7269 6275 7465 2229   set attribute")
+00004a30: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00004a40: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00004a50: 4174 7472 6962 7574 6545 7272 6f72 293a  AttributeError):
+00004a60: 0a20 2020 2020 2020 2020 2020 2070 6c61  .            pla
+00004a70: 6e2e 6368 6563 6b73 203d 207b 7d0a 0a20  n.checks = {}.. 
+00004a80: 2020 2064 6566 2074 6573 745f 7961 6d6c     def test_yaml
+00004a90: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00004aa0: 2320 5374 6172 7469 6e67 2077 6974 6820  # Starting with 
+00004ab0: 6e6f 7468 696e 672c 2077 6520 6765 7420  nothing, we get 
+00004ac0: 7468 6520 656d 7074 7920 7265 7375 6c74  the empty result
+00004ad0: 0a20 2020 2020 2020 2070 6c61 6e20 3d20  .        plan = 
+00004ae0: 7065 6262 6c65 2e50 6c61 6e28 2727 290a  pebble.Plan('').
+00004af0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00004b00: 6572 7445 7175 616c 2870 6c61 6e2e 746f  ertEqual(plan.to
+00004b10: 5f79 616d 6c28 292c 2027 7b7d 5c6e 2729  _yaml(), '{}\n')
+00004b20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00004b30: 7365 7274 4571 7561 6c28 7374 7228 706c  sertEqual(str(pl
+00004b40: 616e 292c 2027 7b7d 5c6e 2729 0a0a 2020  an), '{}\n')..  
+00004b50: 2020 2020 2020 2320 5769 7468 2061 2073        # With a s
+00004b60: 6572 7669 6365 2c20 7765 2072 6574 7572  ervice, we retur
+00004b70: 6e20 7661 6c69 6461 7465 6420 7961 6d6c  n validated yaml
+00004b80: 2063 6f6e 7465 6e74 2e0a 2020 2020 2020   content..      
+00004b90: 2020 7261 7720 3d20 2727 275c 0a73 6572    raw = '''\.ser
+00004ba0: 7669 6365 733a 0a20 666f 6f3a 0a20 206f  vices:. foo:.  o
+00004bb0: 7665 7272 6964 653a 2072 6570 6c61 6365  verride: replace
+00004bc0: 0a20 2063 6f6d 6d61 6e64 3a20 6563 686f  .  command: echo
+00004bd0: 2066 6f6f 0a0a 6368 6563 6b73 3a0a 2062   foo..checks:. b
+00004be0: 6172 3a0a 2020 6874 7470 3a0a 2020 2068  ar:.  http:.   h
+00004bf0: 7474 7073 3a2f 2f65 7861 6d70 6c65 2e63  ttps://example.c
+00004c00: 6f6d 2f0a 2727 270a 2020 2020 2020 2020  om/.'''.        
+00004c10: 706c 616e 203d 2070 6562 626c 652e 506c  plan = pebble.Pl
+00004c20: 616e 2872 6177 290a 2020 2020 2020 2020  an(raw).        
+00004c30: 7265 666f 726d 6564 203d 2079 616d 6c2e  reformed = yaml.
+00004c40: 7361 6665 5f64 756d 7028 7961 6d6c 2e73  safe_dump(yaml.s
+00004c50: 6166 655f 6c6f 6164 2872 6177 2929 0a20  afe_load(raw)). 
+00004c60: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00004c70: 7274 4571 7561 6c28 706c 616e 2e74 6f5f  rtEqual(plan.to_
+00004c80: 7961 6d6c 2829 2c20 7265 666f 726d 6564  yaml(), reformed
+00004c90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00004ca0: 7373 6572 7445 7175 616c 2873 7472 2870  ssertEqual(str(p
+00004cb0: 6c61 6e29 2c20 7265 666f 726d 6564 290a  lan), reformed).
+00004cc0: 0a20 2020 2064 6566 2074 6573 745f 7365  .    def test_se
+00004cd0: 7276 6963 655f 6571 7561 6c69 7479 2873  rvice_equality(s
+00004ce0: 656c 6629 3a0a 2020 2020 2020 2020 706c  elf):.        pl
+00004cf0: 616e 203d 2070 6562 626c 652e 506c 616e  an = pebble.Plan
+00004d00: 2827 7365 7276 6963 6573 3a5c 6e20 666f  ('services:\n fo
+00004d10: 6f3a 5c6e 2020 6f76 6572 7269 6465 3a20  o:\n  override: 
+00004d20: 7265 706c 6163 655c 6e20 2063 6f6d 6d61  replace\n  comma
+00004d30: 6e64 3a20 6563 686f 2066 6f6f 2729 0a0a  nd: echo foo')..
+00004d40: 2020 2020 2020 2020 6f6c 645f 7365 7276          old_serv
+00004d50: 6963 6520 3d20 7065 6262 6c65 2e53 6572  ice = pebble.Ser
+00004d60: 7669 6365 286e 616d 653d 2266 6f6f 222c  vice(name="foo",
+00004d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00004d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d90: 2020 2020 2020 2020 2020 2072 6177 3d7b             raw={
-00004da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004d90: 2020 2020 2020 7261 773d 7b0a 2020 2020        raw={.    
+00004da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004dc0: 2020 2020 2020 2020 2020 2022 6f76 6572             "over
-00004dd0: 7269 6465 223a 2022 7265 706c 6163 6522  ride": "replace"
-00004de0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00004dc0: 2020 2020 2020 226f 7665 7272 6964 6522        "override"
+00004dd0: 3a20 2272 6570 6c61 6365 222c 0a20 2020  : "replace",.   
+00004de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e00: 2020 2020 2020 2020 2020 2020 2263 6f6d              "com
-00004e10: 6d61 6e64 223a 2022 6563 686f 2066 6f6f  mand": "echo foo
-00004e20: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00004e00: 2020 2020 2020 2022 636f 6d6d 616e 6422         "command"
+00004e10: 3a20 2265 6368 6f20 666f 6f22 0a20 2020  : "echo foo".   
+00004e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e40: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
-00004e50: 2020 6f6c 645f 7365 7276 6963 6573 203d    old_services =
-00004e60: 207b 2266 6f6f 223a 206f 6c64 5f73 6572   {"foo": old_ser
-00004e70: 7669 6365 7d0a 2020 2020 2020 2020 7365  vice}.        se
-00004e80: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-00004e90: 6c61 6e2e 7365 7276 6963 6573 2c20 6f6c  lan.services, ol
-00004ea0: 645f 7365 7276 6963 6573 290a 0a20 2020  d_services)..   
-00004eb0: 2020 2020 2073 6572 7669 6365 735f 6173       services_as
-00004ec0: 5f64 6963 7420 3d20 7b0a 2020 2020 2020  _dict = {.      
-00004ed0: 2020 2020 2020 2266 6f6f 223a 207b 226f        "foo": {"o
-00004ee0: 7665 7272 6964 6522 3a20 2272 6570 6c61  verride": "repla
-00004ef0: 6365 222c 2022 636f 6d6d 616e 6422 3a20  ce", "command": 
-00004f00: 2265 6368 6f20 666f 6f22 7d0a 2020 2020  "echo foo"}.    
-00004f10: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-00004f20: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-00004f30: 6c61 6e2e 7365 7276 6963 6573 2c20 7365  lan.services, se
-00004f40: 7276 6963 6573 5f61 735f 6469 6374 290a  rvices_as_dict).
-00004f50: 0a0a 636c 6173 7320 5465 7374 4c61 7965  ..class TestLaye
-00004f60: 7228 756e 6974 7465 7374 2e54 6573 7443  r(unittest.TestC
-00004f70: 6173 6529 3a0a 2020 2020 6465 6620 5f61  ase):.    def _a
-00004f80: 7373 6572 745f 656d 7074 7928 7365 6c66  ssert_empty(self
-00004f90: 2c20 6c61 7965 7229 3a0a 2020 2020 2020  , layer):.      
-00004fa0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00004fb0: 616c 286c 6179 6572 2e73 756d 6d61 7279  al(layer.summary
-00004fc0: 2c20 2727 290a 2020 2020 2020 2020 7365  , '').        se
-00004fd0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-00004fe0: 6179 6572 2e64 6573 6372 6970 7469 6f6e  ayer.description
-00004ff0: 2c20 2727 290a 2020 2020 2020 2020 7365  , '').        se
-00005000: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
-00005010: 6179 6572 2e73 6572 7669 6365 732c 207b  ayer.services, {
-00005020: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-00005030: 6173 7365 7274 4571 7561 6c28 6c61 7965  assertEqual(laye
-00005040: 722e 746f 5f64 6963 7428 292c 207b 7d29  r.to_dict(), {})
-00005050: 0a0a 2020 2020 6465 6620 7465 7374 5f6e  ..    def test_n
-00005060: 6f5f 6172 6773 2873 656c 6629 3a0a 2020  o_args(self):.  
-00005070: 2020 2020 2020 7320 3d20 7065 6262 6c65        s = pebble
-00005080: 2e4c 6179 6572 2829 0a20 2020 2020 2020  .Layer().       
-00005090: 2073 656c 662e 5f61 7373 6572 745f 656d   self._assert_em
-000050a0: 7074 7928 7329 0a0a 2020 2020 6465 6620  pty(s)..    def 
-000050b0: 7465 7374 5f64 6963 7428 7365 6c66 293a  test_dict(self):
-000050c0: 0a20 2020 2020 2020 2073 203d 2070 6562  .        s = peb
-000050d0: 626c 652e 4c61 7965 7228 7b7d 290a 2020  ble.Layer({}).  
-000050e0: 2020 2020 2020 7365 6c66 2e5f 6173 7365        self._asse
-000050f0: 7274 5f65 6d70 7479 2873 290a 0a20 2020  rt_empty(s)..   
-00005100: 2020 2020 2064 203d 207b 0a20 2020 2020       d = {.     
-00005110: 2020 2020 2020 2027 7375 6d6d 6172 7927         'summary'
-00005120: 3a20 2753 756d 204d 6172 7927 2c0a 2020  : 'Sum Mary',.  
-00005130: 2020 2020 2020 2020 2020 2764 6573 6372            'descr
-00005140: 6970 7469 6f6e 273a 2027 5468 6520 7175  iption': 'The qu
-00005150: 6963 6b20 6272 6f77 6e20 666f 7821 272c  ick brown fox!',
-00005160: 0a20 2020 2020 2020 2020 2020 2027 7365  .            'se
-00005170: 7276 6963 6573 273a 207b 0a20 2020 2020  rvices': {.     
-00005180: 2020 2020 2020 2020 2020 2027 666f 6f27             'foo'
-00005190: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000051a0: 2020 2020 2020 2020 2773 756d 6d61 7279          'summary
-000051b0: 273a 2027 466f 6f27 2c0a 2020 2020 2020  ': 'Foo',.      
-000051c0: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-000051d0: 6f6d 6d61 6e64 273a 2027 6563 686f 2066  ommand': 'echo f
-000051e0: 6f6f 272c 0a20 2020 2020 2020 2020 2020  oo',.           
-000051f0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00005200: 2020 2020 2020 2020 2762 6172 273a 207b          'bar': {
-00005210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005220: 2020 2020 2027 7375 6d6d 6172 7927 3a20       'summary': 
-00005230: 2742 6172 272c 0a20 2020 2020 2020 2020  'Bar',.         
-00005240: 2020 2020 2020 2020 2020 2027 636f 6d6d             'comm
-00005250: 616e 6427 3a20 2765 6368 6f20 6261 7227  and': 'echo bar'
-00005260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005270: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-00005280: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
-00005290: 2020 2020 2073 203d 2070 6562 626c 652e       s = pebble.
-000052a0: 4c61 7965 7228 6429 0a20 2020 2020 2020  Layer(d).       
-000052b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000052c0: 6c28 732e 7375 6d6d 6172 792c 2027 5375  l(s.summary, 'Su
-000052d0: 6d20 4d61 7279 2729 0a20 2020 2020 2020  m Mary').       
-000052e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000052f0: 6c28 732e 6465 7363 7269 7074 696f 6e2c  l(s.description,
-00005300: 2027 5468 6520 7175 6963 6b20 6272 6f77   'The quick brow
-00005310: 6e20 666f 7821 2729 0a20 2020 2020 2020  n fox!').       
-00005320: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00005330: 6c28 732e 7365 7276 6963 6573 5b27 666f  l(s.services['fo
-00005340: 6f27 5d2e 6e61 6d65 2c20 2766 6f6f 2729  o'].name, 'foo')
-00005350: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00005360: 7365 7274 4571 7561 6c28 732e 7365 7276  sertEqual(s.serv
-00005370: 6963 6573 5b27 666f 6f27 5d2e 7375 6d6d  ices['foo'].summ
-00005380: 6172 792c 2027 466f 6f27 290a 2020 2020  ary, 'Foo').    
-00005390: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000053a0: 7175 616c 2873 2e73 6572 7669 6365 735b  qual(s.services[
-000053b0: 2766 6f6f 275d 2e63 6f6d 6d61 6e64 2c20  'foo'].command, 
-000053c0: 2765 6368 6f20 666f 6f27 290a 2020 2020  'echo foo').    
-000053d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000053e0: 7175 616c 2873 2e73 6572 7669 6365 735b  qual(s.services[
-000053f0: 2762 6172 275d 2e6e 616d 652c 2027 6261  'bar'].name, 'ba
-00005400: 7227 290a 2020 2020 2020 2020 7365 6c66  r').        self
-00005410: 2e61 7373 6572 7445 7175 616c 2873 2e73  .assertEqual(s.s
-00005420: 6572 7669 6365 735b 2762 6172 275d 2e73  ervices['bar'].s
-00005430: 756d 6d61 7279 2c20 2742 6172 2729 0a20  ummary, 'Bar'). 
-00005440: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00005450: 7274 4571 7561 6c28 732e 7365 7276 6963  rtEqual(s.servic
-00005460: 6573 5b27 6261 7227 5d2e 636f 6d6d 616e  es['bar'].comman
-00005470: 642c 2027 6563 686f 2062 6172 2729 0a0a  d, 'echo bar')..
-00005480: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00005490: 6572 7445 7175 616c 2873 2e74 6f5f 6469  ertEqual(s.to_di
-000054a0: 6374 2829 2c20 6429 0a0a 2020 2020 6465  ct(), d)..    de
-000054b0: 6620 7465 7374 5f79 616d 6c28 7365 6c66  f test_yaml(self
-000054c0: 293a 0a20 2020 2020 2020 2073 203d 2070  ):.        s = p
-000054d0: 6562 626c 652e 4c61 7965 7228 2727 290a  ebble.Layer('').
-000054e0: 2020 2020 2020 2020 7365 6c66 2e5f 6173          self._as
-000054f0: 7365 7274 5f65 6d70 7479 2873 290a 0a20  sert_empty(s).. 
-00005500: 2020 2020 2020 2079 616d 6c20 3d20 2222         yaml = ""
-00005510: 2263 6865 636b 733a 0a20 2063 686b 3a0a  "checks:.  chk:.
-00005520: 2020 2020 6874 7470 3a0a 2020 2020 2020      http:.      
-00005530: 7572 6c3a 2068 7474 7073 3a2f 2f65 7861  url: https://exa
-00005540: 6d70 6c65 2e63 6f6d 2f0a 6465 7363 7269  mple.com/.descri
-00005550: 7074 696f 6e3a 2054 6865 2071 7569 636b  ption: The quick
-00005560: 2062 726f 776e 2066 6f78 210a 7365 7276   brown fox!.serv
-00005570: 6963 6573 3a0a 2020 6261 723a 0a20 2020  ices:.  bar:.   
-00005580: 2063 6f6d 6d61 6e64 3a20 6563 686f 2062   command: echo b
-00005590: 6172 0a20 2020 2065 6e76 6972 6f6e 6d65  ar.    environme
-000055a0: 6e74 3a0a 2020 2020 2020 454e 5631 3a20  nt:.      ENV1: 
-000055b0: 7661 6c75 6531 0a20 2020 2020 2045 4e56  value1.      ENV
-000055c0: 323a 2076 616c 7565 320a 2020 2020 6772  2: value2.    gr
-000055d0: 6f75 703a 2073 7461 6666 0a20 2020 2067  oup: staff.    g
-000055e0: 726f 7570 2d69 643a 2032 3030 300a 2020  roup-id: 2000.  
-000055f0: 2020 7375 6d6d 6172 793a 2042 6172 0a20    summary: Bar. 
-00005600: 2020 2075 7365 723a 2062 6f62 0a20 2020     user: bob.   
-00005610: 2075 7365 722d 6964 3a20 3130 3030 0a20   user-id: 1000. 
-00005620: 2066 6f6f 3a0a 2020 2020 636f 6d6d 616e   foo:.    comman
-00005630: 643a 2065 6368 6f20 666f 6f0a 2020 2020  d: echo foo.    
-00005640: 7375 6d6d 6172 793a 2046 6f6f 0a73 756d  summary: Foo.sum
-00005650: 6d61 7279 3a20 5375 6d20 4d61 7279 0a22  mary: Sum Mary."
-00005660: 2222 0a20 2020 2020 2020 2073 203d 2070  "".        s = p
-00005670: 6562 626c 652e 4c61 7965 7228 7961 6d6c  ebble.Layer(yaml
-00005680: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00005690: 7373 6572 7445 7175 616c 2873 2e73 756d  ssertEqual(s.sum
-000056a0: 6d61 7279 2c20 2753 756d 204d 6172 7927  mary, 'Sum Mary'
-000056b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000056c0: 7373 6572 7445 7175 616c 2873 2e64 6573  ssertEqual(s.des
-000056d0: 6372 6970 7469 6f6e 2c20 2754 6865 2071  cription, 'The q
-000056e0: 7569 636b 2062 726f 776e 2066 6f78 2127  uick brown fox!'
-000056f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00005700: 7373 6572 7445 7175 616c 2873 2e73 6572  ssertEqual(s.ser
-00005710: 7669 6365 735b 2766 6f6f 275d 2e6e 616d  vices['foo'].nam
-00005720: 652c 2027 666f 6f27 290a 2020 2020 2020  e, 'foo').      
-00005730: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00005740: 616c 2873 2e73 6572 7669 6365 735b 2766  al(s.services['f
-00005750: 6f6f 275d 2e73 756d 6d61 7279 2c20 2746  oo'].summary, 'F
-00005760: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
-00005770: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
-00005780: 7365 7276 6963 6573 5b27 666f 6f27 5d2e  services['foo'].
-00005790: 636f 6d6d 616e 642c 2027 6563 686f 2066  command, 'echo f
-000057a0: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
-000057b0: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
-000057c0: 7365 7276 6963 6573 5b27 6261 7227 5d2e  services['bar'].
-000057d0: 6e61 6d65 2c20 2762 6172 2729 0a20 2020  name, 'bar').   
-000057e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000057f0: 4571 7561 6c28 732e 7365 7276 6963 6573  Equal(s.services
-00005800: 5b27 6261 7227 5d2e 7375 6d6d 6172 792c  ['bar'].summary,
-00005810: 2027 4261 7227 290a 2020 2020 2020 2020   'Bar').        
-00005820: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00005830: 2873 2e73 6572 7669 6365 735b 2762 6172  (s.services['bar
-00005840: 275d 2e63 6f6d 6d61 6e64 2c20 2765 6368  '].command, 'ech
-00005850: 6f20 6261 7227 290a 2020 2020 2020 2020  o bar').        
-00005860: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00005870: 2873 2e73 6572 7669 6365 735b 2762 6172  (s.services['bar
-00005880: 275d 2e65 6e76 6972 6f6e 6d65 6e74 2c0a  '].environment,.
+00004e40: 2020 7d29 0a20 2020 2020 2020 206f 6c64    }).        old
+00004e50: 5f73 6572 7669 6365 7320 3d20 7b22 666f  _services = {"fo
+00004e60: 6f22 3a20 6f6c 645f 7365 7276 6963 657d  o": old_service}
+00004e70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00004e80: 7365 7274 4571 7561 6c28 706c 616e 2e73  sertEqual(plan.s
+00004e90: 6572 7669 6365 732c 206f 6c64 5f73 6572  ervices, old_ser
+00004ea0: 7669 6365 7329 0a0a 2020 2020 2020 2020  vices)..        
+00004eb0: 7365 7276 6963 6573 5f61 735f 6469 6374  services_as_dict
+00004ec0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00004ed0: 2022 666f 6f22 3a20 7b22 6f76 6572 7269   "foo": {"overri
+00004ee0: 6465 223a 2022 7265 706c 6163 6522 2c20  de": "replace", 
+00004ef0: 2263 6f6d 6d61 6e64 223a 2022 6563 686f  "command": "echo
+00004f00: 2066 6f6f 227d 0a20 2020 2020 2020 207d   foo"}.        }
+00004f10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00004f20: 7365 7274 4571 7561 6c28 706c 616e 2e73  sertEqual(plan.s
+00004f30: 6572 7669 6365 732c 2073 6572 7669 6365  ervices, service
+00004f40: 735f 6173 5f64 6963 7429 0a0a 0a63 6c61  s_as_dict)...cla
+00004f50: 7373 2054 6573 744c 6179 6572 2875 6e69  ss TestLayer(uni
+00004f60: 7474 6573 742e 5465 7374 4361 7365 293a  ttest.TestCase):
+00004f70: 0a20 2020 2064 6566 205f 6173 7365 7274  .    def _assert
+00004f80: 5f65 6d70 7479 2873 656c 662c 206c 6179  _empty(self, lay
+00004f90: 6572 293a 0a20 2020 2020 2020 2073 656c  er):.        sel
+00004fa0: 662e 6173 7365 7274 4571 7561 6c28 6c61  f.assertEqual(la
+00004fb0: 7965 722e 7375 6d6d 6172 792c 2027 2729  yer.summary, '')
+00004fc0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00004fd0: 7365 7274 4571 7561 6c28 6c61 7965 722e  sertEqual(layer.
+00004fe0: 6465 7363 7269 7074 696f 6e2c 2027 2729  description, '')
+00004ff0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00005000: 7365 7274 4571 7561 6c28 6c61 7965 722e  sertEqual(layer.
+00005010: 7365 7276 6963 6573 2c20 7b7d 290a 2020  services, {}).  
+00005020: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00005030: 7445 7175 616c 286c 6179 6572 2e74 6f5f  tEqual(layer.to_
+00005040: 6469 6374 2829 2c20 7b7d 290a 0a20 2020  dict(), {})..   
+00005050: 2064 6566 2074 6573 745f 6e6f 5f61 7267   def test_no_arg
+00005060: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+00005070: 2073 203d 2070 6562 626c 652e 4c61 7965   s = pebble.Laye
+00005080: 7228 290a 2020 2020 2020 2020 7365 6c66  r().        self
+00005090: 2e5f 6173 7365 7274 5f65 6d70 7479 2873  ._assert_empty(s
+000050a0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000050b0: 6469 6374 2873 656c 6629 3a0a 2020 2020  dict(self):.    
+000050c0: 2020 2020 7320 3d20 7065 6262 6c65 2e4c      s = pebble.L
+000050d0: 6179 6572 287b 7d29 0a20 2020 2020 2020  ayer({}).       
+000050e0: 2073 656c 662e 5f61 7373 6572 745f 656d   self._assert_em
+000050f0: 7074 7928 7329 0a0a 2020 2020 2020 2020  pty(s)..        
+00005100: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
+00005110: 2020 2773 756d 6d61 7279 273a 2027 5375    'summary': 'Su
+00005120: 6d20 4d61 7279 272c 0a20 2020 2020 2020  m Mary',.       
+00005130: 2020 2020 2027 6465 7363 7269 7074 696f       'descriptio
+00005140: 6e27 3a20 2754 6865 2071 7569 636b 2062  n': 'The quick b
+00005150: 726f 776e 2066 6f78 2127 2c0a 2020 2020  rown fox!',.    
+00005160: 2020 2020 2020 2020 2773 6572 7669 6365          'service
+00005170: 7327 3a20 7b0a 2020 2020 2020 2020 2020  s': {.          
+00005180: 2020 2020 2020 2766 6f6f 273a 207b 0a20        'foo': {. 
+00005190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051a0: 2020 2027 7375 6d6d 6172 7927 3a20 2746     'summary': 'F
+000051b0: 6f6f 272c 0a20 2020 2020 2020 2020 2020  oo',.           
+000051c0: 2020 2020 2020 2020 2027 636f 6d6d 616e           'comman
+000051d0: 6427 3a20 2765 6368 6f20 666f 6f27 2c0a  d': 'echo foo',.
+000051e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051f0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00005200: 2020 2027 6261 7227 3a20 7b0a 2020 2020     'bar': {.    
+00005210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005220: 2773 756d 6d61 7279 273a 2027 4261 7227  'summary': 'Bar'
+00005230: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00005240: 2020 2020 2020 2763 6f6d 6d61 6e64 273a        'command':
+00005250: 2027 6563 686f 2062 6172 272c 0a20 2020   'echo bar',.   
+00005260: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00005270: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00005280: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00005290: 7320 3d20 7065 6262 6c65 2e4c 6179 6572  s = pebble.Layer
+000052a0: 2864 290a 2020 2020 2020 2020 7365 6c66  (d).        self
+000052b0: 2e61 7373 6572 7445 7175 616c 2873 2e73  .assertEqual(s.s
+000052c0: 756d 6d61 7279 2c20 2753 756d 204d 6172  ummary, 'Sum Mar
+000052d0: 7927 290a 2020 2020 2020 2020 7365 6c66  y').        self
+000052e0: 2e61 7373 6572 7445 7175 616c 2873 2e64  .assertEqual(s.d
+000052f0: 6573 6372 6970 7469 6f6e 2c20 2754 6865  escription, 'The
+00005300: 2071 7569 636b 2062 726f 776e 2066 6f78   quick brown fox
+00005310: 2127 290a 2020 2020 2020 2020 7365 6c66  !').        self
+00005320: 2e61 7373 6572 7445 7175 616c 2873 2e73  .assertEqual(s.s
+00005330: 6572 7669 6365 735b 2766 6f6f 275d 2e6e  ervices['foo'].n
+00005340: 616d 652c 2027 666f 6f27 290a 2020 2020  ame, 'foo').    
+00005350: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00005360: 7175 616c 2873 2e73 6572 7669 6365 735b  qual(s.services[
+00005370: 2766 6f6f 275d 2e73 756d 6d61 7279 2c20  'foo'].summary, 
+00005380: 2746 6f6f 2729 0a20 2020 2020 2020 2073  'Foo').        s
+00005390: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000053a0: 732e 7365 7276 6963 6573 5b27 666f 6f27  s.services['foo'
+000053b0: 5d2e 636f 6d6d 616e 642c 2027 6563 686f  ].command, 'echo
+000053c0: 2066 6f6f 2729 0a20 2020 2020 2020 2073   foo').        s
+000053d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000053e0: 732e 7365 7276 6963 6573 5b27 6261 7227  s.services['bar'
+000053f0: 5d2e 6e61 6d65 2c20 2762 6172 2729 0a20  ].name, 'bar'). 
+00005400: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00005410: 7274 4571 7561 6c28 732e 7365 7276 6963  rtEqual(s.servic
+00005420: 6573 5b27 6261 7227 5d2e 7375 6d6d 6172  es['bar'].summar
+00005430: 792c 2027 4261 7227 290a 2020 2020 2020  y, 'Bar').      
+00005440: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00005450: 616c 2873 2e73 6572 7669 6365 735b 2762  al(s.services['b
+00005460: 6172 275d 2e63 6f6d 6d61 6e64 2c20 2765  ar'].command, 'e
+00005470: 6368 6f20 6261 7227 290a 0a20 2020 2020  cho bar')..     
+00005480: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00005490: 7561 6c28 732e 746f 5f64 6963 7428 292c  ual(s.to_dict(),
+000054a0: 2064 290a 0a20 2020 2064 6566 2074 6573   d)..    def tes
+000054b0: 745f 7961 6d6c 2873 656c 6629 3a0a 2020  t_yaml(self):.  
+000054c0: 2020 2020 2020 7320 3d20 7065 6262 6c65        s = pebble
+000054d0: 2e4c 6179 6572 2827 2729 0a20 2020 2020  .Layer('').     
+000054e0: 2020 2073 656c 662e 5f61 7373 6572 745f     self._assert_
+000054f0: 656d 7074 7928 7329 0a0a 2020 2020 2020  empty(s)..      
+00005500: 2020 7961 6d6c 203d 2022 2222 6368 6563    yaml = """chec
+00005510: 6b73 3a0a 2020 6368 6b3a 0a20 2020 2068  ks:.  chk:.    h
+00005520: 7474 703a 0a20 2020 2020 2075 726c 3a20  ttp:.      url: 
+00005530: 6874 7470 733a 2f2f 6578 616d 706c 652e  https://example.
+00005540: 636f 6d2f 0a64 6573 6372 6970 7469 6f6e  com/.description
+00005550: 3a20 5468 6520 7175 6963 6b20 6272 6f77  : The quick brow
+00005560: 6e20 666f 7821 0a73 6572 7669 6365 733a  n fox!.services:
+00005570: 0a20 2062 6172 3a0a 2020 2020 636f 6d6d  .  bar:.    comm
+00005580: 616e 643a 2065 6368 6f20 6261 720a 2020  and: echo bar.  
+00005590: 2020 656e 7669 726f 6e6d 656e 743a 0a20    environment:. 
+000055a0: 2020 2020 2045 4e56 313a 2076 616c 7565       ENV1: value
+000055b0: 310a 2020 2020 2020 454e 5632 3a20 7661  1.      ENV2: va
+000055c0: 6c75 6532 0a20 2020 2067 726f 7570 3a20  lue2.    group: 
+000055d0: 7374 6166 660a 2020 2020 6772 6f75 702d  staff.    group-
+000055e0: 6964 3a20 3230 3030 0a20 2020 2073 756d  id: 2000.    sum
+000055f0: 6d61 7279 3a20 4261 720a 2020 2020 7573  mary: Bar.    us
+00005600: 6572 3a20 626f 620a 2020 2020 7573 6572  er: bob.    user
+00005610: 2d69 643a 2031 3030 300a 2020 666f 6f3a  -id: 1000.  foo:
+00005620: 0a20 2020 2063 6f6d 6d61 6e64 3a20 6563  .    command: ec
+00005630: 686f 2066 6f6f 0a20 2020 2073 756d 6d61  ho foo.    summa
+00005640: 7279 3a20 466f 6f0a 7375 6d6d 6172 793a  ry: Foo.summary:
+00005650: 2053 756d 204d 6172 790a 2222 220a 2020   Sum Mary.""".  
+00005660: 2020 2020 2020 7320 3d20 7065 6262 6c65        s = pebble
+00005670: 2e4c 6179 6572 2879 616d 6c29 0a20 2020  .Layer(yaml).   
+00005680: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00005690: 4571 7561 6c28 732e 7375 6d6d 6172 792c  Equal(s.summary,
+000056a0: 2027 5375 6d20 4d61 7279 2729 0a20 2020   'Sum Mary').   
+000056b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000056c0: 4571 7561 6c28 732e 6465 7363 7269 7074  Equal(s.descript
+000056d0: 696f 6e2c 2027 5468 6520 7175 6963 6b20  ion, 'The quick 
+000056e0: 6272 6f77 6e20 666f 7821 2729 0a20 2020  brown fox!').   
+000056f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00005700: 4571 7561 6c28 732e 7365 7276 6963 6573  Equal(s.services
+00005710: 5b27 666f 6f27 5d2e 6e61 6d65 2c20 2766  ['foo'].name, 'f
+00005720: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
+00005730: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
+00005740: 7365 7276 6963 6573 5b27 666f 6f27 5d2e  services['foo'].
+00005750: 7375 6d6d 6172 792c 2027 466f 6f27 290a  summary, 'Foo').
+00005760: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00005770: 6572 7445 7175 616c 2873 2e73 6572 7669  ertEqual(s.servi
+00005780: 6365 735b 2766 6f6f 275d 2e63 6f6d 6d61  ces['foo'].comma
+00005790: 6e64 2c20 2765 6368 6f20 666f 6f27 290a  nd, 'echo foo').
+000057a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000057b0: 6572 7445 7175 616c 2873 2e73 6572 7669  ertEqual(s.servi
+000057c0: 6365 735b 2762 6172 275d 2e6e 616d 652c  ces['bar'].name,
+000057d0: 2027 6261 7227 290a 2020 2020 2020 2020   'bar').        
+000057e0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000057f0: 2873 2e73 6572 7669 6365 735b 2762 6172  (s.services['bar
+00005800: 275d 2e73 756d 6d61 7279 2c20 2742 6172  '].summary, 'Bar
+00005810: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00005820: 6173 7365 7274 4571 7561 6c28 732e 7365  assertEqual(s.se
+00005830: 7276 6963 6573 5b27 6261 7227 5d2e 636f  rvices['bar'].co
+00005840: 6d6d 616e 642c 2027 6563 686f 2062 6172  mmand, 'echo bar
+00005850: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00005860: 6173 7365 7274 4571 7561 6c28 732e 7365  assertEqual(s.se
+00005870: 7276 6963 6573 5b27 6261 7227 5d2e 656e  rvices['bar'].en
+00005880: 7669 726f 6e6d 656e 742c 0a20 2020 2020  vironment,.     
 00005890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058a0: 2020 2020 2020 2020 207b 2745 4e56 3127           {'ENV1'
-000058b0: 3a20 2776 616c 7565 3127 2c20 2745 4e56  : 'value1', 'ENV
-000058c0: 3227 3a20 2776 616c 7565 3227 7d29 0a20  2': 'value2'}). 
-000058d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000058e0: 7274 4571 7561 6c28 732e 7365 7276 6963  rtEqual(s.servic
-000058f0: 6573 5b27 6261 7227 5d2e 7573 6572 2c20  es['bar'].user, 
-00005900: 2762 6f62 2729 0a20 2020 2020 2020 2073  'bob').        s
-00005910: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00005920: 732e 7365 7276 6963 6573 5b27 6261 7227  s.services['bar'
-00005930: 5d2e 7573 6572 5f69 642c 2031 3030 3029  ].user_id, 1000)
-00005940: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00005950: 7365 7274 4571 7561 6c28 732e 7365 7276  sertEqual(s.serv
-00005960: 6963 6573 5b27 6261 7227 5d2e 6772 6f75  ices['bar'].grou
-00005970: 702c 2027 7374 6166 6627 290a 2020 2020  p, 'staff').    
-00005980: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00005990: 7175 616c 2873 2e73 6572 7669 6365 735b  qual(s.services[
-000059a0: 2762 6172 275d 2e67 726f 7570 5f69 642c  'bar'].group_id,
-000059b0: 2032 3030 3029 0a0a 2020 2020 2020 2020   2000)..        
-000059c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000059d0: 2873 2e63 6865 636b 735b 2763 686b 275d  (s.checks['chk']
-000059e0: 2e6e 616d 652c 2027 6368 6b27 290a 2020  .name, 'chk').  
-000059f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00005a00: 7445 7175 616c 2873 2e63 6865 636b 735b  tEqual(s.checks[
-00005a10: 2763 686b 275d 2e68 7474 702c 207b 2775  'chk'].http, {'u
-00005a20: 726c 273a 2027 6874 7470 733a 2f2f 6578  rl': 'https://ex
-00005a30: 616d 706c 652e 636f 6d2f 277d 290a 0a20  ample.com/'}).. 
-00005a40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00005a50: 7274 4571 7561 6c28 732e 746f 5f79 616d  rtEqual(s.to_yam
-00005a60: 6c28 292c 2079 616d 6c29 0a20 2020 2020  l(), yaml).     
-00005a70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00005a80: 7561 6c28 7374 7228 7329 2c20 7961 6d6c  ual(str(s), yaml
-00005a90: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00005aa0: 6c61 7965 725f 7365 7276 6963 655f 6571  layer_service_eq
-00005ab0: 7561 6c69 7479 2873 656c 6629 3a0a 2020  uality(self):.  
-00005ac0: 2020 2020 2020 7320 3d20 7065 6262 6c65        s = pebble
-00005ad0: 2e4c 6179 6572 287b 7d29 0a20 2020 2020  .Layer({}).     
-00005ae0: 2020 2073 656c 662e 5f61 7373 6572 745f     self._assert_
-00005af0: 656d 7074 7928 7329 0a0a 2020 2020 2020  empty(s)..      
-00005b00: 2020 6420 3d20 7b0a 2020 2020 2020 2020    d = {.        
-00005b10: 2020 2020 2773 756d 6d61 7279 273a 2027      'summary': '
-00005b20: 5375 6d20 4d61 7279 272c 0a20 2020 2020  Sum Mary',.     
-00005b30: 2020 2020 2020 2027 6465 7363 7269 7074         'descript
-00005b40: 696f 6e27 3a20 2754 6865 2071 7569 636b  ion': 'The quick
-00005b50: 2062 726f 776e 2066 6f78 2127 2c0a 2020   brown fox!',.  
-00005b60: 2020 2020 2020 2020 2020 2773 6572 7669            'servi
-00005b70: 6365 7327 3a20 7b0a 2020 2020 2020 2020  ces': {.        
-00005b80: 2020 2020 2020 2020 2766 6f6f 273a 207b          'foo': {
-00005b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005ba0: 2020 2020 2027 7375 6d6d 6172 7927 3a20       'summary': 
-00005bb0: 2746 6f6f 272c 0a20 2020 2020 2020 2020  'Foo',.         
-00005bc0: 2020 2020 2020 2020 2020 2027 636f 6d6d             'comm
-00005bd0: 616e 6427 3a20 2765 6368 6f20 666f 6f27  and': 'echo foo'
-00005be0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005bf0: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-00005c00: 2020 2020 2027 6261 7227 3a20 7b0a 2020       'bar': {.  
-00005c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c20: 2020 2773 756d 6d61 7279 273a 2027 4261    'summary': 'Ba
-00005c30: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
-00005c40: 2020 2020 2020 2020 2763 6f6d 6d61 6e64          'command
-00005c50: 273a 2027 6563 686f 2062 6172 272c 0a20  ': 'echo bar',. 
-00005c60: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00005c70: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00005c80: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00005c90: 2020 7320 3d20 7065 6262 6c65 2e4c 6179    s = pebble.Lay
-00005ca0: 6572 2864 290a 2020 2020 2020 2020 7420  er(d).        t 
-00005cb0: 3d20 7065 6262 6c65 2e4c 6179 6572 2864  = pebble.Layer(d
-00005cc0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00005cd0: 6173 7365 7274 4571 7561 6c28 732e 7365  assertEqual(s.se
-00005ce0: 7276 6963 6573 2c20 742e 7365 7276 6963  rvices, t.servic
-00005cf0: 6573 290a 0a0a 636c 6173 7320 5465 7374  es)...class Test
-00005d00: 5365 7276 6963 6528 756e 6974 7465 7374  Service(unittest
-00005d10: 2e54 6573 7443 6173 6529 3a0a 2020 2020  .TestCase):.    
-00005d20: 6465 6620 5f61 7373 6572 745f 656d 7074  def _assert_empt
-00005d30: 7928 7365 6c66 2c20 7365 7276 6963 652c  y(self, service,
-00005d40: 206e 616d 6529 3a0a 2020 2020 2020 2020   name):.        
-00005d50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00005d60: 2873 6572 7669 6365 2e6e 616d 652c 206e  (service.name, n
-00005d70: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
-00005d80: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-00005d90: 7276 6963 652e 7375 6d6d 6172 792c 2027  rvice.summary, '
-00005da0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00005db0: 6173 7365 7274 4571 7561 6c28 7365 7276  assertEqual(serv
-00005dc0: 6963 652e 6465 7363 7269 7074 696f 6e2c  ice.description,
-00005dd0: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
-00005de0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-00005df0: 7276 6963 652e 7374 6172 7475 702c 2027  rvice.startup, '
-00005e00: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00005e10: 6173 7365 7274 4571 7561 6c28 7365 7276  assertEqual(serv
-00005e20: 6963 652e 6f76 6572 7269 6465 2c20 2727  ice.override, ''
-00005e30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00005e40: 7373 6572 7445 7175 616c 2873 6572 7669  ssertEqual(servi
-00005e50: 6365 2e63 6f6d 6d61 6e64 2c20 2727 290a  ce.command, '').
-00005e60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00005e70: 6572 7445 7175 616c 2873 6572 7669 6365  ertEqual(service
-00005e80: 2e61 6674 6572 2c20 5b5d 290a 2020 2020  .after, []).    
-00005e90: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00005ea0: 7175 616c 2873 6572 7669 6365 2e62 6566  qual(service.bef
-00005eb0: 6f72 652c 205b 5d29 0a20 2020 2020 2020  ore, []).       
-00005ec0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00005ed0: 6c28 7365 7276 6963 652e 7265 7175 6972  l(service.requir
-00005ee0: 6573 2c20 5b5d 290a 2020 2020 2020 2020  es, []).        
-00005ef0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00005f00: 2873 6572 7669 6365 2e65 6e76 6972 6f6e  (service.environ
-00005f10: 6d65 6e74 2c20 7b7d 290a 2020 2020 2020  ment, {}).      
-00005f20: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00005f30: 616c 2873 6572 7669 6365 2e75 7365 722c  al(service.user,
-00005f40: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
-00005f50: 662e 6173 7365 7274 4973 2873 6572 7669  f.assertIs(servi
-00005f60: 6365 2e75 7365 725f 6964 2c20 4e6f 6e65  ce.user_id, None
-00005f70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00005f80: 7373 6572 7445 7175 616c 2873 6572 7669  ssertEqual(servi
-00005f90: 6365 2e67 726f 7570 2c20 2727 290a 2020  ce.group, '').  
-00005fa0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00005fb0: 7449 7328 7365 7276 6963 652e 6772 6f75  tIs(service.grou
-00005fc0: 705f 6964 2c20 4e6f 6e65 290a 2020 2020  p_id, None).    
-00005fd0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00005fe0: 7175 616c 2873 6572 7669 6365 2e6f 6e5f  qual(service.on_
-00005ff0: 7375 6363 6573 732c 2027 2729 0a20 2020  success, '').   
-00006000: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00006010: 4571 7561 6c28 7365 7276 6963 652e 6f6e  Equal(service.on
-00006020: 5f66 6169 6c75 7265 2c20 2727 290a 2020  _failure, '').  
-00006030: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006040: 7445 7175 616c 2873 6572 7669 6365 2e6f  tEqual(service.o
-00006050: 6e5f 6368 6563 6b5f 6661 696c 7572 652c  n_check_failure,
-00006060: 207b 7d29 0a20 2020 2020 2020 2073 656c   {}).        sel
-00006070: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-00006080: 7276 6963 652e 6261 636b 6f66 665f 6465  rvice.backoff_de
-00006090: 6c61 792c 2027 2729 0a20 2020 2020 2020  lay, '').       
-000060a0: 2073 656c 662e 6173 7365 7274 4973 2873   self.assertIs(s
-000060b0: 6572 7669 6365 2e62 6163 6b6f 6666 5f66  ervice.backoff_f
-000060c0: 6163 746f 722c 204e 6f6e 6529 0a20 2020  actor, None).   
-000060d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000060e0: 4571 7561 6c28 7365 7276 6963 652e 6261  Equal(service.ba
-000060f0: 636b 6f66 665f 6c69 6d69 742c 2027 2729  ckoff_limit, '')
-00006100: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00006110: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
-00006120: 652e 746f 5f64 6963 7428 292c 207b 7d29  e.to_dict(), {})
-00006130: 0a0a 2020 2020 6465 6620 7465 7374 5f6e  ..    def test_n
-00006140: 616d 655f 6f6e 6c79 2873 656c 6629 3a0a  ame_only(self):.
-00006150: 2020 2020 2020 2020 7320 3d20 7065 6262          s = pebb
-00006160: 6c65 2e53 6572 7669 6365 2827 4e61 6d65  le.Service('Name
-00006170: 2030 2729 0a20 2020 2020 2020 2073 656c   0').        sel
-00006180: 662e 5f61 7373 6572 745f 656d 7074 7928  f._assert_empty(
-00006190: 732c 2027 4e61 6d65 2030 2729 0a0a 2020  s, 'Name 0')..  
-000061a0: 2020 6465 6620 7465 7374 5f64 6963 7428    def test_dict(
-000061b0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-000061c0: 203d 2070 6562 626c 652e 5365 7276 6963   = pebble.Servic
-000061d0: 6528 274e 616d 6520 3127 2c20 7b7d 290a  e('Name 1', {}).
-000061e0: 2020 2020 2020 2020 7365 6c66 2e5f 6173          self._as
-000061f0: 7365 7274 5f65 6d70 7479 2873 2c20 274e  sert_empty(s, 'N
-00006200: 616d 6520 3127 290a 0a20 2020 2020 2020  ame 1')..       
-00006210: 2064 203d 207b 0a20 2020 2020 2020 2020   d = {.         
-00006220: 2020 2027 7375 6d6d 6172 7927 3a20 2753     'summary': 'S
-00006230: 756d 204d 6172 7927 2c0a 2020 2020 2020  um Mary',.      
-00006240: 2020 2020 2020 2764 6573 6372 6970 7469        'descripti
-00006250: 6f6e 273a 2027 5468 6520 6c61 7a79 2071  on': 'The lazy q
-00006260: 7569 636b 2062 726f 776e 272c 0a20 2020  uick brown',.   
-00006270: 2020 2020 2020 2020 2027 7374 6172 7475           'startu
-00006280: 7027 3a20 2753 7461 7274 2055 7027 2c0a  p': 'Start Up',.
-00006290: 2020 2020 2020 2020 2020 2020 276f 7665              'ove
-000062a0: 7272 6964 6527 3a20 276f 7665 7272 6964  rride': 'overrid
-000062b0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-000062c0: 2763 6f6d 6d61 6e64 273a 2027 6563 686f  'command': 'echo
-000062d0: 2073 756d 206d 6172 7927 2c0a 2020 2020   sum mary',.    
-000062e0: 2020 2020 2020 2020 2761 6674 6572 273a          'after':
-000062f0: 205b 2761 3127 2c20 2761 3227 5d2c 0a20   ['a1', 'a2'],. 
-00006300: 2020 2020 2020 2020 2020 2027 6265 666f             'befo
-00006310: 7265 273a 205b 2762 3127 2c20 2762 3227  re': ['b1', 'b2'
-00006320: 5d2c 0a20 2020 2020 2020 2020 2020 2027  ],.            '
-00006330: 7265 7175 6972 6573 273a 205b 2772 3127  requires': ['r1'
-00006340: 2c20 2772 3227 5d2c 0a20 2020 2020 2020  , 'r2'],.       
-00006350: 2020 2020 2027 656e 7669 726f 6e6d 656e       'environmen
-00006360: 7427 3a20 7b27 6b31 273a 2027 7631 272c  t': {'k1': 'v1',
-00006370: 2027 6b32 273a 2027 7632 277d 2c0a 2020   'k2': 'v2'},.  
-00006380: 2020 2020 2020 2020 2020 2775 7365 7227            'user'
-00006390: 3a20 2762 6f62 272c 0a20 2020 2020 2020  : 'bob',.       
-000063a0: 2020 2020 2027 7573 6572 2d69 6427 3a20       'user-id': 
-000063b0: 3130 3030 2c0a 2020 2020 2020 2020 2020  1000,.          
-000063c0: 2020 2767 726f 7570 273a 2027 7374 6166    'group': 'staf
-000063d0: 6627 2c0a 2020 2020 2020 2020 2020 2020  f',.            
-000063e0: 2767 726f 7570 2d69 6427 3a20 3230 3030  'group-id': 2000
-000063f0: 2c0a 2020 2020 2020 2020 2020 2020 276f  ,.            'o
-00006400: 6e2d 7375 6363 6573 7327 3a20 2772 6573  n-success': 'res
-00006410: 7461 7274 272c 0a20 2020 2020 2020 2020  tart',.         
-00006420: 2020 2027 6f6e 2d66 6169 6c75 7265 273a     'on-failure':
-00006430: 2027 6967 6e6f 7265 272c 0a20 2020 2020   'ignore',.     
-00006440: 2020 2020 2020 2027 6f6e 2d63 6865 636b         'on-check
-00006450: 2d66 6169 6c75 7265 273a 207b 2763 686b  -failure': {'chk
-00006460: 3127 3a20 2768 616c 7427 7d2c 0a20 2020  1': 'halt'},.   
-00006470: 2020 2020 2020 2020 2027 6261 636b 6f66           'backof
-00006480: 662d 6465 6c61 7927 3a20 2731 7327 2c0a  f-delay': '1s',.
-00006490: 2020 2020 2020 2020 2020 2020 2762 6163              'bac
-000064a0: 6b6f 6666 2d66 6163 746f 7227 3a20 342c  koff-factor': 4,
-000064b0: 0a20 2020 2020 2020 2020 2020 2027 6261  .            'ba
-000064c0: 636b 6f66 662d 6c69 6d69 7427 3a20 2731  ckoff-limit': '1
-000064d0: 3073 272c 0a20 2020 2020 2020 207d 0a20  0s',.        }. 
-000064e0: 2020 2020 2020 2073 203d 2070 6562 626c         s = pebbl
-000064f0: 652e 5365 7276 6963 6528 274e 616d 6520  e.Service('Name 
-00006500: 3227 2c20 6429 0a20 2020 2020 2020 2073  2', d).        s
-00006510: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006520: 732e 6e61 6d65 2c20 274e 616d 6520 3227  s.name, 'Name 2'
-00006530: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006540: 7373 6572 7445 7175 616c 2873 2e64 6573  ssertEqual(s.des
-00006550: 6372 6970 7469 6f6e 2c20 2754 6865 206c  cription, 'The l
-00006560: 617a 7920 7175 6963 6b20 6272 6f77 6e27  azy quick brown'
-00006570: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006580: 7373 6572 7445 7175 616c 2873 2e73 7461  ssertEqual(s.sta
-00006590: 7274 7570 2c20 2753 7461 7274 2055 7027  rtup, 'Start Up'
-000065a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000065b0: 7373 6572 7445 7175 616c 2873 2e6f 7665  ssertEqual(s.ove
-000065c0: 7272 6964 652c 2027 6f76 6572 7269 6465  rride, 'override
-000065d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000065e0: 6173 7365 7274 4571 7561 6c28 732e 636f  assertEqual(s.co
-000065f0: 6d6d 616e 642c 2027 6563 686f 2073 756d  mmand, 'echo sum
-00006600: 206d 6172 7927 290a 2020 2020 2020 2020   mary').        
-00006610: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006620: 2873 2e61 6674 6572 2c20 5b27 6131 272c  (s.after, ['a1',
-00006630: 2027 6132 275d 290a 2020 2020 2020 2020   'a2']).        
-00006640: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006650: 2873 2e62 6566 6f72 652c 205b 2762 3127  (s.before, ['b1'
-00006660: 2c20 2762 3227 5d29 0a20 2020 2020 2020  , 'b2']).       
-00006670: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00006680: 6c28 732e 7265 7175 6972 6573 2c20 5b27  l(s.requires, ['
-00006690: 7231 272c 2027 7232 275d 290a 2020 2020  r1', 'r2']).    
-000066a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000066b0: 7175 616c 2873 2e65 6e76 6972 6f6e 6d65  qual(s.environme
-000066c0: 6e74 2c20 7b27 6b31 273a 2027 7631 272c  nt, {'k1': 'v1',
-000066d0: 2027 6b32 273a 2027 7632 277d 290a 2020   'k2': 'v2'}).  
-000066e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000066f0: 7445 7175 616c 2873 2e75 7365 722c 2027  tEqual(s.user, '
-00006700: 626f 6227 290a 2020 2020 2020 2020 7365  bob').        se
-00006710: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00006720: 2e75 7365 725f 6964 2c20 3130 3030 290a  .user_id, 1000).
-00006730: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00006740: 6572 7445 7175 616c 2873 2e67 726f 7570  ertEqual(s.group
-00006750: 2c20 2773 7461 6666 2729 0a20 2020 2020  , 'staff').     
-00006760: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00006770: 7561 6c28 732e 6772 6f75 705f 6964 2c20  ual(s.group_id, 
-00006780: 3230 3030 290a 2020 2020 2020 2020 7365  2000).        se
-00006790: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-000067a0: 2e6f 6e5f 7375 6363 6573 732c 2027 7265  .on_success, 're
-000067b0: 7374 6172 7427 290a 2020 2020 2020 2020  start').        
-000067c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000067d0: 2873 2e6f 6e5f 6661 696c 7572 652c 2027  (s.on_failure, '
-000067e0: 6967 6e6f 7265 2729 0a20 2020 2020 2020  ignore').       
-000067f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00006800: 6c28 732e 6f6e 5f63 6865 636b 5f66 6169  l(s.on_check_fai
-00006810: 6c75 7265 2c20 7b27 6368 6b31 273a 2027  lure, {'chk1': '
-00006820: 6861 6c74 277d 290a 2020 2020 2020 2020  halt'}).        
-00006830: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006840: 2873 2e62 6163 6b6f 6666 5f64 656c 6179  (s.backoff_delay
-00006850: 2c20 2731 7327 290a 2020 2020 2020 2020  , '1s').        
-00006860: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006870: 2873 2e62 6163 6b6f 6666 5f66 6163 746f  (s.backoff_facto
-00006880: 722c 2034 290a 2020 2020 2020 2020 7365  r, 4).        se
-00006890: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-000068a0: 2e62 6163 6b6f 6666 5f6c 696d 6974 2c20  .backoff_limit, 
-000068b0: 2731 3073 2729 0a0a 2020 2020 2020 2020  '10s')..        
-000068c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000068d0: 2873 2e74 6f5f 6469 6374 2829 2c20 6429  (s.to_dict(), d)
-000068e0: 0a0a 2020 2020 2020 2020 2320 456e 7375  ..        # Ensu
-000068f0: 7265 2070 6562 626c 652e 5365 7276 6963  re pebble.Servic
-00006900: 6520 6861 7320 6d61 6465 2063 6f70 6965  e has made copie
-00006910: 7320 6f66 206d 7574 6162 6c65 206f 626a  s of mutable obj
-00006920: 6563 7473 0a20 2020 2020 2020 2073 2e61  ects.        s.a
-00006930: 6674 6572 2e61 7070 656e 6428 2761 3327  fter.append('a3'
-00006940: 290a 2020 2020 2020 2020 732e 6265 666f  ).        s.befo
-00006950: 7265 2e61 7070 656e 6428 2762 3327 290a  re.append('b3').
-00006960: 2020 2020 2020 2020 732e 7265 7175 6972          s.requir
-00006970: 6573 2e61 7070 656e 6428 2772 3327 290a  es.append('r3').
-00006980: 2020 2020 2020 2020 732e 656e 7669 726f          s.enviro
-00006990: 6e6d 656e 745b 276b 3327 5d20 3d20 2776  nment['k3'] = 'v
-000069a0: 3327 0a20 2020 2020 2020 2073 2e6f 6e5f  3'.        s.on_
-000069b0: 6368 6563 6b5f 6661 696c 7572 655b 2763  check_failure['c
-000069c0: 686b 3227 5d20 3d20 2769 676e 6f72 6527  hk2'] = 'ignore'
-000069d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000069e0: 7365 7274 4571 7561 6c28 732e 6166 7465  sertEqual(s.afte
-000069f0: 722c 205b 2761 3127 2c20 2761 3227 2c20  r, ['a1', 'a2', 
-00006a00: 2761 3327 5d29 0a20 2020 2020 2020 2073  'a3']).        s
-00006a10: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006a20: 732e 6265 666f 7265 2c20 5b27 6231 272c  s.before, ['b1',
-00006a30: 2027 6232 272c 2027 6233 275d 290a 2020   'b2', 'b3']).  
-00006a40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006a50: 7445 7175 616c 2873 2e72 6571 7569 7265  tEqual(s.require
-00006a60: 732c 205b 2772 3127 2c20 2772 3227 2c20  s, ['r1', 'r2', 
-00006a70: 2772 3327 5d29 0a20 2020 2020 2020 2073  'r3']).        s
-00006a80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006a90: 732e 656e 7669 726f 6e6d 656e 742c 207b  s.environment, {
-00006aa0: 276b 3127 3a20 2776 3127 2c20 276b 3227  'k1': 'v1', 'k2'
-00006ab0: 3a20 2776 3227 2c20 276b 3327 3a20 2776  : 'v2', 'k3': 'v
-00006ac0: 3327 7d29 0a20 2020 2020 2020 2073 656c  3'}).        sel
-00006ad0: 662e 6173 7365 7274 4571 7561 6c28 645b  f.assertEqual(d[
-00006ae0: 2761 6674 6572 275d 2c20 5b27 6131 272c  'after'], ['a1',
-00006af0: 2027 6132 275d 290a 2020 2020 2020 2020   'a2']).        
-00006b00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006b10: 2864 5b27 6265 666f 7265 275d 2c20 5b27  (d['before'], ['
-00006b20: 6231 272c 2027 6232 275d 290a 2020 2020  b1', 'b2']).    
-00006b30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00006b40: 7175 616c 2864 5b27 7265 7175 6972 6573  qual(d['requires
-00006b50: 275d 2c20 5b27 7231 272c 2027 7232 275d  '], ['r1', 'r2']
-00006b60: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00006b70: 7373 6572 7445 7175 616c 2864 5b27 656e  ssertEqual(d['en
-00006b80: 7669 726f 6e6d 656e 7427 5d2c 207b 276b  vironment'], {'k
-00006b90: 3127 3a20 2776 3127 2c20 276b 3227 3a20  1': 'v1', 'k2': 
-00006ba0: 2776 3227 7d29 0a20 2020 2020 2020 2073  'v2'}).        s
-00006bb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006bc0: 645b 276f 6e2d 6368 6563 6b2d 6661 696c  d['on-check-fail
-00006bd0: 7572 6527 5d2c 207b 2763 686b 3127 3a20  ure'], {'chk1': 
-00006be0: 2768 616c 7427 7d29 0a0a 2020 2020 6465  'halt'})..    de
-00006bf0: 6620 7465 7374 5f65 7175 616c 6974 7928  f test_equality(
-00006c00: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-00006c10: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00006c20: 2027 7375 6d6d 6172 7927 3a20 2753 756d   'summary': 'Sum
-00006c30: 204d 6172 7927 2c0a 2020 2020 2020 2020   Mary',.        
-00006c40: 2020 2020 2764 6573 6372 6970 7469 6f6e      'description
-00006c50: 273a 2027 5468 6520 6c61 7a79 2071 7569  ': 'The lazy qui
-00006c60: 636b 2062 726f 776e 272c 0a20 2020 2020  ck brown',.     
-00006c70: 2020 2020 2020 2027 7374 6172 7475 7027         'startup'
-00006c80: 3a20 2753 7461 7274 2055 7027 2c0a 2020  : 'Start Up',.  
-00006c90: 2020 2020 2020 2020 2020 276f 7665 7272            'overr
-00006ca0: 6964 6527 3a20 276f 7665 7272 6964 6527  ide': 'override'
-00006cb0: 2c0a 2020 2020 2020 2020 2020 2020 2763  ,.            'c
-00006cc0: 6f6d 6d61 6e64 273a 2027 6563 686f 2073  ommand': 'echo s
-00006cd0: 756d 206d 6172 7927 2c0a 2020 2020 2020  um mary',.      
-00006ce0: 2020 2020 2020 2761 6674 6572 273a 205b        'after': [
-00006cf0: 2761 3127 2c20 2761 3227 5d2c 0a20 2020  'a1', 'a2'],.   
-00006d00: 2020 2020 2020 2020 2027 6265 666f 7265           'before
-00006d10: 273a 205b 2762 3127 2c20 2762 3227 5d2c  ': ['b1', 'b2'],
-00006d20: 0a20 2020 2020 2020 2020 2020 2027 7265  .            're
-00006d30: 7175 6972 6573 273a 205b 2772 3127 2c20  quires': ['r1', 
-00006d40: 2772 3227 5d2c 0a20 2020 2020 2020 2020  'r2'],.         
-00006d50: 2020 2027 656e 7669 726f 6e6d 656e 7427     'environment'
-00006d60: 3a20 7b27 6b31 273a 2027 7631 272c 2027  : {'k1': 'v1', '
-00006d70: 6b32 273a 2027 7632 277d 2c0a 2020 2020  k2': 'v2'},.    
-00006d80: 2020 2020 2020 2020 2775 7365 7227 3a20          'user': 
-00006d90: 2762 6f62 272c 0a20 2020 2020 2020 2020  'bob',.         
-00006da0: 2020 2027 7573 6572 2d69 6427 3a20 3130     'user-id': 10
-00006db0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00006dc0: 2767 726f 7570 273a 2027 7374 6166 6627  'group': 'staff'
-00006dd0: 2c0a 2020 2020 2020 2020 2020 2020 2767  ,.            'g
-00006de0: 726f 7570 2d69 6427 3a20 3230 3030 2c0a  roup-id': 2000,.
-00006df0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00006e00: 2020 6f6e 6520 3d20 7065 6262 6c65 2e53    one = pebble.S
-00006e10: 6572 7669 6365 2822 4e61 6d65 2031 222c  ervice("Name 1",
-00006e20: 2064 290a 2020 2020 2020 2020 7477 6f20   d).        two 
-00006e30: 3d20 7065 6262 6c65 2e53 6572 7669 6365  = pebble.Service
-00006e40: 2822 4e61 6d65 2031 222c 2064 290a 2020  ("Name 1", d).  
-00006e50: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00006e60: 7445 7175 616c 286f 6e65 2c20 7477 6f29  tEqual(one, two)
-00006e70: 0a0a 2020 2020 2020 2020 6173 5f64 6963  ..        as_dic
-00006e80: 7420 3d20 7b0a 2020 2020 2020 2020 2020  t = {.          
-00006e90: 2020 2773 756d 6d61 7279 273a 2027 5375    'summary': 'Su
-00006ea0: 6d20 4d61 7279 272c 0a20 2020 2020 2020  m Mary',.       
-00006eb0: 2020 2020 2027 6465 7363 7269 7074 696f       'descriptio
-00006ec0: 6e27 3a20 2754 6865 206c 617a 7920 7175  n': 'The lazy qu
-00006ed0: 6963 6b20 6272 6f77 6e27 2c0a 2020 2020  ick brown',.    
-00006ee0: 2020 2020 2020 2020 2773 7461 7274 7570          'startup
-00006ef0: 273a 2027 5374 6172 7420 5570 272c 0a20  ': 'Start Up',. 
-00006f00: 2020 2020 2020 2020 2020 2027 6f76 6572             'over
-00006f10: 7269 6465 273a 2027 6f76 6572 7269 6465  ride': 'override
-00006f20: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00006f30: 636f 6d6d 616e 6427 3a20 2765 6368 6f20  command': 'echo 
-00006f40: 7375 6d20 6d61 7279 272c 0a20 2020 2020  sum mary',.     
-00006f50: 2020 2020 2020 2027 6166 7465 7227 3a20         'after': 
-00006f60: 5b27 6131 272c 2027 6132 275d 2c0a 2020  ['a1', 'a2'],.  
-00006f70: 2020 2020 2020 2020 2020 2762 6566 6f72            'befor
-00006f80: 6527 3a20 5b27 6231 272c 2027 6232 275d  e': ['b1', 'b2']
-00006f90: 2c0a 2020 2020 2020 2020 2020 2020 2772  ,.            'r
-00006fa0: 6571 7569 7265 7327 3a20 5b27 7231 272c  equires': ['r1',
-00006fb0: 2027 7232 275d 2c0a 2020 2020 2020 2020   'r2'],.        
-00006fc0: 2020 2020 2765 6e76 6972 6f6e 6d65 6e74      'environment
-00006fd0: 273a 207b 276b 3127 3a20 2776 3127 2c20  ': {'k1': 'v1', 
-00006fe0: 276b 3227 3a20 2776 3227 7d2c 0a20 2020  'k2': 'v2'},.   
-00006ff0: 2020 2020 2020 2020 2027 7573 6572 273a           'user':
-00007000: 2027 626f 6227 2c0a 2020 2020 2020 2020   'bob',.        
-00007010: 2020 2020 2775 7365 722d 6964 273a 2031      'user-id': 1
-00007020: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
-00007030: 2027 6772 6f75 7027 3a20 2773 7461 6666   'group': 'staff
-00007040: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00007050: 6772 6f75 702d 6964 273a 2032 3030 302c  group-id': 2000,
-00007060: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00007070: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00007080: 7561 6c28 6f6e 652c 2061 735f 6469 6374  ual(one, as_dict
-00007090: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-000070a0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-000070b0: 7328 5661 6c75 6545 7272 6f72 293a 0a20  s(ValueError):. 
-000070c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000070d0: 6173 7365 7274 4571 7561 6c28 6f6e 652c  assertEqual(one,
-000070e0: 2035 290a 0a0a 636c 6173 7320 5465 7374   5)...class Test
-000070f0: 4368 6563 6b28 756e 6974 7465 7374 2e54  Check(unittest.T
-00007100: 6573 7443 6173 6529 3a0a 2020 2020 6465  estCase):.    de
-00007110: 6620 5f61 7373 6572 745f 656d 7074 7928  f _assert_empty(
-00007120: 7365 6c66 2c20 6368 6563 6b2c 206e 616d  self, check, nam
-00007130: 6529 3a0a 2020 2020 2020 2020 7365 6c66  e):.        self
-00007140: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00007150: 636b 2e6e 616d 652c 206e 616d 6529 0a20  ck.name, name). 
-00007160: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007170: 7274 4571 7561 6c28 6368 6563 6b2e 6f76  rtEqual(check.ov
-00007180: 6572 7269 6465 2c20 2727 290a 2020 2020  erride, '').    
-00007190: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000071a0: 7175 616c 2863 6865 636b 2e6c 6576 656c  qual(check.level
-000071b0: 2c20 7065 6262 6c65 2e43 6865 636b 4c65  , pebble.CheckLe
-000071c0: 7665 6c2e 554e 5345 5429 0a20 2020 2020  vel.UNSET).     
-000071d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000071e0: 7561 6c28 6368 6563 6b2e 7065 7269 6f64  ual(check.period
-000071f0: 2c20 2727 290a 2020 2020 2020 2020 7365  , '').        se
-00007200: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00007210: 6865 636b 2e74 696d 656f 7574 2c20 2727  heck.timeout, ''
-00007220: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00007230: 7373 6572 7449 7328 6368 6563 6b2e 7468  ssertIs(check.th
-00007240: 7265 7368 6f6c 642c 204e 6f6e 6529 0a20  reshold, None). 
-00007250: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007260: 7274 4973 2863 6865 636b 2e68 7474 702c  rtIs(check.http,
-00007270: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
-00007280: 656c 662e 6173 7365 7274 4973 2863 6865  elf.assertIs(che
-00007290: 636b 2e74 6370 2c20 4e6f 6e65 290a 2020  ck.tcp, None).  
-000072a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000072b0: 7449 7328 6368 6563 6b2e 6578 6563 2c20  tIs(check.exec, 
-000072c0: 4e6f 6e65 290a 0a20 2020 2064 6566 2074  None)..    def t
-000072d0: 6573 745f 6e61 6d65 5f6f 6e6c 7928 7365  est_name_only(se
-000072e0: 6c66 293a 0a20 2020 2020 2020 2063 6865  lf):.        che
-000072f0: 636b 203d 2070 6562 626c 652e 4368 6563  ck = pebble.Chec
-00007300: 6b28 2763 686b 2729 0a20 2020 2020 2020  k('chk').       
-00007310: 2073 656c 662e 5f61 7373 6572 745f 656d   self._assert_em
-00007320: 7074 7928 6368 6563 6b2c 2027 6368 6b27  pty(check, 'chk'
-00007330: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00007340: 6469 6374 2873 656c 6629 3a0a 2020 2020  dict(self):.    
-00007350: 2020 2020 6420 3d20 7b0a 2020 2020 2020      d = {.      
-00007360: 2020 2020 2020 276f 7665 7272 6964 6527        'override'
-00007370: 3a20 2772 6570 6c61 6365 272c 0a20 2020  : 'replace',.   
-00007380: 2020 2020 2020 2020 2027 6c65 7665 6c27           'level'
-00007390: 3a20 2761 6c69 7665 272c 0a20 2020 2020  : 'alive',.     
-000073a0: 2020 2020 2020 2027 7065 7269 6f64 273a         'period':
-000073b0: 2027 3130 7327 2c0a 2020 2020 2020 2020   '10s',.        
-000073c0: 2020 2020 2774 696d 656f 7574 273a 2027      'timeout': '
-000073d0: 3373 272c 0a20 2020 2020 2020 2020 2020  3s',.           
-000073e0: 2027 7468 7265 7368 6f6c 6427 3a20 352c   'threshold': 5,
-000073f0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-00007400: 6f74 2076 616c 6964 2066 6f72 2050 6562  ot valid for Peb
-00007410: 626c 6520 746f 2068 6176 6520 6d6f 7265  ble to have more
-00007420: 2074 6861 6e20 6f6e 6520 6f66 2068 7474   than one of htt
-00007430: 702c 2074 6370 2c20 616e 6420 6578 6563  p, tcp, and exec
-00007440: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00007450: 6275 7420 6974 206d 616b 6573 2074 6869  but it makes thi
-00007460: 6e67 7320 7369 6d70 6c65 7220 666f 7220  ngs simpler for 
-00007470: 7468 6520 756e 6974 2074 6573 7473 2e0a  the unit tests..
-00007480: 2020 2020 2020 2020 2020 2020 2768 7474              'htt
-00007490: 7027 3a20 7b27 7572 6c27 3a20 2768 7474  p': {'url': 'htt
-000074a0: 7073 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  ps://example.com
-000074b0: 2f27 7d2c 0a20 2020 2020 2020 2020 2020  /'},.           
-000074c0: 2027 7463 7027 3a20 7b27 706f 7274 273a   'tcp': {'port':
-000074d0: 2038 307d 2c0a 2020 2020 2020 2020 2020   80},.          
-000074e0: 2020 2765 7865 6327 3a20 7b27 636f 6d6d    'exec': {'comm
-000074f0: 616e 6427 3a20 2765 6368 6f20 666f 6f27  and': 'echo foo'
-00007500: 7d2c 0a20 2020 2020 2020 207d 0a20 2020  },.        }.   
-00007510: 2020 2020 2063 6865 636b 203d 2070 6562       check = peb
-00007520: 626c 652e 4368 6563 6b28 2763 686b 2d68  ble.Check('chk-h
-00007530: 7474 7027 2c20 6429 0a20 2020 2020 2020  ttp', d).       
-00007540: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00007550: 6c28 6368 6563 6b2e 6e61 6d65 2c20 2763  l(check.name, 'c
-00007560: 686b 2d68 7474 7027 290a 2020 2020 2020  hk-http').      
-00007570: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007580: 616c 2863 6865 636b 2e6f 7665 7272 6964  al(check.overrid
-00007590: 652c 2027 7265 706c 6163 6527 290a 2020  e, 'replace').  
-000075a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000075b0: 7445 7175 616c 2863 6865 636b 2e6c 6576  tEqual(check.lev
-000075c0: 656c 2c20 7065 6262 6c65 2e43 6865 636b  el, pebble.Check
-000075d0: 4c65 7665 6c2e 414c 4956 4529 0a20 2020  Level.ALIVE).   
-000075e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000075f0: 4571 7561 6c28 6368 6563 6b2e 7065 7269  Equal(check.peri
-00007600: 6f64 2c20 2731 3073 2729 0a20 2020 2020  od, '10s').     
-00007610: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00007620: 7561 6c28 6368 6563 6b2e 7469 6d65 6f75  ual(check.timeou
-00007630: 742c 2027 3373 2729 0a20 2020 2020 2020  t, '3s').       
-00007640: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00007650: 6c28 6368 6563 6b2e 7468 7265 7368 6f6c  l(check.threshol
-00007660: 642c 2035 290a 2020 2020 2020 2020 7365  d, 5).        se
-00007670: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00007680: 6865 636b 2e68 7474 702c 207b 2775 726c  heck.http, {'url
-00007690: 273a 2027 6874 7470 733a 2f2f 6578 616d  ': 'https://exam
-000076a0: 706c 652e 636f 6d2f 277d 290a 2020 2020  ple.com/'}).    
-000076b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000076c0: 7175 616c 2863 6865 636b 2e74 6370 2c20  qual(check.tcp, 
-000076d0: 7b27 706f 7274 273a 2038 307d 290a 2020  {'port': 80}).  
-000076e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000076f0: 7445 7175 616c 2863 6865 636b 2e65 7865  tEqual(check.exe
-00007700: 632c 207b 2763 6f6d 6d61 6e64 273a 2027  c, {'command': '
-00007710: 6563 686f 2066 6f6f 277d 290a 0a20 2020  echo foo'})..   
-00007720: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007730: 4571 7561 6c28 6368 6563 6b2e 746f 5f64  Equal(check.to_d
-00007740: 6963 7428 292c 2064 290a 0a20 2020 2020  ict(), d)..     
-00007750: 2020 2023 2045 6e73 7572 6520 7065 6262     # Ensure pebb
-00007760: 6c65 2e43 6865 636b 2068 6173 206d 6164  le.Check has mad
-00007770: 6520 636f 7069 6573 206f 6620 6d75 7461  e copies of muta
-00007780: 626c 6520 6f62 6a65 6374 730a 2020 2020  ble objects.    
-00007790: 2020 2020 6368 6563 6b2e 6874 7470 5b27      check.http['
-000077a0: 7572 6c27 5d20 3d20 2768 7474 7073 3a2f  url'] = 'https:/
-000077b0: 2f77 7777 2e67 6f6f 676c 652e 636f 6d27  /www.google.com'
-000077c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000077d0: 7365 7274 4571 7561 6c28 645b 2768 7474  sertEqual(d['htt
-000077e0: 7027 5d2c 207b 2775 726c 273a 2027 6874  p'], {'url': 'ht
-000077f0: 7470 733a 2f2f 6578 616d 706c 652e 636f  tps://example.co
-00007800: 6d2f 277d 290a 2020 2020 2020 2020 6368  m/'}).        ch
-00007810: 6563 6b2e 7463 705b 2770 6f72 7427 5d20  eck.tcp['port'] 
-00007820: 3d20 3831 0a20 2020 2020 2020 2073 656c  = 81.        sel
-00007830: 662e 6173 7365 7274 4571 7561 6c28 645b  f.assertEqual(d[
-00007840: 2774 6370 275d 2c20 7b27 706f 7274 273a  'tcp'], {'port':
-00007850: 2038 307d 290a 2020 2020 2020 2020 6368   80}).        ch
-00007860: 6563 6b2e 6578 6563 5b27 636f 6d6d 616e  eck.exec['comman
-00007870: 6427 5d20 3d20 2766 6f6f 270a 2020 2020  d'] = 'foo'.    
-00007880: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007890: 7175 616c 2864 5b27 6578 6563 275d 2c20  qual(d['exec'], 
-000078a0: 7b27 636f 6d6d 616e 6427 3a20 2765 6368  {'command': 'ech
-000078b0: 6f20 666f 6f27 7d29 0a0a 2020 2020 6465  o foo'})..    de
-000078c0: 6620 7465 7374 5f6c 6576 656c 5f72 6177  f test_level_raw
-000078d0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000078e0: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
-000078f0: 2020 276f 7665 7272 6964 6527 3a20 2772    'override': 'r
-00007900: 6570 6c61 6365 272c 0a20 2020 2020 2020  eplace',.       
-00007910: 2020 2020 2027 6c65 7665 6c27 3a20 2766       'level': 'f
-00007920: 6f6f 6261 7221 272c 0a20 2020 2020 2020  oobar!',.       
-00007930: 2020 2020 2027 7065 7269 6f64 273a 2027       'period': '
-00007940: 3130 7327 2c0a 2020 2020 2020 2020 2020  10s',.          
-00007950: 2020 2774 696d 656f 7574 273a 2027 3373    'timeout': '3s
-00007960: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00007970: 7468 7265 7368 6f6c 6427 3a20 352c 0a20  threshold': 5,. 
-00007980: 2020 2020 2020 2020 2020 2027 6874 7470             'http
-00007990: 273a 207b 2775 726c 273a 2027 6874 7470  ': {'url': 'http
-000079a0: 733a 2f2f 6578 616d 706c 652e 636f 6d2f  s://example.com/
-000079b0: 277d 2c0a 2020 2020 2020 2020 7d0a 2020  '},.        }.  
-000079c0: 2020 2020 2020 6368 6563 6b20 3d20 7065        check = pe
-000079d0: 6262 6c65 2e43 6865 636b 2827 6368 6b2d  bble.Check('chk-
-000079e0: 6874 7470 272c 2064 290a 2020 2020 2020  http', d).      
-000079f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007a00: 616c 2863 6865 636b 2e6c 6576 656c 2c20  al(check.level, 
-00007a10: 2766 6f6f 6261 7221 2729 2020 2320 7265  'foobar!')  # re
-00007a20: 6d61 696e 7320 6120 7374 7269 6e67 0a0a  mains a string..
-00007a30: 2020 2020 6465 6620 7465 7374 5f65 7175      def test_equ
-00007a40: 616c 6974 7928 7365 6c66 293a 0a20 2020  ality(self):.   
-00007a50: 2020 2020 2064 203d 207b 0a20 2020 2020       d = {.     
-00007a60: 2020 2020 2020 2027 6f76 6572 7269 6465         'override
-00007a70: 273a 2027 7265 706c 6163 6527 2c0a 2020  ': 'replace',.  
-00007a80: 2020 2020 2020 2020 2020 276c 6576 656c            'level
-00007a90: 273a 2027 616c 6976 6527 2c0a 2020 2020  ': 'alive',.    
-00007aa0: 2020 2020 2020 2020 2770 6572 696f 6427          'period'
-00007ab0: 3a20 2731 3073 272c 0a20 2020 2020 2020  : '10s',.       
-00007ac0: 2020 2020 2027 7469 6d65 6f75 7427 3a20       'timeout': 
-00007ad0: 2733 7327 2c0a 2020 2020 2020 2020 2020  '3s',.          
-00007ae0: 2020 2774 6872 6573 686f 6c64 273a 2035    'threshold': 5
-00007af0: 2c0a 2020 2020 2020 2020 2020 2020 2768  ,.            'h
-00007b00: 7474 7027 3a20 7b27 7572 6c27 3a20 2768  ttp': {'url': 'h
-00007b10: 7474 7073 3a2f 2f65 7861 6d70 6c65 2e63  ttps://example.c
-00007b20: 6f6d 2f27 7d2c 0a20 2020 2020 2020 207d  om/'},.        }
-00007b30: 0a20 2020 2020 2020 206f 6e65 203d 2070  .        one = p
-00007b40: 6562 626c 652e 4368 6563 6b28 276f 6e65  ebble.Check('one
-00007b50: 272c 2064 290a 2020 2020 2020 2020 7477  ', d).        tw
-00007b60: 6f20 3d20 7065 6262 6c65 2e43 6865 636b  o = pebble.Check
-00007b70: 2827 7477 6f27 2c20 6429 0a20 2020 2020  ('two', d).     
-00007b80: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00007b90: 7561 6c28 6f6e 652c 2074 776f 290a 2020  ual(one, two).  
-00007ba0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00007bb0: 7445 7175 616c 286f 6e65 2c20 6429 0a20  tEqual(one, d). 
-00007bc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007bd0: 7274 4571 7561 6c28 7477 6f2c 2064 290a  rtEqual(two, d).
-00007be0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007bf0: 6572 7445 7175 616c 286f 6e65 2c20 6f6e  ertEqual(one, on
-00007c00: 652e 746f 5f64 6963 7428 2929 0a20 2020  e.to_dict()).   
-00007c10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007c20: 4571 7561 6c28 7477 6f2c 2074 776f 2e74  Equal(two, two.t
-00007c30: 6f5f 6469 6374 2829 290a 2020 2020 2020  o_dict()).      
-00007c40: 2020 645b 276c 6576 656c 275d 203d 2027    d['level'] = '
-00007c50: 7265 6164 7927 0a20 2020 2020 2020 2073  ready'.        s
-00007c60: 656c 662e 6173 7365 7274 4e6f 7445 7175  elf.assertNotEqu
-00007c70: 616c 286f 6e65 2c20 6429 0a0a 2020 2020  al(one, d)..    
-00007c80: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-00007c90: 7365 7274 5261 6973 6573 2856 616c 7565  sertRaises(Value
-00007ca0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00007cb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007cc0: 7175 616c 286f 6e65 2c20 3529 0a0a 0a63  qual(one, 5)...c
-00007cd0: 6c61 7373 2054 6573 7453 6572 7669 6365  lass TestService
-00007ce0: 496e 666f 2875 6e69 7474 6573 742e 5465  Info(unittest.Te
-00007cf0: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
-00007d00: 2074 6573 745f 7365 7276 6963 655f 7374   test_service_st
-00007d10: 6172 7475 7028 7365 6c66 293a 0a20 2020  artup(self):.   
-00007d20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007d30: 4571 7561 6c28 6c69 7374 2870 6562 626c  Equal(list(pebbl
-00007d40: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-00007d50: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-00007d60: 2070 6562 626c 652e 5365 7276 6963 6553   pebble.ServiceS
-00007d70: 7461 7274 7570 2e45 4e41 424c 4544 2c0a  tartup.ENABLED,.
-00007d80: 2020 2020 2020 2020 2020 2020 7065 6262              pebb
-00007d90: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
-00007da0: 702e 4449 5341 424c 4544 2c0a 2020 2020  p.DISABLED,.    
-00007db0: 2020 2020 5d29 0a20 2020 2020 2020 2073      ]).        s
-00007dc0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00007dd0: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
-00007de0: 6172 7475 702e 454e 4142 4c45 442e 7661  artup.ENABLED.va
-00007df0: 6c75 652c 2027 656e 6162 6c65 6427 290a  lue, 'enabled').
-00007e00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00007e10: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
-00007e20: 5365 7276 6963 6553 7461 7274 7570 2e44  ServiceStartup.D
-00007e30: 4953 4142 4c45 442e 7661 6c75 652c 2027  ISABLED.value, '
-00007e40: 6469 7361 626c 6564 2729 0a0a 2020 2020  disabled')..    
-00007e50: 6465 6620 7465 7374 5f73 6572 7669 6365  def test_service
-00007e60: 5f73 7461 7475 7328 7365 6c66 293a 0a20  _status(self):. 
-00007e70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00007e80: 7274 4571 7561 6c28 6c69 7374 2870 6562  rtEqual(list(peb
-00007e90: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-00007ea0: 7329 2c20 5b0a 2020 2020 2020 2020 2020  s), [.          
-00007eb0: 2020 7065 6262 6c65 2e53 6572 7669 6365    pebble.Service
-00007ec0: 5374 6174 7573 2e41 4354 4956 452c 0a20  Status.ACTIVE,. 
-00007ed0: 2020 2020 2020 2020 2020 2070 6562 626c             pebbl
-00007ee0: 652e 5365 7276 6963 6553 7461 7475 732e  e.ServiceStatus.
-00007ef0: 494e 4143 5449 5645 2c0a 2020 2020 2020  INACTIVE,.      
-00007f00: 2020 2020 2020 7065 6262 6c65 2e53 6572        pebble.Ser
-00007f10: 7669 6365 5374 6174 7573 2e45 5252 4f52  viceStatus.ERROR
-00007f20: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
-00007f30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007f40: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
-00007f50: 7669 6365 5374 6174 7573 2e41 4354 4956  viceStatus.ACTIV
-00007f60: 452e 7661 6c75 652c 2027 6163 7469 7665  E.value, 'active
-00007f70: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00007f80: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
-00007f90: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
-00007fa0: 2e49 4e41 4354 4956 452e 7661 6c75 652c  .INACTIVE.value,
-00007fb0: 2027 696e 6163 7469 7665 2729 0a20 2020   'inactive').   
-00007fc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00007fd0: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
-00007fe0: 7669 6365 5374 6174 7573 2e45 5252 4f52  viceStatus.ERROR
-00007ff0: 2e76 616c 7565 2c20 2765 7272 6f72 2729  .value, 'error')
-00008000: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-00008010: 6572 7669 6365 5f69 6e66 6f28 7365 6c66  ervice_info(self
-00008020: 293a 0a20 2020 2020 2020 2073 203d 2070  ):.        s = p
-00008030: 6562 626c 652e 5365 7276 6963 6549 6e66  ebble.ServiceInf
-00008040: 6f28 2773 7663 3127 2c20 7065 6262 6c65  o('svc1', pebble
-00008050: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-00008060: 454e 4142 4c45 442c 2070 6562 626c 652e  ENABLED, pebble.
-00008070: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
-00008080: 5449 5645 290a 2020 2020 2020 2020 7365  TIVE).        se
-00008090: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-000080a0: 2e6e 616d 652c 2027 7376 6331 2729 0a20  .name, 'svc1'). 
-000080b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000080c0: 7274 4571 7561 6c28 732e 7374 6172 7475  rtEqual(s.startu
-000080d0: 702c 2070 6562 626c 652e 5365 7276 6963  p, pebble.Servic
-000080e0: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
-000080f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00008100: 7373 6572 7445 7175 616c 2873 2e63 7572  ssertEqual(s.cur
-00008110: 7265 6e74 2c20 7065 6262 6c65 2e53 6572  rent, pebble.Ser
-00008120: 7669 6365 5374 6174 7573 2e41 4354 4956  viceStatus.ACTIV
-00008130: 4529 0a0a 2020 2020 2020 2020 7320 3d20  E)..        s = 
-00008140: 7065 6262 6c65 2e53 6572 7669 6365 496e  pebble.ServiceIn
-00008150: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-00008160: 2773 7663 3127 2c0a 2020 2020 2020 2020  'svc1',.        
-00008170: 2020 2020 7065 6262 6c65 2e53 6572 7669      pebble.Servi
-00008180: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
-00008190: 442c 0a20 2020 2020 2020 2020 2020 2070  D,.            p
-000081a0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-000081b0: 7475 732e 4143 5449 5645 290a 2020 2020  tus.ACTIVE).    
-000081c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000081d0: 7175 616c 2873 2e6e 616d 652c 2027 7376  qual(s.name, 'sv
-000081e0: 6331 2729 0a20 2020 2020 2020 2073 656c  c1').        sel
-000081f0: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
-00008200: 7374 6172 7475 702c 2070 6562 626c 652e  startup, pebble.
-00008210: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
-00008220: 4e41 424c 4544 290a 2020 2020 2020 2020  NABLED).        
-00008230: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00008240: 2873 2e63 7572 7265 6e74 2c20 7065 6262  (s.current, pebb
-00008250: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
-00008260: 2e41 4354 4956 4529 0a0a 2020 2020 2020  .ACTIVE)..      
-00008270: 2020 7320 3d20 7065 6262 6c65 2e53 6572    s = pebble.Ser
-00008280: 7669 6365 496e 666f 2e66 726f 6d5f 6469  viceInfo.from_di
-00008290: 6374 287b 0a20 2020 2020 2020 2020 2020  ct({.           
-000082a0: 2027 6e61 6d65 273a 2027 7376 6332 272c   'name': 'svc2',
-000082b0: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
-000082c0: 6172 7475 7027 3a20 2764 6973 6162 6c65  artup': 'disable
-000082d0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-000082e0: 2763 7572 7265 6e74 273a 2027 696e 6163  'current': 'inac
-000082f0: 7469 7665 272c 0a20 2020 2020 2020 207d  tive',.        }
-00008300: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00008310: 7373 6572 7445 7175 616c 2873 2e6e 616d  ssertEqual(s.nam
-00008320: 652c 2027 7376 6332 2729 0a20 2020 2020  e, 'svc2').     
-00008330: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00008340: 7561 6c28 732e 7374 6172 7475 702c 2070  ual(s.startup, p
-00008350: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-00008360: 7274 7570 2e44 4953 4142 4c45 4429 0a20  rtup.DISABLED). 
-00008370: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008380: 7274 4571 7561 6c28 732e 6375 7272 656e  rtEqual(s.curren
-00008390: 742c 2070 6562 626c 652e 5365 7276 6963  t, pebble.Servic
-000083a0: 6553 7461 7475 732e 494e 4143 5449 5645  eStatus.INACTIVE
-000083b0: 290a 0a20 2020 2020 2020 2073 203d 2070  )..        s = p
-000083c0: 6562 626c 652e 5365 7276 6963 6549 6e66  ebble.ServiceInf
-000083d0: 6f2e 6672 6f6d 5f64 6963 7428 7b0a 2020  o.from_dict({.  
-000083e0: 2020 2020 2020 2020 2020 276e 616d 6527            'name'
-000083f0: 3a20 2773 7663 3227 2c0a 2020 2020 2020  : 'svc2',.      
-00008400: 2020 2020 2020 2773 7461 7274 7570 273a        'startup':
-00008410: 2027 7468 696e 6779 272c 0a20 2020 2020   'thingy',.     
-00008420: 2020 2020 2020 2027 6375 7272 656e 7427         'current'
-00008430: 3a20 2762 6f62 272c 0a20 2020 2020 2020  : 'bob',.       
-00008440: 207d 290a 2020 2020 2020 2020 7365 6c66   }).        self
-00008450: 2e61 7373 6572 7445 7175 616c 2873 2e6e  .assertEqual(s.n
-00008460: 616d 652c 2027 7376 6332 2729 0a20 2020  ame, 'svc2').   
-00008470: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00008480: 4571 7561 6c28 732e 7374 6172 7475 702c  Equal(s.startup,
-00008490: 2027 7468 696e 6779 2729 0a20 2020 2020   'thingy').     
-000084a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000084b0: 7561 6c28 732e 6375 7272 656e 742c 2027  ual(s.current, '
-000084c0: 626f 6227 290a 0a20 2020 2064 6566 2074  bob')..    def t
-000084d0: 6573 745f 6973 5f72 756e 6e69 6e67 2873  est_is_running(s
-000084e0: 656c 6629 3a0a 2020 2020 2020 2020 7320  elf):.        s 
-000084f0: 3d20 7065 6262 6c65 2e53 6572 7669 6365  = pebble.Service
-00008500: 496e 666f 2827 7327 2c20 7065 6262 6c65  Info('s', pebble
-00008510: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
-00008520: 454e 4142 4c45 442c 2070 6562 626c 652e  ENABLED, pebble.
-00008530: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
-00008540: 5449 5645 290a 2020 2020 2020 2020 7365  TIVE).        se
-00008550: 6c66 2e61 7373 6572 7454 7275 6528 732e  lf.assertTrue(s.
-00008560: 6973 5f72 756e 6e69 6e67 2829 290a 2020  is_running()).  
-00008570: 2020 2020 2020 666f 7220 6375 7272 656e        for curren
-00008580: 7420 696e 205b 7065 6262 6c65 2e53 6572  t in [pebble.Ser
-00008590: 7669 6365 5374 6174 7573 2e49 4e41 4354  viceStatus.INACT
-000085a0: 4956 452c 2070 6562 626c 652e 5365 7276  IVE, pebble.Serv
-000085b0: 6963 6553 7461 7475 732e 4552 524f 522c  iceStatus.ERROR,
-000085c0: 2027 6f74 6865 7227 5d3a 0a20 2020 2020   'other']:.     
-000085d0: 2020 2020 2020 2073 203d 2070 6562 626c         s = pebbl
-000085e0: 652e 5365 7276 6963 6549 6e66 6f28 2773  e.ServiceInfo('s
-000085f0: 272c 2070 6562 626c 652e 5365 7276 6963  ', pebble.Servic
-00008600: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
-00008610: 2c20 6375 7272 656e 7429 0a20 2020 2020  , current).     
-00008620: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00008630: 7274 4661 6c73 6528 732e 6973 5f72 756e  rtFalse(s.is_run
-00008640: 6e69 6e67 2829 290a 0a0a 636c 6173 7320  ning())...class 
-00008650: 5465 7374 4368 6563 6b49 6e66 6f28 756e  TestCheckInfo(un
-00008660: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
-00008670: 3a0a 2020 2020 6465 6620 7465 7374 5f63  :.    def test_c
-00008680: 6865 636b 5f6c 6576 656c 2873 656c 6629  heck_level(self)
-00008690: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-000086a0: 7373 6572 7445 7175 616c 286c 6973 7428  ssertEqual(list(
-000086b0: 7065 6262 6c65 2e43 6865 636b 4c65 7665  pebble.CheckLeve
-000086c0: 6c29 2c20 5b0a 2020 2020 2020 2020 2020  l), [.          
-000086d0: 2020 7065 6262 6c65 2e43 6865 636b 4c65    pebble.CheckLe
-000086e0: 7665 6c2e 554e 5345 542c 0a20 2020 2020  vel.UNSET,.     
-000086f0: 2020 2020 2020 2070 6562 626c 652e 4368         pebble.Ch
-00008700: 6563 6b4c 6576 656c 2e41 4c49 5645 2c0a  eckLevel.ALIVE,.
-00008710: 2020 2020 2020 2020 2020 2020 7065 6262              pebb
-00008720: 6c65 2e43 6865 636b 4c65 7665 6c2e 5245  le.CheckLevel.RE
-00008730: 4144 592c 0a20 2020 2020 2020 205d 290a  ADY,.        ]).
-00008740: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008750: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
-00008760: 4368 6563 6b4c 6576 656c 2e55 4e53 4554  CheckLevel.UNSET
-00008770: 2e76 616c 7565 2c20 2727 290a 2020 2020  .value, '').    
-00008780: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00008790: 7175 616c 2870 6562 626c 652e 4368 6563  qual(pebble.Chec
-000087a0: 6b4c 6576 656c 2e41 4c49 5645 2e76 616c  kLevel.ALIVE.val
-000087b0: 7565 2c20 2761 6c69 7665 2729 0a20 2020  ue, 'alive').   
-000087c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000087d0: 4571 7561 6c28 7065 6262 6c65 2e43 6865  Equal(pebble.Che
-000087e0: 636b 4c65 7665 6c2e 5245 4144 592e 7661  ckLevel.READY.va
-000087f0: 6c75 652c 2027 7265 6164 7927 290a 0a20  lue, 'ready').. 
-00008800: 2020 2064 6566 2074 6573 745f 6368 6563     def test_chec
-00008810: 6b5f 7374 6174 7573 2873 656c 6629 3a0a  k_status(self):.
-00008820: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008830: 6572 7445 7175 616c 286c 6973 7428 7065  ertEqual(list(pe
-00008840: 6262 6c65 2e43 6865 636b 5374 6174 7573  bble.CheckStatus
-00008850: 292c 205b 0a20 2020 2020 2020 2020 2020  ), [.           
-00008860: 2070 6562 626c 652e 4368 6563 6b53 7461   pebble.CheckSta
-00008870: 7475 732e 5550 2c0a 2020 2020 2020 2020  tus.UP,.        
-00008880: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
-00008890: 5374 6174 7573 2e44 4f57 4e2c 0a20 2020  Status.DOWN,.   
-000088a0: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
-000088b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000088c0: 2870 6562 626c 652e 4368 6563 6b53 7461  (pebble.CheckSta
-000088d0: 7475 732e 5550 2e76 616c 7565 2c20 2775  tus.UP.value, 'u
-000088e0: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
-000088f0: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-00008900: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-00008910: 444f 574e 2e76 616c 7565 2c20 2764 6f77  DOWN.value, 'dow
-00008920: 6e27 290a 0a20 2020 2064 6566 2074 6573  n')..    def tes
-00008930: 745f 6368 6563 6b5f 696e 666f 2873 656c  t_check_info(sel
-00008940: 6629 3a0a 2020 2020 2020 2020 6368 6563  f):.        chec
-00008950: 6b20 3d20 7065 6262 6c65 2e43 6865 636b  k = pebble.Check
-00008960: 496e 666f 280a 2020 2020 2020 2020 2020  Info(.          
-00008970: 2020 6e61 6d65 3d27 6368 6b31 272c 0a20    name='chk1',. 
-00008980: 2020 2020 2020 2020 2020 206c 6576 656c             level
-00008990: 3d70 6562 626c 652e 4368 6563 6b4c 6576  =pebble.CheckLev
-000089a0: 656c 2e52 4541 4459 2c0a 2020 2020 2020  el.READY,.      
-000089b0: 2020 2020 2020 7374 6174 7573 3d70 6562        status=peb
-000089c0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-000089d0: 5550 2c0a 2020 2020 2020 2020 2020 2020  UP,.            
-000089e0: 7468 7265 7368 6f6c 643d 332c 0a20 2020  threshold=3,.   
-000089f0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-00008a00: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00008a10: 6368 6563 6b2e 6e61 6d65 2c20 2763 686b  check.name, 'chk
-00008a20: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
-00008a30: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00008a40: 636b 2e6c 6576 656c 2c20 7065 6262 6c65  ck.level, pebble
-00008a50: 2e43 6865 636b 4c65 7665 6c2e 5245 4144  .CheckLevel.READ
-00008a60: 5929 0a20 2020 2020 2020 2073 656c 662e  Y).        self.
-00008a70: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-00008a80: 6b2e 7374 6174 7573 2c20 7065 6262 6c65  k.status, pebble
-00008a90: 2e43 6865 636b 5374 6174 7573 2e55 5029  .CheckStatus.UP)
-00008aa0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008ab0: 7365 7274 4571 7561 6c28 6368 6563 6b2e  sertEqual(check.
-00008ac0: 6661 696c 7572 6573 2c20 3029 0a20 2020  failures, 0).   
-00008ad0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00008ae0: 4571 7561 6c28 6368 6563 6b2e 7468 7265  Equal(check.thre
-00008af0: 7368 6f6c 642c 2033 290a 0a20 2020 2020  shold, 3)..     
-00008b00: 2020 2063 6865 636b 203d 2070 6562 626c     check = pebbl
-00008b10: 652e 4368 6563 6b49 6e66 6f28 0a20 2020  e.CheckInfo(.   
-00008b20: 2020 2020 2020 2020 206e 616d 653d 2763           name='c
-00008b30: 686b 3227 2c0a 2020 2020 2020 2020 2020  hk2',.          
-00008b40: 2020 6c65 7665 6c3d 7065 6262 6c65 2e43    level=pebble.C
-00008b50: 6865 636b 4c65 7665 6c2e 414c 4956 452c  heckLevel.ALIVE,
-00008b60: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00008b70: 7475 733d 7065 6262 6c65 2e43 6865 636b  tus=pebble.Check
-00008b80: 5374 6174 7573 2e44 4f57 4e2c 0a20 2020  Status.DOWN,.   
-00008b90: 2020 2020 2020 2020 2066 6169 6c75 7265           failure
-00008ba0: 733d 352c 0a20 2020 2020 2020 2020 2020  s=5,.           
-00008bb0: 2074 6872 6573 686f 6c64 3d33 2c0a 2020   threshold=3,.  
-00008bc0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00008bd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00008be0: 2863 6865 636b 2e6e 616d 652c 2027 6368  (check.name, 'ch
-00008bf0: 6b32 2729 0a20 2020 2020 2020 2073 656c  k2').        sel
-00008c00: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-00008c10: 6563 6b2e 6c65 7665 6c2c 2070 6562 626c  eck.level, pebbl
-00008c20: 652e 4368 6563 6b4c 6576 656c 2e41 4c49  e.CheckLevel.ALI
-00008c30: 5645 290a 2020 2020 2020 2020 7365 6c66  VE).        self
-00008c40: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00008c50: 636b 2e73 7461 7475 732c 2070 6562 626c  ck.status, pebbl
-00008c60: 652e 4368 6563 6b53 7461 7475 732e 444f  e.CheckStatus.DO
-00008c70: 574e 290a 2020 2020 2020 2020 7365 6c66  WN).        self
-00008c80: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00008c90: 636b 2e66 6169 6c75 7265 732c 2035 290a  ck.failures, 5).
-00008ca0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008cb0: 6572 7445 7175 616c 2863 6865 636b 2e74  ertEqual(check.t
-00008cc0: 6872 6573 686f 6c64 2c20 3329 0a0a 2020  hreshold, 3)..  
-00008cd0: 2020 2020 2020 6368 6563 6b20 3d20 7065        check = pe
-00008ce0: 6262 6c65 2e43 6865 636b 496e 666f 2e66  bble.CheckInfo.f
-00008cf0: 726f 6d5f 6469 6374 287b 0a20 2020 2020  rom_dict({.     
-00008d00: 2020 2020 2020 2027 6e61 6d65 273a 2027         'name': '
-00008d10: 6368 6b33 272c 0a20 2020 2020 2020 2020  chk3',.         
-00008d20: 2020 2027 7374 6174 7573 273a 2027 7570     'status': 'up
-00008d30: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00008d40: 7468 7265 7368 6f6c 6427 3a20 332c 0a20  threshold': 3,. 
-00008d50: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
-00008d60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00008d70: 616c 2863 6865 636b 2e6e 616d 652c 2027  al(check.name, '
-00008d80: 6368 6b33 2729 0a20 2020 2020 2020 2073  chk3').        s
-00008d90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00008da0: 6368 6563 6b2e 6c65 7665 6c2c 2070 6562  check.level, peb
-00008db0: 626c 652e 4368 6563 6b4c 6576 656c 2e55  ble.CheckLevel.U
-00008dc0: 4e53 4554 290a 2020 2020 2020 2020 7365  NSET).        se
-00008dd0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00008de0: 6865 636b 2e73 7461 7475 732c 2070 6562  heck.status, peb
-00008df0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-00008e00: 5550 290a 2020 2020 2020 2020 7365 6c66  UP).        self
-00008e10: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00008e20: 636b 2e66 6169 6c75 7265 732c 2030 290a  ck.failures, 0).
-00008e30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008e40: 6572 7445 7175 616c 2863 6865 636b 2e74  ertEqual(check.t
-00008e50: 6872 6573 686f 6c64 2c20 3329 0a0a 2020  hreshold, 3)..  
-00008e60: 2020 2020 2020 6368 6563 6b20 3d20 7065        check = pe
-00008e70: 6262 6c65 2e43 6865 636b 496e 666f 2e66  bble.CheckInfo.f
-00008e80: 726f 6d5f 6469 6374 287b 0a20 2020 2020  rom_dict({.     
-00008e90: 2020 2020 2020 2027 6e61 6d65 273a 2027         'name': '
-00008ea0: 6368 6b34 272c 0a20 2020 2020 2020 2020  chk4',.         
-00008eb0: 2020 2027 6c65 7665 6c27 3a20 7065 6262     'level': pebb
-00008ec0: 6c65 2e43 6865 636b 4c65 7665 6c2e 554e  le.CheckLevel.UN
-00008ed0: 5345 542c 0a20 2020 2020 2020 2020 2020  SET,.           
-00008ee0: 2027 7374 6174 7573 273a 2070 6562 626c   'status': pebbl
-00008ef0: 652e 4368 6563 6b53 7461 7475 732e 444f  e.CheckStatus.DO
-00008f00: 574e 2c0a 2020 2020 2020 2020 2020 2020  WN,.            
-00008f10: 2766 6169 6c75 7265 7327 3a20 332c 0a20  'failures': 3,. 
-00008f20: 2020 2020 2020 2020 2020 2027 7468 7265             'thre
-00008f30: 7368 6f6c 6427 3a20 332c 0a20 2020 2020  shold': 3,.     
-00008f40: 2020 207d 290a 2020 2020 2020 2020 7365     }).        se
-00008f50: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00008f60: 6865 636b 2e6e 616d 652c 2027 6368 6b34  heck.name, 'chk4
-00008f70: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00008f80: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-00008f90: 6b2e 6c65 7665 6c2c 2070 6562 626c 652e  k.level, pebble.
-00008fa0: 4368 6563 6b4c 6576 656c 2e55 4e53 4554  CheckLevel.UNSET
-00008fb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00008fc0: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-00008fd0: 2e73 7461 7475 732c 2070 6562 626c 652e  .status, pebble.
-00008fe0: 4368 6563 6b53 7461 7475 732e 444f 574e  CheckStatus.DOWN
-00008ff0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00009000: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-00009010: 2e66 6169 6c75 7265 732c 2033 290a 2020  .failures, 3).  
-00009020: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00009030: 7445 7175 616c 2863 6865 636b 2e74 6872  tEqual(check.thr
-00009040: 6573 686f 6c64 2c20 3329 0a0a 0a63 6c61  eshold, 3)...cla
-00009050: 7373 204d 6f63 6b43 6c69 656e 7428 7065  ss MockClient(pe
-00009060: 6262 6c65 2e43 6c69 656e 7429 3a0a 2020  bble.Client):.  
-00009070: 2020 2222 224d 6f63 6b20 5065 6262 6c65    """Mock Pebble
-00009080: 2063 6c69 656e 7420 7468 6174 2073 696d   client that sim
-00009090: 706c 7920 7265 636f 7264 7320 7265 7175  ply records requ
-000090a0: 6573 7473 2061 6e64 2072 6574 7572 6e73  ests and returns
-000090b0: 2073 746f 7265 6420 7265 7370 6f6e 7365   stored response
-000090c0: 732e 2222 220a 0a20 2020 2064 6566 205f  s."""..    def _
-000090d0: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
-000090e0: 2020 2020 2020 2073 656c 662e 7265 7175         self.requ
-000090f0: 6573 7473 203d 205b 5d0a 2020 2020 2020  ests = [].      
-00009100: 2020 7365 6c66 2e72 6573 706f 6e73 6573    self.responses
-00009110: 203d 205b 5d0a 2020 2020 2020 2020 7365   = [].        se
-00009120: 6c66 2e74 696d 656f 7574 203d 2035 0a20  lf.timeout = 5. 
-00009130: 2020 2020 2020 2073 656c 662e 7765 6273         self.webs
-00009140: 6f63 6b65 7473 203d 207b 7d0a 0a20 2020  ockets = {}..   
-00009150: 2064 6566 205f 7265 7175 6573 7428 7365   def _request(se
-00009160: 6c66 2c20 6d65 7468 6f64 2c20 7061 7468  lf, method, path
-00009170: 2c20 7175 6572 793d 4e6f 6e65 2c20 626f  , query=None, bo
-00009180: 6479 3d4e 6f6e 6529 3a0a 2020 2020 2020  dy=None):.      
-00009190: 2020 7365 6c66 2e72 6571 7565 7374 732e    self.requests.
-000091a0: 6170 7065 6e64 2828 6d65 7468 6f64 2c20  append((method, 
-000091b0: 7061 7468 2c20 7175 6572 792c 2062 6f64  path, query, bod
-000091c0: 7929 290a 2020 2020 2020 2020 7265 7370  y)).        resp
-000091d0: 203d 2073 656c 662e 7265 7370 6f6e 7365   = self.response
-000091e0: 732e 706f 7028 3029 0a20 2020 2020 2020  s.pop(0).       
-000091f0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-00009200: 6573 702c 2045 7863 6570 7469 6f6e 293a  esp, Exception):
-00009210: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00009220: 7365 2072 6573 700a 2020 2020 2020 2020  se resp.        
-00009230: 6966 2063 616c 6c61 626c 6528 7265 7370  if callable(resp
-00009240: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00009250: 6573 7020 3d20 7265 7370 2829 0a20 2020  esp = resp().   
-00009260: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
-00009270: 0a0a 2020 2020 6465 6620 5f72 6571 7565  ..    def _reque
-00009280: 7374 5f72 6177 2873 656c 662c 206d 6574  st_raw(self, met
-00009290: 686f 642c 2070 6174 682c 2071 7565 7279  hod, path, query
-000092a0: 3d4e 6f6e 652c 2068 6561 6465 7273 3d4e  =None, headers=N
-000092b0: 6f6e 652c 2064 6174 613d 4e6f 6e65 293a  one, data=None):
-000092c0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-000092d0: 7175 6573 7473 2e61 7070 656e 6428 286d  quests.append((m
-000092e0: 6574 686f 642c 2070 6174 682c 2071 7565  ethod, path, que
-000092f0: 7279 2c20 6865 6164 6572 732c 2064 6174  ry, headers, dat
-00009300: 6129 290a 2020 2020 2020 2020 6865 6164  a)).        head
-00009310: 6572 732c 2062 6f64 7920 3d20 7365 6c66  ers, body = self
-00009320: 2e72 6573 706f 6e73 6573 2e70 6f70 2830  .responses.pop(0
-00009330: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00009340: 204d 6f63 6b48 5454 5052 6573 706f 6e73   MockHTTPRespons
-00009350: 6528 6865 6164 6572 732c 2062 6f64 7929  e(headers, body)
-00009360: 0a0a 2020 2020 6465 6620 5f63 6f6e 6e65  ..    def _conne
-00009370: 6374 5f77 6562 736f 636b 6574 2873 656c  ct_websocket(sel
-00009380: 662c 2074 6173 6b5f 6964 2c20 7765 6273  f, task_id, webs
-00009390: 6f63 6b65 745f 6964 293a 0a20 2020 2020  ocket_id):.     
-000093a0: 2020 2072 6574 7572 6e20 7365 6c66 2e77     return self.w
-000093b0: 6562 736f 636b 6574 735b 7461 736b 5f69  ebsockets[task_i
-000093c0: 642c 2077 6562 736f 636b 6574 5f69 645d  d, websocket_id]
-000093d0: 0a0a 0a63 6c61 7373 204d 6f63 6b48 5454  ...class MockHTT
-000093e0: 5052 6573 706f 6e73 653a 0a20 2020 2064  PResponse:.    d
-000093f0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00009400: 2c20 6865 6164 6572 732c 2062 6f64 7929  , headers, body)
-00009410: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
-00009420: 6561 6465 7273 203d 2068 6561 6465 7273  eaders = headers
-00009430: 0a20 2020 2020 2020 2072 6561 6465 7220  .        reader 
-00009440: 3d20 696f 2e42 7974 6573 494f 2862 6f64  = io.BytesIO(bod
-00009450: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
-00009460: 7265 6164 203d 2072 6561 6465 722e 7265  read = reader.re
-00009470: 6164 0a0a 0a63 6c61 7373 204d 6f63 6b54  ad...class MockT
-00009480: 696d 653a 0a20 2020 2022 2222 4d6f 636b  ime:.    """Mock
-00009490: 6564 2076 6572 7369 6f6e 7320 6f66 2074  ed versions of t
-000094a0: 696d 652e 7469 6d65 2829 2061 6e64 2074  ime.time() and t
-000094b0: 696d 652e 736c 6565 7028 292e 0a0a 2020  ime.sleep()...  
-000094c0: 2020 4d6f 636b 5469 6d65 2e73 6c65 6570    MockTime.sleep
-000094d0: 2829 2061 6476 616e 6365 7320 7468 6520  () advances the 
-000094e0: 636c 6f63 6b20 616e 6420 4d6f 636b 5469  clock and MockTi
-000094f0: 6d65 2e74 696d 6528 2920 7265 7475 726e  me.time() return
-00009500: 7320 7468 6520 6375 7272 656e 7420 7469  s the current ti
-00009510: 6d65 2e0a 2020 2020 2222 220a 0a20 2020  me..    """..   
-00009520: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00009530: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00009540: 662e 5f74 696d 6520 3d20 300a 0a20 2020  f._time = 0..   
-00009550: 2064 6566 2074 696d 6528 7365 6c66 293a   def time(self):
-00009560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00009570: 7365 6c66 2e5f 7469 6d65 0a0a 2020 2020  self._time..    
-00009580: 6465 6620 736c 6565 7028 7365 6c66 2c20  def sleep(self, 
-00009590: 6465 6c61 7929 3a0a 2020 2020 2020 2020  delay):.        
-000095a0: 7365 6c66 2e5f 7469 6d65 202b 3d20 6465  self._time += de
-000095b0: 6c61 790a 0a0a 6465 6620 6275 696c 645f  lay...def build_
-000095c0: 6d6f 636b 5f63 6861 6e67 655f 6469 6374  mock_change_dict
-000095d0: 2863 6861 6e67 655f 6964 3d27 3730 2729  (change_id='70')
-000095e0: 3a0a 2020 2020 7265 7475 726e 207b 0a20  :.    return {. 
-000095f0: 2020 2020 2020 2022 6964 223a 2063 6861         "id": cha
-00009600: 6e67 655f 6964 2c0a 2020 2020 2020 2020  nge_id,.        
-00009610: 226b 696e 6422 3a20 2261 7574 6f73 7461  "kind": "autosta
-00009620: 7274 222c 0a20 2020 2020 2020 2022 7265  rt",.        "re
-00009630: 6164 7922 3a20 5472 7565 2c0a 2020 2020  ady": True,.    
-00009640: 2020 2020 2272 6561 6479 2d74 696d 6522      "ready-time"
-00009650: 3a20 2232 3032 312d 3031 2d32 3854 3134  : "2021-01-28T14
-00009660: 3a33 373a 3034 2e32 3931 3531 3737 3638  :37:04.291517768
-00009670: 2b31 333a 3030 222c 0a20 2020 2020 2020  +13:00",.       
-00009680: 2022 7370 6177 6e2d 7469 6d65 223a 2022   "spawn-time": "
-00009690: 3230 3231 2d30 312d 3238 5431 343a 3337  2021-01-28T14:37
-000096a0: 3a30 322e 3234 3732 3032 3130 352b 3133  :02.247202105+13
-000096b0: 3a30 3022 2c0a 2020 2020 2020 2020 2273  :00",.        "s
-000096c0: 7461 7475 7322 3a20 2244 6f6e 6522 2c0a  tatus": "Done",.
-000096d0: 2020 2020 2020 2020 2273 756d 6d61 7279          "summary
-000096e0: 223a 2027 4175 746f 7374 6172 7420 7365  ": 'Autostart se
-000096f0: 7276 6963 6520 2273 7663 2227 2c0a 2020  rvice "svc"',.  
-00009700: 2020 2020 2020 2274 6173 6b73 223a 205b        "tasks": [
-00009710: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00009720: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00009730: 6964 223a 2022 3738 222c 0a20 2020 2020  id": "78",.     
-00009740: 2020 2020 2020 2020 2020 2022 6b69 6e64             "kind
-00009750: 223a 2022 7374 6172 7422 2c0a 2020 2020  ": "start",.    
-00009760: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
-00009770: 6772 6573 7322 3a20 7b0a 2020 2020 2020  gress": {.      
-00009780: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-00009790: 6f6e 6522 3a20 312c 0a20 2020 2020 2020  one": 1,.       
-000097a0: 2020 2020 2020 2020 2020 2020 2022 6c61               "la
-000097b0: 6265 6c22 3a20 2222 2c0a 2020 2020 2020  bel": "",.      
-000097c0: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-000097d0: 6f74 616c 223a 2031 2c0a 2020 2020 2020  otal": 1,.      
-000097e0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-000097f0: 7874 7261 2d66 6965 6c64 223a 2022 666f  xtra-field": "fo
-00009800: 6f22 2c0a 2020 2020 2020 2020 2020 2020  o",.            
-00009810: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00009820: 2020 2020 2020 2022 7265 6164 792d 7469         "ready-ti
-00009830: 6d65 223a 2022 3230 3231 2d30 312d 3238  me": "2021-01-28
-00009840: 5431 343a 3337 3a30 332e 3237 3032 3138  T14:37:03.270218
-00009850: 3737 382b 3133 3a30 3022 2c0a 2020 2020  778+13:00",.    
-00009860: 2020 2020 2020 2020 2020 2020 2273 7061              "spa
-00009870: 776e 2d74 696d 6522 3a20 2232 3032 312d  wn-time": "2021-
-00009880: 3031 2d32 3854 3134 3a33 373a 3032 2e32  01-28T14:37:02.2
-00009890: 3437 3135 3831 3632 2b31 333a 3030 222c  47158162+13:00",
-000098a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000098b0: 2022 7374 6174 7573 223a 2022 446f 6e65   "status": "Done
-000098c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000098d0: 2020 2022 7375 6d6d 6172 7922 3a20 2753     "summary": 'S
-000098e0: 7461 7274 2073 6572 7669 6365 2022 7376  tart service "sv
-000098f0: 6322 272c 0a20 2020 2020 2020 2020 2020  c"',.           
-00009900: 2020 2020 2022 6578 7472 612d 6669 656c       "extra-fiel
-00009910: 6422 3a20 2266 6f6f 222c 0a20 2020 2020  d": "foo",.     
-00009920: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00009930: 2020 5d2c 0a20 2020 2020 2020 2022 6578    ],.        "ex
-00009940: 7472 612d 6669 656c 6422 3a20 2266 6f6f  tra-field": "foo
-00009950: 222c 0a20 2020 207d 0a0a 0a63 6c61 7373  ",.    }...class
-00009960: 2054 6573 744d 756c 7469 7061 7274 5061   TestMultipartPa
-00009970: 7273 6572 2875 6e69 7474 6573 742e 5465  rser(unittest.Te
-00009980: 7374 4361 7365 293a 0a20 2020 2063 6c61  stCase):.    cla
-00009990: 7373 205f 4361 7365 3a0a 2020 2020 2020  ss _Case:.      
-000099a0: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
-000099b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099c0: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-000099d0: 2020 2020 2020 6e61 6d65 2c0a 2020 2020        name,.    
-000099e0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000099f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009a00: 2020 7761 6e74 5f68 6561 6465 7273 2c0a    want_headers,.
-00009a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a20: 7761 6e74 5f62 6f64 6965 732c 0a20 2020  want_bodies,.   
-00009a30: 2020 2020 2020 2020 2020 2020 2077 616e               wan
-00009a40: 745f 626f 6469 6573 5f64 6f6e 652c 0a20  t_bodies_done,. 
-00009a50: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00009a60: 6178 5f62 6f75 6e64 6172 793d 3134 2c0a  ax_boundary=14,.
+000058a0: 2020 2020 7b27 454e 5631 273a 2027 7661      {'ENV1': 'va
+000058b0: 6c75 6531 272c 2027 454e 5632 273a 2027  lue1', 'ENV2': '
+000058c0: 7661 6c75 6532 277d 290a 2020 2020 2020  value2'}).      
+000058d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000058e0: 616c 2873 2e73 6572 7669 6365 735b 2762  al(s.services['b
+000058f0: 6172 275d 2e75 7365 722c 2027 626f 6227  ar'].user, 'bob'
+00005900: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00005910: 7373 6572 7445 7175 616c 2873 2e73 6572  ssertEqual(s.ser
+00005920: 7669 6365 735b 2762 6172 275d 2e75 7365  vices['bar'].use
+00005930: 725f 6964 2c20 3130 3030 290a 2020 2020  r_id, 1000).    
+00005940: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00005950: 7175 616c 2873 2e73 6572 7669 6365 735b  qual(s.services[
+00005960: 2762 6172 275d 2e67 726f 7570 2c20 2773  'bar'].group, 's
+00005970: 7461 6666 2729 0a20 2020 2020 2020 2073  taff').        s
+00005980: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00005990: 732e 7365 7276 6963 6573 5b27 6261 7227  s.services['bar'
+000059a0: 5d2e 6772 6f75 705f 6964 2c20 3230 3030  ].group_id, 2000
+000059b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000059c0: 6173 7365 7274 4571 7561 6c28 732e 6368  assertEqual(s.ch
+000059d0: 6563 6b73 5b27 6368 6b27 5d2e 6e61 6d65  ecks['chk'].name
+000059e0: 2c20 2763 686b 2729 0a20 2020 2020 2020  , 'chk').       
+000059f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00005a00: 6c28 732e 6368 6563 6b73 5b27 6368 6b27  l(s.checks['chk'
+00005a10: 5d2e 6874 7470 2c20 7b27 7572 6c27 3a20  ].http, {'url': 
+00005a20: 2768 7474 7073 3a2f 2f65 7861 6d70 6c65  'https://example
+00005a30: 2e63 6f6d 2f27 7d29 0a0a 2020 2020 2020  .com/'})..      
+00005a40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00005a50: 616c 2873 2e74 6f5f 7961 6d6c 2829 2c20  al(s.to_yaml(), 
+00005a60: 7961 6d6c 290a 2020 2020 2020 2020 7365  yaml).        se
+00005a70: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00005a80: 7472 2873 292c 2079 616d 6c29 0a0a 2020  tr(s), yaml)..  
+00005a90: 2020 6465 6620 7465 7374 5f6c 6179 6572    def test_layer
+00005aa0: 5f73 6572 7669 6365 5f65 7175 616c 6974  _service_equalit
+00005ab0: 7928 7365 6c66 293a 0a20 2020 2020 2020  y(self):.       
+00005ac0: 2073 203d 2070 6562 626c 652e 4c61 7965   s = pebble.Laye
+00005ad0: 7228 7b7d 290a 2020 2020 2020 2020 7365  r({}).        se
+00005ae0: 6c66 2e5f 6173 7365 7274 5f65 6d70 7479  lf._assert_empty
+00005af0: 2873 290a 0a20 2020 2020 2020 2064 203d  (s)..        d =
+00005b00: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00005b10: 7375 6d6d 6172 7927 3a20 2753 756d 204d  summary': 'Sum M
+00005b20: 6172 7927 2c0a 2020 2020 2020 2020 2020  ary',.          
+00005b30: 2020 2764 6573 6372 6970 7469 6f6e 273a    'description':
+00005b40: 2027 5468 6520 7175 6963 6b20 6272 6f77   'The quick brow
+00005b50: 6e20 666f 7821 272c 0a20 2020 2020 2020  n fox!',.       
+00005b60: 2020 2020 2027 7365 7276 6963 6573 273a       'services':
+00005b70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00005b80: 2020 2027 666f 6f27 3a20 7b0a 2020 2020     'foo': {.    
+00005b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ba0: 2773 756d 6d61 7279 273a 2027 466f 6f27  'summary': 'Foo'
+00005bb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00005bc0: 2020 2020 2020 2763 6f6d 6d61 6e64 273a        'command':
+00005bd0: 2027 6563 686f 2066 6f6f 272c 0a20 2020   'echo foo',.   
+00005be0: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00005bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c00: 2762 6172 273a 207b 0a20 2020 2020 2020  'bar': {.       
+00005c10: 2020 2020 2020 2020 2020 2020 2027 7375               'su
+00005c20: 6d6d 6172 7927 3a20 2742 6172 272c 0a20  mmary': 'Bar',. 
+00005c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c40: 2020 2027 636f 6d6d 616e 6427 3a20 2765     'command': 'e
+00005c50: 6368 6f20 6261 7227 2c0a 2020 2020 2020  cho bar',.      
+00005c60: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00005c70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00005c80: 2020 207d 0a20 2020 2020 2020 2073 203d     }.        s =
+00005c90: 2070 6562 626c 652e 4c61 7965 7228 6429   pebble.Layer(d)
+00005ca0: 0a20 2020 2020 2020 2074 203d 2070 6562  .        t = peb
+00005cb0: 626c 652e 4c61 7965 7228 6429 0a0a 2020  ble.Layer(d)..  
+00005cc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00005cd0: 7445 7175 616c 2873 2e73 6572 7669 6365  tEqual(s.service
+00005ce0: 732c 2074 2e73 6572 7669 6365 7329 0a0a  s, t.services)..
+00005cf0: 2020 2020 6465 6620 7465 7374 5f6c 6179      def test_lay
+00005d00: 6572 5f65 7175 616c 6974 7928 7365 6c66  er_equality(self
+00005d10: 293a 0a20 2020 2020 2020 2073 203d 2070  ):.        s = p
+00005d20: 6562 626c 652e 4c61 7965 7228 7b7d 290a  ebble.Layer({}).
+00005d30: 2020 2020 2020 2020 7365 6c66 2e5f 6173          self._as
+00005d40: 7365 7274 5f65 6d70 7479 2873 290a 0a20  sert_empty(s).. 
+00005d50: 2020 2020 2020 2064 203d 207b 0a20 2020         d = {.   
+00005d60: 2020 2020 2020 2020 2027 7375 6d6d 6172           'summar
+00005d70: 7927 3a20 2753 756d 204d 6172 7927 2c0a  y': 'Sum Mary',.
+00005d80: 2020 2020 2020 2020 2020 2020 2764 6573              'des
+00005d90: 6372 6970 7469 6f6e 273a 2027 5468 6520  cription': 'The 
+00005da0: 7175 6963 6b20 6272 6f77 6e20 666f 7821  quick brown fox!
+00005db0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00005dc0: 7365 7276 6963 6573 273a 207b 0a20 2020  services': {.   
+00005dd0: 2020 2020 2020 2020 2020 2020 2027 666f               'fo
+00005de0: 6f27 3a20 7b0a 2020 2020 2020 2020 2020  o': {.          
+00005df0: 2020 2020 2020 2020 2020 2773 756d 6d61            'summa
+00005e00: 7279 273a 2027 466f 6f27 2c0a 2020 2020  ry': 'Foo',.    
+00005e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e20: 2763 6f6d 6d61 6e64 273a 2027 6563 686f  'command': 'echo
+00005e30: 2066 6f6f 272c 0a20 2020 2020 2020 2020   foo',.         
+00005e40: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00005e50: 2020 2020 2020 2020 2020 2762 6172 273a            'bar':
+00005e60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00005e70: 2020 2020 2020 2027 7375 6d6d 6172 7927         'summary'
+00005e80: 3a20 2742 6172 272c 0a20 2020 2020 2020  : 'Bar',.       
+00005e90: 2020 2020 2020 2020 2020 2020 2027 636f               'co
+00005ea0: 6d6d 616e 6427 3a20 2765 6368 6f20 6261  mmand': 'echo ba
+00005eb0: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
+00005ec0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00005ed0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
+00005ee0: 2020 2020 2020 2074 203d 2070 6562 626c         t = pebbl
+00005ef0: 652e 4c61 7965 7228 6429 0a20 2020 2020  e.Layer(d).     
+00005f00: 2020 2073 656c 662e 6173 7365 7274 4e6f     self.assertNo
+00005f10: 7445 7175 616c 2873 2c20 7429 0a20 2020  tEqual(s, t).   
+00005f20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00005f30: 4e6f 7445 7175 616c 2874 2c20 7b7d 290a  NotEqual(t, {}).
+00005f40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00005f50: 6572 7445 7175 616c 2874 2c20 6429 0a0a  ertEqual(t, d)..
+00005f60: 2020 2020 2020 2020 7320 3d20 7065 6262          s = pebb
+00005f70: 6c65 2e4c 6179 6572 2864 290a 2020 2020  le.Layer(d).    
+00005f80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00005f90: 7175 616c 2873 2c20 7429 0a20 2020 2020  qual(s, t).     
+00005fa0: 2020 2073 656c 662e 6173 7365 7274 4e6f     self.assertNo
+00005fb0: 7445 7175 616c 2873 2c20 7b7d 290a 2020  tEqual(s, {}).  
+00005fc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00005fd0: 7445 7175 616c 2873 2c20 6429 0a0a 2020  tEqual(s, d)..  
+00005fe0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00005ff0: 744e 6f74 4571 7561 6c28 732c 2035 290a  tNotEqual(s, 5).
+00006000: 0a0a 636c 6173 7320 5465 7374 5365 7276  ..class TestServ
+00006010: 6963 6528 756e 6974 7465 7374 2e54 6573  ice(unittest.Tes
+00006020: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
+00006030: 5f61 7373 6572 745f 656d 7074 7928 7365  _assert_empty(se
+00006040: 6c66 2c20 7365 7276 6963 652c 206e 616d  lf, service, nam
+00006050: 6529 3a0a 2020 2020 2020 2020 7365 6c66  e):.        self
+00006060: 2e61 7373 6572 7445 7175 616c 2873 6572  .assertEqual(ser
+00006070: 7669 6365 2e6e 616d 652c 206e 616d 6529  vice.name, name)
+00006080: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00006090: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
+000060a0: 652e 7375 6d6d 6172 792c 2027 2729 0a20  e.summary, ''). 
+000060b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000060c0: 7274 4571 7561 6c28 7365 7276 6963 652e  rtEqual(service.
+000060d0: 6465 7363 7269 7074 696f 6e2c 2027 2729  description, '')
+000060e0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000060f0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
+00006100: 652e 7374 6172 7475 702c 2027 2729 0a20  e.startup, ''). 
+00006110: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00006120: 7274 4571 7561 6c28 7365 7276 6963 652e  rtEqual(service.
+00006130: 6f76 6572 7269 6465 2c20 2727 290a 2020  override, '').  
+00006140: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006150: 7445 7175 616c 2873 6572 7669 6365 2e63  tEqual(service.c
+00006160: 6f6d 6d61 6e64 2c20 2727 290a 2020 2020  ommand, '').    
+00006170: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00006180: 7175 616c 2873 6572 7669 6365 2e61 6674  qual(service.aft
+00006190: 6572 2c20 5b5d 290a 2020 2020 2020 2020  er, []).        
+000061a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000061b0: 2873 6572 7669 6365 2e62 6566 6f72 652c  (service.before,
+000061c0: 205b 5d29 0a20 2020 2020 2020 2073 656c   []).        sel
+000061d0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+000061e0: 7276 6963 652e 7265 7175 6972 6573 2c20  rvice.requires, 
+000061f0: 5b5d 290a 2020 2020 2020 2020 7365 6c66  []).        self
+00006200: 2e61 7373 6572 7445 7175 616c 2873 6572  .assertEqual(ser
+00006210: 7669 6365 2e65 6e76 6972 6f6e 6d65 6e74  vice.environment
+00006220: 2c20 7b7d 290a 2020 2020 2020 2020 7365  , {}).        se
+00006230: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00006240: 6572 7669 6365 2e75 7365 722c 2027 2729  ervice.user, '')
+00006250: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00006260: 7365 7274 4973 2873 6572 7669 6365 2e75  sertIs(service.u
+00006270: 7365 725f 6964 2c20 4e6f 6e65 290a 2020  ser_id, None).  
+00006280: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006290: 7445 7175 616c 2873 6572 7669 6365 2e67  tEqual(service.g
+000062a0: 726f 7570 2c20 2727 290a 2020 2020 2020  roup, '').      
+000062b0: 2020 7365 6c66 2e61 7373 6572 7449 7328    self.assertIs(
+000062c0: 7365 7276 6963 652e 6772 6f75 705f 6964  service.group_id
+000062d0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+000062e0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000062f0: 2873 6572 7669 6365 2e6f 6e5f 7375 6363  (service.on_succ
+00006300: 6573 732c 2027 2729 0a20 2020 2020 2020  ess, '').       
+00006310: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00006320: 6c28 7365 7276 6963 652e 6f6e 5f66 6169  l(service.on_fai
+00006330: 6c75 7265 2c20 2727 290a 2020 2020 2020  lure, '').      
+00006340: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00006350: 616c 2873 6572 7669 6365 2e6f 6e5f 6368  al(service.on_ch
+00006360: 6563 6b5f 6661 696c 7572 652c 207b 7d29  eck_failure, {})
+00006370: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00006380: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
+00006390: 652e 6261 636b 6f66 665f 6465 6c61 792c  e.backoff_delay,
+000063a0: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
+000063b0: 662e 6173 7365 7274 4973 2873 6572 7669  f.assertIs(servi
+000063c0: 6365 2e62 6163 6b6f 6666 5f66 6163 746f  ce.backoff_facto
+000063d0: 722c 204e 6f6e 6529 0a20 2020 2020 2020  r, None).       
+000063e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000063f0: 6c28 7365 7276 6963 652e 6261 636b 6f66  l(service.backof
+00006400: 665f 6c69 6d69 742c 2027 2729 0a20 2020  f_limit, '').   
+00006410: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00006420: 4571 7561 6c28 7365 7276 6963 652e 746f  Equal(service.to
+00006430: 5f64 6963 7428 292c 207b 7d29 0a0a 2020  _dict(), {})..  
+00006440: 2020 6465 6620 7465 7374 5f6e 616d 655f    def test_name_
+00006450: 6f6e 6c79 2873 656c 6629 3a0a 2020 2020  only(self):.    
+00006460: 2020 2020 7320 3d20 7065 6262 6c65 2e53      s = pebble.S
+00006470: 6572 7669 6365 2827 4e61 6d65 2030 2729  ervice('Name 0')
+00006480: 0a20 2020 2020 2020 2073 656c 662e 5f61  .        self._a
+00006490: 7373 6572 745f 656d 7074 7928 732c 2027  ssert_empty(s, '
+000064a0: 4e61 6d65 2030 2729 0a0a 2020 2020 6465  Name 0')..    de
+000064b0: 6620 7465 7374 5f64 6963 7428 7365 6c66  f test_dict(self
+000064c0: 293a 0a20 2020 2020 2020 2073 203d 2070  ):.        s = p
+000064d0: 6562 626c 652e 5365 7276 6963 6528 274e  ebble.Service('N
+000064e0: 616d 6520 3127 2c20 7b7d 290a 2020 2020  ame 1', {}).    
+000064f0: 2020 2020 7365 6c66 2e5f 6173 7365 7274      self._assert
+00006500: 5f65 6d70 7479 2873 2c20 274e 616d 6520  _empty(s, 'Name 
+00006510: 3127 290a 0a20 2020 2020 2020 2064 203d  1')..        d =
+00006520: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00006530: 7375 6d6d 6172 7927 3a20 2753 756d 204d  summary': 'Sum M
+00006540: 6172 7927 2c0a 2020 2020 2020 2020 2020  ary',.          
+00006550: 2020 2764 6573 6372 6970 7469 6f6e 273a    'description':
+00006560: 2027 5468 6520 6c61 7a79 2071 7569 636b   'The lazy quick
+00006570: 2062 726f 776e 272c 0a20 2020 2020 2020   brown',.       
+00006580: 2020 2020 2027 7374 6172 7475 7027 3a20       'startup': 
+00006590: 2753 7461 7274 2055 7027 2c0a 2020 2020  'Start Up',.    
+000065a0: 2020 2020 2020 2020 276f 7665 7272 6964          'overrid
+000065b0: 6527 3a20 276f 7665 7272 6964 6527 2c0a  e': 'override',.
+000065c0: 2020 2020 2020 2020 2020 2020 2763 6f6d              'com
+000065d0: 6d61 6e64 273a 2027 6563 686f 2073 756d  mand': 'echo sum
+000065e0: 206d 6172 7927 2c0a 2020 2020 2020 2020   mary',.        
+000065f0: 2020 2020 2761 6674 6572 273a 205b 2761      'after': ['a
+00006600: 3127 2c20 2761 3227 5d2c 0a20 2020 2020  1', 'a2'],.     
+00006610: 2020 2020 2020 2027 6265 666f 7265 273a         'before':
+00006620: 205b 2762 3127 2c20 2762 3227 5d2c 0a20   ['b1', 'b2'],. 
+00006630: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
+00006640: 6972 6573 273a 205b 2772 3127 2c20 2772  ires': ['r1', 'r
+00006650: 3227 5d2c 0a20 2020 2020 2020 2020 2020  2'],.           
+00006660: 2027 656e 7669 726f 6e6d 656e 7427 3a20   'environment': 
+00006670: 7b27 6b31 273a 2027 7631 272c 2027 6b32  {'k1': 'v1', 'k2
+00006680: 273a 2027 7632 277d 2c0a 2020 2020 2020  ': 'v2'},.      
+00006690: 2020 2020 2020 2775 7365 7227 3a20 2762        'user': 'b
+000066a0: 6f62 272c 0a20 2020 2020 2020 2020 2020  ob',.           
+000066b0: 2027 7573 6572 2d69 6427 3a20 3130 3030   'user-id': 1000
+000066c0: 2c0a 2020 2020 2020 2020 2020 2020 2767  ,.            'g
+000066d0: 726f 7570 273a 2027 7374 6166 6627 2c0a  roup': 'staff',.
+000066e0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
+000066f0: 7570 2d69 6427 3a20 3230 3030 2c0a 2020  up-id': 2000,.  
+00006700: 2020 2020 2020 2020 2020 276f 6e2d 7375            'on-su
+00006710: 6363 6573 7327 3a20 2772 6573 7461 7274  ccess': 'restart
+00006720: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00006730: 6f6e 2d66 6169 6c75 7265 273a 2027 6967  on-failure': 'ig
+00006740: 6e6f 7265 272c 0a20 2020 2020 2020 2020  nore',.         
+00006750: 2020 2027 6f6e 2d63 6865 636b 2d66 6169     'on-check-fai
+00006760: 6c75 7265 273a 207b 2763 686b 3127 3a20  lure': {'chk1': 
+00006770: 2768 616c 7427 7d2c 0a20 2020 2020 2020  'halt'},.       
+00006780: 2020 2020 2027 6261 636b 6f66 662d 6465       'backoff-de
+00006790: 6c61 7927 3a20 2731 7327 2c0a 2020 2020  lay': '1s',.    
+000067a0: 2020 2020 2020 2020 2762 6163 6b6f 6666          'backoff
+000067b0: 2d66 6163 746f 7227 3a20 342c 0a20 2020  -factor': 4,.   
+000067c0: 2020 2020 2020 2020 2027 6261 636b 6f66           'backof
+000067d0: 662d 6c69 6d69 7427 3a20 2731 3073 272c  f-limit': '10s',
+000067e0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+000067f0: 2020 2073 203d 2070 6562 626c 652e 5365     s = pebble.Se
+00006800: 7276 6963 6528 274e 616d 6520 3227 2c20  rvice('Name 2', 
+00006810: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+00006820: 6173 7365 7274 4571 7561 6c28 732e 6e61  assertEqual(s.na
+00006830: 6d65 2c20 274e 616d 6520 3227 290a 2020  me, 'Name 2').  
+00006840: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006850: 7445 7175 616c 2873 2e64 6573 6372 6970  tEqual(s.descrip
+00006860: 7469 6f6e 2c20 2754 6865 206c 617a 7920  tion, 'The lazy 
+00006870: 7175 6963 6b20 6272 6f77 6e27 290a 2020  quick brown').  
+00006880: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006890: 7445 7175 616c 2873 2e73 7461 7274 7570  tEqual(s.startup
+000068a0: 2c20 2753 7461 7274 2055 7027 290a 2020  , 'Start Up').  
+000068b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000068c0: 7445 7175 616c 2873 2e6f 7665 7272 6964  tEqual(s.overrid
+000068d0: 652c 2027 6f76 6572 7269 6465 2729 0a20  e, 'override'). 
+000068e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000068f0: 7274 4571 7561 6c28 732e 636f 6d6d 616e  rtEqual(s.comman
+00006900: 642c 2027 6563 686f 2073 756d 206d 6172  d, 'echo sum mar
+00006910: 7927 290a 2020 2020 2020 2020 7365 6c66  y').        self
+00006920: 2e61 7373 6572 7445 7175 616c 2873 2e61  .assertEqual(s.a
+00006930: 6674 6572 2c20 5b27 6131 272c 2027 6132  fter, ['a1', 'a2
+00006940: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
+00006950: 2e61 7373 6572 7445 7175 616c 2873 2e62  .assertEqual(s.b
+00006960: 6566 6f72 652c 205b 2762 3127 2c20 2762  efore, ['b1', 'b
+00006970: 3227 5d29 0a20 2020 2020 2020 2073 656c  2']).        sel
+00006980: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
+00006990: 7265 7175 6972 6573 2c20 5b27 7231 272c  requires, ['r1',
+000069a0: 2027 7232 275d 290a 2020 2020 2020 2020   'r2']).        
+000069b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000069c0: 2873 2e65 6e76 6972 6f6e 6d65 6e74 2c20  (s.environment, 
+000069d0: 7b27 6b31 273a 2027 7631 272c 2027 6b32  {'k1': 'v1', 'k2
+000069e0: 273a 2027 7632 277d 290a 2020 2020 2020  ': 'v2'}).      
+000069f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00006a00: 616c 2873 2e75 7365 722c 2027 626f 6227  al(s.user, 'bob'
+00006a10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006a20: 7373 6572 7445 7175 616c 2873 2e75 7365  ssertEqual(s.use
+00006a30: 725f 6964 2c20 3130 3030 290a 2020 2020  r_id, 1000).    
+00006a40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00006a50: 7175 616c 2873 2e67 726f 7570 2c20 2773  qual(s.group, 's
+00006a60: 7461 6666 2729 0a20 2020 2020 2020 2073  taff').        s
+00006a70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006a80: 732e 6772 6f75 705f 6964 2c20 3230 3030  s.group_id, 2000
+00006a90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006aa0: 7373 6572 7445 7175 616c 2873 2e6f 6e5f  ssertEqual(s.on_
+00006ab0: 7375 6363 6573 732c 2027 7265 7374 6172  success, 'restar
+00006ac0: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
+00006ad0: 2e61 7373 6572 7445 7175 616c 2873 2e6f  .assertEqual(s.o
+00006ae0: 6e5f 6661 696c 7572 652c 2027 6967 6e6f  n_failure, 'igno
+00006af0: 7265 2729 0a20 2020 2020 2020 2073 656c  re').        sel
+00006b00: 662e 6173 7365 7274 4571 7561 6c28 732e  f.assertEqual(s.
+00006b10: 6f6e 5f63 6865 636b 5f66 6169 6c75 7265  on_check_failure
+00006b20: 2c20 7b27 6368 6b31 273a 2027 6861 6c74  , {'chk1': 'halt
+00006b30: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
+00006b40: 2e61 7373 6572 7445 7175 616c 2873 2e62  .assertEqual(s.b
+00006b50: 6163 6b6f 6666 5f64 656c 6179 2c20 2731  ackoff_delay, '1
+00006b60: 7327 290a 2020 2020 2020 2020 7365 6c66  s').        self
+00006b70: 2e61 7373 6572 7445 7175 616c 2873 2e62  .assertEqual(s.b
+00006b80: 6163 6b6f 6666 5f66 6163 746f 722c 2034  ackoff_factor, 4
+00006b90: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00006ba0: 7373 6572 7445 7175 616c 2873 2e62 6163  ssertEqual(s.bac
+00006bb0: 6b6f 6666 5f6c 696d 6974 2c20 2731 3073  koff_limit, '10s
+00006bc0: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+00006bd0: 2e61 7373 6572 7445 7175 616c 2873 2e74  .assertEqual(s.t
+00006be0: 6f5f 6469 6374 2829 2c20 6429 0a0a 2020  o_dict(), d)..  
+00006bf0: 2020 2020 2020 2320 456e 7375 7265 2070        # Ensure p
+00006c00: 6562 626c 652e 5365 7276 6963 6520 6861  ebble.Service ha
+00006c10: 7320 6d61 6465 2063 6f70 6965 7320 6f66  s made copies of
+00006c20: 206d 7574 6162 6c65 206f 626a 6563 7473   mutable objects
+00006c30: 0a20 2020 2020 2020 2073 2e61 6674 6572  .        s.after
+00006c40: 2e61 7070 656e 6428 2761 3327 290a 2020  .append('a3').  
+00006c50: 2020 2020 2020 732e 6265 666f 7265 2e61        s.before.a
+00006c60: 7070 656e 6428 2762 3327 290a 2020 2020  ppend('b3').    
+00006c70: 2020 2020 732e 7265 7175 6972 6573 2e61      s.requires.a
+00006c80: 7070 656e 6428 2772 3327 290a 2020 2020  ppend('r3').    
+00006c90: 2020 2020 732e 656e 7669 726f 6e6d 656e      s.environmen
+00006ca0: 745b 276b 3327 5d20 3d20 2776 3327 0a20  t['k3'] = 'v3'. 
+00006cb0: 2020 2020 2020 2073 2e6f 6e5f 6368 6563         s.on_chec
+00006cc0: 6b5f 6661 696c 7572 655b 2763 686b 3227  k_failure['chk2'
+00006cd0: 5d20 3d20 2769 676e 6f72 6527 0a20 2020  ] = 'ignore'.   
+00006ce0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00006cf0: 4571 7561 6c28 732e 6166 7465 722c 205b  Equal(s.after, [
+00006d00: 2761 3127 2c20 2761 3227 2c20 2761 3327  'a1', 'a2', 'a3'
+00006d10: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00006d20: 6173 7365 7274 4571 7561 6c28 732e 6265  assertEqual(s.be
+00006d30: 666f 7265 2c20 5b27 6231 272c 2027 6232  fore, ['b1', 'b2
+00006d40: 272c 2027 6233 275d 290a 2020 2020 2020  ', 'b3']).      
+00006d50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00006d60: 616c 2873 2e72 6571 7569 7265 732c 205b  al(s.requires, [
+00006d70: 2772 3127 2c20 2772 3227 2c20 2772 3327  'r1', 'r2', 'r3'
+00006d80: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00006d90: 6173 7365 7274 4571 7561 6c28 732e 656e  assertEqual(s.en
+00006da0: 7669 726f 6e6d 656e 742c 207b 276b 3127  vironment, {'k1'
+00006db0: 3a20 2776 3127 2c20 276b 3227 3a20 2776  : 'v1', 'k2': 'v
+00006dc0: 3227 2c20 276b 3327 3a20 2776 3327 7d29  2', 'k3': 'v3'})
+00006dd0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00006de0: 7365 7274 4571 7561 6c28 645b 2761 6674  sertEqual(d['aft
+00006df0: 6572 275d 2c20 5b27 6131 272c 2027 6132  er'], ['a1', 'a2
+00006e00: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
+00006e10: 2e61 7373 6572 7445 7175 616c 2864 5b27  .assertEqual(d['
+00006e20: 6265 666f 7265 275d 2c20 5b27 6231 272c  before'], ['b1',
+00006e30: 2027 6232 275d 290a 2020 2020 2020 2020   'b2']).        
+00006e40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00006e50: 2864 5b27 7265 7175 6972 6573 275d 2c20  (d['requires'], 
+00006e60: 5b27 7231 272c 2027 7232 275d 290a 2020  ['r1', 'r2']).  
+00006e70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006e80: 7445 7175 616c 2864 5b27 656e 7669 726f  tEqual(d['enviro
+00006e90: 6e6d 656e 7427 5d2c 207b 276b 3127 3a20  nment'], {'k1': 
+00006ea0: 2776 3127 2c20 276b 3227 3a20 2776 3227  'v1', 'k2': 'v2'
+00006eb0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+00006ec0: 6173 7365 7274 4571 7561 6c28 645b 276f  assertEqual(d['o
+00006ed0: 6e2d 6368 6563 6b2d 6661 696c 7572 6527  n-check-failure'
+00006ee0: 5d2c 207b 2763 686b 3127 3a20 2768 616c  ], {'chk1': 'hal
+00006ef0: 7427 7d29 0a0a 2020 2020 6465 6620 7465  t'})..    def te
+00006f00: 7374 5f65 7175 616c 6974 7928 7365 6c66  st_equality(self
+00006f10: 293a 0a20 2020 2020 2020 2064 203d 207b  ):.        d = {
+00006f20: 0a20 2020 2020 2020 2020 2020 2027 7375  .            'su
+00006f30: 6d6d 6172 7927 3a20 2753 756d 204d 6172  mmary': 'Sum Mar
+00006f40: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00006f50: 2764 6573 6372 6970 7469 6f6e 273a 2027  'description': '
+00006f60: 5468 6520 6c61 7a79 2071 7569 636b 2062  The lazy quick b
+00006f70: 726f 776e 272c 0a20 2020 2020 2020 2020  rown',.         
+00006f80: 2020 2027 7374 6172 7475 7027 3a20 2753     'startup': 'S
+00006f90: 7461 7274 2055 7027 2c0a 2020 2020 2020  tart Up',.      
+00006fa0: 2020 2020 2020 276f 7665 7272 6964 6527        'override'
+00006fb0: 3a20 276f 7665 7272 6964 6527 2c0a 2020  : 'override',.  
+00006fc0: 2020 2020 2020 2020 2020 2763 6f6d 6d61            'comma
+00006fd0: 6e64 273a 2027 6563 686f 2073 756d 206d  nd': 'echo sum m
+00006fe0: 6172 7927 2c0a 2020 2020 2020 2020 2020  ary',.          
+00006ff0: 2020 2761 6674 6572 273a 205b 2761 3127    'after': ['a1'
+00007000: 2c20 2761 3227 5d2c 0a20 2020 2020 2020  , 'a2'],.       
+00007010: 2020 2020 2027 6265 666f 7265 273a 205b       'before': [
+00007020: 2762 3127 2c20 2762 3227 5d2c 0a20 2020  'b1', 'b2'],.   
+00007030: 2020 2020 2020 2020 2027 7265 7175 6972           'requir
+00007040: 6573 273a 205b 2772 3127 2c20 2772 3227  es': ['r1', 'r2'
+00007050: 5d2c 0a20 2020 2020 2020 2020 2020 2027  ],.            '
+00007060: 656e 7669 726f 6e6d 656e 7427 3a20 7b27  environment': {'
+00007070: 6b31 273a 2027 7631 272c 2027 6b32 273a  k1': 'v1', 'k2':
+00007080: 2027 7632 277d 2c0a 2020 2020 2020 2020   'v2'},.        
+00007090: 2020 2020 2775 7365 7227 3a20 2762 6f62      'user': 'bob
+000070a0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000070b0: 7573 6572 2d69 6427 3a20 3130 3030 2c0a  user-id': 1000,.
+000070c0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
+000070d0: 7570 273a 2027 7374 6166 6627 2c0a 2020  up': 'staff',.  
+000070e0: 2020 2020 2020 2020 2020 2767 726f 7570            'group
+000070f0: 2d69 6427 3a20 3230 3030 2c0a 2020 2020  -id': 2000,.    
+00007100: 2020 2020 7d0a 2020 2020 2020 2020 6f6e      }.        on
+00007110: 6520 3d20 7065 6262 6c65 2e53 6572 7669  e = pebble.Servi
+00007120: 6365 2822 4e61 6d65 2031 222c 2064 290a  ce("Name 1", d).
+00007130: 2020 2020 2020 2020 7477 6f20 3d20 7065          two = pe
+00007140: 6262 6c65 2e53 6572 7669 6365 2822 4e61  bble.Service("Na
+00007150: 6d65 2031 222c 2064 290a 2020 2020 2020  me 1", d).      
+00007160: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00007170: 616c 286f 6e65 2c20 7477 6f29 0a0a 2020  al(one, two)..  
+00007180: 2020 2020 2020 6173 5f64 6963 7420 3d20        as_dict = 
+00007190: 7b0a 2020 2020 2020 2020 2020 2020 2773  {.            's
+000071a0: 756d 6d61 7279 273a 2027 5375 6d20 4d61  ummary': 'Sum Ma
+000071b0: 7279 272c 0a20 2020 2020 2020 2020 2020  ry',.           
+000071c0: 2027 6465 7363 7269 7074 696f 6e27 3a20   'description': 
+000071d0: 2754 6865 206c 617a 7920 7175 6963 6b20  'The lazy quick 
+000071e0: 6272 6f77 6e27 2c0a 2020 2020 2020 2020  brown',.        
+000071f0: 2020 2020 2773 7461 7274 7570 273a 2027      'startup': '
+00007200: 5374 6172 7420 5570 272c 0a20 2020 2020  Start Up',.     
+00007210: 2020 2020 2020 2027 6f76 6572 7269 6465         'override
+00007220: 273a 2027 6f76 6572 7269 6465 272c 0a20  ': 'override',. 
+00007230: 2020 2020 2020 2020 2020 2027 636f 6d6d             'comm
+00007240: 616e 6427 3a20 2765 6368 6f20 7375 6d20  and': 'echo sum 
+00007250: 6d61 7279 272c 0a20 2020 2020 2020 2020  mary',.         
+00007260: 2020 2027 6166 7465 7227 3a20 5b27 6131     'after': ['a1
+00007270: 272c 2027 6132 275d 2c0a 2020 2020 2020  ', 'a2'],.      
+00007280: 2020 2020 2020 2762 6566 6f72 6527 3a20        'before': 
+00007290: 5b27 6231 272c 2027 6232 275d 2c0a 2020  ['b1', 'b2'],.  
+000072a0: 2020 2020 2020 2020 2020 2772 6571 7569            'requi
+000072b0: 7265 7327 3a20 5b27 7231 272c 2027 7232  res': ['r1', 'r2
+000072c0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+000072d0: 2765 6e76 6972 6f6e 6d65 6e74 273a 207b  'environment': {
+000072e0: 276b 3127 3a20 2776 3127 2c20 276b 3227  'k1': 'v1', 'k2'
+000072f0: 3a20 2776 3227 7d2c 0a20 2020 2020 2020  : 'v2'},.       
+00007300: 2020 2020 2027 7573 6572 273a 2027 626f       'user': 'bo
+00007310: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+00007320: 2775 7365 722d 6964 273a 2031 3030 302c  'user-id': 1000,
+00007330: 0a20 2020 2020 2020 2020 2020 2027 6772  .            'gr
+00007340: 6f75 7027 3a20 2773 7461 6666 272c 0a20  oup': 'staff',. 
+00007350: 2020 2020 2020 2020 2020 2027 6772 6f75             'grou
+00007360: 702d 6964 273a 2032 3030 302c 0a20 2020  p-id': 2000,.   
+00007370: 2020 2020 207d 0a20 2020 2020 2020 2073       }.        s
+00007380: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00007390: 6f6e 652c 2061 735f 6469 6374 290a 0a20  one, as_dict).. 
+000073a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000073b0: 7274 4e6f 7445 7175 616c 286f 6e65 2c20  rtNotEqual(one, 
+000073c0: 3529 0a0a 0a63 6c61 7373 2054 6573 7443  5)...class TestC
+000073d0: 6865 636b 2875 6e69 7474 6573 742e 5465  heck(unittest.Te
+000073e0: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+000073f0: 205f 6173 7365 7274 5f65 6d70 7479 2873   _assert_empty(s
+00007400: 656c 662c 2063 6865 636b 2c20 6e61 6d65  elf, check, name
+00007410: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00007420: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
+00007430: 6b2e 6e61 6d65 2c20 6e61 6d65 290a 2020  k.name, name).  
+00007440: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007450: 7445 7175 616c 2863 6865 636b 2e6f 7665  tEqual(check.ove
+00007460: 7272 6964 652c 2027 2729 0a20 2020 2020  rride, '').     
+00007470: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00007480: 7561 6c28 6368 6563 6b2e 6c65 7665 6c2c  ual(check.level,
+00007490: 2070 6562 626c 652e 4368 6563 6b4c 6576   pebble.CheckLev
+000074a0: 656c 2e55 4e53 4554 290a 2020 2020 2020  el.UNSET).      
+000074b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000074c0: 616c 2863 6865 636b 2e70 6572 696f 642c  al(check.period,
+000074d0: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
+000074e0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+000074f0: 6563 6b2e 7469 6d65 6f75 742c 2027 2729  eck.timeout, '')
+00007500: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007510: 7365 7274 4973 2863 6865 636b 2e74 6872  sertIs(check.thr
+00007520: 6573 686f 6c64 2c20 4e6f 6e65 290a 2020  eshold, None).  
+00007530: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007540: 7449 7328 6368 6563 6b2e 6874 7470 2c20  tIs(check.http, 
+00007550: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
+00007560: 6c66 2e61 7373 6572 7449 7328 6368 6563  lf.assertIs(chec
+00007570: 6b2e 7463 702c 204e 6f6e 6529 0a20 2020  k.tcp, None).   
+00007580: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00007590: 4973 2863 6865 636b 2e65 7865 632c 204e  Is(check.exec, N
+000075a0: 6f6e 6529 0a0a 2020 2020 6465 6620 7465  one)..    def te
+000075b0: 7374 5f6e 616d 655f 6f6e 6c79 2873 656c  st_name_only(sel
+000075c0: 6629 3a0a 2020 2020 2020 2020 6368 6563  f):.        chec
+000075d0: 6b20 3d20 7065 6262 6c65 2e43 6865 636b  k = pebble.Check
+000075e0: 2827 6368 6b27 290a 2020 2020 2020 2020  ('chk').        
+000075f0: 7365 6c66 2e5f 6173 7365 7274 5f65 6d70  self._assert_emp
+00007600: 7479 2863 6865 636b 2c20 2763 686b 2729  ty(check, 'chk')
+00007610: 0a0a 2020 2020 6465 6620 7465 7374 5f64  ..    def test_d
+00007620: 6963 7428 7365 6c66 293a 0a20 2020 2020  ict(self):.     
+00007630: 2020 2064 203d 207b 0a20 2020 2020 2020     d = {.       
+00007640: 2020 2020 2027 6f76 6572 7269 6465 273a       'override':
+00007650: 2027 7265 706c 6163 6527 2c0a 2020 2020   'replace',.    
+00007660: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
+00007670: 2027 616c 6976 6527 2c0a 2020 2020 2020   'alive',.      
+00007680: 2020 2020 2020 2770 6572 696f 6427 3a20        'period': 
+00007690: 2731 3073 272c 0a20 2020 2020 2020 2020  '10s',.         
+000076a0: 2020 2027 7469 6d65 6f75 7427 3a20 2733     'timeout': '3
+000076b0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000076c0: 2774 6872 6573 686f 6c64 273a 2035 2c0a  'threshold': 5,.
+000076d0: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+000076e0: 7420 7661 6c69 6420 666f 7220 5065 6262  t valid for Pebb
+000076f0: 6c65 2074 6f20 6861 7665 206d 6f72 6520  le to have more 
+00007700: 7468 616e 206f 6e65 206f 6620 6874 7470  than one of http
+00007710: 2c20 7463 702c 2061 6e64 2065 7865 632c  , tcp, and exec,
+00007720: 0a20 2020 2020 2020 2020 2020 2023 2062  .            # b
+00007730: 7574 2069 7420 6d61 6b65 7320 7468 696e  ut it makes thin
+00007740: 6773 2073 696d 706c 6572 2066 6f72 2074  gs simpler for t
+00007750: 6865 2075 6e69 7420 7465 7374 732e 0a20  he unit tests.. 
+00007760: 2020 2020 2020 2020 2020 2027 6874 7470             'http
+00007770: 273a 207b 2775 726c 273a 2027 6874 7470  ': {'url': 'http
+00007780: 733a 2f2f 6578 616d 706c 652e 636f 6d2f  s://example.com/
+00007790: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+000077a0: 2774 6370 273a 207b 2770 6f72 7427 3a20  'tcp': {'port': 
+000077b0: 3830 7d2c 0a20 2020 2020 2020 2020 2020  80},.           
+000077c0: 2027 6578 6563 273a 207b 2763 6f6d 6d61   'exec': {'comma
+000077d0: 6e64 273a 2027 6563 686f 2066 6f6f 277d  nd': 'echo foo'}
+000077e0: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
+000077f0: 2020 2020 6368 6563 6b20 3d20 7065 6262      check = pebb
+00007800: 6c65 2e43 6865 636b 2827 6368 6b2d 6874  le.Check('chk-ht
+00007810: 7470 272c 2064 290a 2020 2020 2020 2020  tp', d).        
+00007820: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00007830: 2863 6865 636b 2e6e 616d 652c 2027 6368  (check.name, 'ch
+00007840: 6b2d 6874 7470 2729 0a20 2020 2020 2020  k-http').       
+00007850: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00007860: 6c28 6368 6563 6b2e 6f76 6572 7269 6465  l(check.override
+00007870: 2c20 2772 6570 6c61 6365 2729 0a20 2020  , 'replace').   
+00007880: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00007890: 4571 7561 6c28 6368 6563 6b2e 6c65 7665  Equal(check.leve
+000078a0: 6c2c 2070 6562 626c 652e 4368 6563 6b4c  l, pebble.CheckL
+000078b0: 6576 656c 2e41 4c49 5645 290a 2020 2020  evel.ALIVE).    
+000078c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000078d0: 7175 616c 2863 6865 636b 2e70 6572 696f  qual(check.perio
+000078e0: 642c 2027 3130 7327 290a 2020 2020 2020  d, '10s').      
+000078f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00007900: 616c 2863 6865 636b 2e74 696d 656f 7574  al(check.timeout
+00007910: 2c20 2733 7327 290a 2020 2020 2020 2020  , '3s').        
+00007920: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00007930: 2863 6865 636b 2e74 6872 6573 686f 6c64  (check.threshold
+00007940: 2c20 3529 0a20 2020 2020 2020 2073 656c  , 5).        sel
+00007950: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00007960: 6563 6b2e 6874 7470 2c20 7b27 7572 6c27  eck.http, {'url'
+00007970: 3a20 2768 7474 7073 3a2f 2f65 7861 6d70  : 'https://examp
+00007980: 6c65 2e63 6f6d 2f27 7d29 0a20 2020 2020  le.com/'}).     
+00007990: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000079a0: 7561 6c28 6368 6563 6b2e 7463 702c 207b  ual(check.tcp, {
+000079b0: 2770 6f72 7427 3a20 3830 7d29 0a20 2020  'port': 80}).   
+000079c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000079d0: 4571 7561 6c28 6368 6563 6b2e 6578 6563  Equal(check.exec
+000079e0: 2c20 7b27 636f 6d6d 616e 6427 3a20 2765  , {'command': 'e
+000079f0: 6368 6f20 666f 6f27 7d29 0a0a 2020 2020  cho foo'})..    
+00007a00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007a10: 7175 616c 2863 6865 636b 2e74 6f5f 6469  qual(check.to_di
+00007a20: 6374 2829 2c20 6429 0a0a 2020 2020 2020  ct(), d)..      
+00007a30: 2020 2320 456e 7375 7265 2070 6562 626c    # Ensure pebbl
+00007a40: 652e 4368 6563 6b20 6861 7320 6d61 6465  e.Check has made
+00007a50: 2063 6f70 6965 7320 6f66 206d 7574 6162   copies of mutab
+00007a60: 6c65 206f 626a 6563 7473 0a20 2020 2020  le objects.     
+00007a70: 2020 2063 6865 636b 2e68 7474 705b 2775     check.http['u
+00007a80: 726c 275d 203d 2027 6874 7470 733a 2f2f  rl'] = 'https://
+00007a90: 7777 772e 676f 6f67 6c65 2e63 6f6d 270a  www.google.com'.
+00007aa0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00007ab0: 6572 7445 7175 616c 2864 5b27 6874 7470  ertEqual(d['http
+00007ac0: 275d 2c20 7b27 7572 6c27 3a20 2768 7474  '], {'url': 'htt
+00007ad0: 7073 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  ps://example.com
+00007ae0: 2f27 7d29 0a20 2020 2020 2020 2063 6865  /'}).        che
+00007af0: 636b 2e74 6370 5b27 706f 7274 275d 203d  ck.tcp['port'] =
+00007b00: 2038 310a 2020 2020 2020 2020 7365 6c66   81.        self
+00007b10: 2e61 7373 6572 7445 7175 616c 2864 5b27  .assertEqual(d['
+00007b20: 7463 7027 5d2c 207b 2770 6f72 7427 3a20  tcp'], {'port': 
+00007b30: 3830 7d29 0a20 2020 2020 2020 2063 6865  80}).        che
+00007b40: 636b 2e65 7865 635b 2763 6f6d 6d61 6e64  ck.exec['command
+00007b50: 275d 203d 2027 666f 6f27 0a20 2020 2020  '] = 'foo'.     
+00007b60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00007b70: 7561 6c28 645b 2765 7865 6327 5d2c 207b  ual(d['exec'], {
+00007b80: 2763 6f6d 6d61 6e64 273a 2027 6563 686f  'command': 'echo
+00007b90: 2066 6f6f 277d 290a 0a20 2020 2064 6566   foo'})..    def
+00007ba0: 2074 6573 745f 6c65 7665 6c5f 7261 7728   test_level_raw(
+00007bb0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
+00007bc0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00007bd0: 2027 6f76 6572 7269 6465 273a 2027 7265   'override': 're
+00007be0: 706c 6163 6527 2c0a 2020 2020 2020 2020  place',.        
+00007bf0: 2020 2020 276c 6576 656c 273a 2027 666f      'level': 'fo
+00007c00: 6f62 6172 2127 2c0a 2020 2020 2020 2020  obar!',.        
+00007c10: 2020 2020 2770 6572 696f 6427 3a20 2731      'period': '1
+00007c20: 3073 272c 0a20 2020 2020 2020 2020 2020  0s',.           
+00007c30: 2027 7469 6d65 6f75 7427 3a20 2733 7327   'timeout': '3s'
+00007c40: 2c0a 2020 2020 2020 2020 2020 2020 2774  ,.            't
+00007c50: 6872 6573 686f 6c64 273a 2035 2c0a 2020  hreshold': 5,.  
+00007c60: 2020 2020 2020 2020 2020 2768 7474 7027            'http'
+00007c70: 3a20 7b27 7572 6c27 3a20 2768 7474 7073  : {'url': 'https
+00007c80: 3a2f 2f65 7861 6d70 6c65 2e63 6f6d 2f27  ://example.com/'
+00007c90: 7d2c 0a20 2020 2020 2020 207d 0a20 2020  },.        }.   
+00007ca0: 2020 2020 2063 6865 636b 203d 2070 6562       check = peb
+00007cb0: 626c 652e 4368 6563 6b28 2763 686b 2d68  ble.Check('chk-h
+00007cc0: 7474 7027 2c20 6429 0a20 2020 2020 2020  ttp', d).       
+00007cd0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00007ce0: 6c28 6368 6563 6b2e 6c65 7665 6c2c 2027  l(check.level, '
+00007cf0: 666f 6f62 6172 2127 2920 2023 2072 656d  foobar!')  # rem
+00007d00: 6169 6e73 2061 2073 7472 696e 670a 0a20  ains a string.. 
+00007d10: 2020 2064 6566 2074 6573 745f 6571 7561     def test_equa
+00007d20: 6c69 7479 2873 656c 6629 3a0a 2020 2020  lity(self):.    
+00007d30: 2020 2020 6420 3d20 7b0a 2020 2020 2020      d = {.      
+00007d40: 2020 2020 2020 276f 7665 7272 6964 6527        'override'
+00007d50: 3a20 2772 6570 6c61 6365 272c 0a20 2020  : 'replace',.   
+00007d60: 2020 2020 2020 2020 2027 6c65 7665 6c27           'level'
+00007d70: 3a20 2761 6c69 7665 272c 0a20 2020 2020  : 'alive',.     
+00007d80: 2020 2020 2020 2027 7065 7269 6f64 273a         'period':
+00007d90: 2027 3130 7327 2c0a 2020 2020 2020 2020   '10s',.        
+00007da0: 2020 2020 2774 696d 656f 7574 273a 2027      'timeout': '
+00007db0: 3373 272c 0a20 2020 2020 2020 2020 2020  3s',.           
+00007dc0: 2027 7468 7265 7368 6f6c 6427 3a20 352c   'threshold': 5,
+00007dd0: 0a20 2020 2020 2020 2020 2020 2027 6874  .            'ht
+00007de0: 7470 273a 207b 2775 726c 273a 2027 6874  tp': {'url': 'ht
+00007df0: 7470 733a 2f2f 6578 616d 706c 652e 636f  tps://example.co
+00007e00: 6d2f 277d 2c0a 2020 2020 2020 2020 7d0a  m/'},.        }.
+00007e10: 2020 2020 2020 2020 6f6e 6520 3d20 7065          one = pe
+00007e20: 6262 6c65 2e43 6865 636b 2827 6f6e 6527  bble.Check('one'
+00007e30: 2c20 6429 0a20 2020 2020 2020 2074 776f  , d).        two
+00007e40: 203d 2070 6562 626c 652e 4368 6563 6b28   = pebble.Check(
+00007e50: 2774 776f 272c 2064 290a 2020 2020 2020  'two', d).      
+00007e60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00007e70: 616c 286f 6e65 2c20 7477 6f29 0a20 2020  al(one, two).   
+00007e80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00007e90: 4571 7561 6c28 6f6e 652c 2064 290a 2020  Equal(one, d).  
+00007ea0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00007eb0: 7445 7175 616c 2874 776f 2c20 6429 0a20  tEqual(two, d). 
+00007ec0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007ed0: 7274 4571 7561 6c28 6f6e 652c 206f 6e65  rtEqual(one, one
+00007ee0: 2e74 6f5f 6469 6374 2829 290a 2020 2020  .to_dict()).    
+00007ef0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007f00: 7175 616c 2874 776f 2c20 7477 6f2e 746f  qual(two, two.to
+00007f10: 5f64 6963 7428 2929 0a20 2020 2020 2020  _dict()).       
+00007f20: 2064 5b27 6c65 7665 6c27 5d20 3d20 2772   d['level'] = 'r
+00007f30: 6561 6479 270a 2020 2020 2020 2020 7365  eady'.        se
+00007f40: 6c66 2e61 7373 6572 744e 6f74 4571 7561  lf.assertNotEqua
+00007f50: 6c28 6f6e 652c 2064 290a 0a20 2020 2020  l(one, d)..     
+00007f60: 2020 2073 656c 662e 6173 7365 7274 4e6f     self.assertNo
+00007f70: 7445 7175 616c 286f 6e65 2c20 3529 0a0a  tEqual(one, 5)..
+00007f80: 0a63 6c61 7373 2054 6573 7453 6572 7669  .class TestServi
+00007f90: 6365 496e 666f 2875 6e69 7474 6573 742e  ceInfo(unittest.
+00007fa0: 5465 7374 4361 7365 293a 0a20 2020 2064  TestCase):.    d
+00007fb0: 6566 2074 6573 745f 7365 7276 6963 655f  ef test_service_
+00007fc0: 7374 6172 7475 7028 7365 6c66 293a 0a20  startup(self):. 
+00007fd0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007fe0: 7274 4571 7561 6c28 6c69 7374 2870 6562  rtEqual(list(peb
+00007ff0: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
+00008000: 7570 292c 205b 0a20 2020 2020 2020 2020  up), [.         
+00008010: 2020 2070 6562 626c 652e 5365 7276 6963     pebble.Servic
+00008020: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
+00008030: 2c0a 2020 2020 2020 2020 2020 2020 7065  ,.            pe
+00008040: 6262 6c65 2e53 6572 7669 6365 5374 6172  bble.ServiceStar
+00008050: 7475 702e 4449 5341 424c 4544 2c0a 2020  tup.DISABLED,.  
+00008060: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
+00008070: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008080: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
+00008090: 5374 6172 7475 702e 454e 4142 4c45 442e  Startup.ENABLED.
+000080a0: 7661 6c75 652c 2027 656e 6162 6c65 6427  value, 'enabled'
+000080b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000080c0: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
+000080d0: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
+000080e0: 2e44 4953 4142 4c45 442e 7661 6c75 652c  .DISABLED.value,
+000080f0: 2027 6469 7361 626c 6564 2729 0a0a 2020   'disabled')..  
+00008100: 2020 6465 6620 7465 7374 5f73 6572 7669    def test_servi
+00008110: 6365 5f73 7461 7475 7328 7365 6c66 293a  ce_status(self):
+00008120: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008130: 7365 7274 4571 7561 6c28 6c69 7374 2870  sertEqual(list(p
+00008140: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+00008150: 7475 7329 2c20 5b0a 2020 2020 2020 2020  tus), [.        
+00008160: 2020 2020 7065 6262 6c65 2e53 6572 7669      pebble.Servi
+00008170: 6365 5374 6174 7573 2e41 4354 4956 452c  ceStatus.ACTIVE,
+00008180: 0a20 2020 2020 2020 2020 2020 2070 6562  .            peb
+00008190: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
+000081a0: 732e 494e 4143 5449 5645 2c0a 2020 2020  s.INACTIVE,.    
+000081b0: 2020 2020 2020 2020 7065 6262 6c65 2e53          pebble.S
+000081c0: 6572 7669 6365 5374 6174 7573 2e45 5252  erviceStatus.ERR
+000081d0: 4f52 2c0a 2020 2020 2020 2020 5d29 0a20  OR,.        ]). 
+000081e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000081f0: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
+00008200: 6572 7669 6365 5374 6174 7573 2e41 4354  erviceStatus.ACT
+00008210: 4956 452e 7661 6c75 652c 2027 6163 7469  IVE.value, 'acti
+00008220: 7665 2729 0a20 2020 2020 2020 2073 656c  ve').        sel
+00008230: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
+00008240: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
+00008250: 7573 2e49 4e41 4354 4956 452e 7661 6c75  us.INACTIVE.valu
+00008260: 652c 2027 696e 6163 7469 7665 2729 0a20  e, 'inactive'). 
+00008270: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00008280: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
+00008290: 6572 7669 6365 5374 6174 7573 2e45 5252  erviceStatus.ERR
+000082a0: 4f52 2e76 616c 7565 2c20 2765 7272 6f72  OR.value, 'error
+000082b0: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
+000082c0: 5f73 6572 7669 6365 5f69 6e66 6f28 7365  _service_info(se
+000082d0: 6c66 293a 0a20 2020 2020 2020 2073 203d  lf):.        s =
+000082e0: 2070 6562 626c 652e 5365 7276 6963 6549   pebble.ServiceI
+000082f0: 6e66 6f28 2773 7663 3127 2c20 7065 6262  nfo('svc1', pebb
+00008300: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
+00008310: 702e 454e 4142 4c45 442c 2070 6562 626c  p.ENABLED, pebbl
+00008320: 652e 5365 7276 6963 6553 7461 7475 732e  e.ServiceStatus.
+00008330: 4143 5449 5645 290a 2020 2020 2020 2020  ACTIVE).        
+00008340: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00008350: 2873 2e6e 616d 652c 2027 7376 6331 2729  (s.name, 'svc1')
+00008360: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008370: 7365 7274 4571 7561 6c28 732e 7374 6172  sertEqual(s.star
+00008380: 7475 702c 2070 6562 626c 652e 5365 7276  tup, pebble.Serv
+00008390: 6963 6553 7461 7274 7570 2e45 4e41 424c  iceStartup.ENABL
+000083a0: 4544 290a 2020 2020 2020 2020 7365 6c66  ED).        self
+000083b0: 2e61 7373 6572 7445 7175 616c 2873 2e63  .assertEqual(s.c
+000083c0: 7572 7265 6e74 2c20 7065 6262 6c65 2e53  urrent, pebble.S
+000083d0: 6572 7669 6365 5374 6174 7573 2e41 4354  erviceStatus.ACT
+000083e0: 4956 4529 0a0a 2020 2020 2020 2020 7320  IVE)..        s 
+000083f0: 3d20 7065 6262 6c65 2e53 6572 7669 6365  = pebble.Service
+00008400: 496e 666f 280a 2020 2020 2020 2020 2020  Info(.          
+00008410: 2020 2773 7663 3127 2c0a 2020 2020 2020    'svc1',.      
+00008420: 2020 2020 2020 7065 6262 6c65 2e53 6572        pebble.Ser
+00008430: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
+00008440: 4c45 442c 0a20 2020 2020 2020 2020 2020  LED,.           
+00008450: 2070 6562 626c 652e 5365 7276 6963 6553   pebble.ServiceS
+00008460: 7461 7475 732e 4143 5449 5645 290a 2020  tatus.ACTIVE).  
+00008470: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00008480: 7445 7175 616c 2873 2e6e 616d 652c 2027  tEqual(s.name, '
+00008490: 7376 6331 2729 0a20 2020 2020 2020 2073  svc1').        s
+000084a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000084b0: 732e 7374 6172 7475 702c 2070 6562 626c  s.startup, pebbl
+000084c0: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
+000084d0: 2e45 4e41 424c 4544 290a 2020 2020 2020  .ENABLED).      
+000084e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000084f0: 616c 2873 2e63 7572 7265 6e74 2c20 7065  al(s.current, pe
+00008500: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
+00008510: 7573 2e41 4354 4956 4529 0a0a 2020 2020  us.ACTIVE)..    
+00008520: 2020 2020 7320 3d20 7065 6262 6c65 2e53      s = pebble.S
+00008530: 6572 7669 6365 496e 666f 2e66 726f 6d5f  erviceInfo.from_
+00008540: 6469 6374 287b 0a20 2020 2020 2020 2020  dict({.         
+00008550: 2020 2027 6e61 6d65 273a 2027 7376 6332     'name': 'svc2
+00008560: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00008570: 7374 6172 7475 7027 3a20 2764 6973 6162  startup': 'disab
+00008580: 6c65 6427 2c0a 2020 2020 2020 2020 2020  led',.          
+00008590: 2020 2763 7572 7265 6e74 273a 2027 696e    'current': 'in
+000085a0: 6163 7469 7665 272c 0a20 2020 2020 2020  active',.       
+000085b0: 207d 290a 2020 2020 2020 2020 7365 6c66   }).        self
+000085c0: 2e61 7373 6572 7445 7175 616c 2873 2e6e  .assertEqual(s.n
+000085d0: 616d 652c 2027 7376 6332 2729 0a20 2020  ame, 'svc2').   
+000085e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000085f0: 4571 7561 6c28 732e 7374 6172 7475 702c  Equal(s.startup,
+00008600: 2070 6562 626c 652e 5365 7276 6963 6553   pebble.ServiceS
+00008610: 7461 7274 7570 2e44 4953 4142 4c45 4429  tartup.DISABLED)
+00008620: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008630: 7365 7274 4571 7561 6c28 732e 6375 7272  sertEqual(s.curr
+00008640: 656e 742c 2070 6562 626c 652e 5365 7276  ent, pebble.Serv
+00008650: 6963 6553 7461 7475 732e 494e 4143 5449  iceStatus.INACTI
+00008660: 5645 290a 0a20 2020 2020 2020 2073 203d  VE)..        s =
+00008670: 2070 6562 626c 652e 5365 7276 6963 6549   pebble.ServiceI
+00008680: 6e66 6f2e 6672 6f6d 5f64 6963 7428 7b0a  nfo.from_dict({.
+00008690: 2020 2020 2020 2020 2020 2020 276e 616d              'nam
+000086a0: 6527 3a20 2773 7663 3227 2c0a 2020 2020  e': 'svc2',.    
+000086b0: 2020 2020 2020 2020 2773 7461 7274 7570          'startup
+000086c0: 273a 2027 7468 696e 6779 272c 0a20 2020  ': 'thingy',.   
+000086d0: 2020 2020 2020 2020 2027 6375 7272 656e           'curren
+000086e0: 7427 3a20 2762 6f62 272c 0a20 2020 2020  t': 'bob',.     
+000086f0: 2020 207d 290a 2020 2020 2020 2020 7365     }).        se
+00008700: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00008710: 2e6e 616d 652c 2027 7376 6332 2729 0a20  .name, 'svc2'). 
+00008720: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00008730: 7274 4571 7561 6c28 732e 7374 6172 7475  rtEqual(s.startu
+00008740: 702c 2027 7468 696e 6779 2729 0a20 2020  p, 'thingy').   
+00008750: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00008760: 4571 7561 6c28 732e 6375 7272 656e 742c  Equal(s.current,
+00008770: 2027 626f 6227 290a 0a20 2020 2064 6566   'bob')..    def
+00008780: 2074 6573 745f 6973 5f72 756e 6e69 6e67   test_is_running
+00008790: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000087a0: 7320 3d20 7065 6262 6c65 2e53 6572 7669  s = pebble.Servi
+000087b0: 6365 496e 666f 2827 7327 2c20 7065 6262  ceInfo('s', pebb
+000087c0: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
+000087d0: 702e 454e 4142 4c45 442c 2070 6562 626c  p.ENABLED, pebbl
+000087e0: 652e 5365 7276 6963 6553 7461 7475 732e  e.ServiceStatus.
+000087f0: 4143 5449 5645 290a 2020 2020 2020 2020  ACTIVE).        
+00008800: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+00008810: 732e 6973 5f72 756e 6e69 6e67 2829 290a  s.is_running()).
+00008820: 2020 2020 2020 2020 666f 7220 6375 7272          for curr
+00008830: 656e 7420 696e 205b 7065 6262 6c65 2e53  ent in [pebble.S
+00008840: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
+00008850: 4354 4956 452c 2070 6562 626c 652e 5365  CTIVE, pebble.Se
+00008860: 7276 6963 6553 7461 7475 732e 4552 524f  rviceStatus.ERRO
+00008870: 522c 2027 6f74 6865 7227 5d3a 0a20 2020  R, 'other']:.   
+00008880: 2020 2020 2020 2020 2073 203d 2070 6562           s = peb
+00008890: 626c 652e 5365 7276 6963 6549 6e66 6f28  ble.ServiceInfo(
+000088a0: 2773 272c 2070 6562 626c 652e 5365 7276  's', pebble.Serv
+000088b0: 6963 6553 7461 7274 7570 2e45 4e41 424c  iceStartup.ENABL
+000088c0: 4544 2c20 6375 7272 656e 7429 0a20 2020  ED, current).   
+000088d0: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+000088e0: 7365 7274 4661 6c73 6528 732e 6973 5f72  sertFalse(s.is_r
+000088f0: 756e 6e69 6e67 2829 290a 0a0a 636c 6173  unning())...clas
+00008900: 7320 5465 7374 4368 6563 6b49 6e66 6f28  s TestCheckInfo(
+00008910: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
+00008920: 6529 3a0a 2020 2020 6465 6620 7465 7374  e):.    def test
+00008930: 5f63 6865 636b 5f6c 6576 656c 2873 656c  _check_level(sel
+00008940: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00008950: 2e61 7373 6572 7445 7175 616c 286c 6973  .assertEqual(lis
+00008960: 7428 7065 6262 6c65 2e43 6865 636b 4c65  t(pebble.CheckLe
+00008970: 7665 6c29 2c20 5b0a 2020 2020 2020 2020  vel), [.        
+00008980: 2020 2020 7065 6262 6c65 2e43 6865 636b      pebble.Check
+00008990: 4c65 7665 6c2e 554e 5345 542c 0a20 2020  Level.UNSET,.   
+000089a0: 2020 2020 2020 2020 2070 6562 626c 652e           pebble.
+000089b0: 4368 6563 6b4c 6576 656c 2e41 4c49 5645  CheckLevel.ALIVE
+000089c0: 2c0a 2020 2020 2020 2020 2020 2020 7065  ,.            pe
+000089d0: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
+000089e0: 5245 4144 592c 0a20 2020 2020 2020 205d  READY,.        ]
+000089f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00008a00: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
+00008a10: 652e 4368 6563 6b4c 6576 656c 2e55 4e53  e.CheckLevel.UNS
+00008a20: 4554 2e76 616c 7565 2c20 2727 290a 2020  ET.value, '').  
+00008a30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00008a40: 7445 7175 616c 2870 6562 626c 652e 4368  tEqual(pebble.Ch
+00008a50: 6563 6b4c 6576 656c 2e41 4c49 5645 2e76  eckLevel.ALIVE.v
+00008a60: 616c 7565 2c20 2761 6c69 7665 2729 0a20  alue, 'alive'). 
+00008a70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00008a80: 7274 4571 7561 6c28 7065 6262 6c65 2e43  rtEqual(pebble.C
+00008a90: 6865 636b 4c65 7665 6c2e 5245 4144 592e  heckLevel.READY.
+00008aa0: 7661 6c75 652c 2027 7265 6164 7927 290a  value, 'ready').
+00008ab0: 0a20 2020 2064 6566 2074 6573 745f 6368  .    def test_ch
+00008ac0: 6563 6b5f 7374 6174 7573 2873 656c 6629  eck_status(self)
+00008ad0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
+00008ae0: 7373 6572 7445 7175 616c 286c 6973 7428  ssertEqual(list(
+00008af0: 7065 6262 6c65 2e43 6865 636b 5374 6174  pebble.CheckStat
+00008b00: 7573 292c 205b 0a20 2020 2020 2020 2020  us), [.         
+00008b10: 2020 2070 6562 626c 652e 4368 6563 6b53     pebble.CheckS
+00008b20: 7461 7475 732e 5550 2c0a 2020 2020 2020  tatus.UP,.      
+00008b30: 2020 2020 2020 7065 6262 6c65 2e43 6865        pebble.Che
+00008b40: 636b 5374 6174 7573 2e44 4f57 4e2c 0a20  ckStatus.DOWN,. 
+00008b50: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
+00008b60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008b70: 616c 2870 6562 626c 652e 4368 6563 6b53  al(pebble.CheckS
+00008b80: 7461 7475 732e 5550 2e76 616c 7565 2c20  tatus.UP.value, 
+00008b90: 2775 7027 290a 2020 2020 2020 2020 7365  'up').        se
+00008ba0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00008bb0: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+00008bc0: 732e 444f 574e 2e76 616c 7565 2c20 2764  s.DOWN.value, 'd
+00008bd0: 6f77 6e27 290a 0a20 2020 2064 6566 2074  own')..    def t
+00008be0: 6573 745f 6368 6563 6b5f 696e 666f 2873  est_check_info(s
+00008bf0: 656c 6629 3a0a 2020 2020 2020 2020 6368  elf):.        ch
+00008c00: 6563 6b20 3d20 7065 6262 6c65 2e43 6865  eck = pebble.Che
+00008c10: 636b 496e 666f 280a 2020 2020 2020 2020  ckInfo(.        
+00008c20: 2020 2020 6e61 6d65 3d27 6368 6b31 272c      name='chk1',
+00008c30: 0a20 2020 2020 2020 2020 2020 206c 6576  .            lev
+00008c40: 656c 3d70 6562 626c 652e 4368 6563 6b4c  el=pebble.CheckL
+00008c50: 6576 656c 2e52 4541 4459 2c0a 2020 2020  evel.READY,.    
+00008c60: 2020 2020 2020 2020 7374 6174 7573 3d70          status=p
+00008c70: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+00008c80: 732e 5550 2c0a 2020 2020 2020 2020 2020  s.UP,.          
+00008c90: 2020 7468 7265 7368 6f6c 643d 332c 0a20    threshold=3,. 
+00008ca0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00008cb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008cc0: 6c28 6368 6563 6b2e 6e61 6d65 2c20 2763  l(check.name, 'c
+00008cd0: 686b 3127 290a 2020 2020 2020 2020 7365  hk1').        se
+00008ce0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00008cf0: 6865 636b 2e6c 6576 656c 2c20 7065 6262  heck.level, pebb
+00008d00: 6c65 2e43 6865 636b 4c65 7665 6c2e 5245  le.CheckLevel.RE
+00008d10: 4144 5929 0a20 2020 2020 2020 2073 656c  ADY).        sel
+00008d20: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00008d30: 6563 6b2e 7374 6174 7573 2c20 7065 6262  eck.status, pebb
+00008d40: 6c65 2e43 6865 636b 5374 6174 7573 2e55  le.CheckStatus.U
+00008d50: 5029 0a20 2020 2020 2020 2073 656c 662e  P).        self.
+00008d60: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
+00008d70: 6b2e 6661 696c 7572 6573 2c20 3029 0a20  k.failures, 0). 
+00008d80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00008d90: 7274 4571 7561 6c28 6368 6563 6b2e 7468  rtEqual(check.th
+00008da0: 7265 7368 6f6c 642c 2033 290a 0a20 2020  reshold, 3)..   
+00008db0: 2020 2020 2063 6865 636b 203d 2070 6562       check = peb
+00008dc0: 626c 652e 4368 6563 6b49 6e66 6f28 0a20  ble.CheckInfo(. 
+00008dd0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+00008de0: 2763 686b 3227 2c0a 2020 2020 2020 2020  'chk2',.        
+00008df0: 2020 2020 6c65 7665 6c3d 7065 6262 6c65      level=pebble
+00008e00: 2e43 6865 636b 4c65 7665 6c2e 414c 4956  .CheckLevel.ALIV
+00008e10: 452c 0a20 2020 2020 2020 2020 2020 2073  E,.            s
+00008e20: 7461 7475 733d 7065 6262 6c65 2e43 6865  tatus=pebble.Che
+00008e30: 636b 5374 6174 7573 2e44 4f57 4e2c 0a20  ckStatus.DOWN,. 
+00008e40: 2020 2020 2020 2020 2020 2066 6169 6c75             failu
+00008e50: 7265 733d 352c 0a20 2020 2020 2020 2020  res=5,.         
+00008e60: 2020 2074 6872 6573 686f 6c64 3d33 2c0a     threshold=3,.
+00008e70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00008e80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008e90: 616c 2863 6865 636b 2e6e 616d 652c 2027  al(check.name, '
+00008ea0: 6368 6b32 2729 0a20 2020 2020 2020 2073  chk2').        s
+00008eb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00008ec0: 6368 6563 6b2e 6c65 7665 6c2c 2070 6562  check.level, peb
+00008ed0: 626c 652e 4368 6563 6b4c 6576 656c 2e41  ble.CheckLevel.A
+00008ee0: 4c49 5645 290a 2020 2020 2020 2020 7365  LIVE).        se
+00008ef0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00008f00: 6865 636b 2e73 7461 7475 732c 2070 6562  heck.status, peb
+00008f10: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
+00008f20: 444f 574e 290a 2020 2020 2020 2020 7365  DOWN).        se
+00008f30: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00008f40: 6865 636b 2e66 6169 6c75 7265 732c 2035  heck.failures, 5
+00008f50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00008f60: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+00008f70: 2e74 6872 6573 686f 6c64 2c20 3329 0a0a  .threshold, 3)..
+00008f80: 2020 2020 2020 2020 6368 6563 6b20 3d20          check = 
+00008f90: 7065 6262 6c65 2e43 6865 636b 496e 666f  pebble.CheckInfo
+00008fa0: 2e66 726f 6d5f 6469 6374 287b 0a20 2020  .from_dict({.   
+00008fb0: 2020 2020 2020 2020 2027 6e61 6d65 273a           'name':
+00008fc0: 2027 6368 6b33 272c 0a20 2020 2020 2020   'chk3',.       
+00008fd0: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
+00008fe0: 7570 272c 0a20 2020 2020 2020 2020 2020  up',.           
+00008ff0: 2027 7468 7265 7368 6f6c 6427 3a20 332c   'threshold': 3,
+00009000: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+00009010: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00009020: 7175 616c 2863 6865 636b 2e6e 616d 652c  qual(check.name,
+00009030: 2027 6368 6b33 2729 0a20 2020 2020 2020   'chk3').       
+00009040: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00009050: 6c28 6368 6563 6b2e 6c65 7665 6c2c 2070  l(check.level, p
+00009060: 6562 626c 652e 4368 6563 6b4c 6576 656c  ebble.CheckLevel
+00009070: 2e55 4e53 4554 290a 2020 2020 2020 2020  .UNSET).        
+00009080: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00009090: 2863 6865 636b 2e73 7461 7475 732c 2070  (check.status, p
+000090a0: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+000090b0: 732e 5550 290a 2020 2020 2020 2020 7365  s.UP).        se
+000090c0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+000090d0: 6865 636b 2e66 6169 6c75 7265 732c 2030  heck.failures, 0
+000090e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000090f0: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+00009100: 2e74 6872 6573 686f 6c64 2c20 3329 0a0a  .threshold, 3)..
+00009110: 2020 2020 2020 2020 6368 6563 6b20 3d20          check = 
+00009120: 7065 6262 6c65 2e43 6865 636b 496e 666f  pebble.CheckInfo
+00009130: 2e66 726f 6d5f 6469 6374 287b 0a20 2020  .from_dict({.   
+00009140: 2020 2020 2020 2020 2027 6e61 6d65 273a           'name':
+00009150: 2027 6368 6b34 272c 0a20 2020 2020 2020   'chk4',.       
+00009160: 2020 2020 2027 6c65 7665 6c27 3a20 7065       'level': pe
+00009170: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
+00009180: 554e 5345 542c 0a20 2020 2020 2020 2020  UNSET,.         
+00009190: 2020 2027 7374 6174 7573 273a 2070 6562     'status': peb
+000091a0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
+000091b0: 444f 574e 2c0a 2020 2020 2020 2020 2020  DOWN,.          
+000091c0: 2020 2766 6169 6c75 7265 7327 3a20 332c    'failures': 3,
+000091d0: 0a20 2020 2020 2020 2020 2020 2027 7468  .            'th
+000091e0: 7265 7368 6f6c 6427 3a20 332c 0a20 2020  reshold': 3,.   
+000091f0: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
+00009200: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00009210: 2863 6865 636b 2e6e 616d 652c 2027 6368  (check.name, 'ch
+00009220: 6b34 2729 0a20 2020 2020 2020 2073 656c  k4').        sel
+00009230: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00009240: 6563 6b2e 6c65 7665 6c2c 2070 6562 626c  eck.level, pebbl
+00009250: 652e 4368 6563 6b4c 6576 656c 2e55 4e53  e.CheckLevel.UNS
+00009260: 4554 290a 2020 2020 2020 2020 7365 6c66  ET).        self
+00009270: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+00009280: 636b 2e73 7461 7475 732c 2070 6562 626c  ck.status, pebbl
+00009290: 652e 4368 6563 6b53 7461 7475 732e 444f  e.CheckStatus.DO
+000092a0: 574e 290a 2020 2020 2020 2020 7365 6c66  WN).        self
+000092b0: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+000092c0: 636b 2e66 6169 6c75 7265 732c 2033 290a  ck.failures, 3).
+000092d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000092e0: 6572 7445 7175 616c 2863 6865 636b 2e74  ertEqual(check.t
+000092f0: 6872 6573 686f 6c64 2c20 3329 0a0a 0a63  hreshold, 3)...c
+00009300: 6c61 7373 204d 6f63 6b43 6c69 656e 7428  lass MockClient(
+00009310: 7065 6262 6c65 2e43 6c69 656e 7429 3a0a  pebble.Client):.
+00009320: 2020 2020 2222 224d 6f63 6b20 5065 6262      """Mock Pebb
+00009330: 6c65 2063 6c69 656e 7420 7468 6174 2073  le client that s
+00009340: 696d 706c 7920 7265 636f 7264 7320 7265  imply records re
+00009350: 7175 6573 7473 2061 6e64 2072 6574 7572  quests and retur
+00009360: 6e73 2073 746f 7265 6420 7265 7370 6f6e  ns stored respon
+00009370: 7365 732e 2222 220a 0a20 2020 2064 6566  ses."""..    def
+00009380: 205f 5f69 6e69 745f 5f28 7365 6c66 293a   __init__(self):
+00009390: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+000093a0: 7175 6573 7473 203d 205b 5d0a 2020 2020  quests = [].    
+000093b0: 2020 2020 7365 6c66 2e72 6573 706f 6e73      self.respons
+000093c0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+000093d0: 7365 6c66 2e74 696d 656f 7574 203d 2035  self.timeout = 5
+000093e0: 0a20 2020 2020 2020 2073 656c 662e 7765  .        self.we
+000093f0: 6273 6f63 6b65 7473 203d 207b 7d0a 0a20  bsockets = {}.. 
+00009400: 2020 2064 6566 205f 7265 7175 6573 7428     def _request(
+00009410: 7365 6c66 2c20 6d65 7468 6f64 2c20 7061  self, method, pa
+00009420: 7468 2c20 7175 6572 793d 4e6f 6e65 2c20  th, query=None, 
+00009430: 626f 6479 3d4e 6f6e 6529 3a0a 2020 2020  body=None):.    
+00009440: 2020 2020 7365 6c66 2e72 6571 7565 7374      self.request
+00009450: 732e 6170 7065 6e64 2828 6d65 7468 6f64  s.append((method
+00009460: 2c20 7061 7468 2c20 7175 6572 792c 2062  , path, query, b
+00009470: 6f64 7929 290a 2020 2020 2020 2020 7265  ody)).        re
+00009480: 7370 203d 2073 656c 662e 7265 7370 6f6e  sp = self.respon
+00009490: 7365 732e 706f 7028 3029 0a20 2020 2020  ses.pop(0).     
+000094a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000094b0: 2872 6573 702c 2045 7863 6570 7469 6f6e  (resp, Exception
+000094c0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000094d0: 6169 7365 2072 6573 700a 2020 2020 2020  aise resp.      
+000094e0: 2020 6966 2063 616c 6c61 626c 6528 7265    if callable(re
+000094f0: 7370 293a 0a20 2020 2020 2020 2020 2020  sp):.           
+00009500: 2072 6573 7020 3d20 7265 7370 2829 0a20   resp = resp(). 
+00009510: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00009520: 7370 0a0a 2020 2020 6465 6620 5f72 6571  sp..    def _req
+00009530: 7565 7374 5f72 6177 2873 656c 662c 206d  uest_raw(self, m
+00009540: 6574 686f 642c 2070 6174 682c 2071 7565  ethod, path, que
+00009550: 7279 3d4e 6f6e 652c 2068 6561 6465 7273  ry=None, headers
+00009560: 3d4e 6f6e 652c 2064 6174 613d 4e6f 6e65  =None, data=None
+00009570: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00009580: 7265 7175 6573 7473 2e61 7070 656e 6428  requests.append(
+00009590: 286d 6574 686f 642c 2070 6174 682c 2071  (method, path, q
+000095a0: 7565 7279 2c20 6865 6164 6572 732c 2064  uery, headers, d
+000095b0: 6174 6129 290a 2020 2020 2020 2020 6865  ata)).        he
+000095c0: 6164 6572 732c 2062 6f64 7920 3d20 7365  aders, body = se
+000095d0: 6c66 2e72 6573 706f 6e73 6573 2e70 6f70  lf.responses.pop
+000095e0: 2830 290a 2020 2020 2020 2020 7265 7475  (0).        retu
+000095f0: 726e 204d 6f63 6b48 5454 5052 6573 706f  rn MockHTTPRespo
+00009600: 6e73 6528 6865 6164 6572 732c 2062 6f64  nse(headers, bod
+00009610: 7929 0a0a 2020 2020 6465 6620 5f63 6f6e  y)..    def _con
+00009620: 6e65 6374 5f77 6562 736f 636b 6574 2873  nect_websocket(s
+00009630: 656c 662c 2074 6173 6b5f 6964 2c20 7765  elf, task_id, we
+00009640: 6273 6f63 6b65 745f 6964 293a 0a20 2020  bsocket_id):.   
+00009650: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00009660: 2e77 6562 736f 636b 6574 735b 7461 736b  .websockets[task
+00009670: 5f69 642c 2077 6562 736f 636b 6574 5f69  _id, websocket_i
+00009680: 645d 0a0a 0a63 6c61 7373 204d 6f63 6b48  d]...class MockH
+00009690: 5454 5052 6573 706f 6e73 653a 0a20 2020  TTPResponse:.   
+000096a0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+000096b0: 6c66 2c20 6865 6164 6572 732c 2062 6f64  lf, headers, bod
+000096c0: 7929 3a0a 2020 2020 2020 2020 7365 6c66  y):.        self
+000096d0: 2e68 6561 6465 7273 203d 2068 6561 6465  .headers = heade
+000096e0: 7273 0a20 2020 2020 2020 2072 6561 6465  rs.        reade
+000096f0: 7220 3d20 696f 2e42 7974 6573 494f 2862  r = io.BytesIO(b
+00009700: 6f64 7929 0a20 2020 2020 2020 2073 656c  ody).        sel
+00009710: 662e 7265 6164 203d 2072 6561 6465 722e  f.read = reader.
+00009720: 7265 6164 0a0a 0a63 6c61 7373 204d 6f63  read...class Moc
+00009730: 6b54 696d 653a 0a20 2020 2022 2222 4d6f  kTime:.    """Mo
+00009740: 636b 6564 2076 6572 7369 6f6e 7320 6f66  cked versions of
+00009750: 2074 696d 652e 7469 6d65 2829 2061 6e64   time.time() and
+00009760: 2074 696d 652e 736c 6565 7028 292e 0a0a   time.sleep()...
+00009770: 2020 2020 4d6f 636b 5469 6d65 2e73 6c65      MockTime.sle
+00009780: 6570 2829 2061 6476 616e 6365 7320 7468  ep() advances th
+00009790: 6520 636c 6f63 6b20 616e 6420 4d6f 636b  e clock and Mock
+000097a0: 5469 6d65 2e74 696d 6528 2920 7265 7475  Time.time() retu
+000097b0: 726e 7320 7468 6520 6375 7272 656e 7420  rns the current 
+000097c0: 7469 6d65 2e0a 2020 2020 2222 220a 0a20  time..    """.. 
+000097d0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+000097e0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+000097f0: 656c 662e 5f74 696d 6520 3d20 300a 0a20  elf._time = 0.. 
+00009800: 2020 2064 6566 2074 696d 6528 7365 6c66     def time(self
+00009810: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00009820: 6e20 7365 6c66 2e5f 7469 6d65 0a0a 2020  n self._time..  
+00009830: 2020 6465 6620 736c 6565 7028 7365 6c66    def sleep(self
+00009840: 2c20 6465 6c61 7929 3a0a 2020 2020 2020  , delay):.      
+00009850: 2020 7365 6c66 2e5f 7469 6d65 202b 3d20    self._time += 
+00009860: 6465 6c61 790a 0a0a 6465 6620 6275 696c  delay...def buil
+00009870: 645f 6d6f 636b 5f63 6861 6e67 655f 6469  d_mock_change_di
+00009880: 6374 2863 6861 6e67 655f 6964 3d27 3730  ct(change_id='70
+00009890: 2729 3a0a 2020 2020 7265 7475 726e 207b  '):.    return {
+000098a0: 0a20 2020 2020 2020 2022 6964 223a 2063  .        "id": c
+000098b0: 6861 6e67 655f 6964 2c0a 2020 2020 2020  hange_id,.      
+000098c0: 2020 226b 696e 6422 3a20 2261 7574 6f73    "kind": "autos
+000098d0: 7461 7274 222c 0a20 2020 2020 2020 2022  tart",.        "
+000098e0: 7265 6164 7922 3a20 5472 7565 2c0a 2020  ready": True,.  
+000098f0: 2020 2020 2020 2272 6561 6479 2d74 696d        "ready-tim
+00009900: 6522 3a20 2232 3032 312d 3031 2d32 3854  e": "2021-01-28T
+00009910: 3134 3a33 373a 3034 2e32 3931 3531 3737  14:37:04.2915177
+00009920: 3638 2b31 333a 3030 222c 0a20 2020 2020  68+13:00",.     
+00009930: 2020 2022 7370 6177 6e2d 7469 6d65 223a     "spawn-time":
+00009940: 2022 3230 3231 2d30 312d 3238 5431 343a   "2021-01-28T14:
+00009950: 3337 3a30 322e 3234 3732 3032 3130 352b  37:02.247202105+
+00009960: 3133 3a30 3022 2c0a 2020 2020 2020 2020  13:00",.        
+00009970: 2273 7461 7475 7322 3a20 2244 6f6e 6522  "status": "Done"
+00009980: 2c0a 2020 2020 2020 2020 2273 756d 6d61  ,.        "summa
+00009990: 7279 223a 2027 4175 746f 7374 6172 7420  ry": 'Autostart 
+000099a0: 7365 7276 6963 6520 2273 7663 2227 2c0a  service "svc"',.
+000099b0: 2020 2020 2020 2020 2274 6173 6b73 223a          "tasks":
+000099c0: 205b 0a20 2020 2020 2020 2020 2020 207b   [.            {
+000099d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000099e0: 2022 6964 223a 2022 3738 222c 0a20 2020   "id": "78",.   
+000099f0: 2020 2020 2020 2020 2020 2020 2022 6b69               "ki
+00009a00: 6e64 223a 2022 7374 6172 7422 2c0a 2020  nd": "start",.  
+00009a10: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+00009a20: 726f 6772 6573 7322 3a20 7b0a 2020 2020  rogress": {.    
+00009a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a40: 2264 6f6e 6522 3a20 312c 0a20 2020 2020  "done": 1,.     
+00009a50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00009a60: 6c61 6265 6c22 3a20 2222 2c0a 2020 2020  label": "",.    
 00009a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a80: 6d61 785f 6c6f 6f6b 6168 6561 643d 3820  max_lookahead=8 
-00009a90: 2a20 3130 3234 2c0a 2020 2020 2020 2020  * 1024,.        
-00009aa0: 2020 2020 2020 2020 6572 726f 723d 2727          error=''
-00009ab0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00009ac0: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
-00009ad0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00009ae0: 2e64 6174 6120 3d20 6461 7461 0a20 2020  .data = data.   
-00009af0: 2020 2020 2020 2020 2073 656c 662e 7761           self.wa
-00009b00: 6e74 5f68 6561 6465 7273 203d 2077 616e  nt_headers = wan
-00009b10: 745f 6865 6164 6572 730a 2020 2020 2020  t_headers.      
-00009b20: 2020 2020 2020 7365 6c66 2e77 616e 745f        self.want_
-00009b30: 626f 6469 6573 203d 2077 616e 745f 626f  bodies = want_bo
-00009b40: 6469 6573 0a20 2020 2020 2020 2020 2020  dies.           
-00009b50: 2073 656c 662e 7761 6e74 5f62 6f64 6965   self.want_bodie
-00009b60: 735f 646f 6e65 203d 2077 616e 745f 626f  s_done = want_bo
-00009b70: 6469 6573 5f64 6f6e 650a 2020 2020 2020  dies_done.      
-00009b80: 2020 2020 2020 7365 6c66 2e6d 6178 5f62        self.max_b
-00009b90: 6f75 6e64 6172 7920 3d20 6d61 785f 626f  oundary = max_bo
-00009ba0: 756e 6461 7279 0a20 2020 2020 2020 2020  undary.         
-00009bb0: 2020 2073 656c 662e 6d61 785f 6c6f 6f6b     self.max_look
-00009bc0: 6168 6561 6420 3d20 6d61 785f 6c6f 6f6b  ahead = max_look
-00009bd0: 6168 6561 640a 2020 2020 2020 2020 2020  ahead.          
-00009be0: 2020 7365 6c66 2e65 7272 6f72 203d 2065    self.error = e
-00009bf0: 7272 6f72 0a0a 2020 2020 6465 6620 7465  rror..    def te
-00009c00: 7374 5f6d 756c 7469 7061 7274 5f70 6172  st_multipart_par
-00009c10: 7365 7228 7365 6c66 293a 0a20 2020 2020  ser(self):.     
-00009c20: 2020 2074 6573 7473 203d 205b 0a20 2020     tests = [.   
-00009c30: 2020 2020 2020 2020 2054 6573 744d 756c           TestMul
-00009c40: 7469 7061 7274 5061 7273 6572 2e5f 4361  tipartParser._Ca
-00009c50: 7365 280a 2020 2020 2020 2020 2020 2020  se(.            
-00009c60: 2020 2020 2762 6173 656c 696e 6527 2c0a      'baseline',.
-00009c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c80: 6227 5c72 5c6e 2d2d 7177 6572 7479 5c72  b'\r\n--qwerty\r
-00009c90: 5c6e 6865 6164 6572 2066 6f6f 5c72 5c6e  \nheader foo\r\n
-00009ca0: 5c72 5c6e 666f 6f20 6261 725c 6e66 6f6f  \r\nfoo bar\nfoo
-00009cb0: 2062 6172 5c72 5c6e 2d2d 7177 6572 7479   bar\r\n--qwerty
-00009cc0: 2d2d 5c72 5c6e 272c 0a20 2020 2020 2020  --\r\n',.       
-00009cd0: 2020 2020 2020 2020 205b 6227 6865 6164           [b'head
-00009ce0: 6572 2066 6f6f 5c72 5c6e 5c72 5c6e 275d  er foo\r\n\r\n']
-00009cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009d00: 2020 5b62 2766 6f6f 2062 6172 5c6e 666f    [b'foo bar\nfo
-00009d10: 6f20 6261 7227 5d2c 0a20 2020 2020 2020  o bar'],.       
-00009d20: 2020 2020 2020 2020 2077 616e 745f 626f           want_bo
-00009d30: 6469 6573 5f64 6f6e 653d 5b54 7275 655d  dies_done=[True]
-00009d40: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-00009d50: 0a20 2020 2020 2020 2020 2020 2054 6573  .            Tes
-00009d60: 744d 756c 7469 7061 7274 5061 7273 6572  tMultipartParser
-00009d70: 2e5f 4361 7365 280a 2020 2020 2020 2020  ._Case(.        
-00009d80: 2020 2020 2020 2020 2769 6e63 6f6d 706c          'incompl
-00009d90: 6574 6520 6865 6164 6572 272c 0a20 2020  ete header',.   
-00009da0: 2020 2020 2020 2020 2020 2020 2062 275c               b'\
-00009db0: 725c 6e2d 2d71 7765 7274 795c 725c 6e68  r\n--qwerty\r\nh
-00009dc0: 6561 6465 7220 666f 6f5c 725c 6e27 2c0a  eader foo\r\n',.
-00009dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009de0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00009df0: 2020 2020 5b5d 2c0a 2020 2020 2020 2020      [],.        
-00009e00: 2020 2020 2020 2020 7761 6e74 5f62 6f64          want_bod
-00009e10: 6965 735f 646f 6e65 3d5b 5d2c 0a20 2020  ies_done=[],.   
-00009e20: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-00009e30: 2020 2020 2020 2020 5465 7374 4d75 6c74          TestMult
-00009e40: 6970 6172 7450 6172 7365 722e 5f43 6173  ipartParser._Cas
-00009e50: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00009e60: 2020 2027 6d69 7373 696e 6720 6865 6164     'missing head
-00009e70: 6572 272c 0a20 2020 2020 2020 2020 2020  er',.           
-00009e80: 2020 2020 2062 275c 725c 6e2d 2d71 7765       b'\r\n--qwe
-00009e90: 7274 795c 725c 6e68 6561 6465 7220 666f  rty\r\nheader fo
-00009ea0: 6f5c 725c 6e27 202b 2034 3020 2a20 6227  o\r\n' + 40 * b'
-00009eb0: 2027 2c0a 2020 2020 2020 2020 2020 2020   ',.            
-00009ec0: 2020 2020 5b5d 2c0a 2020 2020 2020 2020      [],.        
-00009ed0: 2020 2020 2020 2020 5b5d 2c0a 2020 2020          [],.    
-00009ee0: 2020 2020 2020 2020 2020 2020 7761 6e74              want
-00009ef0: 5f62 6f64 6965 735f 646f 6e65 3d5b 5d2c  _bodies_done=[],
-00009f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009f10: 206d 6178 5f6c 6f6f 6b61 6865 6164 3d34   max_lookahead=4
-00009f20: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00009f30: 2020 2065 7272 6f72 3d27 6865 6164 6572     error='header
-00009f40: 2074 6572 6d69 6e61 746f 7220 6e6f 7420   terminator not 
-00009f50: 666f 756e 6427 2c0a 2020 2020 2020 2020  found',.        
-00009f60: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00009f70: 2020 2054 6573 744d 756c 7469 7061 7274     TestMultipart
-00009f80: 5061 7273 6572 2e5f 4361 7365 280a 2020  Parser._Case(.  
-00009f90: 2020 2020 2020 2020 2020 2020 2020 2769                'i
-00009fa0: 6e63 6f6d 706c 6574 6520 626f 6479 2074  ncomplete body t
-00009fb0: 6572 6d69 6e61 746f 7227 2c0a 2020 2020  erminator',.    
-00009fc0: 2020 2020 2020 2020 2020 2020 6227 5c72              b'\r
-00009fd0: 5c6e 2d2d 7177 6572 7479 5c72 5c6e 6865  \n--qwerty\r\nhe
-00009fe0: 6164 6572 2066 6f6f 5c72 5c6e 5c72 5c6e  ader foo\r\n\r\n
-00009ff0: 666f 6f20 6261 725c 725c 6e2d 2d71 7765  foo bar\r\n--qwe
-0000a000: 7274 795c 7268 656c 6c6f 206d 7920 6e61  rty\rhello my na
-0000a010: 6d65 2069 7320 6a6f 6520 616e 6420 4920  me is joe and I 
-0000a020: 776f 726b 2069 6e20 6120 6275 7474 6f6e  work in a button
-0000a030: 2066 6163 746f 7279 272c 2020 2320 6e6f   factory',  # no
-0000a040: 7161 0a20 2020 2020 2020 2020 2020 2020  qa.             
-0000a050: 2020 205b 6227 6865 6164 6572 2066 6f6f     [b'header foo
-0000a060: 5c72 5c6e 5c72 5c6e 275d 2c0a 2020 2020  \r\n\r\n'],.    
-0000a070: 2020 2020 2020 2020 2020 2020 5b62 2766              [b'f
-0000a080: 6f6f 2062 6172 5c72 5c6e 2d2d 7177 6572  oo bar\r\n--qwer
-0000a090: 7479 5c72 6865 6c6c 6f20 6d79 206e 616d  ty\rhello my nam
-0000a0a0: 6520 6973 206a 6f65 2061 6e64 2049 2077  e is joe and I w
-0000a0b0: 6f72 6b20 696e 2061 2027 5d2c 0a20 2020  ork in a '],.   
-0000a0c0: 2020 2020 2020 2020 2020 2020 2077 616e               wan
-0000a0d0: 745f 626f 6469 6573 5f64 6f6e 653d 5b46  t_bodies_done=[F
-0000a0e0: 616c 7365 5d2c 0a20 2020 2020 2020 2020  alse],.         
-0000a0f0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-0000a100: 2020 5465 7374 4d75 6c74 6970 6172 7450    TestMultipartP
-0000a110: 6172 7365 722e 5f43 6173 6528 0a20 2020  arser._Case(.   
-0000a120: 2020 2020 2020 2020 2020 2020 2027 656d               'em
-0000a130: 7074 7920 626f 6479 272c 0a20 2020 2020  pty body',.     
-0000a140: 2020 2020 2020 2020 2020 2062 275c 725c             b'\r\
-0000a150: 6e2d 2d71 7765 7274 795c 725c 6e68 6561  n--qwerty\r\nhea
-0000a160: 6465 7220 666f 6f5c 725c 6e5c 725c 6e5c  der foo\r\n\r\n\
-0000a170: 725c 6e2d 2d71 7765 7274 795c 725c 6e27  r\n--qwerty\r\n'
-0000a180: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a190: 2020 5b62 2768 6561 6465 7220 666f 6f5c    [b'header foo\
-0000a1a0: 725c 6e5c 725c 6e27 5d2c 0a20 2020 2020  r\n\r\n'],.     
-0000a1b0: 2020 2020 2020 2020 2020 205b 6227 275d             [b'']
-0000a1c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a1d0: 2020 7761 6e74 5f62 6f64 6965 735f 646f    want_bodies_do
-0000a1e0: 6e65 3d5b 5472 7565 5d2c 0a20 2020 2020  ne=[True],.     
-0000a1f0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0000a200: 2020 2020 2020 5465 7374 4d75 6c74 6970        TestMultip
-0000a210: 6172 7450 6172 7365 722e 5f43 6173 6528  artParser._Case(
-0000a220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a230: 2027 6967 6e6f 7265 206c 6561 6469 6e67   'ignore leading
-0000a240: 2067 6172 6261 6765 272c 0a20 2020 2020   garbage',.     
-0000a250: 2020 2020 2020 2020 2020 2062 2768 656c             b'hel
-0000a260: 6c6f 206d 7920 6e61 6d65 2069 7320 6a6f  lo my name is jo
-0000a270: 655c 725c 6e5c 6e5c 6e5c 6e5c 725c 6e2d  e\r\n\n\n\n\r\n-
-0000a280: 2d71 7765 7274 795c 725c 6e68 6561 6465  -qwerty\r\nheade
-0000a290: 7220 666f 6f5c 725c 6e5c 725c 6e66 6f6f  r foo\r\n\r\nfoo
-0000a2a0: 2062 6172 5c72 5c6e 2d2d 7177 6572 7479   bar\r\n--qwerty
-0000a2b0: 5c72 5c6e 272c 2020 2320 6e6f 7161 0a20  \r\n',  # noqa. 
-0000a2c0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-0000a2d0: 6227 6865 6164 6572 2066 6f6f 5c72 5c6e  b'header foo\r\n
-0000a2e0: 5c72 5c6e 275d 2c0a 2020 2020 2020 2020  \r\n'],.        
-0000a2f0: 2020 2020 2020 2020 5b62 2766 6f6f 2062          [b'foo b
-0000a300: 6172 275d 2c0a 2020 2020 2020 2020 2020  ar'],.          
-0000a310: 2020 2020 2020 7761 6e74 5f62 6f64 6965        want_bodie
-0000a320: 735f 646f 6e65 3d5b 5472 7565 5d2c 0a20  s_done=[True],. 
-0000a330: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0000a340: 2020 2020 2020 2020 2020 5465 7374 4d75            TestMu
-0000a350: 6c74 6970 6172 7450 6172 7365 722e 5f43  ltipartParser._C
-0000a360: 6173 6528 0a20 2020 2020 2020 2020 2020  ase(.           
-0000a370: 2020 2020 2027 6967 6e6f 7265 2074 7261       'ignore tra
-0000a380: 696c 696e 6720 6761 7262 6167 6527 2c0a  iling garbage',.
-0000a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3a0: 6227 5c72 5c6e 2d2d 7177 6572 7479 5c72  b'\r\n--qwerty\r
-0000a3b0: 5c6e 6865 6164 6572 2066 6f6f 5c72 5c6e  \nheader foo\r\n
-0000a3c0: 5c72 5c6e 666f 6f20 6261 725c 725c 6e2d  \r\nfoo bar\r\n-
-0000a3d0: 2d71 7765 7274 795c 725c 6e68 656c 6c6f  -qwerty\r\nhello
-0000a3e0: 206d 7920 6e61 6d65 2069 7320 6a6f 6527   my name is joe'
-0000a3f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a400: 2020 5b62 2768 6561 6465 7220 666f 6f5c    [b'header foo\
-0000a410: 725c 6e5c 725c 6e27 5d2c 0a20 2020 2020  r\n\r\n'],.     
-0000a420: 2020 2020 2020 2020 2020 205b 6227 666f             [b'fo
-0000a430: 6f20 6261 7227 5d2c 0a20 2020 2020 2020  o bar'],.       
-0000a440: 2020 2020 2020 2020 2077 616e 745f 626f           want_bo
-0000a450: 6469 6573 5f64 6f6e 653d 5b54 7275 655d  dies_done=[True]
-0000a460: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-0000a470: 0a20 2020 2020 2020 2020 2020 2054 6573  .            Tes
-0000a480: 744d 756c 7469 7061 7274 5061 7273 6572  tMultipartParser
-0000a490: 2e5f 4361 7365 280a 2020 2020 2020 2020  ._Case(.        
-0000a4a0: 2020 2020 2020 2020 2762 6f75 6e64 6172          'boundar
-0000a4b0: 7920 616c 6c6f 7720 6c69 6e65 6172 2077  y allow linear w
-0000a4c0: 6869 7465 7370 6163 6527 2c0a 2020 2020  hitespace',.    
-0000a4d0: 2020 2020 2020 2020 2020 2020 6227 5c72              b'\r
-0000a4e0: 5c6e 2d2d 7177 6572 7479 205c 7420 5c72  \n--qwerty \t \r
-0000a4f0: 5c6e 6865 6164 6572 2066 6f6f 5c72 5c6e  \nheader foo\r\n
-0000a500: 5c72 5c6e 666f 6f20 6261 725c 725c 6e2d  \r\nfoo bar\r\n-
-0000a510: 2d71 7765 7274 795c 725c 6e27 2c0a 2020  -qwerty\r\n',.  
-0000a520: 2020 2020 2020 2020 2020 2020 2020 5b62                [b
-0000a530: 2768 6561 6465 7220 666f 6f5c 725c 6e5c  'header foo\r\n\
-0000a540: 725c 6e27 5d2c 0a20 2020 2020 2020 2020  r\n'],.         
-0000a550: 2020 2020 2020 205b 6227 666f 6f20 6261         [b'foo ba
-0000a560: 7227 5d2c 0a20 2020 2020 2020 2020 2020  r'],.           
-0000a570: 2020 2020 2077 616e 745f 626f 6469 6573       want_bodies
-0000a580: 5f64 6f6e 653d 5b54 7275 655d 2c0a 2020  _done=[True],.  
-0000a590: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0000a5a0: 785f 626f 756e 6461 7279 3d32 302c 0a20  x_boundary=20,. 
-0000a5b0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0000a5c0: 2020 2020 2020 2020 2020 5465 7374 4d75            TestMu
-0000a5d0: 6c74 6970 6172 7450 6172 7365 722e 5f43  ltipartParser._C
-0000a5e0: 6173 6528 0a20 2020 2020 2020 2020 2020  ase(.           
-0000a5f0: 2020 2020 2027 7465 726d 696e 616c 2062       'terminal b
-0000a600: 6f75 6e64 6172 7920 616c 6c6f 7720 6c69  oundary allow li
-0000a610: 6e65 6172 2077 6869 7465 7370 6163 6527  near whitespace'
-0000a620: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a630: 2020 6227 5c72 5c6e 2d2d 7177 6572 7479    b'\r\n--qwerty
-0000a640: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
-0000a650: 5c6e 5c72 5c6e 666f 6f20 6261 725c 725c  \n\r\nfoo bar\r\
-0000a660: 6e2d 2d71 7765 7274 792d 2d20 5c74 205c  n--qwerty-- \t \
-0000a670: 725c 6e27 2c0a 2020 2020 2020 2020 2020  r\n',.          
-0000a680: 2020 2020 2020 5b62 2768 6561 6465 7220        [b'header 
-0000a690: 666f 6f5c 725c 6e5c 725c 6e27 5d2c 0a20  foo\r\n\r\n'],. 
-0000a6a0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-0000a6b0: 6227 666f 6f20 6261 7227 5d2c 0a20 2020  b'foo bar'],.   
-0000a6c0: 2020 2020 2020 2020 2020 2020 2077 616e               wan
-0000a6d0: 745f 626f 6469 6573 5f64 6f6e 653d 5b54  t_bodies_done=[T
-0000a6e0: 7275 655d 2c0a 2020 2020 2020 2020 2020  rue],.          
-0000a6f0: 2020 2020 2020 6d61 785f 626f 756e 6461        max_bounda
-0000a700: 7279 3d32 302c 0a20 2020 2020 2020 2020  ry=20,.         
-0000a710: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-0000a720: 2020 5465 7374 4d75 6c74 6970 6172 7450    TestMultipartP
-0000a730: 6172 7365 722e 5f43 6173 6528 0a20 2020  arser._Case(.   
-0000a740: 2020 2020 2020 2020 2020 2020 2027 6d75               'mu
-0000a750: 6c74 6970 6c65 2070 6172 7473 272c 0a20  ltiple parts',. 
-0000a760: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000a770: 275c 725c 6e2d 2d71 7765 7274 7920 5c74  '\r\n--qwerty \t
-0000a780: 205c 725c 6e68 6561 6465 7220 666f 6f5c   \r\nheader foo\
-0000a790: 725c 6e5c 725c 6e66 6f6f 2062 6172 5c72  r\n\r\nfoo bar\r
-0000a7a0: 5c6e 2d2d 7177 6572 7479 5c72 5c6e 6865  \n--qwerty\r\nhe
-0000a7b0: 6164 6572 2062 6172 5c72 5c6e 5c72 5c6e  ader bar\r\n\r\n
-0000a7c0: 666f 6f20 6261 7a5c 725c 6e2d 2d71 7765  foo baz\r\n--qwe
-0000a7d0: 7274 792d 2d5c 725c 6e27 2c20 2023 206e  rty--\r\n',  # n
-0000a7e0: 6f71 610a 2020 2020 2020 2020 2020 2020  oqa.            
-0000a7f0: 2020 2020 5b62 2768 6561 6465 7220 666f      [b'header fo
-0000a800: 6f5c 725c 6e5c 725c 6e27 2c20 6227 6865  o\r\n\r\n', b'he
-0000a810: 6164 6572 2062 6172 5c72 5c6e 5c72 5c6e  ader bar\r\n\r\n
-0000a820: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0000a830: 2020 2020 5b62 2766 6f6f 2062 6172 272c      [b'foo bar',
-0000a840: 2062 2766 6f6f 2062 617a 275d 2c0a 2020   b'foo baz'],.  
-0000a850: 2020 2020 2020 2020 2020 2020 2020 7761                wa
-0000a860: 6e74 5f62 6f64 6965 735f 646f 6e65 3d5b  nt_bodies_done=[
-0000a870: 5472 7565 2c20 5472 7565 5d2c 0a20 2020  True, True],.   
-0000a880: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0000a890: 2020 2020 2020 2020 5465 7374 4d75 6c74          TestMult
-0000a8a0: 6970 6172 7450 6172 7365 722e 5f43 6173  ipartParser._Cas
-0000a8b0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0000a8c0: 2020 2027 6967 6e6f 7265 2061 6674 6572     'ignore after
-0000a8d0: 2074 6572 6d69 6e61 6c20 626f 756e 6461   terminal bounda
-0000a8e0: 7279 272c 0a20 2020 2020 2020 2020 2020  ry',.           
-0000a8f0: 2020 2020 2062 275c 725c 6e2d 2d71 7765       b'\r\n--qwe
-0000a900: 7274 7920 5c74 205c 725c 6e68 6561 6465  rty \t \r\nheade
-0000a910: 7220 666f 6f5c 725c 6e5c 725c 6e66 6f6f  r foo\r\n\r\nfoo
-0000a920: 2062 6172 5c72 5c6e 2d2d 7177 6572 7479   bar\r\n--qwerty
-0000a930: 2d2d 5c72 5c6e 6865 6164 6572 2062 6172  --\r\nheader bar
-0000a940: 5c72 5c6e 5c72 5c6e 666f 6f20 6261 7a5c  \r\n\r\nfoo baz\
-0000a950: 725c 6e2d 2d71 7765 7274 792d 2d5c 725c  r\n--qwerty--\r\
-0000a960: 6e27 2c20 2023 206e 6f71 610a 2020 2020  n',  # noqa.    
-0000a970: 2020 2020 2020 2020 2020 2020 5b62 2768              [b'h
-0000a980: 6561 6465 7220 666f 6f5c 725c 6e5c 725c  eader foo\r\n\r\
-0000a990: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
-0000a9a0: 2020 2020 205b 6227 666f 6f20 6261 7227       [b'foo bar'
-0000a9b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000a9c0: 2020 2077 616e 745f 626f 6469 6573 5f64     want_bodies_d
-0000a9d0: 6f6e 653d 5b54 7275 655d 2c0a 2020 2020  one=[True],.    
-0000a9e0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0000a9f0: 2020 205d 0a0a 2020 2020 2020 2020 6368     ]..        ch
-0000aa00: 756e 6b5f 7369 7a65 7320 3d20 5b31 2c20  unk_sizes = [1, 
-0000aa10: 322c 2033 2c20 342c 2035 2c20 372c 2031  2, 3, 4, 5, 7, 1
-0000aa20: 332c 2031 372c 2031 392c 2032 332c 2032  3, 17, 19, 23, 2
-0000aa30: 392c 2033 312c 2033 372c 2034 322c 2035  9, 31, 37, 42, 5
-0000aa40: 302c 2031 3030 2c20 3130 3030 5d0a 2020  0, 100, 1000].  
-0000aa50: 2020 2020 2020 6d61 726b 6572 203d 2062        marker = b
-0000aa60: 2771 7765 7274 7927 0a20 2020 2020 2020  'qwerty'.       
-0000aa70: 2066 6f72 2069 2c20 7465 7374 2069 6e20   for i, test in 
-0000aa80: 656e 756d 6572 6174 6528 7465 7374 7329  enumerate(tests)
-0000aa90: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-0000aaa0: 7220 6368 756e 6b5f 7369 7a65 2069 6e20  r chunk_size in 
-0000aab0: 6368 756e 6b5f 7369 7a65 733a 0a20 2020  chunk_sizes:.   
-0000aac0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-0000aad0: 6465 7273 203d 205b 5d0a 2020 2020 2020  ders = [].      
-0000aae0: 2020 2020 2020 2020 2020 626f 6469 6573            bodies
-0000aaf0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-0000ab00: 2020 2020 2020 626f 6469 6573 5f64 6f6e        bodies_don
-0000ab10: 6520 3d20 5b5d 0a0a 2020 2020 2020 2020  e = []..        
-0000ab20: 2020 2020 2020 2020 6465 6620 6861 6e64          def hand
-0000ab30: 6c65 5f68 6561 6465 7228 6461 7461 293a  le_header(data):
-0000ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ab50: 2020 2020 2068 6561 6465 7273 2e61 7070       headers.app
-0000ab60: 656e 6428 6279 7465 7328 6461 7461 2929  end(bytes(data))
-0000ab70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ab80: 2020 2020 2062 6f64 6965 732e 6170 7065       bodies.appe
-0000ab90: 6e64 2862 2727 290a 2020 2020 2020 2020  nd(b'').        
-0000aba0: 2020 2020 2020 2020 2020 2020 626f 6469              bodi
-0000abb0: 6573 5f64 6f6e 652e 6170 7065 6e64 2846  es_done.append(F
-0000abc0: 616c 7365 290a 0a20 2020 2020 2020 2020  alse)..         
-0000abd0: 2020 2020 2020 2064 6566 2068 616e 646c         def handl
-0000abe0: 655f 626f 6479 2864 6174 612c 2064 6f6e  e_body(data, don
-0000abf0: 653d 4661 6c73 6529 3a0a 2020 2020 2020  e=False):.      
-0000ac00: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-0000ac10: 6469 6573 5b2d 315d 202b 3d20 6461 7461  dies[-1] += data
-0000ac20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ac30: 2020 2020 2062 6f64 6965 735f 646f 6e65       bodies_done
-0000ac40: 5b2d 315d 203d 2064 6f6e 650a 0a20 2020  [-1] = done..   
-0000ac50: 2020 2020 2020 2020 2020 2020 2070 6172               par
-0000ac60: 7365 7220 3d20 7065 6262 6c65 2e5f 4d75  ser = pebble._Mu
-0000ac70: 6c74 6970 6172 7450 6172 7365 7228 0a20  ltipartParser(. 
-0000ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac90: 2020 206d 6172 6b65 722c 0a20 2020 2020     marker,.     
-0000aca0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0000acb0: 616e 646c 655f 6865 6164 6572 2c0a 2020  andle_header,.  
-0000acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000acd0: 2020 6861 6e64 6c65 5f62 6f64 792c 0a20    handle_body,. 
-0000ace0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000acf0: 2020 206d 6178 5f62 6f75 6e64 6172 795f     max_boundary_
-0000ad00: 6c65 6e67 7468 3d74 6573 742e 6d61 785f  length=test.max_
-0000ad10: 626f 756e 6461 7279 2c0a 2020 2020 2020  boundary,.      
-0000ad20: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0000ad30: 785f 6c6f 6f6b 6168 6561 643d 7465 7374  x_lookahead=test
-0000ad40: 2e6d 6178 5f6c 6f6f 6b61 6865 6164 290a  .max_lookahead).
-0000ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad60: 7372 6320 3d20 696f 2e42 7974 6573 494f  src = io.BytesIO
-0000ad70: 2874 6573 742e 6461 7461 290a 0a20 2020  (test.data)..   
-0000ad80: 2020 2020 2020 2020 2020 2020 2074 7279               try
-0000ad90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ada0: 2020 2020 2020 7768 696c 6520 5472 7565        while True
-0000adb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000adc0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-0000add0: 2073 7263 2e72 6561 6428 6368 756e 6b5f   src.read(chunk_
-0000ade0: 7369 7a65 290a 2020 2020 2020 2020 2020  size).          
-0000adf0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000ae00: 206e 6f74 2064 6174 613a 0a20 2020 2020   not data:.     
-0000ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae20: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-0000ae30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae40: 2020 2020 2070 6172 7365 722e 6665 6564       parser.feed
-0000ae50: 2864 6174 6129 0a20 2020 2020 2020 2020  (data).         
-0000ae60: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0000ae70: 6365 7074 696f 6e20 6173 2065 7272 3a0a  ception as err:.
-0000ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae90: 2020 2020 6966 206e 6f74 2074 6573 742e      if not test.
-0000aea0: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
-0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000aec0: 656c 662e 6661 696c 2827 756e 6578 7065  elf.fail('unexpe
-0000aed0: 6374 6564 2065 7272 6f72 3a27 2c20 6572  cted error:', er
-0000aee0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0000aef0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0000af00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000af10: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000af20: 4571 7561 6c28 7465 7374 2e65 7272 6f72  Equal(test.error
-0000af30: 2c20 7374 7228 6572 7229 290a 2020 2020  , str(err)).    
-0000af40: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000af50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000af60: 2020 2020 2020 6966 2074 6573 742e 6572        if test.er
-0000af70: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0000af80: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000af90: 662e 6661 696c 2866 276d 6973 7369 6e67  f.fail(f'missing
-0000afa0: 2065 7870 6563 7465 6420 6572 726f 723a   expected error:
-0000afb0: 207b 7465 7374 2e65 7272 6f72 2172 7d27   {test.error!r}'
-0000afc0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000afd0: 2020 2020 2020 206d 7367 203d 2066 2774         msg = f't
-0000afe0: 6573 7420 6361 7365 207b 6920 2b20 317d  est case {i + 1}
-0000aff0: 2028 7b74 6573 742e 6e61 6d65 7d29 2c20   ({test.name}), 
-0000b000: 6368 756e 6b20 7369 7a65 207b 6368 756e  chunk size {chun
-0000b010: 6b5f 7369 7a65 7d27 0a20 2020 2020 2020  k_size}'.       
-0000b020: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000b030: 662e 6173 7365 7274 4571 7561 6c28 7465  f.assertEqual(te
-0000b040: 7374 2e77 616e 745f 6865 6164 6572 732c  st.want_headers,
-0000b050: 2068 6561 6465 7273 2c20 6d73 6729 0a20   headers, msg). 
-0000b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b070: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000b080: 7561 6c28 7465 7374 2e77 616e 745f 626f  ual(test.want_bo
-0000b090: 6469 6573 2c20 626f 6469 6573 2c20 6d73  dies, bodies, ms
-0000b0a0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-0000b0b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000b0c0: 7274 4571 7561 6c28 7465 7374 2e77 616e  rtEqual(test.wan
-0000b0d0: 745f 626f 6469 6573 5f64 6f6e 652c 2062  t_bodies_done, b
-0000b0e0: 6f64 6965 735f 646f 6e65 2c20 6d73 6729  odies_done, msg)
-0000b0f0: 0a0a 0a63 6c61 7373 2054 6573 7443 6c69  ...class TestCli
-0000b100: 656e 7428 756e 6974 7465 7374 2e54 6573  ent(unittest.Tes
-0000b110: 7443 6173 6529 3a0a 2020 2020 6d61 7844  tCase):.    maxD
-0000b120: 6966 6620 3d20 4e6f 6e65 0a0a 2020 2020  iff = None..    
-0000b130: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
-0000b140: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-0000b150: 6965 6e74 203d 204d 6f63 6b43 6c69 656e  ient = MockClien
-0000b160: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000b170: 2e74 696d 6520 3d20 4d6f 636b 5469 6d65  .time = MockTime
-0000b180: 2829 0a20 2020 2020 2020 2074 696d 655f  ().        time_
-0000b190: 7061 7463 6865 7220 3d20 756e 6974 7465  patcher = unitte
-0000b1a0: 7374 2e6d 6f63 6b2e 7061 7463 6828 276f  st.mock.patch('o
-0000b1b0: 7073 2e70 6562 626c 652e 7469 6d65 272c  ps.pebble.time',
-0000b1c0: 2073 656c 662e 7469 6d65 290a 2020 2020   self.time).    
-0000b1d0: 2020 2020 7469 6d65 5f70 6174 6368 6572      time_patcher
-0000b1e0: 2e73 7461 7274 2829 0a20 2020 2020 2020  .start().       
-0000b1f0: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0000b200: 2874 696d 655f 7061 7463 6865 722e 7374  (time_patcher.st
-0000b210: 6f70 290a 0a20 2020 2064 6566 2074 6573  op)..    def tes
-0000b220: 745f 636c 6965 6e74 5f69 6e69 7428 7365  t_client_init(se
-0000b230: 6c66 293a 0a20 2020 2020 2020 2070 6562  lf):.        peb
-0000b240: 626c 652e 436c 6965 6e74 2873 6f63 6b65  ble.Client(socke
-0000b250: 745f 7061 7468 3d27 666f 6f27 2920 2023  t_path='foo')  #
-0000b260: 2074 6573 7420 7468 6174 2063 6f6e 7374   test that const
-0000b270: 7275 6374 6f72 2072 756e 730a 2020 2020  ructor runs.    
-0000b280: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000b290: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-0000b2a0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000b2b0: 2020 2070 6562 626c 652e 436c 6965 6e74     pebble.Client
-0000b2c0: 2829 2020 2320 736f 636b 6574 5f70 6174  ()  # socket_pat
-0000b2d0: 6820 6172 6720 7265 7175 6972 6564 0a0a  h arg required..
-0000b2e0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
-0000b2f0: 5f73 7973 7465 6d5f 696e 666f 2873 656c  _system_info(sel
-0000b300: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-0000b310: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-0000b320: 732e 6170 7065 6e64 287b 0a20 2020 2020  s.append({.     
-0000b330: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
-0000b340: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0000b350: 2020 2022 7665 7273 696f 6e22 3a20 2231     "version": "1
-0000b360: 2e32 2e33 222c 0a20 2020 2020 2020 2020  .2.3",.         
-0000b370: 2020 2020 2020 2022 6578 7472 612d 6669         "extra-fi
-0000b380: 656c 6422 3a20 2266 6f6f 222c 0a20 2020  eld": "foo",.   
-0000b390: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-0000b3a0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000b3b0: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000b3c0: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000b3d0: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000b3e0: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000b3f0: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
-0000b400: 2020 2020 2020 696e 666f 203d 2073 656c        info = sel
-0000b410: 662e 636c 6965 6e74 2e67 6574 5f73 7973  f.client.get_sys
-0000b420: 7465 6d5f 696e 666f 2829 0a20 2020 2020  tem_info().     
-0000b430: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000b440: 7561 6c28 696e 666f 2e76 6572 7369 6f6e  ual(info.version
-0000b450: 2c20 2731 2e32 2e33 2729 0a20 2020 2020  , '1.2.3').     
-0000b460: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000b470: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-0000b480: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000b490: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-0000b4a0: 272f 7631 2f73 7973 7465 6d2d 696e 666f  '/v1/system-info
-0000b4b0: 272c 204e 6f6e 652c 204e 6f6e 6529 2c0a  ', None, None),.
-0000b4c0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-0000b4d0: 6465 6620 7465 7374 5f67 6574 5f77 6172  def test_get_war
-0000b4e0: 6e69 6e67 7328 7365 6c66 293a 0a20 2020  nings(self):.   
-0000b4f0: 2020 2020 2065 6d70 7479 203d 207b 0a20       empty = {. 
-0000b500: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
-0000b510: 6c74 223a 205b 5d2c 0a20 2020 2020 2020  lt": [],.       
-0000b520: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
-0000b530: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
-0000b540: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
-0000b550: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
-0000b560: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
-0000b570: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0000b580: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000b590: 7370 6f6e 7365 732e 6170 7065 6e64 2865  sponses.append(e
-0000b5a0: 6d70 7479 290a 2020 2020 2020 2020 7761  mpty).        wa
-0000b5b0: 726e 696e 6773 203d 2073 656c 662e 636c  rnings = self.cl
-0000b5c0: 6965 6e74 2e67 6574 5f77 6172 6e69 6e67  ient.get_warning
-0000b5d0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-0000b5e0: 2e61 7373 6572 7445 7175 616c 2877 6172  .assertEqual(war
-0000b5f0: 6e69 6e67 732c 205b 5d29 0a0a 2020 2020  nings, [])..    
-0000b600: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000b610: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000b620: 2865 6d70 7479 290a 2020 2020 2020 2020  (empty).        
-0000b630: 7761 726e 696e 6773 203d 2073 656c 662e  warnings = self.
-0000b640: 636c 6965 6e74 2e67 6574 5f77 6172 6e69  client.get_warni
-0000b650: 6e67 7328 7365 6c65 6374 3d70 6562 626c  ngs(select=pebbl
-0000b660: 652e 5761 726e 696e 6753 7461 7465 2e41  e.WarningState.A
-0000b670: 4c4c 290a 2020 2020 2020 2020 7365 6c66  LL).        self
-0000b680: 2e61 7373 6572 7445 7175 616c 2877 6172  .assertEqual(war
-0000b690: 6e69 6e67 732c 205b 5d29 0a0a 2020 2020  nings, [])..    
-0000b6a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000b6b0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-0000b6c0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-0000b6d0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0000b6e0: 2027 2f76 312f 7761 726e 696e 6773 272c   '/v1/warnings',
-0000b6f0: 207b 2773 656c 6563 7427 3a20 2770 656e   {'select': 'pen
-0000b700: 6469 6e67 277d 2c20 4e6f 6e65 292c 0a20  ding'}, None),. 
-0000b710: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-0000b720: 272c 2027 2f76 312f 7761 726e 696e 6773  ', '/v1/warnings
-0000b730: 272c 207b 2773 656c 6563 7427 3a20 2761  ', {'select': 'a
-0000b740: 6c6c 277d 2c20 4e6f 6e65 292c 0a20 2020  ll'}, None),.   
-0000b750: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-0000b760: 2074 6573 745f 6163 6b5f 7761 726e 696e   test_ack_warnin
-0000b770: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
-0000b780: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000b790: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-0000b7a0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-0000b7b0: 7375 6c74 223a 2030 2c0a 2020 2020 2020  sult": 0,.      
-0000b7c0: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-0000b7d0: 224f 4b22 2c0a 2020 2020 2020 2020 2020  "OK",.          
-0000b7e0: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
-0000b7f0: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
-0000b800: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
-0000b810: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-0000b820: 2020 2020 6e75 6d20 3d20 7365 6c66 2e63      num = self.c
-0000b830: 6c69 656e 742e 6163 6b5f 7761 726e 696e  lient.ack_warnin
-0000b840: 6773 2864 6174 6574 696d 655f 6e7a 6474  gs(datetime_nzdt
-0000b850: 2832 3032 312c 2031 2c20 3238 2c20 3135  (2021, 1, 28, 15
-0000b860: 2c20 3131 2c20 3029 290a 2020 2020 2020  , 11, 0)).      
-0000b870: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000b880: 616c 286e 756d 2c20 3029 0a20 2020 2020  al(num, 0).     
-0000b890: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000b8a0: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-0000b8b0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0000b8c0: 2020 2020 2020 2020 2827 504f 5354 272c          ('POST',
-0000b8d0: 2027 2f76 312f 7761 726e 696e 6773 272c   '/v1/warnings',
-0000b8e0: 204e 6f6e 652c 207b 0a20 2020 2020 2020   None, {.       
-0000b8f0: 2020 2020 2020 2020 2027 6163 7469 6f6e           'action
-0000b900: 273a 2027 6f6b 6179 272c 0a20 2020 2020  ': 'okay',.     
-0000b910: 2020 2020 2020 2020 2020 2027 7469 6d65             'time
-0000b920: 7374 616d 7027 3a20 2732 3032 312d 3031  stamp': '2021-01
-0000b930: 2d32 3854 3135 3a31 313a 3030 2b31 333a  -28T15:11:00+13:
-0000b940: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-0000b950: 207d 292c 0a20 2020 2020 2020 205d 290a   }),.        ]).
-0000b960: 0a20 2020 2064 6566 2061 7373 6572 745f  .    def assert_
-0000b970: 6d6f 636b 5f63 6861 6e67 6528 7365 6c66  mock_change(self
-0000b980: 2c20 6368 616e 6765 293a 0a20 2020 2020  , change):.     
-0000b990: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000b9a0: 7561 6c28 6368 616e 6765 2e69 642c 2027  ual(change.id, '
-0000b9b0: 3730 2729 0a20 2020 2020 2020 2073 656c  70').        sel
-0000b9c0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000b9d0: 616e 6765 2e6b 696e 642c 2027 6175 746f  ange.kind, 'auto
-0000b9e0: 7374 6172 7427 290a 2020 2020 2020 2020  start').        
-0000b9f0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ba00: 2863 6861 6e67 652e 7375 6d6d 6172 792c  (change.summary,
-0000ba10: 2027 4175 746f 7374 6172 7420 7365 7276   'Autostart serv
-0000ba20: 6963 6520 2273 7663 2227 290a 2020 2020  ice "svc"').    
-0000ba30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000ba40: 7175 616c 2863 6861 6e67 652e 7374 6174  qual(change.stat
-0000ba50: 7573 2c20 2744 6f6e 6527 290a 2020 2020  us, 'Done').    
-0000ba60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000ba70: 7175 616c 286c 656e 2863 6861 6e67 652e  qual(len(change.
-0000ba80: 7461 736b 7329 2c20 3129 0a20 2020 2020  tasks), 1).     
-0000ba90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000baa0: 7561 6c28 6368 616e 6765 2e74 6173 6b73  ual(change.tasks
-0000bab0: 5b30 5d2e 6964 2c20 2737 3827 290a 2020  [0].id, '78').  
-0000bac0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000bad0: 7445 7175 616c 2863 6861 6e67 652e 7461  tEqual(change.ta
-0000bae0: 736b 735b 305d 2e6b 696e 642c 2027 7374  sks[0].kind, 'st
-0000baf0: 6172 7427 290a 2020 2020 2020 2020 7365  art').        se
-0000bb00: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0000bb10: 6861 6e67 652e 7461 736b 735b 305d 2e73  hange.tasks[0].s
-0000bb20: 756d 6d61 7279 2c20 2753 7461 7274 2073  ummary, 'Start s
-0000bb30: 6572 7669 6365 2022 7376 6322 2729 0a20  ervice "svc"'). 
-0000bb40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000bb50: 7274 4571 7561 6c28 6368 616e 6765 2e74  rtEqual(change.t
-0000bb60: 6173 6b73 5b30 5d2e 7374 6174 7573 2c20  asks[0].status, 
-0000bb70: 2744 6f6e 6527 290a 2020 2020 2020 2020  'Done').        
-0000bb80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000bb90: 2863 6861 6e67 652e 7461 736b 735b 305d  (change.tasks[0]
-0000bba0: 2e6c 6f67 2c20 5b5d 290a 2020 2020 2020  .log, []).      
-0000bbb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000bbc0: 616c 2863 6861 6e67 652e 7461 736b 735b  al(change.tasks[
-0000bbd0: 305d 2e70 726f 6772 6573 732e 646f 6e65  0].progress.done
-0000bbe0: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
-0000bbf0: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000bc00: 616e 6765 2e74 6173 6b73 5b30 5d2e 7072  ange.tasks[0].pr
-0000bc10: 6f67 7265 7373 2e6c 6162 656c 2c20 2727  ogress.label, ''
-0000bc20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000bc30: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
-0000bc40: 652e 7461 736b 735b 305d 2e70 726f 6772  e.tasks[0].progr
-0000bc50: 6573 732e 746f 7461 6c2c 2031 290a 2020  ess.total, 1).  
-0000bc60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000bc70: 7445 7175 616c 2863 6861 6e67 652e 7461  tEqual(change.ta
-0000bc80: 736b 735b 305d 2e72 6561 6479 5f74 696d  sks[0].ready_tim
-0000bc90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000bca0: 2020 2020 2020 2020 2020 2020 6461 7465              date
-0000bcb0: 7469 6d65 5f6e 7a64 7428 3230 3231 2c20  time_nzdt(2021, 
-0000bcc0: 312c 2032 382c 2031 342c 2033 372c 2033  1, 28, 14, 37, 3
-0000bcd0: 2c20 3237 3032 3139 2929 0a20 2020 2020  , 270219)).     
-0000bce0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000bcf0: 7561 6c28 6368 616e 6765 2e74 6173 6b73  ual(change.tasks
-0000bd00: 5b30 5d2e 7370 6177 6e5f 7469 6d65 2c0a  [0].spawn_time,.
-0000bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd20: 2020 2020 2020 2020 2064 6174 6574 696d           datetim
-0000bd30: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
-0000bd40: 3238 2c20 3134 2c20 3337 2c20 322c 2032  28, 14, 37, 2, 2
-0000bd50: 3437 3135 3829 290a 2020 2020 2020 2020  47158)).        
-0000bd60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000bd70: 2863 6861 6e67 652e 7265 6164 792c 2054  (change.ready, T
-0000bd80: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-0000bd90: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0000bda0: 616e 6765 2e65 7272 2c20 4e6f 6e65 290a  ange.err, None).
-0000bdb0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000bdc0: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
-0000bdd0: 7265 6164 795f 7469 6d65 2c20 6461 7465  ready_time, date
-0000bde0: 7469 6d65 5f6e 7a64 7428 3230 3231 2c20  time_nzdt(2021, 
-0000bdf0: 312c 2032 382c 2031 342c 2033 372c 2034  1, 28, 14, 37, 4
-0000be00: 2c20 3239 3135 3138 2929 0a20 2020 2020  , 291518)).     
-0000be10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000be20: 7561 6c28 6368 616e 6765 2e73 7061 776e  ual(change.spawn
-0000be30: 5f74 696d 652c 2064 6174 6574 696d 655f  _time, datetime_
-0000be40: 6e7a 6474 2832 3032 312c 2031 2c20 3238  nzdt(2021, 1, 28
-0000be50: 2c20 3134 2c20 3337 2c20 322c 2032 3437  , 14, 37, 2, 247
-0000be60: 3230 3229 290a 0a20 2020 2064 6566 2074  202))..    def t
-0000be70: 6573 745f 6765 745f 6368 616e 6765 7328  est_get_changes(
-0000be80: 7365 6c66 293a 0a20 2020 2020 2020 2065  self):.        e
-0000be90: 6d70 7479 203d 207b 0a20 2020 2020 2020  mpty = {.       
-0000bea0: 2020 2020 2022 7265 7375 6c74 223a 205b       "result": [
-0000beb0: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-0000bec0: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
-0000bed0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-0000bee0: 7573 2d63 6f64 6522 3a20 3230 302c 0a20  us-code": 200,. 
-0000bef0: 2020 2020 2020 2020 2020 2022 7479 7065             "type
-0000bf00: 223a 2022 7379 6e63 220a 2020 2020 2020  ": "sync".      
-0000bf10: 2020 7d0a 2020 2020 2020 2020 7365 6c66    }.        self
-0000bf20: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-0000bf30: 732e 6170 7065 6e64 2865 6d70 7479 290a  s.append(empty).
-0000bf40: 2020 2020 2020 2020 6368 616e 6765 7320          changes 
-0000bf50: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
-0000bf60: 745f 6368 616e 6765 7328 290a 2020 2020  t_changes().    
-0000bf70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000bf80: 7175 616c 2863 6861 6e67 6573 2c20 5b5d  qual(changes, []
-0000bf90: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000bfa0: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
-0000bfb0: 2e61 7070 656e 6428 656d 7074 7929 0a20  .append(empty). 
-0000bfc0: 2020 2020 2020 2063 6861 6e67 6573 203d         changes =
-0000bfd0: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
-0000bfe0: 5f63 6861 6e67 6573 2873 656c 6563 743d  _changes(select=
-0000bff0: 7065 6262 6c65 2e43 6861 6e67 6553 7461  pebble.ChangeSta
-0000c000: 7465 2e41 4c4c 290a 2020 2020 2020 2020  te.ALL).        
-0000c010: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000c020: 2863 6861 6e67 6573 2c20 5b5d 290a 0a20  (changes, []).. 
-0000c030: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0000c040: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-0000c050: 656e 6428 656d 7074 7929 0a20 2020 2020  end(empty).     
-0000c060: 2020 2063 6861 6e67 6573 203d 2073 656c     changes = sel
-0000c070: 662e 636c 6965 6e74 2e67 6574 5f63 6861  f.client.get_cha
-0000c080: 6e67 6573 2873 656c 6563 743d 7065 6262  nges(select=pebb
-0000c090: 6c65 2e43 6861 6e67 6553 7461 7465 2e41  le.ChangeState.A
-0000c0a0: 4c4c 2c20 7365 7276 6963 653d 2766 6f6f  LL, service='foo
-0000c0b0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000c0c0: 6173 7365 7274 4571 7561 6c28 6368 616e  assertEqual(chan
-0000c0d0: 6765 732c 205b 5d29 0a0a 2020 2020 2020  ges, [])..      
-0000c0e0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000c0f0: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-0000c100: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-0000c110: 7375 6c74 223a 205b 0a20 2020 2020 2020  sult": [.       
-0000c120: 2020 2020 2020 2020 2062 7569 6c64 5f6d           build_m
-0000c130: 6f63 6b5f 6368 616e 6765 5f64 6963 7428  ock_change_dict(
-0000c140: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
-0000c150: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0000c160: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
-0000c170: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-0000c180: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
-0000c190: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
-0000c1a0: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
-0000c1b0: 207d 290a 2020 2020 2020 2020 6368 616e   }).        chan
-0000c1c0: 6765 7320 3d20 7365 6c66 2e63 6c69 656e  ges = self.clien
-0000c1d0: 742e 6765 745f 6368 616e 6765 7328 290a  t.get_changes().
-0000c1e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000c1f0: 6572 7445 7175 616c 286c 656e 2863 6861  ertEqual(len(cha
-0000c200: 6e67 6573 292c 2031 290a 2020 2020 2020  nges), 1).      
-0000c210: 2020 7365 6c66 2e61 7373 6572 745f 6d6f    self.assert_mo
-0000c220: 636b 5f63 6861 6e67 6528 6368 616e 6765  ck_change(change
-0000c230: 735b 305d 290a 0a20 2020 2020 2020 2073  s[0])..        s
-0000c240: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000c250: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
-0000c260: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-0000c270: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
-0000c280: 2f63 6861 6e67 6573 272c 207b 2773 656c  /changes', {'sel
-0000c290: 6563 7427 3a20 2769 6e2d 7072 6f67 7265  ect': 'in-progre
-0000c2a0: 7373 277d 2c20 4e6f 6e65 292c 0a20 2020  ss'}, None),.   
-0000c2b0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0000c2c0: 2027 2f76 312f 6368 616e 6765 7327 2c20   '/v1/changes', 
-0000c2d0: 7b27 7365 6c65 6374 273a 2027 616c 6c27  {'select': 'all'
-0000c2e0: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
-0000c2f0: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-0000c300: 7631 2f63 6861 6e67 6573 272c 207b 2773  v1/changes', {'s
-0000c310: 656c 6563 7427 3a20 2761 6c6c 272c 2027  elect': 'all', '
-0000c320: 666f 7227 3a20 2766 6f6f 277d 2c20 4e6f  for': 'foo'}, No
-0000c330: 6e65 292c 0a20 2020 2020 2020 2020 2020  ne),.           
-0000c340: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
-0000c350: 616e 6765 7327 2c20 7b27 7365 6c65 6374  anges', {'select
-0000c360: 273a 2027 696e 2d70 726f 6772 6573 7327  ': 'in-progress'
-0000c370: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
-0000c380: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-0000c390: 7374 5f67 6574 5f63 6861 6e67 6528 7365  st_get_change(se
-0000c3a0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000c3b0: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-0000c3c0: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
-0000c3d0: 2020 2020 2020 2020 2272 6573 756c 7422          "result"
-0000c3e0: 3a20 6275 696c 645f 6d6f 636b 5f63 6861  : build_mock_cha
-0000c3f0: 6e67 655f 6469 6374 2829 2c0a 2020 2020  nge_dict(),.    
-0000c400: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000c410: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000c420: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000c430: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000c440: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000c450: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
-0000c460: 2020 2020 2020 6368 616e 6765 203d 2073        change = s
-0000c470: 656c 662e 636c 6965 6e74 2e67 6574 5f63  elf.client.get_c
-0000c480: 6861 6e67 6528 2737 3027 290a 2020 2020  hange('70').    
-0000c490: 2020 2020 7365 6c66 2e61 7373 6572 745f      self.assert_
-0000c4a0: 6d6f 636b 5f63 6861 6e67 6528 6368 616e  mock_change(chan
-0000c4b0: 6765 290a 2020 2020 2020 2020 7365 6c66  ge).        self
-0000c4c0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000c4d0: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-0000c4e0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-0000c4f0: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
-0000c500: 616e 6765 732f 3730 272c 204e 6f6e 652c  anges/70', None,
-0000c510: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0000c520: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0000c530: 5f61 626f 7274 5f63 6861 6e67 6528 7365  _abort_change(se
-0000c540: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000c550: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-0000c560: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
-0000c570: 2020 2020 2020 2020 2272 6573 756c 7422          "result"
-0000c580: 3a20 6275 696c 645f 6d6f 636b 5f63 6861  : build_mock_cha
-0000c590: 6e67 655f 6469 6374 2829 2c0a 2020 2020  nge_dict(),.    
-0000c5a0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000c5b0: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000c5c0: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000c5d0: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000c5e0: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000c5f0: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
-0000c600: 2020 2020 2020 6368 616e 6765 203d 2073        change = s
-0000c610: 656c 662e 636c 6965 6e74 2e61 626f 7274  elf.client.abort
-0000c620: 5f63 6861 6e67 6528 2737 3027 290a 2020  _change('70').  
-0000c630: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000c640: 745f 6d6f 636b 5f63 6861 6e67 6528 6368  t_mock_change(ch
-0000c650: 616e 6765 290a 2020 2020 2020 2020 7365  ange).        se
-0000c660: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-0000c670: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-0000c680: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-0000c690: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-0000c6a0: 2f63 6861 6e67 6573 2f37 3027 2c20 4e6f  /changes/70', No
-0000c6b0: 6e65 2c20 7b27 6163 7469 6f6e 273a 2027  ne, {'action': '
-0000c6c0: 6162 6f72 7427 7d29 2c0a 2020 2020 2020  abort'}),.      
-0000c6d0: 2020 5d29 0a0a 2020 2020 6465 6620 5f73    ])..    def _s
-0000c6e0: 6572 7669 6365 735f 6163 7469 6f6e 5f68  ervices_action_h
-0000c6f0: 656c 7065 7228 7365 6c66 2c20 6163 7469  elper(self, acti
-0000c700: 6f6e 2c20 6170 695f 6675 6e63 2c20 7365  on, api_func, se
-0000c710: 7276 6963 6573 293a 0a20 2020 2020 2020  rvices):.       
-0000c720: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
-0000c730: 706f 6e73 6573 2e61 7070 656e 6428 7b0a  ponses.append({.
-0000c740: 2020 2020 2020 2020 2020 2020 2263 6861              "cha
-0000c750: 6e67 6522 3a20 2237 3022 2c0a 2020 2020  nge": "70",.    
-0000c760: 2020 2020 2020 2020 2272 6573 756c 7422          "result"
-0000c770: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-0000c780: 2020 2020 2273 7461 7475 7322 3a20 2241      "status": "A
-0000c790: 6363 6570 7465 6422 2c0a 2020 2020 2020  ccepted",.      
-0000c7a0: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
-0000c7b0: 6465 223a 2032 3032 2c0a 2020 2020 2020  de": 202,.      
-0000c7c0: 2020 2020 2020 2274 7970 6522 3a20 2261        "type": "a
-0000c7d0: 7379 6e63 220a 2020 2020 2020 2020 7d29  sync".        })
-0000c7e0: 0a20 2020 2020 2020 2063 6861 6e67 6520  .        change 
-0000c7f0: 3d20 6275 696c 645f 6d6f 636b 5f63 6861  = build_mock_cha
-0000c800: 6e67 655f 6469 6374 2829 0a20 2020 2020  nge_dict().     
-0000c810: 2020 2063 6861 6e67 655b 2772 6561 6479     change['ready
-0000c820: 275d 203d 2054 7275 650a 2020 2020 2020  '] = True.      
-0000c830: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000c840: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-0000c850: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-0000c860: 7375 6c74 223a 2063 6861 6e67 652c 0a20  sult": change,. 
-0000c870: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-0000c880: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
-0000c890: 2020 2020 2020 2022 7374 6174 7573 2d63         "status-c
-0000c8a0: 6f64 6522 3a20 3230 302c 0a20 2020 2020  ode": 200,.     
-0000c8b0: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
-0000c8c0: 7379 6e63 220a 2020 2020 2020 2020 7d29  sync".        })
-0000c8d0: 0a20 2020 2020 2020 2063 6861 6e67 655f  .        change_
-0000c8e0: 6964 203d 2061 7069 5f66 756e 6328 290a  id = api_func().
-0000c8f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000c900: 6572 7445 7175 616c 2863 6861 6e67 655f  ertEqual(change_
-0000c910: 6964 2c20 2737 3027 290a 2020 2020 2020  id, '70').      
-0000c920: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000c930: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-0000c940: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-0000c950: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
-0000c960: 272f 7631 2f73 6572 7669 6365 7327 2c20  '/v1/services', 
-0000c970: 4e6f 6e65 2c20 7b27 6163 7469 6f6e 273a  None, {'action':
-0000c980: 2061 6374 696f 6e2c 2027 7365 7276 6963   action, 'servic
-0000c990: 6573 273a 2073 6572 7669 6365 737d 292c  es': services}),
-0000c9a0: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-0000c9b0: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
-0000c9c0: 732f 3730 2f77 6169 7427 2c20 7b27 7469  s/70/wait', {'ti
-0000c9d0: 6d65 6f75 7427 3a20 2734 2e30 3030 7327  meout': '4.000s'
-0000c9e0: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
-0000c9f0: 2020 5d29 0a0a 2020 2020 6465 6620 5f73    ])..    def _s
-0000ca00: 6572 7669 6365 735f 6163 7469 6f6e 5f61  ervices_action_a
-0000ca10: 7379 6e63 5f68 656c 7065 7228 7365 6c66  sync_helper(self
-0000ca20: 2c20 6163 7469 6f6e 2c20 6170 695f 6675  , action, api_fu
-0000ca30: 6e63 2c20 7365 7276 6963 6573 293a 0a20  nc, services):. 
-0000ca40: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0000ca50: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-0000ca60: 656e 6428 7b0a 2020 2020 2020 2020 2020  end({.          
-0000ca70: 2020 2263 6861 6e67 6522 3a20 2237 3022    "change": "70"
-0000ca80: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-0000ca90: 6573 756c 7422 3a20 4e6f 6e65 2c0a 2020  esult": None,.  
-0000caa0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-0000cab0: 7322 3a20 2241 6363 6570 7465 6422 2c0a  s": "Accepted",.
-0000cac0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-0000cad0: 7475 732d 636f 6465 223a 2032 3032 2c0a  tus-code": 202,.
-0000cae0: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
-0000caf0: 6522 3a20 2261 7379 6e63 220a 2020 2020  e": "async".    
-0000cb00: 2020 2020 7d29 0a20 2020 2020 2020 2063      }).        c
-0000cb10: 6861 6e67 655f 6964 203d 2061 7069 5f66  hange_id = api_f
-0000cb20: 756e 6328 7469 6d65 6f75 743d 3029 0a20  unc(timeout=0). 
-0000cb30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000cb40: 7274 4571 7561 6c28 6368 616e 6765 5f69  rtEqual(change_i
-0000cb50: 642c 2027 3730 2729 0a20 2020 2020 2020  d, '70').       
-0000cb60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000cb70: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-0000cb80: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000cb90: 2020 2020 2020 2827 504f 5354 272c 2027        ('POST', '
-0000cba0: 2f76 312f 7365 7276 6963 6573 272c 204e  /v1/services', N
-0000cbb0: 6f6e 652c 207b 2761 6374 696f 6e27 3a20  one, {'action': 
-0000cbc0: 6163 7469 6f6e 2c20 2773 6572 7669 6365  action, 'service
-0000cbd0: 7327 3a20 7365 7276 6963 6573 7d29 2c0a  s': services}),.
-0000cbe0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-0000cbf0: 6465 6620 7465 7374 5f61 7574 6f73 7461  def test_autosta
-0000cc00: 7274 5f73 6572 7669 6365 7328 7365 6c66  rt_services(self
-0000cc10: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000cc20: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
-0000cc30: 5f68 656c 7065 7228 2761 7574 6f73 7461  _helper('autosta
-0000cc40: 7274 272c 2073 656c 662e 636c 6965 6e74  rt', self.client
-0000cc50: 2e61 7574 6f73 7461 7274 5f73 6572 7669  .autostart_servi
-0000cc60: 6365 732c 205b 5d29 0a0a 2020 2020 6465  ces, [])..    de
-0000cc70: 6620 7465 7374 5f61 7574 6f73 7461 7274  f test_autostart
-0000cc80: 5f73 6572 7669 6365 735f 6173 796e 6328  _services_async(
-0000cc90: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0000cca0: 656c 662e 5f73 6572 7669 6365 735f 6163  elf._services_ac
-0000ccb0: 7469 6f6e 5f61 7379 6e63 5f68 656c 7065  tion_async_helpe
-0000ccc0: 7228 2761 7574 6f73 7461 7274 272c 2073  r('autostart', s
-0000ccd0: 656c 662e 636c 6965 6e74 2e61 7574 6f73  elf.client.autos
-0000cce0: 7461 7274 5f73 6572 7669 6365 732c 205b  tart_services, [
-0000ccf0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0000cd00: 5f72 6570 6c61 6e5f 7365 7276 6963 6573  _replan_services
-0000cd10: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000cd20: 7365 6c66 2e5f 7365 7276 6963 6573 5f61  self._services_a
-0000cd30: 6374 696f 6e5f 6865 6c70 6572 2827 7265  ction_helper('re
-0000cd40: 706c 616e 272c 2073 656c 662e 636c 6965  plan', self.clie
-0000cd50: 6e74 2e72 6570 6c61 6e5f 7365 7276 6963  nt.replan_servic
-0000cd60: 6573 2c20 5b5d 290a 0a20 2020 2064 6566  es, [])..    def
-0000cd70: 2074 6573 745f 7265 706c 616e 5f73 6572   test_replan_ser
-0000cd80: 7669 6365 735f 6173 796e 6328 7365 6c66  vices_async(self
-0000cd90: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000cda0: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
-0000cdb0: 5f61 7379 6e63 5f68 656c 7065 7228 2772  _async_helper('r
-0000cdc0: 6570 6c61 6e27 2c20 7365 6c66 2e63 6c69  eplan', self.cli
-0000cdd0: 656e 742e 7265 706c 616e 5f73 6572 7669  ent.replan_servi
-0000cde0: 6365 732c 205b 5d29 0a0a 2020 2020 6465  ces, [])..    de
-0000cdf0: 6620 7465 7374 5f73 7461 7274 5f73 6572  f test_start_ser
-0000ce00: 7669 6365 7328 7365 6c66 293a 0a20 2020  vices(self):.   
-0000ce10: 2020 2020 2064 6566 2061 7069 5f66 756e       def api_fun
-0000ce20: 6328 293a 0a20 2020 2020 2020 2020 2020  c():.           
-0000ce30: 2072 6574 7572 6e20 7365 6c66 2e63 6c69   return self.cli
-0000ce40: 656e 742e 7374 6172 745f 7365 7276 6963  ent.start_servic
-0000ce50: 6573 285b 2773 7663 275d 290a 2020 2020  es(['svc']).    
-0000ce60: 2020 2020 7365 6c66 2e5f 7365 7276 6963      self._servic
-0000ce70: 6573 5f61 6374 696f 6e5f 6865 6c70 6572  es_action_helper
-0000ce80: 2827 7374 6172 7427 2c20 6170 695f 6675  ('start', api_fu
-0000ce90: 6e63 2c20 5b27 7376 6327 5d29 0a0a 2020  nc, ['svc'])..  
-0000cea0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000ceb0: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-0000cec0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000ced0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0000cee0: 2e73 7461 7274 5f73 6572 7669 6365 7328  .start_services(
-0000cef0: 3129 0a0a 2020 2020 2020 2020 7769 7468  1)..        with
-0000cf00: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000cf10: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
-0000cf20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000cf30: 636c 6965 6e74 2e73 7461 7274 5f73 6572  client.start_ser
-0000cf40: 7669 6365 7328 5b31 5d29 0a0a 2020 2020  vices([1])..    
-0000cf50: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000cf60: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-0000cf70: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000cf80: 2020 2073 656c 662e 636c 6965 6e74 2e73     self.client.s
-0000cf90: 7461 7274 5f73 6572 7669 6365 7328 5b5b  tart_services([[
-0000cfa0: 2766 6f6f 275d 5d29 0a0a 2020 2020 6465  'foo']])..    de
-0000cfb0: 6620 7465 7374 5f73 7461 7274 5f73 6572  f test_start_ser
-0000cfc0: 7669 6365 735f 6173 796e 6328 7365 6c66  vices_async(self
-0000cfd0: 293a 0a20 2020 2020 2020 2064 6566 2061  ):.        def a
-0000cfe0: 7069 5f66 756e 6328 7469 6d65 6f75 743d  pi_func(timeout=
-0000cff0: 3330 293a 0a20 2020 2020 2020 2020 2020  30):.           
-0000d000: 2072 6574 7572 6e20 7365 6c66 2e63 6c69   return self.cli
-0000d010: 656e 742e 7374 6172 745f 7365 7276 6963  ent.start_servic
-0000d020: 6573 285b 2773 7663 275d 2c20 7469 6d65  es(['svc'], time
-0000d030: 6f75 743d 7469 6d65 6f75 7429 0a20 2020  out=timeout).   
-0000d040: 2020 2020 2073 656c 662e 5f73 6572 7669       self._servi
-0000d050: 6365 735f 6163 7469 6f6e 5f61 7379 6e63  ces_action_async
-0000d060: 5f68 656c 7065 7228 2773 7461 7274 272c  _helper('start',
-0000d070: 2061 7069 5f66 756e 632c 205b 2773 7663   api_func, ['svc
-0000d080: 275d 290a 0a20 2020 2064 6566 2074 6573  '])..    def tes
-0000d090: 745f 7374 6f70 5f73 6572 7669 6365 7328  t_stop_services(
-0000d0a0: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-0000d0b0: 6566 2061 7069 5f66 756e 6328 293a 0a20  ef api_func():. 
-0000d0c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d0d0: 6e20 7365 6c66 2e63 6c69 656e 742e 7374  n self.client.st
-0000d0e0: 6f70 5f73 6572 7669 6365 7328 5b27 7376  op_services(['sv
-0000d0f0: 6327 5d29 0a20 2020 2020 2020 2073 656c  c']).        sel
-0000d100: 662e 5f73 6572 7669 6365 735f 6163 7469  f._services_acti
-0000d110: 6f6e 5f68 656c 7065 7228 2773 746f 7027  on_helper('stop'
-0000d120: 2c20 6170 695f 6675 6e63 2c20 5b27 7376  , api_func, ['sv
-0000d130: 6327 5d29 0a0a 2020 2020 2020 2020 7769  c'])..        wi
-0000d140: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000d150: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-0000d160: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000d170: 662e 636c 6965 6e74 2e73 746f 705f 7365  f.client.stop_se
-0000d180: 7276 6963 6573 2831 290a 0a20 2020 2020  rvices(1)..     
-0000d190: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000d1a0: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-0000d1b0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000d1c0: 2020 7365 6c66 2e63 6c69 656e 742e 7374    self.client.st
-0000d1d0: 6f70 5f73 6572 7669 6365 7328 5b31 5d29  op_services([1])
-0000d1e0: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-0000d1f0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-0000d200: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
-0000d210: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-0000d220: 6965 6e74 2e73 746f 705f 7365 7276 6963  ient.stop_servic
-0000d230: 6573 285b 5b27 666f 6f27 5d5d 290a 0a20  es([['foo']]).. 
-0000d240: 2020 2064 6566 2074 6573 745f 7374 6f70     def test_stop
-0000d250: 5f73 6572 7669 6365 735f 6173 796e 6328  _services_async(
-0000d260: 7365 6c66 293a 0a20 2020 2020 2020 2064  self):.        d
-0000d270: 6566 2061 7069 5f66 756e 6328 7469 6d65  ef api_func(time
-0000d280: 6f75 743d 3330 293a 0a20 2020 2020 2020  out=30):.       
-0000d290: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000d2a0: 2e63 6c69 656e 742e 7374 6f70 5f73 6572  .client.stop_ser
-0000d2b0: 7669 6365 7328 5b27 7376 6327 5d2c 2074  vices(['svc'], t
-0000d2c0: 696d 656f 7574 3d74 696d 656f 7574 290a  imeout=timeout).
-0000d2d0: 2020 2020 2020 2020 7365 6c66 2e5f 7365          self._se
-0000d2e0: 7276 6963 6573 5f61 6374 696f 6e5f 6173  rvices_action_as
-0000d2f0: 796e 635f 6865 6c70 6572 2827 7374 6f70  ync_helper('stop
-0000d300: 272c 2061 7069 5f66 756e 632c 205b 2773  ', api_func, ['s
-0000d310: 7663 275d 290a 0a20 2020 2064 6566 2074  vc'])..    def t
-0000d320: 6573 745f 7265 7374 6172 745f 7365 7276  est_restart_serv
-0000d330: 6963 6573 2873 656c 6629 3a0a 2020 2020  ices(self):.    
-0000d340: 2020 2020 6465 6620 6170 695f 6675 6e63      def api_func
-0000d350: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000d360: 7265 7475 726e 2073 656c 662e 636c 6965  return self.clie
-0000d370: 6e74 2e72 6573 7461 7274 5f73 6572 7669  nt.restart_servi
-0000d380: 6365 7328 5b27 7376 6327 5d29 0a20 2020  ces(['svc']).   
-0000d390: 2020 2020 2073 656c 662e 5f73 6572 7669       self._servi
-0000d3a0: 6365 735f 6163 7469 6f6e 5f68 656c 7065  ces_action_helpe
-0000d3b0: 7228 2772 6573 7461 7274 272c 2061 7069  r('restart', api
-0000d3c0: 5f66 756e 632c 205b 2773 7663 275d 290a  _func, ['svc']).
-0000d3d0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0000d3e0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0000d3f0: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
-0000d400: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0000d410: 656e 742e 7265 7374 6172 745f 7365 7276  ent.restart_serv
-0000d420: 6963 6573 2831 290a 0a20 2020 2020 2020  ices(1)..       
-0000d430: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000d440: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
-0000d450: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000d460: 7365 6c66 2e63 6c69 656e 742e 7265 7374  self.client.rest
-0000d470: 6172 745f 7365 7276 6963 6573 285b 315d  art_services([1]
-0000d480: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-0000d490: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000d4a0: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
-0000d4b0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0000d4c0: 6c69 656e 742e 7265 7374 6172 745f 7365  lient.restart_se
-0000d4d0: 7276 6963 6573 285b 5b27 666f 6f27 5d5d  rvices([['foo']]
-0000d4e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000d4f0: 7265 7374 6172 745f 7365 7276 6963 6573  restart_services
-0000d500: 5f61 7379 6e63 2873 656c 6629 3a0a 2020  _async(self):.  
-0000d510: 2020 2020 2020 6465 6620 6170 695f 6675        def api_fu
-0000d520: 6e63 2874 696d 656f 7574 3d33 3029 3a0a  nc(timeout=30):.
-0000d530: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000d540: 726e 2073 656c 662e 636c 6965 6e74 2e72  rn self.client.r
-0000d550: 6573 7461 7274 5f73 6572 7669 6365 7328  estart_services(
-0000d560: 5b27 7376 6327 5d2c 2074 696d 656f 7574  ['svc'], timeout
-0000d570: 3d74 696d 656f 7574 290a 2020 2020 2020  =timeout).      
-0000d580: 2020 7365 6c66 2e5f 7365 7276 6963 6573    self._services
-0000d590: 5f61 6374 696f 6e5f 6173 796e 635f 6865  _action_async_he
-0000d5a0: 6c70 6572 2827 7265 7374 6172 7427 2c20  lper('restart', 
-0000d5b0: 6170 695f 6675 6e63 2c20 5b27 7376 6327  api_func, ['svc'
-0000d5c0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0000d5d0: 5f63 6861 6e67 655f 6572 726f 7228 7365  _change_error(se
-0000d5e0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-0000d5f0: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-0000d600: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
-0000d610: 2020 2020 2020 2020 2263 6861 6e67 6522          "change"
-0000d620: 3a20 2237 3022 2c0a 2020 2020 2020 2020  : "70",.        
-0000d630: 2020 2020 2272 6573 756c 7422 3a20 4e6f      "result": No
-0000d640: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0000d650: 2273 7461 7475 7322 3a20 2241 6363 6570  "status": "Accep
-0000d660: 7465 6422 2c0a 2020 2020 2020 2020 2020  ted",.          
-0000d670: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
-0000d680: 2032 3032 2c0a 2020 2020 2020 2020 2020   202,.          
-0000d690: 2020 2274 7970 6522 3a20 2261 7379 6e63    "type": "async
-0000d6a0: 220a 2020 2020 2020 2020 7d29 0a20 2020  ".        }).   
-0000d6b0: 2020 2020 2063 6861 6e67 6520 3d20 6275       change = bu
-0000d6c0: 696c 645f 6d6f 636b 5f63 6861 6e67 655f  ild_mock_change_
-0000d6d0: 6469 6374 2829 0a20 2020 2020 2020 2063  dict().        c
-0000d6e0: 6861 6e67 655b 2765 7272 275d 203d 2027  hange['err'] = '
-0000d6f0: 536f 6d65 206b 696e 6420 6f66 2073 6572  Some kind of ser
-0000d700: 7669 6365 2065 7272 6f72 270a 2020 2020  vice error'.    
-0000d710: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000d720: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000d730: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-0000d740: 7265 7375 6c74 223a 2063 6861 6e67 652c  result": change,
-0000d750: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-0000d760: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
-0000d770: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-0000d780: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
-0000d790: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
-0000d7a0: 2022 7379 6e63 220a 2020 2020 2020 2020   "sync".        
-0000d7b0: 7d29 0a20 2020 2020 2020 2077 6974 6820  }).        with 
-0000d7c0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000d7d0: 7328 7065 6262 6c65 2e43 6861 6e67 6545  s(pebble.ChangeE
-0000d7e0: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-0000d7f0: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-0000d800: 6965 6e74 2e61 7574 6f73 7461 7274 5f73  ient.autostart_s
-0000d810: 6572 7669 6365 7328 290a 2020 2020 2020  ervices().      
-0000d820: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0000d830: 6e73 7461 6e63 6528 636d 2e65 7863 6570  nstance(cm.excep
-0000d840: 7469 6f6e 2c20 7065 6262 6c65 2e45 7272  tion, pebble.Err
-0000d850: 6f72 290a 2020 2020 2020 2020 7365 6c66  or).        self
-0000d860: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
-0000d870: 6578 6365 7074 696f 6e2e 6572 722c 2027  exception.err, '
-0000d880: 536f 6d65 206b 696e 6420 6f66 2073 6572  Some kind of ser
-0000d890: 7669 6365 2065 7272 6f72 2729 0a20 2020  vice error').   
-0000d8a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000d8b0: 4973 496e 7374 616e 6365 2863 6d2e 6578  IsInstance(cm.ex
-0000d8c0: 6365 7074 696f 6e2e 6368 616e 6765 2c20  ception.change, 
-0000d8d0: 7065 6262 6c65 2e43 6861 6e67 6529 0a20  pebble.Change). 
-0000d8e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d8f0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
-0000d900: 7469 6f6e 2e63 6861 6e67 652e 6964 2c20  tion.change.id, 
-0000d910: 2737 3027 290a 0a20 2020 2020 2020 2073  '70')..        s
-0000d920: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000d930: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
-0000d940: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-0000d950: 2020 2020 2827 504f 5354 272c 2027 2f76      ('POST', '/v
-0000d960: 312f 7365 7276 6963 6573 272c 204e 6f6e  1/services', Non
-0000d970: 652c 207b 2761 6374 696f 6e27 3a20 2761  e, {'action': 'a
-0000d980: 7574 6f73 7461 7274 272c 2027 7365 7276  utostart', 'serv
-0000d990: 6963 6573 273a 205b 5d7d 292c 0a20 2020  ices': []}),.   
-0000d9a0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0000d9b0: 2027 2f76 312f 6368 616e 6765 732f 3730   '/v1/changes/70
-0000d9c0: 2f77 6169 7427 2c20 7b27 7469 6d65 6f75  /wait', {'timeou
-0000d9d0: 7427 3a20 2734 2e30 3030 7327 7d2c 204e  t': '4.000s'}, N
-0000d9e0: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-0000d9f0: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
-0000da00: 6169 745f 6368 616e 6765 5f73 7563 6365  ait_change_succe
-0000da10: 7373 2873 656c 662c 2074 696d 656f 7574  ss(self, timeout
-0000da20: 3d33 302e 3029 3a0a 2020 2020 2020 2020  =30.0):.        
-0000da30: 6368 616e 6765 203d 2062 7569 6c64 5f6d  change = build_m
-0000da40: 6f63 6b5f 6368 616e 6765 5f64 6963 7428  ock_change_dict(
-0000da50: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0000da60: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
-0000da70: 6170 7065 6e64 287b 0a20 2020 2020 2020  append({.       
-0000da80: 2020 2020 2022 7265 7375 6c74 223a 2063       "result": c
-0000da90: 6861 6e67 652c 0a20 2020 2020 2020 2020  hange,.         
-0000daa0: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
-0000dab0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0000dac0: 7374 6174 7573 2d63 6f64 6522 3a20 3230  status-code": 20
-0000dad0: 302c 0a20 2020 2020 2020 2020 2020 2022  0,.            "
-0000dae0: 7479 7065 223a 2022 7379 6e63 220a 2020  type": "sync".  
-0000daf0: 2020 2020 2020 7d29 0a0a 2020 2020 2020        })..      
-0000db00: 2020 7265 7370 6f6e 7365 203d 2073 656c    response = sel
-0000db10: 662e 636c 6965 6e74 2e77 6169 745f 6368  f.client.wait_ch
-0000db20: 616e 6765 2827 3730 272c 2074 696d 656f  ange('70', timeo
-0000db30: 7574 3d74 696d 656f 7574 290a 2020 2020  ut=timeout).    
-0000db40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000db50: 7175 616c 2872 6573 706f 6e73 652e 6964  qual(response.id
-0000db60: 2c20 2737 3027 290a 2020 2020 2020 2020  , '70').        
-0000db70: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000db80: 7265 7370 6f6e 7365 2e72 6561 6479 290a  response.ready).
+00009a80: 2274 6f74 616c 223a 2031 2c0a 2020 2020  "total": 1,.    
+00009a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009aa0: 2265 7874 7261 2d66 6965 6c64 223a 2022  "extra-field": "
+00009ab0: 666f 6f22 2c0a 2020 2020 2020 2020 2020  foo",.          
+00009ac0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00009ad0: 2020 2020 2020 2020 2022 7265 6164 792d           "ready-
+00009ae0: 7469 6d65 223a 2022 3230 3231 2d30 312d  time": "2021-01-
+00009af0: 3238 5431 343a 3337 3a30 332e 3237 3032  28T14:37:03.2702
+00009b00: 3138 3737 382b 3133 3a30 3022 2c0a 2020  18778+13:00",.  
+00009b10: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00009b20: 7061 776e 2d74 696d 6522 3a20 2232 3032  pawn-time": "202
+00009b30: 312d 3031 2d32 3854 3134 3a33 373a 3032  1-01-28T14:37:02
+00009b40: 2e32 3437 3135 3831 3632 2b31 333a 3030  .247158162+13:00
+00009b50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00009b60: 2020 2022 7374 6174 7573 223a 2022 446f     "status": "Do
+00009b70: 6e65 222c 0a20 2020 2020 2020 2020 2020  ne",.           
+00009b80: 2020 2020 2022 7375 6d6d 6172 7922 3a20       "summary": 
+00009b90: 2753 7461 7274 2073 6572 7669 6365 2022  'Start service "
+00009ba0: 7376 6322 272c 0a20 2020 2020 2020 2020  svc"',.         
+00009bb0: 2020 2020 2020 2022 6578 7472 612d 6669         "extra-fi
+00009bc0: 656c 6422 3a20 2266 6f6f 222c 0a20 2020  eld": "foo",.   
+00009bd0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00009be0: 2020 2020 5d2c 0a20 2020 2020 2020 2022      ],.        "
+00009bf0: 6578 7472 612d 6669 656c 6422 3a20 2266  extra-field": "f
+00009c00: 6f6f 222c 0a20 2020 207d 0a0a 0a63 6c61  oo",.    }...cla
+00009c10: 7373 2054 6573 744d 756c 7469 7061 7274  ss TestMultipart
+00009c20: 5061 7273 6572 2875 6e69 7474 6573 742e  Parser(unittest.
+00009c30: 5465 7374 4361 7365 293a 0a20 2020 2063  TestCase):.    c
+00009c40: 6c61 7373 205f 4361 7365 3a0a 2020 2020  lass _Case:.    
+00009c50: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00009c60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009c70: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00009c80: 2020 2020 2020 2020 6e61 6d65 2c0a 2020          name,.  
+00009c90: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00009ca0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+00009cb0: 2020 2020 7761 6e74 5f68 6561 6465 7273      want_headers
+00009cc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009cd0: 2020 7761 6e74 5f62 6f64 6965 732c 0a20    want_bodies,. 
+00009ce0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00009cf0: 616e 745f 626f 6469 6573 5f64 6f6e 652c  ant_bodies_done,
+00009d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009d10: 206d 6178 5f62 6f75 6e64 6172 793d 3134   max_boundary=14
+00009d20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009d30: 2020 6d61 785f 6c6f 6f6b 6168 6561 643d    max_lookahead=
+00009d40: 3820 2a20 3130 3234 2c0a 2020 2020 2020  8 * 1024,.      
+00009d50: 2020 2020 2020 2020 2020 6572 726f 723d            error=
+00009d60: 2727 293a 0a20 2020 2020 2020 2020 2020  ''):.           
+00009d70: 2073 656c 662e 6e61 6d65 203d 206e 616d   self.name = nam
+00009d80: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
+00009d90: 6c66 2e64 6174 6120 3d20 6461 7461 0a20  lf.data = data. 
+00009da0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00009db0: 7761 6e74 5f68 6561 6465 7273 203d 2077  want_headers = w
+00009dc0: 616e 745f 6865 6164 6572 730a 2020 2020  ant_headers.    
+00009dd0: 2020 2020 2020 2020 7365 6c66 2e77 616e          self.wan
+00009de0: 745f 626f 6469 6573 203d 2077 616e 745f  t_bodies = want_
+00009df0: 626f 6469 6573 0a20 2020 2020 2020 2020  bodies.         
+00009e00: 2020 2073 656c 662e 7761 6e74 5f62 6f64     self.want_bod
+00009e10: 6965 735f 646f 6e65 203d 2077 616e 745f  ies_done = want_
+00009e20: 626f 6469 6573 5f64 6f6e 650a 2020 2020  bodies_done.    
+00009e30: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
+00009e40: 5f62 6f75 6e64 6172 7920 3d20 6d61 785f  _boundary = max_
+00009e50: 626f 756e 6461 7279 0a20 2020 2020 2020  boundary.       
+00009e60: 2020 2020 2073 656c 662e 6d61 785f 6c6f       self.max_lo
+00009e70: 6f6b 6168 6561 6420 3d20 6d61 785f 6c6f  okahead = max_lo
+00009e80: 6f6b 6168 6561 640a 2020 2020 2020 2020  okahead.        
+00009e90: 2020 2020 7365 6c66 2e65 7272 6f72 203d      self.error =
+00009ea0: 2065 7272 6f72 0a0a 2020 2020 6465 6620   error..    def 
+00009eb0: 7465 7374 5f6d 756c 7469 7061 7274 5f70  test_multipart_p
+00009ec0: 6172 7365 7228 7365 6c66 293a 0a20 2020  arser(self):.   
+00009ed0: 2020 2020 2074 6573 7473 203d 205b 0a20       tests = [. 
+00009ee0: 2020 2020 2020 2020 2020 2054 6573 744d             TestM
+00009ef0: 756c 7469 7061 7274 5061 7273 6572 2e5f  ultipartParser._
+00009f00: 4361 7365 280a 2020 2020 2020 2020 2020  Case(.          
+00009f10: 2020 2020 2020 2762 6173 656c 696e 6527        'baseline'
+00009f20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009f30: 2020 6227 5c72 5c6e 2d2d 7177 6572 7479    b'\r\n--qwerty
+00009f40: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
+00009f50: 5c6e 5c72 5c6e 666f 6f20 6261 725c 6e66  \n\r\nfoo bar\nf
+00009f60: 6f6f 2062 6172 5c72 5c6e 2d2d 7177 6572  oo bar\r\n--qwer
+00009f70: 7479 2d2d 5c72 5c6e 272c 0a20 2020 2020  ty--\r\n',.     
+00009f80: 2020 2020 2020 2020 2020 205b 6227 6865             [b'he
+00009f90: 6164 6572 2066 6f6f 5c72 5c6e 5c72 5c6e  ader foo\r\n\r\n
+00009fa0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+00009fb0: 2020 2020 5b62 2766 6f6f 2062 6172 5c6e      [b'foo bar\n
+00009fc0: 666f 6f20 6261 7227 5d2c 0a20 2020 2020  foo bar'],.     
+00009fd0: 2020 2020 2020 2020 2020 2077 616e 745f             want_
+00009fe0: 626f 6469 6573 5f64 6f6e 653d 5b54 7275  bodies_done=[Tru
+00009ff0: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
+0000a000: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
+0000a010: 6573 744d 756c 7469 7061 7274 5061 7273  estMultipartPars
+0000a020: 6572 2e5f 4361 7365 280a 2020 2020 2020  er._Case(.      
+0000a030: 2020 2020 2020 2020 2020 2769 6e63 6f6d            'incom
+0000a040: 706c 6574 6520 6865 6164 6572 272c 0a20  plete header',. 
+0000a050: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000a060: 275c 725c 6e2d 2d71 7765 7274 795c 725c  '\r\n--qwerty\r\
+0000a070: 6e68 6561 6465 7220 666f 6f5c 725c 6e27  nheader foo\r\n'
+0000a080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a090: 2020 5b5d 2c0a 2020 2020 2020 2020 2020    [],.          
+0000a0a0: 2020 2020 2020 5b5d 2c0a 2020 2020 2020        [],.      
+0000a0b0: 2020 2020 2020 2020 2020 7761 6e74 5f62            want_b
+0000a0c0: 6f64 6965 735f 646f 6e65 3d5b 5d2c 0a20  odies_done=[],. 
+0000a0d0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0000a0e0: 2020 2020 2020 2020 2020 5465 7374 4d75            TestMu
+0000a0f0: 6c74 6970 6172 7450 6172 7365 722e 5f43  ltipartParser._C
+0000a100: 6173 6528 0a20 2020 2020 2020 2020 2020  ase(.           
+0000a110: 2020 2020 2027 6d69 7373 696e 6720 6865       'missing he
+0000a120: 6164 6572 272c 0a20 2020 2020 2020 2020  ader',.         
+0000a130: 2020 2020 2020 2062 275c 725c 6e2d 2d71         b'\r\n--q
+0000a140: 7765 7274 795c 725c 6e68 6561 6465 7220  werty\r\nheader 
+0000a150: 666f 6f5c 725c 6e27 202b 2034 3020 2a20  foo\r\n' + 40 * 
+0000a160: 6227 2027 2c0a 2020 2020 2020 2020 2020  b' ',.          
+0000a170: 2020 2020 2020 5b5d 2c0a 2020 2020 2020        [],.      
+0000a180: 2020 2020 2020 2020 2020 5b5d 2c0a 2020            [],.  
+0000a190: 2020 2020 2020 2020 2020 2020 2020 7761                wa
+0000a1a0: 6e74 5f62 6f64 6965 735f 646f 6e65 3d5b  nt_bodies_done=[
+0000a1b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000a1c0: 2020 206d 6178 5f6c 6f6f 6b61 6865 6164     max_lookahead
+0000a1d0: 3d34 302c 0a20 2020 2020 2020 2020 2020  =40,.           
+0000a1e0: 2020 2020 2065 7272 6f72 3d27 6865 6164       error='head
+0000a1f0: 6572 2074 6572 6d69 6e61 746f 7220 6e6f  er terminator no
+0000a200: 7420 666f 756e 6427 2c0a 2020 2020 2020  t found',.      
+0000a210: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+0000a220: 2020 2020 2054 6573 744d 756c 7469 7061       TestMultipa
+0000a230: 7274 5061 7273 6572 2e5f 4361 7365 280a  rtParser._Case(.
+0000a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a250: 2769 6e63 6f6d 706c 6574 6520 626f 6479  'incomplete body
+0000a260: 2074 6572 6d69 6e61 746f 7227 2c0a 2020   terminator',.  
+0000a270: 2020 2020 2020 2020 2020 2020 2020 6227                b'
+0000a280: 5c72 5c6e 2d2d 7177 6572 7479 5c72 5c6e  \r\n--qwerty\r\n
+0000a290: 6865 6164 6572 2066 6f6f 5c72 5c6e 5c72  header foo\r\n\r
+0000a2a0: 5c6e 666f 6f20 6261 725c 725c 6e2d 2d71  \nfoo bar\r\n--q
+0000a2b0: 7765 7274 795c 7268 656c 6c6f 206d 7920  werty\rhello my 
+0000a2c0: 6e61 6d65 2069 7320 6a6f 6520 616e 6420  name is joe and 
+0000a2d0: 4920 776f 726b 2069 6e20 6120 6275 7474  I work in a butt
+0000a2e0: 6f6e 2066 6163 746f 7279 272c 2020 2320  on factory',  # 
+0000a2f0: 6e6f 7161 0a20 2020 2020 2020 2020 2020  noqa.           
+0000a300: 2020 2020 205b 6227 6865 6164 6572 2066       [b'header f
+0000a310: 6f6f 5c72 5c6e 5c72 5c6e 275d 2c0a 2020  oo\r\n\r\n'],.  
+0000a320: 2020 2020 2020 2020 2020 2020 2020 5b62                [b
+0000a330: 2766 6f6f 2062 6172 5c72 5c6e 2d2d 7177  'foo bar\r\n--qw
+0000a340: 6572 7479 5c72 6865 6c6c 6f20 6d79 206e  erty\rhello my n
+0000a350: 616d 6520 6973 206a 6f65 2061 6e64 2049  ame is joe and I
+0000a360: 2077 6f72 6b20 696e 2061 2027 5d2c 0a20   work in a '],. 
+0000a370: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000a380: 616e 745f 626f 6469 6573 5f64 6f6e 653d  ant_bodies_done=
+0000a390: 5b46 616c 7365 5d2c 0a20 2020 2020 2020  [False],.       
+0000a3a0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0000a3b0: 2020 2020 5465 7374 4d75 6c74 6970 6172      TestMultipar
+0000a3c0: 7450 6172 7365 722e 5f43 6173 6528 0a20  tParser._Case(. 
+0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000a3e0: 656d 7074 7920 626f 6479 272c 0a20 2020  empty body',.   
+0000a3f0: 2020 2020 2020 2020 2020 2020 2062 275c               b'\
+0000a400: 725c 6e2d 2d71 7765 7274 795c 725c 6e68  r\n--qwerty\r\nh
+0000a410: 6561 6465 7220 666f 6f5c 725c 6e5c 725c  eader foo\r\n\r\
+0000a420: 6e5c 725c 6e2d 2d71 7765 7274 795c 725c  n\r\n--qwerty\r\
+0000a430: 6e27 2c0a 2020 2020 2020 2020 2020 2020  n',.            
+0000a440: 2020 2020 5b62 2768 6561 6465 7220 666f      [b'header fo
+0000a450: 6f5c 725c 6e5c 725c 6e27 5d2c 0a20 2020  o\r\n\r\n'],.   
+0000a460: 2020 2020 2020 2020 2020 2020 205b 6227               [b'
+0000a470: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0000a480: 2020 2020 7761 6e74 5f62 6f64 6965 735f      want_bodies_
+0000a490: 646f 6e65 3d5b 5472 7565 5d2c 0a20 2020  done=[True],.   
+0000a4a0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+0000a4b0: 2020 2020 2020 2020 5465 7374 4d75 6c74          TestMult
+0000a4c0: 6970 6172 7450 6172 7365 722e 5f43 6173  ipartParser._Cas
+0000a4d0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000a4e0: 2020 2027 6967 6e6f 7265 206c 6561 6469     'ignore leadi
+0000a4f0: 6e67 2067 6172 6261 6765 272c 0a20 2020  ng garbage',.   
+0000a500: 2020 2020 2020 2020 2020 2020 2062 2768               b'h
+0000a510: 656c 6c6f 206d 7920 6e61 6d65 2069 7320  ello my name is 
+0000a520: 6a6f 655c 725c 6e5c 6e5c 6e5c 6e5c 725c  joe\r\n\n\n\n\r\
+0000a530: 6e2d 2d71 7765 7274 795c 725c 6e68 6561  n--qwerty\r\nhea
+0000a540: 6465 7220 666f 6f5c 725c 6e5c 725c 6e66  der foo\r\n\r\nf
+0000a550: 6f6f 2062 6172 5c72 5c6e 2d2d 7177 6572  oo bar\r\n--qwer
+0000a560: 7479 5c72 5c6e 272c 2020 2320 6e6f 7161  ty\r\n',  # noqa
+0000a570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a580: 205b 6227 6865 6164 6572 2066 6f6f 5c72   [b'header foo\r
+0000a590: 5c6e 5c72 5c6e 275d 2c0a 2020 2020 2020  \n\r\n'],.      
+0000a5a0: 2020 2020 2020 2020 2020 5b62 2766 6f6f            [b'foo
+0000a5b0: 2062 6172 275d 2c0a 2020 2020 2020 2020   bar'],.        
+0000a5c0: 2020 2020 2020 2020 7761 6e74 5f62 6f64          want_bod
+0000a5d0: 6965 735f 646f 6e65 3d5b 5472 7565 5d2c  ies_done=[True],
+0000a5e0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0000a5f0: 2020 2020 2020 2020 2020 2020 5465 7374              Test
+0000a600: 4d75 6c74 6970 6172 7450 6172 7365 722e  MultipartParser.
+0000a610: 5f43 6173 6528 0a20 2020 2020 2020 2020  _Case(.         
+0000a620: 2020 2020 2020 2027 6967 6e6f 7265 2074         'ignore t
+0000a630: 7261 696c 696e 6720 6761 7262 6167 6527  railing garbage'
+0000a640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a650: 2020 6227 5c72 5c6e 2d2d 7177 6572 7479    b'\r\n--qwerty
+0000a660: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
+0000a670: 5c6e 5c72 5c6e 666f 6f20 6261 725c 725c  \n\r\nfoo bar\r\
+0000a680: 6e2d 2d71 7765 7274 795c 725c 6e68 656c  n--qwerty\r\nhel
+0000a690: 6c6f 206d 7920 6e61 6d65 2069 7320 6a6f  lo my name is jo
+0000a6a0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+0000a6b0: 2020 2020 5b62 2768 6561 6465 7220 666f      [b'header fo
+0000a6c0: 6f5c 725c 6e5c 725c 6e27 5d2c 0a20 2020  o\r\n\r\n'],.   
+0000a6d0: 2020 2020 2020 2020 2020 2020 205b 6227               [b'
+0000a6e0: 666f 6f20 6261 7227 5d2c 0a20 2020 2020  foo bar'],.     
+0000a6f0: 2020 2020 2020 2020 2020 2077 616e 745f             want_
+0000a700: 626f 6469 6573 5f64 6f6e 653d 5b54 7275  bodies_done=[Tru
+0000a710: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
+0000a720: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
+0000a730: 6573 744d 756c 7469 7061 7274 5061 7273  estMultipartPars
+0000a740: 6572 2e5f 4361 7365 280a 2020 2020 2020  er._Case(.      
+0000a750: 2020 2020 2020 2020 2020 2762 6f75 6e64            'bound
+0000a760: 6172 7920 616c 6c6f 7720 6c69 6e65 6172  ary allow linear
+0000a770: 2077 6869 7465 7370 6163 6527 2c0a 2020   whitespace',.  
+0000a780: 2020 2020 2020 2020 2020 2020 2020 6227                b'
+0000a790: 5c72 5c6e 2d2d 7177 6572 7479 205c 7420  \r\n--qwerty \t 
+0000a7a0: 5c72 5c6e 6865 6164 6572 2066 6f6f 5c72  \r\nheader foo\r
+0000a7b0: 5c6e 5c72 5c6e 666f 6f20 6261 725c 725c  \n\r\nfoo bar\r\
+0000a7c0: 6e2d 2d71 7765 7274 795c 725c 6e27 2c0a  n--qwerty\r\n',.
+0000a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7e0: 5b62 2768 6561 6465 7220 666f 6f5c 725c  [b'header foo\r\
+0000a7f0: 6e5c 725c 6e27 5d2c 0a20 2020 2020 2020  n\r\n'],.       
+0000a800: 2020 2020 2020 2020 205b 6227 666f 6f20           [b'foo 
+0000a810: 6261 7227 5d2c 0a20 2020 2020 2020 2020  bar'],.         
+0000a820: 2020 2020 2020 2077 616e 745f 626f 6469         want_bodi
+0000a830: 6573 5f64 6f6e 653d 5b54 7275 655d 2c0a  es_done=[True],.
+0000a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a850: 6d61 785f 626f 756e 6461 7279 3d32 302c  max_boundary=20,
+0000a860: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0000a870: 2020 2020 2020 2020 2020 2020 5465 7374              Test
+0000a880: 4d75 6c74 6970 6172 7450 6172 7365 722e  MultipartParser.
+0000a890: 5f43 6173 6528 0a20 2020 2020 2020 2020  _Case(.         
+0000a8a0: 2020 2020 2020 2027 7465 726d 696e 616c         'terminal
+0000a8b0: 2062 6f75 6e64 6172 7920 616c 6c6f 7720   boundary allow 
+0000a8c0: 6c69 6e65 6172 2077 6869 7465 7370 6163  linear whitespac
+0000a8d0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+0000a8e0: 2020 2020 6227 5c72 5c6e 2d2d 7177 6572      b'\r\n--qwer
+0000a8f0: 7479 5c72 5c6e 6865 6164 6572 2066 6f6f  ty\r\nheader foo
+0000a900: 5c72 5c6e 5c72 5c6e 666f 6f20 6261 725c  \r\n\r\nfoo bar\
+0000a910: 725c 6e2d 2d71 7765 7274 792d 2d20 5c74  r\n--qwerty-- \t
+0000a920: 205c 725c 6e27 2c0a 2020 2020 2020 2020   \r\n',.        
+0000a930: 2020 2020 2020 2020 5b62 2768 6561 6465          [b'heade
+0000a940: 7220 666f 6f5c 725c 6e5c 725c 6e27 5d2c  r foo\r\n\r\n'],
+0000a950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a960: 205b 6227 666f 6f20 6261 7227 5d2c 0a20   [b'foo bar'],. 
+0000a970: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000a980: 616e 745f 626f 6469 6573 5f64 6f6e 653d  ant_bodies_done=
+0000a990: 5b54 7275 655d 2c0a 2020 2020 2020 2020  [True],.        
+0000a9a0: 2020 2020 2020 2020 6d61 785f 626f 756e          max_boun
+0000a9b0: 6461 7279 3d32 302c 0a20 2020 2020 2020  dary=20,.       
+0000a9c0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0000a9d0: 2020 2020 5465 7374 4d75 6c74 6970 6172      TestMultipar
+0000a9e0: 7450 6172 7365 722e 5f43 6173 6528 0a20  tParser._Case(. 
+0000a9f0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000aa00: 6d75 6c74 6970 6c65 2070 6172 7473 272c  multiple parts',
+0000aa10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aa20: 2062 275c 725c 6e2d 2d71 7765 7274 7920   b'\r\n--qwerty 
+0000aa30: 5c74 205c 725c 6e68 6561 6465 7220 666f  \t \r\nheader fo
+0000aa40: 6f5c 725c 6e5c 725c 6e66 6f6f 2062 6172  o\r\n\r\nfoo bar
+0000aa50: 5c72 5c6e 2d2d 7177 6572 7479 5c72 5c6e  \r\n--qwerty\r\n
+0000aa60: 6865 6164 6572 2062 6172 5c72 5c6e 5c72  header bar\r\n\r
+0000aa70: 5c6e 666f 6f20 6261 7a5c 725c 6e2d 2d71  \nfoo baz\r\n--q
+0000aa80: 7765 7274 792d 2d5c 725c 6e27 2c20 2023  werty--\r\n',  #
+0000aa90: 206e 6f71 610a 2020 2020 2020 2020 2020   noqa.          
+0000aaa0: 2020 2020 2020 5b62 2768 6561 6465 7220        [b'header 
+0000aab0: 666f 6f5c 725c 6e5c 725c 6e27 2c20 6227  foo\r\n\r\n', b'
+0000aac0: 6865 6164 6572 2062 6172 5c72 5c6e 5c72  header bar\r\n\r
+0000aad0: 5c6e 275d 2c0a 2020 2020 2020 2020 2020  \n'],.          
+0000aae0: 2020 2020 2020 5b62 2766 6f6f 2062 6172        [b'foo bar
+0000aaf0: 272c 2062 2766 6f6f 2062 617a 275d 2c0a  ', b'foo baz'],.
+0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab10: 7761 6e74 5f62 6f64 6965 735f 646f 6e65  want_bodies_done
+0000ab20: 3d5b 5472 7565 2c20 5472 7565 5d2c 0a20  =[True, True],. 
+0000ab30: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0000ab40: 2020 2020 2020 2020 2020 5465 7374 4d75            TestMu
+0000ab50: 6c74 6970 6172 7450 6172 7365 722e 5f43  ltipartParser._C
+0000ab60: 6173 6528 0a20 2020 2020 2020 2020 2020  ase(.           
+0000ab70: 2020 2020 2027 6967 6e6f 7265 2061 6674       'ignore aft
+0000ab80: 6572 2074 6572 6d69 6e61 6c20 626f 756e  er terminal boun
+0000ab90: 6461 7279 272c 0a20 2020 2020 2020 2020  dary',.         
+0000aba0: 2020 2020 2020 2062 275c 725c 6e2d 2d71         b'\r\n--q
+0000abb0: 7765 7274 7920 5c74 205c 725c 6e68 6561  werty \t \r\nhea
+0000abc0: 6465 7220 666f 6f5c 725c 6e5c 725c 6e66  der foo\r\n\r\nf
+0000abd0: 6f6f 2062 6172 5c72 5c6e 2d2d 7177 6572  oo bar\r\n--qwer
+0000abe0: 7479 2d2d 5c72 5c6e 6865 6164 6572 2062  ty--\r\nheader b
+0000abf0: 6172 5c72 5c6e 5c72 5c6e 666f 6f20 6261  ar\r\n\r\nfoo ba
+0000ac00: 7a5c 725c 6e2d 2d71 7765 7274 792d 2d5c  z\r\n--qwerty--\
+0000ac10: 725c 6e27 2c20 2023 206e 6f71 610a 2020  r\n',  # noqa.  
+0000ac20: 2020 2020 2020 2020 2020 2020 2020 5b62                [b
+0000ac30: 2768 6561 6465 7220 666f 6f5c 725c 6e5c  'header foo\r\n\
+0000ac40: 725c 6e27 5d2c 0a20 2020 2020 2020 2020  r\n'],.         
+0000ac50: 2020 2020 2020 205b 6227 666f 6f20 6261         [b'foo ba
+0000ac60: 7227 5d2c 0a20 2020 2020 2020 2020 2020  r'],.           
+0000ac70: 2020 2020 2077 616e 745f 626f 6469 6573       want_bodies
+0000ac80: 5f64 6f6e 653d 5b54 7275 655d 2c0a 2020  _done=[True],.  
+0000ac90: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+0000aca0: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+0000acb0: 6368 756e 6b5f 7369 7a65 7320 3d20 5b31  chunk_sizes = [1
+0000acc0: 2c20 322c 2033 2c20 342c 2035 2c20 372c  , 2, 3, 4, 5, 7,
+0000acd0: 2031 332c 2031 372c 2031 392c 2032 332c   13, 17, 19, 23,
+0000ace0: 2032 392c 2033 312c 2033 372c 2034 322c   29, 31, 37, 42,
+0000acf0: 2035 302c 2031 3030 2c20 3130 3030 5d0a   50, 100, 1000].
+0000ad00: 2020 2020 2020 2020 6d61 726b 6572 203d          marker =
+0000ad10: 2062 2771 7765 7274 7927 0a20 2020 2020   b'qwerty'.     
+0000ad20: 2020 2066 6f72 2069 2c20 7465 7374 2069     for i, test i
+0000ad30: 6e20 656e 756d 6572 6174 6528 7465 7374  n enumerate(test
+0000ad40: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000ad50: 666f 7220 6368 756e 6b5f 7369 7a65 2069  for chunk_size i
+0000ad60: 6e20 6368 756e 6b5f 7369 7a65 733a 0a20  n chunk_sizes:. 
+0000ad70: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0000ad80: 6561 6465 7273 203d 205b 5d0a 2020 2020  eaders = [].    
+0000ad90: 2020 2020 2020 2020 2020 2020 626f 6469              bodi
+0000ada0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+0000adb0: 2020 2020 2020 2020 626f 6469 6573 5f64          bodies_d
+0000adc0: 6f6e 6520 3d20 5b5d 0a0a 2020 2020 2020  one = []..      
+0000add0: 2020 2020 2020 2020 2020 6465 6620 6861            def ha
+0000ade0: 6e64 6c65 5f68 6561 6465 7228 6461 7461  ndle_header(data
+0000adf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000ae00: 2020 2020 2020 2068 6561 6465 7273 2e61         headers.a
+0000ae10: 7070 656e 6428 6279 7465 7328 6461 7461  ppend(bytes(data
+0000ae20: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000ae30: 2020 2020 2020 2062 6f64 6965 732e 6170         bodies.ap
+0000ae40: 7065 6e64 2862 2727 290a 2020 2020 2020  pend(b'').      
+0000ae50: 2020 2020 2020 2020 2020 2020 2020 626f                bo
+0000ae60: 6469 6573 5f64 6f6e 652e 6170 7065 6e64  dies_done.append
+0000ae70: 2846 616c 7365 290a 0a20 2020 2020 2020  (False)..       
+0000ae80: 2020 2020 2020 2020 2064 6566 2068 616e           def han
+0000ae90: 646c 655f 626f 6479 2864 6174 612c 2064  dle_body(data, d
+0000aea0: 6f6e 653d 4661 6c73 6529 3a0a 2020 2020  one=False):.    
+0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aec0: 626f 6469 6573 5b2d 315d 202b 3d20 6461  bodies[-1] += da
+0000aed0: 7461 0a20 2020 2020 2020 2020 2020 2020  ta.             
+0000aee0: 2020 2020 2020 2062 6f64 6965 735f 646f         bodies_do
+0000aef0: 6e65 5b2d 315d 203d 2064 6f6e 650a 0a20  ne[-1] = done.. 
+0000af00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000af10: 6172 7365 7220 3d20 7065 6262 6c65 2e5f  arser = pebble._
+0000af20: 4d75 6c74 6970 6172 7450 6172 7365 7228  MultipartParser(
+0000af30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000af40: 2020 2020 206d 6172 6b65 722c 0a20 2020       marker,.   
+0000af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af60: 2068 616e 646c 655f 6865 6164 6572 2c0a   handle_header,.
+0000af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af80: 2020 2020 6861 6e64 6c65 5f62 6f64 792c      handle_body,
+0000af90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000afa0: 2020 2020 206d 6178 5f62 6f75 6e64 6172       max_boundar
+0000afb0: 795f 6c65 6e67 7468 3d74 6573 742e 6d61  y_length=test.ma
+0000afc0: 785f 626f 756e 6461 7279 2c0a 2020 2020  x_boundary,.    
+0000afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000afe0: 6d61 785f 6c6f 6f6b 6168 6561 643d 7465  max_lookahead=te
+0000aff0: 7374 2e6d 6178 5f6c 6f6f 6b61 6865 6164  st.max_lookahead
+0000b000: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000b010: 2020 7372 6320 3d20 696f 2e42 7974 6573    src = io.Bytes
+0000b020: 494f 2874 6573 742e 6461 7461 290a 0a20  IO(test.data).. 
+0000b030: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000b040: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000b050: 2020 2020 2020 2020 7768 696c 6520 5472          while Tr
+0000b060: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
+0000b070: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000b080: 203d 2073 7263 2e72 6561 6428 6368 756e   = src.read(chun
+0000b090: 6b5f 7369 7a65 290a 2020 2020 2020 2020  k_size).        
+0000b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0b0: 6966 206e 6f74 2064 6174 613a 0a20 2020  if not data:.   
+0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0d0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+0000b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0f0: 2020 2020 2020 2070 6172 7365 722e 6665         parser.fe
+0000b100: 6564 2864 6174 6129 0a20 2020 2020 2020  ed(data).       
+0000b110: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0000b120: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
+0000b130: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b140: 2020 2020 2020 6966 206e 6f74 2074 6573        if not tes
+0000b150: 742e 6572 726f 723a 0a20 2020 2020 2020  t.error:.       
+0000b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b170: 2073 656c 662e 6661 696c 2827 756e 6578   self.fail('unex
+0000b180: 7065 6374 6564 2065 7272 6f72 3a27 2c20  pected error:', 
+0000b190: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
+0000b1a0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0000b1b0: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
+0000b1c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000b1d0: 7274 4571 7561 6c28 7465 7374 2e65 7272  rtEqual(test.err
+0000b1e0: 6f72 2c20 7374 7228 6572 7229 290a 2020  or, str(err)).  
+0000b1f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000b200: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000b210: 2020 2020 2020 2020 6966 2074 6573 742e          if test.
+0000b220: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
+0000b230: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000b240: 656c 662e 6661 696c 2866 276d 6973 7369  elf.fail(f'missi
+0000b250: 6e67 2065 7870 6563 7465 6420 6572 726f  ng expected erro
+0000b260: 723a 207b 7465 7374 2e65 7272 6f72 2172  r: {test.error!r
+0000b270: 7d27 290a 0a20 2020 2020 2020 2020 2020  }')..           
+0000b280: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+0000b290: 2774 6573 7420 6361 7365 207b 6920 2b20  'test case {i + 
+0000b2a0: 317d 2028 7b74 6573 742e 6e61 6d65 7d29  1} ({test.name})
+0000b2b0: 2c20 6368 756e 6b20 7369 7a65 207b 6368  , chunk size {ch
+0000b2c0: 756e 6b5f 7369 7a65 7d27 0a20 2020 2020  unk_size}'.     
+0000b2d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000b2e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000b2f0: 7465 7374 2e77 616e 745f 6865 6164 6572  test.want_header
+0000b300: 732c 2068 6561 6465 7273 2c20 6d73 6729  s, headers, msg)
+0000b310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b320: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000b330: 4571 7561 6c28 7465 7374 2e77 616e 745f  Equal(test.want_
+0000b340: 626f 6469 6573 2c20 626f 6469 6573 2c20  bodies, bodies, 
+0000b350: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0000b360: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0000b370: 7365 7274 4571 7561 6c28 7465 7374 2e77  sertEqual(test.w
+0000b380: 616e 745f 626f 6469 6573 5f64 6f6e 652c  ant_bodies_done,
+0000b390: 2062 6f64 6965 735f 646f 6e65 2c20 6d73   bodies_done, ms
+0000b3a0: 6729 0a0a 0a63 6c61 7373 2054 6573 7443  g)...class TestC
+0000b3b0: 6c69 656e 7428 756e 6974 7465 7374 2e54  lient(unittest.T
+0000b3c0: 6573 7443 6173 6529 3a0a 2020 2020 6d61  estCase):.    ma
+0000b3d0: 7844 6966 6620 3d20 4e6f 6e65 0a0a 2020  xDiff = None..  
+0000b3e0: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
+0000b3f0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000b400: 636c 6965 6e74 203d 204d 6f63 6b43 6c69  client = MockCli
+0000b410: 656e 7428 290a 2020 2020 2020 2020 7365  ent().        se
+0000b420: 6c66 2e74 696d 6520 3d20 4d6f 636b 5469  lf.time = MockTi
+0000b430: 6d65 2829 0a20 2020 2020 2020 2074 696d  me().        tim
+0000b440: 655f 7061 7463 6865 7220 3d20 756e 6974  e_patcher = unit
+0000b450: 7465 7374 2e6d 6f63 6b2e 7061 7463 6828  test.mock.patch(
+0000b460: 276f 7073 2e70 6562 626c 652e 7469 6d65  'ops.pebble.time
+0000b470: 272c 2073 656c 662e 7469 6d65 290a 2020  ', self.time).  
+0000b480: 2020 2020 2020 7469 6d65 5f70 6174 6368        time_patch
+0000b490: 6572 2e73 7461 7274 2829 0a20 2020 2020  er.start().     
+0000b4a0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0000b4b0: 7570 2874 696d 655f 7061 7463 6865 722e  up(time_patcher.
+0000b4c0: 7374 6f70 290a 0a20 2020 2064 6566 2074  stop)..    def t
+0000b4d0: 6573 745f 636c 6965 6e74 5f69 6e69 7428  est_client_init(
+0000b4e0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
+0000b4f0: 6562 626c 652e 436c 6965 6e74 2873 6f63  ebble.Client(soc
+0000b500: 6b65 745f 7061 7468 3d27 666f 6f27 2920  ket_path='foo') 
+0000b510: 2023 2074 6573 7420 7468 6174 2063 6f6e   # test that con
+0000b520: 7374 7275 6374 6f72 2072 756e 730a 2020  structor runs.  
+0000b530: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000b540: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
+0000b550: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000b560: 2020 2020 2070 6562 626c 652e 436c 6965       pebble.Clie
+0000b570: 6e74 2829 2020 2320 736f 636b 6574 5f70  nt()  # socket_p
+0000b580: 6174 6820 6172 6720 7265 7175 6972 6564  ath arg required
+0000b590: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+0000b5a0: 6574 5f73 7973 7465 6d5f 696e 666f 2873  et_system_info(s
+0000b5b0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+0000b5c0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
+0000b5d0: 7365 732e 6170 7065 6e64 287b 0a20 2020  ses.append({.   
+0000b5e0: 2020 2020 2020 2020 2022 7265 7375 6c74           "result
+0000b5f0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+0000b600: 2020 2020 2022 7665 7273 696f 6e22 3a20       "version": 
+0000b610: 2231 2e32 2e33 222c 0a20 2020 2020 2020  "1.2.3",.       
+0000b620: 2020 2020 2020 2020 2022 6578 7472 612d           "extra-
+0000b630: 6669 656c 6422 3a20 2266 6f6f 222c 0a20  field": "foo",. 
+0000b640: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+0000b650: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000b660: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+0000b670: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
+0000b680: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
+0000b690: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
+0000b6a0: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
+0000b6b0: 2020 2020 2020 2020 696e 666f 203d 2073          info = s
+0000b6c0: 656c 662e 636c 6965 6e74 2e67 6574 5f73  elf.client.get_s
+0000b6d0: 7973 7465 6d5f 696e 666f 2829 0a20 2020  ystem_info().   
+0000b6e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000b6f0: 4571 7561 6c28 696e 666f 2e76 6572 7369  Equal(info.versi
+0000b700: 6f6e 2c20 2731 2e32 2e33 2729 0a20 2020  on, '1.2.3').   
+0000b710: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000b720: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+0000b730: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+0000b740: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+0000b750: 2c20 272f 7631 2f73 7973 7465 6d2d 696e  , '/v1/system-in
+0000b760: 666f 272c 204e 6f6e 652c 204e 6f6e 6529  fo', None, None)
+0000b770: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+0000b780: 2020 6465 6620 7465 7374 5f67 6574 5f77    def test_get_w
+0000b790: 6172 6e69 6e67 7328 7365 6c66 293a 0a20  arnings(self):. 
+0000b7a0: 2020 2020 2020 2065 6d70 7479 203d 207b         empty = {
+0000b7b0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+0000b7c0: 7375 6c74 223a 205b 5d2c 0a20 2020 2020  sult": [],.     
+0000b7d0: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
+0000b7e0: 2022 4f4b 222c 0a20 2020 2020 2020 2020   "OK",.         
+0000b7f0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
+0000b800: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
+0000b810: 2020 2022 7479 7065 223a 2022 7379 6e63     "type": "sync
+0000b820: 220a 2020 2020 2020 2020 7d0a 2020 2020  ".        }.    
+0000b830: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000b840: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000b850: 2865 6d70 7479 290a 2020 2020 2020 2020  (empty).        
+0000b860: 7761 726e 696e 6773 203d 2073 656c 662e  warnings = self.
+0000b870: 636c 6965 6e74 2e67 6574 5f77 6172 6e69  client.get_warni
+0000b880: 6e67 7328 290a 2020 2020 2020 2020 7365  ngs().        se
+0000b890: 6c66 2e61 7373 6572 7445 7175 616c 2877  lf.assertEqual(w
+0000b8a0: 6172 6e69 6e67 732c 205b 5d29 0a0a 2020  arnings, [])..  
+0000b8b0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000b8c0: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+0000b8d0: 6e64 2865 6d70 7479 290a 2020 2020 2020  nd(empty).      
+0000b8e0: 2020 7761 726e 696e 6773 203d 2073 656c    warnings = sel
+0000b8f0: 662e 636c 6965 6e74 2e67 6574 5f77 6172  f.client.get_war
+0000b900: 6e69 6e67 7328 7365 6c65 6374 3d70 6562  nings(select=peb
+0000b910: 626c 652e 5761 726e 696e 6753 7461 7465  ble.WarningState
+0000b920: 2e41 4c4c 290a 2020 2020 2020 2020 7365  .ALL).        se
+0000b930: 6c66 2e61 7373 6572 7445 7175 616c 2877  lf.assertEqual(w
+0000b940: 6172 6e69 6e67 732c 205b 5d29 0a0a 2020  arnings, [])..  
+0000b950: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000b960: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
+0000b970: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
+0000b980: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+0000b990: 272c 2027 2f76 312f 7761 726e 696e 6773  ', '/v1/warnings
+0000b9a0: 272c 207b 2773 656c 6563 7427 3a20 2770  ', {'select': 'p
+0000b9b0: 656e 6469 6e67 277d 2c20 4e6f 6e65 292c  ending'}, None),
+0000b9c0: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+0000b9d0: 4554 272c 2027 2f76 312f 7761 726e 696e  ET', '/v1/warnin
+0000b9e0: 6773 272c 207b 2773 656c 6563 7427 3a20  gs', {'select': 
+0000b9f0: 2761 6c6c 277d 2c20 4e6f 6e65 292c 0a20  'all'}, None),. 
+0000ba00: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
+0000ba10: 6566 2074 6573 745f 6163 6b5f 7761 726e  ef test_ack_warn
+0000ba20: 696e 6773 2873 656c 6629 3a0a 2020 2020  ings(self):.    
+0000ba30: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000ba40: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000ba50: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
+0000ba60: 7265 7375 6c74 223a 2030 2c0a 2020 2020  result": 0,.    
+0000ba70: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+0000ba80: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
+0000ba90: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
+0000baa0: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
+0000bab0: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
+0000bac0: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
+0000bad0: 2020 2020 2020 6e75 6d20 3d20 7365 6c66        num = self
+0000bae0: 2e63 6c69 656e 742e 6163 6b5f 7761 726e  .client.ack_warn
+0000baf0: 696e 6773 2864 6174 6574 696d 655f 6e7a  ings(datetime_nz
+0000bb00: 6474 2832 3032 312c 2031 2c20 3238 2c20  dt(2021, 1, 28, 
+0000bb10: 3135 2c20 3131 2c20 3029 290a 2020 2020  15, 11, 0)).    
+0000bb20: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000bb30: 7175 616c 286e 756d 2c20 3029 0a20 2020  qual(num, 0).   
+0000bb40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000bb50: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+0000bb60: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+0000bb70: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
+0000bb80: 272c 2027 2f76 312f 7761 726e 696e 6773  ', '/v1/warnings
+0000bb90: 272c 204e 6f6e 652c 207b 0a20 2020 2020  ', None, {.     
+0000bba0: 2020 2020 2020 2020 2020 2027 6163 7469             'acti
+0000bbb0: 6f6e 273a 2027 6f6b 6179 272c 0a20 2020  on': 'okay',.   
+0000bbc0: 2020 2020 2020 2020 2020 2020 2027 7469               'ti
+0000bbd0: 6d65 7374 616d 7027 3a20 2732 3032 312d  mestamp': '2021-
+0000bbe0: 3031 2d32 3854 3135 3a31 313a 3030 2b31  01-28T15:11:00+1
+0000bbf0: 333a 3030 272c 0a20 2020 2020 2020 2020  3:00',.         
+0000bc00: 2020 207d 292c 0a20 2020 2020 2020 205d     }),.        ]
+0000bc10: 290a 0a20 2020 2064 6566 2061 7373 6572  )..    def asser
+0000bc20: 745f 6d6f 636b 5f63 6861 6e67 6528 7365  t_mock_change(se
+0000bc30: 6c66 2c20 6368 616e 6765 293a 0a20 2020  lf, change):.   
+0000bc40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000bc50: 4571 7561 6c28 6368 616e 6765 2e69 642c  Equal(change.id,
+0000bc60: 2027 3730 2729 0a20 2020 2020 2020 2073   '70').        s
+0000bc70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000bc80: 6368 616e 6765 2e6b 696e 642c 2027 6175  change.kind, 'au
+0000bc90: 746f 7374 6172 7427 290a 2020 2020 2020  tostart').      
+0000bca0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000bcb0: 616c 2863 6861 6e67 652e 7375 6d6d 6172  al(change.summar
+0000bcc0: 792c 2027 4175 746f 7374 6172 7420 7365  y, 'Autostart se
+0000bcd0: 7276 6963 6520 2273 7663 2227 290a 2020  rvice "svc"').  
+0000bce0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bcf0: 7445 7175 616c 2863 6861 6e67 652e 7374  tEqual(change.st
+0000bd00: 6174 7573 2c20 2744 6f6e 6527 290a 2020  atus, 'Done').  
+0000bd10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bd20: 7445 7175 616c 286c 656e 2863 6861 6e67  tEqual(len(chang
+0000bd30: 652e 7461 736b 7329 2c20 3129 0a20 2020  e.tasks), 1).   
+0000bd40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000bd50: 4571 7561 6c28 6368 616e 6765 2e74 6173  Equal(change.tas
+0000bd60: 6b73 5b30 5d2e 6964 2c20 2737 3827 290a  ks[0].id, '78').
+0000bd70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000bd80: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
+0000bd90: 7461 736b 735b 305d 2e6b 696e 642c 2027  tasks[0].kind, '
+0000bda0: 7374 6172 7427 290a 2020 2020 2020 2020  start').        
+0000bdb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000bdc0: 2863 6861 6e67 652e 7461 736b 735b 305d  (change.tasks[0]
+0000bdd0: 2e73 756d 6d61 7279 2c20 2753 7461 7274  .summary, 'Start
+0000bde0: 2073 6572 7669 6365 2022 7376 6322 2729   service "svc"')
+0000bdf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000be00: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+0000be10: 2e74 6173 6b73 5b30 5d2e 7374 6174 7573  .tasks[0].status
+0000be20: 2c20 2744 6f6e 6527 290a 2020 2020 2020  , 'Done').      
+0000be30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000be40: 616c 2863 6861 6e67 652e 7461 736b 735b  al(change.tasks[
+0000be50: 305d 2e6c 6f67 2c20 5b5d 290a 2020 2020  0].log, []).    
+0000be60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000be70: 7175 616c 2863 6861 6e67 652e 7461 736b  qual(change.task
+0000be80: 735b 305d 2e70 726f 6772 6573 732e 646f  s[0].progress.do
+0000be90: 6e65 2c20 3129 0a20 2020 2020 2020 2073  ne, 1).        s
+0000bea0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000beb0: 6368 616e 6765 2e74 6173 6b73 5b30 5d2e  change.tasks[0].
+0000bec0: 7072 6f67 7265 7373 2e6c 6162 656c 2c20  progress.label, 
+0000bed0: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0000bee0: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
+0000bef0: 6e67 652e 7461 736b 735b 305d 2e70 726f  nge.tasks[0].pro
+0000bf00: 6772 6573 732e 746f 7461 6c2c 2031 290a  gress.total, 1).
+0000bf10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000bf20: 6572 7445 7175 616c 2863 6861 6e67 652e  ertEqual(change.
+0000bf30: 7461 736b 735b 305d 2e72 6561 6479 5f74  tasks[0].ready_t
+0000bf40: 696d 652c 0a20 2020 2020 2020 2020 2020  ime,.           
+0000bf50: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0000bf60: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
+0000bf70: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
+0000bf80: 2033 2c20 3237 3032 3139 2929 0a20 2020   3, 270219)).   
+0000bf90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000bfa0: 4571 7561 6c28 6368 616e 6765 2e74 6173  Equal(change.tas
+0000bfb0: 6b73 5b30 5d2e 7370 6177 6e5f 7469 6d65  ks[0].spawn_time
+0000bfc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000bfd0: 2020 2020 2020 2020 2020 2064 6174 6574             datet
+0000bfe0: 696d 655f 6e7a 6474 2832 3032 312c 2031  ime_nzdt(2021, 1
+0000bff0: 2c20 3238 2c20 3134 2c20 3337 2c20 322c  , 28, 14, 37, 2,
+0000c000: 2032 3437 3135 3829 290a 2020 2020 2020   247158)).      
+0000c010: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000c020: 616c 2863 6861 6e67 652e 7265 6164 792c  al(change.ready,
+0000c030: 2054 7275 6529 0a20 2020 2020 2020 2073   True).        s
+0000c040: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000c050: 6368 616e 6765 2e65 7272 2c20 4e6f 6e65  change.err, None
+0000c060: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c070: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
+0000c080: 652e 7265 6164 795f 7469 6d65 2c20 6461  e.ready_time, da
+0000c090: 7465 7469 6d65 5f6e 7a64 7428 3230 3231  tetime_nzdt(2021
+0000c0a0: 2c20 312c 2032 382c 2031 342c 2033 372c  , 1, 28, 14, 37,
+0000c0b0: 2034 2c20 3239 3135 3138 2929 0a20 2020   4, 291518)).   
+0000c0c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c0d0: 4571 7561 6c28 6368 616e 6765 2e73 7061  Equal(change.spa
+0000c0e0: 776e 5f74 696d 652c 2064 6174 6574 696d  wn_time, datetim
+0000c0f0: 655f 6e7a 6474 2832 3032 312c 2031 2c20  e_nzdt(2021, 1, 
+0000c100: 3238 2c20 3134 2c20 3337 2c20 322c 2032  28, 14, 37, 2, 2
+0000c110: 3437 3230 3229 290a 0a20 2020 2064 6566  47202))..    def
+0000c120: 2074 6573 745f 6765 745f 6368 616e 6765   test_get_change
+0000c130: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000c140: 2065 6d70 7479 203d 207b 0a20 2020 2020   empty = {.     
+0000c150: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
+0000c160: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+0000c170: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
+0000c180: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0000c190: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
+0000c1a0: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
+0000c1b0: 7065 223a 2022 7379 6e63 220a 2020 2020  pe": "sync".    
+0000c1c0: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
+0000c1d0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
+0000c1e0: 7365 732e 6170 7065 6e64 2865 6d70 7479  ses.append(empty
+0000c1f0: 290a 2020 2020 2020 2020 6368 616e 6765  ).        change
+0000c200: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+0000c210: 6765 745f 6368 616e 6765 7328 290a 2020  get_changes().  
+0000c220: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000c230: 7445 7175 616c 2863 6861 6e67 6573 2c20  tEqual(changes, 
+0000c240: 5b5d 290a 0a20 2020 2020 2020 2073 656c  [])..        sel
+0000c250: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
+0000c260: 6573 2e61 7070 656e 6428 656d 7074 7929  es.append(empty)
+0000c270: 0a20 2020 2020 2020 2063 6861 6e67 6573  .        changes
+0000c280: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
+0000c290: 6574 5f63 6861 6e67 6573 2873 656c 6563  et_changes(selec
+0000c2a0: 743d 7065 6262 6c65 2e43 6861 6e67 6553  t=pebble.ChangeS
+0000c2b0: 7461 7465 2e41 4c4c 290a 2020 2020 2020  tate.ALL).      
+0000c2c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000c2d0: 616c 2863 6861 6e67 6573 2c20 5b5d 290a  al(changes, []).
+0000c2e0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+0000c2f0: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+0000c300: 7070 656e 6428 656d 7074 7929 0a20 2020  ppend(empty).   
+0000c310: 2020 2020 2063 6861 6e67 6573 203d 2073       changes = s
+0000c320: 656c 662e 636c 6965 6e74 2e67 6574 5f63  elf.client.get_c
+0000c330: 6861 6e67 6573 2873 656c 6563 743d 7065  hanges(select=pe
+0000c340: 6262 6c65 2e43 6861 6e67 6553 7461 7465  bble.ChangeState
+0000c350: 2e41 4c4c 2c20 7365 7276 6963 653d 2766  .ALL, service='f
+0000c360: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
+0000c370: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+0000c380: 616e 6765 732c 205b 5d29 0a0a 2020 2020  anges, [])..    
+0000c390: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000c3a0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000c3b0: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
+0000c3c0: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
+0000c3d0: 2020 2020 2020 2020 2020 2062 7569 6c64             build
+0000c3e0: 5f6d 6f63 6b5f 6368 616e 6765 5f64 6963  _mock_change_dic
+0000c3f0: 7428 292c 0a20 2020 2020 2020 2020 2020  t(),.           
+0000c400: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+0000c410: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
+0000c420: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000c430: 7475 732d 636f 6465 223a 2032 3030 2c0a  tus-code": 200,.
+0000c440: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
+0000c450: 6522 3a20 2273 796e 6322 0a20 2020 2020  e": "sync".     
+0000c460: 2020 207d 290a 2020 2020 2020 2020 6368     }).        ch
+0000c470: 616e 6765 7320 3d20 7365 6c66 2e63 6c69  anges = self.cli
+0000c480: 656e 742e 6765 745f 6368 616e 6765 7328  ent.get_changes(
+0000c490: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c4a0: 7373 6572 7445 7175 616c 286c 656e 2863  ssertEqual(len(c
+0000c4b0: 6861 6e67 6573 292c 2031 290a 2020 2020  hanges), 1).    
+0000c4c0: 2020 2020 7365 6c66 2e61 7373 6572 745f      self.assert_
+0000c4d0: 6d6f 636b 5f63 6861 6e67 6528 6368 616e  mock_change(chan
+0000c4e0: 6765 735b 305d 290a 0a20 2020 2020 2020  ges[0])..       
+0000c4f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000c500: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
+0000c510: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+0000c520: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+0000c530: 7631 2f63 6861 6e67 6573 272c 207b 2773  v1/changes', {'s
+0000c540: 656c 6563 7427 3a20 2769 6e2d 7072 6f67  elect': 'in-prog
+0000c550: 7265 7373 277d 2c20 4e6f 6e65 292c 0a20  ress'}, None),. 
+0000c560: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+0000c570: 272c 2027 2f76 312f 6368 616e 6765 7327  ', '/v1/changes'
+0000c580: 2c20 7b27 7365 6c65 6374 273a 2027 616c  , {'select': 'al
+0000c590: 6c27 7d2c 204e 6f6e 6529 2c0a 2020 2020  l'}, None),.    
+0000c5a0: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
+0000c5b0: 272f 7631 2f63 6861 6e67 6573 272c 207b  '/v1/changes', {
+0000c5c0: 2773 656c 6563 7427 3a20 2761 6c6c 272c  'select': 'all',
+0000c5d0: 2027 666f 7227 3a20 2766 6f6f 277d 2c20   'for': 'foo'}, 
+0000c5e0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000c5f0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0000c600: 6368 616e 6765 7327 2c20 7b27 7365 6c65  changes', {'sele
+0000c610: 6374 273a 2027 696e 2d70 726f 6772 6573  ct': 'in-progres
+0000c620: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
+0000c630: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+0000c640: 7465 7374 5f67 6574 5f63 6861 6e67 6528  test_get_change(
+0000c650: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0000c660: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+0000c670: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+0000c680: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+0000c690: 7422 3a20 6275 696c 645f 6d6f 636b 5f63  t": build_mock_c
+0000c6a0: 6861 6e67 655f 6469 6374 2829 2c0a 2020  hange_dict(),.  
+0000c6b0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000c6c0: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+0000c6d0: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
+0000c6e0: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
+0000c6f0: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
+0000c700: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
+0000c710: 2020 2020 2020 2020 6368 616e 6765 203d          change =
+0000c720: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
+0000c730: 5f63 6861 6e67 6528 2737 3027 290a 2020  _change('70').  
+0000c740: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000c750: 745f 6d6f 636b 5f63 6861 6e67 6528 6368  t_mock_change(ch
+0000c760: 616e 6765 290a 2020 2020 2020 2020 7365  ange).        se
+0000c770: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000c780: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+0000c790: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000c7a0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0000c7b0: 6368 616e 6765 732f 3730 272c 204e 6f6e  changes/70', Non
+0000c7c0: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
+0000c7d0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0000c7e0: 7374 5f61 626f 7274 5f63 6861 6e67 6528  st_abort_change(
+0000c7f0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0000c800: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+0000c810: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+0000c820: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+0000c830: 7422 3a20 6275 696c 645f 6d6f 636b 5f63  t": build_mock_c
+0000c840: 6861 6e67 655f 6469 6374 2829 2c0a 2020  hange_dict(),.  
+0000c850: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000c860: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+0000c870: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
+0000c880: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
+0000c890: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
+0000c8a0: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
+0000c8b0: 2020 2020 2020 2020 6368 616e 6765 203d          change =
+0000c8c0: 2073 656c 662e 636c 6965 6e74 2e61 626f   self.client.abo
+0000c8d0: 7274 5f63 6861 6e67 6528 2737 3027 290a  rt_change('70').
+0000c8e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000c8f0: 6572 745f 6d6f 636b 5f63 6861 6e67 6528  ert_mock_change(
+0000c900: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
+0000c910: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c920: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+0000c930: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+0000c940: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
+0000c950: 7631 2f63 6861 6e67 6573 2f37 3027 2c20  v1/changes/70', 
+0000c960: 4e6f 6e65 2c20 7b27 6163 7469 6f6e 273a  None, {'action':
+0000c970: 2027 6162 6f72 7427 7d29 2c0a 2020 2020   'abort'}),.    
+0000c980: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+0000c990: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
+0000c9a0: 5f68 656c 7065 7228 7365 6c66 2c20 6163  _helper(self, ac
+0000c9b0: 7469 6f6e 2c20 6170 695f 6675 6e63 2c20  tion, api_func, 
+0000c9c0: 7365 7276 6963 6573 293a 0a20 2020 2020  services):.     
+0000c9d0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+0000c9e0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+0000c9f0: 7b0a 2020 2020 2020 2020 2020 2020 2263  {.            "c
+0000ca00: 6861 6e67 6522 3a20 2237 3022 2c0a 2020  hange": "70",.  
+0000ca10: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+0000ca20: 7422 3a20 4e6f 6e65 2c0a 2020 2020 2020  t": None,.      
+0000ca30: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+0000ca40: 2241 6363 6570 7465 6422 2c0a 2020 2020  "Accepted",.    
+0000ca50: 2020 2020 2020 2020 2273 7461 7475 732d          "status-
+0000ca60: 636f 6465 223a 2032 3032 2c0a 2020 2020  code": 202,.    
+0000ca70: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+0000ca80: 2261 7379 6e63 220a 2020 2020 2020 2020  "async".        
+0000ca90: 7d29 0a20 2020 2020 2020 2063 6861 6e67  }).        chang
+0000caa0: 6520 3d20 6275 696c 645f 6d6f 636b 5f63  e = build_mock_c
+0000cab0: 6861 6e67 655f 6469 6374 2829 0a20 2020  hange_dict().   
+0000cac0: 2020 2020 2063 6861 6e67 655b 2772 6561       change['rea
+0000cad0: 6479 275d 203d 2054 7275 650a 2020 2020  dy'] = True.    
+0000cae0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000caf0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000cb00: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
+0000cb10: 7265 7375 6c74 223a 2063 6861 6e67 652c  result": change,
+0000cb20: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0000cb30: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
+0000cb40: 2020 2020 2020 2020 2022 7374 6174 7573           "status
+0000cb50: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
+0000cb60: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
+0000cb70: 2022 7379 6e63 220a 2020 2020 2020 2020   "sync".        
+0000cb80: 7d29 0a20 2020 2020 2020 2063 6861 6e67  }).        chang
+0000cb90: 655f 6964 203d 2061 7069 5f66 756e 6328  e_id = api_func(
+0000cba0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000cbb0: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
+0000cbc0: 655f 6964 2c20 2737 3027 290a 2020 2020  e_id, '70').    
+0000cbd0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000cbe0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+0000cbf0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+0000cc00: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
+0000cc10: 2c20 272f 7631 2f73 6572 7669 6365 7327  , '/v1/services'
+0000cc20: 2c20 4e6f 6e65 2c20 7b27 6163 7469 6f6e  , None, {'action
+0000cc30: 273a 2061 6374 696f 6e2c 2027 7365 7276  ': action, 'serv
+0000cc40: 6963 6573 273a 2073 6572 7669 6365 737d  ices': services}
+0000cc50: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0000cc60: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0000cc70: 6765 732f 3730 2f77 6169 7427 2c20 7b27  ges/70/wait', {'
+0000cc80: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
+0000cc90: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
+0000cca0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+0000ccb0: 5f73 6572 7669 6365 735f 6163 7469 6f6e  _services_action
+0000ccc0: 5f61 7379 6e63 5f68 656c 7065 7228 7365  _async_helper(se
+0000ccd0: 6c66 2c20 6163 7469 6f6e 2c20 6170 695f  lf, action, api_
+0000cce0: 6675 6e63 2c20 7365 7276 6963 6573 293a  func, services):
+0000ccf0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+0000cd00: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+0000cd10: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
+0000cd20: 2020 2020 2263 6861 6e67 6522 3a20 2237      "change": "7
+0000cd30: 3022 2c0a 2020 2020 2020 2020 2020 2020  0",.            
+0000cd40: 2272 6573 756c 7422 3a20 4e6f 6e65 2c0a  "result": None,.
+0000cd50: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000cd60: 7475 7322 3a20 2241 6363 6570 7465 6422  tus": "Accepted"
+0000cd70: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+0000cd80: 7461 7475 732d 636f 6465 223a 2032 3032  tatus-code": 202
+0000cd90: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+0000cda0: 7970 6522 3a20 2261 7379 6e63 220a 2020  ype": "async".  
+0000cdb0: 2020 2020 2020 7d29 0a20 2020 2020 2020        }).       
+0000cdc0: 2063 6861 6e67 655f 6964 203d 2061 7069   change_id = api
+0000cdd0: 5f66 756e 6328 7469 6d65 6f75 743d 3029  _func(timeout=0)
+0000cde0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000cdf0: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+0000ce00: 5f69 642c 2027 3730 2729 0a20 2020 2020  _id, '70').     
+0000ce10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ce20: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
+0000ce30: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
+0000ce40: 2020 2020 2020 2020 2827 504f 5354 272c          ('POST',
+0000ce50: 2027 2f76 312f 7365 7276 6963 6573 272c   '/v1/services',
+0000ce60: 204e 6f6e 652c 207b 2761 6374 696f 6e27   None, {'action'
+0000ce70: 3a20 6163 7469 6f6e 2c20 2773 6572 7669  : action, 'servi
+0000ce80: 6365 7327 3a20 7365 7276 6963 6573 7d29  ces': services})
+0000ce90: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+0000cea0: 2020 6465 6620 7465 7374 5f61 7574 6f73    def test_autos
+0000ceb0: 7461 7274 5f73 6572 7669 6365 7328 7365  tart_services(se
+0000cec0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+0000ced0: 662e 5f73 6572 7669 6365 735f 6163 7469  f._services_acti
+0000cee0: 6f6e 5f68 656c 7065 7228 2761 7574 6f73  on_helper('autos
+0000cef0: 7461 7274 272c 2073 656c 662e 636c 6965  tart', self.clie
+0000cf00: 6e74 2e61 7574 6f73 7461 7274 5f73 6572  nt.autostart_ser
+0000cf10: 7669 6365 732c 205b 5d29 0a0a 2020 2020  vices, [])..    
+0000cf20: 6465 6620 7465 7374 5f61 7574 6f73 7461  def test_autosta
+0000cf30: 7274 5f73 6572 7669 6365 735f 6173 796e  rt_services_asyn
+0000cf40: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
+0000cf50: 2073 656c 662e 5f73 6572 7669 6365 735f   self._services_
+0000cf60: 6163 7469 6f6e 5f61 7379 6e63 5f68 656c  action_async_hel
+0000cf70: 7065 7228 2761 7574 6f73 7461 7274 272c  per('autostart',
+0000cf80: 2073 656c 662e 636c 6965 6e74 2e61 7574   self.client.aut
+0000cf90: 6f73 7461 7274 5f73 6572 7669 6365 732c  ostart_services,
+0000cfa0: 205b 5d29 0a0a 2020 2020 6465 6620 7465   [])..    def te
+0000cfb0: 7374 5f72 6570 6c61 6e5f 7365 7276 6963  st_replan_servic
+0000cfc0: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
+0000cfd0: 2020 7365 6c66 2e5f 7365 7276 6963 6573    self._services
+0000cfe0: 5f61 6374 696f 6e5f 6865 6c70 6572 2827  _action_helper('
+0000cff0: 7265 706c 616e 272c 2073 656c 662e 636c  replan', self.cl
+0000d000: 6965 6e74 2e72 6570 6c61 6e5f 7365 7276  ient.replan_serv
+0000d010: 6963 6573 2c20 5b5d 290a 0a20 2020 2064  ices, [])..    d
+0000d020: 6566 2074 6573 745f 7265 706c 616e 5f73  ef test_replan_s
+0000d030: 6572 7669 6365 735f 6173 796e 6328 7365  ervices_async(se
+0000d040: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+0000d050: 662e 5f73 6572 7669 6365 735f 6163 7469  f._services_acti
+0000d060: 6f6e 5f61 7379 6e63 5f68 656c 7065 7228  on_async_helper(
+0000d070: 2772 6570 6c61 6e27 2c20 7365 6c66 2e63  'replan', self.c
+0000d080: 6c69 656e 742e 7265 706c 616e 5f73 6572  lient.replan_ser
+0000d090: 7669 6365 732c 205b 5d29 0a0a 2020 2020  vices, [])..    
+0000d0a0: 6465 6620 7465 7374 5f73 7461 7274 5f73  def test_start_s
+0000d0b0: 6572 7669 6365 7328 7365 6c66 293a 0a20  ervices(self):. 
+0000d0c0: 2020 2020 2020 2064 6566 2061 7069 5f66         def api_f
+0000d0d0: 756e 6328 293a 0a20 2020 2020 2020 2020  unc():.         
+0000d0e0: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+0000d0f0: 6c69 656e 742e 7374 6172 745f 7365 7276  lient.start_serv
+0000d100: 6963 6573 285b 2773 7663 275d 290a 2020  ices(['svc']).  
+0000d110: 2020 2020 2020 7365 6c66 2e5f 7365 7276        self._serv
+0000d120: 6963 6573 5f61 6374 696f 6e5f 6865 6c70  ices_action_help
+0000d130: 6572 2827 7374 6172 7427 2c20 6170 695f  er('start', api_
+0000d140: 6675 6e63 2c20 5b27 7376 6327 5d29 0a0a  func, ['svc'])..
+0000d150: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0000d160: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
+0000d170: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
+0000d180: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+0000d190: 6e74 2e73 7461 7274 5f73 6572 7669 6365  nt.start_service
+0000d1a0: 7328 3129 0a0a 2020 2020 2020 2020 7769  s(1)..        wi
+0000d1b0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000d1c0: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+0000d1d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000d1e0: 662e 636c 6965 6e74 2e73 7461 7274 5f73  f.client.start_s
+0000d1f0: 6572 7669 6365 7328 5b31 5d29 0a0a 2020  ervices([1])..  
+0000d200: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000d210: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
+0000d220: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000d230: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0000d240: 2e73 7461 7274 5f73 6572 7669 6365 7328  .start_services(
+0000d250: 5b5b 2766 6f6f 275d 5d29 0a0a 2020 2020  [['foo']])..    
+0000d260: 6465 6620 7465 7374 5f73 7461 7274 5f73  def test_start_s
+0000d270: 6572 7669 6365 735f 6173 796e 6328 7365  ervices_async(se
+0000d280: 6c66 293a 0a20 2020 2020 2020 2064 6566  lf):.        def
+0000d290: 2061 7069 5f66 756e 6328 7469 6d65 6f75   api_func(timeou
+0000d2a0: 743d 3330 293a 0a20 2020 2020 2020 2020  t=30):.         
+0000d2b0: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+0000d2c0: 6c69 656e 742e 7374 6172 745f 7365 7276  lient.start_serv
+0000d2d0: 6963 6573 285b 2773 7663 275d 2c20 7469  ices(['svc'], ti
+0000d2e0: 6d65 6f75 743d 7469 6d65 6f75 7429 0a20  meout=timeout). 
+0000d2f0: 2020 2020 2020 2073 656c 662e 5f73 6572         self._ser
+0000d300: 7669 6365 735f 6163 7469 6f6e 5f61 7379  vices_action_asy
+0000d310: 6e63 5f68 656c 7065 7228 2773 7461 7274  nc_helper('start
+0000d320: 272c 2061 7069 5f66 756e 632c 205b 2773  ', api_func, ['s
+0000d330: 7663 275d 290a 0a20 2020 2064 6566 2074  vc'])..    def t
+0000d340: 6573 745f 7374 6f70 5f73 6572 7669 6365  est_stop_service
+0000d350: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000d360: 2064 6566 2061 7069 5f66 756e 6328 293a   def api_func():
+0000d370: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000d380: 7572 6e20 7365 6c66 2e63 6c69 656e 742e  urn self.client.
+0000d390: 7374 6f70 5f73 6572 7669 6365 7328 5b27  stop_services(['
+0000d3a0: 7376 6327 5d29 0a20 2020 2020 2020 2073  svc']).        s
+0000d3b0: 656c 662e 5f73 6572 7669 6365 735f 6163  elf._services_ac
+0000d3c0: 7469 6f6e 5f68 656c 7065 7228 2773 746f  tion_helper('sto
+0000d3d0: 7027 2c20 6170 695f 6675 6e63 2c20 5b27  p', api_func, ['
+0000d3e0: 7376 6327 5d29 0a0a 2020 2020 2020 2020  svc'])..        
+0000d3f0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000d400: 5261 6973 6573 2854 7970 6545 7272 6f72  Raises(TypeError
+0000d410: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0000d420: 656c 662e 636c 6965 6e74 2e73 746f 705f  elf.client.stop_
+0000d430: 7365 7276 6963 6573 2831 290a 0a20 2020  services(1)..   
+0000d440: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000d450: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+0000d460: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0000d470: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000d480: 7374 6f70 5f73 6572 7669 6365 7328 5b31  stop_services([1
+0000d490: 5d29 0a0a 2020 2020 2020 2020 7769 7468  ])..        with
+0000d4a0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000d4b0: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
+0000d4c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d4d0: 636c 6965 6e74 2e73 746f 705f 7365 7276  client.stop_serv
+0000d4e0: 6963 6573 285b 5b27 666f 6f27 5d5d 290a  ices([['foo']]).
+0000d4f0: 0a20 2020 2064 6566 2074 6573 745f 7374  .    def test_st
+0000d500: 6f70 5f73 6572 7669 6365 735f 6173 796e  op_services_asyn
+0000d510: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
+0000d520: 2064 6566 2061 7069 5f66 756e 6328 7469   def api_func(ti
+0000d530: 6d65 6f75 743d 3330 293a 0a20 2020 2020  meout=30):.     
+0000d540: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000d550: 6c66 2e63 6c69 656e 742e 7374 6f70 5f73  lf.client.stop_s
+0000d560: 6572 7669 6365 7328 5b27 7376 6327 5d2c  ervices(['svc'],
+0000d570: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
+0000d580: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+0000d590: 7365 7276 6963 6573 5f61 6374 696f 6e5f  services_action_
+0000d5a0: 6173 796e 635f 6865 6c70 6572 2827 7374  async_helper('st
+0000d5b0: 6f70 272c 2061 7069 5f66 756e 632c 205b  op', api_func, [
+0000d5c0: 2773 7663 275d 290a 0a20 2020 2064 6566  'svc'])..    def
+0000d5d0: 2074 6573 745f 7265 7374 6172 745f 7365   test_restart_se
+0000d5e0: 7276 6963 6573 2873 656c 6629 3a0a 2020  rvices(self):.  
+0000d5f0: 2020 2020 2020 6465 6620 6170 695f 6675        def api_fu
+0000d600: 6e63 2829 3a0a 2020 2020 2020 2020 2020  nc():.          
+0000d610: 2020 7265 7475 726e 2073 656c 662e 636c    return self.cl
+0000d620: 6965 6e74 2e72 6573 7461 7274 5f73 6572  ient.restart_ser
+0000d630: 7669 6365 7328 5b27 7376 6327 5d29 0a20  vices(['svc']). 
+0000d640: 2020 2020 2020 2073 656c 662e 5f73 6572         self._ser
+0000d650: 7669 6365 735f 6163 7469 6f6e 5f68 656c  vices_action_hel
+0000d660: 7065 7228 2772 6573 7461 7274 272c 2061  per('restart', a
+0000d670: 7069 5f66 756e 632c 205b 2773 7663 275d  pi_func, ['svc']
+0000d680: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+0000d690: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0000d6a0: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
+0000d6b0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0000d6c0: 6c69 656e 742e 7265 7374 6172 745f 7365  lient.restart_se
+0000d6d0: 7276 6963 6573 2831 290a 0a20 2020 2020  rvices(1)..     
+0000d6e0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000d6f0: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
+0000d700: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000d710: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000d720: 7374 6172 745f 7365 7276 6963 6573 285b  start_services([
+0000d730: 315d 290a 0a20 2020 2020 2020 2077 6974  1])..        wit
+0000d740: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000d750: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
+0000d760: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000d770: 2e63 6c69 656e 742e 7265 7374 6172 745f  .client.restart_
+0000d780: 7365 7276 6963 6573 285b 5b27 666f 6f27  services([['foo'
+0000d790: 5d5d 290a 0a20 2020 2064 6566 2074 6573  ]])..    def tes
+0000d7a0: 745f 7265 7374 6172 745f 7365 7276 6963  t_restart_servic
+0000d7b0: 6573 5f61 7379 6e63 2873 656c 6629 3a0a  es_async(self):.
+0000d7c0: 2020 2020 2020 2020 6465 6620 6170 695f          def api_
+0000d7d0: 6675 6e63 2874 696d 656f 7574 3d33 3029  func(timeout=30)
+0000d7e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000d7f0: 7475 726e 2073 656c 662e 636c 6965 6e74  turn self.client
+0000d800: 2e72 6573 7461 7274 5f73 6572 7669 6365  .restart_service
+0000d810: 7328 5b27 7376 6327 5d2c 2074 696d 656f  s(['svc'], timeo
+0000d820: 7574 3d74 696d 656f 7574 290a 2020 2020  ut=timeout).    
+0000d830: 2020 2020 7365 6c66 2e5f 7365 7276 6963      self._servic
+0000d840: 6573 5f61 6374 696f 6e5f 6173 796e 635f  es_action_async_
+0000d850: 6865 6c70 6572 2827 7265 7374 6172 7427  helper('restart'
+0000d860: 2c20 6170 695f 6675 6e63 2c20 5b27 7376  , api_func, ['sv
+0000d870: 6327 5d29 0a0a 2020 2020 6465 6620 7465  c'])..    def te
+0000d880: 7374 5f63 6861 6e67 655f 6572 726f 7228  st_change_error(
+0000d890: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0000d8a0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+0000d8b0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+0000d8c0: 2020 2020 2020 2020 2020 2263 6861 6e67            "chang
+0000d8d0: 6522 3a20 2237 3022 2c0a 2020 2020 2020  e": "70",.      
+0000d8e0: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
+0000d8f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0000d900: 2020 2273 7461 7475 7322 3a20 2241 6363    "status": "Acc
+0000d910: 6570 7465 6422 2c0a 2020 2020 2020 2020  epted",.        
+0000d920: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
+0000d930: 223a 2032 3032 2c0a 2020 2020 2020 2020  ": 202,.        
+0000d940: 2020 2020 2274 7970 6522 3a20 2261 7379      "type": "asy
+0000d950: 6e63 220a 2020 2020 2020 2020 7d29 0a20  nc".        }). 
+0000d960: 2020 2020 2020 2063 6861 6e67 6520 3d20         change = 
+0000d970: 6275 696c 645f 6d6f 636b 5f63 6861 6e67  build_mock_chang
+0000d980: 655f 6469 6374 2829 0a20 2020 2020 2020  e_dict().       
+0000d990: 2063 6861 6e67 655b 2765 7272 275d 203d   change['err'] =
+0000d9a0: 2027 536f 6d65 206b 696e 6420 6f66 2073   'Some kind of s
+0000d9b0: 6572 7669 6365 2065 7272 6f72 270a 2020  ervice error'.  
+0000d9c0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000d9d0: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+0000d9e0: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
+0000d9f0: 2022 7265 7375 6c74 223a 2063 6861 6e67   "result": chang
+0000da00: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+0000da10: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
+0000da20: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+0000da30: 7573 2d63 6f64 6522 3a20 3230 302c 0a20  us-code": 200,. 
+0000da40: 2020 2020 2020 2020 2020 2022 7479 7065             "type
+0000da50: 223a 2022 7379 6e63 220a 2020 2020 2020  ": "sync".      
+0000da60: 2020 7d29 0a20 2020 2020 2020 2077 6974    }).        wit
+0000da70: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000da80: 7365 7328 7065 6262 6c65 2e43 6861 6e67  ses(pebble.Chang
+0000da90: 6545 7272 6f72 2920 6173 2063 6d3a 0a20  eError) as cm:. 
+0000daa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000dab0: 636c 6965 6e74 2e61 7574 6f73 7461 7274  client.autostart
+0000dac0: 5f73 6572 7669 6365 7328 290a 2020 2020  _services().    
+0000dad0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+0000dae0: 7349 6e73 7461 6e63 6528 636d 2e65 7863  sInstance(cm.exc
+0000daf0: 6570 7469 6f6e 2c20 7065 6262 6c65 2e45  eption, pebble.E
+0000db00: 7272 6f72 290a 2020 2020 2020 2020 7365  rror).        se
+0000db10: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000db20: 6d2e 6578 6365 7074 696f 6e2e 6572 722c  m.exception.err,
+0000db30: 2027 536f 6d65 206b 696e 6420 6f66 2073   'Some kind of s
+0000db40: 6572 7669 6365 2065 7272 6f72 2729 0a20  ervice error'). 
+0000db50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000db60: 7274 4973 496e 7374 616e 6365 2863 6d2e  rtIsInstance(cm.
+0000db70: 6578 6365 7074 696f 6e2e 6368 616e 6765  exception.change
+0000db80: 2c20 7065 6262 6c65 2e43 6861 6e67 6529  , pebble.Change)
 0000db90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000dba0: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
-0000dbb0: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
-0000dbc0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-0000dbd0: 4745 5427 2c20 272f 7631 2f63 6861 6e67  GET', '/v1/chang
-0000dbe0: 6573 2f37 302f 7761 6974 272c 207b 2774  es/70/wait', {'t
-0000dbf0: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
-0000dc00: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
-0000dc10: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-0000dc20: 6573 745f 7761 6974 5f63 6861 6e67 655f  est_wait_change_
-0000dc30: 7375 6363 6573 735f 7469 6d65 6f75 745f  success_timeout_
-0000dc40: 6e6f 6e65 2873 656c 6629 3a0a 2020 2020  none(self):.    
-0000dc50: 2020 2020 7365 6c66 2e74 6573 745f 7761      self.test_wa
-0000dc60: 6974 5f63 6861 6e67 655f 7375 6363 6573  it_change_succes
-0000dc70: 7328 7469 6d65 6f75 743d 4e6f 6e65 290a  s(timeout=None).
-0000dc80: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
-0000dc90: 6974 5f63 6861 6e67 655f 7375 6363 6573  it_change_succes
-0000dca0: 735f 6d75 6c74 6970 6c65 5f63 616c 6c73  s_multiple_calls
-0000dcb0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000dcc0: 6465 6620 7469 6d65 6f75 745f 7265 7370  def timeout_resp
-0000dcd0: 6f6e 7365 286e 293a 0a20 2020 2020 2020  onse(n):.       
-0000dce0: 2020 2020 2073 656c 662e 7469 6d65 2e73       self.time.s
-0000dcf0: 6c65 6570 286e 2920 2023 2073 696d 756c  leep(n)  # simul
-0000dd00: 6174 6520 7061 7373 696e 6720 6f66 2074  ate passing of t
-0000dd10: 696d 6520 6475 6520 746f 2077 6169 745f  ime due to wait_
-0000dd20: 6368 616e 6765 2063 616c 6c0a 2020 2020  change call.    
-0000dd30: 2020 2020 2020 2020 7261 6973 6520 7065          raise pe
-0000dd40: 6262 6c65 2e41 5049 4572 726f 7228 7b7d  bble.APIError({}
-0000dd50: 2c20 3530 342c 2022 4761 7465 7761 7920  , 504, "Gateway 
-0000dd60: 5469 6d65 6f75 7422 2c20 2274 696d 6564  Timeout", "timed
-0000dd70: 206f 7574 2229 0a0a 2020 2020 2020 2020   out")..        
-0000dd80: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
-0000dd90: 6f6e 7365 732e 6170 7065 6e64 286c 616d  onses.append(lam
-0000dda0: 6264 613a 2074 696d 656f 7574 5f72 6573  bda: timeout_res
-0000ddb0: 706f 6e73 6528 3429 290a 0a20 2020 2020  ponse(4))..     
-0000ddc0: 2020 2063 6861 6e67 6520 3d20 6275 696c     change = buil
-0000ddd0: 645f 6d6f 636b 5f63 6861 6e67 655f 6469  d_mock_change_di
-0000dde0: 6374 2829 0a20 2020 2020 2020 2073 656c  ct().        sel
-0000ddf0: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-0000de00: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
-0000de10: 2020 2020 2020 2020 2272 6573 756c 7422          "result"
-0000de20: 3a20 6368 616e 6765 2c0a 2020 2020 2020  : change,.      
-0000de30: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-0000de40: 224f 4b22 2c0a 2020 2020 2020 2020 2020  "OK",.          
-0000de50: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
-0000de60: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
-0000de70: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
-0000de80: 0a20 2020 2020 2020 207d 290a 0a20 2020  .        })..   
-0000de90: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-0000dea0: 7365 6c66 2e63 6c69 656e 742e 7761 6974  self.client.wait
-0000deb0: 5f63 6861 6e67 6528 2737 3027 290a 2020  _change('70').  
-0000dec0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000ded0: 7445 7175 616c 2872 6573 706f 6e73 652e  tEqual(response.
-0000dee0: 6964 2c20 2737 3027 290a 2020 2020 2020  id, '70').      
-0000def0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000df00: 6528 7265 7370 6f6e 7365 2e72 6561 6479  e(response.ready
-0000df10: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000df20: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000df30: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-0000df40: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0000df50: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
-0000df60: 6e67 6573 2f37 302f 7761 6974 272c 207b  nges/70/wait', {
-0000df70: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
-0000df80: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
-0000df90: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0000dfa0: 2027 2f76 312f 6368 616e 6765 732f 3730   '/v1/changes/70
-0000dfb0: 2f77 6169 7427 2c20 7b27 7469 6d65 6f75  /wait', {'timeou
-0000dfc0: 7427 3a20 2734 2e30 3030 7327 7d2c 204e  t': '4.000s'}, N
-0000dfd0: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-0000dfe0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0000dff0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-0000e000: 7469 6d65 2e74 696d 6528 292c 2034 290a  time.time(), 4).
-0000e010: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
-0000e020: 6974 5f63 6861 6e67 655f 7375 6363 6573  it_change_succes
-0000e030: 735f 706f 6c6c 6564 2873 656c 662c 2074  s_polled(self, t
-0000e040: 696d 656f 7574 3d33 302e 3029 3a0a 2020  imeout=30.0):.  
-0000e050: 2020 2020 2020 2320 5472 6967 6765 7220        # Trigger 
-0000e060: 706f 6c6c 6564 206d 6f64 650a 2020 2020  polled mode.    
-0000e070: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000e080: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000e090: 2870 6562 626c 652e 4150 4945 7272 6f72  (pebble.APIError
-0000e0a0: 287b 7d2c 2034 3034 2c20 224e 6f74 2046  ({}, 404, "Not F
-0000e0b0: 6f75 6e64 222c 2022 6e6f 7420 666f 756e  ound", "not foun
-0000e0c0: 6422 2929 0a0a 2020 2020 2020 2020 666f  d"))..        fo
-0000e0d0: 7220 6920 696e 2072 616e 6765 2833 293a  r i in range(3):
-0000e0e0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
-0000e0f0: 6e67 6520 3d20 6275 696c 645f 6d6f 636b  nge = build_mock
-0000e100: 5f63 6861 6e67 655f 6469 6374 2829 0a20  _change_dict(). 
-0000e110: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
-0000e120: 655b 2772 6561 6479 275d 203d 2069 203d  e['ready'] = i =
-0000e130: 3d20 320a 2020 2020 2020 2020 2020 2020  = 2.            
-0000e140: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
-0000e150: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
-0000e160: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e170: 7265 7375 6c74 223a 2063 6861 6e67 652c  result": change,
-0000e180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e190: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
-0000e1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e1b0: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
-0000e1c0: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
-0000e1d0: 2020 2020 2022 7479 7065 223a 2022 7379       "type": "sy
-0000e1e0: 6e63 220a 2020 2020 2020 2020 2020 2020  nc".            
-0000e1f0: 7d29 0a0a 2020 2020 2020 2020 7265 7370  })..        resp
-0000e200: 6f6e 7365 203d 2073 656c 662e 636c 6965  onse = self.clie
-0000e210: 6e74 2e77 6169 745f 6368 616e 6765 2827  nt.wait_change('
-0000e220: 3730 272c 2074 696d 656f 7574 3d74 696d  70', timeout=tim
-0000e230: 656f 7574 2c20 6465 6c61 793d 3129 0a20  eout, delay=1). 
-0000e240: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000e250: 7274 4571 7561 6c28 7265 7370 6f6e 7365  rtEqual(response
-0000e260: 2e69 642c 2027 3730 2729 0a20 2020 2020  .id, '70').     
-0000e270: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000e280: 7565 2872 6573 706f 6e73 652e 7265 6164  ue(response.read
-0000e290: 7929 0a0a 2020 2020 2020 2020 7365 6c66  y)..        self
+0000dba0: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
+0000dbb0: 6570 7469 6f6e 2e63 6861 6e67 652e 6964  eption.change.id
+0000dbc0: 2c20 2737 3027 290a 0a20 2020 2020 2020  , '70')..       
+0000dbd0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000dbe0: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
+0000dbf0: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+0000dc00: 2020 2020 2020 2827 504f 5354 272c 2027        ('POST', '
+0000dc10: 2f76 312f 7365 7276 6963 6573 272c 204e  /v1/services', N
+0000dc20: 6f6e 652c 207b 2761 6374 696f 6e27 3a20  one, {'action': 
+0000dc30: 2761 7574 6f73 7461 7274 272c 2027 7365  'autostart', 'se
+0000dc40: 7276 6963 6573 273a 205b 5d7d 292c 0a20  rvices': []}),. 
+0000dc50: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+0000dc60: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
+0000dc70: 3730 2f77 6169 7427 2c20 7b27 7469 6d65  70/wait', {'time
+0000dc80: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
+0000dc90: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0000dca0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+0000dcb0: 5f77 6169 745f 6368 616e 6765 5f73 7563  _wait_change_suc
+0000dcc0: 6365 7373 2873 656c 662c 2074 696d 656f  cess(self, timeo
+0000dcd0: 7574 3d33 302e 3029 3a0a 2020 2020 2020  ut=30.0):.      
+0000dce0: 2020 6368 616e 6765 203d 2062 7569 6c64    change = build
+0000dcf0: 5f6d 6f63 6b5f 6368 616e 6765 5f64 6963  _mock_change_dic
+0000dd00: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0000dd10: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
+0000dd20: 732e 6170 7065 6e64 287b 0a20 2020 2020  s.append({.     
+0000dd30: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
+0000dd40: 2063 6861 6e67 652c 0a20 2020 2020 2020   change,.       
+0000dd50: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
+0000dd60: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
+0000dd70: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
+0000dd80: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
+0000dd90: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
+0000dda0: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
+0000ddb0: 2020 2020 7265 7370 6f6e 7365 203d 2073      response = s
+0000ddc0: 656c 662e 636c 6965 6e74 2e77 6169 745f  elf.client.wait_
+0000ddd0: 6368 616e 6765 2827 3730 272c 2074 696d  change('70', tim
+0000dde0: 656f 7574 3d74 696d 656f 7574 290a 2020  eout=timeout).  
+0000ddf0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000de00: 7445 7175 616c 2872 6573 706f 6e73 652e  tEqual(response.
+0000de10: 6964 2c20 2737 3027 290a 2020 2020 2020  id, '70').      
+0000de20: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+0000de30: 6528 7265 7370 6f6e 7365 2e72 6561 6479  e(response.ready
+0000de40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000de50: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000de60: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
+0000de70: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0000de80: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
+0000de90: 6e67 6573 2f37 302f 7761 6974 272c 207b  nges/70/wait', {
+0000dea0: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
+0000deb0: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
+0000dec0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+0000ded0: 2074 6573 745f 7761 6974 5f63 6861 6e67   test_wait_chang
+0000dee0: 655f 7375 6363 6573 735f 7469 6d65 6f75  e_success_timeou
+0000def0: 745f 6e6f 6e65 2873 656c 6629 3a0a 2020  t_none(self):.  
+0000df00: 2020 2020 2020 7365 6c66 2e74 6573 745f        self.test_
+0000df10: 7761 6974 5f63 6861 6e67 655f 7375 6363  wait_change_succ
+0000df20: 6573 7328 7469 6d65 6f75 743d 4e6f 6e65  ess(timeout=None
+0000df30: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000df40: 7761 6974 5f63 6861 6e67 655f 7375 6363  wait_change_succ
+0000df50: 6573 735f 6d75 6c74 6970 6c65 5f63 616c  ess_multiple_cal
+0000df60: 6c73 2873 656c 6629 3a0a 2020 2020 2020  ls(self):.      
+0000df70: 2020 6465 6620 7469 6d65 6f75 745f 7265    def timeout_re
+0000df80: 7370 6f6e 7365 286e 293a 0a20 2020 2020  sponse(n):.     
+0000df90: 2020 2020 2020 2073 656c 662e 7469 6d65         self.time
+0000dfa0: 2e73 6c65 6570 286e 2920 2023 2073 696d  .sleep(n)  # sim
+0000dfb0: 756c 6174 6520 7061 7373 696e 6720 6f66  ulate passing of
+0000dfc0: 2074 696d 6520 6475 6520 746f 2077 6169   time due to wai
+0000dfd0: 745f 6368 616e 6765 2063 616c 6c0a 2020  t_change call.  
+0000dfe0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000dff0: 7065 6262 6c65 2e41 5049 4572 726f 7228  pebble.APIError(
+0000e000: 7b7d 2c20 3530 342c 2022 4761 7465 7761  {}, 504, "Gatewa
+0000e010: 7920 5469 6d65 6f75 7422 2c20 2274 696d  y Timeout", "tim
+0000e020: 6564 206f 7574 2229 0a0a 2020 2020 2020  ed out")..      
+0000e030: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000e040: 7370 6f6e 7365 732e 6170 7065 6e64 286c  sponses.append(l
+0000e050: 616d 6264 613a 2074 696d 656f 7574 5f72  ambda: timeout_r
+0000e060: 6573 706f 6e73 6528 3429 290a 0a20 2020  esponse(4))..   
+0000e070: 2020 2020 2063 6861 6e67 6520 3d20 6275       change = bu
+0000e080: 696c 645f 6d6f 636b 5f63 6861 6e67 655f  ild_mock_change_
+0000e090: 6469 6374 2829 0a20 2020 2020 2020 2073  dict().        s
+0000e0a0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+0000e0b0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+0000e0c0: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+0000e0d0: 7422 3a20 6368 616e 6765 2c0a 2020 2020  t": change,.    
+0000e0e0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+0000e0f0: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
+0000e100: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
+0000e110: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
+0000e120: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
+0000e130: 6322 0a20 2020 2020 2020 207d 290a 0a20  c".        }).. 
+0000e140: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+0000e150: 3d20 7365 6c66 2e63 6c69 656e 742e 7761  = self.client.wa
+0000e160: 6974 5f63 6861 6e67 6528 2737 3027 290a  it_change('70').
+0000e170: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000e180: 6572 7445 7175 616c 2872 6573 706f 6e73  ertEqual(respons
+0000e190: 652e 6964 2c20 2737 3027 290a 2020 2020  e.id, '70').    
+0000e1a0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+0000e1b0: 7275 6528 7265 7370 6f6e 7365 2e72 6561  rue(response.rea
+0000e1c0: 6479 290a 0a20 2020 2020 2020 2073 656c  dy)..        sel
+0000e1d0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000e1e0: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
+0000e1f0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
+0000e200: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
+0000e210: 6861 6e67 6573 2f37 302f 7761 6974 272c  hanges/70/wait',
+0000e220: 207b 2774 696d 656f 7574 273a 2027 342e   {'timeout': '4.
+0000e230: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
+0000e240: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+0000e250: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
+0000e260: 3730 2f77 6169 7427 2c20 7b27 7469 6d65  70/wait', {'time
+0000e270: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
+0000e280: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0000e290: 5d29 0a0a 2020 2020 2020 2020 7365 6c66  ])..        self
 0000e2a0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000e2b0: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-0000e2c0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-0000e2d0: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
-0000e2e0: 616e 6765 732f 3730 2f77 6169 7427 2c20  anges/70/wait', 
-0000e2f0: 7b27 7469 6d65 6f75 7427 3a20 2734 2e30  {'timeout': '4.0
-0000e300: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
-0000e310: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
-0000e320: 2c20 272f 7631 2f63 6861 6e67 6573 2f37  , '/v1/changes/7
-0000e330: 3027 2c20 4e6f 6e65 2c20 4e6f 6e65 292c  0', None, None),
-0000e340: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-0000e350: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
-0000e360: 732f 3730 272c 204e 6f6e 652c 204e 6f6e  s/70', None, Non
-0000e370: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000e380: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
-0000e390: 6e67 6573 2f37 3027 2c20 4e6f 6e65 2c20  nges/70', None, 
-0000e3a0: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-0000e3b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000e3c0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000e3d0: 2e74 696d 652e 7469 6d65 2829 2c20 3229  .time.time(), 2)
-0000e3e0: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
-0000e3f0: 6169 745f 6368 616e 6765 5f73 7563 6365  ait_change_succe
-0000e400: 7373 5f70 6f6c 6c65 645f 7469 6d65 6f75  ss_polled_timeou
-0000e410: 745f 6e6f 6e65 2873 656c 6629 3a0a 2020  t_none(self):.  
-0000e420: 2020 2020 2020 7365 6c66 2e74 6573 745f        self.test_
-0000e430: 7761 6974 5f63 6861 6e67 655f 7375 6363  wait_change_succ
-0000e440: 6573 735f 706f 6c6c 6564 2874 696d 656f  ess_polled(timeo
-0000e450: 7574 3d4e 6f6e 6529 0a0a 2020 2020 6465  ut=None)..    de
-0000e460: 6620 7465 7374 5f77 6169 745f 6368 616e  f test_wait_chan
-0000e470: 6765 5f74 696d 656f 7574 2873 656c 6629  ge_timeout(self)
-0000e480: 3a0a 2020 2020 2020 2020 6465 6620 7469  :.        def ti
-0000e490: 6d65 6f75 745f 7265 7370 6f6e 7365 286e  meout_response(n
-0000e4a0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-0000e4b0: 656c 662e 7469 6d65 2e73 6c65 6570 286e  elf.time.sleep(n
-0000e4c0: 2920 2023 2073 696d 756c 6174 6520 7061  )  # simulate pa
-0000e4d0: 7373 696e 6720 6f66 2074 696d 6520 6475  ssing of time du
-0000e4e0: 6520 746f 2077 6169 745f 6368 616e 6765  e to wait_change
-0000e4f0: 2063 616c 6c0a 2020 2020 2020 2020 2020   call.          
-0000e500: 2020 7261 6973 6520 7065 6262 6c65 2e41    raise pebble.A
-0000e510: 5049 4572 726f 7228 7b7d 2c20 3530 342c  PIError({}, 504,
-0000e520: 2022 4761 7465 7761 7920 5469 6d65 6f75   "Gateway Timeou
-0000e530: 7422 2c20 2274 696d 6564 206f 7574 2229  t", "timed out")
-0000e540: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-0000e550: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
-0000e560: 6170 7065 6e64 286c 616d 6264 613a 2074  append(lambda: t
-0000e570: 696d 656f 7574 5f72 6573 706f 6e73 6528  imeout_response(
-0000e580: 3429 290a 2020 2020 2020 2020 7365 6c66  4)).        self
-0000e590: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-0000e5a0: 732e 6170 7065 6e64 286c 616d 6264 613a  s.append(lambda:
-0000e5b0: 2074 696d 656f 7574 5f72 6573 706f 6e73   timeout_respons
-0000e5c0: 6528 3229 290a 0a20 2020 2020 2020 2077  e(2))..        w
-0000e5d0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0000e5e0: 6169 7365 7328 7065 6262 6c65 2e54 696d  aises(pebble.Tim
-0000e5f0: 656f 7574 4572 726f 7229 2061 7320 636d  eoutError) as cm
-0000e600: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000e610: 6c66 2e63 6c69 656e 742e 7761 6974 5f63  lf.client.wait_c
-0000e620: 6861 6e67 6528 2737 3027 2c20 7469 6d65  hange('70', time
-0000e630: 6f75 743d 3629 0a20 2020 2020 2020 2073  out=6).        s
-0000e640: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-0000e650: 616e 6365 2863 6d2e 6578 6365 7074 696f  ance(cm.exceptio
-0000e660: 6e2c 2070 6562 626c 652e 4572 726f 7229  n, pebble.Error)
-0000e670: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000e680: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
-0000e690: 6d2e 6578 6365 7074 696f 6e2c 2054 696d  m.exception, Tim
-0000e6a0: 656f 7574 4572 726f 7229 0a0a 2020 2020  eoutError)..    
-0000e6b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000e6c0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-0000e6d0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-0000e6e0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-0000e6f0: 2027 2f76 312f 6368 616e 6765 732f 3730   '/v1/changes/70
-0000e700: 2f77 6169 7427 2c20 7b27 7469 6d65 6f75  /wait', {'timeou
-0000e710: 7427 3a20 2734 2e30 3030 7327 7d2c 204e  t': '4.000s'}, N
-0000e720: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
-0000e730: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
-0000e740: 6861 6e67 6573 2f37 302f 7761 6974 272c  hanges/70/wait',
-0000e750: 207b 2774 696d 656f 7574 273a 2027 322e   {'timeout': '2.
-0000e760: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
-0000e770: 2020 2020 2020 205d 290a 0a20 2020 2020         ])..     
-0000e780: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000e790: 7561 6c28 7365 6c66 2e74 696d 652e 7469  ual(self.time.ti
-0000e7a0: 6d65 2829 2c20 3629 0a0a 2020 2020 6465  me(), 6)..    de
-0000e7b0: 6620 7465 7374 5f77 6169 745f 6368 616e  f test_wait_chan
-0000e7c0: 6765 5f74 696d 656f 7574 5f70 6f6c 6c65  ge_timeout_polle
-0000e7d0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-0000e7e0: 2023 2054 7269 6767 6572 2070 6f6c 6c65   # Trigger polle
-0000e7f0: 6420 6d6f 6465 0a20 2020 2020 2020 2073  d mode.        s
-0000e800: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-0000e810: 6e73 6573 2e61 7070 656e 6428 7065 6262  nses.append(pebb
-0000e820: 6c65 2e41 5049 4572 726f 7228 7b7d 2c20  le.APIError({}, 
-0000e830: 3430 342c 2022 4e6f 7420 466f 756e 6422  404, "Not Found"
-0000e840: 2c20 226e 6f74 2066 6f75 6e64 2229 290a  , "not found")).
-0000e850: 0a20 2020 2020 2020 2063 6861 6e67 6520  .        change 
-0000e860: 3d20 6275 696c 645f 6d6f 636b 5f63 6861  = build_mock_cha
-0000e870: 6e67 655f 6469 6374 2829 0a20 2020 2020  nge_dict().     
-0000e880: 2020 2063 6861 6e67 655b 2772 6561 6479     change['ready
-0000e890: 275d 203d 2046 616c 7365 0a20 2020 2020  '] = False.     
-0000e8a0: 2020 2066 6f72 205f 2069 6e20 7261 6e67     for _ in rang
-0000e8b0: 6528 3329 3a0a 2020 2020 2020 2020 2020  e(3):.          
-0000e8c0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-0000e8d0: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-0000e8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e8f0: 2022 7265 7375 6c74 223a 2063 6861 6e67   "result": chang
-0000e900: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000e910: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
-0000e920: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000e930: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
-0000e940: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
-0000e950: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
-0000e960: 7379 6e63 220a 2020 2020 2020 2020 2020  sync".          
-0000e970: 2020 7d29 0a0a 2020 2020 2020 2020 7769    })..        wi
-0000e980: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-0000e990: 6973 6573 2870 6562 626c 652e 5469 6d65  ises(pebble.Time
-0000e9a0: 6f75 7445 7272 6f72 2920 6173 2063 6d3a  outError) as cm:
-0000e9b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000e9c0: 662e 636c 6965 6e74 2e77 6169 745f 6368  f.client.wait_ch
-0000e9d0: 616e 6765 2827 3730 272c 2074 696d 656f  ange('70', timeo
-0000e9e0: 7574 3d33 2c20 6465 6c61 793d 3129 0a20  ut=3, delay=1). 
-0000e9f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000ea00: 7274 4973 496e 7374 616e 6365 2863 6d2e  rtIsInstance(cm.
-0000ea10: 6578 6365 7074 696f 6e2c 2070 6562 626c  exception, pebbl
-0000ea20: 652e 4572 726f 7229 0a20 2020 2020 2020  e.Error).       
-0000ea30: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0000ea40: 7374 616e 6365 2863 6d2e 6578 6365 7074  stance(cm.except
-0000ea50: 696f 6e2c 2054 696d 656f 7574 4572 726f  ion, TimeoutErro
-0000ea60: 7229 0a0a 2020 2020 2020 2020 7365 6c66  r)..        self
-0000ea70: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000ea80: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-0000ea90: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-0000eaa0: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
-0000eab0: 616e 6765 732f 3730 2f77 6169 7427 2c20  anges/70/wait', 
-0000eac0: 7b27 7469 6d65 6f75 7427 3a20 2733 2e30  {'timeout': '3.0
-0000ead0: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
-0000eae0: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
-0000eaf0: 2c20 272f 7631 2f63 6861 6e67 6573 2f37  , '/v1/changes/7
-0000eb00: 3027 2c20 4e6f 6e65 2c20 4e6f 6e65 292c  0', None, None),
-0000eb10: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-0000eb20: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
-0000eb30: 732f 3730 272c 204e 6f6e 652c 204e 6f6e  s/70', None, Non
-0000eb40: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000eb50: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
-0000eb60: 6e67 6573 2f37 3027 2c20 4e6f 6e65 2c20  nges/70', None, 
-0000eb70: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-0000eb80: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000eb90: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0000eba0: 2e74 696d 652e 7469 6d65 2829 2c20 3329  .time.time(), 3)
-0000ebb0: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
-0000ebc0: 6169 745f 6368 616e 6765 5f65 7272 6f72  ait_change_error
-0000ebd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000ebe0: 6368 616e 6765 203d 2062 7569 6c64 5f6d  change = build_m
-0000ebf0: 6f63 6b5f 6368 616e 6765 5f64 6963 7428  ock_change_dict(
-0000ec00: 290a 2020 2020 2020 2020 6368 616e 6765  ).        change
-0000ec10: 5b27 6572 7227 5d20 3d20 2753 6f6d 6520  ['err'] = 'Some 
-0000ec20: 6b69 6e64 206f 6620 7365 7276 6963 6520  kind of service 
-0000ec30: 6572 726f 7227 0a20 2020 2020 2020 2073  error'.        s
-0000ec40: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-0000ec50: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-0000ec60: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-0000ec70: 7422 3a20 6368 616e 6765 2c0a 2020 2020  t": change,.    
-0000ec80: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000ec90: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000eca0: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000ecb0: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000ecc0: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000ecd0: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
-0000ece0: 2020 2020 2020 2320 7761 6974 5f63 6861        # wait_cha
-0000ecf0: 6e67 6528 2920 6974 7365 6c66 2073 686f  nge() itself sho
-0000ed00: 756c 646e 2774 2072 6169 7365 2061 6e20  uldn't raise an 
-0000ed10: 6572 726f 720a 2020 2020 2020 2020 7265  error.        re
-0000ed20: 7370 6f6e 7365 203d 2073 656c 662e 636c  sponse = self.cl
-0000ed30: 6965 6e74 2e77 6169 745f 6368 616e 6765  ient.wait_change
-0000ed40: 2827 3730 2729 0a20 2020 2020 2020 2073  ('70').        s
-0000ed50: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000ed60: 7265 7370 6f6e 7365 2e69 642c 2027 3730  response.id, '70
-0000ed70: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000ed80: 6173 7365 7274 4571 7561 6c28 7265 7370  assertEqual(resp
-0000ed90: 6f6e 7365 2e65 7272 2c20 2753 6f6d 6520  onse.err, 'Some 
-0000eda0: 6b69 6e64 206f 6620 7365 7276 6963 6520  kind of service 
-0000edb0: 6572 726f 7227 290a 0a20 2020 2020 2020  error')..       
-0000edc0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000edd0: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-0000ede0: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000edf0: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-0000ee00: 7631 2f63 6861 6e67 6573 2f37 302f 7761  v1/changes/70/wa
-0000ee10: 6974 272c 207b 2774 696d 656f 7574 273a  it', {'timeout':
-0000ee20: 2027 342e 3030 3073 277d 2c20 4e6f 6e65   '4.000s'}, None
-0000ee30: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-0000ee40: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
-0000ee50: 6c61 7965 7228 7365 6c66 293a 0a20 2020  layer(self):.   
-0000ee60: 2020 2020 206f 6b61 795f 7265 7370 6f6e       okay_respon
-0000ee70: 7365 203d 207b 0a20 2020 2020 2020 2020  se = {.         
-0000ee80: 2020 2022 7265 7375 6c74 223a 2054 7275     "result": Tru
-0000ee90: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-0000eea0: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
-0000eeb0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-0000eec0: 7573 2d63 6f64 6522 3a20 3230 302c 0a20  us-code": 200,. 
-0000eed0: 2020 2020 2020 2020 2020 2022 7479 7065             "type
-0000eee0: 223a 2022 7379 6e63 220a 2020 2020 2020  ": "sync".      
-0000eef0: 2020 7d0a 2020 2020 2020 2020 7365 6c66    }.        self
-0000ef00: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-0000ef10: 732e 6170 7065 6e64 286f 6b61 795f 7265  s.append(okay_re
-0000ef20: 7370 6f6e 7365 290a 2020 2020 2020 2020  sponse).        
-0000ef30: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
-0000ef40: 6f6e 7365 732e 6170 7065 6e64 286f 6b61  onses.append(oka
-0000ef50: 795f 7265 7370 6f6e 7365 290a 2020 2020  y_response).    
-0000ef60: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-0000ef70: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-0000ef80: 286f 6b61 795f 7265 7370 6f6e 7365 290a  (okay_response).
-0000ef90: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0000efa0: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
-0000efb0: 7065 6e64 286f 6b61 795f 7265 7370 6f6e  pend(okay_respon
-0000efc0: 7365 290a 0a20 2020 2020 2020 206c 6179  se)..        lay
-0000efd0: 6572 5f79 616d 6c20 3d20 2222 220a 7365  er_yaml = """.se
-0000efe0: 7276 6963 6573 3a0a 2020 666f 6f3a 0a20  rvices:.  foo:. 
-0000eff0: 2020 2063 6f6d 6d61 6e64 3a20 6563 686f     command: echo
-0000f000: 2062 6172 0a20 2020 206f 7665 7272 6964   bar.    overrid
-0000f010: 653a 2072 6570 6c61 6365 0a22 2222 5b31  e: replace."""[1
-0000f020: 3a5d 0a20 2020 2020 2020 206c 6179 6572  :].        layer
-0000f030: 203d 2070 6562 626c 652e 4c61 7965 7228   = pebble.Layer(
-0000f040: 6c61 7965 725f 7961 6d6c 290a 0a20 2020  layer_yaml)..   
-0000f050: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0000f060: 2e61 6464 5f6c 6179 6572 2827 6127 2c20  .add_layer('a', 
-0000f070: 6c61 7965 7229 0a20 2020 2020 2020 2073  layer).        s
-0000f080: 656c 662e 636c 6965 6e74 2e61 6464 5f6c  elf.client.add_l
-0000f090: 6179 6572 2827 6227 2c20 6c61 7965 722e  ayer('b', layer.
-0000f0a0: 746f 5f79 616d 6c28 2929 0a20 2020 2020  to_yaml()).     
-0000f0b0: 2020 2073 656c 662e 636c 6965 6e74 2e61     self.client.a
-0000f0c0: 6464 5f6c 6179 6572 2827 6327 2c20 6c61  dd_layer('c', la
-0000f0d0: 7965 722e 746f 5f64 6963 7428 2929 0a20  yer.to_dict()). 
-0000f0e0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0000f0f0: 6e74 2e61 6464 5f6c 6179 6572 2827 6427  nt.add_layer('d'
-0000f100: 2c20 6c61 7965 722c 2063 6f6d 6269 6e65  , layer, combine
-0000f110: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
-0000f120: 6465 6620 6275 696c 645f 6578 7065 6374  def build_expect
-0000f130: 6564 286c 6162 656c 2c20 636f 6d62 696e  ed(label, combin
-0000f140: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0000f150: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
-0000f160: 2020 2020 2020 2020 2027 6163 7469 6f6e           'action
-0000f170: 273a 2027 6164 6427 2c0a 2020 2020 2020  ': 'add',.      
-0000f180: 2020 2020 2020 2020 2020 2763 6f6d 6269            'combi
-0000f190: 6e65 273a 2063 6f6d 6269 6e65 2c0a 2020  ne': combine,.  
-0000f1a0: 2020 2020 2020 2020 2020 2020 2020 276c                'l
-0000f1b0: 6162 656c 273a 206c 6162 656c 2c0a 2020  abel': label,.  
-0000f1c0: 2020 2020 2020 2020 2020 2020 2020 2766                'f
-0000f1d0: 6f72 6d61 7427 3a20 2779 616d 6c27 2c0a  ormat': 'yaml',.
-0000f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1f0: 276c 6179 6572 273a 206c 6179 6572 5f79  'layer': layer_y
-0000f200: 616d 6c2c 0a20 2020 2020 2020 2020 2020  aml,.           
-0000f210: 207d 0a0a 2020 2020 2020 2020 7365 6c66   }..        self
-0000f220: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0000f230: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-0000f240: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-0000f250: 2028 2750 4f53 5427 2c20 272f 7631 2f6c   ('POST', '/v1/l
-0000f260: 6179 6572 7327 2c20 4e6f 6e65 2c20 6275  ayers', None, bu
-0000f270: 696c 645f 6578 7065 6374 6564 2827 6127  ild_expected('a'
-0000f280: 2c20 4661 6c73 6529 292c 0a20 2020 2020  , False)),.     
-0000f290: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
-0000f2a0: 272f 7631 2f6c 6179 6572 7327 2c20 4e6f  '/v1/layers', No
-0000f2b0: 6e65 2c20 6275 696c 645f 6578 7065 6374  ne, build_expect
-0000f2c0: 6564 2827 6227 2c20 4661 6c73 6529 292c  ed('b', False)),
-0000f2d0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
-0000f2e0: 4f53 5427 2c20 272f 7631 2f6c 6179 6572  OST', '/v1/layer
-0000f2f0: 7327 2c20 4e6f 6e65 2c20 6275 696c 645f  s', None, build_
-0000f300: 6578 7065 6374 6564 2827 6327 2c20 4661  expected('c', Fa
-0000f310: 6c73 6529 292c 0a20 2020 2020 2020 2020  lse)),.         
-0000f320: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-0000f330: 2f6c 6179 6572 7327 2c20 4e6f 6e65 2c20  /layers', None, 
-0000f340: 6275 696c 645f 6578 7065 6374 6564 2827  build_expected('
-0000f350: 6427 2c20 5472 7565 2929 2c0a 2020 2020  d', True)),.    
-0000f360: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-0000f370: 7465 7374 5f61 6464 5f6c 6179 6572 5f69  test_add_layer_i
-0000f380: 6e76 616c 6964 5f74 7970 6528 7365 6c66  nvalid_type(self
-0000f390: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
-0000f3a0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000f3b0: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
-0000f3c0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0000f3d0: 6c69 656e 742e 6164 645f 6c61 7965 7228  lient.add_layer(
-0000f3e0: 2766 6f6f 272c 2034 3229 0a20 2020 2020  'foo', 42).     
-0000f3f0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000f400: 6572 7452 6169 7365 7328 5479 7065 4572  ertRaises(TypeEr
-0000f410: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000f420: 2020 7365 6c66 2e63 6c69 656e 742e 6164    self.client.ad
-0000f430: 645f 6c61 7965 7228 3432 2c20 2766 6f6f  d_layer(42, 'foo
-0000f440: 2729 0a0a 2020 2020 2020 2020 2320 636f  ')..        # co
-0000f450: 6d62 696e 6520 6973 2061 206b 6579 776f  mbine is a keywo
-0000f460: 7264 2d6f 6e6c 7920 6172 6720 2873 686f  rd-only arg (sho
-0000f470: 756c 6420 6265 2063 6f6d 6269 6e65 3d54  uld be combine=T
-0000f480: 7275 6529 0a20 2020 2020 2020 2077 6974  rue).        wit
-0000f490: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000f4a0: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-0000f4b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f4c0: 2e63 6c69 656e 742e 6164 645f 6c61 7965  .client.add_laye
-0000f4d0: 7228 2766 6f6f 272c 207b 7d2c 2054 7275  r('foo', {}, Tru
-0000f4e0: 6529 0a0a 2020 2020 6465 6620 7465 7374  e)..    def test
-0000f4f0: 5f67 6574 5f70 6c61 6e28 7365 6c66 293a  _get_plan(self):
-0000f500: 0a20 2020 2020 2020 2070 6c61 6e5f 7961  .        plan_ya
-0000f510: 6d6c 203d 2022 2222 0a73 6572 7669 6365  ml = """.service
-0000f520: 733a 0a20 2066 6f6f 3a0a 2020 2020 636f  s:.  foo:.    co
-0000f530: 6d6d 616e 643a 2065 6368 6f20 6261 720a  mmand: echo bar.
-0000f540: 2020 2020 6f76 6572 7269 6465 3a20 7265      override: re
-0000f550: 706c 6163 650a 2222 225b 313a 5d0a 2020  place."""[1:].  
-0000f560: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000f570: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
-0000f580: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
-0000f590: 2022 7265 7375 6c74 223a 2070 6c61 6e5f   "result": plan_
-0000f5a0: 7961 6d6c 2c0a 2020 2020 2020 2020 2020  yaml,.          
-0000f5b0: 2020 2273 7461 7475 7322 3a20 224f 4b22    "status": "OK"
-0000f5c0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0000f5d0: 7461 7475 732d 636f 6465 223a 2032 3030  tatus-code": 200
-0000f5e0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-0000f5f0: 7970 6522 3a20 2273 796e 6322 0a20 2020  ype": "sync".   
-0000f600: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
-0000f610: 706c 616e 203d 2073 656c 662e 636c 6965  plan = self.clie
-0000f620: 6e74 2e67 6574 5f70 6c61 6e28 290a 2020  nt.get_plan().  
-0000f630: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f640: 7445 7175 616c 2870 6c61 6e2e 746f 5f79  tEqual(plan.to_y
-0000f650: 616d 6c28 292c 2070 6c61 6e5f 7961 6d6c  aml(), plan_yaml
-0000f660: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000f670: 7373 6572 7445 7175 616c 286c 656e 2870  ssertEqual(len(p
-0000f680: 6c61 6e2e 7365 7276 6963 6573 292c 2031  lan.services), 1
-0000f690: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000f6a0: 7373 6572 7445 7175 616c 2870 6c61 6e2e  ssertEqual(plan.
-0000f6b0: 7365 7276 6963 6573 5b27 666f 6f27 5d2e  services['foo'].
-0000f6c0: 636f 6d6d 616e 642c 2027 6563 686f 2062  command, 'echo b
-0000f6d0: 6172 2729 0a20 2020 2020 2020 2073 656c  ar').        sel
-0000f6e0: 662e 6173 7365 7274 4571 7561 6c28 706c  f.assertEqual(pl
-0000f6f0: 616e 2e73 6572 7669 6365 735b 2766 6f6f  an.services['foo
-0000f700: 275d 2e6f 7665 7272 6964 652c 2027 7265  '].override, 're
-0000f710: 706c 6163 6527 290a 0a20 2020 2020 2020  place')..       
-0000f720: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000f730: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-0000f740: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-0000f750: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-0000f760: 7631 2f70 6c61 6e27 2c20 7b27 666f 726d  v1/plan', {'form
-0000f770: 6174 273a 2027 7961 6d6c 277d 2c20 4e6f  at': 'yaml'}, No
-0000f780: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-0000f790: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
-0000f7a0: 745f 7365 7276 6963 6573 5f61 6c6c 2873  t_services_all(s
-0000f7b0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000f7c0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
-0000f7d0: 7365 732e 6170 7065 6e64 287b 0a20 2020  ses.append({.   
-0000f7e0: 2020 2020 2020 2020 2022 7265 7375 6c74           "result
-0000f7f0: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
-0000f800: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0000f810: 2020 2020 2020 2020 2020 2022 6375 7272             "curr
-0000f820: 656e 7422 3a20 2269 6e61 6374 6976 6522  ent": "inactive"
-0000f830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f840: 2020 2020 2020 226e 616d 6522 3a20 2273        "name": "s
-0000f850: 7663 3122 2c0a 2020 2020 2020 2020 2020  vc1",.          
-0000f860: 2020 2020 2020 2020 2020 2273 7461 7274            "start
-0000f870: 7570 223a 2022 6469 7361 626c 6564 220a  up": "disabled".
-0000f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f890: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0000f8a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0000f8b0: 2020 2020 2020 2020 2022 6375 7272 656e           "curren
-0000f8c0: 7422 3a20 2261 6374 6976 6522 2c0a 2020  t": "active",.  
-0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8e0: 2020 226e 616d 6522 3a20 2273 7663 3222    "name": "svc2"
-0000f8f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f900: 2020 2020 2020 2273 7461 7274 7570 223a        "startup":
-0000f910: 2022 656e 6162 6c65 6422 0a20 2020 2020   "enabled".     
-0000f920: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0000f930: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0000f940: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000f950: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000f960: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000f970: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000f980: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000f990: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
-0000f9a0: 2020 2020 2020 7365 7276 6963 6573 203d        services =
-0000f9b0: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
-0000f9c0: 5f73 6572 7669 6365 7328 290a 2020 2020  _services().    
-0000f9d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000f9e0: 7175 616c 286c 656e 2873 6572 7669 6365  qual(len(service
-0000f9f0: 7329 2c20 3229 0a20 2020 2020 2020 2073  s), 2).        s
-0000fa00: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000fa10: 7365 7276 6963 6573 5b30 5d2e 6e61 6d65  services[0].name
-0000fa20: 2c20 2773 7663 3127 290a 2020 2020 2020  , 'svc1').      
-0000fa30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000fa40: 616c 2873 6572 7669 6365 735b 305d 2e73  al(services[0].s
-0000fa50: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
-0000fa60: 6572 7669 6365 5374 6172 7475 702e 4449  erviceStartup.DI
-0000fa70: 5341 424c 4544 290a 2020 2020 2020 2020  SABLED).        
-0000fa80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000fa90: 2873 6572 7669 6365 735b 305d 2e63 7572  (services[0].cur
-0000faa0: 7265 6e74 2c20 7065 6262 6c65 2e53 6572  rent, pebble.Ser
-0000fab0: 7669 6365 5374 6174 7573 2e49 4e41 4354  viceStatus.INACT
-0000fac0: 4956 4529 0a20 2020 2020 2020 2073 656c  IVE).        sel
-0000fad0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000fae0: 7276 6963 6573 5b31 5d2e 6e61 6d65 2c20  rvices[1].name, 
-0000faf0: 2773 7663 3227 290a 2020 2020 2020 2020  'svc2').        
-0000fb00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000fb10: 2873 6572 7669 6365 735b 315d 2e73 7461  (services[1].sta
-0000fb20: 7274 7570 2c20 7065 6262 6c65 2e53 6572  rtup, pebble.Ser
-0000fb30: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
-0000fb40: 4c45 4429 0a20 2020 2020 2020 2073 656c  LED).        sel
-0000fb50: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000fb60: 7276 6963 6573 5b31 5d2e 6375 7272 656e  rvices[1].curren
-0000fb70: 742c 2070 6562 626c 652e 5365 7276 6963  t, pebble.Servic
-0000fb80: 6553 7461 7475 732e 4143 5449 5645 290a  eStatus.ACTIVE).
-0000fb90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0000fba0: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
-0000fbb0: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
-0000fbc0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-0000fbd0: 4745 5427 2c20 272f 7631 2f73 6572 7669  GET', '/v1/servi
-0000fbe0: 6365 7327 2c20 4e6f 6e65 2c20 4e6f 6e65  ces', None, None
-0000fbf0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-0000fc00: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-0000fc10: 7365 7276 6963 6573 5f6e 616d 6573 2873  services_names(s
-0000fc20: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-0000fc30: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
-0000fc40: 7365 732e 6170 7065 6e64 287b 0a20 2020  ses.append({.   
-0000fc50: 2020 2020 2020 2020 2022 7265 7375 6c74           "result
-0000fc60: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
-0000fc70: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0000fc80: 2020 2020 2020 2020 2020 2022 6375 7272             "curr
-0000fc90: 656e 7422 3a20 2269 6e61 6374 6976 6522  ent": "inactive"
-0000fca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fcb0: 2020 2020 2020 226e 616d 6522 3a20 2273        "name": "s
-0000fcc0: 7663 3122 2c0a 2020 2020 2020 2020 2020  vc1",.          
-0000fcd0: 2020 2020 2020 2020 2020 2273 7461 7274            "start
-0000fce0: 7570 223a 2022 6469 7361 626c 6564 220a  up": "disabled".
-0000fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd00: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0000fd10: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0000fd20: 2020 2020 2020 2020 2022 6375 7272 656e           "curren
-0000fd30: 7422 3a20 2261 6374 6976 6522 2c0a 2020  t": "active",.  
-0000fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd50: 2020 226e 616d 6522 3a20 2273 7663 3222    "name": "svc2"
-0000fd60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fd70: 2020 2020 2020 2273 7461 7274 7570 223a        "startup":
-0000fd80: 2022 656e 6162 6c65 6422 0a20 2020 2020   "enabled".     
-0000fd90: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0000fda0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0000fdb0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0000fdc0: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
-0000fdd0: 2020 2020 2273 7461 7475 732d 636f 6465      "status-code
-0000fde0: 223a 2032 3030 2c0a 2020 2020 2020 2020  ": 200,.        
-0000fdf0: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
-0000fe00: 6322 0a20 2020 2020 2020 207d 290a 2020  c".        }).  
-0000fe10: 2020 2020 2020 7365 7276 6963 6573 203d        services =
-0000fe20: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
-0000fe30: 5f73 6572 7669 6365 7328 5b27 7376 6331  _services(['svc1
-0000fe40: 272c 2027 7376 6332 275d 290a 2020 2020  ', 'svc2']).    
-0000fe50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000fe60: 7175 616c 286c 656e 2873 6572 7669 6365  qual(len(service
-0000fe70: 7329 2c20 3229 0a20 2020 2020 2020 2073  s), 2).        s
-0000fe80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000fe90: 7365 7276 6963 6573 5b30 5d2e 6e61 6d65  services[0].name
-0000fea0: 2c20 2773 7663 3127 290a 2020 2020 2020  , 'svc1').      
-0000feb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000fec0: 616c 2873 6572 7669 6365 735b 305d 2e73  al(services[0].s
-0000fed0: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
-0000fee0: 6572 7669 6365 5374 6172 7475 702e 4449  erviceStartup.DI
-0000fef0: 5341 424c 4544 290a 2020 2020 2020 2020  SABLED).        
-0000ff00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ff10: 2873 6572 7669 6365 735b 305d 2e63 7572  (services[0].cur
-0000ff20: 7265 6e74 2c20 7065 6262 6c65 2e53 6572  rent, pebble.Ser
-0000ff30: 7669 6365 5374 6174 7573 2e49 4e41 4354  viceStatus.INACT
-0000ff40: 4956 4529 0a20 2020 2020 2020 2073 656c  IVE).        sel
-0000ff50: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000ff60: 7276 6963 6573 5b31 5d2e 6e61 6d65 2c20  rvices[1].name, 
-0000ff70: 2773 7663 3227 290a 2020 2020 2020 2020  'svc2').        
-0000ff80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ff90: 2873 6572 7669 6365 735b 315d 2e73 7461  (services[1].sta
-0000ffa0: 7274 7570 2c20 7065 6262 6c65 2e53 6572  rtup, pebble.Ser
-0000ffb0: 7669 6365 5374 6172 7475 702e 454e 4142  viceStartup.ENAB
-0000ffc0: 4c45 4429 0a20 2020 2020 2020 2073 656c  LED).        sel
-0000ffd0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0000ffe0: 7276 6963 6573 5b31 5d2e 6375 7272 656e  rvices[1].curren
-0000fff0: 742c 2070 6562 626c 652e 5365 7276 6963  t, pebble.Servic
-00010000: 6553 7461 7475 732e 4143 5449 5645 290a  eStatus.ACTIVE).
-00010010: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00010020: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-00010030: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
-00010040: 2020 2020 2272 6573 756c 7422 3a20 5b0a      "result": [.
-00010050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010060: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00010070: 2020 2020 2020 2263 7572 7265 6e74 223a        "current":
-00010080: 2022 6163 7469 7665 222c 0a20 2020 2020   "active",.     
-00010090: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000100a0: 6e61 6d65 223a 2022 7376 6332 222c 0a20  name": "svc2",. 
-000100b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100c0: 2020 2022 7374 6172 7475 7022 3a20 2265     "startup": "e
-000100d0: 6e61 626c 6564 220a 2020 2020 2020 2020  nabled".        
-000100e0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000100f0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00010100: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
-00010110: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
-00010120: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
-00010130: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
-00010140: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
-00010150: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
-00010160: 2020 2073 6572 7669 6365 7320 3d20 7365     services = se
-00010170: 6c66 2e63 6c69 656e 742e 6765 745f 7365  lf.client.get_se
-00010180: 7276 6963 6573 285b 2773 7663 3227 5d29  rvices(['svc2'])
-00010190: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000101a0: 7365 7274 4571 7561 6c28 6c65 6e28 7365  sertEqual(len(se
-000101b0: 7276 6963 6573 292c 2031 290a 2020 2020  rvices), 1).    
-000101c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000101d0: 7175 616c 2873 6572 7669 6365 735b 305d  qual(services[0]
-000101e0: 2e6e 616d 652c 2027 7376 6332 2729 0a20  .name, 'svc2'). 
-000101f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00010200: 7274 4571 7561 6c28 7365 7276 6963 6573  rtEqual(services
-00010210: 5b30 5d2e 7374 6172 7475 702c 2070 6562  [0].startup, peb
-00010220: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
-00010230: 7570 2e45 4e41 424c 4544 290a 2020 2020  up.ENABLED).    
-00010240: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00010250: 7175 616c 2873 6572 7669 6365 735b 305d  qual(services[0]
-00010260: 2e63 7572 7265 6e74 2c20 7065 6262 6c65  .current, pebble
-00010270: 2e53 6572 7669 6365 5374 6174 7573 2e41  .ServiceStatus.A
-00010280: 4354 4956 4529 0a0a 2020 2020 2020 2020  CTIVE)..        
-00010290: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000102a0: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-000102b0: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-000102c0: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
-000102d0: 312f 7365 7276 6963 6573 272c 207b 276e  1/services', {'n
-000102e0: 616d 6573 273a 2027 7376 6331 2c73 7663  ames': 'svc1,svc
-000102f0: 3227 7d2c 204e 6f6e 6529 2c0a 2020 2020  2'}, None),.    
-00010300: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-00010310: 272f 7631 2f73 6572 7669 6365 7327 2c20  '/v1/services', 
-00010320: 7b27 6e61 6d65 7327 3a20 2773 7663 3227  {'names': 'svc2'
-00010330: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
-00010340: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-00010350: 7374 5f70 756c 6c5f 626f 756e 6461 7279  st_pull_boundary
-00010360: 5f73 7061 6e6e 696e 675f 6368 756e 6b28  _spanning_chunk(
-00010370: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00010380: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-00010390: 6e73 6573 2e61 7070 656e 6428 280a 2020  nses.append((.  
-000103a0: 2020 2020 2020 2020 2020 7b27 436f 6e74            {'Cont
-000103b0: 656e 742d 5479 7065 273a 2027 6d75 6c74  ent-Type': 'mult
-000103c0: 6970 6172 742f 666f 726d 2d64 6174 613b  ipart/form-data;
-000103d0: 2062 6f75 6e64 6172 793d 3031 3233 3435   boundary=012345
-000103e0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
-000103f0: 3233 3435 3637 3839 3031 277d 2c0a 2020  2345678901'},.  
-00010400: 2020 2020 2020 2020 2020 6222 2222 5c0a            b"""\.
-00010410: 2d2d 3031 3233 3435 3637 3839 3031 3233  --01234567890123
-00010420: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-00010430: 3031 5c72 0a43 6f6e 7465 6e74 2d44 6973  01\r.Content-Dis
-00010440: 706f 7369 7469 6f6e 3a20 666f 726d 2d64  position: form-d
-00010450: 6174 613b 206e 616d 653d 2266 696c 6573  ata; name="files
-00010460: 223b 2066 696c 656e 616d 653d 222f 6574  "; filename="/et
-00010470: 632f 686f 7374 7322 5c72 0a5c 720a 3132  c/hosts"\r.\r.12
-00010480: 372e 302e 302e 3120 6c6f 6361 6c68 6f73  7.0.0.1 localhos
-00010490: 7420 2023 205c 7866 305c 7839 665c 7839  t  # \xf0\x9f\x9
-000104a0: 385c 7838 305c 6e66 6f6f 5c72 5c6e 6261  8\x80\nfoo\r\nba
-000104b0: 725c 720a 2d2d 3031 3233 3435 3637 3839  r\r.--0123456789
-000104c0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
-000104d0: 3637 3839 3031 5c72 0a43 6f6e 7465 6e74  678901\r.Content
-000104e0: 2d44 6973 706f 7369 7469 6f6e 3a20 666f  -Disposition: fo
-000104f0: 726d 2d64 6174 613b 206e 616d 653d 2272  rm-data; name="r
-00010500: 6573 706f 6e73 6522 5c72 0a5c 720a 7b0a  esponse"\r.\r.{.
-00010510: 2020 2020 2272 6573 756c 7422 3a20 5b7b      "result": [{
-00010520: 2270 6174 6822 3a20 222f 6574 632f 686f  "path": "/etc/ho
-00010530: 7374 7322 7d5d 2c0a 2020 2020 2273 7461  sts"}],.    "sta
-00010540: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
-00010550: 2273 7461 7475 732d 636f 6465 223a 2032  "status-code": 2
-00010560: 3030 2c0a 2020 2020 2274 7970 6522 3a20  00,.    "type": 
-00010570: 2273 796e 6322 0a7d 5c72 0a2d 2d30 3132  "sync".}\r.--012
-00010580: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
-00010590: 3930 3132 3334 3536 3738 3930 312d 2d5c  9012345678901--\
-000105a0: 720a 2222 222c 0a20 2020 2020 2020 2029  r.""",.        )
-000105b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000105c0: 636c 6965 6e74 2e5f 6368 756e 6b5f 7369  client._chunk_si
-000105d0: 7a65 203d 2031 330a 2020 2020 2020 2020  ze = 13.        
-000105e0: 7769 7468 2073 656c 662e 636c 6965 6e74  with self.client
-000105f0: 2e70 756c 6c28 272f 6574 632f 686f 7374  .pull('/etc/host
-00010600: 7327 2920 6173 2069 6e66 696c 653a 0a20  s') as infile:. 
-00010610: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-00010620: 6e74 203d 2069 6e66 696c 652e 7265 6164  nt = infile.read
-00010630: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00010640: 6173 7365 7274 4571 7561 6c28 636f 6e74  assertEqual(cont
-00010650: 656e 742c 2027 3132 372e 302e 302e 3120  ent, '127.0.0.1 
-00010660: 6c6f 6361 6c68 6f73 7420 2023 20f0 9f98  localhost  # ...
-00010670: 805c 6e66 6f6f 5c72 5c6e 6261 7227 290a  .\nfoo\r\nbar').
-00010680: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00010690: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
-000106a0: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
-000106b0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-000106c0: 4745 5427 2c20 272f 7631 2f66 696c 6573  GET', '/v1/files
-000106d0: 272c 207b 2761 6374 696f 6e27 3a20 2772  ', {'action': 'r
-000106e0: 6561 6427 2c20 2770 6174 6827 3a20 272f  ead', 'path': '/
-000106f0: 6574 632f 686f 7374 7327 7d2c 0a20 2020  etc/hosts'},.   
-00010700: 2020 2020 2020 2020 2020 2020 207b 2741               {'A
-00010710: 6363 6570 7427 3a20 276d 756c 7469 7061  ccept': 'multipa
-00010720: 7274 2f66 6f72 6d2d 6461 7461 277d 2c20  rt/form-data'}, 
-00010730: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-00010740: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00010750: 7075 6c6c 5f74 6578 7428 7365 6c66 293a  pull_text(self):
-00010760: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00010770: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-00010780: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
-00010790: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
-000107a0: 7065 273a 2027 6d75 6c74 6970 6172 742f  pe': 'multipart/
-000107b0: 666f 726d 2d64 6174 613b 2062 6f75 6e64  form-data; bound
-000107c0: 6172 793d 3031 3233 3435 3637 3839 3031  ary=012345678901
-000107d0: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-000107e0: 3839 3031 277d 2c0a 2020 2020 2020 2020  8901'},.        
-000107f0: 2020 2020 6222 2222 5c0a 2d2d 3031 3233      b"""\.--0123
-00010800: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-00010810: 3031 3233 3435 3637 3839 3031 5c72 0a43  012345678901\r.C
-00010820: 6f6e 7465 6e74 2d44 6973 706f 7369 7469  ontent-Dispositi
-00010830: 6f6e 3a20 666f 726d 2d64 6174 613b 206e  on: form-data; n
-00010840: 616d 653d 2266 696c 6573 223b 2066 696c  ame="files"; fil
-00010850: 656e 616d 653d 222f 6574 632f 686f 7374  ename="/etc/host
-00010860: 7322 5c72 0a5c 720a 3132 372e 302e 302e  s"\r.\r.127.0.0.
-00010870: 3120 6c6f 6361 6c68 6f73 7420 2023 205c  1 localhost  # \
-00010880: 7866 305c 7839 665c 7839 385c 7838 305c  xf0\x9f\x98\x80\
-00010890: 6e66 6f6f 5c72 5c6e 6261 725c 720a 2d2d  nfoo\r\nbar\r.--
-000108a0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
-000108b0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
-000108c0: 5c72 0a43 6f6e 7465 6e74 2d44 6973 706f  \r.Content-Dispo
-000108d0: 7369 7469 6f6e 3a20 666f 726d 2d64 6174  sition: form-dat
-000108e0: 613b 206e 616d 653d 2272 6573 706f 6e73  a; name="respons
-000108f0: 6522 5c72 0a5c 720a 7b0a 2020 2020 2272  e"\r.\r.{.    "r
-00010900: 6573 756c 7422 3a20 5b7b 2270 6174 6822  esult": [{"path"
-00010910: 3a20 222f 6574 632f 686f 7374 7322 7d5d  : "/etc/hosts"}]
-00010920: 2c0a 2020 2020 2273 7461 7475 7322 3a20  ,.    "status": 
-00010930: 224f 4b22 2c0a 2020 2020 2273 7461 7475  "OK",.    "statu
-00010940: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
-00010950: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
-00010960: 0a7d 5c72 0a2d 2d30 3132 3334 3536 3738  .}\r.--012345678
-00010970: 3930 3132 3334 3536 3738 3930 3132 3334  9012345678901234
-00010980: 3536 3738 3930 312d 2d5c 720a 2222 222c  5678901--\r.""",
-00010990: 0a20 2020 2020 2020 2029 290a 0a20 2020  .        ))..   
-000109a0: 2020 2020 2077 6974 6820 7365 6c66 2e63       with self.c
-000109b0: 6c69 656e 742e 7075 6c6c 2827 2f65 7463  lient.pull('/etc
-000109c0: 2f68 6f73 7473 2729 2061 7320 696e 6669  /hosts') as infi
-000109d0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-000109e0: 636f 6e74 656e 7420 3d20 696e 6669 6c65  content = infile
-000109f0: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
-00010a00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00010a10: 2863 6f6e 7465 6e74 2c20 2731 3237 2e30  (content, '127.0
-00010a20: 2e30 2e31 206c 6f63 616c 686f 7374 2020  .0.1 localhost  
-00010a30: 2320 f09f 9880 5c6e 666f 6f5c 725c 6e62  # ....\nfoo\r\nb
-00010a40: 6172 2729 0a0a 2020 2020 2020 2020 7365  ar')..        se
-00010a50: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00010a60: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00010a70: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-00010a80: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-00010a90: 6669 6c65 7327 2c20 7b27 6163 7469 6f6e  files', {'action
-00010aa0: 273a 2027 7265 6164 272c 2027 7061 7468  ': 'read', 'path
-00010ab0: 273a 2027 2f65 7463 2f68 6f73 7473 277d  ': '/etc/hosts'}
-00010ac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010ad0: 2020 7b27 4163 6365 7074 273a 2027 6d75    {'Accept': 'mu
-00010ae0: 6c74 6970 6172 742f 666f 726d 2d64 6174  ltipart/form-dat
-00010af0: 6127 7d2c 204e 6f6e 6529 2c0a 2020 2020  a'}, None),.    
-00010b00: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
-00010b10: 7465 7374 5f70 756c 6c5f 6269 6e61 7279  test_pull_binary
-00010b20: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00010b30: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
-00010b40: 6f6e 7365 732e 6170 7065 6e64 2828 0a20  onses.append((. 
-00010b50: 2020 2020 2020 2020 2020 207b 2743 6f6e             {'Con
-00010b60: 7465 6e74 2d54 7970 6527 3a20 276d 756c  tent-Type': 'mul
-00010b70: 7469 7061 7274 2f66 6f72 6d2d 6461 7461  tipart/form-data
-00010b80: 3b20 626f 756e 6461 7279 3d30 3132 3334  ; boundary=01234
-00010b90: 3536 3738 3930 3132 3334 3536 3738 3930  5678901234567890
-00010ba0: 3132 3334 3536 3738 3930 3127 7d2c 0a20  12345678901'},. 
-00010bb0: 2020 2020 2020 2020 2020 2062 2222 225c             b"""\
-00010bc0: 0a2d 2d30 3132 3334 3536 3738 3930 3132  .--0123456789012
-00010bd0: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
-00010be0: 3930 315c 720a 436f 6e74 656e 742d 4469  901\r.Content-Di
-00010bf0: 7370 6f73 6974 696f 6e3a 2066 6f72 6d2d  sposition: form-
-00010c00: 6461 7461 3b20 6e61 6d65 3d22 6669 6c65  data; name="file
-00010c10: 7322 3b20 6669 6c65 6e61 6d65 3d22 2f65  s"; filename="/e
-00010c20: 7463 2f68 6f73 7473 225c 720a 5c72 0a31  tc/hosts"\r.\r.1
-00010c30: 3237 2e30 2e30 2e31 206c 6f63 616c 686f  27.0.0.1 localho
-00010c40: 7374 2020 2320 5c78 6630 5c78 3966 5c78  st  # \xf0\x9f\x
-00010c50: 3938 5c78 3830 5c6e 666f 6f5c 725c 6e62  98\x80\nfoo\r\nb
-00010c60: 6172 5c72 0a2d 2d30 3132 3334 3536 3738  ar\r.--012345678
-00010c70: 3930 3132 3334 3536 3738 3930 3132 3334  9012345678901234
-00010c80: 3536 3738 3930 315c 720a 436f 6e74 656e  5678901\r.Conten
-00010c90: 742d 4469 7370 6f73 6974 696f 6e3a 2066  t-Disposition: f
-00010ca0: 6f72 6d2d 6461 7461 3b20 6e61 6d65 3d22  orm-data; name="
-00010cb0: 7265 7370 6f6e 7365 225c 720a 5c72 0a7b  response"\r.\r.{
-00010cc0: 0a20 2020 2022 7265 7375 6c74 223a 205b  .    "result": [
-00010cd0: 7b22 7061 7468 223a 2022 2f65 7463 2f68  {"path": "/etc/h
-00010ce0: 6f73 7473 227d 5d2c 0a20 2020 2022 7374  osts"}],.    "st
-00010cf0: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
-00010d00: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
-00010d10: 3230 302c 0a20 2020 2022 7479 7065 223a  200,.    "type":
-00010d20: 2022 7379 6e63 220a 7d5c 720a 2d2d 3031   "sync".}\r.--01
-00010d30: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-00010d40: 3839 3031 3233 3435 3637 3839 3031 2d2d  89012345678901--
-00010d50: 5c72 0a22 2222 2c0a 2020 2020 2020 2020  \r.""",.        
-00010d60: 2929 0a0a 2020 2020 2020 2020 7769 7468  ))..        with
-00010d70: 2073 656c 662e 636c 6965 6e74 2e70 756c   self.client.pul
-00010d80: 6c28 272f 6574 632f 686f 7374 7327 2c20  l('/etc/hosts', 
-00010d90: 656e 636f 6469 6e67 3d4e 6f6e 6529 2061  encoding=None) a
-00010da0: 7320 696e 6669 6c65 3a0a 2020 2020 2020  s infile:.      
-00010db0: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
-00010dc0: 696e 6669 6c65 2e72 6561 6428 290a 2020  infile.read().  
-00010dd0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010de0: 7445 7175 616c 2863 6f6e 7465 6e74 2c20  tEqual(content, 
-00010df0: 6227 3132 372e 302e 302e 3120 6c6f 6361  b'127.0.0.1 loca
-00010e00: 6c68 6f73 7420 2023 205c 7866 305c 7839  lhost  # \xf0\x9
-00010e10: 665c 7839 385c 7838 305c 6e66 6f6f 5c72  f\x98\x80\nfoo\r
-00010e20: 5c6e 6261 7227 290a 0a20 2020 2020 2020  \nbar')..       
-00010e30: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00010e40: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-00010e50: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-00010e60: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-00010e70: 7631 2f66 696c 6573 272c 207b 2761 6374  v1/files', {'act
-00010e80: 696f 6e27 3a20 2772 6561 6427 2c20 2770  ion': 'read', 'p
-00010e90: 6174 6827 3a20 272f 6574 632f 686f 7374  ath': '/etc/host
-00010ea0: 7327 7d2c 0a20 2020 2020 2020 2020 2020  s'},.           
-00010eb0: 2020 2020 207b 2741 6363 6570 7427 3a20       {'Accept': 
-00010ec0: 276d 756c 7469 7061 7274 2f66 6f72 6d2d  'multipart/form-
-00010ed0: 6461 7461 277d 2c20 4e6f 6e65 292c 0a20  data'}, None),. 
-00010ee0: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-00010ef0: 6566 2074 6573 745f 7075 6c6c 5f70 6174  ef test_pull_pat
-00010f00: 685f 6572 726f 7228 7365 6c66 293a 0a20  h_error(self):. 
-00010f10: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00010f20: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-00010f30: 656e 6428 280a 2020 2020 2020 2020 2020  end((.          
-00010f40: 2020 7b27 436f 6e74 656e 742d 5479 7065    {'Content-Type
-00010f50: 273a 2027 6d75 6c74 6970 6172 742f 666f  ': 'multipart/fo
-00010f60: 726d 2d64 6174 613b 2062 6f75 6e64 6172  rm-data; boundar
-00010f70: 793d 3031 3233 3435 3637 3839 3031 3233  y=01234567890123
-00010f80: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-00010f90: 3031 277d 2c0a 2020 2020 2020 2020 2020  01'},.          
-00010fa0: 2020 6222 2222 5c0a 2d2d 3031 3233 3435    b"""\.--012345
-00010fb0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
-00010fc0: 3233 3435 3637 3839 3031 5c72 0a43 6f6e  2345678901\r.Con
-00010fd0: 7465 6e74 2d44 6973 706f 7369 7469 6f6e  tent-Disposition
-00010fe0: 3a20 666f 726d 2d64 6174 613b 206e 616d  : form-data; nam
-00010ff0: 653d 2272 6573 706f 6e73 6522 5c72 0a5c  e="response"\r.\
-00011000: 720a 7b0a 2020 2020 2272 6573 756c 7422  r.{.    "result"
-00011010: 3a20 5b0a 2020 2020 2020 2020 7b22 7061  : [.        {"pa
-00011020: 7468 223a 2022 2f65 7463 2f68 6f73 7473  th": "/etc/hosts
-00011030: 222c 2022 6572 726f 7222 3a20 7b22 6b69  ", "error": {"ki
-00011040: 6e64 223a 2022 6e6f 742d 666f 756e 6422  nd": "not-found"
-00011050: 2c20 226d 6573 7361 6765 223a 2022 6e6f  , "message": "no
-00011060: 7420 666f 756e 6422 7d7d 0a20 2020 205d  t found"}}.    ]
-00011070: 2c0a 2020 2020 2273 7461 7475 7322 3a20  ,.    "status": 
-00011080: 224f 4b22 2c0a 2020 2020 2273 7461 7475  "OK",.    "statu
-00011090: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
-000110a0: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
-000110b0: 0a7d 5c72 0a2d 2d30 3132 3334 3536 3738  .}\r.--012345678
-000110c0: 3930 3132 3334 3536 3738 3930 3132 3334  9012345678901234
-000110d0: 3536 3738 3930 312d 2d5c 720a 2222 222c  5678901--\r.""",
-000110e0: 0a20 2020 2020 2020 2029 290a 0a20 2020  .        ))..   
-000110f0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00011100: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
-00011110: 6c65 2e50 6174 6845 7272 6f72 2920 6173  le.PathError) as
-00011120: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-00011130: 2073 656c 662e 636c 6965 6e74 2e70 756c   self.client.pul
-00011140: 6c28 272f 6574 632f 686f 7374 7327 290a  l('/etc/hosts').
-00011150: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00011160: 6572 7449 7349 6e73 7461 6e63 6528 636d  ertIsInstance(cm
-00011170: 2e65 7863 6570 7469 6f6e 2c20 7065 6262  .exception, pebb
-00011180: 6c65 2e45 7272 6f72 290a 2020 2020 2020  le.Error).      
-00011190: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000111a0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-000111b0: 6b69 6e64 2c20 276e 6f74 2d66 6f75 6e64  kind, 'not-found
-000111c0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000111d0: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
-000111e0: 7863 6570 7469 6f6e 2e6d 6573 7361 6765  xception.message
-000111f0: 2c20 276e 6f74 2066 6f75 6e64 2729 0a0a  , 'not found')..
-00011200: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00011210: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
-00011220: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
-00011230: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-00011240: 4554 272c 2027 2f76 312f 6669 6c65 7327  ET', '/v1/files'
-00011250: 2c20 7b27 6163 7469 6f6e 273a 2027 7265  , {'action': 're
-00011260: 6164 272c 2027 7061 7468 273a 2027 2f65  ad', 'path': '/e
-00011270: 7463 2f68 6f73 7473 277d 2c0a 2020 2020  tc/hosts'},.    
-00011280: 2020 2020 2020 2020 2020 2020 7b27 4163              {'Ac
-00011290: 6365 7074 273a 2027 6d75 6c74 6970 6172  cept': 'multipar
-000112a0: 742f 666f 726d 2d64 6174 6127 7d2c 204e  t/form-data'}, N
-000112b0: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-000112c0: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
-000112d0: 756c 6c5f 7072 6f74 6f63 6f6c 5f65 7272  ull_protocol_err
-000112e0: 6f72 7328 7365 6c66 293a 0a20 2020 2020  ors(self):.     
-000112f0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
-00011300: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-00011310: 287b 2743 6f6e 7465 6e74 2d54 7970 6527  ({'Content-Type'
-00011320: 3a20 2763 7427 7d2c 2062 2727 2929 0a20  : 'ct'}, b'')). 
-00011330: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00011340: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
-00011350: 6262 6c65 2e50 726f 746f 636f 6c45 7272  bble.ProtocolErr
-00011360: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
-00011370: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00011380: 6e74 2e70 756c 6c28 272f 6574 632f 686f  nt.pull('/etc/ho
-00011390: 7374 7327 290a 2020 2020 2020 2020 7365  sts').        se
-000113a0: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-000113b0: 6e63 6528 636d 2e65 7863 6570 7469 6f6e  nce(cm.exception
-000113c0: 2c20 7065 6262 6c65 2e45 7272 6f72 290a  , pebble.Error).
-000113d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000113e0: 6572 7445 7175 616c 2873 7472 2863 6d2e  ertEqual(str(cm.
-000113f0: 6578 6365 7074 696f 6e29 2c0a 2020 2020  exception),.    
-00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011410: 2020 2020 2022 6578 7065 6374 6564 2043       "expected C
-00011420: 6f6e 7465 6e74 2d54 7970 6520 276d 756c  ontent-Type 'mul
-00011430: 7469 7061 7274 2f66 6f72 6d2d 6461 7461  tipart/form-data
-00011440: 272c 2067 6f74 2027 6374 2722 290a 0a20  ', got 'ct'").. 
-00011450: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00011460: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-00011470: 656e 6428 287b 2743 6f6e 7465 6e74 2d54  end(({'Content-T
-00011480: 7970 6527 3a20 276d 756c 7469 7061 7274  ype': 'multipart
-00011490: 2f66 6f72 6d2d 6461 7461 277d 2c20 6227  /form-data'}, b'
-000114a0: 2729 290a 2020 2020 2020 2020 7769 7468  ')).        with
-000114b0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-000114c0: 6573 2870 6562 626c 652e 5072 6f74 6f63  es(pebble.Protoc
-000114d0: 6f6c 4572 726f 7229 2061 7320 636d 3a0a  olError) as cm:.
-000114e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000114f0: 2e63 6c69 656e 742e 7075 6c6c 2827 2f65  .client.pull('/e
-00011500: 7463 2f68 6f73 7473 2729 0a20 2020 2020  tc/hosts').     
-00011510: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00011520: 7561 6c28 7374 7228 636d 2e65 7863 6570  ual(str(cm.excep
-00011530: 7469 6f6e 292c 2022 696e 7661 6c69 6420  tion), "invalid 
-00011540: 626f 756e 6461 7279 2027 2722 290a 0a20  boundary ''").. 
-00011550: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00011560: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-00011570: 656e 6428 280a 2020 2020 2020 2020 2020  end((.          
-00011580: 2020 7b27 436f 6e74 656e 742d 5479 7065    {'Content-Type
-00011590: 273a 2027 6d75 6c74 6970 6172 742f 666f  ': 'multipart/fo
-000115a0: 726d 2d64 6174 613b 2062 6f75 6e64 6172  rm-data; boundar
-000115b0: 793d 3031 3233 3435 3637 3839 3031 3233  y=01234567890123
-000115c0: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
-000115d0: 3031 277d 2c0a 2020 2020 2020 2020 2020  01'},.          
-000115e0: 2020 6222 2222 5c0a 2d2d 3031 3233 3435    b"""\.--012345
-000115f0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
-00011600: 3233 3435 3637 3839 3031 5c72 0a43 6f6e  2345678901\r.Con
-00011610: 7465 6e74 2d44 6973 706f 7369 7469 6f6e  tent-Disposition
-00011620: 3a20 666f 726d 2d64 6174 613b 206e 616d  : form-data; nam
-00011630: 653d 2266 696c 6573 223b 2066 696c 656e  e="files"; filen
-00011640: 616d 653d 222f 6261 6422 5c72 0a5c 720a  ame="/bad"\r.\r.
-00011650: 6261 6420 7061 7468 5c72 0a2d 2d30 3132  bad path\r.--012
-00011660: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
-00011670: 3930 3132 3334 3536 3738 3930 315c 720a  9012345678901\r.
-00011680: 436f 6e74 656e 742d 4469 7370 6f73 6974  Content-Disposit
-00011690: 696f 6e3a 2066 6f72 6d2d 6461 7461 3b20  ion: form-data; 
-000116a0: 6e61 6d65 3d22 7265 7370 6f6e 7365 225c  name="response"\
-000116b0: 720a 5c72 0a7b 0a20 2020 2022 7265 7375  r.\r.{.    "resu
-000116c0: 6c74 223a 205b 7b22 7061 7468 223a 2022  lt": [{"path": "
-000116d0: 2f65 7463 2f68 6f73 7473 227d 5d2c 0a20  /etc/hosts"}],. 
-000116e0: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
-000116f0: 222c 0a20 2020 2022 7374 6174 7573 2d63  ",.    "status-c
-00011700: 6f64 6522 3a20 3230 302c 0a20 2020 2022  ode": 200,.    "
-00011710: 7479 7065 223a 2022 7379 6e63 220a 7d5c  type": "sync".}\
-00011720: 720a 2d2d 3031 3233 3435 3637 3839 3031  r.--012345678901
-00011730: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-00011740: 3839 3031 2d2d 5c72 0a22 2222 2c0a 2020  8901--\r.""",.  
-00011750: 2020 2020 2020 2929 0a20 2020 2020 2020        )).       
-00011760: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00011770: 7452 6169 7365 7328 7065 6262 6c65 2e50  tRaises(pebble.P
-00011780: 726f 746f 636f 6c45 7272 6f72 2920 6173  rotocolError) as
-00011790: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-000117a0: 2073 656c 662e 636c 6965 6e74 2e70 756c   self.client.pul
-000117b0: 6c28 272f 6574 632f 686f 7374 7327 290a  l('/etc/hosts').
-000117c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000117d0: 6572 7445 7175 616c 2873 7472 2863 6d2e  ertEqual(str(cm.
-000117e0: 6578 6365 7074 696f 6e29 2c20 2270 6174  exception), "pat
-000117f0: 6820 6e6f 7420 6578 7065 6374 6564 3a20  h not expected: 
-00011800: 272f 6261 6427 2229 0a0a 2020 2020 2020  '/bad'")..      
-00011810: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-00011820: 7370 6f6e 7365 732e 6170 7065 6e64 2828  sponses.append((
-00011830: 0a20 2020 2020 2020 2020 2020 207b 2743  .            {'C
-00011840: 6f6e 7465 6e74 2d54 7970 6527 3a20 276d  ontent-Type': 'm
-00011850: 756c 7469 7061 7274 2f66 6f72 6d2d 6461  ultipart/form-da
-00011860: 7461 3b20 626f 756e 6461 7279 3d30 3132  ta; boundary=012
-00011870: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
-00011880: 3930 3132 3334 3536 3738 3930 3127 7d2c  9012345678901'},
-00011890: 0a20 2020 2020 2020 2020 2020 2062 2222  .            b""
-000118a0: 225c 0a2d 2d30 3132 3334 3536 3738 3930  "\.--01234567890
-000118b0: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
-000118c0: 3738 3930 315c 720a 436f 6e74 656e 742d  78901\r.Content-
-000118d0: 4469 7370 6f73 6974 696f 6e3a 2066 6f72  Disposition: for
-000118e0: 6d2d 6461 7461 3b20 6e61 6d65 3d22 6669  m-data; name="fi
-000118f0: 6c65 7322 3b20 6669 6c65 6e61 6d65 3d22  les"; filename="
-00011900: 2f65 7463 2f68 6f73 7473 225c 720a 5c72  /etc/hosts"\r.\r
-00011910: 0a62 6164 2070 6174 685c 720a 2d2d 3031  .bad path\r.--01
-00011920: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
-00011930: 3839 3031 3233 3435 3637 3839 3031 2d2d  89012345678901--
-00011940: 5c72 0a22 2222 2c0a 2020 2020 2020 2020  \r.""",.        
-00011950: 2929 0a20 2020 2020 2020 2077 6974 6820  )).        with 
-00011960: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00011970: 7328 7065 6262 6c65 2e50 726f 746f 636f  s(pebble.Protoco
-00011980: 6c45 7272 6f72 2920 6173 2063 6d3a 0a20  lError) as cm:. 
-00011990: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000119a0: 636c 6965 6e74 2e70 756c 6c28 272f 6574  client.pull('/et
-000119b0: 632f 686f 7374 7327 290a 2020 2020 2020  c/hosts').      
-000119c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000119d0: 616c 2873 7472 2863 6d2e 6578 6365 7074  al(str(cm.except
-000119e0: 696f 6e29 2c20 276e 6f20 2272 6573 706f  ion), 'no "respo
-000119f0: 6e73 6522 2066 6965 6c64 2069 6e20 6d75  nse" field in mu
-00011a00: 6c74 6970 6172 7420 626f 6479 2729 0a0a  ltipart body')..
-00011a10: 2020 2020 6465 6620 7465 7374 5f70 7573      def test_pus
-00011a20: 685f 7374 7228 7365 6c66 293a 0a20 2020  h_str(self):.   
-00011a30: 2020 2020 2073 656c 662e 5f74 6573 745f       self._test_
-00011a40: 7075 7368 5f73 7472 2827 636f 6e74 656e  push_str('conten
-00011a50: 7420 f09f 9880 5c6e 666f 6f5c 725c 6e62  t ....\nfoo\r\nb
-00011a60: 6172 2729 0a0a 2020 2020 6465 6620 7465  ar')..    def te
-00011a70: 7374 5f70 7573 685f 7465 7874 2873 656c  st_push_text(sel
-00011a80: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00011a90: 2e5f 7465 7374 5f70 7573 685f 7374 7228  ._test_push_str(
-00011aa0: 696f 2e53 7472 696e 6749 4f28 2763 6f6e  io.StringIO('con
-00011ab0: 7465 6e74 20f0 9f98 805c 6e66 6f6f 5c72  tent ....\nfoo\r
-00011ac0: 5c6e 6261 7227 2929 0a0a 2020 2020 6465  \nbar'))..    de
-00011ad0: 6620 5f74 6573 745f 7075 7368 5f73 7472  f _test_push_str
-00011ae0: 2873 656c 662c 2073 6f75 7263 6529 3a0a  (self, source):.
-00011af0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-00011b00: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
-00011b10: 7065 6e64 2828 0a20 2020 2020 2020 2020  pend((.         
-00011b20: 2020 207b 2743 6f6e 7465 6e74 2d54 7970     {'Content-Typ
-00011b30: 6527 3a20 2761 7070 6c69 6361 7469 6f6e  e': 'application
-00011b40: 2f6a 736f 6e27 7d2c 0a20 2020 2020 2020  /json'},.       
-00011b50: 2020 2020 2062 2222 220a 7b0a 2020 2020       b""".{.    
-00011b60: 2272 6573 756c 7422 3a20 5b0a 2020 2020  "result": [.    
-00011b70: 2020 2020 7b22 7061 7468 223a 2022 2f66      {"path": "/f
-00011b80: 6f6f 2f62 6172 227d 0a20 2020 205d 2c0a  oo/bar"}.    ],.
-00011b90: 2020 2020 2273 7461 7475 7322 3a20 224f      "status": "O
-00011ba0: 4b22 2c0a 2020 2020 2273 7461 7475 732d  K",.    "status-
-00011bb0: 636f 6465 223a 2032 3030 2c0a 2020 2020  code": 200,.    
-00011bc0: 2274 7970 6522 3a20 2273 796e 6322 0a7d  "type": "sync".}
-00011bd0: 0a22 2222 2c0a 2020 2020 2020 2020 2929  .""",.        ))
-00011be0: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-00011bf0: 6c69 656e 742e 7075 7368 2827 2f66 6f6f  lient.push('/foo
-00011c00: 2f62 6172 272c 2073 6f75 7263 6529 0a0a  /bar', source)..
-00011c10: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00011c20: 6572 7445 7175 616c 286c 656e 2873 656c  ertEqual(len(sel
-00011c30: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-00011c40: 7329 2c20 3129 0a20 2020 2020 2020 2072  s), 1).        r
-00011c50: 6571 7565 7374 203d 2073 656c 662e 636c  equest = self.cl
-00011c60: 6965 6e74 2e72 6571 7565 7374 735b 305d  ient.requests[0]
-00011c70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00011c80: 7365 7274 4571 7561 6c28 7265 7175 6573  sertEqual(reques
-00011c90: 745b 3a33 5d2c 2028 2750 4f53 5427 2c20  t[:3], ('POST', 
-00011ca0: 272f 7631 2f66 696c 6573 272c 204e 6f6e  '/v1/files', Non
-00011cb0: 6529 290a 0a20 2020 2020 2020 2068 6561  e))..        hea
-00011cc0: 6465 7273 2c20 626f 6479 203d 2072 6571  ders, body = req
-00011cd0: 7565 7374 5b33 3a5d 0a0a 2020 2020 2020  uest[3:]..      
-00011ce0: 2020 636f 6e74 656e 745f 7479 7065 203d    content_type =
-00011cf0: 2068 6561 6465 7273 5b27 436f 6e74 656e   headers['Conten
-00011d00: 742d 5479 7065 275d 0a20 2020 2020 2020  t-Type'].       
-00011d10: 2072 6571 2c20 6669 6c65 6e61 6d65 2c20   req, filename, 
-00011d20: 636f 6e74 656e 7420 3d20 7365 6c66 2e5f  content = self._
-00011d30: 7061 7273 655f 7772 6974 655f 6d75 6c74  parse_write_mult
-00011d40: 6970 6172 7428 636f 6e74 656e 745f 7479  ipart(content_ty
-00011d50: 7065 2c20 626f 6479 290a 2020 2020 2020  pe, body).      
-00011d60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00011d70: 616c 2866 696c 656e 616d 652c 2027 2f66  al(filename, '/f
-00011d80: 6f6f 2f62 6172 2729 0a20 2020 2020 2020  oo/bar').       
-00011d90: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00011da0: 6c28 636f 6e74 656e 742c 2062 2763 6f6e  l(content, b'con
-00011db0: 7465 6e74 205c 7866 305c 7839 665c 7839  tent \xf0\x9f\x9
-00011dc0: 385c 7838 305c 6e66 6f6f 5c72 5c6e 6261  8\x80\nfoo\r\nba
-00011dd0: 7227 290a 2020 2020 2020 2020 7365 6c66  r').        self
-00011de0: 2e61 7373 6572 7445 7175 616c 2872 6571  .assertEqual(req
-00011df0: 2c20 7b0a 2020 2020 2020 2020 2020 2020  , {.            
-00011e00: 2761 6374 696f 6e27 3a20 2777 7269 7465  'action': 'write
-00011e10: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00011e20: 6669 6c65 7327 3a20 5b7b 2770 6174 6827  files': [{'path'
-00011e30: 3a20 272f 666f 6f2f 6261 7227 7d5d 2c0a  : '/foo/bar'}],.
-00011e40: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
-00011e50: 6465 6620 7465 7374 5f70 7573 685f 6279  def test_push_by
-00011e60: 7465 7328 7365 6c66 293a 0a20 2020 2020  tes(self):.     
-00011e70: 2020 2073 656c 662e 5f74 6573 745f 7075     self._test_pu
-00011e80: 7368 5f62 7974 6573 2862 2763 6f6e 7465  sh_bytes(b'conte
-00011e90: 6e74 205c 7866 305c 7839 665c 7839 385c  nt \xf0\x9f\x98\
-00011ea0: 7838 305c 6e66 6f6f 5c72 5c6e 6261 7227  x80\nfoo\r\nbar'
-00011eb0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00011ec0: 7075 7368 5f62 696e 6172 7928 7365 6c66  push_binary(self
-00011ed0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00011ee0: 5f74 6573 745f 7075 7368 5f62 7974 6573  _test_push_bytes
-00011ef0: 2869 6f2e 4279 7465 7349 4f28 6227 636f  (io.BytesIO(b'co
-00011f00: 6e74 656e 7420 5c78 6630 5c78 3966 5c78  ntent \xf0\x9f\x
-00011f10: 3938 5c78 3830 5c6e 666f 6f5c 725c 6e62  98\x80\nfoo\r\nb
-00011f20: 6172 2729 290a 0a20 2020 2064 6566 205f  ar'))..    def _
-00011f30: 7465 7374 5f70 7573 685f 6279 7465 7328  test_push_bytes(
-00011f40: 7365 6c66 2c20 736f 7572 6365 293a 0a20  self, source):. 
-00011f50: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00011f60: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-00011f70: 656e 6428 280a 2020 2020 2020 2020 2020  end((.          
-00011f80: 2020 7b27 436f 6e74 656e 742d 5479 7065    {'Content-Type
-00011f90: 273a 2027 6170 706c 6963 6174 696f 6e2f  ': 'application/
-00011fa0: 6a73 6f6e 277d 2c0a 2020 2020 2020 2020  json'},.        
-00011fb0: 2020 2020 6222 2222 0a7b 0a20 2020 2022      b""".{.    "
-00011fc0: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
-00011fd0: 2020 207b 2270 6174 6822 3a20 222f 666f     {"path": "/fo
-00011fe0: 6f2f 6261 7222 7d0a 2020 2020 5d2c 0a20  o/bar"}.    ],. 
-00011ff0: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
-00012000: 222c 0a20 2020 2022 7374 6174 7573 2d63  ",.    "status-c
-00012010: 6f64 6522 3a20 3230 302c 0a20 2020 2022  ode": 200,.    "
-00012020: 7479 7065 223a 2022 7379 6e63 220a 7d0a  type": "sync".}.
-00012030: 2222 222c 0a20 2020 2020 2020 2029 290a  """,.        )).
-00012040: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00012050: 6965 6e74 2e70 7573 6828 272f 666f 6f2f  ient.push('/foo/
-00012060: 6261 7227 2c20 736f 7572 6365 290a 0a20  bar', source).. 
-00012070: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00012080: 7274 4571 7561 6c28 6c65 6e28 7365 6c66  rtEqual(len(self
-00012090: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-000120a0: 292c 2031 290a 2020 2020 2020 2020 7265  ), 1).        re
-000120b0: 7175 6573 7420 3d20 7365 6c66 2e63 6c69  quest = self.cli
-000120c0: 656e 742e 7265 7175 6573 7473 5b30 5d0a  ent.requests[0].
-000120d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000120e0: 6572 7445 7175 616c 2872 6571 7565 7374  ertEqual(request
-000120f0: 5b3a 335d 2c20 2827 504f 5354 272c 2027  [:3], ('POST', '
-00012100: 2f76 312f 6669 6c65 7327 2c20 4e6f 6e65  /v1/files', None
-00012110: 2929 0a0a 2020 2020 2020 2020 6865 6164  ))..        head
-00012120: 6572 732c 2062 6f64 7920 3d20 7265 7175  ers, body = requ
-00012130: 6573 745b 333a 5d0a 2020 2020 2020 2020  est[3:].        
-00012140: 636f 6e74 656e 745f 7479 7065 203d 2068  content_type = h
-00012150: 6561 6465 7273 5b27 436f 6e74 656e 742d  eaders['Content-
-00012160: 5479 7065 275d 0a20 2020 2020 2020 2072  Type'].        r
-00012170: 6571 2c20 6669 6c65 6e61 6d65 2c20 636f  eq, filename, co
-00012180: 6e74 656e 7420 3d20 7365 6c66 2e5f 7061  ntent = self._pa
-00012190: 7273 655f 7772 6974 655f 6d75 6c74 6970  rse_write_multip
-000121a0: 6172 7428 636f 6e74 656e 745f 7479 7065  art(content_type
-000121b0: 2c20 626f 6479 290a 2020 2020 2020 2020  , body).        
-000121c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000121d0: 2866 696c 656e 616d 652c 2027 2f66 6f6f  (filename, '/foo
-000121e0: 2f62 6172 2729 0a20 2020 2020 2020 2073  /bar').        s
-000121f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012200: 636f 6e74 656e 742c 2062 2763 6f6e 7465  content, b'conte
-00012210: 6e74 205c 7866 305c 7839 665c 7839 385c  nt \xf0\x9f\x98\
-00012220: 7838 305c 6e66 6f6f 5c72 5c6e 6261 7227  x80\nfoo\r\nbar'
-00012230: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00012240: 7373 6572 7445 7175 616c 2872 6571 2c20  ssertEqual(req, 
-00012250: 7b0a 2020 2020 2020 2020 2020 2020 2761  {.            'a
-00012260: 6374 696f 6e27 3a20 2777 7269 7465 272c  ction': 'write',
-00012270: 0a20 2020 2020 2020 2020 2020 2027 6669  .            'fi
-00012280: 6c65 7327 3a20 5b7b 2770 6174 6827 3a20  les': [{'path': 
-00012290: 272f 666f 6f2f 6261 7227 7d5d 2c0a 2020  '/foo/bar'}],.  
-000122a0: 2020 2020 2020 7d29 0a0a 2020 2020 6465        })..    de
-000122b0: 6620 7465 7374 5f70 7573 685f 616c 6c5f  f test_push_all_
-000122c0: 6f70 7469 6f6e 7328 7365 6c66 293a 0a20  options(self):. 
-000122d0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-000122e0: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-000122f0: 656e 6428 280a 2020 2020 2020 2020 2020  end((.          
-00012300: 2020 7b27 436f 6e74 656e 742d 5479 7065    {'Content-Type
-00012310: 273a 2027 6170 706c 6963 6174 696f 6e2f  ': 'application/
-00012320: 6a73 6f6e 277d 2c0a 2020 2020 2020 2020  json'},.        
-00012330: 2020 2020 6222 2222 0a7b 0a20 2020 2022      b""".{.    "
-00012340: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
-00012350: 2020 207b 2270 6174 6822 3a20 222f 666f     {"path": "/fo
-00012360: 6f2f 6261 7222 7d0a 2020 2020 5d2c 0a20  o/bar"}.    ],. 
-00012370: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
-00012380: 222c 0a20 2020 2022 7374 6174 7573 2d63  ",.    "status-c
-00012390: 6f64 6522 3a20 3230 302c 0a20 2020 2022  ode": 200,.    "
-000123a0: 7479 7065 223a 2022 7379 6e63 220a 7d0a  type": "sync".}.
-000123b0: 2222 222c 0a20 2020 2020 2020 2029 290a  """,.        )).
-000123c0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-000123d0: 6965 6e74 2e70 7573 6828 272f 666f 6f2f  ient.push('/foo/
-000123e0: 6261 7227 2c20 2763 6f6e 7465 6e74 272c  bar', 'content',
-000123f0: 206d 616b 655f 6469 7273 3d54 7275 652c   make_dirs=True,
-00012400: 2070 6572 6d69 7373 696f 6e73 3d30 6f36   permissions=0o6
-00012410: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00012420: 2020 2020 2020 2020 2020 2020 2075 7365               use
-00012430: 725f 6964 3d31 322c 2075 7365 723d 2762  r_id=12, user='b
-00012440: 6f62 272c 2067 726f 7570 5f69 643d 3334  ob', group_id=34
-00012450: 2c20 6772 6f75 703d 2773 7461 6666 2729  , group='staff')
-00012460: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00012470: 7373 6572 7445 7175 616c 286c 656e 2873  ssertEqual(len(s
-00012480: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00012490: 7374 7329 2c20 3129 0a20 2020 2020 2020  sts), 1).       
-000124a0: 2072 6571 7565 7374 203d 2073 656c 662e   request = self.
-000124b0: 636c 6965 6e74 2e72 6571 7565 7374 735b  client.requests[
-000124c0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-000124d0: 6173 7365 7274 4571 7561 6c28 7265 7175  assertEqual(requ
-000124e0: 6573 745b 3a33 5d2c 2028 2750 4f53 5427  est[:3], ('POST'
-000124f0: 2c20 272f 7631 2f66 696c 6573 272c 204e  , '/v1/files', N
-00012500: 6f6e 6529 290a 0a20 2020 2020 2020 2068  one))..        h
-00012510: 6561 6465 7273 2c20 626f 6479 203d 2072  eaders, body = r
-00012520: 6571 7565 7374 5b33 3a5d 0a20 2020 2020  equest[3:].     
-00012530: 2020 2063 6f6e 7465 6e74 5f74 7970 6520     content_type 
-00012540: 3d20 6865 6164 6572 735b 2743 6f6e 7465  = headers['Conte
-00012550: 6e74 2d54 7970 6527 5d0a 2020 2020 2020  nt-Type'].      
-00012560: 2020 7265 712c 2066 696c 656e 616d 652c    req, filename,
-00012570: 2063 6f6e 7465 6e74 203d 2073 656c 662e   content = self.
-00012580: 5f70 6172 7365 5f77 7269 7465 5f6d 756c  _parse_write_mul
-00012590: 7469 7061 7274 2863 6f6e 7465 6e74 5f74  tipart(content_t
-000125a0: 7970 652c 2062 6f64 7929 0a20 2020 2020  ype, body).     
-000125b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000125c0: 7561 6c28 6669 6c65 6e61 6d65 2c20 272f  ual(filename, '/
-000125d0: 666f 6f2f 6261 7227 290a 2020 2020 2020  foo/bar').      
-000125e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000125f0: 616c 2863 6f6e 7465 6e74 2c20 6227 636f  al(content, b'co
-00012600: 6e74 656e 7427 290a 2020 2020 2020 2020  ntent').        
-00012610: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00012620: 2872 6571 2c20 7b0a 2020 2020 2020 2020  (req, {.        
-00012630: 2020 2020 2761 6374 696f 6e27 3a20 2777      'action': 'w
-00012640: 7269 7465 272c 0a20 2020 2020 2020 2020  rite',.         
-00012650: 2020 2027 6669 6c65 7327 3a20 5b7b 0a20     'files': [{. 
-00012660: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00012670: 7061 7468 273a 2027 2f66 6f6f 2f62 6172  path': '/foo/bar
-00012680: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00012690: 2020 2027 6d61 6b65 2d64 6972 7327 3a20     'make-dirs': 
-000126a0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-000126b0: 2020 2020 2020 2770 6572 6d69 7373 696f        'permissio
-000126c0: 6e73 273a 2027 3630 3027 2c0a 2020 2020  ns': '600',.    
-000126d0: 2020 2020 2020 2020 2020 2020 2775 7365              'use
-000126e0: 722d 6964 273a 2031 322c 0a20 2020 2020  r-id': 12,.     
-000126f0: 2020 2020 2020 2020 2020 2027 7573 6572             'user
-00012700: 273a 2027 626f 6227 2c0a 2020 2020 2020  ': 'bob',.      
-00012710: 2020 2020 2020 2020 2020 2767 726f 7570            'group
-00012720: 2d69 6427 3a20 3334 2c0a 2020 2020 2020  -id': 34,.      
-00012730: 2020 2020 2020 2020 2020 2767 726f 7570            'group
-00012740: 273a 2027 7374 6166 6627 2c0a 2020 2020  ': 'staff',.    
-00012750: 2020 2020 2020 2020 7d5d 2c0a 2020 2020          }],.    
-00012760: 2020 2020 7d29 0a0a 2020 2020 6465 6620      })..    def 
-00012770: 7465 7374 5f70 7573 685f 7569 645f 6769  test_push_uid_gi
-00012780: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00012790: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
-000127a0: 706f 6e73 6573 2e61 7070 656e 6428 280a  ponses.append((.
-000127b0: 2020 2020 2020 2020 2020 2020 7b27 436f              {'Co
-000127c0: 6e74 656e 742d 5479 7065 273a 2027 6170  ntent-Type': 'ap
-000127d0: 706c 6963 6174 696f 6e2f 6a73 6f6e 277d  plication/json'}
-000127e0: 2c0a 2020 2020 2020 2020 2020 2020 6222  ,.            b"
-000127f0: 2222 0a7b 0a20 2020 2022 7265 7375 6c74  "".{.    "result
-00012800: 223a 205b 0a20 2020 2020 2020 207b 2270  ": [.        {"p
-00012810: 6174 6822 3a20 222f 666f 6f2f 6261 7222  ath": "/foo/bar"
-00012820: 7d0a 2020 2020 5d2c 0a20 2020 2022 7374  }.    ],.    "st
-00012830: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
-00012840: 2022 7374 6174 7573 2d63 6f64 6522 3a20   "status-code": 
-00012850: 3230 302c 0a20 2020 2022 7479 7065 223a  200,.    "type":
-00012860: 2022 7379 6e63 220a 7d0a 2222 222c 0a20   "sync".}.""",. 
-00012870: 2020 2020 2020 2029 290a 0a20 2020 2020         ))..     
-00012880: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
-00012890: 7573 6828 272f 666f 6f2f 6261 7227 2c20  ush('/foo/bar', 
-000128a0: 2763 6f6e 7465 6e74 272c 2075 7365 725f  'content', user_
-000128b0: 6964 3d31 322c 2067 726f 7570 5f69 643d  id=12, group_id=
-000128c0: 3334 290a 0a20 2020 2020 2020 2073 656c  34)..        sel
-000128d0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-000128e0: 6e28 7365 6c66 2e63 6c69 656e 742e 7265  n(self.client.re
-000128f0: 7175 6573 7473 292c 2031 290a 2020 2020  quests), 1).    
-00012900: 2020 2020 7265 7175 6573 7420 3d20 7365      request = se
-00012910: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
-00012920: 7473 5b30 5d0a 2020 2020 2020 2020 7365  ts[0].        se
-00012930: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
-00012940: 6571 7565 7374 5b3a 335d 2c20 2827 504f  equest[:3], ('PO
-00012950: 5354 272c 2027 2f76 312f 6669 6c65 7327  ST', '/v1/files'
-00012960: 2c20 4e6f 6e65 2929 0a0a 2020 2020 2020  , None))..      
-00012970: 2020 6865 6164 6572 732c 2062 6f64 7920    headers, body 
-00012980: 3d20 7265 7175 6573 745b 333a 5d0a 2020  = request[3:].  
-00012990: 2020 2020 2020 636f 6e74 656e 745f 7479        content_ty
-000129a0: 7065 203d 2068 6561 6465 7273 5b27 436f  pe = headers['Co
-000129b0: 6e74 656e 742d 5479 7065 275d 0a20 2020  ntent-Type'].   
-000129c0: 2020 2020 2072 6571 2c20 6669 6c65 6e61       req, filena
-000129d0: 6d65 2c20 636f 6e74 656e 7420 3d20 7365  me, content = se
-000129e0: 6c66 2e5f 7061 7273 655f 7772 6974 655f  lf._parse_write_
-000129f0: 6d75 6c74 6970 6172 7428 636f 6e74 656e  multipart(conten
-00012a00: 745f 7479 7065 2c20 626f 6479 290a 2020  t_type, body).  
-00012a10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012a20: 7445 7175 616c 2866 696c 656e 616d 652c  tEqual(filename,
-00012a30: 2027 2f66 6f6f 2f62 6172 2729 0a20 2020   '/foo/bar').   
-00012a40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00012a50: 4571 7561 6c28 636f 6e74 656e 742c 2062  Equal(content, b
-00012a60: 2763 6f6e 7465 6e74 2729 0a20 2020 2020  'content').     
-00012a70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00012a80: 7561 6c28 7265 712c 207b 0a20 2020 2020  ual(req, {.     
-00012a90: 2020 2020 2020 2027 6163 7469 6f6e 273a         'action':
-00012aa0: 2027 7772 6974 6527 2c0a 2020 2020 2020   'write',.      
-00012ab0: 2020 2020 2020 2766 696c 6573 273a 205b        'files': [
-00012ac0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00012ad0: 2020 2770 6174 6827 3a20 272f 666f 6f2f    'path': '/foo/
-00012ae0: 6261 7227 2c0a 2020 2020 2020 2020 2020  bar',.          
-00012af0: 2020 2020 2020 2775 7365 722d 6964 273a        'user-id':
-00012b00: 2031 322c 0a20 2020 2020 2020 2020 2020   12,.           
-00012b10: 2020 2020 2027 6772 6f75 702d 6964 273a       'group-id':
-00012b20: 2033 342c 0a20 2020 2020 2020 2020 2020   34,.           
-00012b30: 207d 5d2c 0a20 2020 2020 2020 207d 290a   }],.        }).
-00012b40: 0a20 2020 2064 6566 2074 6573 745f 7075  .    def test_pu
-00012b50: 7368 5f70 6174 685f 6572 726f 7228 7365  sh_path_error(se
-00012b60: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00012b70: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-00012b80: 6573 2e61 7070 656e 6428 280a 2020 2020  es.append((.    
-00012b90: 2020 2020 2020 2020 7b27 436f 6e74 656e          {'Conten
-00012ba0: 742d 5479 7065 273a 2027 6170 706c 6963  t-Type': 'applic
-00012bb0: 6174 696f 6e2f 6a73 6f6e 277d 2c0a 2020  ation/json'},.  
-00012bc0: 2020 2020 2020 2020 2020 6222 2222 0a7b            b""".{
-00012bd0: 0a20 2020 2022 7265 7375 6c74 223a 205b  .    "result": [
-00012be0: 0a20 2020 2020 2020 207b 2270 6174 6822  .        {"path"
-00012bf0: 3a20 222f 666f 6f2f 6261 7222 2c20 2265  : "/foo/bar", "e
-00012c00: 7272 6f72 223a 207b 226b 696e 6422 3a20  rror": {"kind": 
-00012c10: 226e 6f74 2d66 6f75 6e64 222c 2022 6d65  "not-found", "me
-00012c20: 7373 6167 6522 3a20 226e 6f74 2066 6f75  ssage": "not fou
-00012c30: 6e64 227d 7d0a 2020 2020 5d2c 0a20 2020  nd"}}.    ],.   
-00012c40: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
-00012c50: 0a20 2020 2022 7374 6174 7573 2d63 6f64  .    "status-cod
-00012c60: 6522 3a20 3230 302c 0a20 2020 2022 7479  e": 200,.    "ty
-00012c70: 7065 223a 2022 7379 6e63 220a 7d0a 2222  pe": "sync".}.""
-00012c80: 222c 0a20 2020 2020 2020 2029 290a 0a20  ",.        )).. 
-00012c90: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00012ca0: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
-00012cb0: 6262 6c65 2e50 6174 6845 7272 6f72 2920  bble.PathError) 
-00012cc0: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00012cd0: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
-00012ce0: 7573 6828 272f 666f 6f2f 6261 7227 2c20  ush('/foo/bar', 
-00012cf0: 2763 6f6e 7465 6e74 2729 0a20 2020 2020  'content').     
-00012d00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00012d10: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
-00012d20: 2e6b 696e 642c 2027 6e6f 742d 666f 756e  .kind, 'not-foun
-00012d30: 6427 290a 2020 2020 2020 2020 7365 6c66  d').        self
-00012d40: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
-00012d50: 6578 6365 7074 696f 6e2e 6d65 7373 6167  exception.messag
-00012d60: 652c 2027 6e6f 7420 666f 756e 6427 290a  e, 'not found').
-00012d70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00012d80: 7365 7274 4571 7561 6c28 6c65 6e28 7365  sertEqual(len(se
-00012d90: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
-00012da0: 7473 292c 2031 290a 2020 2020 2020 2020  ts), 1).        
-00012db0: 7265 7175 6573 7420 3d20 7365 6c66 2e63  request = self.c
-00012dc0: 6c69 656e 742e 7265 7175 6573 7473 5b30  lient.requests[0
-00012dd0: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-00012de0: 7373 6572 7445 7175 616c 2872 6571 7565  ssertEqual(reque
-00012df0: 7374 5b3a 335d 2c20 2827 504f 5354 272c  st[:3], ('POST',
-00012e00: 2027 2f76 312f 6669 6c65 7327 2c20 4e6f   '/v1/files', No
-00012e10: 6e65 2929 0a0a 2020 2020 2020 2020 6865  ne))..        he
-00012e20: 6164 6572 732c 2062 6f64 7920 3d20 7265  aders, body = re
-00012e30: 7175 6573 745b 333a 5d0a 2020 2020 2020  quest[3:].      
-00012e40: 2020 636f 6e74 656e 745f 7479 7065 203d    content_type =
-00012e50: 2068 6561 6465 7273 5b27 436f 6e74 656e   headers['Conten
-00012e60: 742d 5479 7065 275d 0a20 2020 2020 2020  t-Type'].       
-00012e70: 2072 6571 2c20 6669 6c65 6e61 6d65 2c20   req, filename, 
-00012e80: 636f 6e74 656e 7420 3d20 7365 6c66 2e5f  content = self._
-00012e90: 7061 7273 655f 7772 6974 655f 6d75 6c74  parse_write_mult
-00012ea0: 6970 6172 7428 636f 6e74 656e 745f 7479  ipart(content_ty
-00012eb0: 7065 2c20 626f 6479 290a 2020 2020 2020  pe, body).      
-00012ec0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00012ed0: 616c 2866 696c 656e 616d 652c 2027 2f66  al(filename, '/f
-00012ee0: 6f6f 2f62 6172 2729 0a20 2020 2020 2020  oo/bar').       
-00012ef0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00012f00: 6c28 636f 6e74 656e 742c 2062 2763 6f6e  l(content, b'con
-00012f10: 7465 6e74 2729 0a20 2020 2020 2020 2073  tent').        s
-00012f20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012f30: 7265 712c 207b 0a20 2020 2020 2020 2020  req, {.         
-00012f40: 2020 2027 6163 7469 6f6e 273a 2027 7772     'action': 'wr
-00012f50: 6974 6527 2c0a 2020 2020 2020 2020 2020  ite',.          
-00012f60: 2020 2766 696c 6573 273a 205b 7b27 7061    'files': [{'pa
-00012f70: 7468 273a 2027 2f66 6f6f 2f62 6172 277d  th': '/foo/bar'}
-00012f80: 5d2c 0a20 2020 2020 2020 207d 290a 0a20  ],.        }).. 
-00012f90: 2020 2064 6566 205f 7061 7273 655f 7772     def _parse_wr
-00012fa0: 6974 655f 6d75 6c74 6970 6172 7428 7365  ite_multipart(se
-00012fb0: 6c66 2c20 636f 6e74 656e 745f 7479 7065  lf, content_type
-00012fc0: 2c20 626f 6479 293a 0a20 2020 2020 2020  , body):.       
-00012fd0: 2063 7479 7065 2c20 6f70 7469 6f6e 7320   ctype, options 
-00012fe0: 3d20 6367 692e 7061 7273 655f 6865 6164  = cgi.parse_head
-00012ff0: 6572 2863 6f6e 7465 6e74 5f74 7970 6529  er(content_type)
-00013000: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00013010: 7365 7274 4571 7561 6c28 6374 7970 652c  sertEqual(ctype,
-00013020: 2027 6d75 6c74 6970 6172 742f 666f 726d   'multipart/form
-00013030: 2d64 6174 6127 290a 2020 2020 2020 2020  -data').        
-00013040: 626f 756e 6461 7279 203d 206f 7074 696f  boundary = optio
-00013050: 6e73 5b27 626f 756e 6461 7279 275d 0a0a  ns['boundary']..
-00013060: 2020 2020 2020 2020 2320 5765 2068 6176          # We hav
-00013070: 6520 746f 206d 616e 7561 6c6c 7920 7772  e to manually wr
-00013080: 6974 6520 7468 6520 436f 6e74 656e 742d  ite the Content-
-00013090: 5479 7065 2077 6974 6820 626f 756e 6461  Type with bounda
-000130a0: 7279 2c20 6265 6361 7573 650a 2020 2020  ry, because.    
-000130b0: 2020 2020 2320 656d 6169 6c2e 7061 7273      # email.pars
-000130c0: 6572 2065 7870 6563 7473 2074 6865 2065  er expects the e
-000130d0: 6e74 6972 6520 6d75 6c74 6970 6172 7420  ntire multipart 
-000130e0: 6d65 7373 6167 6520 7769 7468 2068 6561  message with hea
-000130f0: 6465 7273 2e0a 2020 2020 2020 2020 7061  ders..        pa
-00013100: 7273 6572 203d 2065 6d61 696c 2e70 6172  rser = email.par
-00013110: 7365 722e 4279 7465 7346 6565 6450 6172  ser.BytesFeedPar
-00013120: 7365 7228 290a 2020 2020 2020 2020 7061  ser().        pa
-00013130: 7273 6572 2e66 6565 6428 6227 436f 6e74  rser.feed(b'Cont
-00013140: 656e 742d 5479 7065 3a20 6d75 6c74 6970  ent-Type: multip
-00013150: 6172 742f 666f 726d 2d64 6174 613b 2062  art/form-data; b
-00013160: 6f75 6e64 6172 793d 270a 2020 2020 2020  oundary='.      
-00013170: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-00013180: 626f 756e 6461 7279 2e65 6e63 6f64 6528  boundary.encode(
-00013190: 2775 7466 2d38 2729 202b 2062 275c 725c  'utf-8') + b'\r\
-000131a0: 6e5c 725c 6e27 290a 2020 2020 2020 2020  n\r\n').        
-000131b0: 666f 7220 6220 696e 2062 6f64 793a 0a20  for b in body:. 
-000131c0: 2020 2020 2020 2020 2020 2023 2057 6974             # Wit
-000131d0: 6820 7468 6520 226d 656d 6f72 7920 6566  h the "memory ef
-000131e0: 6669 6369 656e 7420 7075 7368 2220 6368  ficient push" ch
-000131f0: 616e 6765 732c 2062 6f64 7920 6973 2061  anges, body is a
-00013200: 6e20 6974 6572 6162 6c65 2e0a 2020 2020  n iterable..    
-00013210: 2020 2020 2020 2020 7061 7273 6572 2e66          parser.f
-00013220: 6565 6428 6229 0a20 2020 2020 2020 206d  eed(b).        m
-00013230: 6573 7361 6765 203d 2070 6172 7365 722e  essage = parser.
-00013240: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
-00013250: 2072 6571 203d 204e 6f6e 650a 2020 2020   req = None.    
-00013260: 2020 2020 6669 6c65 6e61 6d65 203d 204e      filename = N
-00013270: 6f6e 650a 2020 2020 2020 2020 636f 6e74  one.        cont
-00013280: 656e 7420 3d20 4e6f 6e65 0a20 2020 2020  ent = None.     
-00013290: 2020 2066 6f72 2070 6172 7420 696e 206d     for part in m
-000132a0: 6573 7361 6765 2e77 616c 6b28 293a 0a20  essage.walk():. 
-000132b0: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-000132c0: 3d20 7061 7274 2e67 6574 5f70 6172 616d  = part.get_param
-000132d0: 2827 6e61 6d65 272c 2068 6561 6465 723d  ('name', header=
-000132e0: 2743 6f6e 7465 6e74 2d44 6973 706f 7369  'Content-Disposi
-000132f0: 7469 6f6e 2729 0a20 2020 2020 2020 2020  tion').         
-00013300: 2020 2069 6620 6e61 6d65 203d 3d20 2772     if name == 'r
-00013310: 6571 7565 7374 273a 0a20 2020 2020 2020  equest':.       
-00013320: 2020 2020 2020 2020 2072 6571 203d 206a           req = j
-00013330: 736f 6e2e 6c6f 6164 7328 7061 7274 2e67  son.loads(part.g
-00013340: 6574 5f70 6179 6c6f 6164 2829 290a 2020  et_payload()).  
-00013350: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
-00013360: 616d 6520 3d3d 2027 6669 6c65 7327 3a0a  ame == 'files':.
-00013370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013380: 2320 6465 636f 6465 3d54 7275 652c 2069  # decode=True, i
-00013390: 726f 6e69 6361 6c6c 792c 2061 766f 6964  ronically, avoid
-000133a0: 7320 6465 636f 6469 6e67 2062 7974 6573  s decoding bytes
-000133b0: 2074 6f20 7374 720a 2020 2020 2020 2020   to str.        
-000133c0: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
-000133d0: 3d20 7061 7274 2e67 6574 5f70 6179 6c6f  = part.get_paylo
-000133e0: 6164 2864 6563 6f64 653d 5472 7565 290a  ad(decode=True).
-000133f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013400: 6669 6c65 6e61 6d65 203d 2070 6172 742e  filename = part.
-00013410: 6765 745f 6669 6c65 6e61 6d65 2829 0a20  get_filename(). 
-00013420: 2020 2020 2020 2072 6574 7572 6e20 2872         return (r
-00013430: 6571 2c20 6669 6c65 6e61 6d65 2c20 636f  eq, filename, co
-00013440: 6e74 656e 7429 0a0a 2020 2020 6465 6620  ntent)..    def 
-00013450: 7465 7374 5f6c 6973 745f 6669 6c65 735f  test_list_files_
-00013460: 7061 7468 2873 656c 6629 3a0a 2020 2020  path(self):.    
-00013470: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00013480: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-00013490: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-000134a0: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
-000134b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000134c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134d0: 2027 7061 7468 273a 2027 2f65 7463 2f68   'path': '/etc/h
-000134e0: 6f73 7473 272c 0a20 2020 2020 2020 2020  osts',.         
-000134f0: 2020 2020 2020 2020 2020 2027 6e61 6d65             'name
-00013500: 273a 2027 686f 7374 7327 2c0a 2020 2020  ': 'hosts',.    
-00013510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013520: 2774 7970 6527 3a20 2766 696c 6527 2c0a  'type': 'file',.
-00013530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013540: 2020 2020 2773 697a 6527 3a20 3132 332c      'size': 123,
-00013550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013560: 2020 2020 2027 7065 726d 6973 7369 6f6e       'permission
-00013570: 7327 3a20 2736 3434 272c 0a20 2020 2020  s': '644',.     
-00013580: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00013590: 6c61 7374 2d6d 6f64 6966 6965 6427 3a20  last-modified': 
-000135a0: 2732 3032 312d 3031 2d32 3854 3134 3a33  '2021-01-28T14:3
-000135b0: 373a 3034 2e32 3931 3531 3737 3638 2b31  7:04.291517768+1
-000135c0: 333a 3030 272c 0a20 2020 2020 2020 2020  3:00',.         
-000135d0: 2020 2020 2020 2020 2020 2027 7573 6572             'user
-000135e0: 2d69 6427 3a20 3132 2c0a 2020 2020 2020  -id': 12,.      
-000135f0: 2020 2020 2020 2020 2020 2020 2020 2775                'u
-00013600: 7365 7227 3a20 2762 6f62 272c 0a20 2020  ser': 'bob',.   
-00013610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013620: 2027 6772 6f75 702d 6964 273a 2033 342c   'group-id': 34,
-00013630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013640: 2020 2020 2027 6772 6f75 7027 3a20 2773       'group': 's
-00013650: 7461 6666 272c 0a20 2020 2020 2020 2020  taff',.         
-00013660: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00013670: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00013680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013690: 2770 6174 6827 3a20 272f 6574 632f 6e67  'path': '/etc/ng
-000136a0: 696e 7827 2c0a 2020 2020 2020 2020 2020  inx',.          
-000136b0: 2020 2020 2020 2020 2020 276e 616d 6527            'name'
-000136c0: 3a20 276e 6769 6e78 272c 0a20 2020 2020  : 'nginx',.     
-000136d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000136e0: 7479 7065 273a 2027 6469 7265 6374 6f72  type': 'director
-000136f0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-00013700: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
-00013710: 696f 6e73 273a 2027 3735 3527 2c0a 2020  ions': '755',.  
-00013720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013730: 2020 276c 6173 742d 6d6f 6469 6669 6564    'last-modified
-00013740: 273a 2027 3230 3230 2d30 312d 3031 5430  ': '2020-01-01T0
-00013750: 313a 3031 3a30 312e 3030 3030 3030 2b31  1:01:01.000000+1
-00013760: 333a 3030 272c 0a20 2020 2020 2020 2020  3:00',.         
-00013770: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00013780: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00013790: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
-000137a0: 4f4b 272c 0a20 2020 2020 2020 2020 2020  OK',.           
-000137b0: 2027 7374 6174 7573 2d63 6f64 6527 3a20   'status-code': 
-000137c0: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
-000137d0: 2027 7479 7065 273a 2027 7379 6e63 272c   'type': 'sync',
-000137e0: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-000137f0: 2020 2020 696e 666f 7320 3d20 7365 6c66      infos = self
-00013800: 2e63 6c69 656e 742e 6c69 7374 5f66 696c  .client.list_fil
-00013810: 6573 2827 2f65 7463 2729 0a0a 2020 2020  es('/etc')..    
-00013820: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013830: 7175 616c 286c 656e 2869 6e66 6f73 292c  qual(len(infos),
-00013840: 2032 290a 2020 2020 2020 2020 7365 6c66   2).        self
-00013850: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-00013860: 6f73 5b30 5d2e 7061 7468 2c20 272f 6574  os[0].path, '/et
-00013870: 632f 686f 7374 7327 290a 2020 2020 2020  c/hosts').      
-00013880: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00013890: 616c 2869 6e66 6f73 5b30 5d2e 6e61 6d65  al(infos[0].name
-000138a0: 2c20 2768 6f73 7473 2729 0a20 2020 2020  , 'hosts').     
-000138b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000138c0: 7561 6c28 696e 666f 735b 305d 2e74 7970  ual(infos[0].typ
-000138d0: 652c 2070 6562 626c 652e 4669 6c65 5479  e, pebble.FileTy
-000138e0: 7065 2e46 494c 4529 0a20 2020 2020 2020  pe.FILE).       
-000138f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00013900: 6c28 696e 666f 735b 305d 2e73 697a 652c  l(infos[0].size,
-00013910: 2031 3233 290a 2020 2020 2020 2020 7365   123).        se
-00013920: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-00013930: 6e66 6f73 5b30 5d2e 7065 726d 6973 7369  nfos[0].permissi
-00013940: 6f6e 732c 2030 6f36 3434 290a 2020 2020  ons, 0o644).    
-00013950: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013960: 7175 616c 2869 6e66 6f73 5b30 5d2e 6c61  qual(infos[0].la
-00013970: 7374 5f6d 6f64 6966 6965 642c 2064 6174  st_modified, dat
-00013980: 6574 696d 655f 6e7a 6474 2832 3032 312c  etime_nzdt(2021,
-00013990: 2031 2c20 3238 2c20 3134 2c20 3337 2c20   1, 28, 14, 37, 
-000139a0: 342c 2032 3931 3531 3829 290a 2020 2020  4, 291518)).    
-000139b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000139c0: 7175 616c 2869 6e66 6f73 5b30 5d2e 7573  qual(infos[0].us
-000139d0: 6572 5f69 642c 2031 3229 0a20 2020 2020  er_id, 12).     
-000139e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000139f0: 7561 6c28 696e 666f 735b 305d 2e75 7365  ual(infos[0].use
-00013a00: 722c 2027 626f 6227 290a 2020 2020 2020  r, 'bob').      
-00013a10: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00013a20: 616c 2869 6e66 6f73 5b30 5d2e 6772 6f75  al(infos[0].grou
-00013a30: 705f 6964 2c20 3334 290a 2020 2020 2020  p_id, 34).      
-00013a40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00013a50: 616c 2869 6e66 6f73 5b30 5d2e 6772 6f75  al(infos[0].grou
-00013a60: 702c 2027 7374 6166 6627 290a 2020 2020  p, 'staff').    
-00013a70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013a80: 7175 616c 2869 6e66 6f73 5b31 5d2e 7061  qual(infos[1].pa
-00013a90: 7468 2c20 272f 6574 632f 6e67 696e 7827  th, '/etc/nginx'
-00013aa0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00013ab0: 7373 6572 7445 7175 616c 2869 6e66 6f73  ssertEqual(infos
-00013ac0: 5b31 5d2e 6e61 6d65 2c20 276e 6769 6e78  [1].name, 'nginx
-00013ad0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00013ae0: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
-00013af0: 735b 315d 2e74 7970 652c 2070 6562 626c  s[1].type, pebbl
-00013b00: 652e 4669 6c65 5479 7065 2e44 4952 4543  e.FileType.DIREC
-00013b10: 544f 5259 290a 2020 2020 2020 2020 7365  TORY).        se
-00013b20: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-00013b30: 6e66 6f73 5b31 5d2e 7369 7a65 2c20 4e6f  nfos[1].size, No
-00013b40: 6e65 290a 2020 2020 2020 2020 7365 6c66  ne).        self
-00013b50: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
-00013b60: 6f73 5b31 5d2e 7065 726d 6973 7369 6f6e  os[1].permission
-00013b70: 732c 2030 6f37 3535 290a 2020 2020 2020  s, 0o755).      
-00013b80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00013b90: 616c 2869 6e66 6f73 5b31 5d2e 6c61 7374  al(infos[1].last
-00013ba0: 5f6d 6f64 6966 6965 642c 2064 6174 6574  _modified, datet
-00013bb0: 696d 655f 6e7a 6474 2832 3032 302c 2031  ime_nzdt(2020, 1
-00013bc0: 2c20 312c 2031 2c20 312c 2031 2c20 3029  , 1, 1, 1, 1, 0)
-00013bd0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00013be0: 7373 6572 7449 7328 696e 666f 735b 315d  ssertIs(infos[1]
-00013bf0: 2e75 7365 725f 6964 2c20 4e6f 6e65 290a  .user_id, None).
-00013c00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00013c10: 6572 7449 7328 696e 666f 735b 315d 2e75  ertIs(infos[1].u
-00013c20: 7365 722c 204e 6f6e 6529 0a20 2020 2020  ser, None).     
-00013c30: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-00013c40: 2869 6e66 6f73 5b31 5d2e 6772 6f75 705f  (infos[1].group_
-00013c50: 6964 2c20 4e6f 6e65 290a 2020 2020 2020  id, None).      
-00013c60: 2020 7365 6c66 2e61 7373 6572 7449 7328    self.assertIs(
-00013c70: 696e 666f 735b 315d 2e67 726f 7570 2c20  infos[1].group, 
-00013c80: 4e6f 6e65 290a 0a20 2020 2020 2020 2073  None)..        s
-00013c90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00013ca0: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
-00013cb0: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
-00013cc0: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
-00013cd0: 2f66 696c 6573 272c 207b 2761 6374 696f  /files', {'actio
-00013ce0: 6e27 3a20 276c 6973 7427 2c20 2770 6174  n': 'list', 'pat
-00013cf0: 6827 3a20 272f 6574 6327 7d2c 204e 6f6e  h': '/etc'}, Non
-00013d00: 6529 2c0a 2020 2020 2020 2020 5d29 0a0a  e),.        ])..
-00013d10: 2020 2020 6465 6620 7465 7374 5f6c 6973      def test_lis
-00013d20: 745f 6669 6c65 735f 7061 7474 6572 6e28  t_files_pattern(
-00013d30: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00013d40: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
-00013d50: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
-00013d60: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
-00013d70: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
-00013d80: 2020 2020 2773 7461 7475 7327 3a20 274f      'status': 'O
-00013d90: 4b27 2c0a 2020 2020 2020 2020 2020 2020  K',.            
-00013da0: 2773 7461 7475 732d 636f 6465 273a 2032  'status-code': 2
-00013db0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00013dc0: 2774 7970 6527 3a20 2773 796e 6327 2c0a  'type': 'sync',.
-00013dd0: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
-00013de0: 2020 2020 696e 666f 7320 3d20 7365 6c66      infos = self
-00013df0: 2e63 6c69 656e 742e 6c69 7374 5f66 696c  .client.list_fil
-00013e00: 6573 2827 2f65 7463 272c 2070 6174 7465  es('/etc', patte
-00013e10: 726e 3d27 2a2e 636f 6e66 2729 0a0a 2020  rn='*.conf')..  
-00013e20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013e30: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
-00013e40: 292c 2030 290a 2020 2020 2020 2020 7365  ), 0).        se
-00013e50: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00013e60: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00013e70: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-00013e80: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-00013e90: 6669 6c65 7327 2c20 7b27 6163 7469 6f6e  files', {'action
-00013ea0: 273a 2027 6c69 7374 272c 2027 7061 7468  ': 'list', 'path
-00013eb0: 273a 2027 2f65 7463 272c 2027 7061 7474  ': '/etc', 'patt
-00013ec0: 6572 6e27 3a20 272a 2e63 6f6e 6627 7d2c  ern': '*.conf'},
-00013ed0: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-00013ee0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00013ef0: 5f6c 6973 745f 6669 6c65 735f 6974 7365  _list_files_itse
-00013f00: 6c66 2873 656c 6629 3a0a 2020 2020 2020  lf(self):.      
-00013f10: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-00013f20: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-00013f30: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-00013f40: 7375 6c74 223a 205b 5d2c 0a20 2020 2020  sult": [],.     
-00013f50: 2020 2020 2020 2027 7374 6174 7573 273a         'status':
-00013f60: 2027 4f4b 272c 0a20 2020 2020 2020 2020   'OK',.         
-00013f70: 2020 2027 7374 6174 7573 2d63 6f64 6527     'status-code'
-00013f80: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
-00013f90: 2020 2027 7479 7065 273a 2027 7379 6e63     'type': 'sync
-00013fa0: 272c 0a20 2020 2020 2020 207d 290a 0a20  ',.        }).. 
-00013fb0: 2020 2020 2020 2069 6e66 6f73 203d 2073         infos = s
-00013fc0: 656c 662e 636c 6965 6e74 2e6c 6973 745f  elf.client.list_
-00013fd0: 6669 6c65 7328 272f 6574 6327 2c20 6974  files('/etc', it
-00013fe0: 7365 6c66 3d54 7275 6529 0a0a 2020 2020  self=True)..    
-00013ff0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00014000: 7175 616c 286c 656e 2869 6e66 6f73 292c  qual(len(infos),
-00014010: 2030 290a 2020 2020 2020 2020 7365 6c66   0).        self
-00014020: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00014030: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-00014040: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-00014050: 2028 2747 4554 272c 2027 2f76 312f 6669   ('GET', '/v1/fi
-00014060: 6c65 7327 2c20 7b27 6163 7469 6f6e 273a  les', {'action':
-00014070: 2027 6c69 7374 272c 2027 7061 7468 273a   'list', 'path':
-00014080: 2027 2f65 7463 272c 2027 6974 7365 6c66   '/etc', 'itself
-00014090: 273a 2027 7472 7565 277d 2c20 4e6f 6e65  ': 'true'}, None
-000140a0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-000140b0: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
-000140c0: 5f64 6972 5f62 6173 6963 2873 656c 6629  _dir_basic(self)
-000140d0: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
-000140e0: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
-000140f0: 6170 7065 6e64 287b 0a20 2020 2020 2020  append({.       
-00014100: 2020 2020 2022 7265 7375 6c74 223a 205b       "result": [
-00014110: 7b27 7061 7468 273a 2027 2f66 6f6f 2f62  {'path': '/foo/b
-00014120: 6172 277d 5d2c 0a20 2020 2020 2020 2020  ar'}],.         
-00014130: 2020 2027 7374 6174 7573 273a 2027 4f4b     'status': 'OK
-00014140: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00014150: 7374 6174 7573 2d63 6f64 6527 3a20 3230  status-code': 20
-00014160: 302c 0a20 2020 2020 2020 2020 2020 2027  0,.            '
-00014170: 7479 7065 273a 2027 7379 6e63 272c 0a20  type': 'sync',. 
-00014180: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
-00014190: 2020 7365 6c66 2e63 6c69 656e 742e 6d61    self.client.ma
-000141a0: 6b65 5f64 6972 2827 2f66 6f6f 2f62 6172  ke_dir('/foo/bar
-000141b0: 2729 0a20 2020 2020 2020 2072 6571 203d  ').        req =
-000141c0: 207b 2761 6374 696f 6e27 3a20 276d 616b   {'action': 'mak
-000141d0: 652d 6469 7273 272c 2027 6469 7273 273a  e-dirs', 'dirs':
-000141e0: 205b 7b0a 2020 2020 2020 2020 2020 2020   [{.            
-000141f0: 2770 6174 6827 3a20 272f 666f 6f2f 6261  'path': '/foo/ba
-00014200: 7227 2c0a 2020 2020 2020 2020 7d5d 7d0a  r',.        }]}.
-00014210: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014220: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
-00014230: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
-00014240: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
-00014250: 4f53 5427 2c20 272f 7631 2f66 696c 6573  OST', '/v1/files
-00014260: 272c 204e 6f6e 652c 2072 6571 292c 0a20  ', None, req),. 
-00014270: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-00014280: 6566 2074 6573 745f 6d61 6b65 5f64 6972  ef test_make_dir
-00014290: 5f61 6c6c 5f6f 7074 696f 6e73 2873 656c  _all_options(sel
-000142a0: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-000142b0: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
-000142c0: 732e 6170 7065 6e64 287b 0a20 2020 2020  s.append({.     
-000142d0: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
-000142e0: 205b 7b27 7061 7468 273a 2027 2f66 6f6f   [{'path': '/foo
-000142f0: 2f62 6172 277d 5d2c 0a20 2020 2020 2020  /bar'}],.       
-00014300: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
-00014310: 4f4b 272c 0a20 2020 2020 2020 2020 2020  OK',.           
-00014320: 2027 7374 6174 7573 2d63 6f64 6527 3a20   'status-code': 
-00014330: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
-00014340: 2027 7479 7065 273a 2027 7379 6e63 272c   'type': 'sync',
-00014350: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
-00014360: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00014370: 6d61 6b65 5f64 6972 2827 2f66 6f6f 2f62  make_dir('/foo/b
-00014380: 6172 272c 206d 616b 655f 7061 7265 6e74  ar', make_parent
-00014390: 733d 5472 7565 2c20 7065 726d 6973 7369  s=True, permissi
-000143a0: 6f6e 733d 306f 3630 302c 0a20 2020 2020  ons=0o600,.     
-000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143c0: 2020 2020 2020 2020 7573 6572 5f69 643d          user_id=
-000143d0: 3132 2c20 7573 6572 3d27 626f 6227 2c20  12, user='bob', 
-000143e0: 6772 6f75 705f 6964 3d33 342c 2067 726f  group_id=34, gro
-000143f0: 7570 3d27 7374 6166 6627 290a 0a20 2020  up='staff')..   
-00014400: 2020 2020 2072 6571 203d 207b 2761 6374       req = {'act
-00014410: 696f 6e27 3a20 276d 616b 652d 6469 7273  ion': 'make-dirs
-00014420: 272c 2027 6469 7273 273a 205b 7b0a 2020  ', 'dirs': [{.  
-00014430: 2020 2020 2020 2020 2020 2770 6174 6827            'path'
-00014440: 3a20 272f 666f 6f2f 6261 7227 2c0a 2020  : '/foo/bar',.  
-00014450: 2020 2020 2020 2020 2020 276d 616b 652d            'make-
-00014460: 7061 7265 6e74 7327 3a20 5472 7565 2c0a  parents': True,.
-00014470: 2020 2020 2020 2020 2020 2020 2770 6572              'per
-00014480: 6d69 7373 696f 6e73 273a 2027 3630 3027  missions': '600'
-00014490: 2c0a 2020 2020 2020 2020 2020 2020 2775  ,.            'u
-000144a0: 7365 722d 6964 273a 2031 322c 0a20 2020  ser-id': 12,.   
-000144b0: 2020 2020 2020 2020 2027 7573 6572 273a           'user':
-000144c0: 2027 626f 6227 2c0a 2020 2020 2020 2020   'bob',.        
-000144d0: 2020 2020 2767 726f 7570 2d69 6427 3a20      'group-id': 
-000144e0: 3334 2c0a 2020 2020 2020 2020 2020 2020  34,.            
-000144f0: 2767 726f 7570 273a 2027 7374 6166 6627  'group': 'staff'
-00014500: 2c0a 2020 2020 2020 2020 7d5d 7d0a 2020  ,.        }]}.  
-00014510: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00014520: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-00014530: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-00014540: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
-00014550: 5427 2c20 272f 7631 2f66 696c 6573 272c  T', '/v1/files',
-00014560: 204e 6f6e 652c 2072 6571 292c 0a20 2020   None, req),.   
-00014570: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-00014580: 2074 6573 745f 6d61 6b65 5f64 6972 5f65   test_make_dir_e
-00014590: 7272 6f72 2873 656c 6629 3a0a 2020 2020  rror(self):.    
-000145a0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-000145b0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-000145c0: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
-000145d0: 7265 7375 6c74 223a 205b 7b0a 2020 2020  result": [{.    
-000145e0: 2020 2020 2020 2020 2020 2020 2770 6174              'pat
-000145f0: 6827 3a20 272f 666f 6f2f 6261 7227 2c0a  h': '/foo/bar',.
-00014600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014610: 2765 7272 6f72 273a 207b 0a20 2020 2020  'error': {.     
-00014620: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00014630: 6b69 6e64 273a 2027 7065 726d 6973 7369  kind': 'permissi
-00014640: 6f6e 2d64 656e 6965 6427 2c0a 2020 2020  on-denied',.    
-00014650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014660: 276d 6573 7361 6765 273a 2027 7065 726d  'message': 'perm
-00014670: 6973 7369 6f6e 2064 656e 6965 6427 2c0a  ission denied',.
-00014680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014690: 7d2c 0a20 2020 2020 2020 2020 2020 207d  },.            }
-000146a0: 5d2c 0a20 2020 2020 2020 2020 2020 2027  ],.            '
-000146b0: 7374 6174 7573 273a 2027 4f4b 272c 0a20  status': 'OK',. 
-000146c0: 2020 2020 2020 2020 2020 2027 7374 6174             'stat
-000146d0: 7573 2d63 6f64 6527 3a20 3230 302c 0a20  us-code': 200,. 
-000146e0: 2020 2020 2020 2020 2020 2027 7479 7065             'type
-000146f0: 273a 2027 7379 6e63 272c 0a20 2020 2020  ': 'sync',.     
-00014700: 2020 207d 290a 2020 2020 2020 2020 7769     }).        wi
-00014710: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00014720: 6973 6573 2870 6562 626c 652e 5061 7468  ises(pebble.Path
-00014730: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
-00014740: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00014750: 6c69 656e 742e 6d61 6b65 5f64 6972 2827  lient.make_dir('
-00014760: 2f66 6f6f 2f62 6172 2729 0a20 2020 2020  /foo/bar').     
-00014770: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-00014780: 496e 7374 616e 6365 2863 6d2e 6578 6365  Instance(cm.exce
-00014790: 7074 696f 6e2c 2070 6562 626c 652e 4572  ption, pebble.Er
-000147a0: 726f 7229 0a20 2020 2020 2020 2073 656c  ror).        sel
-000147b0: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
-000147c0: 2e65 7863 6570 7469 6f6e 2e6b 696e 642c  .exception.kind,
-000147d0: 2027 7065 726d 6973 7369 6f6e 2d64 656e   'permission-den
-000147e0: 6965 6427 290a 2020 2020 2020 2020 7365  ied').        se
-000147f0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00014800: 6d2e 6578 6365 7074 696f 6e2e 6d65 7373  m.exception.mess
-00014810: 6167 652c 2027 7065 726d 6973 7369 6f6e  age, 'permission
-00014820: 2064 656e 6965 6427 290a 0a20 2020 2064   denied')..    d
-00014830: 6566 2074 6573 745f 7265 6d6f 7665 5f70  ef test_remove_p
-00014840: 6174 685f 6261 7369 6328 7365 6c66 293a  ath_basic(self):
-00014850: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00014860: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-00014870: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
-00014880: 2020 2020 2272 6573 756c 7422 3a20 5b7b      "result": [{
-00014890: 2770 6174 6827 3a20 272f 626f 6f2f 6661  'path': '/boo/fa
-000148a0: 7227 7d5d 2c0a 2020 2020 2020 2020 2020  r'}],.          
-000148b0: 2020 2773 7461 7475 7327 3a20 274f 4b27    'status': 'OK'
-000148c0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-000148d0: 7461 7475 732d 636f 6465 273a 2032 3030  tatus-code': 200
-000148e0: 2c0a 2020 2020 2020 2020 2020 2020 2774  ,.            't
-000148f0: 7970 6527 3a20 2773 796e 6327 2c0a 2020  ype': 'sync',.  
-00014900: 2020 2020 2020 7d29 0a20 2020 2020 2020        }).       
-00014910: 2073 656c 662e 636c 6965 6e74 2e72 656d   self.client.rem
-00014920: 6f76 655f 7061 7468 2827 2f62 6f6f 2f66  ove_path('/boo/f
-00014930: 6172 2729 0a20 2020 2020 2020 2072 6571  ar').        req
-00014940: 203d 207b 2761 6374 696f 6e27 3a20 2772   = {'action': 'r
-00014950: 656d 6f76 6527 2c20 2770 6174 6873 273a  emove', 'paths':
-00014960: 205b 7b0a 2020 2020 2020 2020 2020 2020   [{.            
-00014970: 2770 6174 6827 3a20 272f 626f 6f2f 6661  'path': '/boo/fa
-00014980: 7227 2c0a 2020 2020 2020 2020 7d5d 7d0a  r',.        }]}.
-00014990: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000149a0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
-000149b0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
-000149c0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
-000149d0: 4f53 5427 2c20 272f 7631 2f66 696c 6573  OST', '/v1/files
-000149e0: 272c 204e 6f6e 652c 2072 6571 292c 0a20  ', None, req),. 
-000149f0: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
-00014a00: 6566 2074 6573 745f 7265 6d6f 7665 5f70  ef test_remove_p
-00014a10: 6174 685f 7265 6375 7273 6976 6528 7365  ath_recursive(se
-00014a20: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00014a30: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-00014a40: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
-00014a50: 2020 2020 2020 2020 2272 6573 756c 7422          "result"
-00014a60: 3a20 5b7b 2770 6174 6827 3a20 272f 626f  : [{'path': '/bo
-00014a70: 6f2f 6661 7227 7d5d 2c0a 2020 2020 2020  o/far'}],.      
-00014a80: 2020 2020 2020 2773 7461 7475 7327 3a20        'status': 
-00014a90: 274f 4b27 2c0a 2020 2020 2020 2020 2020  'OK',.          
-00014aa0: 2020 2773 7461 7475 732d 636f 6465 273a    'status-code':
-00014ab0: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
-00014ac0: 2020 2774 7970 6527 3a20 2773 796e 6327    'type': 'sync'
-00014ad0: 2c0a 2020 2020 2020 2020 7d29 0a20 2020  ,.        }).   
-00014ae0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00014af0: 2e72 656d 6f76 655f 7061 7468 2827 2f62  .remove_path('/b
-00014b00: 6f6f 2f66 6172 272c 2072 6563 7572 7369  oo/far', recursi
-00014b10: 7665 3d54 7275 6529 0a0a 2020 2020 2020  ve=True)..      
-00014b20: 2020 7265 7120 3d20 7b27 6163 7469 6f6e    req = {'action
-00014b30: 273a 2027 7265 6d6f 7665 272c 2027 7061  ': 'remove', 'pa
-00014b40: 7468 7327 3a20 5b7b 0a20 2020 2020 2020  ths': [{.       
-00014b50: 2020 2020 2027 7061 7468 273a 2027 2f62       'path': '/b
-00014b60: 6f6f 2f66 6172 272c 0a20 2020 2020 2020  oo/far',.       
-00014b70: 2020 2020 2027 7265 6375 7273 6976 6527       'recursive'
-00014b80: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
-00014b90: 7d5d 7d0a 2020 2020 2020 2020 7365 6c66  }]}.        self
-00014ba0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-00014bb0: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-00014bc0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-00014bd0: 2028 2750 4f53 5427 2c20 272f 7631 2f66   ('POST', '/v1/f
-00014be0: 696c 6573 272c 204e 6f6e 652c 2072 6571  iles', None, req
-00014bf0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
-00014c00: 2020 2064 6566 2074 6573 745f 7265 6d6f     def test_remo
-00014c10: 7665 5f70 6174 685f 6572 726f 7228 7365  ve_path_error(se
-00014c20: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00014c30: 662e 636c 6965 6e74 2e72 6573 706f 6e73  f.client.respons
-00014c40: 6573 2e61 7070 656e 6428 7b0a 2020 2020  es.append({.    
-00014c50: 2020 2020 2020 2020 2272 6573 756c 7422          "result"
-00014c60: 3a20 5b7b 0a20 2020 2020 2020 2020 2020  : [{.           
-00014c70: 2020 2020 2027 7061 7468 273a 2027 2f62       'path': '/b
-00014c80: 6f6f 2f66 6172 272c 0a20 2020 2020 2020  oo/far',.       
-00014c90: 2020 2020 2020 2020 2027 6572 726f 7227           'error'
-00014ca0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00014cb0: 2020 2020 2020 2020 276b 696e 6427 3a20          'kind': 
-00014cc0: 2767 656e 6572 6963 2d66 696c 652d 6572  'generic-file-er
-00014cd0: 726f 7227 2c0a 2020 2020 2020 2020 2020  ror',.          
-00014ce0: 2020 2020 2020 2020 2020 276d 6573 7361            'messa
-00014cf0: 6765 273a 2027 736f 6d65 206f 7468 6572  ge': 'some other
-00014d00: 2065 7272 6f72 272c 0a20 2020 2020 2020   error',.       
-00014d10: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00014d20: 2020 2020 2020 2020 7d5d 2c0a 2020 2020          }],.    
+0000e2b0: 662e 7469 6d65 2e74 696d 6528 292c 2034  f.time.time(), 4
+0000e2c0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000e2d0: 7761 6974 5f63 6861 6e67 655f 7375 6363  wait_change_succ
+0000e2e0: 6573 735f 706f 6c6c 6564 2873 656c 662c  ess_polled(self,
+0000e2f0: 2074 696d 656f 7574 3d33 302e 3029 3a0a   timeout=30.0):.
+0000e300: 2020 2020 2020 2020 2320 5472 6967 6765          # Trigge
+0000e310: 7220 706f 6c6c 6564 206d 6f64 650a 2020  r polled mode.  
+0000e320: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000e330: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+0000e340: 6e64 2870 6562 626c 652e 4150 4945 7272  nd(pebble.APIErr
+0000e350: 6f72 287b 7d2c 2034 3034 2c20 224e 6f74  or({}, 404, "Not
+0000e360: 2046 6f75 6e64 222c 2022 6e6f 7420 666f   Found", "not fo
+0000e370: 756e 6422 2929 0a0a 2020 2020 2020 2020  und"))..        
+0000e380: 666f 7220 6920 696e 2072 616e 6765 2833  for i in range(3
+0000e390: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+0000e3a0: 6861 6e67 6520 3d20 6275 696c 645f 6d6f  hange = build_mo
+0000e3b0: 636b 5f63 6861 6e67 655f 6469 6374 2829  ck_change_dict()
+0000e3c0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
+0000e3d0: 6e67 655b 2772 6561 6479 275d 203d 2069  nge['ready'] = i
+0000e3e0: 203d 3d20 320a 2020 2020 2020 2020 2020   == 2.          
+0000e3f0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000e400: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
+0000e410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e420: 2022 7265 7375 6c74 223a 2063 6861 6e67   "result": chang
+0000e430: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000e440: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
+0000e450: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000e460: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
+0000e470: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
+0000e480: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
+0000e490: 7379 6e63 220a 2020 2020 2020 2020 2020  sync".          
+0000e4a0: 2020 7d29 0a0a 2020 2020 2020 2020 7265    })..        re
+0000e4b0: 7370 6f6e 7365 203d 2073 656c 662e 636c  sponse = self.cl
+0000e4c0: 6965 6e74 2e77 6169 745f 6368 616e 6765  ient.wait_change
+0000e4d0: 2827 3730 272c 2074 696d 656f 7574 3d74  ('70', timeout=t
+0000e4e0: 696d 656f 7574 2c20 6465 6c61 793d 3129  imeout, delay=1)
+0000e4f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000e500: 7365 7274 4571 7561 6c28 7265 7370 6f6e  sertEqual(respon
+0000e510: 7365 2e69 642c 2027 3730 2729 0a20 2020  se.id, '70').   
+0000e520: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000e530: 5472 7565 2872 6573 706f 6e73 652e 7265  True(response.re
+0000e540: 6164 7929 0a0a 2020 2020 2020 2020 7365  ady)..        se
+0000e550: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000e560: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+0000e570: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000e580: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0000e590: 6368 616e 6765 732f 3730 2f77 6169 7427  changes/70/wait'
+0000e5a0: 2c20 7b27 7469 6d65 6f75 7427 3a20 2734  , {'timeout': '4
+0000e5b0: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
+0000e5c0: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+0000e5d0: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
+0000e5e0: 2f37 3027 2c20 4e6f 6e65 2c20 4e6f 6e65  /70', None, None
+0000e5f0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0000e600: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0000e610: 6765 732f 3730 272c 204e 6f6e 652c 204e  ges/70', None, N
+0000e620: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
+0000e630: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
+0000e640: 6861 6e67 6573 2f37 3027 2c20 4e6f 6e65  hanges/70', None
+0000e650: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+0000e660: 205d 290a 0a20 2020 2020 2020 2073 656c   ])..        sel
+0000e670: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000e680: 6c66 2e74 696d 652e 7469 6d65 2829 2c20  lf.time.time(), 
+0000e690: 3229 0a0a 2020 2020 6465 6620 7465 7374  2)..    def test
+0000e6a0: 5f77 6169 745f 6368 616e 6765 5f73 7563  _wait_change_suc
+0000e6b0: 6365 7373 5f70 6f6c 6c65 645f 7469 6d65  cess_polled_time
+0000e6c0: 6f75 745f 6e6f 6e65 2873 656c 6629 3a0a  out_none(self):.
+0000e6d0: 2020 2020 2020 2020 7365 6c66 2e74 6573          self.tes
+0000e6e0: 745f 7761 6974 5f63 6861 6e67 655f 7375  t_wait_change_su
+0000e6f0: 6363 6573 735f 706f 6c6c 6564 2874 696d  ccess_polled(tim
+0000e700: 656f 7574 3d4e 6f6e 6529 0a0a 2020 2020  eout=None)..    
+0000e710: 6465 6620 7465 7374 5f77 6169 745f 6368  def test_wait_ch
+0000e720: 616e 6765 5f74 696d 656f 7574 2873 656c  ange_timeout(sel
+0000e730: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
+0000e740: 7469 6d65 6f75 745f 7265 7370 6f6e 7365  timeout_response
+0000e750: 286e 293a 0a20 2020 2020 2020 2020 2020  (n):.           
+0000e760: 2073 656c 662e 7469 6d65 2e73 6c65 6570   self.time.sleep
+0000e770: 286e 2920 2023 2073 696d 756c 6174 6520  (n)  # simulate 
+0000e780: 7061 7373 696e 6720 6f66 2074 696d 6520  passing of time 
+0000e790: 6475 6520 746f 2077 6169 745f 6368 616e  due to wait_chan
+0000e7a0: 6765 2063 616c 6c0a 2020 2020 2020 2020  ge call.        
+0000e7b0: 2020 2020 7261 6973 6520 7065 6262 6c65      raise pebble
+0000e7c0: 2e41 5049 4572 726f 7228 7b7d 2c20 3530  .APIError({}, 50
+0000e7d0: 342c 2022 4761 7465 7761 7920 5469 6d65  4, "Gateway Time
+0000e7e0: 6f75 7422 2c20 2274 696d 6564 206f 7574  out", "timed out
+0000e7f0: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
+0000e800: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
+0000e810: 732e 6170 7065 6e64 286c 616d 6264 613a  s.append(lambda:
+0000e820: 2074 696d 656f 7574 5f72 6573 706f 6e73   timeout_respons
+0000e830: 6528 3429 290a 2020 2020 2020 2020 7365  e(4)).        se
+0000e840: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
+0000e850: 7365 732e 6170 7065 6e64 286c 616d 6264  ses.append(lambd
+0000e860: 613a 2074 696d 656f 7574 5f72 6573 706f  a: timeout_respo
+0000e870: 6e73 6528 3229 290a 0a20 2020 2020 2020  nse(2))..       
+0000e880: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000e890: 7452 6169 7365 7328 7065 6262 6c65 2e54  tRaises(pebble.T
+0000e8a0: 696d 656f 7574 4572 726f 7229 2061 7320  imeoutError) as 
+0000e8b0: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
+0000e8c0: 7365 6c66 2e63 6c69 656e 742e 7761 6974  self.client.wait
+0000e8d0: 5f63 6861 6e67 6528 2737 3027 2c20 7469  _change('70', ti
+0000e8e0: 6d65 6f75 743d 3629 0a20 2020 2020 2020  meout=6).       
+0000e8f0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+0000e900: 7374 616e 6365 2863 6d2e 6578 6365 7074  stance(cm.except
+0000e910: 696f 6e2c 2070 6562 626c 652e 4572 726f  ion, pebble.Erro
+0000e920: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
+0000e930: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
+0000e940: 2863 6d2e 6578 6365 7074 696f 6e2c 2054  (cm.exception, T
+0000e950: 696d 656f 7574 4572 726f 7229 0a0a 2020  imeoutError)..  
+0000e960: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000e970: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
+0000e980: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
+0000e990: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+0000e9a0: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
+0000e9b0: 3730 2f77 6169 7427 2c20 7b27 7469 6d65  70/wait', {'time
+0000e9c0: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
+0000e9d0: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0000e9e0: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
+0000e9f0: 2f63 6861 6e67 6573 2f37 302f 7761 6974  /changes/70/wait
+0000ea00: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
+0000ea10: 322e 3030 3073 277d 2c20 4e6f 6e65 292c  2.000s'}, None),
+0000ea20: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+0000ea30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000ea40: 4571 7561 6c28 7365 6c66 2e74 696d 652e  Equal(self.time.
+0000ea50: 7469 6d65 2829 2c20 3629 0a0a 2020 2020  time(), 6)..    
+0000ea60: 6465 6620 7465 7374 5f77 6169 745f 6368  def test_wait_ch
+0000ea70: 616e 6765 5f74 696d 656f 7574 5f70 6f6c  ange_timeout_pol
+0000ea80: 6c65 6428 7365 6c66 293a 0a20 2020 2020  led(self):.     
+0000ea90: 2020 2023 2054 7269 6767 6572 2070 6f6c     # Trigger pol
+0000eaa0: 6c65 6420 6d6f 6465 0a20 2020 2020 2020  led mode.       
+0000eab0: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
+0000eac0: 706f 6e73 6573 2e61 7070 656e 6428 7065  ponses.append(pe
+0000ead0: 6262 6c65 2e41 5049 4572 726f 7228 7b7d  bble.APIError({}
+0000eae0: 2c20 3430 342c 2022 4e6f 7420 466f 756e  , 404, "Not Foun
+0000eaf0: 6422 2c20 226e 6f74 2066 6f75 6e64 2229  d", "not found")
+0000eb00: 290a 0a20 2020 2020 2020 2063 6861 6e67  )..        chang
+0000eb10: 6520 3d20 6275 696c 645f 6d6f 636b 5f63  e = build_mock_c
+0000eb20: 6861 6e67 655f 6469 6374 2829 0a20 2020  hange_dict().   
+0000eb30: 2020 2020 2063 6861 6e67 655b 2772 6561       change['rea
+0000eb40: 6479 275d 203d 2046 616c 7365 0a20 2020  dy'] = False.   
+0000eb50: 2020 2020 2066 6f72 205f 2069 6e20 7261       for _ in ra
+0000eb60: 6e67 6528 3329 3a0a 2020 2020 2020 2020  nge(3):.        
+0000eb70: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000eb80: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+0000eb90: 287b 0a20 2020 2020 2020 2020 2020 2020  ({.             
+0000eba0: 2020 2022 7265 7375 6c74 223a 2063 6861     "result": cha
+0000ebb0: 6e67 652c 0a20 2020 2020 2020 2020 2020  nge,.           
+0000ebc0: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
+0000ebd0: 4f4b 222c 0a20 2020 2020 2020 2020 2020  OK",.           
+0000ebe0: 2020 2020 2022 7374 6174 7573 2d63 6f64       "status-cod
+0000ebf0: 6522 3a20 3230 302c 0a20 2020 2020 2020  e": 200,.       
+0000ec00: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
+0000ec10: 2022 7379 6e63 220a 2020 2020 2020 2020   "sync".        
+0000ec20: 2020 2020 7d29 0a0a 2020 2020 2020 2020      })..        
+0000ec30: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000ec40: 5261 6973 6573 2870 6562 626c 652e 5469  Raises(pebble.Ti
+0000ec50: 6d65 6f75 7445 7272 6f72 2920 6173 2063  meoutError) as c
+0000ec60: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
+0000ec70: 656c 662e 636c 6965 6e74 2e77 6169 745f  elf.client.wait_
+0000ec80: 6368 616e 6765 2827 3730 272c 2074 696d  change('70', tim
+0000ec90: 656f 7574 3d33 2c20 6465 6c61 793d 3129  eout=3, delay=1)
+0000eca0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0000ecb0: 7365 7274 4973 496e 7374 616e 6365 2863  sertIsInstance(c
+0000ecc0: 6d2e 6578 6365 7074 696f 6e2c 2070 6562  m.exception, peb
+0000ecd0: 626c 652e 4572 726f 7229 0a20 2020 2020  ble.Error).     
+0000ece0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0000ecf0: 496e 7374 616e 6365 2863 6d2e 6578 6365  Instance(cm.exce
+0000ed00: 7074 696f 6e2c 2054 696d 656f 7574 4572  ption, TimeoutEr
+0000ed10: 726f 7229 0a0a 2020 2020 2020 2020 7365  ror)..        se
+0000ed20: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000ed30: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+0000ed40: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000ed50: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+0000ed60: 6368 616e 6765 732f 3730 2f77 6169 7427  changes/70/wait'
+0000ed70: 2c20 7b27 7469 6d65 6f75 7427 3a20 2733  , {'timeout': '3
+0000ed80: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
+0000ed90: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+0000eda0: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
+0000edb0: 2f37 3027 2c20 4e6f 6e65 2c20 4e6f 6e65  /70', None, None
+0000edc0: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0000edd0: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0000ede0: 6765 732f 3730 272c 204e 6f6e 652c 204e  ges/70', None, N
+0000edf0: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
+0000ee00: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
+0000ee10: 6861 6e67 6573 2f37 3027 2c20 4e6f 6e65  hanges/70', None
+0000ee20: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+0000ee30: 205d 290a 0a20 2020 2020 2020 2073 656c   ])..        sel
+0000ee40: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0000ee50: 6c66 2e74 696d 652e 7469 6d65 2829 2c20  lf.time.time(), 
+0000ee60: 3329 0a0a 2020 2020 6465 6620 7465 7374  3)..    def test
+0000ee70: 5f77 6169 745f 6368 616e 6765 5f65 7272  _wait_change_err
+0000ee80: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
+0000ee90: 2020 6368 616e 6765 203d 2062 7569 6c64    change = build
+0000eea0: 5f6d 6f63 6b5f 6368 616e 6765 5f64 6963  _mock_change_dic
+0000eeb0: 7428 290a 2020 2020 2020 2020 6368 616e  t().        chan
+0000eec0: 6765 5b27 6572 7227 5d20 3d20 2753 6f6d  ge['err'] = 'Som
+0000eed0: 6520 6b69 6e64 206f 6620 7365 7276 6963  e kind of servic
+0000eee0: 6520 6572 726f 7227 0a20 2020 2020 2020  e error'.       
+0000eef0: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
+0000ef00: 706f 6e73 6573 2e61 7070 656e 6428 7b0a  ponses.append({.
+0000ef10: 2020 2020 2020 2020 2020 2020 2272 6573              "res
+0000ef20: 756c 7422 3a20 6368 616e 6765 2c0a 2020  ult": change,.  
+0000ef30: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000ef40: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+0000ef50: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
+0000ef60: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
+0000ef70: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
+0000ef80: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
+0000ef90: 2020 2020 2020 2020 2320 7761 6974 5f63          # wait_c
+0000efa0: 6861 6e67 6528 2920 6974 7365 6c66 2073  hange() itself s
+0000efb0: 686f 756c 646e 2774 2072 6169 7365 2061  houldn't raise a
+0000efc0: 6e20 6572 726f 720a 2020 2020 2020 2020  n error.        
+0000efd0: 7265 7370 6f6e 7365 203d 2073 656c 662e  response = self.
+0000efe0: 636c 6965 6e74 2e77 6169 745f 6368 616e  client.wait_chan
+0000eff0: 6765 2827 3730 2729 0a20 2020 2020 2020  ge('70').       
+0000f000: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f010: 6c28 7265 7370 6f6e 7365 2e69 642c 2027  l(response.id, '
+0000f020: 3730 2729 0a20 2020 2020 2020 2073 656c  70').        sel
+0000f030: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
+0000f040: 7370 6f6e 7365 2e65 7272 2c20 2753 6f6d  sponse.err, 'Som
+0000f050: 6520 6b69 6e64 206f 6620 7365 7276 6963  e kind of servic
+0000f060: 6520 6572 726f 7227 290a 0a20 2020 2020  e error')..     
+0000f070: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000f080: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
+0000f090: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
+0000f0a0: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
+0000f0b0: 272f 7631 2f63 6861 6e67 6573 2f37 302f  '/v1/changes/70/
+0000f0c0: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
+0000f0d0: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
+0000f0e0: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+0000f0f0: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+0000f100: 645f 6c61 7965 7228 7365 6c66 293a 0a20  d_layer(self):. 
+0000f110: 2020 2020 2020 206f 6b61 795f 7265 7370         okay_resp
+0000f120: 6f6e 7365 203d 207b 0a20 2020 2020 2020  onse = {.       
+0000f130: 2020 2020 2022 7265 7375 6c74 223a 2054       "result": T
+0000f140: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0000f150: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
+0000f160: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0000f170: 6174 7573 2d63 6f64 6522 3a20 3230 302c  atus-code": 200,
+0000f180: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
+0000f190: 7065 223a 2022 7379 6e63 220a 2020 2020  pe": "sync".    
+0000f1a0: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
+0000f1b0: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
+0000f1c0: 7365 732e 6170 7065 6e64 286f 6b61 795f  ses.append(okay_
+0000f1d0: 7265 7370 6f6e 7365 290a 2020 2020 2020  response).      
+0000f1e0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+0000f1f0: 7370 6f6e 7365 732e 6170 7065 6e64 286f  sponses.append(o
+0000f200: 6b61 795f 7265 7370 6f6e 7365 290a 2020  kay_response).  
+0000f210: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000f220: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+0000f230: 6e64 286f 6b61 795f 7265 7370 6f6e 7365  nd(okay_response
+0000f240: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0000f250: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+0000f260: 6170 7065 6e64 286f 6b61 795f 7265 7370  append(okay_resp
+0000f270: 6f6e 7365 290a 0a20 2020 2020 2020 206c  onse)..        l
+0000f280: 6179 6572 5f79 616d 6c20 3d20 2222 220a  ayer_yaml = """.
+0000f290: 7365 7276 6963 6573 3a0a 2020 666f 6f3a  services:.  foo:
+0000f2a0: 0a20 2020 2063 6f6d 6d61 6e64 3a20 6563  .    command: ec
+0000f2b0: 686f 2062 6172 0a20 2020 206f 7665 7272  ho bar.    overr
+0000f2c0: 6964 653a 2072 6570 6c61 6365 0a22 2222  ide: replace."""
+0000f2d0: 5b31 3a5d 0a20 2020 2020 2020 206c 6179  [1:].        lay
+0000f2e0: 6572 203d 2070 6562 626c 652e 4c61 7965  er = pebble.Laye
+0000f2f0: 7228 6c61 7965 725f 7961 6d6c 290a 0a20  r(layer_yaml).. 
+0000f300: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+0000f310: 6e74 2e61 6464 5f6c 6179 6572 2827 6127  nt.add_layer('a'
+0000f320: 2c20 6c61 7965 7229 0a20 2020 2020 2020  , layer).       
+0000f330: 2073 656c 662e 636c 6965 6e74 2e61 6464   self.client.add
+0000f340: 5f6c 6179 6572 2827 6227 2c20 6c61 7965  _layer('b', laye
+0000f350: 722e 746f 5f79 616d 6c28 2929 0a20 2020  r.to_yaml()).   
+0000f360: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0000f370: 2e61 6464 5f6c 6179 6572 2827 6327 2c20  .add_layer('c', 
+0000f380: 6c61 7965 722e 746f 5f64 6963 7428 2929  layer.to_dict())
+0000f390: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+0000f3a0: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
+0000f3b0: 6427 2c20 6c61 7965 722c 2063 6f6d 6269  d', layer, combi
+0000f3c0: 6e65 3d54 7275 6529 0a0a 2020 2020 2020  ne=True)..      
+0000f3d0: 2020 6465 6620 6275 696c 645f 6578 7065    def build_expe
+0000f3e0: 6374 6564 286c 6162 656c 2c20 636f 6d62  cted(label, comb
+0000f3f0: 696e 6529 3a0a 2020 2020 2020 2020 2020  ine):.          
+0000f400: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
+0000f410: 2020 2020 2020 2020 2020 2027 6163 7469             'acti
+0000f420: 6f6e 273a 2027 6164 6427 2c0a 2020 2020  on': 'add',.    
+0000f430: 2020 2020 2020 2020 2020 2020 2763 6f6d              'com
+0000f440: 6269 6e65 273a 2063 6f6d 6269 6e65 2c0a  bine': combine,.
+0000f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f460: 276c 6162 656c 273a 206c 6162 656c 2c0a  'label': label,.
+0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f480: 2766 6f72 6d61 7427 3a20 2779 616d 6c27  'format': 'yaml'
+0000f490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f4a0: 2020 276c 6179 6572 273a 206c 6179 6572    'layer': layer
+0000f4b0: 5f79 616d 6c2c 0a20 2020 2020 2020 2020  _yaml,.         
+0000f4c0: 2020 207d 0a0a 2020 2020 2020 2020 7365     }..        se
+0000f4d0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0000f4e0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+0000f4f0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0000f500: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+0000f510: 2f6c 6179 6572 7327 2c20 4e6f 6e65 2c20  /layers', None, 
+0000f520: 6275 696c 645f 6578 7065 6374 6564 2827  build_expected('
+0000f530: 6127 2c20 4661 6c73 6529 292c 0a20 2020  a', False)),.   
+0000f540: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
+0000f550: 2c20 272f 7631 2f6c 6179 6572 7327 2c20  , '/v1/layers', 
+0000f560: 4e6f 6e65 2c20 6275 696c 645f 6578 7065  None, build_expe
+0000f570: 6374 6564 2827 6227 2c20 4661 6c73 6529  cted('b', False)
+0000f580: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0000f590: 2750 4f53 5427 2c20 272f 7631 2f6c 6179  'POST', '/v1/lay
+0000f5a0: 6572 7327 2c20 4e6f 6e65 2c20 6275 696c  ers', None, buil
+0000f5b0: 645f 6578 7065 6374 6564 2827 6327 2c20  d_expected('c', 
+0000f5c0: 4661 6c73 6529 292c 0a20 2020 2020 2020  False)),.       
+0000f5d0: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
+0000f5e0: 7631 2f6c 6179 6572 7327 2c20 4e6f 6e65  v1/layers', None
+0000f5f0: 2c20 6275 696c 645f 6578 7065 6374 6564  , build_expected
+0000f600: 2827 6427 2c20 5472 7565 2929 2c0a 2020  ('d', True)),.  
+0000f610: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+0000f620: 6620 7465 7374 5f61 6464 5f6c 6179 6572  f test_add_layer
+0000f630: 5f69 6e76 616c 6964 5f74 7970 6528 7365  _invalid_type(se
+0000f640: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
+0000f650: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000f660: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
+0000f670: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000f680: 2e63 6c69 656e 742e 6164 645f 6c61 7965  .client.add_laye
+0000f690: 7228 2766 6f6f 272c 2034 3229 0a20 2020  r('foo', 42).   
+0000f6a0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000f6b0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+0000f6c0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0000f6d0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0000f6e0: 6164 645f 6c61 7965 7228 3432 2c20 2766  add_layer(42, 'f
+0000f6f0: 6f6f 2729 0a0a 2020 2020 2020 2020 2320  oo')..        # 
+0000f700: 636f 6d62 696e 6520 6973 2061 206b 6579  combine is a key
+0000f710: 776f 7264 2d6f 6e6c 7920 6172 6720 2873  word-only arg (s
+0000f720: 686f 756c 6420 6265 2063 6f6d 6269 6e65  hould be combine
+0000f730: 3d54 7275 6529 0a20 2020 2020 2020 2077  =True).        w
+0000f740: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000f750: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+0000f760: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000f770: 6c66 2e63 6c69 656e 742e 6164 645f 6c61  lf.client.add_la
+0000f780: 7965 7228 2766 6f6f 272c 207b 7d2c 2054  yer('foo', {}, T
+0000f790: 7275 6529 0a0a 2020 2020 6465 6620 7465  rue)..    def te
+0000f7a0: 7374 5f67 6574 5f70 6c61 6e28 7365 6c66  st_get_plan(self
+0000f7b0: 293a 0a20 2020 2020 2020 2070 6c61 6e5f  ):.        plan_
+0000f7c0: 7961 6d6c 203d 2022 2222 0a73 6572 7669  yaml = """.servi
+0000f7d0: 6365 733a 0a20 2066 6f6f 3a0a 2020 2020  ces:.  foo:.    
+0000f7e0: 636f 6d6d 616e 643a 2065 6368 6f20 6261  command: echo ba
+0000f7f0: 720a 2020 2020 6f76 6572 7269 6465 3a20  r.    override: 
+0000f800: 7265 706c 6163 650a 2222 225b 313a 5d0a  replace."""[1:].
+0000f810: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0000f820: 656e 742e 7265 7370 6f6e 7365 732e 6170  ent.responses.ap
+0000f830: 7065 6e64 287b 0a20 2020 2020 2020 2020  pend({.         
+0000f840: 2020 2022 7265 7375 6c74 223a 2070 6c61     "result": pla
+0000f850: 6e5f 7961 6d6c 2c0a 2020 2020 2020 2020  n_yaml,.        
+0000f860: 2020 2020 2273 7461 7475 7322 3a20 224f      "status": "O
+0000f870: 4b22 2c0a 2020 2020 2020 2020 2020 2020  K",.            
+0000f880: 2273 7461 7475 732d 636f 6465 223a 2032  "status-code": 2
+0000f890: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+0000f8a0: 2274 7970 6522 3a20 2273 796e 6322 0a20  "type": "sync". 
+0000f8b0: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
+0000f8c0: 2020 706c 616e 203d 2073 656c 662e 636c    plan = self.cl
+0000f8d0: 6965 6e74 2e67 6574 5f70 6c61 6e28 290a  ient.get_plan().
+0000f8e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0000f8f0: 6572 7445 7175 616c 2870 6c61 6e2e 746f  ertEqual(plan.to
+0000f900: 5f79 616d 6c28 292c 2070 6c61 6e5f 7961  _yaml(), plan_ya
+0000f910: 6d6c 290a 2020 2020 2020 2020 7365 6c66  ml).        self
+0000f920: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+0000f930: 2870 6c61 6e2e 7365 7276 6963 6573 292c  (plan.services),
+0000f940: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
+0000f950: 2e61 7373 6572 7445 7175 616c 2870 6c61  .assertEqual(pla
+0000f960: 6e2e 7365 7276 6963 6573 5b27 666f 6f27  n.services['foo'
+0000f970: 5d2e 636f 6d6d 616e 642c 2027 6563 686f  ].command, 'echo
+0000f980: 2062 6172 2729 0a20 2020 2020 2020 2073   bar').        s
+0000f990: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000f9a0: 706c 616e 2e73 6572 7669 6365 735b 2766  plan.services['f
+0000f9b0: 6f6f 275d 2e6f 7665 7272 6964 652c 2027  oo'].override, '
+0000f9c0: 7265 706c 6163 6527 290a 0a20 2020 2020  replace')..     
+0000f9d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000f9e0: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
+0000f9f0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
+0000fa00: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
+0000fa10: 272f 7631 2f70 6c61 6e27 2c20 7b27 666f  '/v1/plan', {'fo
+0000fa20: 726d 6174 273a 2027 7961 6d6c 277d 2c20  rmat': 'yaml'}, 
+0000fa30: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
+0000fa40: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000fa50: 6765 745f 7365 7276 6963 6573 5f61 6c6c  get_services_all
+0000fa60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000fa70: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
+0000fa80: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
+0000fa90: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
+0000faa0: 6c74 223a 205b 0a20 2020 2020 2020 2020  lt": [.         
+0000fab0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0000fac0: 2020 2020 2020 2020 2020 2020 2022 6375               "cu
+0000fad0: 7272 656e 7422 3a20 2269 6e61 6374 6976  rrent": "inactiv
+0000fae0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000faf0: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+0000fb00: 2273 7663 3122 2c0a 2020 2020 2020 2020  "svc1",.        
+0000fb10: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000fb20: 7274 7570 223a 2022 6469 7361 626c 6564  rtup": "disabled
+0000fb30: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000fb40: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0000fb50: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0000fb60: 2020 2020 2020 2020 2020 2022 6375 7272             "curr
+0000fb70: 656e 7422 3a20 2261 6374 6976 6522 2c0a  ent": "active",.
+0000fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb90: 2020 2020 226e 616d 6522 3a20 2273 7663      "name": "svc
+0000fba0: 3222 2c0a 2020 2020 2020 2020 2020 2020  2",.            
+0000fbb0: 2020 2020 2020 2020 2273 7461 7274 7570          "startup
+0000fbc0: 223a 2022 656e 6162 6c65 6422 0a20 2020  ": "enabled".   
+0000fbd0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0000fbe0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+0000fbf0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+0000fc00: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+0000fc10: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
+0000fc20: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
+0000fc30: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
+0000fc40: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
+0000fc50: 2020 2020 2020 2020 7365 7276 6963 6573          services
+0000fc60: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
+0000fc70: 6574 5f73 6572 7669 6365 7328 290a 2020  et_services().  
+0000fc80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000fc90: 7445 7175 616c 286c 656e 2873 6572 7669  tEqual(len(servi
+0000fca0: 6365 7329 2c20 3229 0a20 2020 2020 2020  ces), 2).       
+0000fcb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000fcc0: 6c28 7365 7276 6963 6573 5b30 5d2e 6e61  l(services[0].na
+0000fcd0: 6d65 2c20 2773 7663 3127 290a 2020 2020  me, 'svc1').    
+0000fce0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000fcf0: 7175 616c 2873 6572 7669 6365 735b 305d  qual(services[0]
+0000fd00: 2e73 7461 7274 7570 2c20 7065 6262 6c65  .startup, pebble
+0000fd10: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
+0000fd20: 4449 5341 424c 4544 290a 2020 2020 2020  DISABLED).      
+0000fd30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000fd40: 616c 2873 6572 7669 6365 735b 305d 2e63  al(services[0].c
+0000fd50: 7572 7265 6e74 2c20 7065 6262 6c65 2e53  urrent, pebble.S
+0000fd60: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
+0000fd70: 4354 4956 4529 0a20 2020 2020 2020 2073  CTIVE).        s
+0000fd80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000fd90: 7365 7276 6963 6573 5b31 5d2e 6e61 6d65  services[1].name
+0000fda0: 2c20 2773 7663 3227 290a 2020 2020 2020  , 'svc2').      
+0000fdb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000fdc0: 616c 2873 6572 7669 6365 735b 315d 2e73  al(services[1].s
+0000fdd0: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
+0000fde0: 6572 7669 6365 5374 6172 7475 702e 454e  erviceStartup.EN
+0000fdf0: 4142 4c45 4429 0a20 2020 2020 2020 2073  ABLED).        s
+0000fe00: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000fe10: 7365 7276 6963 6573 5b31 5d2e 6375 7272  services[1].curr
+0000fe20: 656e 742c 2070 6562 626c 652e 5365 7276  ent, pebble.Serv
+0000fe30: 6963 6553 7461 7475 732e 4143 5449 5645  iceStatus.ACTIVE
+0000fe40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000fe50: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0000fe60: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
+0000fe70: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0000fe80: 2827 4745 5427 2c20 272f 7631 2f73 6572  ('GET', '/v1/ser
+0000fe90: 7669 6365 7327 2c20 4e6f 6e65 2c20 4e6f  vices', None, No
+0000fea0: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+0000feb0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
+0000fec0: 745f 7365 7276 6963 6573 5f6e 616d 6573  t_services_names
+0000fed0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000fee0: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
+0000fef0: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
+0000ff00: 2020 2020 2020 2020 2020 2022 7265 7375             "resu
+0000ff10: 6c74 223a 205b 0a20 2020 2020 2020 2020  lt": [.         
+0000ff20: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0000ff30: 2020 2020 2020 2020 2020 2020 2022 6375               "cu
+0000ff40: 7272 656e 7422 3a20 2269 6e61 6374 6976  rrent": "inactiv
+0000ff50: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000ff60: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+0000ff70: 2273 7663 3122 2c0a 2020 2020 2020 2020  "svc1",.        
+0000ff80: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+0000ff90: 7274 7570 223a 2022 6469 7361 626c 6564  rtup": "disabled
+0000ffa0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000ffb0: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0000ffc0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0000ffd0: 2020 2020 2020 2020 2020 2022 6375 7272             "curr
+0000ffe0: 656e 7422 3a20 2261 6374 6976 6522 2c0a  ent": "active",.
+0000fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010000: 2020 2020 226e 616d 6522 3a20 2273 7663      "name": "svc
+00010010: 3222 2c0a 2020 2020 2020 2020 2020 2020  2",.            
+00010020: 2020 2020 2020 2020 2273 7461 7274 7570          "startup
+00010030: 223a 2022 656e 6162 6c65 6422 0a20 2020  ": "enabled".   
+00010040: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00010050: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00010060: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+00010070: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+00010080: 2020 2020 2020 2273 7461 7475 732d 636f        "status-co
+00010090: 6465 223a 2032 3030 2c0a 2020 2020 2020  de": 200,.      
+000100a0: 2020 2020 2020 2274 7970 6522 3a20 2273        "type": "s
+000100b0: 796e 6322 0a20 2020 2020 2020 207d 290a  ync".        }).
+000100c0: 2020 2020 2020 2020 7365 7276 6963 6573          services
+000100d0: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
+000100e0: 6574 5f73 6572 7669 6365 7328 5b27 7376  et_services(['sv
+000100f0: 6331 272c 2027 7376 6332 275d 290a 2020  c1', 'svc2']).  
+00010100: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010110: 7445 7175 616c 286c 656e 2873 6572 7669  tEqual(len(servi
+00010120: 6365 7329 2c20 3229 0a20 2020 2020 2020  ces), 2).       
+00010130: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00010140: 6c28 7365 7276 6963 6573 5b30 5d2e 6e61  l(services[0].na
+00010150: 6d65 2c20 2773 7663 3127 290a 2020 2020  me, 'svc1').    
+00010160: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00010170: 7175 616c 2873 6572 7669 6365 735b 305d  qual(services[0]
+00010180: 2e73 7461 7274 7570 2c20 7065 6262 6c65  .startup, pebble
+00010190: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
+000101a0: 4449 5341 424c 4544 290a 2020 2020 2020  DISABLED).      
+000101b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000101c0: 616c 2873 6572 7669 6365 735b 305d 2e63  al(services[0].c
+000101d0: 7572 7265 6e74 2c20 7065 6262 6c65 2e53  urrent, pebble.S
+000101e0: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
+000101f0: 4354 4956 4529 0a20 2020 2020 2020 2073  CTIVE).        s
+00010200: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010210: 7365 7276 6963 6573 5b31 5d2e 6e61 6d65  services[1].name
+00010220: 2c20 2773 7663 3227 290a 2020 2020 2020  , 'svc2').      
+00010230: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00010240: 616c 2873 6572 7669 6365 735b 315d 2e73  al(services[1].s
+00010250: 7461 7274 7570 2c20 7065 6262 6c65 2e53  tartup, pebble.S
+00010260: 6572 7669 6365 5374 6172 7475 702e 454e  erviceStartup.EN
+00010270: 4142 4c45 4429 0a20 2020 2020 2020 2073  ABLED).        s
+00010280: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00010290: 7365 7276 6963 6573 5b31 5d2e 6375 7272  services[1].curr
+000102a0: 656e 742c 2070 6562 626c 652e 5365 7276  ent, pebble.Serv
+000102b0: 6963 6553 7461 7475 732e 4143 5449 5645  iceStatus.ACTIVE
+000102c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000102d0: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
+000102e0: 2e61 7070 656e 6428 7b0a 2020 2020 2020  .append({.      
+000102f0: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
+00010300: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00010310: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00010320: 2020 2020 2020 2020 2263 7572 7265 6e74          "current
+00010330: 223a 2022 6163 7469 7665 222c 0a20 2020  ": "active",.   
+00010340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010350: 2022 6e61 6d65 223a 2022 7376 6332 222c   "name": "svc2",
+00010360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010370: 2020 2020 2022 7374 6172 7475 7022 3a20       "startup": 
+00010380: 2265 6e61 626c 6564 220a 2020 2020 2020  "enabled".      
+00010390: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000103a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000103b0: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
+000103c0: 2022 4f4b 222c 0a20 2020 2020 2020 2020   "OK",.         
+000103d0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
+000103e0: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
+000103f0: 2020 2022 7479 7065 223a 2022 7379 6e63     "type": "sync
+00010400: 220a 2020 2020 2020 2020 7d29 0a20 2020  ".        }).   
+00010410: 2020 2020 2073 6572 7669 6365 7320 3d20       services = 
+00010420: 7365 6c66 2e63 6c69 656e 742e 6765 745f  self.client.get_
+00010430: 7365 7276 6963 6573 285b 2773 7663 3227  services(['svc2'
+00010440: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00010450: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+00010460: 7365 7276 6963 6573 292c 2031 290a 2020  services), 1).  
+00010470: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010480: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+00010490: 305d 2e6e 616d 652c 2027 7376 6332 2729  0].name, 'svc2')
+000104a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000104b0: 7365 7274 4571 7561 6c28 7365 7276 6963  sertEqual(servic
+000104c0: 6573 5b30 5d2e 7374 6172 7475 702c 2070  es[0].startup, p
+000104d0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+000104e0: 7274 7570 2e45 4e41 424c 4544 290a 2020  rtup.ENABLED).  
+000104f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00010500: 7445 7175 616c 2873 6572 7669 6365 735b  tEqual(services[
+00010510: 305d 2e63 7572 7265 6e74 2c20 7065 6262  0].current, pebb
+00010520: 6c65 2e53 6572 7669 6365 5374 6174 7573  le.ServiceStatus
+00010530: 2e41 4354 4956 4529 0a0a 2020 2020 2020  .ACTIVE)..      
+00010540: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00010550: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+00010560: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+00010570: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+00010580: 2f76 312f 7365 7276 6963 6573 272c 207b  /v1/services', {
+00010590: 276e 616d 6573 273a 2027 7376 6331 2c73  'names': 'svc1,s
+000105a0: 7663 3227 7d2c 204e 6f6e 6529 2c0a 2020  vc2'}, None),.  
+000105b0: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+000105c0: 2c20 272f 7631 2f73 6572 7669 6365 7327  , '/v1/services'
+000105d0: 2c20 7b27 6e61 6d65 7327 3a20 2773 7663  , {'names': 'svc
+000105e0: 3227 7d2c 204e 6f6e 6529 2c0a 2020 2020  2'}, None),.    
+000105f0: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+00010600: 7465 7374 5f70 756c 6c5f 626f 756e 6461  test_pull_bounda
+00010610: 7279 5f73 7061 6e6e 696e 675f 6368 756e  ry_spanning_chun
+00010620: 6b28 7365 6c66 293a 0a20 2020 2020 2020  k(self):.       
+00010630: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
+00010640: 706f 6e73 6573 2e61 7070 656e 6428 280a  ponses.append((.
+00010650: 2020 2020 2020 2020 2020 2020 7b27 436f              {'Co
+00010660: 6e74 656e 742d 5479 7065 273a 2027 6d75  ntent-Type': 'mu
+00010670: 6c74 6970 6172 742f 666f 726d 2d64 6174  ltipart/form-dat
+00010680: 613b 2062 6f75 6e64 6172 793d 3031 3233  a; boundary=0123
+00010690: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
+000106a0: 3031 3233 3435 3637 3839 3031 277d 2c0a  012345678901'},.
+000106b0: 2020 2020 2020 2020 2020 2020 6222 2222              b"""
+000106c0: 5c0a 2d2d 3031 3233 3435 3637 3839 3031  \.--012345678901
+000106d0: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
+000106e0: 3839 3031 5c72 0a43 6f6e 7465 6e74 2d44  8901\r.Content-D
+000106f0: 6973 706f 7369 7469 6f6e 3a20 666f 726d  isposition: form
+00010700: 2d64 6174 613b 206e 616d 653d 2266 696c  -data; name="fil
+00010710: 6573 223b 2066 696c 656e 616d 653d 222f  es"; filename="/
+00010720: 6574 632f 686f 7374 7322 5c72 0a5c 720a  etc/hosts"\r.\r.
+00010730: 3132 372e 302e 302e 3120 6c6f 6361 6c68  127.0.0.1 localh
+00010740: 6f73 7420 2023 205c 7866 305c 7839 665c  ost  # \xf0\x9f\
+00010750: 7839 385c 7838 305c 6e66 6f6f 5c72 5c6e  x98\x80\nfoo\r\n
+00010760: 6261 725c 720a 2d2d 3031 3233 3435 3637  bar\r.--01234567
+00010770: 3839 3031 3233 3435 3637 3839 3031 3233  8901234567890123
+00010780: 3435 3637 3839 3031 5c72 0a43 6f6e 7465  45678901\r.Conte
+00010790: 6e74 2d44 6973 706f 7369 7469 6f6e 3a20  nt-Disposition: 
+000107a0: 666f 726d 2d64 6174 613b 206e 616d 653d  form-data; name=
+000107b0: 2272 6573 706f 6e73 6522 5c72 0a5c 720a  "response"\r.\r.
+000107c0: 7b0a 2020 2020 2272 6573 756c 7422 3a20  {.    "result": 
+000107d0: 5b7b 2270 6174 6822 3a20 222f 6574 632f  [{"path": "/etc/
+000107e0: 686f 7374 7322 7d5d 2c0a 2020 2020 2273  hosts"}],.    "s
+000107f0: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+00010800: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
+00010810: 2032 3030 2c0a 2020 2020 2274 7970 6522   200,.    "type"
+00010820: 3a20 2273 796e 6322 0a7d 5c72 0a2d 2d30  : "sync".}\r.--0
+00010830: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
+00010840: 3738 3930 3132 3334 3536 3738 3930 312d  789012345678901-
+00010850: 2d5c 720a 2222 222c 0a20 2020 2020 2020  -\r.""",.       
+00010860: 2029 290a 0a20 2020 2020 2020 2073 656c   ))..        sel
+00010870: 662e 636c 6965 6e74 2e5f 6368 756e 6b5f  f.client._chunk_
+00010880: 7369 7a65 203d 2031 330a 2020 2020 2020  size = 13.      
+00010890: 2020 7769 7468 2073 656c 662e 636c 6965    with self.clie
+000108a0: 6e74 2e70 756c 6c28 272f 6574 632f 686f  nt.pull('/etc/ho
+000108b0: 7374 7327 2920 6173 2069 6e66 696c 653a  sts') as infile:
+000108c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000108d0: 7465 6e74 203d 2069 6e66 696c 652e 7265  tent = infile.re
+000108e0: 6164 2829 0a20 2020 2020 2020 2073 656c  ad().        sel
+000108f0: 662e 6173 7365 7274 4571 7561 6c28 636f  f.assertEqual(co
+00010900: 6e74 656e 742c 2027 3132 372e 302e 302e  ntent, '127.0.0.
+00010910: 3120 6c6f 6361 6c68 6f73 7420 2023 20f0  1 localhost  # .
+00010920: 9f98 805c 6e66 6f6f 5c72 5c6e 6261 7227  ...\nfoo\r\nbar'
+00010930: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00010940: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+00010950: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
+00010960: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00010970: 2827 4745 5427 2c20 272f 7631 2f66 696c  ('GET', '/v1/fil
+00010980: 6573 272c 207b 2761 6374 696f 6e27 3a20  es', {'action': 
+00010990: 2772 6561 6427 2c20 2770 6174 6827 3a20  'read', 'path': 
+000109a0: 272f 6574 632f 686f 7374 7327 7d2c 0a20  '/etc/hosts'},. 
+000109b0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+000109c0: 2741 6363 6570 7427 3a20 276d 756c 7469  'Accept': 'multi
+000109d0: 7061 7274 2f66 6f72 6d2d 6461 7461 277d  part/form-data'}
+000109e0: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+000109f0: 205d 290a 0a20 2020 2064 6566 2074 6573   ])..    def tes
+00010a00: 745f 7075 6c6c 5f74 6578 7428 7365 6c66  t_pull_text(self
+00010a10: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00010a20: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
+00010a30: 2e61 7070 656e 6428 280a 2020 2020 2020  .append((.      
+00010a40: 2020 2020 2020 7b27 436f 6e74 656e 742d        {'Content-
+00010a50: 5479 7065 273a 2027 6d75 6c74 6970 6172  Type': 'multipar
+00010a60: 742f 666f 726d 2d64 6174 613b 2062 6f75  t/form-data; bou
+00010a70: 6e64 6172 793d 3031 3233 3435 3637 3839  ndary=0123456789
+00010a80: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+00010a90: 3637 3839 3031 277d 2c0a 2020 2020 2020  678901'},.      
+00010aa0: 2020 2020 2020 6222 2222 5c0a 2d2d 3031        b"""\.--01
+00010ab0: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
+00010ac0: 3839 3031 3233 3435 3637 3839 3031 5c72  89012345678901\r
+00010ad0: 0a43 6f6e 7465 6e74 2d44 6973 706f 7369  .Content-Disposi
+00010ae0: 7469 6f6e 3a20 666f 726d 2d64 6174 613b  tion: form-data;
+00010af0: 206e 616d 653d 2266 696c 6573 223b 2066   name="files"; f
+00010b00: 696c 656e 616d 653d 222f 6574 632f 686f  ilename="/etc/ho
+00010b10: 7374 7322 5c72 0a5c 720a 3132 372e 302e  sts"\r.\r.127.0.
+00010b20: 302e 3120 6c6f 6361 6c68 6f73 7420 2023  0.1 localhost  #
+00010b30: 205c 7866 305c 7839 665c 7839 385c 7838   \xf0\x9f\x98\x8
+00010b40: 305c 6e66 6f6f 5c72 5c6e 6261 725c 720a  0\nfoo\r\nbar\r.
+00010b50: 2d2d 3031 3233 3435 3637 3839 3031 3233  --01234567890123
+00010b60: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
+00010b70: 3031 5c72 0a43 6f6e 7465 6e74 2d44 6973  01\r.Content-Dis
+00010b80: 706f 7369 7469 6f6e 3a20 666f 726d 2d64  position: form-d
+00010b90: 6174 613b 206e 616d 653d 2272 6573 706f  ata; name="respo
+00010ba0: 6e73 6522 5c72 0a5c 720a 7b0a 2020 2020  nse"\r.\r.{.    
+00010bb0: 2272 6573 756c 7422 3a20 5b7b 2270 6174  "result": [{"pat
+00010bc0: 6822 3a20 222f 6574 632f 686f 7374 7322  h": "/etc/hosts"
+00010bd0: 7d5d 2c0a 2020 2020 2273 7461 7475 7322  }],.    "status"
+00010be0: 3a20 224f 4b22 2c0a 2020 2020 2273 7461  : "OK",.    "sta
+00010bf0: 7475 732d 636f 6465 223a 2032 3030 2c0a  tus-code": 200,.
+00010c00: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
+00010c10: 6322 0a7d 5c72 0a2d 2d30 3132 3334 3536  c".}\r.--0123456
+00010c20: 3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012
+00010c30: 3334 3536 3738 3930 312d 2d5c 720a 2222  345678901--\r.""
+00010c40: 222c 0a20 2020 2020 2020 2029 290a 0a20  ",.        )).. 
+00010c50: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00010c60: 2e63 6c69 656e 742e 7075 6c6c 2827 2f65  .client.pull('/e
+00010c70: 7463 2f68 6f73 7473 2729 2061 7320 696e  tc/hosts') as in
+00010c80: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+00010c90: 2020 636f 6e74 656e 7420 3d20 696e 6669    content = infi
+00010ca0: 6c65 2e72 6561 6428 290a 2020 2020 2020  le.read().      
+00010cb0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00010cc0: 616c 2863 6f6e 7465 6e74 2c20 2731 3237  al(content, '127
+00010cd0: 2e30 2e30 2e31 206c 6f63 616c 686f 7374  .0.0.1 localhost
+00010ce0: 2020 2320 f09f 9880 5c6e 666f 6f5c 725c    # ....\nfoo\r\
+00010cf0: 6e62 6172 2729 0a0a 2020 2020 2020 2020  nbar')..        
+00010d00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00010d10: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+00010d20: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+00010d30: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
+00010d40: 312f 6669 6c65 7327 2c20 7b27 6163 7469  1/files', {'acti
+00010d50: 6f6e 273a 2027 7265 6164 272c 2027 7061  on': 'read', 'pa
+00010d60: 7468 273a 2027 2f65 7463 2f68 6f73 7473  th': '/etc/hosts
+00010d70: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00010d80: 2020 2020 7b27 4163 6365 7074 273a 2027      {'Accept': '
+00010d90: 6d75 6c74 6970 6172 742f 666f 726d 2d64  multipart/form-d
+00010da0: 6174 6127 7d2c 204e 6f6e 6529 2c0a 2020  ata'}, None),.  
+00010db0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
+00010dc0: 6620 7465 7374 5f70 756c 6c5f 6269 6e61  f test_pull_bina
+00010dd0: 7279 2873 656c 6629 3a0a 2020 2020 2020  ry(self):.      
+00010de0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+00010df0: 7370 6f6e 7365 732e 6170 7065 6e64 2828  sponses.append((
+00010e00: 0a20 2020 2020 2020 2020 2020 207b 2743  .            {'C
+00010e10: 6f6e 7465 6e74 2d54 7970 6527 3a20 276d  ontent-Type': 'm
+00010e20: 756c 7469 7061 7274 2f66 6f72 6d2d 6461  ultipart/form-da
+00010e30: 7461 3b20 626f 756e 6461 7279 3d30 3132  ta; boundary=012
+00010e40: 3334 3536 3738 3930 3132 3334 3536 3738  3456789012345678
+00010e50: 3930 3132 3334 3536 3738 3930 3127 7d2c  9012345678901'},
+00010e60: 0a20 2020 2020 2020 2020 2020 2062 2222  .            b""
+00010e70: 225c 0a2d 2d30 3132 3334 3536 3738 3930  "\.--01234567890
+00010e80: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
+00010e90: 3738 3930 315c 720a 436f 6e74 656e 742d  78901\r.Content-
+00010ea0: 4469 7370 6f73 6974 696f 6e3a 2066 6f72  Disposition: for
+00010eb0: 6d2d 6461 7461 3b20 6e61 6d65 3d22 6669  m-data; name="fi
+00010ec0: 6c65 7322 3b20 6669 6c65 6e61 6d65 3d22  les"; filename="
+00010ed0: 2f65 7463 2f68 6f73 7473 225c 720a 5c72  /etc/hosts"\r.\r
+00010ee0: 0a31 3237 2e30 2e30 2e31 206c 6f63 616c  .127.0.0.1 local
+00010ef0: 686f 7374 2020 2320 5c78 6630 5c78 3966  host  # \xf0\x9f
+00010f00: 5c78 3938 5c78 3830 5c6e 666f 6f5c 725c  \x98\x80\nfoo\r\
+00010f10: 6e62 6172 5c72 0a2d 2d30 3132 3334 3536  nbar\r.--0123456
+00010f20: 3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012
+00010f30: 3334 3536 3738 3930 315c 720a 436f 6e74  345678901\r.Cont
+00010f40: 656e 742d 4469 7370 6f73 6974 696f 6e3a  ent-Disposition:
+00010f50: 2066 6f72 6d2d 6461 7461 3b20 6e61 6d65   form-data; name
+00010f60: 3d22 7265 7370 6f6e 7365 225c 720a 5c72  ="response"\r.\r
+00010f70: 0a7b 0a20 2020 2022 7265 7375 6c74 223a  .{.    "result":
+00010f80: 205b 7b22 7061 7468 223a 2022 2f65 7463   [{"path": "/etc
+00010f90: 2f68 6f73 7473 227d 5d2c 0a20 2020 2022  /hosts"}],.    "
+00010fa0: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
+00010fb0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
+00010fc0: 3a20 3230 302c 0a20 2020 2022 7479 7065  : 200,.    "type
+00010fd0: 223a 2022 7379 6e63 220a 7d5c 720a 2d2d  ": "sync".}\r.--
+00010fe0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+00010ff0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
+00011000: 2d2d 5c72 0a22 2222 2c0a 2020 2020 2020  --\r.""",.      
+00011010: 2020 2929 0a0a 2020 2020 2020 2020 7769    ))..        wi
+00011020: 7468 2073 656c 662e 636c 6965 6e74 2e70  th self.client.p
+00011030: 756c 6c28 272f 6574 632f 686f 7374 7327  ull('/etc/hosts'
+00011040: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
+00011050: 2061 7320 696e 6669 6c65 3a0a 2020 2020   as infile:.    
+00011060: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
+00011070: 3d20 696e 6669 6c65 2e72 6561 6428 290a  = infile.read().
+00011080: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00011090: 6572 7445 7175 616c 2863 6f6e 7465 6e74  ertEqual(content
+000110a0: 2c20 6227 3132 372e 302e 302e 3120 6c6f  , b'127.0.0.1 lo
+000110b0: 6361 6c68 6f73 7420 2023 205c 7866 305c  calhost  # \xf0\
+000110c0: 7839 665c 7839 385c 7838 305c 6e66 6f6f  x9f\x98\x80\nfoo
+000110d0: 5c72 5c6e 6261 7227 290a 0a20 2020 2020  \r\nbar')..     
+000110e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000110f0: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
+00011100: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
+00011110: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
+00011120: 272f 7631 2f66 696c 6573 272c 207b 2761  '/v1/files', {'a
+00011130: 6374 696f 6e27 3a20 2772 6561 6427 2c20  ction': 'read', 
+00011140: 2770 6174 6827 3a20 272f 6574 632f 686f  'path': '/etc/ho
+00011150: 7374 7327 7d2c 0a20 2020 2020 2020 2020  sts'},.         
+00011160: 2020 2020 2020 207b 2741 6363 6570 7427         {'Accept'
+00011170: 3a20 276d 756c 7469 7061 7274 2f66 6f72  : 'multipart/for
+00011180: 6d2d 6461 7461 277d 2c20 4e6f 6e65 292c  m-data'}, None),
+00011190: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+000111a0: 2064 6566 2074 6573 745f 7075 6c6c 5f70   def test_pull_p
+000111b0: 6174 685f 6572 726f 7228 7365 6c66 293a  ath_error(self):
+000111c0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+000111d0: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+000111e0: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
+000111f0: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
+00011200: 7065 273a 2027 6d75 6c74 6970 6172 742f  pe': 'multipart/
+00011210: 666f 726d 2d64 6174 613b 2062 6f75 6e64  form-data; bound
+00011220: 6172 793d 3031 3233 3435 3637 3839 3031  ary=012345678901
+00011230: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
+00011240: 3839 3031 277d 2c0a 2020 2020 2020 2020  8901'},.        
+00011250: 2020 2020 6222 2222 5c0a 2d2d 3031 3233      b"""\.--0123
+00011260: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
+00011270: 3031 3233 3435 3637 3839 3031 5c72 0a43  012345678901\r.C
+00011280: 6f6e 7465 6e74 2d44 6973 706f 7369 7469  ontent-Dispositi
+00011290: 6f6e 3a20 666f 726d 2d64 6174 613b 206e  on: form-data; n
+000112a0: 616d 653d 2272 6573 706f 6e73 6522 5c72  ame="response"\r
+000112b0: 0a5c 720a 7b0a 2020 2020 2272 6573 756c  .\r.{.    "resul
+000112c0: 7422 3a20 5b0a 2020 2020 2020 2020 7b22  t": [.        {"
+000112d0: 7061 7468 223a 2022 2f65 7463 2f68 6f73  path": "/etc/hos
+000112e0: 7473 222c 2022 6572 726f 7222 3a20 7b22  ts", "error": {"
+000112f0: 6b69 6e64 223a 2022 6e6f 742d 666f 756e  kind": "not-foun
+00011300: 6422 2c20 226d 6573 7361 6765 223a 2022  d", "message": "
+00011310: 6e6f 7420 666f 756e 6422 7d7d 0a20 2020  not found"}}.   
+00011320: 205d 2c0a 2020 2020 2273 7461 7475 7322   ],.    "status"
+00011330: 3a20 224f 4b22 2c0a 2020 2020 2273 7461  : "OK",.    "sta
+00011340: 7475 732d 636f 6465 223a 2032 3030 2c0a  tus-code": 200,.
+00011350: 2020 2020 2274 7970 6522 3a20 2273 796e      "type": "syn
+00011360: 6322 0a7d 5c72 0a2d 2d30 3132 3334 3536  c".}\r.--0123456
+00011370: 3738 3930 3132 3334 3536 3738 3930 3132  7890123456789012
+00011380: 3334 3536 3738 3930 312d 2d5c 720a 2222  345678901--\r.""
+00011390: 222c 0a20 2020 2020 2020 2029 290a 0a20  ",.        )).. 
+000113a0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000113b0: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+000113c0: 6262 6c65 2e50 6174 6845 7272 6f72 2920  bble.PathError) 
+000113d0: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+000113e0: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
+000113f0: 756c 6c28 272f 6574 632f 686f 7374 7327  ull('/etc/hosts'
+00011400: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00011410: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+00011420: 636d 2e65 7863 6570 7469 6f6e 2c20 7065  cm.exception, pe
+00011430: 6262 6c65 2e45 7272 6f72 290a 2020 2020  bble.Error).    
+00011440: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00011450: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+00011460: 6e2e 6b69 6e64 2c20 276e 6f74 2d66 6f75  n.kind, 'not-fou
+00011470: 6e64 2729 0a20 2020 2020 2020 2073 656c  nd').        sel
+00011480: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
+00011490: 2e65 7863 6570 7469 6f6e 2e6d 6573 7361  .exception.messa
+000114a0: 6765 2c20 276e 6f74 2066 6f75 6e64 2729  ge, 'not found')
+000114b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+000114c0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+000114d0: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+000114e0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+000114f0: 2747 4554 272c 2027 2f76 312f 6669 6c65  'GET', '/v1/file
+00011500: 7327 2c20 7b27 6163 7469 6f6e 273a 2027  s', {'action': '
+00011510: 7265 6164 272c 2027 7061 7468 273a 2027  read', 'path': '
+00011520: 2f65 7463 2f68 6f73 7473 277d 2c0a 2020  /etc/hosts'},.  
+00011530: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+00011540: 4163 6365 7074 273a 2027 6d75 6c74 6970  Accept': 'multip
+00011550: 6172 742f 666f 726d 2d64 6174 6127 7d2c  art/form-data'},
+00011560: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+00011570: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+00011580: 5f70 756c 6c5f 7072 6f74 6f63 6f6c 5f65  _pull_protocol_e
+00011590: 7272 6f72 7328 7365 6c66 293a 0a20 2020  rrors(self):.   
+000115a0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+000115b0: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+000115c0: 6428 287b 2743 6f6e 7465 6e74 2d54 7970  d(({'Content-Typ
+000115d0: 6527 3a20 2763 7427 7d2c 2062 2727 2929  e': 'ct'}, b''))
+000115e0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+000115f0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00011600: 7065 6262 6c65 2e50 726f 746f 636f 6c45  pebble.ProtocolE
+00011610: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
+00011620: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+00011630: 6965 6e74 2e70 756c 6c28 272f 6574 632f  ient.pull('/etc/
+00011640: 686f 7374 7327 290a 2020 2020 2020 2020  hosts').        
+00011650: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+00011660: 7461 6e63 6528 636d 2e65 7863 6570 7469  tance(cm.excepti
+00011670: 6f6e 2c20 7065 6262 6c65 2e45 7272 6f72  on, pebble.Error
+00011680: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00011690: 7373 6572 7445 7175 616c 2873 7472 2863  ssertEqual(str(c
+000116a0: 6d2e 6578 6365 7074 696f 6e29 2c0a 2020  m.exception),.  
+000116b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000116c0: 2020 2020 2020 2022 6578 7065 6374 6564         "expected
+000116d0: 2043 6f6e 7465 6e74 2d54 7970 6520 276d   Content-Type 'm
+000116e0: 756c 7469 7061 7274 2f66 6f72 6d2d 6461  ultipart/form-da
+000116f0: 7461 272c 2067 6f74 2027 6374 2722 290a  ta', got 'ct'").
+00011700: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00011710: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+00011720: 7070 656e 6428 287b 2743 6f6e 7465 6e74  ppend(({'Content
+00011730: 2d54 7970 6527 3a20 276d 756c 7469 7061  -Type': 'multipa
+00011740: 7274 2f66 6f72 6d2d 6461 7461 277d 2c20  rt/form-data'}, 
+00011750: 6227 2729 290a 2020 2020 2020 2020 7769  b'')).        wi
+00011760: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00011770: 6973 6573 2870 6562 626c 652e 5072 6f74  ises(pebble.Prot
+00011780: 6f63 6f6c 4572 726f 7229 2061 7320 636d  ocolError) as cm
+00011790: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000117a0: 6c66 2e63 6c69 656e 742e 7075 6c6c 2827  lf.client.pull('
+000117b0: 2f65 7463 2f68 6f73 7473 2729 0a20 2020  /etc/hosts').   
+000117c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000117d0: 4571 7561 6c28 7374 7228 636d 2e65 7863  Equal(str(cm.exc
+000117e0: 6570 7469 6f6e 292c 2022 696e 7661 6c69  eption), "invali
+000117f0: 6420 626f 756e 6461 7279 2027 2722 290a  d boundary ''").
+00011800: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00011810: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+00011820: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
+00011830: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
+00011840: 7065 273a 2027 6d75 6c74 6970 6172 742f  pe': 'multipart/
+00011850: 666f 726d 2d64 6174 613b 2062 6f75 6e64  form-data; bound
+00011860: 6172 793d 3031 3233 3435 3637 3839 3031  ary=012345678901
+00011870: 3233 3435 3637 3839 3031 3233 3435 3637  2345678901234567
+00011880: 3839 3031 277d 2c0a 2020 2020 2020 2020  8901'},.        
+00011890: 2020 2020 6222 2222 5c0a 2d2d 3031 3233      b"""\.--0123
+000118a0: 3435 3637 3839 3031 3233 3435 3637 3839  4567890123456789
+000118b0: 3031 3233 3435 3637 3839 3031 5c72 0a43  012345678901\r.C
+000118c0: 6f6e 7465 6e74 2d44 6973 706f 7369 7469  ontent-Dispositi
+000118d0: 6f6e 3a20 666f 726d 2d64 6174 613b 206e  on: form-data; n
+000118e0: 616d 653d 2266 696c 6573 223b 2066 696c  ame="files"; fil
+000118f0: 656e 616d 653d 222f 6261 6422 5c72 0a5c  ename="/bad"\r.\
+00011900: 720a 6261 6420 7061 7468 5c72 0a2d 2d30  r.bad path\r.--0
+00011910: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
+00011920: 3738 3930 3132 3334 3536 3738 3930 315c  789012345678901\
+00011930: 720a 436f 6e74 656e 742d 4469 7370 6f73  r.Content-Dispos
+00011940: 6974 696f 6e3a 2066 6f72 6d2d 6461 7461  ition: form-data
+00011950: 3b20 6e61 6d65 3d22 7265 7370 6f6e 7365  ; name="response
+00011960: 225c 720a 5c72 0a7b 0a20 2020 2022 7265  "\r.\r.{.    "re
+00011970: 7375 6c74 223a 205b 7b22 7061 7468 223a  sult": [{"path":
+00011980: 2022 2f65 7463 2f68 6f73 7473 227d 5d2c   "/etc/hosts"}],
+00011990: 0a20 2020 2022 7374 6174 7573 223a 2022  .    "status": "
+000119a0: 4f4b 222c 0a20 2020 2022 7374 6174 7573  OK",.    "status
+000119b0: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
+000119c0: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
+000119d0: 7d5c 720a 2d2d 3031 3233 3435 3637 3839  }\r.--0123456789
+000119e0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+000119f0: 3637 3839 3031 2d2d 5c72 0a22 2222 2c0a  678901--\r.""",.
+00011a00: 2020 2020 2020 2020 2929 0a20 2020 2020          )).     
+00011a10: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00011a20: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
+00011a30: 2e50 726f 746f 636f 6c45 7272 6f72 2920  .ProtocolError) 
+00011a40: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
+00011a50: 2020 2073 656c 662e 636c 6965 6e74 2e70     self.client.p
+00011a60: 756c 6c28 272f 6574 632f 686f 7374 7327  ull('/etc/hosts'
+00011a70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00011a80: 7373 6572 7445 7175 616c 2873 7472 2863  ssertEqual(str(c
+00011a90: 6d2e 6578 6365 7074 696f 6e29 2c20 2270  m.exception), "p
+00011aa0: 6174 6820 6e6f 7420 6578 7065 6374 6564  ath not expected
+00011ab0: 3a20 272f 6261 6427 2229 0a0a 2020 2020  : '/bad'")..    
+00011ac0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+00011ad0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+00011ae0: 2828 0a20 2020 2020 2020 2020 2020 207b  ((.            {
+00011af0: 2743 6f6e 7465 6e74 2d54 7970 6527 3a20  'Content-Type': 
+00011b00: 276d 756c 7469 7061 7274 2f66 6f72 6d2d  'multipart/form-
+00011b10: 6461 7461 3b20 626f 756e 6461 7279 3d30  data; boundary=0
+00011b20: 3132 3334 3536 3738 3930 3132 3334 3536  1234567890123456
+00011b30: 3738 3930 3132 3334 3536 3738 3930 3127  789012345678901'
+00011b40: 7d2c 0a20 2020 2020 2020 2020 2020 2062  },.            b
+00011b50: 2222 225c 0a2d 2d30 3132 3334 3536 3738  """\.--012345678
+00011b60: 3930 3132 3334 3536 3738 3930 3132 3334  9012345678901234
+00011b70: 3536 3738 3930 315c 720a 436f 6e74 656e  5678901\r.Conten
+00011b80: 742d 4469 7370 6f73 6974 696f 6e3a 2066  t-Disposition: f
+00011b90: 6f72 6d2d 6461 7461 3b20 6e61 6d65 3d22  orm-data; name="
+00011ba0: 6669 6c65 7322 3b20 6669 6c65 6e61 6d65  files"; filename
+00011bb0: 3d22 2f65 7463 2f68 6f73 7473 225c 720a  ="/etc/hosts"\r.
+00011bc0: 5c72 0a62 6164 2070 6174 685c 720a 2d2d  \r.bad path\r.--
+00011bd0: 3031 3233 3435 3637 3839 3031 3233 3435  0123456789012345
+00011be0: 3637 3839 3031 3233 3435 3637 3839 3031  6789012345678901
+00011bf0: 2d2d 5c72 0a22 2222 2c0a 2020 2020 2020  --\r.""",.      
+00011c00: 2020 2929 0a20 2020 2020 2020 2077 6974    )).        wit
+00011c10: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00011c20: 7365 7328 7065 6262 6c65 2e50 726f 746f  ses(pebble.Proto
+00011c30: 636f 6c45 7272 6f72 2920 6173 2063 6d3a  colError) as cm:
+00011c40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011c50: 662e 636c 6965 6e74 2e70 756c 6c28 272f  f.client.pull('/
+00011c60: 6574 632f 686f 7374 7327 290a 2020 2020  etc/hosts').    
+00011c70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00011c80: 7175 616c 2873 7472 2863 6d2e 6578 6365  qual(str(cm.exce
+00011c90: 7074 696f 6e29 2c20 276e 6f20 2272 6573  ption), 'no "res
+00011ca0: 706f 6e73 6522 2066 6965 6c64 2069 6e20  ponse" field in 
+00011cb0: 6d75 6c74 6970 6172 7420 626f 6479 2729  multipart body')
+00011cc0: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
+00011cd0: 7573 685f 7374 7228 7365 6c66 293a 0a20  ush_str(self):. 
+00011ce0: 2020 2020 2020 2073 656c 662e 5f74 6573         self._tes
+00011cf0: 745f 7075 7368 5f73 7472 2827 636f 6e74  t_push_str('cont
+00011d00: 656e 7420 f09f 9880 5c6e 666f 6f5c 725c  ent ....\nfoo\r\
+00011d10: 6e62 6172 2729 0a0a 2020 2020 6465 6620  nbar')..    def 
+00011d20: 7465 7374 5f70 7573 685f 7465 7874 2873  test_push_text(s
+00011d30: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+00011d40: 6c66 2e5f 7465 7374 5f70 7573 685f 7374  lf._test_push_st
+00011d50: 7228 696f 2e53 7472 696e 6749 4f28 2763  r(io.StringIO('c
+00011d60: 6f6e 7465 6e74 20f0 9f98 805c 6e66 6f6f  ontent ....\nfoo
+00011d70: 5c72 5c6e 6261 7227 2929 0a0a 2020 2020  \r\nbar'))..    
+00011d80: 6465 6620 5f74 6573 745f 7075 7368 5f73  def _test_push_s
+00011d90: 7472 2873 656c 662c 2073 6f75 7263 6529  tr(self, source)
+00011da0: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+00011db0: 6c69 656e 742e 7265 7370 6f6e 7365 732e  lient.responses.
+00011dc0: 6170 7065 6e64 2828 0a20 2020 2020 2020  append((.       
+00011dd0: 2020 2020 207b 2743 6f6e 7465 6e74 2d54       {'Content-T
+00011de0: 7970 6527 3a20 2761 7070 6c69 6361 7469  ype': 'applicati
+00011df0: 6f6e 2f6a 736f 6e27 7d2c 0a20 2020 2020  on/json'},.     
+00011e00: 2020 2020 2020 2062 2222 220a 7b0a 2020         b""".{.  
+00011e10: 2020 2272 6573 756c 7422 3a20 5b0a 2020    "result": [.  
+00011e20: 2020 2020 2020 7b22 7061 7468 223a 2022        {"path": "
+00011e30: 2f66 6f6f 2f62 6172 227d 0a20 2020 205d  /foo/bar"}.    ]
+00011e40: 2c0a 2020 2020 2273 7461 7475 7322 3a20  ,.    "status": 
+00011e50: 224f 4b22 2c0a 2020 2020 2273 7461 7475  "OK",.    "statu
+00011e60: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+00011e70: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
+00011e80: 0a7d 0a22 2222 2c0a 2020 2020 2020 2020  .}.""",.        
+00011e90: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+00011ea0: 2e63 6c69 656e 742e 7075 7368 2827 2f66  .client.push('/f
+00011eb0: 6f6f 2f62 6172 272c 2073 6f75 7263 6529  oo/bar', source)
+00011ec0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00011ed0: 7373 6572 7445 7175 616c 286c 656e 2873  ssertEqual(len(s
+00011ee0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00011ef0: 7374 7329 2c20 3129 0a20 2020 2020 2020  sts), 1).       
+00011f00: 2072 6571 7565 7374 203d 2073 656c 662e   request = self.
+00011f10: 636c 6965 6e74 2e72 6571 7565 7374 735b  client.requests[
+00011f20: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+00011f30: 6173 7365 7274 4571 7561 6c28 7265 7175  assertEqual(requ
+00011f40: 6573 745b 3a33 5d2c 2028 2750 4f53 5427  est[:3], ('POST'
+00011f50: 2c20 272f 7631 2f66 696c 6573 272c 204e  , '/v1/files', N
+00011f60: 6f6e 6529 290a 0a20 2020 2020 2020 2068  one))..        h
+00011f70: 6561 6465 7273 2c20 626f 6479 203d 2072  eaders, body = r
+00011f80: 6571 7565 7374 5b33 3a5d 0a0a 2020 2020  equest[3:]..    
+00011f90: 2020 2020 636f 6e74 656e 745f 7479 7065      content_type
+00011fa0: 203d 2068 6561 6465 7273 5b27 436f 6e74   = headers['Cont
+00011fb0: 656e 742d 5479 7065 275d 0a20 2020 2020  ent-Type'].     
+00011fc0: 2020 2072 6571 2c20 6669 6c65 6e61 6d65     req, filename
+00011fd0: 2c20 636f 6e74 656e 7420 3d20 7365 6c66  , content = self
+00011fe0: 2e5f 7061 7273 655f 7772 6974 655f 6d75  ._parse_write_mu
+00011ff0: 6c74 6970 6172 7428 636f 6e74 656e 745f  ltipart(content_
+00012000: 7479 7065 2c20 626f 6479 290a 2020 2020  type, body).    
+00012010: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00012020: 7175 616c 2866 696c 656e 616d 652c 2027  qual(filename, '
+00012030: 2f66 6f6f 2f62 6172 2729 0a20 2020 2020  /foo/bar').     
+00012040: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00012050: 7561 6c28 636f 6e74 656e 742c 2062 2763  ual(content, b'c
+00012060: 6f6e 7465 6e74 205c 7866 305c 7839 665c  ontent \xf0\x9f\
+00012070: 7839 385c 7838 305c 6e66 6f6f 5c72 5c6e  x98\x80\nfoo\r\n
+00012080: 6261 7227 290a 2020 2020 2020 2020 7365  bar').        se
+00012090: 6c66 2e61 7373 6572 7445 7175 616c 2872  lf.assertEqual(r
+000120a0: 6571 2c20 7b0a 2020 2020 2020 2020 2020  eq, {.          
+000120b0: 2020 2761 6374 696f 6e27 3a20 2777 7269    'action': 'wri
+000120c0: 7465 272c 0a20 2020 2020 2020 2020 2020  te',.           
+000120d0: 2027 6669 6c65 7327 3a20 5b7b 2770 6174   'files': [{'pat
+000120e0: 6827 3a20 272f 666f 6f2f 6261 7227 7d5d  h': '/foo/bar'}]
+000120f0: 2c0a 2020 2020 2020 2020 7d29 0a0a 2020  ,.        })..  
+00012100: 2020 6465 6620 7465 7374 5f70 7573 685f    def test_push_
+00012110: 6279 7465 7328 7365 6c66 293a 0a20 2020  bytes(self):.   
+00012120: 2020 2020 2073 656c 662e 5f74 6573 745f       self._test_
+00012130: 7075 7368 5f62 7974 6573 2862 2763 6f6e  push_bytes(b'con
+00012140: 7465 6e74 205c 7866 305c 7839 665c 7839  tent \xf0\x9f\x9
+00012150: 385c 7838 305c 6e66 6f6f 5c72 5c6e 6261  8\x80\nfoo\r\nba
+00012160: 7227 290a 0a20 2020 2064 6566 2074 6573  r')..    def tes
+00012170: 745f 7075 7368 5f62 696e 6172 7928 7365  t_push_binary(se
+00012180: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00012190: 662e 5f74 6573 745f 7075 7368 5f62 7974  f._test_push_byt
+000121a0: 6573 2869 6f2e 4279 7465 7349 4f28 6227  es(io.BytesIO(b'
+000121b0: 636f 6e74 656e 7420 5c78 6630 5c78 3966  content \xf0\x9f
+000121c0: 5c78 3938 5c78 3830 5c6e 666f 6f5c 725c  \x98\x80\nfoo\r\
+000121d0: 6e62 6172 2729 290a 0a20 2020 2064 6566  nbar'))..    def
+000121e0: 205f 7465 7374 5f70 7573 685f 6279 7465   _test_push_byte
+000121f0: 7328 7365 6c66 2c20 736f 7572 6365 293a  s(self, source):
+00012200: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00012210: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+00012220: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
+00012230: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
+00012240: 7065 273a 2027 6170 706c 6963 6174 696f  pe': 'applicatio
+00012250: 6e2f 6a73 6f6e 277d 2c0a 2020 2020 2020  n/json'},.      
+00012260: 2020 2020 2020 6222 2222 0a7b 0a20 2020        b""".{.   
+00012270: 2022 7265 7375 6c74 223a 205b 0a20 2020   "result": [.   
+00012280: 2020 2020 207b 2270 6174 6822 3a20 222f       {"path": "/
+00012290: 666f 6f2f 6261 7222 7d0a 2020 2020 5d2c  foo/bar"}.    ],
+000122a0: 0a20 2020 2022 7374 6174 7573 223a 2022  .    "status": "
+000122b0: 4f4b 222c 0a20 2020 2022 7374 6174 7573  OK",.    "status
+000122c0: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
+000122d0: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
+000122e0: 7d0a 2222 222c 0a20 2020 2020 2020 2029  }.""",.        )
+000122f0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00012300: 636c 6965 6e74 2e70 7573 6828 272f 666f  client.push('/fo
+00012310: 6f2f 6261 7227 2c20 736f 7572 6365 290a  o/bar', source).
+00012320: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00012330: 7365 7274 4571 7561 6c28 6c65 6e28 7365  sertEqual(len(se
+00012340: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
+00012350: 7473 292c 2031 290a 2020 2020 2020 2020  ts), 1).        
+00012360: 7265 7175 6573 7420 3d20 7365 6c66 2e63  request = self.c
+00012370: 6c69 656e 742e 7265 7175 6573 7473 5b30  lient.requests[0
+00012380: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+00012390: 7373 6572 7445 7175 616c 2872 6571 7565  ssertEqual(reque
+000123a0: 7374 5b3a 335d 2c20 2827 504f 5354 272c  st[:3], ('POST',
+000123b0: 2027 2f76 312f 6669 6c65 7327 2c20 4e6f   '/v1/files', No
+000123c0: 6e65 2929 0a0a 2020 2020 2020 2020 6865  ne))..        he
+000123d0: 6164 6572 732c 2062 6f64 7920 3d20 7265  aders, body = re
+000123e0: 7175 6573 745b 333a 5d0a 2020 2020 2020  quest[3:].      
+000123f0: 2020 636f 6e74 656e 745f 7479 7065 203d    content_type =
+00012400: 2068 6561 6465 7273 5b27 436f 6e74 656e   headers['Conten
+00012410: 742d 5479 7065 275d 0a20 2020 2020 2020  t-Type'].       
+00012420: 2072 6571 2c20 6669 6c65 6e61 6d65 2c20   req, filename, 
+00012430: 636f 6e74 656e 7420 3d20 7365 6c66 2e5f  content = self._
+00012440: 7061 7273 655f 7772 6974 655f 6d75 6c74  parse_write_mult
+00012450: 6970 6172 7428 636f 6e74 656e 745f 7479  ipart(content_ty
+00012460: 7065 2c20 626f 6479 290a 2020 2020 2020  pe, body).      
+00012470: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00012480: 616c 2866 696c 656e 616d 652c 2027 2f66  al(filename, '/f
+00012490: 6f6f 2f62 6172 2729 0a20 2020 2020 2020  oo/bar').       
+000124a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000124b0: 6c28 636f 6e74 656e 742c 2062 2763 6f6e  l(content, b'con
+000124c0: 7465 6e74 205c 7866 305c 7839 665c 7839  tent \xf0\x9f\x9
+000124d0: 385c 7838 305c 6e66 6f6f 5c72 5c6e 6261  8\x80\nfoo\r\nba
+000124e0: 7227 290a 2020 2020 2020 2020 7365 6c66  r').        self
+000124f0: 2e61 7373 6572 7445 7175 616c 2872 6571  .assertEqual(req
+00012500: 2c20 7b0a 2020 2020 2020 2020 2020 2020  , {.            
+00012510: 2761 6374 696f 6e27 3a20 2777 7269 7465  'action': 'write
+00012520: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00012530: 6669 6c65 7327 3a20 5b7b 2770 6174 6827  files': [{'path'
+00012540: 3a20 272f 666f 6f2f 6261 7227 7d5d 2c0a  : '/foo/bar'}],.
+00012550: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
+00012560: 6465 6620 7465 7374 5f70 7573 685f 616c  def test_push_al
+00012570: 6c5f 6f70 7469 6f6e 7328 7365 6c66 293a  l_options(self):
+00012580: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00012590: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+000125a0: 7070 656e 6428 280a 2020 2020 2020 2020  ppend((.        
+000125b0: 2020 2020 7b27 436f 6e74 656e 742d 5479      {'Content-Ty
+000125c0: 7065 273a 2027 6170 706c 6963 6174 696f  pe': 'applicatio
+000125d0: 6e2f 6a73 6f6e 277d 2c0a 2020 2020 2020  n/json'},.      
+000125e0: 2020 2020 2020 6222 2222 0a7b 0a20 2020        b""".{.   
+000125f0: 2022 7265 7375 6c74 223a 205b 0a20 2020   "result": [.   
+00012600: 2020 2020 207b 2270 6174 6822 3a20 222f       {"path": "/
+00012610: 666f 6f2f 6261 7222 7d0a 2020 2020 5d2c  foo/bar"}.    ],
+00012620: 0a20 2020 2022 7374 6174 7573 223a 2022  .    "status": "
+00012630: 4f4b 222c 0a20 2020 2022 7374 6174 7573  OK",.    "status
+00012640: 2d63 6f64 6522 3a20 3230 302c 0a20 2020  -code": 200,.   
+00012650: 2022 7479 7065 223a 2022 7379 6e63 220a   "type": "sync".
+00012660: 7d0a 2222 222c 0a20 2020 2020 2020 2029  }.""",.        )
+00012670: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00012680: 636c 6965 6e74 2e70 7573 6828 272f 666f  client.push('/fo
+00012690: 6f2f 6261 7227 2c20 2763 6f6e 7465 6e74  o/bar', 'content
+000126a0: 272c 206d 616b 655f 6469 7273 3d54 7275  ', make_dirs=Tru
+000126b0: 652c 2070 6572 6d69 7373 696f 6e73 3d30  e, permissions=0
+000126c0: 6f36 3030 2c0a 2020 2020 2020 2020 2020  o600,.          
+000126d0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+000126e0: 7365 725f 6964 3d31 322c 2075 7365 723d  ser_id=12, user=
+000126f0: 2762 6f62 272c 2067 726f 7570 5f69 643d  'bob', group_id=
+00012700: 3334 2c20 6772 6f75 703d 2773 7461 6666  34, group='staff
+00012710: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+00012720: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+00012730: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+00012740: 7565 7374 7329 2c20 3129 0a20 2020 2020  uests), 1).     
+00012750: 2020 2072 6571 7565 7374 203d 2073 656c     request = sel
+00012760: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
+00012770: 735b 305d 0a20 2020 2020 2020 2073 656c  s[0].        sel
+00012780: 662e 6173 7365 7274 4571 7561 6c28 7265  f.assertEqual(re
+00012790: 7175 6573 745b 3a33 5d2c 2028 2750 4f53  quest[:3], ('POS
+000127a0: 5427 2c20 272f 7631 2f66 696c 6573 272c  T', '/v1/files',
+000127b0: 204e 6f6e 6529 290a 0a20 2020 2020 2020   None))..       
+000127c0: 2068 6561 6465 7273 2c20 626f 6479 203d   headers, body =
+000127d0: 2072 6571 7565 7374 5b33 3a5d 0a20 2020   request[3:].   
+000127e0: 2020 2020 2063 6f6e 7465 6e74 5f74 7970       content_typ
+000127f0: 6520 3d20 6865 6164 6572 735b 2743 6f6e  e = headers['Con
+00012800: 7465 6e74 2d54 7970 6527 5d0a 2020 2020  tent-Type'].    
+00012810: 2020 2020 7265 712c 2066 696c 656e 616d      req, filenam
+00012820: 652c 2063 6f6e 7465 6e74 203d 2073 656c  e, content = sel
+00012830: 662e 5f70 6172 7365 5f77 7269 7465 5f6d  f._parse_write_m
+00012840: 756c 7469 7061 7274 2863 6f6e 7465 6e74  ultipart(content
+00012850: 5f74 7970 652c 2062 6f64 7929 0a20 2020  _type, body).   
+00012860: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00012870: 4571 7561 6c28 6669 6c65 6e61 6d65 2c20  Equal(filename, 
+00012880: 272f 666f 6f2f 6261 7227 290a 2020 2020  '/foo/bar').    
+00012890: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000128a0: 7175 616c 2863 6f6e 7465 6e74 2c20 6227  qual(content, b'
+000128b0: 636f 6e74 656e 7427 290a 2020 2020 2020  content').      
+000128c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000128d0: 616c 2872 6571 2c20 7b0a 2020 2020 2020  al(req, {.      
+000128e0: 2020 2020 2020 2761 6374 696f 6e27 3a20        'action': 
+000128f0: 2777 7269 7465 272c 0a20 2020 2020 2020  'write',.       
+00012900: 2020 2020 2027 6669 6c65 7327 3a20 5b7b       'files': [{
+00012910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012920: 2027 7061 7468 273a 2027 2f66 6f6f 2f62   'path': '/foo/b
+00012930: 6172 272c 0a20 2020 2020 2020 2020 2020  ar',.           
+00012940: 2020 2020 2027 6d61 6b65 2d64 6972 7327       'make-dirs'
+00012950: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
+00012960: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
+00012970: 696f 6e73 273a 2027 3630 3027 2c0a 2020  ions': '600',.  
+00012980: 2020 2020 2020 2020 2020 2020 2020 2775                'u
+00012990: 7365 722d 6964 273a 2031 322c 0a20 2020  ser-id': 12,.   
+000129a0: 2020 2020 2020 2020 2020 2020 2027 7573               'us
+000129b0: 6572 273a 2027 626f 6227 2c0a 2020 2020  er': 'bob',.    
+000129c0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
+000129d0: 7570 2d69 6427 3a20 3334 2c0a 2020 2020  up-id': 34,.    
+000129e0: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
+000129f0: 7570 273a 2027 7374 6166 6627 2c0a 2020  up': 'staff',.  
+00012a00: 2020 2020 2020 2020 2020 7d5d 2c0a 2020            }],.  
+00012a10: 2020 2020 2020 7d29 0a0a 2020 2020 6465        })..    de
+00012a20: 6620 7465 7374 5f70 7573 685f 7569 645f  f test_push_uid_
+00012a30: 6769 6428 7365 6c66 293a 0a20 2020 2020  gid(self):.     
+00012a40: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+00012a50: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
+00012a60: 280a 2020 2020 2020 2020 2020 2020 7b27  (.            {'
+00012a70: 436f 6e74 656e 742d 5479 7065 273a 2027  Content-Type': '
+00012a80: 6170 706c 6963 6174 696f 6e2f 6a73 6f6e  application/json
+00012a90: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00012aa0: 6222 2222 0a7b 0a20 2020 2022 7265 7375  b""".{.    "resu
+00012ab0: 6c74 223a 205b 0a20 2020 2020 2020 207b  lt": [.        {
+00012ac0: 2270 6174 6822 3a20 222f 666f 6f2f 6261  "path": "/foo/ba
+00012ad0: 7222 7d0a 2020 2020 5d2c 0a20 2020 2022  r"}.    ],.    "
+00012ae0: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
+00012af0: 2020 2022 7374 6174 7573 2d63 6f64 6522     "status-code"
+00012b00: 3a20 3230 302c 0a20 2020 2022 7479 7065  : 200,.    "type
+00012b10: 223a 2022 7379 6e63 220a 7d0a 2222 222c  ": "sync".}.""",
+00012b20: 0a20 2020 2020 2020 2029 290a 0a20 2020  .        ))..   
+00012b30: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00012b40: 2e70 7573 6828 272f 666f 6f2f 6261 7227  .push('/foo/bar'
+00012b50: 2c20 2763 6f6e 7465 6e74 272c 2075 7365  , 'content', use
+00012b60: 725f 6964 3d31 322c 2067 726f 7570 5f69  r_id=12, group_i
+00012b70: 643d 3334 290a 0a20 2020 2020 2020 2073  d=34)..        s
+00012b80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00012b90: 6c65 6e28 7365 6c66 2e63 6c69 656e 742e  len(self.client.
+00012ba0: 7265 7175 6573 7473 292c 2031 290a 2020  requests), 1).  
+00012bb0: 2020 2020 2020 7265 7175 6573 7420 3d20        request = 
+00012bc0: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+00012bd0: 6573 7473 5b30 5d0a 2020 2020 2020 2020  ests[0].        
+00012be0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012bf0: 2872 6571 7565 7374 5b3a 335d 2c20 2827  (request[:3], ('
+00012c00: 504f 5354 272c 2027 2f76 312f 6669 6c65  POST', '/v1/file
+00012c10: 7327 2c20 4e6f 6e65 2929 0a0a 2020 2020  s', None))..    
+00012c20: 2020 2020 6865 6164 6572 732c 2062 6f64      headers, bod
+00012c30: 7920 3d20 7265 7175 6573 745b 333a 5d0a  y = request[3:].
+00012c40: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
+00012c50: 7479 7065 203d 2068 6561 6465 7273 5b27  type = headers['
+00012c60: 436f 6e74 656e 742d 5479 7065 275d 0a20  Content-Type']. 
+00012c70: 2020 2020 2020 2072 6571 2c20 6669 6c65         req, file
+00012c80: 6e61 6d65 2c20 636f 6e74 656e 7420 3d20  name, content = 
+00012c90: 7365 6c66 2e5f 7061 7273 655f 7772 6974  self._parse_writ
+00012ca0: 655f 6d75 6c74 6970 6172 7428 636f 6e74  e_multipart(cont
+00012cb0: 656e 745f 7479 7065 2c20 626f 6479 290a  ent_type, body).
+00012cc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00012cd0: 6572 7445 7175 616c 2866 696c 656e 616d  ertEqual(filenam
+00012ce0: 652c 2027 2f66 6f6f 2f62 6172 2729 0a20  e, '/foo/bar'). 
+00012cf0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00012d00: 7274 4571 7561 6c28 636f 6e74 656e 742c  rtEqual(content,
+00012d10: 2062 2763 6f6e 7465 6e74 2729 0a20 2020   b'content').   
+00012d20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00012d30: 4571 7561 6c28 7265 712c 207b 0a20 2020  Equal(req, {.   
+00012d40: 2020 2020 2020 2020 2027 6163 7469 6f6e           'action
+00012d50: 273a 2027 7772 6974 6527 2c0a 2020 2020  ': 'write',.    
+00012d60: 2020 2020 2020 2020 2766 696c 6573 273a          'files':
+00012d70: 205b 7b0a 2020 2020 2020 2020 2020 2020   [{.            
+00012d80: 2020 2020 2770 6174 6827 3a20 272f 666f      'path': '/fo
+00012d90: 6f2f 6261 7227 2c0a 2020 2020 2020 2020  o/bar',.        
+00012da0: 2020 2020 2020 2020 2775 7365 722d 6964          'user-id
+00012db0: 273a 2031 322c 0a20 2020 2020 2020 2020  ': 12,.         
+00012dc0: 2020 2020 2020 2027 6772 6f75 702d 6964         'group-id
+00012dd0: 273a 2033 342c 0a20 2020 2020 2020 2020  ': 34,.         
+00012de0: 2020 207d 5d2c 0a20 2020 2020 2020 207d     }],.        }
+00012df0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00012e00: 7075 7368 5f70 6174 685f 6572 726f 7228  push_path_error(
+00012e10: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00012e20: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+00012e30: 6e73 6573 2e61 7070 656e 6428 280a 2020  nses.append((.  
+00012e40: 2020 2020 2020 2020 2020 7b27 436f 6e74            {'Cont
+00012e50: 656e 742d 5479 7065 273a 2027 6170 706c  ent-Type': 'appl
+00012e60: 6963 6174 696f 6e2f 6a73 6f6e 277d 2c0a  ication/json'},.
+00012e70: 2020 2020 2020 2020 2020 2020 6222 2222              b"""
+00012e80: 0a7b 0a20 2020 2022 7265 7375 6c74 223a  .{.    "result":
+00012e90: 205b 0a20 2020 2020 2020 207b 2270 6174   [.        {"pat
+00012ea0: 6822 3a20 222f 666f 6f2f 6261 7222 2c20  h": "/foo/bar", 
+00012eb0: 2265 7272 6f72 223a 207b 226b 696e 6422  "error": {"kind"
+00012ec0: 3a20 226e 6f74 2d66 6f75 6e64 222c 2022  : "not-found", "
+00012ed0: 6d65 7373 6167 6522 3a20 226e 6f74 2066  message": "not f
+00012ee0: 6f75 6e64 227d 7d0a 2020 2020 5d2c 0a20  ound"}}.    ],. 
+00012ef0: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
+00012f00: 222c 0a20 2020 2022 7374 6174 7573 2d63  ",.    "status-c
+00012f10: 6f64 6522 3a20 3230 302c 0a20 2020 2022  ode": 200,.    "
+00012f20: 7479 7065 223a 2022 7379 6e63 220a 7d0a  type": "sync".}.
+00012f30: 2222 222c 0a20 2020 2020 2020 2029 290a  """,.        )).
+00012f40: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00012f50: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00012f60: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
+00012f70: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00012f80: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00012f90: 2e70 7573 6828 272f 666f 6f2f 6261 7227  .push('/foo/bar'
+00012fa0: 2c20 2763 6f6e 7465 6e74 2729 0a20 2020  , 'content').   
+00012fb0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00012fc0: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
+00012fd0: 6f6e 2e6b 696e 642c 2027 6e6f 742d 666f  on.kind, 'not-fo
+00012fe0: 756e 6427 290a 2020 2020 2020 2020 7365  und').        se
+00012ff0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00013000: 6d2e 6578 6365 7074 696f 6e2e 6d65 7373  m.exception.mess
+00013010: 6167 652c 2027 6e6f 7420 666f 756e 6427  age, 'not found'
+00013020: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00013030: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+00013040: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+00013050: 6573 7473 292c 2031 290a 2020 2020 2020  ests), 1).      
+00013060: 2020 7265 7175 6573 7420 3d20 7365 6c66    request = self
+00013070: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
+00013080: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
+00013090: 2e61 7373 6572 7445 7175 616c 2872 6571  .assertEqual(req
+000130a0: 7565 7374 5b3a 335d 2c20 2827 504f 5354  uest[:3], ('POST
+000130b0: 272c 2027 2f76 312f 6669 6c65 7327 2c20  ', '/v1/files', 
+000130c0: 4e6f 6e65 2929 0a0a 2020 2020 2020 2020  None))..        
+000130d0: 6865 6164 6572 732c 2062 6f64 7920 3d20  headers, body = 
+000130e0: 7265 7175 6573 745b 333a 5d0a 2020 2020  request[3:].    
+000130f0: 2020 2020 636f 6e74 656e 745f 7479 7065      content_type
+00013100: 203d 2068 6561 6465 7273 5b27 436f 6e74   = headers['Cont
+00013110: 656e 742d 5479 7065 275d 0a20 2020 2020  ent-Type'].     
+00013120: 2020 2072 6571 2c20 6669 6c65 6e61 6d65     req, filename
+00013130: 2c20 636f 6e74 656e 7420 3d20 7365 6c66  , content = self
+00013140: 2e5f 7061 7273 655f 7772 6974 655f 6d75  ._parse_write_mu
+00013150: 6c74 6970 6172 7428 636f 6e74 656e 745f  ltipart(content_
+00013160: 7479 7065 2c20 626f 6479 290a 2020 2020  type, body).    
+00013170: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013180: 7175 616c 2866 696c 656e 616d 652c 2027  qual(filename, '
+00013190: 2f66 6f6f 2f62 6172 2729 0a20 2020 2020  /foo/bar').     
+000131a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000131b0: 7561 6c28 636f 6e74 656e 742c 2062 2763  ual(content, b'c
+000131c0: 6f6e 7465 6e74 2729 0a20 2020 2020 2020  ontent').       
+000131d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000131e0: 6c28 7265 712c 207b 0a20 2020 2020 2020  l(req, {.       
+000131f0: 2020 2020 2027 6163 7469 6f6e 273a 2027       'action': '
+00013200: 7772 6974 6527 2c0a 2020 2020 2020 2020  write',.        
+00013210: 2020 2020 2766 696c 6573 273a 205b 7b27      'files': [{'
+00013220: 7061 7468 273a 2027 2f66 6f6f 2f62 6172  path': '/foo/bar
+00013230: 277d 5d2c 0a20 2020 2020 2020 207d 290a  '}],.        }).
+00013240: 0a20 2020 2064 6566 205f 7061 7273 655f  .    def _parse_
+00013250: 7772 6974 655f 6d75 6c74 6970 6172 7428  write_multipart(
+00013260: 7365 6c66 2c20 636f 6e74 656e 745f 7479  self, content_ty
+00013270: 7065 2c20 626f 6479 293a 0a20 2020 2020  pe, body):.     
+00013280: 2020 2063 7479 7065 2c20 6f70 7469 6f6e     ctype, option
+00013290: 7320 3d20 6367 692e 7061 7273 655f 6865  s = cgi.parse_he
+000132a0: 6164 6572 2863 6f6e 7465 6e74 5f74 7970  ader(content_typ
+000132b0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+000132c0: 6173 7365 7274 4571 7561 6c28 6374 7970  assertEqual(ctyp
+000132d0: 652c 2027 6d75 6c74 6970 6172 742f 666f  e, 'multipart/fo
+000132e0: 726d 2d64 6174 6127 290a 2020 2020 2020  rm-data').      
+000132f0: 2020 626f 756e 6461 7279 203d 206f 7074    boundary = opt
+00013300: 696f 6e73 5b27 626f 756e 6461 7279 275d  ions['boundary']
+00013310: 0a0a 2020 2020 2020 2020 2320 5765 2068  ..        # We h
+00013320: 6176 6520 746f 206d 616e 7561 6c6c 7920  ave to manually 
+00013330: 7772 6974 6520 7468 6520 436f 6e74 656e  write the Conten
+00013340: 742d 5479 7065 2077 6974 6820 626f 756e  t-Type with boun
+00013350: 6461 7279 2c20 6265 6361 7573 650a 2020  dary, because.  
+00013360: 2020 2020 2020 2320 656d 6169 6c2e 7061        # email.pa
+00013370: 7273 6572 2065 7870 6563 7473 2074 6865  rser expects the
+00013380: 2065 6e74 6972 6520 6d75 6c74 6970 6172   entire multipar
+00013390: 7420 6d65 7373 6167 6520 7769 7468 2068  t message with h
+000133a0: 6561 6465 7273 2e0a 2020 2020 2020 2020  eaders..        
+000133b0: 7061 7273 6572 203d 2065 6d61 696c 2e70  parser = email.p
+000133c0: 6172 7365 722e 4279 7465 7346 6565 6450  arser.BytesFeedP
+000133d0: 6172 7365 7228 290a 2020 2020 2020 2020  arser().        
+000133e0: 7061 7273 6572 2e66 6565 6428 6227 436f  parser.feed(b'Co
+000133f0: 6e74 656e 742d 5479 7065 3a20 6d75 6c74  ntent-Type: mult
+00013400: 6970 6172 742f 666f 726d 2d64 6174 613b  ipart/form-data;
+00013410: 2062 6f75 6e64 6172 793d 270a 2020 2020   boundary='.    
+00013420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013430: 2b20 626f 756e 6461 7279 2e65 6e63 6f64  + boundary.encod
+00013440: 6528 2775 7466 2d38 2729 202b 2062 275c  e('utf-8') + b'\
+00013450: 725c 6e5c 725c 6e27 290a 2020 2020 2020  r\n\r\n').      
+00013460: 2020 666f 7220 6220 696e 2062 6f64 793a    for b in body:
+00013470: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+00013480: 6974 6820 7468 6520 226d 656d 6f72 7920  ith the "memory 
+00013490: 6566 6669 6369 656e 7420 7075 7368 2220  efficient push" 
+000134a0: 6368 616e 6765 732c 2062 6f64 7920 6973  changes, body is
+000134b0: 2061 6e20 6974 6572 6162 6c65 2e0a 2020   an iterable..  
+000134c0: 2020 2020 2020 2020 2020 7061 7273 6572            parser
+000134d0: 2e66 6565 6428 6229 0a20 2020 2020 2020  .feed(b).       
+000134e0: 206d 6573 7361 6765 203d 2070 6172 7365   message = parse
+000134f0: 722e 636c 6f73 6528 290a 0a20 2020 2020  r.close()..     
+00013500: 2020 2072 6571 203d 204e 6f6e 650a 2020     req = None.  
+00013510: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
+00013520: 204e 6f6e 650a 2020 2020 2020 2020 636f   None.        co
+00013530: 6e74 656e 7420 3d20 4e6f 6e65 0a20 2020  ntent = None.   
+00013540: 2020 2020 2066 6f72 2070 6172 7420 696e       for part in
+00013550: 206d 6573 7361 6765 2e77 616c 6b28 293a   message.walk():
+00013560: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00013570: 6520 3d20 7061 7274 2e67 6574 5f70 6172  e = part.get_par
+00013580: 616d 2827 6e61 6d65 272c 2068 6561 6465  am('name', heade
+00013590: 723d 2743 6f6e 7465 6e74 2d44 6973 706f  r='Content-Dispo
+000135a0: 7369 7469 6f6e 2729 0a20 2020 2020 2020  sition').       
+000135b0: 2020 2020 2069 6620 6e61 6d65 203d 3d20       if name == 
+000135c0: 2772 6571 7565 7374 273a 0a20 2020 2020  'request':.     
+000135d0: 2020 2020 2020 2020 2020 2072 6571 203d             req =
+000135e0: 206a 736f 6e2e 6c6f 6164 7328 7061 7274   json.loads(part
+000135f0: 2e67 6574 5f70 6179 6c6f 6164 2829 290a  .get_payload()).
+00013600: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00013610: 206e 616d 6520 3d3d 2027 6669 6c65 7327   name == 'files'
+00013620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013630: 2020 2320 6465 636f 6465 3d54 7275 652c    # decode=True,
+00013640: 2069 726f 6e69 6361 6c6c 792c 2061 766f   ironically, avo
+00013650: 6964 7320 6465 636f 6469 6e67 2062 7974  ids decoding byt
+00013660: 6573 2074 6f20 7374 720a 2020 2020 2020  es to str.      
+00013670: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
+00013680: 7420 3d20 7061 7274 2e67 6574 5f70 6179  t = part.get_pay
+00013690: 6c6f 6164 2864 6563 6f64 653d 5472 7565  load(decode=True
+000136a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000136b0: 2020 6669 6c65 6e61 6d65 203d 2070 6172    filename = par
+000136c0: 742e 6765 745f 6669 6c65 6e61 6d65 2829  t.get_filename()
+000136d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000136e0: 2872 6571 2c20 6669 6c65 6e61 6d65 2c20  (req, filename, 
+000136f0: 636f 6e74 656e 7429 0a0a 2020 2020 6465  content)..    de
+00013700: 6620 7465 7374 5f6c 6973 745f 6669 6c65  f test_list_file
+00013710: 735f 7061 7468 2873 656c 6629 3a0a 2020  s_path(self):.  
+00013720: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00013730: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+00013740: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
+00013750: 2022 7265 7375 6c74 223a 205b 0a20 2020   "result": [.   
+00013760: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00013770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013780: 2020 2027 7061 7468 273a 2027 2f65 7463     'path': '/etc
+00013790: 2f68 6f73 7473 272c 0a20 2020 2020 2020  /hosts',.       
+000137a0: 2020 2020 2020 2020 2020 2020 2027 6e61               'na
+000137b0: 6d65 273a 2027 686f 7374 7327 2c0a 2020  me': 'hosts',.  
+000137c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137d0: 2020 2774 7970 6527 3a20 2766 696c 6527    'type': 'file'
+000137e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000137f0: 2020 2020 2020 2773 697a 6527 3a20 3132        'size': 12
+00013800: 332c 0a20 2020 2020 2020 2020 2020 2020  3,.             
+00013810: 2020 2020 2020 2027 7065 726d 6973 7369         'permissi
+00013820: 6f6e 7327 3a20 2736 3434 272c 0a20 2020  ons': '644',.   
+00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013840: 2027 6c61 7374 2d6d 6f64 6966 6965 6427   'last-modified'
+00013850: 3a20 2732 3032 312d 3031 2d32 3854 3134  : '2021-01-28T14
+00013860: 3a33 373a 3034 2e32 3931 3531 3737 3638  :37:04.291517768
+00013870: 2b31 333a 3030 272c 0a20 2020 2020 2020  +13:00',.       
+00013880: 2020 2020 2020 2020 2020 2020 2027 7573               'us
+00013890: 6572 2d69 6427 3a20 3132 2c0a 2020 2020  er-id': 12,.    
+000138a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138b0: 2775 7365 7227 3a20 2762 6f62 272c 0a20  'user': 'bob',. 
+000138c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138d0: 2020 2027 6772 6f75 702d 6964 273a 2033     'group-id': 3
+000138e0: 342c 0a20 2020 2020 2020 2020 2020 2020  4,.             
+000138f0: 2020 2020 2020 2027 6772 6f75 7027 3a20         'group': 
+00013900: 2773 7461 6666 272c 0a20 2020 2020 2020  'staff',.       
+00013910: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00013920: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00013930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013940: 2020 2770 6174 6827 3a20 272f 6574 632f    'path': '/etc/
+00013950: 6e67 696e 7827 2c0a 2020 2020 2020 2020  nginx',.        
+00013960: 2020 2020 2020 2020 2020 2020 276e 616d              'nam
+00013970: 6527 3a20 276e 6769 6e78 272c 0a20 2020  e': 'nginx',.   
+00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013990: 2027 7479 7065 273a 2027 6469 7265 6374   'type': 'direct
+000139a0: 6f72 7927 2c0a 2020 2020 2020 2020 2020  ory',.          
+000139b0: 2020 2020 2020 2020 2020 2770 6572 6d69            'permi
+000139c0: 7373 696f 6e73 273a 2027 3735 3527 2c0a  ssions': '755',.
+000139d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139e0: 2020 2020 276c 6173 742d 6d6f 6469 6669      'last-modifi
+000139f0: 6564 273a 2027 3230 3230 2d30 312d 3031  ed': '2020-01-01
+00013a00: 5430 313a 3031 3a30 312e 3030 3030 3030  T01:01:01.000000
+00013a10: 2b31 333a 3030 272c 0a20 2020 2020 2020  +13:00',.       
+00013a20: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00013a30: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00013a40: 2020 2020 2020 2027 7374 6174 7573 273a         'status':
+00013a50: 2027 4f4b 272c 0a20 2020 2020 2020 2020   'OK',.         
+00013a60: 2020 2027 7374 6174 7573 2d63 6f64 6527     'status-code'
+00013a70: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
+00013a80: 2020 2027 7479 7065 273a 2027 7379 6e63     'type': 'sync
+00013a90: 272c 0a20 2020 2020 2020 207d 290a 2020  ',.        }).  
+00013aa0: 2020 2020 2020 696e 666f 7320 3d20 7365        infos = se
+00013ab0: 6c66 2e63 6c69 656e 742e 6c69 7374 5f66  lf.client.list_f
+00013ac0: 696c 6573 2827 2f65 7463 2729 0a0a 2020  iles('/etc')..  
+00013ad0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013ae0: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
+00013af0: 292c 2032 290a 2020 2020 2020 2020 7365  ), 2).        se
+00013b00: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+00013b10: 6e66 6f73 5b30 5d2e 7061 7468 2c20 272f  nfos[0].path, '/
+00013b20: 6574 632f 686f 7374 7327 290a 2020 2020  etc/hosts').    
+00013b30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013b40: 7175 616c 2869 6e66 6f73 5b30 5d2e 6e61  qual(infos[0].na
+00013b50: 6d65 2c20 2768 6f73 7473 2729 0a20 2020  me, 'hosts').   
+00013b60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00013b70: 4571 7561 6c28 696e 666f 735b 305d 2e74  Equal(infos[0].t
+00013b80: 7970 652c 2070 6562 626c 652e 4669 6c65  ype, pebble.File
+00013b90: 5479 7065 2e46 494c 4529 0a20 2020 2020  Type.FILE).     
+00013ba0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00013bb0: 7561 6c28 696e 666f 735b 305d 2e73 697a  ual(infos[0].siz
+00013bc0: 652c 2031 3233 290a 2020 2020 2020 2020  e, 123).        
+00013bd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013be0: 2869 6e66 6f73 5b30 5d2e 7065 726d 6973  (infos[0].permis
+00013bf0: 7369 6f6e 732c 2030 6f36 3434 290a 2020  sions, 0o644).  
+00013c00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013c10: 7445 7175 616c 2869 6e66 6f73 5b30 5d2e  tEqual(infos[0].
+00013c20: 6c61 7374 5f6d 6f64 6966 6965 642c 2064  last_modified, d
+00013c30: 6174 6574 696d 655f 6e7a 6474 2832 3032  atetime_nzdt(202
+00013c40: 312c 2031 2c20 3238 2c20 3134 2c20 3337  1, 1, 28, 14, 37
+00013c50: 2c20 342c 2032 3931 3531 3829 290a 2020  , 4, 291518)).  
+00013c60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013c70: 7445 7175 616c 2869 6e66 6f73 5b30 5d2e  tEqual(infos[0].
+00013c80: 7573 6572 5f69 642c 2031 3229 0a20 2020  user_id, 12).   
+00013c90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00013ca0: 4571 7561 6c28 696e 666f 735b 305d 2e75  Equal(infos[0].u
+00013cb0: 7365 722c 2027 626f 6227 290a 2020 2020  ser, 'bob').    
+00013cc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013cd0: 7175 616c 2869 6e66 6f73 5b30 5d2e 6772  qual(infos[0].gr
+00013ce0: 6f75 705f 6964 2c20 3334 290a 2020 2020  oup_id, 34).    
+00013cf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013d00: 7175 616c 2869 6e66 6f73 5b30 5d2e 6772  qual(infos[0].gr
+00013d10: 6f75 702c 2027 7374 6166 6627 290a 2020  oup, 'staff').  
+00013d20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013d30: 7445 7175 616c 2869 6e66 6f73 5b31 5d2e  tEqual(infos[1].
+00013d40: 7061 7468 2c20 272f 6574 632f 6e67 696e  path, '/etc/ngin
+00013d50: 7827 290a 2020 2020 2020 2020 7365 6c66  x').        self
+00013d60: 2e61 7373 6572 7445 7175 616c 2869 6e66  .assertEqual(inf
+00013d70: 6f73 5b31 5d2e 6e61 6d65 2c20 276e 6769  os[1].name, 'ngi
+00013d80: 6e78 2729 0a20 2020 2020 2020 2073 656c  nx').        sel
+00013d90: 662e 6173 7365 7274 4571 7561 6c28 696e  f.assertEqual(in
+00013da0: 666f 735b 315d 2e74 7970 652c 2070 6562  fos[1].type, peb
+00013db0: 626c 652e 4669 6c65 5479 7065 2e44 4952  ble.FileType.DIR
+00013dc0: 4543 544f 5259 290a 2020 2020 2020 2020  ECTORY).        
+00013dd0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013de0: 2869 6e66 6f73 5b31 5d2e 7369 7a65 2c20  (infos[1].size, 
+00013df0: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
+00013e00: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+00013e10: 6e66 6f73 5b31 5d2e 7065 726d 6973 7369  nfos[1].permissi
+00013e20: 6f6e 732c 2030 6f37 3535 290a 2020 2020  ons, 0o755).    
+00013e30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00013e40: 7175 616c 2869 6e66 6f73 5b31 5d2e 6c61  qual(infos[1].la
+00013e50: 7374 5f6d 6f64 6966 6965 642c 2064 6174  st_modified, dat
+00013e60: 6574 696d 655f 6e7a 6474 2832 3032 302c  etime_nzdt(2020,
+00013e70: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+00013e80: 3029 290a 2020 2020 2020 2020 7365 6c66  0)).        self
+00013e90: 2e61 7373 6572 7449 7328 696e 666f 735b  .assertIs(infos[
+00013ea0: 315d 2e75 7365 725f 6964 2c20 4e6f 6e65  1].user_id, None
+00013eb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00013ec0: 7373 6572 7449 7328 696e 666f 735b 315d  ssertIs(infos[1]
+00013ed0: 2e75 7365 722c 204e 6f6e 6529 0a20 2020  .user, None).   
+00013ee0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00013ef0: 4973 2869 6e66 6f73 5b31 5d2e 6772 6f75  Is(infos[1].grou
+00013f00: 705f 6964 2c20 4e6f 6e65 290a 2020 2020  p_id, None).    
+00013f10: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+00013f20: 7328 696e 666f 735b 315d 2e67 726f 7570  s(infos[1].group
+00013f30: 2c20 4e6f 6e65 290a 0a20 2020 2020 2020  , None)..       
+00013f40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00013f50: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
+00013f60: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
+00013f70: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+00013f80: 7631 2f66 696c 6573 272c 207b 2761 6374  v1/files', {'act
+00013f90: 696f 6e27 3a20 276c 6973 7427 2c20 2770  ion': 'list', 'p
+00013fa0: 6174 6827 3a20 272f 6574 6327 7d2c 204e  ath': '/etc'}, N
+00013fb0: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
+00013fc0: 0a0a 2020 2020 6465 6620 7465 7374 5f6c  ..    def test_l
+00013fd0: 6973 745f 6669 6c65 735f 7061 7474 6572  ist_files_patter
+00013fe0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+00013ff0: 2073 656c 662e 636c 6965 6e74 2e72 6573   self.client.res
+00014000: 706f 6e73 6573 2e61 7070 656e 6428 7b0a  ponses.append({.
+00014010: 2020 2020 2020 2020 2020 2020 2272 6573              "res
+00014020: 756c 7422 3a20 5b5d 2c0a 2020 2020 2020  ult": [],.      
+00014030: 2020 2020 2020 2773 7461 7475 7327 3a20        'status': 
+00014040: 274f 4b27 2c0a 2020 2020 2020 2020 2020  'OK',.          
+00014050: 2020 2773 7461 7475 732d 636f 6465 273a    'status-code':
+00014060: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
+00014070: 2020 2774 7970 6527 3a20 2773 796e 6327    'type': 'sync'
+00014080: 2c0a 2020 2020 2020 2020 7d29 0a0a 2020  ,.        })..  
+00014090: 2020 2020 2020 696e 666f 7320 3d20 7365        infos = se
+000140a0: 6c66 2e63 6c69 656e 742e 6c69 7374 5f66  lf.client.list_f
+000140b0: 696c 6573 2827 2f65 7463 272c 2070 6174  iles('/etc', pat
+000140c0: 7465 726e 3d27 2a2e 636f 6e66 2729 0a0a  tern='*.conf')..
+000140d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000140e0: 6572 7445 7175 616c 286c 656e 2869 6e66  ertEqual(len(inf
+000140f0: 6f73 292c 2030 290a 2020 2020 2020 2020  os), 0).        
+00014100: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00014110: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+00014120: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+00014130: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
+00014140: 312f 6669 6c65 7327 2c20 7b27 6163 7469  1/files', {'acti
+00014150: 6f6e 273a 2027 6c69 7374 272c 2027 7061  on': 'list', 'pa
+00014160: 7468 273a 2027 2f65 7463 272c 2027 7061  th': '/etc', 'pa
+00014170: 7474 6572 6e27 3a20 272a 2e63 6f6e 6627  ttern': '*.conf'
+00014180: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
+00014190: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+000141a0: 7374 5f6c 6973 745f 6669 6c65 735f 6974  st_list_files_it
+000141b0: 7365 6c66 2873 656c 6629 3a0a 2020 2020  self(self):.    
+000141c0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+000141d0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+000141e0: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
+000141f0: 7265 7375 6c74 223a 205b 5d2c 0a20 2020  result": [],.   
+00014200: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+00014210: 273a 2027 4f4b 272c 0a20 2020 2020 2020  ': 'OK',.       
+00014220: 2020 2020 2027 7374 6174 7573 2d63 6f64       'status-cod
+00014230: 6527 3a20 3230 302c 0a20 2020 2020 2020  e': 200,.       
+00014240: 2020 2020 2027 7479 7065 273a 2027 7379       'type': 'sy
+00014250: 6e63 272c 0a20 2020 2020 2020 207d 290a  nc',.        }).
+00014260: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
+00014270: 2073 656c 662e 636c 6965 6e74 2e6c 6973   self.client.lis
+00014280: 745f 6669 6c65 7328 272f 6574 6327 2c20  t_files('/etc', 
+00014290: 6974 7365 6c66 3d54 7275 6529 0a0a 2020  itself=True)..  
+000142a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000142b0: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
+000142c0: 292c 2030 290a 2020 2020 2020 2020 7365  ), 0).        se
+000142d0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+000142e0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+000142f0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+00014300: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+00014310: 6669 6c65 7327 2c20 7b27 6163 7469 6f6e  files', {'action
+00014320: 273a 2027 6c69 7374 272c 2027 7061 7468  ': 'list', 'path
+00014330: 273a 2027 2f65 7463 272c 2027 6974 7365  ': '/etc', 'itse
+00014340: 6c66 273a 2027 7472 7565 277d 2c20 4e6f  lf': 'true'}, No
+00014350: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+00014360: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
+00014370: 6b65 5f64 6972 5f62 6173 6963 2873 656c  ke_dir_basic(sel
+00014380: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00014390: 2e63 6c69 656e 742e 7265 7370 6f6e 7365  .client.response
+000143a0: 732e 6170 7065 6e64 287b 0a20 2020 2020  s.append({.     
+000143b0: 2020 2020 2020 2022 7265 7375 6c74 223a         "result":
+000143c0: 205b 7b27 7061 7468 273a 2027 2f66 6f6f   [{'path': '/foo
+000143d0: 2f62 6172 277d 5d2c 0a20 2020 2020 2020  /bar'}],.       
+000143e0: 2020 2020 2027 7374 6174 7573 273a 2027       'status': '
+000143f0: 4f4b 272c 0a20 2020 2020 2020 2020 2020  OK',.           
+00014400: 2027 7374 6174 7573 2d63 6f64 6527 3a20   'status-code': 
+00014410: 3230 302c 0a20 2020 2020 2020 2020 2020  200,.           
+00014420: 2027 7479 7065 273a 2027 7379 6e63 272c   'type': 'sync',
+00014430: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+00014440: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+00014450: 6d61 6b65 5f64 6972 2827 2f66 6f6f 2f62  make_dir('/foo/b
+00014460: 6172 2729 0a20 2020 2020 2020 2072 6571  ar').        req
+00014470: 203d 207b 2761 6374 696f 6e27 3a20 276d   = {'action': 'm
+00014480: 616b 652d 6469 7273 272c 2027 6469 7273  ake-dirs', 'dirs
+00014490: 273a 205b 7b0a 2020 2020 2020 2020 2020  ': [{.          
+000144a0: 2020 2770 6174 6827 3a20 272f 666f 6f2f    'path': '/foo/
+000144b0: 6261 7227 2c0a 2020 2020 2020 2020 7d5d  bar',.        }]
+000144c0: 7d0a 2020 2020 2020 2020 7365 6c66 2e61  }.        self.a
+000144d0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+000144e0: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+000144f0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+00014500: 2750 4f53 5427 2c20 272f 7631 2f66 696c  'POST', '/v1/fil
+00014510: 6573 272c 204e 6f6e 652c 2072 6571 292c  es', None, req),
+00014520: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+00014530: 2064 6566 2074 6573 745f 6d61 6b65 5f64   def test_make_d
+00014540: 6972 5f61 6c6c 5f6f 7074 696f 6e73 2873  ir_all_options(s
+00014550: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
+00014560: 6c66 2e63 6c69 656e 742e 7265 7370 6f6e  lf.client.respon
+00014570: 7365 732e 6170 7065 6e64 287b 0a20 2020  ses.append({.   
+00014580: 2020 2020 2020 2020 2022 7265 7375 6c74           "result
+00014590: 223a 205b 7b27 7061 7468 273a 2027 2f66  ": [{'path': '/f
+000145a0: 6f6f 2f62 6172 277d 5d2c 0a20 2020 2020  oo/bar'}],.     
+000145b0: 2020 2020 2020 2027 7374 6174 7573 273a         'status':
+000145c0: 2027 4f4b 272c 0a20 2020 2020 2020 2020   'OK',.         
+000145d0: 2020 2027 7374 6174 7573 2d63 6f64 6527     'status-code'
+000145e0: 3a20 3230 302c 0a20 2020 2020 2020 2020  : 200,.         
+000145f0: 2020 2027 7479 7065 273a 2027 7379 6e63     'type': 'sync
+00014600: 272c 0a20 2020 2020 2020 207d 290a 2020  ',.        }).  
+00014610: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00014620: 742e 6d61 6b65 5f64 6972 2827 2f66 6f6f  t.make_dir('/foo
+00014630: 2f62 6172 272c 206d 616b 655f 7061 7265  /bar', make_pare
+00014640: 6e74 733d 5472 7565 2c20 7065 726d 6973  nts=True, permis
+00014650: 7369 6f6e 733d 306f 3630 302c 0a20 2020  sions=0o600,.   
+00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014670: 2020 2020 2020 2020 2020 7573 6572 5f69            user_i
+00014680: 643d 3132 2c20 7573 6572 3d27 626f 6227  d=12, user='bob'
+00014690: 2c20 6772 6f75 705f 6964 3d33 342c 2067  , group_id=34, g
+000146a0: 726f 7570 3d27 7374 6166 6627 290a 0a20  roup='staff').. 
+000146b0: 2020 2020 2020 2072 6571 203d 207b 2761         req = {'a
+000146c0: 6374 696f 6e27 3a20 276d 616b 652d 6469  ction': 'make-di
+000146d0: 7273 272c 2027 6469 7273 273a 205b 7b0a  rs', 'dirs': [{.
+000146e0: 2020 2020 2020 2020 2020 2020 2770 6174              'pat
+000146f0: 6827 3a20 272f 666f 6f2f 6261 7227 2c0a  h': '/foo/bar',.
+00014700: 2020 2020 2020 2020 2020 2020 276d 616b              'mak
+00014710: 652d 7061 7265 6e74 7327 3a20 5472 7565  e-parents': True
+00014720: 2c0a 2020 2020 2020 2020 2020 2020 2770  ,.            'p
+00014730: 6572 6d69 7373 696f 6e73 273a 2027 3630  ermissions': '60
+00014740: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00014750: 2775 7365 722d 6964 273a 2031 322c 0a20  'user-id': 12,. 
+00014760: 2020 2020 2020 2020 2020 2027 7573 6572             'user
+00014770: 273a 2027 626f 6227 2c0a 2020 2020 2020  ': 'bob',.      
+00014780: 2020 2020 2020 2767 726f 7570 2d69 6427        'group-id'
+00014790: 3a20 3334 2c0a 2020 2020 2020 2020 2020  : 34,.          
+000147a0: 2020 2767 726f 7570 273a 2027 7374 6166    'group': 'staf
+000147b0: 6627 2c0a 2020 2020 2020 2020 7d5d 7d0a  f',.        }]}.
+000147c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000147d0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+000147e0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+000147f0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
+00014800: 4f53 5427 2c20 272f 7631 2f66 696c 6573  OST', '/v1/files
+00014810: 272c 204e 6f6e 652c 2072 6571 292c 0a20  ', None, req),. 
+00014820: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
+00014830: 6566 2074 6573 745f 6d61 6b65 5f64 6972  ef test_make_dir
+00014840: 5f65 7272 6f72 2873 656c 6629 3a0a 2020  _error(self):.  
+00014850: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00014860: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+00014870: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
+00014880: 2022 7265 7375 6c74 223a 205b 7b0a 2020   "result": [{.  
+00014890: 2020 2020 2020 2020 2020 2020 2020 2770                'p
+000148a0: 6174 6827 3a20 272f 666f 6f2f 6261 7227  ath': '/foo/bar'
+000148b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000148c0: 2020 2765 7272 6f72 273a 207b 0a20 2020    'error': {.   
+000148d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148e0: 2027 6b69 6e64 273a 2027 7065 726d 6973   'kind': 'permis
+000148f0: 7369 6f6e 2d64 656e 6965 6427 2c0a 2020  sion-denied',.  
+00014900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014910: 2020 276d 6573 7361 6765 273a 2027 7065    'message': 'pe
+00014920: 726d 6973 7369 6f6e 2064 656e 6965 6427  rmission denied'
+00014930: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014940: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+00014950: 207d 5d2c 0a20 2020 2020 2020 2020 2020   }],.           
+00014960: 2027 7374 6174 7573 273a 2027 4f4b 272c   'status': 'OK',
+00014970: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
+00014980: 6174 7573 2d63 6f64 6527 3a20 3230 302c  atus-code': 200,
+00014990: 0a20 2020 2020 2020 2020 2020 2027 7479  .            'ty
+000149a0: 7065 273a 2027 7379 6e63 272c 0a20 2020  pe': 'sync',.   
+000149b0: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
+000149c0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+000149d0: 5261 6973 6573 2870 6562 626c 652e 5061  Raises(pebble.Pa
+000149e0: 7468 4572 726f 7229 2061 7320 636d 3a0a  thError) as cm:.
+000149f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014a00: 2e63 6c69 656e 742e 6d61 6b65 5f64 6972  .client.make_dir
+00014a10: 2827 2f66 6f6f 2f62 6172 2729 0a20 2020  ('/foo/bar').   
+00014a20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00014a30: 4973 496e 7374 616e 6365 2863 6d2e 6578  IsInstance(cm.ex
+00014a40: 6365 7074 696f 6e2c 2070 6562 626c 652e  ception, pebble.
+00014a50: 4572 726f 7229 0a20 2020 2020 2020 2073  Error).        s
+00014a60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00014a70: 636d 2e65 7863 6570 7469 6f6e 2e6b 696e  cm.exception.kin
+00014a80: 642c 2027 7065 726d 6973 7369 6f6e 2d64  d, 'permission-d
+00014a90: 656e 6965 6427 290a 2020 2020 2020 2020  enied').        
+00014aa0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00014ab0: 2863 6d2e 6578 6365 7074 696f 6e2e 6d65  (cm.exception.me
+00014ac0: 7373 6167 652c 2027 7065 726d 6973 7369  ssage, 'permissi
+00014ad0: 6f6e 2064 656e 6965 6427 290a 0a20 2020  on denied')..   
+00014ae0: 2064 6566 2074 6573 745f 7265 6d6f 7665   def test_remove
+00014af0: 5f70 6174 685f 6261 7369 6328 7365 6c66  _path_basic(self
+00014b00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00014b10: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
+00014b20: 2e61 7070 656e 6428 7b0a 2020 2020 2020  .append({.      
+00014b30: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
+00014b40: 5b7b 2770 6174 6827 3a20 272f 626f 6f2f  [{'path': '/boo/
+00014b50: 6661 7227 7d5d 2c0a 2020 2020 2020 2020  far'}],.        
+00014b60: 2020 2020 2773 7461 7475 7327 3a20 274f      'status': 'O
+00014b70: 4b27 2c0a 2020 2020 2020 2020 2020 2020  K',.            
+00014b80: 2773 7461 7475 732d 636f 6465 273a 2032  'status-code': 2
+00014b90: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00014ba0: 2774 7970 6527 3a20 2773 796e 6327 2c0a  'type': 'sync',.
+00014bb0: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
+00014bc0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+00014bd0: 656d 6f76 655f 7061 7468 2827 2f62 6f6f  emove_path('/boo
+00014be0: 2f66 6172 2729 0a20 2020 2020 2020 2072  /far').        r
+00014bf0: 6571 203d 207b 2761 6374 696f 6e27 3a20  eq = {'action': 
+00014c00: 2772 656d 6f76 6527 2c20 2770 6174 6873  'remove', 'paths
+00014c10: 273a 205b 7b0a 2020 2020 2020 2020 2020  ': [{.          
+00014c20: 2020 2770 6174 6827 3a20 272f 626f 6f2f    'path': '/boo/
+00014c30: 6661 7227 2c0a 2020 2020 2020 2020 7d5d  far',.        }]
+00014c40: 7d0a 2020 2020 2020 2020 7365 6c66 2e61  }.        self.a
+00014c50: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+00014c60: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
+00014c70: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+00014c80: 2750 4f53 5427 2c20 272f 7631 2f66 696c  'POST', '/v1/fil
+00014c90: 6573 272c 204e 6f6e 652c 2072 6571 292c  es', None, req),
+00014ca0: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
+00014cb0: 2064 6566 2074 6573 745f 7265 6d6f 7665   def test_remove
+00014cc0: 5f70 6174 685f 7265 6375 7273 6976 6528  _path_recursive(
+00014cd0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00014ce0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+00014cf0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+00014d00: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+00014d10: 7422 3a20 5b7b 2770 6174 6827 3a20 272f  t": [{'path': '/
+00014d20: 626f 6f2f 6661 7227 7d5d 2c0a 2020 2020  boo/far'}],.    
 00014d30: 2020 2020 2020 2020 2773 7461 7475 7327          'status'
 00014d40: 3a20 274f 4b27 2c0a 2020 2020 2020 2020  : 'OK',.        
 00014d50: 2020 2020 2773 7461 7475 732d 636f 6465      'status-code
 00014d60: 273a 2032 3030 2c0a 2020 2020 2020 2020  ': 200,.        
 00014d70: 2020 2020 2774 7970 6527 3a20 2773 796e      'type': 'syn
 00014d80: 6327 2c0a 2020 2020 2020 2020 7d29 0a20  c',.        }). 
-00014d90: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00014da0: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
-00014db0: 6262 6c65 2e50 6174 6845 7272 6f72 2920  bble.PathError) 
-00014dc0: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00014dd0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
-00014de0: 656d 6f76 655f 7061 7468 2827 2f62 6f6f  emove_path('/boo
-00014df0: 2f66 6172 2729 0a20 2020 2020 2020 2073  /far').        s
-00014e00: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-00014e10: 616e 6365 2863 6d2e 6578 6365 7074 696f  ance(cm.exceptio
-00014e20: 6e2c 2070 6562 626c 652e 4572 726f 7229  n, pebble.Error)
-00014e30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00014e40: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
-00014e50: 6570 7469 6f6e 2e6b 696e 642c 2027 6765  eption.kind, 'ge
-00014e60: 6e65 7269 632d 6669 6c65 2d65 7272 6f72  neric-file-error
-00014e70: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00014e80: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
-00014e90: 7863 6570 7469 6f6e 2e6d 6573 7361 6765  xception.message
-00014ea0: 2c20 2773 6f6d 6520 6f74 6865 7220 6572  , 'some other er
-00014eb0: 726f 7227 290a 0a20 2020 2064 6566 2074  ror')..    def t
-00014ec0: 6573 745f 7365 6e64 5f73 6967 6e61 6c5f  est_send_signal_
-00014ed0: 6e61 6d65 2873 656c 6629 3a0a 2020 2020  name(self):.    
-00014ee0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00014ef0: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
-00014f00: 287b 0a20 2020 2020 2020 2020 2020 2027  ({.            '
-00014f10: 7265 7375 6c74 273a 2054 7275 652c 0a20  result': True,. 
-00014f20: 2020 2020 2020 2020 2020 2027 7374 6174             'stat
-00014f30: 7573 273a 2027 4f4b 272c 0a20 2020 2020  us': 'OK',.     
-00014f40: 2020 2020 2020 2027 7374 6174 7573 2d63         'status-c
-00014f50: 6f64 6527 3a20 3230 302c 0a20 2020 2020  ode': 200,.     
-00014f60: 2020 2020 2020 2027 7479 7065 273a 2027         'type': '
-00014f70: 7379 6e63 272c 0a20 2020 2020 2020 207d  sync',.        }
-00014f80: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00014f90: 636c 6965 6e74 2e73 656e 645f 7369 676e  client.send_sign
-00014fa0: 616c 2827 5349 4748 5550 272c 205b 2773  al('SIGHUP', ['s
-00014fb0: 3127 2c20 2773 3227 5d29 0a0a 2020 2020  1', 's2'])..    
-00014fc0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00014fd0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-00014fe0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-00014ff0: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
-00015000: 2c20 272f 7631 2f73 6967 6e61 6c73 272c  , '/v1/signals',
-00015010: 204e 6f6e 652c 207b 2773 6967 6e61 6c27   None, {'signal'
-00015020: 3a20 2753 4947 4855 5027 2c20 2773 6572  : 'SIGHUP', 'ser
-00015030: 7669 6365 7327 3a20 5b27 7331 272c 2027  vices': ['s1', '
-00015040: 7332 275d 7d29 2c0a 2020 2020 2020 2020  s2']}),.        
-00015050: 5d29 0a0a 2020 2020 4075 6e69 7474 6573  ])..    @unittes
-00015060: 742e 736b 6970 556e 6c65 7373 2868 6173  t.skipUnless(has
-00015070: 6174 7472 2873 6967 6e61 6c2c 2027 5349  attr(signal, 'SI
-00015080: 4748 5550 2729 2c20 2773 6967 6e61 6c20  GHUP'), 'signal 
-00015090: 636f 6e73 7461 6e74 7320 6e6f 7420 7072  constants not pr
-000150a0: 6573 656e 7427 290a 2020 2020 6465 6620  esent').    def 
-000150b0: 7465 7374 5f73 656e 645f 7369 676e 616c  test_send_signal
-000150c0: 5f6e 756d 6265 7228 7365 6c66 293a 0a20  _number(self):. 
-000150d0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-000150e0: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
-000150f0: 656e 6428 7b0a 2020 2020 2020 2020 2020  end({.          
-00015100: 2020 2772 6573 756c 7427 3a20 5472 7565    'result': True
-00015110: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00015120: 7461 7475 7327 3a20 274f 4b27 2c0a 2020  tatus': 'OK',.  
-00015130: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
-00015140: 732d 636f 6465 273a 2032 3030 2c0a 2020  s-code': 200,.  
-00015150: 2020 2020 2020 2020 2020 2774 7970 6527            'type'
-00015160: 3a20 2773 796e 6327 2c0a 2020 2020 2020  : 'sync',.      
-00015170: 2020 7d29 0a0a 2020 2020 2020 2020 7365    })..        se
-00015180: 6c66 2e63 6c69 656e 742e 7365 6e64 5f73  lf.client.send_s
-00015190: 6967 6e61 6c28 7369 676e 616c 2e53 4947  ignal(signal.SIG
-000151a0: 4855 502c 205b 2773 3127 2c20 2773 3227  HUP, ['s1', 's2'
-000151b0: 5d29 0a0a 2020 2020 2020 2020 7365 6c66  ])..        self
-000151c0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-000151d0: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-000151e0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-000151f0: 2028 2750 4f53 5427 2c20 272f 7631 2f73   ('POST', '/v1/s
-00015200: 6967 6e61 6c73 272c 204e 6f6e 652c 207b  ignals', None, {
-00015210: 2773 6967 6e61 6c27 3a20 2753 4947 4855  'signal': 'SIGHU
-00015220: 5027 2c20 2773 6572 7669 6365 7327 3a20  P', 'services': 
-00015230: 5b27 7331 272c 2027 7332 275d 7d29 2c0a  ['s1', 's2']}),.
-00015240: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-00015250: 6465 6620 7465 7374 5f73 656e 645f 7369  def test_send_si
-00015260: 676e 616c 5f74 7970 655f 6572 726f 7228  gnal_type_error(
-00015270: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
-00015280: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00015290: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
-000152a0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000152b0: 6c66 2e63 6c69 656e 742e 7365 6e64 5f73  lf.client.send_s
-000152c0: 6967 6e61 6c28 2753 4947 4855 5027 2c20  ignal('SIGHUP', 
-000152d0: 2773 686f 756c 642d 6265 2d61 2d6c 6973  'should-be-a-lis
-000152e0: 7427 290a 0a20 2020 2020 2020 2077 6974  t')..        wit
-000152f0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00015300: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
-00015310: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015320: 2e63 6c69 656e 742e 7365 6e64 5f73 6967  .client.send_sig
-00015330: 6e61 6c28 2753 4947 4855 5027 2c20 5b31  nal('SIGHUP', [1
-00015340: 2c20 325d 290a 0a20 2020 2064 6566 2074  , 2])..    def t
-00015350: 6573 745f 6765 745f 6368 6563 6b73 5f61  est_get_checks_a
-00015360: 6c6c 2873 656c 6629 3a0a 2020 2020 2020  ll(self):.      
-00015370: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
-00015380: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
-00015390: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-000153a0: 7375 6c74 223a 205b 0a20 2020 2020 2020  sult": [.       
-000153b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000153c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000153d0: 6e61 6d65 223a 2022 6368 6b31 222c 0a20  name": "chk1",. 
-000153e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000153f0: 2020 2022 7374 6174 7573 223a 2022 7570     "status": "up
-00015400: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00015410: 2020 2020 2020 2022 7468 7265 7368 6f6c         "threshol
-00015420: 6422 3a20 322c 0a20 2020 2020 2020 2020  d": 2,.         
-00015430: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00015440: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00015450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015460: 226e 616d 6522 3a20 2263 686b 3222 2c0a  "name": "chk2",.
-00015470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015480: 2020 2020 226c 6576 656c 223a 2022 616c      "level": "al
-00015490: 6976 6522 2c0a 2020 2020 2020 2020 2020  ive",.          
-000154a0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-000154b0: 7322 3a20 2264 6f77 6e22 2c0a 2020 2020  s": "down",.    
-000154c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154d0: 2266 6169 6c75 7265 7322 3a20 352c 0a20  "failures": 5,. 
-000154e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154f0: 2020 2022 7468 7265 7368 6f6c 6422 3a20     "threshold": 
-00015500: 332c 0a20 2020 2020 2020 2020 2020 2020  3,.             
-00015510: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00015520: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-00015530: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
-00015540: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00015550: 7475 732d 636f 6465 223a 2032 3030 2c0a  tus-code": 200,.
-00015560: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
-00015570: 6522 3a20 2273 796e 6322 0a20 2020 2020  e": "sync".     
-00015580: 2020 207d 290a 2020 2020 2020 2020 6368     }).        ch
-00015590: 6563 6b73 203d 2073 656c 662e 636c 6965  ecks = self.clie
-000155a0: 6e74 2e67 6574 5f63 6865 636b 7328 290a  nt.get_checks().
-000155b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000155c0: 6572 7445 7175 616c 286c 656e 2863 6865  ertEqual(len(che
-000155d0: 636b 7329 2c20 3229 0a20 2020 2020 2020  cks), 2).       
-000155e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000155f0: 6c28 6368 6563 6b73 5b30 5d2e 6e61 6d65  l(checks[0].name
-00015600: 2c20 2763 686b 3127 290a 2020 2020 2020  , 'chk1').      
-00015610: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015620: 616c 2863 6865 636b 735b 305d 2e6c 6576  al(checks[0].lev
-00015630: 656c 2c20 7065 6262 6c65 2e43 6865 636b  el, pebble.Check
-00015640: 4c65 7665 6c2e 554e 5345 5429 0a20 2020  Level.UNSET).   
-00015650: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00015660: 4571 7561 6c28 6368 6563 6b73 5b30 5d2e  Equal(checks[0].
-00015670: 7374 6174 7573 2c20 7065 6262 6c65 2e43  status, pebble.C
-00015680: 6865 636b 5374 6174 7573 2e55 5029 0a20  heckStatus.UP). 
-00015690: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000156a0: 7274 4571 7561 6c28 6368 6563 6b73 5b30  rtEqual(checks[0
-000156b0: 5d2e 6661 696c 7572 6573 2c20 3029 0a20  ].failures, 0). 
-000156c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000156d0: 7274 4571 7561 6c28 6368 6563 6b73 5b30  rtEqual(checks[0
-000156e0: 5d2e 7468 7265 7368 6f6c 642c 2032 290a  ].threshold, 2).
-000156f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00015700: 6572 7445 7175 616c 2863 6865 636b 735b  ertEqual(checks[
-00015710: 315d 2e6e 616d 652c 2027 6368 6b32 2729  1].name, 'chk2')
-00015720: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00015730: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
-00015740: 5b31 5d2e 6c65 7665 6c2c 2070 6562 626c  [1].level, pebbl
-00015750: 652e 4368 6563 6b4c 6576 656c 2e41 4c49  e.CheckLevel.ALI
-00015760: 5645 290a 2020 2020 2020 2020 7365 6c66  VE).        self
-00015770: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
-00015780: 636b 735b 315d 2e73 7461 7475 732c 2070  cks[1].status, p
-00015790: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
-000157a0: 732e 444f 574e 290a 2020 2020 2020 2020  s.DOWN).        
-000157b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000157c0: 2863 6865 636b 735b 315d 2e66 6169 6c75  (checks[1].failu
-000157d0: 7265 732c 2035 290a 2020 2020 2020 2020  res, 5).        
-000157e0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000157f0: 2863 6865 636b 735b 315d 2e74 6872 6573  (checks[1].thres
-00015800: 686f 6c64 2c20 3329 0a0a 2020 2020 2020  hold, 3)..      
-00015810: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015820: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-00015830: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-00015840: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-00015850: 2f76 312f 6368 6563 6b73 272c 207b 7d2c  /v1/checks', {},
-00015860: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-00015870: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00015880: 5f67 6574 5f63 6865 636b 735f 6669 6c74  _get_checks_filt
-00015890: 6572 7328 7365 6c66 293a 0a20 2020 2020  ers(self):.     
-000158a0: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
-000158b0: 6573 706f 6e73 6573 2e61 7070 656e 6428  esponses.append(
-000158c0: 7b0a 2020 2020 2020 2020 2020 2020 2272  {.            "r
-000158d0: 6573 756c 7422 3a20 5b0a 2020 2020 2020  esult": [.      
-000158e0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000158f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015900: 226e 616d 6522 3a20 2263 686b 3222 2c0a  "name": "chk2",.
-00015910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015920: 2020 2020 226c 6576 656c 223a 2022 7265      "level": "re
-00015930: 6164 7922 2c0a 2020 2020 2020 2020 2020  ady",.          
-00015940: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-00015950: 7322 3a20 2275 7022 2c0a 2020 2020 2020  s": "up",.      
-00015960: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-00015970: 6872 6573 686f 6c64 223a 2033 2c0a 2020  hreshold": 3,.  
-00015980: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
-00015990: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-000159a0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-000159b0: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
-000159c0: 2020 2020 2020 2020 2273 7461 7475 732d          "status-
-000159d0: 636f 6465 223a 2032 3030 2c0a 2020 2020  code": 200,.    
-000159e0: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
-000159f0: 2273 796e 6322 0a20 2020 2020 2020 207d  "sync".        }
-00015a00: 290a 2020 2020 2020 2020 6368 6563 6b73  ).        checks
-00015a10: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
-00015a20: 6574 5f63 6865 636b 7328 6c65 7665 6c3d  et_checks(level=
-00015a30: 7065 6262 6c65 2e43 6865 636b 4c65 7665  pebble.CheckLeve
-00015a40: 6c2e 5245 4144 592c 206e 616d 6573 3d5b  l.READY, names=[
-00015a50: 2763 686b 3227 5d29 0a20 2020 2020 2020  'chk2']).       
-00015a60: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00015a70: 6c28 6c65 6e28 6368 6563 6b73 292c 2031  l(len(checks), 1
-00015a80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00015a90: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-00015aa0: 735b 305d 2e6e 616d 652c 2027 6368 6b32  s[0].name, 'chk2
-00015ab0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00015ac0: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
-00015ad0: 6b73 5b30 5d2e 6c65 7665 6c2c 2070 6562  ks[0].level, peb
-00015ae0: 626c 652e 4368 6563 6b4c 6576 656c 2e52  ble.CheckLevel.R
-00015af0: 4541 4459 290a 2020 2020 2020 2020 7365  EADY).        se
-00015b00: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00015b10: 6865 636b 735b 305d 2e73 7461 7475 732c  hecks[0].status,
-00015b20: 2070 6562 626c 652e 4368 6563 6b53 7461   pebble.CheckSta
-00015b30: 7475 732e 5550 290a 2020 2020 2020 2020  tus.UP).        
-00015b40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00015b50: 2863 6865 636b 735b 305d 2e66 6169 6c75  (checks[0].failu
-00015b60: 7265 732c 2030 290a 2020 2020 2020 2020  res, 0).        
-00015b70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00015b80: 2863 6865 636b 735b 305d 2e74 6872 6573  (checks[0].thres
-00015b90: 686f 6c64 2c20 3329 0a0a 2020 2020 2020  hold, 3)..      
-00015ba0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015bb0: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-00015bc0: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-00015bd0: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-00015be0: 2f76 312f 6368 6563 6b73 272c 207b 276c  /v1/checks', {'l
-00015bf0: 6576 656c 273a 2027 7265 6164 7927 2c20  evel': 'ready', 
-00015c00: 276e 616d 6573 273a 205b 2763 686b 3227  'names': ['chk2'
-00015c10: 5d7d 2c20 4e6f 6e65 292c 0a20 2020 2020  ]}, None),.     
-00015c20: 2020 205d 290a 0a20 2020 2064 6566 2074     ])..    def t
-00015c30: 6573 745f 6368 6563 6b6c 6576 656c 5f63  est_checklevel_c
-00015c40: 6f6e 7665 7273 696f 6e28 7365 6c66 293a  onversion(self):
-00015c50: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00015c60: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
-00015c70: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
-00015c80: 2020 2020 2272 6573 756c 7422 3a20 5b0a      "result": [.
-00015c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ca0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00015cb0: 2020 2020 2020 226e 616d 6522 3a20 2263        "name": "c
-00015cc0: 686b 3222 2c0a 2020 2020 2020 2020 2020  hk2",.          
-00015cd0: 2020 2020 2020 2020 2020 226c 6576 656c            "level
-00015ce0: 223a 2022 666f 6f62 6172 2122 2c0a 2020  ": "foobar!",.  
-00015cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d00: 2020 2273 7461 7475 7322 3a20 2275 7022    "status": "up"
-00015d10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015d20: 2020 2020 2020 2274 6872 6573 686f 6c64        "threshold
-00015d30: 223a 2033 2c0a 2020 2020 2020 2020 2020  ": 3,.          
-00015d40: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00015d50: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00015d60: 2020 2020 2273 7461 7475 7322 3a20 224f      "status": "O
-00015d70: 4b22 2c0a 2020 2020 2020 2020 2020 2020  K",.            
-00015d80: 2273 7461 7475 732d 636f 6465 223a 2032  "status-code": 2
-00015d90: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00015da0: 2274 7970 6522 3a20 2273 796e 6322 0a20  "type": "sync". 
-00015db0: 2020 2020 2020 207d 290a 2020 2020 2020         }).      
-00015dc0: 2020 6368 6563 6b73 203d 2073 656c 662e    checks = self.
-00015dd0: 636c 6965 6e74 2e67 6574 5f63 6865 636b  client.get_check
-00015de0: 7328 6c65 7665 6c3d 7065 6262 6c65 2e43  s(level=pebble.C
-00015df0: 6865 636b 4c65 7665 6c2e 5245 4144 592c  heckLevel.READY,
-00015e00: 206e 616d 6573 3d5b 2763 686b 3227 5d29   names=['chk2'])
-00015e10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00015e20: 7365 7274 4571 7561 6c28 6c65 6e28 6368  sertEqual(len(ch
-00015e30: 6563 6b73 292c 2031 290a 2020 2020 2020  ecks), 1).      
-00015e40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015e50: 616c 2863 6865 636b 735b 305d 2e6e 616d  al(checks[0].nam
-00015e60: 652c 2027 6368 6b32 2729 0a20 2020 2020  e, 'chk2').     
-00015e70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00015e80: 7561 6c28 6368 6563 6b73 5b30 5d2e 6c65  ual(checks[0].le
-00015e90: 7665 6c2c 2027 666f 6f62 6172 2127 2920  vel, 'foobar!') 
-00015ea0: 2023 2073 7461 7973 2061 2072 6177 2073   # stays a raw s
-00015eb0: 7472 696e 670a 2020 2020 2020 2020 7365  tring.        se
-00015ec0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00015ed0: 6865 636b 735b 305d 2e73 7461 7475 732c  hecks[0].status,
-00015ee0: 2070 6562 626c 652e 4368 6563 6b53 7461   pebble.CheckSta
-00015ef0: 7475 732e 5550 290a 2020 2020 2020 2020  tus.UP).        
-00015f00: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00015f10: 2863 6865 636b 735b 305d 2e66 6169 6c75  (checks[0].failu
-00015f20: 7265 732c 2030 290a 2020 2020 2020 2020  res, 0).        
-00015f30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00015f40: 2863 6865 636b 735b 305d 2e74 6872 6573  (checks[0].thres
-00015f50: 686f 6c64 2c20 3329 0a0a 2020 2020 2020  hold, 3)..      
-00015f60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015f70: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-00015f80: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-00015f90: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-00015fa0: 2f76 312f 6368 6563 6b73 272c 207b 276c  /v1/checks', {'l
-00015fb0: 6576 656c 273a 2027 7265 6164 7927 2c20  evel': 'ready', 
-00015fc0: 276e 616d 6573 273a 205b 2763 686b 3227  'names': ['chk2'
-00015fd0: 5d7d 2c20 4e6f 6e65 292c 0a20 2020 2020  ]}, None),.     
-00015fe0: 2020 205d 290a 0a0a 636c 6173 7320 5465     ])...class Te
-00015ff0: 7374 536f 636b 6574 436c 6965 6e74 2875  stSocketClient(u
-00016000: 6e69 7474 6573 742e 5465 7374 4361 7365  nittest.TestCase
-00016010: 293a 0a20 2020 2064 6566 2074 6573 745f  ):.    def test_
-00016020: 736f 636b 6574 5f6e 6f74 5f66 6f75 6e64  socket_not_found
-00016030: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00016040: 636c 6965 6e74 203d 2070 6562 626c 652e  client = pebble.
-00016050: 436c 6965 6e74 2873 6f63 6b65 745f 7061  Client(socket_pa
-00016060: 7468 3d27 646f 6573 5f6e 6f74 5f65 7869  th='does_not_exi
-00016070: 7374 2729 0a20 2020 2020 2020 2077 6974  st').        wit
-00016080: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00016090: 7365 7328 7065 6262 6c65 2e43 6f6e 6e65  ses(pebble.Conne
-000160a0: 6374 696f 6e45 7272 6f72 2920 6173 2063  ctionError) as c
-000160b0: 6d3a 0a20 2020 2020 2020 2020 2020 2063  m:.            c
-000160c0: 6c69 656e 742e 6765 745f 7379 7374 656d  lient.get_system
-000160d0: 5f69 6e66 6f28 290a 2020 2020 2020 2020  _info().        
-000160e0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-000160f0: 7461 6e63 6528 636d 2e65 7863 6570 7469  tance(cm.excepti
-00016100: 6f6e 2c20 7065 6262 6c65 2e45 7272 6f72  on, pebble.Error
-00016110: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00016120: 7265 616c 5f63 6c69 656e 7428 7365 6c66  real_client(self
-00016130: 293a 0a20 2020 2020 2020 2073 6875 7464  ):.        shutd
-00016140: 6f77 6e2c 2073 6f63 6b65 745f 7061 7468  own, socket_path
-00016150: 203d 2066 616b 655f 7065 6262 6c65 2e73   = fake_pebble.s
-00016160: 7461 7274 5f73 6572 7665 7228 290a 0a20  tart_server().. 
-00016170: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00016180: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-00016190: 2070 6562 626c 652e 436c 6965 6e74 2873   pebble.Client(s
-000161a0: 6f63 6b65 745f 7061 7468 3d73 6f63 6b65  ocket_path=socke
-000161b0: 745f 7061 7468 290a 2020 2020 2020 2020  t_path).        
-000161c0: 2020 2020 696e 666f 203d 2063 6c69 656e      info = clien
-000161d0: 742e 6765 745f 7379 7374 656d 5f69 6e66  t.get_system_inf
-000161e0: 6f28 290a 2020 2020 2020 2020 2020 2020  o().            
-000161f0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016200: 2869 6e66 6f2e 7665 7273 696f 6e2c 2027  (info.version, '
-00016210: 332e 3134 2e31 3539 2729 0a0a 2020 2020  3.14.159')..    
-00016220: 2020 2020 2020 2020 6368 616e 6765 5f69          change_i
-00016230: 6420 3d20 636c 6965 6e74 2e73 7461 7274  d = client.start
-00016240: 5f73 6572 7669 6365 7328 5b27 666f 6f27  _services(['foo'
-00016250: 5d2c 2074 696d 656f 7574 3d30 290a 2020  ], timeout=0).  
-00016260: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00016270: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
-00016280: 655f 6964 2c20 2731 3233 3427 290a 0a20  e_id, '1234').. 
-00016290: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-000162a0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-000162b0: 7328 7065 6262 6c65 2e41 5049 4572 726f  s(pebble.APIErro
-000162c0: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
-000162d0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-000162e0: 2e73 7461 7274 5f73 6572 7669 6365 7328  .start_services(
-000162f0: 5b27 6261 7227 5d2c 2074 696d 656f 7574  ['bar'], timeout
-00016300: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-00016310: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
-00016320: 7461 6e63 6528 636d 2e65 7863 6570 7469  tance(cm.excepti
-00016330: 6f6e 2c20 7065 6262 6c65 2e45 7272 6f72  on, pebble.Error
-00016340: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00016350: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00016360: 6d2e 6578 6365 7074 696f 6e2e 636f 6465  m.exception.code
-00016370: 2c20 3430 3029 0a20 2020 2020 2020 2020  , 400).         
-00016380: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00016390: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
-000163a0: 2e73 7461 7475 732c 2027 4261 6420 5265  .status, 'Bad Re
-000163b0: 7175 6573 7427 290a 2020 2020 2020 2020  quest').        
-000163c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000163d0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
-000163e0: 6e2e 6d65 7373 6167 652c 2027 7365 7276  n.message, 'serv
-000163f0: 6963 6520 2262 6172 2220 646f 6573 206e  ice "bar" does n
-00016400: 6f74 2065 7869 7374 2729 0a0a 2020 2020  ot exist')..    
-00016410: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-00016420: 2020 2020 2020 2020 2073 6875 7464 6f77           shutdow
-00016430: 6e28 290a 0a0a 636c 6173 7320 5465 7374  n()...class Test
-00016440: 4578 6563 4572 726f 7228 756e 6974 7465  ExecError(unitte
-00016450: 7374 2e54 6573 7443 6173 6529 3a0a 2020  st.TestCase):.  
-00016460: 2020 6465 6620 7465 7374 5f69 6e69 7428    def test_init(
-00016470: 7365 6c66 293a 0a20 2020 2020 2020 2065  self):.        e
-00016480: 203d 2070 6562 626c 652e 4578 6563 4572   = pebble.ExecEr
-00016490: 726f 7228 5b27 666f 6f27 5d2c 2034 322c  ror(['foo'], 42,
-000164a0: 2027 6f75 7427 2c20 2765 7272 2729 0a20   'out', 'err'). 
-000164b0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000164c0: 7274 4571 7561 6c28 652e 636f 6d6d 616e  rtEqual(e.comman
-000164d0: 642c 205b 2766 6f6f 275d 290a 2020 2020  d, ['foo']).    
-000164e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000164f0: 7175 616c 2865 2e65 7869 745f 636f 6465  qual(e.exit_code
-00016500: 2c20 3432 290a 2020 2020 2020 2020 7365  , 42).        se
-00016510: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-00016520: 2e73 7464 6f75 742c 2027 6f75 7427 290a  .stdout, 'out').
-00016530: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00016540: 6572 7445 7175 616c 2865 2e73 7464 6572  ertEqual(e.stder
-00016550: 722c 2027 6572 7227 290a 0a20 2020 2064  r, 'err')..    d
-00016560: 6566 2074 6573 745f 7374 7228 7365 6c66  ef test_str(self
-00016570: 293a 0a20 2020 2020 2020 2065 203d 2070  ):.        e = p
-00016580: 6562 626c 652e 4578 6563 4572 726f 7228  ebble.ExecError(
-00016590: 5b27 7827 5d2c 2031 2c20 4e6f 6e65 2c20  ['x'], 1, None, 
-000165a0: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
-000165b0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-000165c0: 7472 2865 292c 2022 6e6f 6e2d 7a65 726f  tr(e), "non-zero
-000165d0: 2065 7869 7420 636f 6465 2031 2065 7865   exit code 1 exe
-000165e0: 6375 7469 6e67 205b 2778 275d 2229 0a0a  cuting ['x']")..
-000165f0: 2020 2020 2020 2020 6520 3d20 7065 6262          e = pebb
-00016600: 6c65 2e45 7865 6345 7272 6f72 285b 2778  le.ExecError(['x
-00016610: 275d 2c20 312c 2027 6f6e 6c79 2d6f 7574  '], 1, 'only-out
-00016620: 272c 204e 6f6e 6529 0a20 2020 2020 2020  ', None).       
-00016630: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00016640: 6c28 7374 7228 6529 2c20 226e 6f6e 2d7a  l(str(e), "non-z
-00016650: 6572 6f20 6578 6974 2063 6f64 6520 3120  ero exit code 1 
-00016660: 6578 6563 7574 696e 6720 5b27 7827 5d2c  executing ['x'],
-00016670: 2073 7464 6f75 743d 276f 6e6c 792d 6f75   stdout='only-ou
-00016680: 7427 2229 0a0a 2020 2020 2020 2020 6520  t'")..        e 
-00016690: 3d20 7065 6262 6c65 2e45 7865 6345 7272  = pebble.ExecErr
-000166a0: 6f72 285b 2778 275d 2c20 312c 204e 6f6e  or(['x'], 1, Non
-000166b0: 652c 2027 6f6e 6c79 2d65 7272 2729 0a20  e, 'only-err'). 
-000166c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000166d0: 7274 4571 7561 6c28 7374 7228 6529 2c20  rtEqual(str(e), 
-000166e0: 226e 6f6e 2d7a 6572 6f20 6578 6974 2063  "non-zero exit c
-000166f0: 6f64 6520 3120 6578 6563 7574 696e 6720  ode 1 executing 
-00016700: 5b27 7827 5d2c 2073 7464 6572 723d 276f  ['x'], stderr='o
-00016710: 6e6c 792d 6572 7227 2229 0a0a 2020 2020  nly-err'")..    
-00016720: 2020 2020 6520 3d20 7065 6262 6c65 2e45      e = pebble.E
-00016730: 7865 6345 7272 6f72 285b 2761 272c 2027  xecError(['a', '
-00016740: 6227 5d2c 2031 2c20 276f 7574 272c 2027  b'], 1, 'out', '
-00016750: 6572 7227 290a 2020 2020 2020 2020 7365  err').        se
-00016760: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00016770: 7472 2865 292c 2022 6e6f 6e2d 7a65 726f  tr(e), "non-zero
-00016780: 2065 7869 7420 636f 6465 2031 2065 7865   exit code 1 exe
-00016790: 6375 7469 6e67 205b 2761 272c 2027 6227  cuting ['a', 'b'
-000167a0: 5d2c 2022 0a20 2020 2020 2020 2020 2020  ], ".           
-000167b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167c0: 2020 2020 2020 2b20 2273 7464 6f75 743d        + "stdout=
-000167d0: 276f 7574 272c 2073 7464 6572 723d 2765  'out', stderr='e
-000167e0: 7272 2722 290a 0a20 2020 2064 6566 2074  rr'")..    def t
-000167f0: 6573 745f 7374 725f 7472 756e 6361 7465  est_str_truncate
-00016800: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00016810: 2065 203d 2070 6562 626c 652e 4578 6563   e = pebble.Exec
-00016820: 4572 726f 7228 5b27 666f 6f27 5d2c 2032  Error(['foo'], 2
-00016830: 2c20 276c 6f6e 676f 7574 272c 2027 6c6f  , 'longout', 'lo
-00016840: 6e67 6572 7227 290a 2020 2020 2020 2020  ngerr').        
-00016850: 652e 5354 525f 4d41 585f 4f55 5450 5554  e.STR_MAX_OUTPUT
-00016860: 203d 2035 0a20 2020 2020 2020 2073 656c   = 5.        sel
-00016870: 662e 6173 7365 7274 4571 7561 6c28 7374  f.assertEqual(st
-00016880: 7228 6529 2c20 226e 6f6e 2d7a 6572 6f20  r(e), "non-zero 
-00016890: 6578 6974 2063 6f64 6520 3220 6578 6563  exit code 2 exec
-000168a0: 7574 696e 6720 5b27 666f 6f27 5d2c 2022  uting ['foo'], "
-000168b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000168c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168d0: 2020 2b20 2273 7464 6f75 743d 276c 6f6e    + "stdout='lon
-000168e0: 676f 2720 5b74 7275 6e63 6174 6564 5d2c  go' [truncated],
-000168f0: 2073 7464 6572 723d 276c 6f6e 6765 2720   stderr='longe' 
-00016900: 5b74 7275 6e63 6174 6564 5d22 290a 0a0a  [truncated]")...
-00016910: 636c 6173 7320 4d6f 636b 5765 6273 6f63  class MockWebsoc
-00016920: 6b65 743a 0a20 2020 2064 6566 205f 5f69  ket:.    def __i
-00016930: 6e69 745f 5f28 7365 6c66 293a 0a20 2020  nit__(self):.   
-00016940: 2020 2020 2073 656c 662e 7365 6e64 7320       self.sends 
-00016950: 3d20 5b5d 0a20 2020 2020 2020 2073 656c  = [].        sel
-00016960: 662e 7265 6365 6976 6573 203d 205b 5d0a  f.receives = [].
-00016970: 0a20 2020 2064 6566 2073 656e 645f 6269  .    def send_bi
-00016980: 6e61 7279 2873 656c 662c 2062 293a 0a20  nary(self, b):. 
-00016990: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-000169a0: 732e 6170 7065 6e64 2828 2742 494e 272c  s.append(('BIN',
-000169b0: 2062 2929 0a0a 2020 2020 6465 6620 7365   b))..    def se
-000169c0: 6e64 2873 656c 662c 2073 293a 0a20 2020  nd(self, s):.   
-000169d0: 2020 2020 2073 656c 662e 7365 6e64 732e       self.sends.
-000169e0: 6170 7065 6e64 2828 2754 5854 272c 2073  append(('TXT', s
-000169f0: 2929 0a0a 2020 2020 6465 6620 7265 6376  ))..    def recv
-00016a00: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00016a10: 7265 7475 726e 2073 656c 662e 7265 6365  return self.rece
-00016a20: 6976 6573 2e70 6f70 2830 290a 0a20 2020  ives.pop(0)..   
-00016a30: 2064 6566 2073 6875 7464 6f77 6e28 7365   def shutdown(se
-00016a40: 6c66 293a 0a20 2020 2020 2020 2070 6173  lf):.        pas
-00016a50: 730a 0a0a 636c 6173 7320 5465 7374 4578  s...class TestEx
-00016a60: 6563 2875 6e69 7474 6573 742e 5465 7374  ec(unittest.Test
-00016a70: 4361 7365 293a 0a20 2020 2064 6566 2073  Case):.    def s
-00016a80: 6574 5570 2873 656c 6629 3a0a 2020 2020  etUp(self):.    
-00016a90: 2020 2020 7365 6c66 2e63 6c69 656e 7420      self.client 
-00016aa0: 3d20 4d6f 636b 436c 6965 6e74 2829 0a20  = MockClient(). 
-00016ab0: 2020 2020 2020 2073 656c 662e 7469 6d65         self.time
-00016ac0: 203d 204d 6f63 6b54 696d 6528 290a 2020   = MockTime().  
-00016ad0: 2020 2020 2020 7469 6d65 5f70 6174 6368        time_patch
-00016ae0: 6572 203d 2075 6e69 7474 6573 742e 6d6f  er = unittest.mo
-00016af0: 636b 2e70 6174 6368 2827 6f70 732e 7065  ck.patch('ops.pe
-00016b00: 6262 6c65 2e74 696d 6527 2c20 7365 6c66  bble.time', self
-00016b10: 2e74 696d 6529 0a20 2020 2020 2020 2074  .time).        t
-00016b20: 696d 655f 7061 7463 6865 722e 7374 6172  ime_patcher.star
-00016b30: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-00016b40: 2e61 6464 436c 6561 6e75 7028 7469 6d65  .addCleanup(time
-00016b50: 5f70 6174 6368 6572 2e73 746f 7029 0a0a  _patcher.stop)..
-00016b60: 2020 2020 6465 6620 6164 645f 7265 7370      def add_resp
-00016b70: 6f6e 7365 7328 7365 6c66 2c20 6368 616e  onses(self, chan
-00016b80: 6765 5f69 642c 2065 7869 745f 636f 6465  ge_id, exit_code
-00016b90: 2c20 6368 616e 6765 5f65 7272 3d4e 6f6e  , change_err=Non
-00016ba0: 6529 3a0a 2020 2020 2020 2020 7461 736b  e):.        task
-00016bb0: 5f69 6420 3d20 6622 547b 6368 616e 6765  _id = f"T{change
-00016bc0: 5f69 647d 2220 2023 2063 7265 6174 6520  _id}"  # create 
-00016bd0: 6120 7461 736b 5f69 6420 6261 7365 6420  a task_id based 
-00016be0: 6f6e 2063 6861 6e67 655f 6964 0a20 2020  on change_id.   
-00016bf0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00016c00: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
-00016c10: 6428 7b0a 2020 2020 2020 2020 2020 2020  d({.            
-00016c20: 2763 6861 6e67 6527 3a20 6368 616e 6765  'change': change
-00016c30: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00016c40: 2027 7265 7375 6c74 273a 207b 2774 6173   'result': {'tas
-00016c50: 6b2d 6964 273a 2074 6173 6b5f 6964 7d2c  k-id': task_id},
-00016c60: 0a20 2020 2020 2020 207d 290a 0a20 2020  .        })..   
-00016c70: 2020 2020 2063 6861 6e67 6520 3d20 6275       change = bu
-00016c80: 696c 645f 6d6f 636b 5f63 6861 6e67 655f  ild_mock_change_
-00016c90: 6469 6374 2863 6861 6e67 655f 6964 290a  dict(change_id).
-00016ca0: 2020 2020 2020 2020 6368 616e 6765 5b27          change['
-00016cb0: 7461 736b 7327 5d5b 305d 5b27 6461 7461  tasks'][0]['data
-00016cc0: 275d 203d 207b 2765 7869 742d 636f 6465  '] = {'exit-code
-00016cd0: 273a 2065 7869 745f 636f 6465 7d0a 2020  ': exit_code}.  
-00016ce0: 2020 2020 2020 6966 2063 6861 6e67 655f        if change_
-00016cf0: 6572 7220 6973 206e 6f74 204e 6f6e 653a  err is not None:
-00016d00: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
-00016d10: 6e67 655b 2765 7272 275d 203d 2063 6861  nge['err'] = cha
-00016d20: 6e67 655f 6572 720a 2020 2020 2020 2020  nge_err.        
-00016d30: 7365 6c66 2e63 6c69 656e 742e 7265 7370  self.client.resp
-00016d40: 6f6e 7365 732e 6170 7065 6e64 287b 0a20  onses.append({. 
-00016d50: 2020 2020 2020 2020 2020 2027 7265 7375             'resu
-00016d60: 6c74 273a 2063 6861 6e67 652c 0a20 2020  lt': change,.   
-00016d70: 2020 2020 207d 290a 0a20 2020 2020 2020       })..       
-00016d80: 2073 7464 696f 203d 204d 6f63 6b57 6562   stdio = MockWeb
-00016d90: 736f 636b 6574 2829 0a20 2020 2020 2020  socket().       
-00016da0: 2073 7464 6572 7220 3d20 4d6f 636b 5765   stderr = MockWe
-00016db0: 6273 6f63 6b65 7428 290a 2020 2020 2020  bsocket().      
-00016dc0: 2020 636f 6e74 726f 6c20 3d20 4d6f 636b    control = Mock
-00016dd0: 5765 6273 6f63 6b65 7428 290a 2020 2020  Websocket().    
-00016de0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00016df0: 7765 6273 6f63 6b65 7473 203d 207b 0a20  websockets = {. 
-00016e00: 2020 2020 2020 2020 2020 2028 7461 736b             (task
-00016e10: 5f69 642c 2027 7374 6469 6f27 293a 2073  _id, 'stdio'): s
-00016e20: 7464 696f 2c0a 2020 2020 2020 2020 2020  tdio,.          
-00016e30: 2020 2874 6173 6b5f 6964 2c20 2773 7464    (task_id, 'std
-00016e40: 6572 7227 293a 2073 7464 6572 722c 0a20  err'): stderr,. 
-00016e50: 2020 2020 2020 2020 2020 2028 7461 736b             (task
-00016e60: 5f69 642c 2027 636f 6e74 726f 6c27 293a  _id, 'control'):
-00016e70: 2063 6f6e 7472 6f6c 2c0a 2020 2020 2020   control,.      
-00016e80: 2020 7d0a 2020 2020 2020 2020 7265 7475    }.        retu
-00016e90: 726e 2028 7374 6469 6f2c 2073 7464 6572  rn (stdio, stder
-00016ea0: 722c 2063 6f6e 7472 6f6c 290a 0a20 2020  r, control)..   
-00016eb0: 2064 6566 2062 7569 6c64 5f65 7865 635f   def build_exec_
-00016ec0: 6461 7461 280a 2020 2020 2020 2020 2020  data(.          
-00016ed0: 2020 7365 6c66 2c20 636f 6d6d 616e 642c    self, command,
-00016ee0: 2065 6e76 6972 6f6e 6d65 6e74 3d4e 6f6e   environment=Non
-00016ef0: 652c 2077 6f72 6b69 6e67 5f64 6972 3d4e  e, working_dir=N
-00016f00: 6f6e 652c 2074 696d 656f 7574 3d4e 6f6e  one, timeout=Non
-00016f10: 652c 0a20 2020 2020 2020 2020 2020 2075  e,.            u
-00016f20: 7365 725f 6964 3d4e 6f6e 652c 2075 7365  ser_id=None, use
-00016f30: 723d 4e6f 6e65 2c20 6772 6f75 705f 6964  r=None, group_id
-00016f40: 3d4e 6f6e 652c 2067 726f 7570 3d4e 6f6e  =None, group=Non
-00016f50: 652c 2063 6f6d 6269 6e65 5f73 7464 6572  e, combine_stder
-00016f60: 723d 4661 6c73 6529 3a0a 2020 2020 2020  r=False):.      
-00016f70: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-00016f80: 2020 2020 2020 2027 636f 6d6d 616e 6427         'command'
-00016f90: 3a20 636f 6d6d 616e 642c 0a20 2020 2020  : command,.     
-00016fa0: 2020 2020 2020 2027 656e 7669 726f 6e6d         'environm
-00016fb0: 656e 7427 3a20 656e 7669 726f 6e6d 656e  ent': environmen
-00016fc0: 7420 6f72 207b 7d2c 0a20 2020 2020 2020  t or {},.       
-00016fd0: 2020 2020 2027 776f 726b 696e 672d 6469       'working-di
-00016fe0: 7227 3a20 776f 726b 696e 675f 6469 722c  r': working_dir,
-00016ff0: 0a20 2020 2020 2020 2020 2020 2027 7469  .            'ti
-00017000: 6d65 6f75 7427 3a20 6627 7b74 696d 656f  meout': f'{timeo
-00017010: 7574 3a2e 3366 7d73 2720 6966 2074 696d  ut:.3f}s' if tim
-00017020: 656f 7574 2069 7320 6e6f 7420 4e6f 6e65  eout is not None
-00017030: 2065 6c73 6520 4e6f 6e65 2c0a 2020 2020   else None,.    
-00017040: 2020 2020 2020 2020 2775 7365 722d 6964          'user-id
-00017050: 273a 2075 7365 725f 6964 2c0a 2020 2020  ': user_id,.    
-00017060: 2020 2020 2020 2020 2775 7365 7227 3a20          'user': 
-00017070: 7573 6572 2c0a 2020 2020 2020 2020 2020  user,.          
-00017080: 2020 2767 726f 7570 2d69 6427 3a20 6772    'group-id': gr
-00017090: 6f75 705f 6964 2c0a 2020 2020 2020 2020  oup_id,.        
-000170a0: 2020 2020 2767 726f 7570 273a 2067 726f      'group': gro
-000170b0: 7570 2c0a 2020 2020 2020 2020 2020 2020  up,.            
-000170c0: 2773 706c 6974 2d73 7464 6572 7227 3a20  'split-stderr': 
-000170d0: 6e6f 7420 636f 6d62 696e 655f 7374 6465  not combine_stde
-000170e0: 7272 2c0a 2020 2020 2020 2020 7d0a 0a20  rr,.        }.. 
-000170f0: 2020 2064 6566 2074 6573 745f 6172 675f     def test_arg_
-00017100: 6572 726f 7273 2873 656c 6629 3a0a 2020  errors(self):.  
-00017110: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00017120: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-00017130: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00017140: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00017150: 2e65 7865 6328 2766 6f6f 2729 0a20 2020  .exec('foo').   
-00017160: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00017170: 7373 6572 7452 6169 7365 7328 5661 6c75  ssertRaises(Valu
-00017180: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00017190: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-000171a0: 2e65 7865 6328 5b5d 290a 2020 2020 2020  .exec([]).      
-000171b0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-000171c0: 7274 5261 6973 6573 2856 616c 7565 4572  rtRaises(ValueEr
-000171d0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-000171e0: 2020 7365 6c66 2e63 6c69 656e 742e 6578    self.client.ex
-000171f0: 6563 285b 2766 6f6f 275d 2c20 7374 6469  ec(['foo'], stdi
-00017200: 6e3d 2773 272c 2065 6e63 6f64 696e 673d  n='s', encoding=
-00017210: 4e6f 6e65 290a 2020 2020 2020 2020 7769  None).        wi
-00017220: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00017230: 6973 6573 2856 616c 7565 4572 726f 7229  ises(ValueError)
-00017240: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00017250: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
-00017260: 2766 6f6f 275d 2c20 7374 6469 6e3d 6227  'foo'], stdin=b'
-00017270: 7327 290a 2020 2020 2020 2020 7769 7468  s').        with
-00017280: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00017290: 6573 2854 7970 6545 7272 6f72 293a 0a20  es(TypeError):. 
-000172a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000172b0: 636c 6965 6e74 2e65 7865 6328 5b27 666f  client.exec(['fo
-000172c0: 6f27 5d2c 2073 7464 696e 3d31 3233 290a  o'], stdin=123).
-000172d0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000172e0: 662e 6173 7365 7274 5261 6973 6573 2856  f.assertRaises(V
-000172f0: 616c 7565 4572 726f 7229 3a0a 2020 2020  alueError):.    
-00017300: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-00017310: 656e 742e 6578 6563 285b 2766 6f6f 275d  ent.exec(['foo']
-00017320: 2c20 7374 646f 7574 3d69 6f2e 5374 7269  , stdout=io.Stri
-00017330: 6e67 494f 2829 2c20 7374 6465 7272 3d69  ngIO(), stderr=i
-00017340: 6f2e 5374 7269 6e67 494f 2829 2c0a 2020  o.StringIO(),.  
-00017350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017360: 2020 2020 2020 2020 2020 2063 6f6d 6269             combi
-00017370: 6e65 5f73 7464 6572 723d 5472 7565 290a  ne_stderr=True).
-00017380: 0a20 2020 2064 6566 2074 6573 745f 6e6f  .    def test_no
-00017390: 5f77 6169 745f 6361 6c6c 2873 656c 6629  _wait_call(self)
-000173a0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-000173b0: 6464 5f72 6573 706f 6e73 6573 2827 3132  dd_responses('12
-000173c0: 3327 2c20 3029 0a20 2020 2020 2020 2077  3', 0).        w
-000173d0: 6974 6820 7365 6c66 2e61 7373 6572 7457  ith self.assertW
-000173e0: 6172 6e73 2852 6573 6f75 7263 6557 6172  arns(ResourceWar
-000173f0: 6e69 6e67 2920 6173 2063 6d3a 0a20 2020  ning) as cm:.   
-00017400: 2020 2020 2020 2020 2070 726f 6365 7373           process
-00017410: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
-00017420: 7865 6328 5b27 7472 7565 275d 290a 2020  xec(['true']).  
-00017430: 2020 2020 2020 2020 2020 6465 6c20 7072            del pr
-00017440: 6f63 6573 730a 2020 2020 2020 2020 7365  ocess.        se
-00017450: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00017460: 7472 2863 6d2e 7761 726e 696e 6729 2c20  tr(cm.warning), 
-00017470: 2745 7865 6350 726f 6365 7373 2069 6e73  'ExecProcess ins
-00017480: 7461 6e63 6520 6761 7262 6167 6520 636f  tance garbage co
-00017490: 6c6c 6563 7465 6420 270a 2020 2020 2020  llected '.      
-000174a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174c0: 2020 2020 2b20 2777 6974 686f 7574 2063      + 'without c
-000174d0: 616c 6c20 746f 2077 6169 7428 2920 6f72  all to wait() or
-000174e0: 2077 6169 745f 6f75 7470 7574 2829 2729   wait_output()')
-000174f0: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
-00017500: 6169 745f 6578 6974 5f7a 6572 6f28 7365  ait_exit_zero(se
-00017510: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00017520: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
-00017530: 2731 3233 272c 2030 290a 0a20 2020 2020  '123', 0)..     
-00017540: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
-00017550: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
-00017560: 7472 7565 275d 290a 2020 2020 2020 2020  true']).        
-00017570: 7365 6c66 2e61 7373 6572 7449 734e 6f74  self.assertIsNot
-00017580: 4e6f 6e65 2870 726f 6365 7373 2e73 7464  None(process.std
-00017590: 6f75 7429 0a20 2020 2020 2020 2073 656c  out).        sel
-000175a0: 662e 6173 7365 7274 4973 4e6f 744e 6f6e  f.assertIsNotNon
-000175b0: 6528 7072 6f63 6573 732e 7374 6465 7272  e(process.stderr
-000175c0: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
-000175d0: 732e 7761 6974 2829 0a0a 2020 2020 2020  s.wait()..      
-000175e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000175f0: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-00017600: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-00017610: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
-00017620: 272f 7631 2f65 7865 6327 2c20 4e6f 6e65  '/v1/exec', None
-00017630: 2c20 7365 6c66 2e62 7569 6c64 5f65 7865  , self.build_exe
-00017640: 635f 6461 7461 285b 2774 7275 6527 5d29  c_data(['true'])
-00017650: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00017660: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
-00017670: 6765 732f 3132 332f 7761 6974 272c 207b  ges/123/wait', {
-00017680: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
-00017690: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
-000176a0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
-000176b0: 2074 6573 745f 7761 6974 5f65 7869 745f   test_wait_exit_
-000176c0: 6e6f 6e7a 6572 6f28 7365 6c66 293a 0a20  nonzero(self):. 
-000176d0: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-000176e0: 7265 7370 6f6e 7365 7328 2734 3536 272c  responses('456',
-000176f0: 2031 290a 0a20 2020 2020 2020 2070 726f   1)..        pro
-00017700: 6365 7373 203d 2073 656c 662e 636c 6965  cess = self.clie
-00017710: 6e74 2e65 7865 6328 5b27 6661 6c73 6527  nt.exec(['false'
-00017720: 5d29 0a20 2020 2020 2020 2077 6974 6820  ]).        with 
-00017730: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00017740: 7328 7065 6262 6c65 2e45 7865 6345 7272  s(pebble.ExecErr
-00017750: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
-00017760: 2020 2020 2020 2070 726f 6365 7373 2e77         process.w
-00017770: 6169 7428 290a 2020 2020 2020 2020 7365  ait().        se
-00017780: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00017790: 6d2e 6578 6365 7074 696f 6e2e 636f 6d6d  m.exception.comm
-000177a0: 616e 642c 205b 2766 616c 7365 275d 290a  and, ['false']).
-000177b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000177c0: 6572 7445 7175 616c 2863 6d2e 6578 6365  ertEqual(cm.exce
-000177d0: 7074 696f 6e2e 6578 6974 5f63 6f64 652c  ption.exit_code,
-000177e0: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
-000177f0: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
-00017800: 6578 6365 7074 696f 6e2e 7374 646f 7574  exception.stdout
-00017810: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-00017820: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00017830: 2863 6d2e 6578 6365 7074 696f 6e2e 7374  (cm.exception.st
-00017840: 6465 7272 2c20 4e6f 6e65 290a 0a20 2020  derr, None)..   
-00017850: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00017860: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
-00017870: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
-00017880: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
-00017890: 272c 2027 2f76 312f 6578 6563 272c 204e  ', '/v1/exec', N
-000178a0: 6f6e 652c 2073 656c 662e 6275 696c 645f  one, self.build_
-000178b0: 6578 6563 5f64 6174 6128 5b27 6661 6c73  exec_data(['fals
-000178c0: 6527 5d29 292c 0a20 2020 2020 2020 2020  e'])),.         
-000178d0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
-000178e0: 6368 616e 6765 732f 3435 362f 7761 6974  changes/456/wait
-000178f0: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
-00017900: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
-00017910: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-00017920: 2064 6566 2074 6573 745f 7761 6974 5f74   def test_wait_t
-00017930: 696d 656f 7574 2873 656c 6629 3a0a 2020  imeout(self):.  
-00017940: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
-00017950: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
-00017960: 3029 0a0a 2020 2020 2020 2020 7072 6f63  0)..        proc
-00017970: 6573 7320 3d20 7365 6c66 2e63 6c69 656e  ess = self.clien
-00017980: 742e 6578 6563 285b 2774 7275 6527 5d2c  t.exec(['true'],
-00017990: 2074 696d 656f 7574 3d32 290a 2020 2020   timeout=2).    
-000179a0: 2020 2020 7072 6f63 6573 732e 7761 6974      process.wait
-000179b0: 2829 0a0a 2020 2020 2020 2020 7365 6c66  ()..        self
-000179c0: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-000179d0: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-000179e0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-000179f0: 2028 2750 4f53 5427 2c20 272f 7631 2f65   ('POST', '/v1/e
-00017a00: 7865 6327 2c20 4e6f 6e65 2c20 7365 6c66  xec', None, self
-00017a10: 2e62 7569 6c64 5f65 7865 635f 6461 7461  .build_exec_data
-00017a20: 285b 2774 7275 6527 5d2c 2074 696d 656f  (['true'], timeo
-00017a30: 7574 3d32 2929 2c0a 2020 2020 2020 2020  ut=2)),.        
-00017a40: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
-00017a50: 2f63 6861 6e67 6573 2f31 3233 2f77 6169  /changes/123/wai
-00017a60: 7427 2c20 7b27 7469 6d65 6f75 7427 3a20  t', {'timeout': 
-00017a70: 2733 2e30 3030 7327 7d2c 204e 6f6e 6529  '3.000s'}, None)
-00017a80: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-00017a90: 2020 6465 6620 7465 7374 5f77 6169 745f    def test_wait_
-00017aa0: 6f74 6865 725f 6172 6773 2873 656c 6629  other_args(self)
-00017ab0: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
-00017ac0: 6464 5f72 6573 706f 6e73 6573 2827 3132  dd_responses('12
-00017ad0: 3327 2c20 3029 0a0a 2020 2020 2020 2020  3', 0)..        
-00017ae0: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
-00017af0: 6c69 656e 742e 6578 6563 280a 2020 2020  lient.exec(.    
-00017b00: 2020 2020 2020 2020 5b27 7472 7565 275d          ['true']
-00017b10: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
-00017b20: 7669 726f 6e6d 656e 743d 7b27 4b31 273a  vironment={'K1':
-00017b30: 2027 5631 272c 2027 4b32 273a 2027 5632   'V1', 'K2': 'V2
-00017b40: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-00017b50: 776f 726b 696e 675f 6469 723d 2757 4427  working_dir='WD'
-00017b60: 2c0a 2020 2020 2020 2020 2020 2020 7573  ,.            us
-00017b70: 6572 5f69 643d 3130 3030 2c0a 2020 2020  er_id=1000,.    
-00017b80: 2020 2020 2020 2020 7573 6572 3d27 626f          user='bo
-00017b90: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00017ba0: 6772 6f75 705f 6964 3d31 3030 302c 0a20  group_id=1000,. 
-00017bb0: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00017bc0: 3d27 7374 6166 6627 2c0a 2020 2020 2020  ='staff',.      
-00017bd0: 2020 290a 2020 2020 2020 2020 7072 6f63    ).        proc
-00017be0: 6573 732e 7761 6974 2829 0a0a 2020 2020  ess.wait()..    
-00017bf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00017c00: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-00017c10: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-00017c20: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
-00017c30: 2c20 272f 7631 2f65 7865 6327 2c20 4e6f  , '/v1/exec', No
-00017c40: 6e65 2c20 7365 6c66 2e62 7569 6c64 5f65  ne, self.build_e
-00017c50: 7865 635f 6461 7461 280a 2020 2020 2020  xec_data(.      
-00017c60: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-00017c70: 643d 5b27 7472 7565 275d 2c0a 2020 2020  d=['true'],.    
-00017c80: 2020 2020 2020 2020 2020 2020 656e 7669              envi
-00017c90: 726f 6e6d 656e 743d 7b27 4b31 273a 2027  ronment={'K1': '
-00017ca0: 5631 272c 2027 4b32 273a 2027 5632 277d  V1', 'K2': 'V2'}
-00017cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017cc0: 2020 776f 726b 696e 675f 6469 723d 2757    working_dir='W
-00017cd0: 4427 2c0a 2020 2020 2020 2020 2020 2020  D',.            
-00017ce0: 2020 2020 7573 6572 5f69 643d 3130 3030      user_id=1000
-00017cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017d00: 2020 7573 6572 3d27 626f 6227 2c0a 2020    user='bob',.  
-00017d10: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00017d20: 6f75 705f 6964 3d31 3030 302c 0a20 2020  oup_id=1000,.   
-00017d30: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00017d40: 7570 3d27 7374 6166 6627 2c0a 2020 2020  up='staff',.    
-00017d50: 2020 2020 2020 2020 2929 2c0a 2020 2020          )),.    
-00017d60: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-00017d70: 272f 7631 2f63 6861 6e67 6573 2f31 3233  '/v1/changes/123
-00017d80: 2f77 6169 7427 2c20 7b27 7469 6d65 6f75  /wait', {'timeou
-00017d90: 7427 3a20 2734 2e30 3030 7327 7d2c 204e  t': '4.000s'}, N
-00017da0: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-00017db0: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
-00017dc0: 6169 745f 6368 616e 6765 5f65 7272 6f72  ait_change_error
-00017dd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00017de0: 7365 6c66 2e61 6464 5f72 6573 706f 6e73  self.add_respons
-00017df0: 6573 2827 3132 3327 2c20 302c 2063 6861  es('123', 0, cha
-00017e00: 6e67 655f 6572 723d 2763 6861 6e67 6520  nge_err='change 
-00017e10: 6572 726f 7221 2729 0a0a 2020 2020 2020  error!')..      
-00017e20: 2020 7072 6f63 6573 7320 3d20 7365 6c66    process = self
-00017e30: 2e63 6c69 656e 742e 6578 6563 285b 2774  .client.exec(['t
-00017e40: 7275 6527 5d29 0a20 2020 2020 2020 2077  rue']).        w
-00017e50: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00017e60: 6169 7365 7328 7065 6262 6c65 2e43 6861  aises(pebble.Cha
-00017e70: 6e67 6545 7272 6f72 2920 6173 2063 6d3a  ngeError) as cm:
-00017e80: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-00017e90: 6365 7373 2e77 6169 7428 290a 2020 2020  cess.wait().    
-00017ea0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00017eb0: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
-00017ec0: 6e2e 6572 722c 2027 6368 616e 6765 2065  n.err, 'change e
-00017ed0: 7272 6f72 2127 290a 2020 2020 2020 2020  rror!').        
-00017ee0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00017ef0: 2863 6d2e 6578 6365 7074 696f 6e2e 6368  (cm.exception.ch
-00017f00: 616e 6765 2e69 642c 2027 3132 3327 290a  ange.id, '123').
-00017f10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00017f20: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
-00017f30: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
-00017f40: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-00017f50: 504f 5354 272c 2027 2f76 312f 6578 6563  POST', '/v1/exec
-00017f60: 272c 204e 6f6e 652c 2073 656c 662e 6275  ', None, self.bu
-00017f70: 696c 645f 6578 6563 5f64 6174 6128 5b27  ild_exec_data(['
-00017f80: 7472 7565 275d 2929 2c0a 2020 2020 2020  true'])),.      
-00017f90: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
-00017fa0: 7631 2f63 6861 6e67 6573 2f31 3233 2f77  v1/changes/123/w
-00017fb0: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
-00017fc0: 3a20 2734 2e30 3030 7327 7d2c 204e 6f6e  : '4.000s'}, Non
-00017fd0: 6529 2c0a 2020 2020 2020 2020 5d29 0a0a  e),.        ])..
-00017fe0: 2020 2020 6465 6620 7465 7374 5f73 656e      def test_sen
-00017ff0: 645f 7369 676e 616c 2873 656c 6629 3a0a  d_signal(self):.
-00018000: 2020 2020 2020 2020 5f2c 205f 2c20 636f          _, _, co
-00018010: 6e74 726f 6c20 3d20 7365 6c66 2e61 6464  ntrol = self.add
-00018020: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
-00018030: 2c20 3029 0a0a 2020 2020 2020 2020 7072  , 0)..        pr
-00018040: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
-00018050: 656e 742e 6578 6563 285b 2773 6572 7665  ent.exec(['serve
-00018060: 7227 5d29 0a20 2020 2020 2020 2070 726f  r']).        pro
-00018070: 6365 7373 2e73 656e 645f 7369 676e 616c  cess.send_signal
-00018080: 2827 5349 4748 5550 2729 0a20 2020 2020  ('SIGHUP').     
-00018090: 2020 206e 756d 5f73 656e 6473 203d 2031     num_sends = 1
-000180a0: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
-000180b0: 7474 7228 7369 676e 616c 2c20 2753 4947  ttr(signal, 'SIG
-000180c0: 4855 5027 293a 0a20 2020 2020 2020 2020  HUP'):.         
-000180d0: 2020 2070 726f 6365 7373 2e73 656e 645f     process.send_
-000180e0: 7369 676e 616c 2831 290a 2020 2020 2020  signal(1).      
-000180f0: 2020 2020 2020 7072 6f63 6573 732e 7365        process.se
-00018100: 6e64 5f73 6967 6e61 6c28 7369 676e 616c  nd_signal(signal
-00018110: 2e53 4947 4855 5029 0a20 2020 2020 2020  .SIGHUP).       
-00018120: 2020 2020 206e 756d 5f73 656e 6473 202b       num_sends +
-00018130: 3d20 320a 0a20 2020 2020 2020 2070 726f  = 2..        pro
-00018140: 6365 7373 2e77 6169 7428 290a 0a20 2020  cess.wait()..   
-00018150: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018160: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
-00018170: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
-00018180: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
-00018190: 272c 2027 2f76 312f 6578 6563 272c 204e  ', '/v1/exec', N
-000181a0: 6f6e 652c 2073 656c 662e 6275 696c 645f  one, self.build_
-000181b0: 6578 6563 5f64 6174 6128 5b27 7365 7276  exec_data(['serv
-000181c0: 6572 275d 2929 2c0a 2020 2020 2020 2020  er'])),.        
-000181d0: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
-000181e0: 2f63 6861 6e67 6573 2f31 3233 2f77 6169  /changes/123/wai
-000181f0: 7427 2c20 7b27 7469 6d65 6f75 7427 3a20  t', {'timeout': 
-00018200: 2734 2e30 3030 7327 7d2c 204e 6f6e 6529  '4.000s'}, None)
-00018210: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-00018220: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00018230: 7445 7175 616c 286c 656e 2863 6f6e 7472  tEqual(len(contr
-00018240: 6f6c 2e73 656e 6473 292c 206e 756d 5f73  ol.sends), num_s
-00018250: 656e 6473 290a 2020 2020 2020 2020 7365  ends).        se
-00018260: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00018270: 6f6e 7472 6f6c 2e73 656e 6473 5b30 5d5b  ontrol.sends[0][
-00018280: 305d 2c20 2754 5854 2729 0a20 2020 2020  0], 'TXT').     
-00018290: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000182a0: 7561 6c28 6a73 6f6e 2e6c 6f61 6473 2863  ual(json.loads(c
-000182b0: 6f6e 7472 6f6c 2e73 656e 6473 5b30 5d5b  ontrol.sends[0][
-000182c0: 315d 292c 0a20 2020 2020 2020 2020 2020  1]),.           
-000182d0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
-000182e0: 636f 6d6d 616e 6427 3a20 2773 6967 6e61  command': 'signa
-000182f0: 6c27 2c20 2773 6967 6e61 6c27 3a20 7b27  l', 'signal': {'
-00018300: 6e61 6d65 273a 2027 5349 4748 5550 277d  name': 'SIGHUP'}
-00018310: 7d29 0a20 2020 2020 2020 2069 6620 6861  }).        if ha
-00018320: 7361 7474 7228 7369 676e 616c 2c20 2753  sattr(signal, 'S
-00018330: 4947 4855 5027 293a 0a20 2020 2020 2020  IGHUP'):.       
-00018340: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018350: 4571 7561 6c28 636f 6e74 726f 6c2e 7365  Equal(control.se
-00018360: 6e64 735b 315d 5b30 5d2c 2027 5458 5427  nds[1][0], 'TXT'
-00018370: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00018380: 6c66 2e61 7373 6572 7445 7175 616c 286a  lf.assertEqual(j
-00018390: 736f 6e2e 6c6f 6164 7328 636f 6e74 726f  son.loads(contro
-000183a0: 6c2e 7365 6e64 735b 315d 5b31 5d29 2c0a  l.sends[1][1]),.
-000183b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183c0: 2020 2020 2020 2020 2020 2020 207b 2763               {'c
-000183d0: 6f6d 6d61 6e64 273a 2027 7369 676e 616c  ommand': 'signal
-000183e0: 272c 2027 7369 676e 616c 273a 207b 276e  ', 'signal': {'n
-000183f0: 616d 6527 3a20 7369 676e 616c 2e53 6967  ame': signal.Sig
-00018400: 6e61 6c73 2831 292e 6e61 6d65 7d7d 290a  nals(1).name}}).
-00018410: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018420: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
-00018430: 7472 6f6c 2e73 656e 6473 5b32 5d5b 305d  trol.sends[2][0]
-00018440: 2c20 2754 5854 2729 0a20 2020 2020 2020  , 'TXT').       
-00018450: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018460: 4571 7561 6c28 6a73 6f6e 2e6c 6f61 6473  Equal(json.loads
-00018470: 2863 6f6e 7472 6f6c 2e73 656e 6473 5b32  (control.sends[2
-00018480: 5d5b 315d 292c 0a20 2020 2020 2020 2020  ][1]),.         
-00018490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184a0: 2020 2020 7b27 636f 6d6d 616e 6427 3a20      {'command': 
-000184b0: 2773 6967 6e61 6c27 2c20 2773 6967 6e61  'signal', 'signa
-000184c0: 6c27 3a20 7b27 6e61 6d65 273a 2027 5349  l': {'name': 'SI
-000184d0: 4748 5550 277d 7d29 0a0a 2020 2020 6465  GHUP'}})..    de
-000184e0: 6620 7465 7374 5f77 6169 745f 6f75 7470  f test_wait_outp
-000184f0: 7574 2873 656c 6629 3a0a 2020 2020 2020  ut(self):.      
-00018500: 2020 7374 6469 6f2c 2073 7464 6572 722c    stdio, stderr,
-00018510: 205f 203d 2073 656c 662e 6164 645f 7265   _ = self.add_re
-00018520: 7370 6f6e 7365 7328 2731 3233 272c 2030  sponses('123', 0
-00018530: 290a 2020 2020 2020 2020 7374 6469 6f2e  ).        stdio.
-00018540: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
-00018550: 6227 5079 7468 6f6e 2033 2e38 2e31 305c  b'Python 3.8.10\
-00018560: 6e27 290a 2020 2020 2020 2020 7374 6469  n').        stdi
-00018570: 6f2e 7265 6365 6976 6573 2e61 7070 656e  o.receives.appen
-00018580: 6428 277b 2263 6f6d 6d61 6e64 223a 2265  d('{"command":"e
-00018590: 6e64 227d 2729 0a20 2020 2020 2020 2073  nd"}').        s
-000185a0: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
-000185b0: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
-000185c0: 223a 2265 6e64 227d 2729 0a0a 2020 2020  ":"end"}')..    
-000185d0: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
-000185e0: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
-000185f0: 2770 7974 686f 6e33 272c 2027 2d2d 7665  'python3', '--ve
-00018600: 7273 696f 6e27 5d29 0a20 2020 2020 2020  rsion']).       
-00018610: 206f 7574 2c20 6572 7220 3d20 7072 6f63   out, err = proc
-00018620: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
-00018630: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00018640: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
-00018650: 2750 7974 686f 6e20 332e 382e 3130 5c6e  'Python 3.8.10\n
-00018660: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00018670: 6173 7365 7274 4571 7561 6c28 6572 722c  assertEqual(err,
-00018680: 2027 2729 0a0a 2020 2020 2020 2020 7365   '')..        se
-00018690: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-000186a0: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-000186b0: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-000186c0: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-000186d0: 2f65 7865 6327 2c20 4e6f 6e65 2c20 7365  /exec', None, se
-000186e0: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
-000186f0: 7461 285b 2770 7974 686f 6e33 272c 2027  ta(['python3', '
-00018700: 2d2d 7665 7273 696f 6e27 5d29 292c 0a20  --version'])),. 
-00018710: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-00018720: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
-00018730: 3132 332f 7761 6974 272c 207b 2774 696d  123/wait', {'tim
-00018740: 656f 7574 273a 2027 342e 3030 3073 277d  eout': '4.000s'}
-00018750: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
-00018760: 205d 290a 2020 2020 2020 2020 7365 6c66   ]).        self
-00018770: 2e61 7373 6572 7445 7175 616c 2873 7464  .assertEqual(std
-00018780: 696f 2e73 656e 6473 2c20 5b5d 290a 0a20  io.sends, []).. 
-00018790: 2020 2064 6566 2074 6573 745f 7761 6974     def test_wait
-000187a0: 5f6f 7574 7075 745f 636f 6d62 696e 655f  _output_combine_
-000187b0: 7374 6465 7272 2873 656c 6629 3a0a 2020  stderr(self):.  
-000187c0: 2020 2020 2020 7374 6469 6f2c 205f 2c20        stdio, _, 
-000187d0: 5f20 3d20 7365 6c66 2e61 6464 5f72 6573  _ = self.add_res
-000187e0: 706f 6e73 6573 2827 3132 3327 2c20 3029  ponses('123', 0)
-000187f0: 0a20 2020 2020 2020 2073 7464 696f 2e72  .        stdio.r
-00018800: 6563 6569 7665 732e 6170 7065 6e64 2862  eceives.append(b
-00018810: 2769 6e76 616c 6964 2074 696d 6520 696e  'invalid time in
-00018820: 7465 7276 616c 5c6e 2729 0a20 2020 2020  terval\n').     
-00018830: 2020 2073 7464 696f 2e72 6563 6569 7665     stdio.receive
-00018840: 732e 6170 7065 6e64 2827 7b22 636f 6d6d  s.append('{"comm
-00018850: 616e 6422 3a22 656e 6422 7d27 290a 0a20  and":"end"}').. 
-00018860: 2020 2020 2020 2070 726f 6365 7373 203d         process =
-00018870: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
-00018880: 6328 5b27 736c 6565 7027 2c20 2778 275d  c(['sleep', 'x']
-00018890: 2c20 636f 6d62 696e 655f 7374 6465 7272  , combine_stderr
-000188a0: 3d54 7275 6529 0a20 2020 2020 2020 206f  =True).        o
-000188b0: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-000188c0: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-000188d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000188e0: 6572 7445 7175 616c 286f 7574 2c20 2769  ertEqual(out, 'i
-000188f0: 6e76 616c 6964 2074 696d 6520 696e 7465  nvalid time inte
-00018900: 7276 616c 5c6e 2729 0a20 2020 2020 2020  rval\n').       
-00018910: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
-00018920: 6e65 2865 7272 290a 2020 2020 2020 2020  ne(err).        
-00018930: 7365 6c66 2e61 7373 6572 7449 734e 6f6e  self.assertIsNon
-00018940: 6528 7072 6f63 6573 732e 7374 6465 7272  e(process.stderr
-00018950: 290a 0a20 2020 2020 2020 2065 7865 635f  )..        exec_
-00018960: 6461 7461 203d 2073 656c 662e 6275 696c  data = self.buil
-00018970: 645f 6578 6563 5f64 6174 6128 5b27 736c  d_exec_data(['sl
-00018980: 6565 7027 2c20 2778 275d 2c20 636f 6d62  eep', 'x'], comb
-00018990: 696e 655f 7374 6465 7272 3d54 7275 6529  ine_stderr=True)
-000189a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000189b0: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
-000189c0: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
-000189d0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-000189e0: 504f 5354 272c 2027 2f76 312f 6578 6563  POST', '/v1/exec
-000189f0: 272c 204e 6f6e 652c 2065 7865 635f 6461  ', None, exec_da
-00018a00: 7461 292c 0a20 2020 2020 2020 2020 2020  ta),.           
-00018a10: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
-00018a20: 616e 6765 732f 3132 332f 7761 6974 272c  anges/123/wait',
-00018a30: 207b 2774 696d 656f 7574 273a 2027 342e   {'timeout': '4.
-00018a40: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
-00018a50: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
-00018a60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00018a70: 616c 2873 7464 696f 2e73 656e 6473 2c20  al(stdio.sends, 
-00018a80: 5b5d 290a 0a20 2020 2064 6566 2074 6573  [])..    def tes
-00018a90: 745f 7761 6974 5f6f 7574 7075 745f 6279  t_wait_output_by
-00018aa0: 7465 7328 7365 6c66 293a 0a20 2020 2020  tes(self):.     
-00018ab0: 2020 2073 7464 696f 2c20 7374 6465 7272     stdio, stderr
-00018ac0: 2c20 5f20 3d20 7365 6c66 2e61 6464 5f72  , _ = self.add_r
-00018ad0: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
-00018ae0: 3029 0a20 2020 2020 2020 2073 7464 696f  0).        stdio
-00018af0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-00018b00: 2862 2750 7974 686f 6e20 332e 382e 3130  (b'Python 3.8.10
-00018b10: 5c6e 2729 0a20 2020 2020 2020 2073 7464  \n').        std
-00018b20: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
-00018b30: 6e64 2827 7b22 636f 6d6d 616e 6422 3a22  nd('{"command":"
-00018b40: 656e 6422 7d27 290a 2020 2020 2020 2020  end"}').        
-00018b50: 7374 6465 7272 2e72 6563 6569 7665 732e  stderr.receives.
-00018b60: 6170 7065 6e64 2827 7b22 636f 6d6d 616e  append('{"comman
-00018b70: 6422 3a22 656e 6422 7d27 290a 0a20 2020  d":"end"}')..   
-00018b80: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
-00018b90: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
-00018ba0: 5b27 7079 7468 6f6e 3327 2c20 272d 2d76  ['python3', '--v
-00018bb0: 6572 7369 6f6e 275d 2c20 656e 636f 6469  ersion'], encodi
-00018bc0: 6e67 3d4e 6f6e 6529 0a20 2020 2020 2020  ng=None).       
-00018bd0: 206f 7574 2c20 6572 7220 3d20 7072 6f63   out, err = proc
-00018be0: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
-00018bf0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00018c00: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
-00018c10: 6227 5079 7468 6f6e 2033 2e38 2e31 305c  b'Python 3.8.10\
-00018c20: 6e27 290a 2020 2020 2020 2020 7365 6c66  n').        self
-00018c30: 2e61 7373 6572 7445 7175 616c 2865 7272  .assertEqual(err
-00018c40: 2c20 6227 2729 0a0a 2020 2020 2020 2020  , b'')..        
-00018c50: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018c60: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
-00018c70: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
-00018c80: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
-00018c90: 7631 2f65 7865 6327 2c20 4e6f 6e65 2c20  v1/exec', None, 
-00018ca0: 7365 6c66 2e62 7569 6c64 5f65 7865 635f  self.build_exec_
-00018cb0: 6461 7461 285b 2770 7974 686f 6e33 272c  data(['python3',
-00018cc0: 2027 2d2d 7665 7273 696f 6e27 5d29 292c   '--version'])),
-00018cd0: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-00018ce0: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
-00018cf0: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
-00018d00: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
-00018d10: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
-00018d20: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
-00018d30: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00018d40: 7464 696f 2e73 656e 6473 2c20 5b5d 290a  tdio.sends, []).
-00018d50: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
-00018d60: 6974 5f6f 7574 7075 745f 6578 6974 5f6e  it_output_exit_n
-00018d70: 6f6e 7a65 726f 2873 656c 6629 3a0a 2020  onzero(self):.  
-00018d80: 2020 2020 2020 7374 6469 6f2c 2073 7464        stdio, std
-00018d90: 6572 722c 205f 203d 2073 656c 662e 6164  err, _ = self.ad
-00018da0: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
-00018db0: 272c 2030 290a 2020 2020 2020 2020 7374  ', 0).        st
-00018dc0: 6469 6f2e 7265 6365 6976 6573 2e61 7070  dio.receives.app
-00018dd0: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
-00018de0: 2265 6e64 227d 2729 0a20 2020 2020 2020  "end"}').       
-00018df0: 2073 7464 6572 722e 7265 6365 6976 6573   stderr.receives
-00018e00: 2e61 7070 656e 6428 6227 6669 6c65 206e  .append(b'file n
-00018e10: 6f74 2066 6f75 6e64 3a20 785c 6e27 290a  ot found: x\n').
-00018e20: 2020 2020 2020 2020 7374 6465 7272 2e72          stderr.r
-00018e30: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
-00018e40: 7b22 636f 6d6d 616e 6422 3a22 656e 6422  {"command":"end"
-00018e50: 7d27 290a 0a20 2020 2020 2020 2070 726f  }')..        pro
-00018e60: 6365 7373 203d 2073 656c 662e 636c 6965  cess = self.clie
-00018e70: 6e74 2e65 7865 6328 5b27 6c73 272c 2027  nt.exec(['ls', '
-00018e80: 7827 5d29 0a20 2020 2020 2020 206f 7574  x']).        out
-00018e90: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
-00018ea0: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
-00018eb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00018ec0: 7445 7175 616c 286f 7574 2c20 2727 290a  tEqual(out, '').
-00018ed0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00018ee0: 6572 7445 7175 616c 2865 7272 2c20 2766  ertEqual(err, 'f
-00018ef0: 696c 6520 6e6f 7420 666f 756e 643a 2078  ile not found: x
-00018f00: 5c6e 2729 0a0a 2020 2020 2020 2020 7365  \n')..        se
-00018f10: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00018f20: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
-00018f30: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
-00018f40: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
-00018f50: 2f65 7865 6327 2c20 4e6f 6e65 2c20 7365  /exec', None, se
-00018f60: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
-00018f70: 7461 285b 276c 7327 2c20 2778 275d 2929  ta(['ls', 'x']))
-00018f80: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-00018f90: 4745 5427 2c20 272f 7631 2f63 6861 6e67  GET', '/v1/chang
-00018fa0: 6573 2f31 3233 2f77 6169 7427 2c20 7b27  es/123/wait', {'
-00018fb0: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
-00018fc0: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
-00018fd0: 2020 2020 5d29 0a20 2020 2020 2020 2073      ]).        s
-00018fe0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00018ff0: 7374 6469 6f2e 7365 6e64 732c 205b 5d29  stdio.sends, [])
-00019000: 0a0a 2020 2020 6465 6620 7465 7374 5f77  ..    def test_w
-00019010: 6169 745f 6f75 7470 7574 5f65 7869 745f  ait_output_exit_
-00019020: 6e6f 6e7a 6572 6f5f 636f 6d62 696e 655f  nonzero_combine_
-00019030: 7374 6465 7272 2873 656c 6629 3a0a 2020  stderr(self):.  
-00019040: 2020 2020 2020 7374 6469 6f2c 205f 2c20        stdio, _, 
-00019050: 5f20 3d20 7365 6c66 2e61 6464 5f72 6573  _ = self.add_res
-00019060: 706f 6e73 6573 2827 3132 3327 2c20 3029  ponses('123', 0)
-00019070: 0a20 2020 2020 2020 2073 7464 696f 2e72  .        stdio.r
-00019080: 6563 6569 7665 732e 6170 7065 6e64 2862  eceives.append(b
-00019090: 2766 696c 6520 6e6f 7420 666f 756e 643a  'file not found:
-000190a0: 2078 5c6e 2729 0a20 2020 2020 2020 2073   x\n').        s
-000190b0: 7464 696f 2e72 6563 6569 7665 732e 6170  tdio.receives.ap
-000190c0: 7065 6e64 2827 7b22 636f 6d6d 616e 6422  pend('{"command"
-000190d0: 3a22 656e 6422 7d27 290a 0a20 2020 2020  :"end"}')..     
-000190e0: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
-000190f0: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
-00019100: 6c73 272c 2027 7827 5d2c 2063 6f6d 6269  ls', 'x'], combi
-00019110: 6e65 5f73 7464 6572 723d 5472 7565 290a  ne_stderr=True).
-00019120: 2020 2020 2020 2020 6f75 742c 2065 7272          out, err
-00019130: 203d 2070 726f 6365 7373 2e77 6169 745f   = process.wait_
-00019140: 6f75 7470 7574 2829 0a20 2020 2020 2020  output().       
-00019150: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00019160: 6c28 6f75 742c 2027 6669 6c65 206e 6f74  l(out, 'file not
-00019170: 2066 6f75 6e64 3a20 785c 6e27 290a 2020   found: x\n').  
-00019180: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00019190: 7449 734e 6f6e 6528 6572 7229 0a0a 2020  tIsNone(err)..  
-000191a0: 2020 2020 2020 6578 6563 5f64 6174 6120        exec_data 
-000191b0: 3d20 7365 6c66 2e62 7569 6c64 5f65 7865  = self.build_exe
-000191c0: 635f 6461 7461 285b 276c 7327 2c20 2778  c_data(['ls', 'x
-000191d0: 275d 2c20 636f 6d62 696e 655f 7374 6465  '], combine_stde
-000191e0: 7272 3d54 7275 6529 0a20 2020 2020 2020  rr=True).       
-000191f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00019200: 6c28 7365 6c66 2e63 6c69 656e 742e 7265  l(self.client.re
-00019210: 7175 6573 7473 2c20 5b0a 2020 2020 2020  quests, [.      
-00019220: 2020 2020 2020 2827 504f 5354 272c 2027        ('POST', '
-00019230: 2f76 312f 6578 6563 272c 204e 6f6e 652c  /v1/exec', None,
-00019240: 2065 7865 635f 6461 7461 292c 0a20 2020   exec_data),.   
-00019250: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
-00019260: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
-00019270: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
-00019280: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
-00019290: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
-000192a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000192b0: 7373 6572 7445 7175 616c 2873 7464 696f  ssertEqual(stdio
-000192c0: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
-000192d0: 2064 6566 2074 6573 745f 7761 6974 5f6f   def test_wait_o
-000192e0: 7574 7075 745f 7365 6e64 5f73 7464 696e  utput_send_stdin
-000192f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00019300: 7374 6469 6f2c 2073 7464 6572 722c 205f  stdio, stderr, _
-00019310: 203d 2073 656c 662e 6164 645f 7265 7370   = self.add_resp
-00019320: 6f6e 7365 7328 2731 3233 272c 2030 290a  onses('123', 0).
-00019330: 2020 2020 2020 2020 7374 6469 6f2e 7265          stdio.re
-00019340: 6365 6976 6573 2e61 7070 656e 6428 6227  ceives.append(b'
-00019350: 464f 4f5c 6e42 4152 5c6e 2729 0a20 2020  FOO\nBAR\n').   
-00019360: 2020 2020 2073 7464 696f 2e72 6563 6569       stdio.recei
-00019370: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
-00019380: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
-00019390: 2020 2020 2020 2020 7374 6465 7272 2e72          stderr.r
-000193a0: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
-000193b0: 7b22 636f 6d6d 616e 6422 3a22 656e 6422  {"command":"end"
-000193c0: 7d27 290a 0a20 2020 2020 2020 2070 726f  }')..        pro
-000193d0: 6365 7373 203d 2073 656c 662e 636c 6965  cess = self.clie
-000193e0: 6e74 2e65 7865 6328 5b27 6177 6b27 2c20  nt.exec(['awk', 
-000193f0: 277b 2070 7269 6e74 2074 6f75 7070 6572  '{ print toupper
-00019400: 2824 2920 7d27 5d2c 2073 7464 696e 3d27  ($) }'], stdin='
-00019410: 666f 6f5c 6e62 6172 5c6e 2729 0a20 2020  foo\nbar\n').   
-00019420: 2020 2020 206f 7574 2c20 6572 7220 3d20       out, err = 
-00019430: 7072 6f63 6573 732e 7761 6974 5f6f 7574  process.wait_out
-00019440: 7075 7428 290a 2020 2020 2020 2020 7365  put().        se
-00019450: 6c66 2e61 7373 6572 7445 7175 616c 286f  lf.assertEqual(o
-00019460: 7574 2c20 2746 4f4f 5c6e 4241 525c 6e27  ut, 'FOO\nBAR\n'
-00019470: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00019480: 7373 6572 7445 7175 616c 2865 7272 2c20  ssertEqual(err, 
-00019490: 2727 290a 0a20 2020 2020 2020 2073 656c  '')..        sel
-000194a0: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-000194b0: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
-000194c0: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-000194d0: 2020 2827 504f 5354 272c 2027 2f76 312f    ('POST', '/v1/
-000194e0: 6578 6563 272c 204e 6f6e 652c 2073 656c  exec', None, sel
-000194f0: 662e 6275 696c 645f 6578 6563 5f64 6174  f.build_exec_dat
-00019500: 6128 5b27 6177 6b27 2c20 277b 2070 7269  a(['awk', '{ pri
-00019510: 6e74 2074 6f75 7070 6572 2824 2920 7d27  nt toupper($) }'
-00019520: 5d29 292c 0a20 2020 2020 2020 2020 2020  ])),.           
-00019530: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
-00019540: 616e 6765 732f 3132 332f 7761 6974 272c  anges/123/wait',
-00019550: 207b 2774 696d 656f 7574 273a 2027 342e   {'timeout': '4.
-00019560: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
-00019570: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
-00019580: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00019590: 616c 2873 7464 696f 2e73 656e 6473 2c20  al(stdio.sends, 
-000195a0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-000195b0: 4249 4e27 2c20 6227 666f 6f5c 6e62 6172  BIN', b'foo\nbar
-000195c0: 5c6e 2729 2c0a 2020 2020 2020 2020 2020  \n'),.          
-000195d0: 2020 2827 5458 5427 2c20 277b 2263 6f6d    ('TXT', '{"com
-000195e0: 6d61 6e64 223a 2265 6e64 227d 2729 2c0a  mand":"end"}'),.
-000195f0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-00019600: 6465 6620 7465 7374 5f77 6169 745f 6f75  def test_wait_ou
-00019610: 7470 7574 5f73 656e 645f 7374 6469 6e5f  tput_send_stdin_
-00019620: 6279 7465 7328 7365 6c66 293a 0a20 2020  bytes(self):.   
-00019630: 2020 2020 2073 7464 696f 2c20 7374 6465       stdio, stde
-00019640: 7272 2c20 5f20 3d20 7365 6c66 2e61 6464  rr, _ = self.add
-00019650: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
-00019660: 2c20 3029 0a20 2020 2020 2020 2073 7464  , 0).        std
-00019670: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
-00019680: 6e64 2862 2746 4f4f 5c6e 4241 525c 6e27  nd(b'FOO\nBAR\n'
-00019690: 290a 2020 2020 2020 2020 7374 6469 6f2e  ).        stdio.
-000196a0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
-000196b0: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
-000196c0: 227d 2729 0a20 2020 2020 2020 2073 7464  "}').        std
-000196d0: 6572 722e 7265 6365 6976 6573 2e61 7070  err.receives.app
-000196e0: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
-000196f0: 2265 6e64 227d 2729 0a0a 2020 2020 2020  "end"}')..      
-00019700: 2020 7072 6f63 6573 7320 3d20 7365 6c66    process = self
-00019710: 2e63 6c69 656e 742e 6578 6563 285b 2761  .client.exec(['a
-00019720: 776b 272c 2027 7b20 7072 696e 7420 746f  wk', '{ print to
-00019730: 7570 7065 7228 2429 207d 275d 2c20 7374  upper($) }'], st
-00019740: 6469 6e3d 6227 666f 6f5c 6e62 6172 5c6e  din=b'foo\nbar\n
-00019750: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00019760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019770: 2020 2020 2020 656e 636f 6469 6e67 3d4e        encoding=N
-00019780: 6f6e 6529 0a20 2020 2020 2020 206f 7574  one).        out
-00019790: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
-000197a0: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
-000197b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000197c0: 7445 7175 616c 286f 7574 2c20 6227 464f  tEqual(out, b'FO
-000197d0: 4f5c 6e42 4152 5c6e 2729 0a20 2020 2020  O\nBAR\n').     
-000197e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000197f0: 7561 6c28 6572 722c 2062 2727 290a 0a20  ual(err, b'').. 
-00019800: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00019810: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
-00019820: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
-00019830: 2020 2020 2020 2020 2020 2020 2827 504f              ('PO
-00019840: 5354 272c 2027 2f76 312f 6578 6563 272c  ST', '/v1/exec',
-00019850: 204e 6f6e 652c 2073 656c 662e 6275 696c   None, self.buil
-00019860: 645f 6578 6563 5f64 6174 6128 5b27 6177  d_exec_data(['aw
-00019870: 6b27 2c20 277b 2070 7269 6e74 2074 6f75  k', '{ print tou
-00019880: 7070 6572 2824 2920 7d27 5d29 292c 0a20  pper($) }'])),. 
-00019890: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
-000198a0: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
-000198b0: 3132 332f 7761 6974 272c 207b 2774 696d  123/wait', {'tim
-000198c0: 656f 7574 273a 2027 342e 3030 3073 277d  eout': '4.000s'}
-000198d0: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
-000198e0: 205d 290a 2020 2020 2020 2020 7365 6c66   ]).        self
-000198f0: 2e61 7373 6572 7445 7175 616c 2873 7464  .assertEqual(std
-00019900: 696f 2e73 656e 6473 2c20 5b0a 2020 2020  io.sends, [.    
-00019910: 2020 2020 2020 2020 2827 4249 4e27 2c20          ('BIN', 
-00019920: 6227 666f 6f5c 6e62 6172 5c6e 2729 2c0a  b'foo\nbar\n'),.
-00019930: 2020 2020 2020 2020 2020 2020 2827 5458              ('TX
-00019940: 5427 2c20 277b 2263 6f6d 6d61 6e64 223a  T', '{"command":
-00019950: 2265 6e64 227d 2729 2c0a 2020 2020 2020  "end"}'),.      
-00019960: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
-00019970: 7374 5f77 6169 745f 6f75 7470 7574 5f62  st_wait_output_b
-00019980: 6164 5f63 6f6d 6d61 6e64 2873 656c 6629  ad_command(self)
-00019990: 3a0a 2020 2020 2020 2020 7374 6469 6f2c  :.        stdio,
-000199a0: 2073 7464 6572 722c 205f 203d 2073 656c   stderr, _ = sel
-000199b0: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
-000199c0: 2731 3233 272c 2030 290a 2020 2020 2020  '123', 0).      
-000199d0: 2020 7374 6469 6f2e 7265 6365 6976 6573    stdio.receives
-000199e0: 2e61 7070 656e 6428 6227 5079 7468 6f6e  .append(b'Python
-000199f0: 2033 2e38 2e31 305c 6e27 290a 2020 2020   3.8.10\n').    
-00019a00: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
-00019a10: 6573 2e61 7070 656e 6428 276e 6f74 206a  es.append('not j
-00019a20: 736f 6e27 2920 2023 2062 6164 204a 534f  son')  # bad JSO
-00019a30: 4e20 7368 6f75 6c64 2062 6520 6967 6e6f  N should be igno
-00019a40: 7265 640a 2020 2020 2020 2020 7374 6469  red.        stdi
-00019a50: 6f2e 7265 6365 6976 6573 2e61 7070 656e  o.receives.appen
-00019a60: 6428 277b 2263 6f6d 6d61 6e64 223a 2266  d('{"command":"f
-00019a70: 6f6f 227d 2729 2020 2320 756e 6b6e 6f77  oo"}')  # unknow
-00019a80: 6e20 636f 6d6d 616e 6420 7368 6f75 6c64  n command should
-00019a90: 2062 6520 6967 6e6f 7265 640a 2020 2020   be ignored.    
-00019aa0: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
-00019ab0: 6573 2e61 7070 656e 6428 277b 2263 6f6d  es.append('{"com
-00019ac0: 6d61 6e64 223a 2265 6e64 227d 2729 0a20  mand":"end"}'). 
-00019ad0: 2020 2020 2020 2073 7464 6572 722e 7265         stderr.re
-00019ae0: 6365 6976 6573 2e61 7070 656e 6428 277b  ceives.append('{
-00019af0: 2263 6f6d 6d61 6e64 223a 2265 6e64 227d  "command":"end"}
-00019b00: 2729 0a0a 2020 2020 2020 2020 7769 7468  ')..        with
-00019b10: 2073 656c 662e 6173 7365 7274 4c6f 6773   self.assertLogs
-00019b20: 2827 6f70 732e 7065 6262 6c65 272c 206c  ('ops.pebble', l
-00019b30: 6576 656c 3d27 5741 524e 494e 4727 2920  evel='WARNING') 
-00019b40: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00019b50: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
-00019b60: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
-00019b70: 7079 7468 6f6e 3327 2c20 272d 2d76 6572  python3', '--ver
-00019b80: 7369 6f6e 275d 290a 2020 2020 2020 2020  sion']).        
-00019b90: 2020 2020 6f75 742c 2065 7272 203d 2070      out, err = p
-00019ba0: 726f 6365 7373 2e77 6169 745f 6f75 7470  rocess.wait_outp
-00019bb0: 7574 2829 0a20 2020 2020 2020 2073 656c  ut().        sel
-00019bc0: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
-00019bd0: 2e6f 7574 7075 742c 205b 0a20 2020 2020  .output, [.     
-00019be0: 2020 2020 2020 2022 5741 524e 494e 473a         "WARNING:
-00019bf0: 6f70 732e 7065 6262 6c65 3a43 616e 6e6f  ops.pebble:Canno
-00019c00: 7420 6465 636f 6465 2049 2f4f 2063 6f6d  t decode I/O com
-00019c10: 6d61 6e64 2028 696e 7661 6c69 6420 4a53  mand (invalid JS
-00019c20: 4f4e 2922 2c0a 2020 2020 2020 2020 2020  ON)",.          
-00019c30: 2020 2257 4152 4e49 4e47 3a6f 7073 2e70    "WARNING:ops.p
-00019c40: 6562 626c 653a 496e 7661 6c69 6420 492f  ebble:Invalid I/
-00019c50: 4f20 636f 6d6d 616e 6420 2766 6f6f 2722  O command 'foo'"
-00019c60: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
-00019c70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00019c80: 7445 7175 616c 286f 7574 2c20 2750 7974  tEqual(out, 'Pyt
-00019c90: 686f 6e20 332e 382e 3130 5c6e 2729 0a20  hon 3.8.10\n'). 
-00019ca0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00019cb0: 7274 4571 7561 6c28 6572 722c 2027 2729  rtEqual(err, '')
-00019cc0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00019cd0: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
-00019ce0: 636c 6965 6e74 2e72 6571 7565 7374 732c  client.requests,
-00019cf0: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-00019d00: 2750 4f53 5427 2c20 272f 7631 2f65 7865  'POST', '/v1/exe
-00019d10: 6327 2c20 4e6f 6e65 2c20 7365 6c66 2e62  c', None, self.b
-00019d20: 7569 6c64 5f65 7865 635f 6461 7461 285b  uild_exec_data([
-00019d30: 2770 7974 686f 6e33 272c 2027 2d2d 7665  'python3', '--ve
-00019d40: 7273 696f 6e27 5d29 292c 0a20 2020 2020  rsion'])),.     
-00019d50: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-00019d60: 2f76 312f 6368 616e 6765 732f 3132 332f  /v1/changes/123/
-00019d70: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
-00019d80: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
-00019d90: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-00019da0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00019db0: 6572 7445 7175 616c 2873 7464 696f 2e73  ertEqual(stdio.s
-00019dc0: 656e 6473 2c20 5b5d 290a 0a20 2020 2064  ends, [])..    d
-00019dd0: 6566 2074 6573 745f 7761 6974 5f70 6173  ef test_wait_pas
-00019de0: 7365 645f 6f75 7470 7574 2873 656c 6629  sed_output(self)
-00019df0: 3a0a 2020 2020 2020 2020 696f 5f77 732c  :.        io_ws,
-00019e00: 2073 7464 6572 722c 205f 203d 2073 656c   stderr, _ = sel
-00019e10: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
-00019e20: 2731 3233 272c 2030 290a 2020 2020 2020  '123', 0).      
-00019e30: 2020 696f 5f77 732e 7265 6365 6976 6573    io_ws.receives
-00019e40: 2e61 7070 656e 6428 6227 666f 6f5c 6e27  .append(b'foo\n'
-00019e50: 290a 2020 2020 2020 2020 696f 5f77 732e  ).        io_ws.
-00019e60: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
-00019e70: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
-00019e80: 227d 2729 0a20 2020 2020 2020 2073 7464  "}').        std
-00019e90: 6572 722e 7265 6365 6976 6573 2e61 7070  err.receives.app
-00019ea0: 656e 6428 6227 736f 6d65 2065 7272 6f72  end(b'some error
-00019eb0: 5c6e 2729 0a20 2020 2020 2020 2073 7464  \n').        std
-00019ec0: 6572 722e 7265 6365 6976 6573 2e61 7070  err.receives.app
-00019ed0: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
-00019ee0: 2265 6e64 227d 2729 0a0a 2020 2020 2020  "end"}')..      
-00019ef0: 2020 6f75 7420 3d20 696f 2e53 7472 696e    out = io.Strin
-00019f00: 6749 4f28 290a 2020 2020 2020 2020 6572  gIO().        er
-00019f10: 7220 3d20 696f 2e53 7472 696e 6749 4f28  r = io.StringIO(
-00019f20: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
-00019f30: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
-00019f40: 6578 6563 285b 2765 6368 6f27 2c20 2766  exec(['echo', 'f
-00019f50: 6f6f 275d 2c20 7374 646f 7574 3d6f 7574  oo'], stdout=out
-00019f60: 2c20 7374 6465 7272 3d65 7272 290a 2020  , stderr=err).  
-00019f70: 2020 2020 2020 7072 6f63 6573 732e 7761        process.wa
-00019f80: 6974 2829 0a20 2020 2020 2020 2073 656c  it().        sel
-00019f90: 662e 6173 7365 7274 4571 7561 6c28 6f75  f.assertEqual(ou
-00019fa0: 742e 6765 7476 616c 7565 2829 2c20 2766  t.getvalue(), 'f
-00019fb0: 6f6f 5c6e 2729 0a20 2020 2020 2020 2073  oo\n').        s
-00019fc0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00019fd0: 6572 722e 6765 7476 616c 7565 2829 2c20  err.getvalue(), 
-00019fe0: 2773 6f6d 6520 6572 726f 725c 6e27 290a  'some error\n').
-00019ff0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a000: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
-0001a010: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
-0001a020: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
-0001a030: 504f 5354 272c 2027 2f76 312f 6578 6563  POST', '/v1/exec
-0001a040: 272c 204e 6f6e 652c 2073 656c 662e 6275  ', None, self.bu
-0001a050: 696c 645f 6578 6563 5f64 6174 6128 5b27  ild_exec_data(['
-0001a060: 6563 686f 272c 2027 666f 6f27 5d29 292c  echo', 'foo'])),
-0001a070: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
-0001a080: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
-0001a090: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
-0001a0a0: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
-0001a0b0: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
-0001a0c0: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
-0001a0d0: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-0001a0e0: 6f5f 7773 2e73 656e 6473 2c20 5b5d 290a  o_ws.sends, []).
-0001a0f0: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
-0001a100: 6974 5f70 6173 7365 645f 6f75 7470 7574  it_passed_output
-0001a110: 5f63 6f6d 6269 6e65 5f73 7464 6572 7228  _combine_stderr(
-0001a120: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-0001a130: 6f5f 7773 2c20 5f2c 205f 203d 2073 656c  o_ws, _, _ = sel
-0001a140: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
-0001a150: 2731 3233 272c 2030 290a 2020 2020 2020  '123', 0).      
-0001a160: 2020 696f 5f77 732e 7265 6365 6976 6573    io_ws.receives
-0001a170: 2e61 7070 656e 6428 6227 666f 6f5c 6e27  .append(b'foo\n'
-0001a180: 290a 2020 2020 2020 2020 696f 5f77 732e  ).        io_ws.
-0001a190: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
-0001a1a0: 6227 736f 6d65 2065 7272 6f72 5c6e 2729  b'some error\n')
-0001a1b0: 0a20 2020 2020 2020 2069 6f5f 7773 2e72  .        io_ws.r
-0001a1c0: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
-0001a1d0: 7b22 636f 6d6d 616e 6422 3a22 656e 6422  {"command":"end"
-0001a1e0: 7d27 290a 0a20 2020 2020 2020 206f 7574  }')..        out
-0001a1f0: 203d 2069 6f2e 5374 7269 6e67 494f 2829   = io.StringIO()
-0001a200: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-0001a210: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
-0001a220: 7865 6328 5b27 6563 686f 272c 2027 666f  xec(['echo', 'fo
-0001a230: 6f27 5d2c 2073 7464 6f75 743d 6f75 742c  o'], stdout=out,
-0001a240: 2063 6f6d 6269 6e65 5f73 7464 6572 723d   combine_stderr=
-0001a250: 5472 7565 290a 2020 2020 2020 2020 7072  True).        pr
-0001a260: 6f63 6573 732e 7761 6974 2829 0a20 2020  ocess.wait().   
-0001a270: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001a280: 4571 7561 6c28 6f75 742e 6765 7476 616c  Equal(out.getval
-0001a290: 7565 2829 2c20 2766 6f6f 5c6e 736f 6d65  ue(), 'foo\nsome
-0001a2a0: 2065 7272 6f72 5c6e 2729 0a20 2020 2020   error\n').     
-0001a2b0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001a2c0: 4e6f 6e65 2870 726f 6365 7373 2e73 7464  None(process.std
-0001a2d0: 6572 7229 0a0a 2020 2020 2020 2020 6578  err)..        ex
-0001a2e0: 6563 5f64 6174 6120 3d20 7365 6c66 2e62  ec_data = self.b
-0001a2f0: 7569 6c64 5f65 7865 635f 6461 7461 285b  uild_exec_data([
-0001a300: 2765 6368 6f27 2c20 2766 6f6f 275d 2c20  'echo', 'foo'], 
-0001a310: 636f 6d62 696e 655f 7374 6465 7272 3d54  combine_stderr=T
-0001a320: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-0001a330: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
-0001a340: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
-0001a350: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
-0001a360: 2020 2827 504f 5354 272c 2027 2f76 312f    ('POST', '/v1/
-0001a370: 6578 6563 272c 204e 6f6e 652c 2065 7865  exec', None, exe
-0001a380: 635f 6461 7461 292c 0a20 2020 2020 2020  c_data),.       
-0001a390: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
-0001a3a0: 312f 6368 616e 6765 732f 3132 332f 7761  1/changes/123/wa
-0001a3b0: 6974 272c 207b 2774 696d 656f 7574 273a  it', {'timeout':
-0001a3c0: 2027 342e 3030 3073 277d 2c20 4e6f 6e65   '4.000s'}, None
-0001a3d0: 292c 0a20 2020 2020 2020 205d 290a 2020  ),.        ]).  
-0001a3e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001a3f0: 7445 7175 616c 2869 6f5f 7773 2e73 656e  tEqual(io_ws.sen
-0001a400: 6473 2c20 5b5d 290a 0a20 2020 2064 6566  ds, [])..    def
-0001a410: 2074 6573 745f 7761 6974 5f70 6173 7365   test_wait_passe
-0001a420: 645f 6f75 7470 7574 5f62 7974 6573 2873  d_output_bytes(s
-0001a430: 656c 6629 3a0a 2020 2020 2020 2020 696f  elf):.        io
-0001a440: 5f77 732c 2073 7464 6572 722c 205f 203d  _ws, stderr, _ =
-0001a450: 2073 656c 662e 6164 645f 7265 7370 6f6e   self.add_respon
-0001a460: 7365 7328 2731 3233 272c 2030 290a 2020  ses('123', 0).  
-0001a470: 2020 2020 2020 696f 5f77 732e 7265 6365        io_ws.rece
-0001a480: 6976 6573 2e61 7070 656e 6428 6227 666f  ives.append(b'fo
-0001a490: 6f5c 6e27 290a 2020 2020 2020 2020 696f  o\n').        io
-0001a4a0: 5f77 732e 7265 6365 6976 6573 2e61 7070  _ws.receives.app
-0001a4b0: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
-0001a4c0: 2265 6e64 227d 2729 0a20 2020 2020 2020  "end"}').       
-0001a4d0: 2073 7464 6572 722e 7265 6365 6976 6573   stderr.receives
-0001a4e0: 2e61 7070 656e 6428 6227 736f 6d65 2065  .append(b'some e
-0001a4f0: 7272 6f72 5c6e 2729 0a20 2020 2020 2020  rror\n').       
-0001a500: 2073 7464 6572 722e 7265 6365 6976 6573   stderr.receives
-0001a510: 2e61 7070 656e 6428 277b 2263 6f6d 6d61  .append('{"comma
-0001a520: 6e64 223a 2265 6e64 227d 2729 0a0a 2020  nd":"end"}')..  
-0001a530: 2020 2020 2020 6f75 7420 3d20 696f 2e42        out = io.B
-0001a540: 7974 6573 494f 2829 0a20 2020 2020 2020  ytesIO().       
-0001a550: 2065 7272 203d 2069 6f2e 4279 7465 7349   err = io.BytesI
-0001a560: 4f28 290a 2020 2020 2020 2020 7072 6f63  O().        proc
-0001a570: 6573 7320 3d20 7365 6c66 2e63 6c69 656e  ess = self.clien
-0001a580: 742e 6578 6563 285b 2765 6368 6f27 2c20  t.exec(['echo', 
-0001a590: 2766 6f6f 275d 2c20 7374 646f 7574 3d6f  'foo'], stdout=o
-0001a5a0: 7574 2c20 7374 6465 7272 3d65 7272 2c20  ut, stderr=err, 
-0001a5b0: 656e 636f 6469 6e67 3d4e 6f6e 6529 0a20  encoding=None). 
-0001a5c0: 2020 2020 2020 2070 726f 6365 7373 2e77         process.w
-0001a5d0: 6169 7428 290a 2020 2020 2020 2020 7365  ait().        se
-0001a5e0: 6c66 2e61 7373 6572 7445 7175 616c 286f  lf.assertEqual(o
-0001a5f0: 7574 2e67 6574 7661 6c75 6528 292c 2062  ut.getvalue(), b
-0001a600: 2766 6f6f 5c6e 2729 0a20 2020 2020 2020  'foo\n').       
-0001a610: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001a620: 6c28 6572 722e 6765 7476 616c 7565 2829  l(err.getvalue()
-0001a630: 2c20 6227 736f 6d65 2065 7272 6f72 5c6e  , b'some error\n
-0001a640: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
-0001a650: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
-0001a660: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
-0001a670: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
-0001a680: 2028 2750 4f53 5427 2c20 272f 7631 2f65   ('POST', '/v1/e
-0001a690: 7865 6327 2c20 4e6f 6e65 2c20 7365 6c66  xec', None, self
-0001a6a0: 2e62 7569 6c64 5f65 7865 635f 6461 7461  .build_exec_data
-0001a6b0: 285b 2765 6368 6f27 2c20 2766 6f6f 275d  (['echo', 'foo']
-0001a6c0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0001a6d0: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
-0001a6e0: 6e67 6573 2f31 3233 2f77 6169 7427 2c20  nges/123/wait', 
-0001a6f0: 7b27 7469 6d65 6f75 7427 3a20 2734 2e30  {'timeout': '4.0
-0001a700: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
-0001a710: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-0001a720: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001a730: 6c28 696f 5f77 732e 7365 6e64 732c 205b  l(io_ws.sends, [
-0001a740: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001a750: 5f77 6169 745f 7061 7373 6564 5f6f 7574  _wait_passed_out
-0001a760: 7075 745f 6261 645f 636f 6d6d 616e 6428  put_bad_command(
-0001a770: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-0001a780: 6f5f 7773 2c20 7374 6465 7272 2c20 5f20  o_ws, stderr, _ 
-0001a790: 3d20 7365 6c66 2e61 6464 5f72 6573 706f  = self.add_respo
-0001a7a0: 6e73 6573 2827 3132 3327 2c20 3029 0a20  nses('123', 0). 
-0001a7b0: 2020 2020 2020 2069 6f5f 7773 2e72 6563         io_ws.rec
-0001a7c0: 6569 7665 732e 6170 7065 6e64 2862 2766  eives.append(b'f
-0001a7d0: 6f6f 5c6e 2729 0a20 2020 2020 2020 2069  oo\n').        i
-0001a7e0: 6f5f 7773 2e72 6563 6569 7665 732e 6170  o_ws.receives.ap
-0001a7f0: 7065 6e64 2827 6e6f 7420 6a73 6f6e 2729  pend('not json')
-0001a800: 2020 2320 6261 6420 4a53 4f4e 2073 686f    # bad JSON sho
-0001a810: 756c 6420 6265 2069 676e 6f72 6564 0a20  uld be ignored. 
-0001a820: 2020 2020 2020 2069 6f5f 7773 2e72 6563         io_ws.rec
-0001a830: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
-0001a840: 636f 6d6d 616e 6422 3a22 666f 6f22 7d27  command":"foo"}'
-0001a850: 2920 2023 2075 6e6b 6e6f 776e 2063 6f6d  )  # unknown com
-0001a860: 6d61 6e64 2073 686f 756c 6420 6265 2069  mand should be i
-0001a870: 676e 6f72 6564 0a20 2020 2020 2020 2069  gnored.        i
-0001a880: 6f5f 7773 2e72 6563 6569 7665 732e 6170  o_ws.receives.ap
-0001a890: 7065 6e64 2827 7b22 636f 6d6d 616e 6422  pend('{"command"
-0001a8a0: 3a22 656e 6422 7d27 290a 2020 2020 2020  :"end"}').      
-0001a8b0: 2020 7374 6465 7272 2e72 6563 6569 7665    stderr.receive
-0001a8c0: 732e 6170 7065 6e64 2862 2773 6f6d 6520  s.append(b'some 
-0001a8d0: 6572 726f 725c 6e27 290a 2020 2020 2020  error\n').      
-0001a8e0: 2020 7374 6465 7272 2e72 6563 6569 7665    stderr.receive
-0001a8f0: 732e 6170 7065 6e64 2827 7b22 636f 6d6d  s.append('{"comm
-0001a900: 616e 6422 3a22 656e 6422 7d27 290a 0a20  and":"end"}').. 
-0001a910: 2020 2020 2020 206f 7574 203d 2069 6f2e         out = io.
-0001a920: 5374 7269 6e67 494f 2829 0a20 2020 2020  StringIO().     
-0001a930: 2020 2065 7272 203d 2069 6f2e 5374 7269     err = io.Stri
-0001a940: 6e67 494f 2829 0a0a 2020 2020 2020 2020  ngIO()..        
-0001a950: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0001a960: 4c6f 6773 2827 6f70 732e 7065 6262 6c65  Logs('ops.pebble
-0001a970: 272c 206c 6576 656c 3d27 5741 524e 494e  ', level='WARNIN
-0001a980: 4727 2920 6173 2063 6d3a 0a20 2020 2020  G') as cm:.     
-0001a990: 2020 2020 2020 2070 726f 6365 7373 203d         process =
-0001a9a0: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
-0001a9b0: 6328 5b27 6563 686f 272c 2027 666f 6f27  c(['echo', 'foo'
-0001a9c0: 5d2c 2073 7464 6f75 743d 6f75 742c 2073  ], stdout=out, s
-0001a9d0: 7464 6572 723d 6572 7229 0a20 2020 2020  tderr=err).     
-0001a9e0: 2020 2020 2020 2070 726f 6365 7373 2e77         process.w
-0001a9f0: 6169 7428 290a 2020 2020 2020 2020 7365  ait().        se
-0001aa00: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0001aa10: 6d2e 6f75 7470 7574 2c20 5b0a 2020 2020  m.output, [.    
-0001aa20: 2020 2020 2020 2020 2257 4152 4e49 4e47          "WARNING
-0001aa30: 3a6f 7073 2e70 6562 626c 653a 4361 6e6e  :ops.pebble:Cann
-0001aa40: 6f74 2064 6563 6f64 6520 492f 4f20 636f  ot decode I/O co
-0001aa50: 6d6d 616e 6420 2869 6e76 616c 6964 204a  mmand (invalid J
-0001aa60: 534f 4e29 222c 0a20 2020 2020 2020 2020  SON)",.         
-0001aa70: 2020 2022 5741 524e 494e 473a 6f70 732e     "WARNING:ops.
-0001aa80: 7065 6262 6c65 3a49 6e76 616c 6964 2049  pebble:Invalid I
-0001aa90: 2f4f 2063 6f6d 6d61 6e64 2027 666f 6f27  /O command 'foo'
-0001aaa0: 222c 0a20 2020 2020 2020 205d 290a 0a20  ",.        ]).. 
-0001aab0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001aac0: 7274 4571 7561 6c28 6f75 742e 6765 7476  rtEqual(out.getv
-0001aad0: 616c 7565 2829 2c20 2766 6f6f 5c6e 2729  alue(), 'foo\n')
-0001aae0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001aaf0: 7365 7274 4571 7561 6c28 6572 722e 6765  sertEqual(err.ge
-0001ab00: 7476 616c 7565 2829 2c20 2773 6f6d 6520  tvalue(), 'some 
-0001ab10: 6572 726f 725c 6e27 290a 0a20 2020 2020  error\n')..     
-0001ab20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001ab30: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
-0001ab40: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
-0001ab50: 2020 2020 2020 2020 2827 504f 5354 272c          ('POST',
-0001ab60: 2027 2f76 312f 6578 6563 272c 204e 6f6e   '/v1/exec', Non
-0001ab70: 652c 2073 656c 662e 6275 696c 645f 6578  e, self.build_ex
-0001ab80: 6563 5f64 6174 6128 5b27 6563 686f 272c  ec_data(['echo',
-0001ab90: 2027 666f 6f27 5d29 292c 0a20 2020 2020   'foo'])),.     
-0001aba0: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-0001abb0: 2f76 312f 6368 616e 6765 732f 3132 332f  /v1/changes/123/
-0001abc0: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
-0001abd0: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
-0001abe0: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-0001abf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ac00: 6572 7445 7175 616c 2869 6f5f 7773 2e73  ertEqual(io_ws.s
-0001ac10: 656e 6473 2c20 5b5d 290a 0a20 2020 2064  ends, [])..    d
-0001ac20: 6566 2074 6573 745f 7761 6974 5f66 696c  ef test_wait_fil
-0001ac30: 655f 696f 2873 656c 6629 3a0a 2020 2020  e_io(self):.    
-0001ac40: 2020 2020 6669 6e20 3d20 7465 6d70 6669      fin = tempfi
-0001ac50: 6c65 2e54 656d 706f 7261 7279 4669 6c65  le.TemporaryFile
-0001ac60: 286d 6f64 653d 2777 2b27 2c20 656e 636f  (mode='w+', enco
-0001ac70: 6469 6e67 3d27 7574 662d 3827 290a 2020  ding='utf-8').  
-0001ac80: 2020 2020 2020 6f75 7420 3d20 7465 6d70        out = temp
-0001ac90: 6669 6c65 2e54 656d 706f 7261 7279 4669  file.TemporaryFi
-0001aca0: 6c65 286d 6f64 653d 2777 2b27 2c20 656e  le(mode='w+', en
-0001acb0: 636f 6469 6e67 3d27 7574 662d 3827 290a  coding='utf-8').
-0001acc0: 2020 2020 2020 2020 6572 7220 3d20 7465          err = te
-0001acd0: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
-0001ace0: 4669 6c65 286d 6f64 653d 2777 2b27 2c20  File(mode='w+', 
-0001acf0: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-0001ad00: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-0001ad10: 2020 2020 2020 2020 2020 2066 696e 2e77             fin.w
-0001ad20: 7269 7465 2827 666f 6f5c 6e27 290a 2020  rite('foo\n').  
-0001ad30: 2020 2020 2020 2020 2020 6669 6e2e 7365            fin.se
-0001ad40: 656b 2830 290a 0a20 2020 2020 2020 2020  ek(0)..         
-0001ad50: 2020 2069 6f5f 7773 2c20 7374 6465 7272     io_ws, stderr
-0001ad60: 2c20 5f20 3d20 7365 6c66 2e61 6464 5f72  , _ = self.add_r
-0001ad70: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
-0001ad80: 3029 0a20 2020 2020 2020 2020 2020 2069  0).            i
-0001ad90: 6f5f 7773 2e72 6563 6569 7665 732e 6170  o_ws.receives.ap
-0001ada0: 7065 6e64 2862 2766 6f6f 5c6e 2729 0a20  pend(b'foo\n'). 
-0001adb0: 2020 2020 2020 2020 2020 2069 6f5f 7773             io_ws
-0001adc0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-0001add0: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
-0001ade0: 6422 7d27 290a 2020 2020 2020 2020 2020  d"}').          
-0001adf0: 2020 7374 6465 7272 2e72 6563 6569 7665    stderr.receive
-0001ae00: 732e 6170 7065 6e64 2862 2773 6f6d 6520  s.append(b'some 
-0001ae10: 6572 726f 725c 6e27 290a 2020 2020 2020  error\n').      
-0001ae20: 2020 2020 2020 7374 6465 7272 2e72 6563        stderr.rec
-0001ae30: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
-0001ae40: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
-0001ae50: 290a 0a20 2020 2020 2020 2020 2020 2070  )..            p
-0001ae60: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
-0001ae70: 6965 6e74 2e65 7865 6328 5b27 6563 686f  ient.exec(['echo
-0001ae80: 272c 2027 666f 6f27 5d2c 2073 7464 696e  ', 'foo'], stdin
-0001ae90: 3d66 696e 2c20 7374 646f 7574 3d6f 7574  =fin, stdout=out
-0001aea0: 2c20 7374 6465 7272 3d65 7272 290a 2020  , stderr=err).  
-0001aeb0: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
-0001aec0: 732e 7761 6974 2829 0a0a 2020 2020 2020  s.wait()..      
-0001aed0: 2020 2020 2020 6f75 742e 7365 656b 2830        out.seek(0
-0001aee0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0001aef0: 6c66 2e61 7373 6572 7445 7175 616c 286f  lf.assertEqual(o
-0001af00: 7574 2e72 6561 6428 292c 2027 666f 6f5c  ut.read(), 'foo\
-0001af10: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
-0001af20: 6572 722e 7365 656b 2830 290a 2020 2020  err.seek(0).    
-0001af30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001af40: 6572 7445 7175 616c 2865 7272 2e72 6561  ertEqual(err.rea
-0001af50: 6428 292c 2027 736f 6d65 2065 7272 6f72  d(), 'some error
-0001af60: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
-0001af70: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001af80: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
-0001af90: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
-0001afa0: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
-0001afb0: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
-0001afc0: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
-0001afd0: 5f65 7865 635f 6461 7461 285b 2765 6368  _exec_data(['ech
-0001afe0: 6f27 2c20 2766 6f6f 275d 2929 2c0a 2020  o', 'foo'])),.  
-0001aff0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-0001b000: 4745 5427 2c20 272f 7631 2f63 6861 6e67  GET', '/v1/chang
-0001b010: 6573 2f31 3233 2f77 6169 7427 2c20 7b27  es/123/wait', {'
-0001b020: 7469 6d65 6f75 7427 3a20 2734 2e30 3030  timeout': '4.000
-0001b030: 7327 7d2c 204e 6f6e 6529 2c0a 2020 2020  s'}, None),.    
-0001b040: 2020 2020 2020 2020 5d29 0a20 2020 2020          ]).     
-0001b050: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001b060: 7274 4571 7561 6c28 696f 5f77 732e 7365  rtEqual(io_ws.se
-0001b070: 6e64 732c 205b 0a20 2020 2020 2020 2020  nds, [.         
-0001b080: 2020 2020 2020 2028 2742 494e 272c 2062         ('BIN', b
-0001b090: 2766 6f6f 5c6e 2729 2c0a 2020 2020 2020  'foo\n'),.      
-0001b0a0: 2020 2020 2020 2020 2020 2827 5458 5427            ('TXT'
-0001b0b0: 2c20 277b 2263 6f6d 6d61 6e64 223a 2265  , '{"command":"e
-0001b0c0: 6e64 227d 2729 2c0a 2020 2020 2020 2020  nd"}'),.        
-0001b0d0: 2020 2020 5d29 0a20 2020 2020 2020 2066      ]).        f
-0001b0e0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-0001b0f0: 2020 2020 6669 6e2e 636c 6f73 6528 290a      fin.close().
-0001b100: 2020 2020 2020 2020 2020 2020 6f75 742e              out.
-0001b110: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-0001b120: 2020 2020 6572 722e 636c 6f73 6528 290a      err.close().
-0001b130: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
-0001b140: 6974 5f72 6574 7572 6e65 645f 696f 2873  it_returned_io(s
-0001b150: 656c 6629 3a0a 2020 2020 2020 2020 7374  elf):.        st
-0001b160: 6469 6f2c 2073 7464 6572 722c 205f 203d  dio, stderr, _ =
-0001b170: 2073 656c 662e 6164 645f 7265 7370 6f6e   self.add_respon
-0001b180: 7365 7328 2731 3233 272c 2030 290a 2020  ses('123', 0).  
-0001b190: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
-0001b1a0: 6976 6573 2e61 7070 656e 6428 6227 464f  ives.append(b'FO
-0001b1b0: 4f20 4241 525c 6e27 290a 2020 2020 2020  O BAR\n').      
-0001b1c0: 2020 7374 6469 6f2e 7265 6365 6976 6573    stdio.receives
-0001b1d0: 2e61 7070 656e 6428 6227 4241 5a5a 5c6e  .append(b'BAZZ\n
-0001b1e0: 2729 0a20 2020 2020 2020 2073 7464 696f  ').        stdio
-0001b1f0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-0001b200: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
-0001b210: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
-0001b220: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
-0001b230: 6965 6e74 2e65 7865 6328 5b27 6177 6b27  ient.exec(['awk'
-0001b240: 2c20 277b 2070 7269 6e74 2074 6f75 7070  , '{ print toupp
-0001b250: 6572 2824 2920 7d27 5d29 0a20 2020 2020  er($) }']).     
-0001b260: 2020 2070 726f 6365 7373 2e73 7464 696e     process.stdin
-0001b270: 2e77 7269 7465 2827 466f 6f20 4261 725c  .write('Foo Bar\
-0001b280: 6e27 290a 2020 2020 2020 2020 7365 6c66  n').        self
-0001b290: 2e61 7373 6572 7445 7175 616c 2870 726f  .assertEqual(pro
-0001b2a0: 6365 7373 2e73 7464 6f75 742e 7265 6164  cess.stdout.read
-0001b2b0: 2834 292c 2027 464f 4f20 2729 0a20 2020  (4), 'FOO ').   
-0001b2c0: 2020 2020 2070 726f 6365 7373 2e73 7464       process.std
-0001b2d0: 696e 2e77 7269 7465 2827 6261 7a7a 5c6e  in.write('bazz\n
-0001b2e0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0001b2f0: 6173 7365 7274 4571 7561 6c28 7072 6f63  assertEqual(proc
-0001b300: 6573 732e 7374 646f 7574 2e72 6561 6428  ess.stdout.read(
-0001b310: 292c 2027 4241 525c 6e42 415a 5a5c 6e27  ), 'BAR\nBAZZ\n'
-0001b320: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
-0001b330: 732e 7374 6469 6e2e 636c 6f73 6528 290a  s.stdin.close().
-0001b340: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001b350: 6572 7445 7175 616c 2870 726f 6365 7373  ertEqual(process
-0001b360: 2e73 7464 6f75 742e 7265 6164 2829 2c20  .stdout.read(), 
-0001b370: 2727 290a 2020 2020 2020 2020 7072 6f63  '').        proc
-0001b380: 6573 732e 7761 6974 2829 0a0a 2020 2020  ess.wait()..    
-0001b390: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001b3a0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
-0001b3b0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
-0001b3c0: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
-0001b3d0: 2c20 272f 7631 2f65 7865 6327 2c20 4e6f  , '/v1/exec', No
-0001b3e0: 6e65 2c20 7365 6c66 2e62 7569 6c64 5f65  ne, self.build_e
-0001b3f0: 7865 635f 6461 7461 285b 2761 776b 272c  xec_data(['awk',
-0001b400: 2027 7b20 7072 696e 7420 746f 7570 7065   '{ print touppe
-0001b410: 7228 2429 207d 275d 2929 2c0a 2020 2020  r($) }'])),.    
-0001b420: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
-0001b430: 272f 7631 2f63 6861 6e67 6573 2f31 3233  '/v1/changes/123
-0001b440: 2f77 6169 7427 2c20 7b27 7469 6d65 6f75  /wait', {'timeou
-0001b450: 7427 3a20 2734 2e30 3030 7327 7d2c 204e  t': '4.000s'}, N
-0001b460: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
-0001b470: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001b480: 7365 7274 4571 7561 6c28 7374 6469 6f2e  sertEqual(stdio.
-0001b490: 7365 6e64 732c 205b 0a20 2020 2020 2020  sends, [.       
-0001b4a0: 2020 2020 2028 2742 494e 272c 2062 2746       ('BIN', b'F
-0001b4b0: 6f6f 2042 6172 5c6e 6261 7a7a 5c6e 2729  oo Bar\nbazz\n')
-0001b4c0: 2c20 2023 2054 6578 7449 4f57 7261 7070  ,  # TextIOWrapp
-0001b4d0: 6572 2067 726f 7570 7320 7468 6520 7772  er groups the wr
-0001b4e0: 6974 6573 2074 6f67 6574 6865 720a 2020  ites together.  
-0001b4f0: 2020 2020 2020 2020 2020 2827 5458 5427            ('TXT'
-0001b500: 2c20 277b 2263 6f6d 6d61 6e64 223a 2265  , '{"command":"e
-0001b510: 6e64 227d 2729 2c0a 2020 2020 2020 2020  nd"}'),.        
-0001b520: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001b530: 5f77 6169 745f 7265 7475 726e 6564 5f69  _wait_returned_i
-0001b540: 6f5f 6279 7465 7328 7365 6c66 293a 0a20  o_bytes(self):. 
-0001b550: 2020 2020 2020 2073 7464 696f 2c20 7374         stdio, st
-0001b560: 6465 7272 2c20 5f20 3d20 7365 6c66 2e61  derr, _ = self.a
-0001b570: 6464 5f72 6573 706f 6e73 6573 2827 3132  dd_responses('12
-0001b580: 3327 2c20 3029 0a20 2020 2020 2020 2073  3', 0).        s
-0001b590: 7464 696f 2e72 6563 6569 7665 732e 6170  tdio.receives.ap
-0001b5a0: 7065 6e64 2862 2746 4f4f 2042 4152 5c6e  pend(b'FOO BAR\n
-0001b5b0: 2729 0a20 2020 2020 2020 2073 7464 696f  ').        stdio
-0001b5c0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
-0001b5d0: 2862 2742 415a 5a5c 6e27 290a 2020 2020  (b'BAZZ\n').    
-0001b5e0: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
-0001b5f0: 6573 2e61 7070 656e 6428 277b 2263 6f6d  es.append('{"com
-0001b600: 6d61 6e64 223a 2265 6e64 227d 2729 0a0a  mand":"end"}')..
-0001b610: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
-0001b620: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
-0001b630: 6563 285b 2761 776b 272c 2027 7b20 7072  ec(['awk', '{ pr
-0001b640: 696e 7420 746f 7570 7065 7228 2429 207d  int toupper($) }
-0001b650: 275d 2c20 656e 636f 6469 6e67 3d4e 6f6e  '], encoding=Non
-0001b660: 6529 0a20 2020 2020 2020 2070 726f 6365  e).        proce
-0001b670: 7373 2e73 7464 696e 2e77 7269 7465 2862  ss.stdin.write(b
-0001b680: 2746 6f6f 2042 6172 5c6e 2729 0a20 2020  'Foo Bar\n').   
-0001b690: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001b6a0: 4571 7561 6c28 7072 6f63 6573 732e 7374  Equal(process.st
-0001b6b0: 646f 7574 2e72 6561 6428 3429 2c20 6227  dout.read(4), b'
-0001b6c0: 464f 4f20 2729 0a20 2020 2020 2020 2073  FOO ').        s
-0001b6d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001b6e0: 7072 6f63 6573 732e 7374 646f 7574 2e72  process.stdout.r
-0001b6f0: 6561 6428 292c 2062 2742 4152 5c6e 2729  ead(), b'BAR\n')
-0001b700: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-0001b710: 2e73 7464 696e 2e77 7269 7465 2862 2762  .stdin.write(b'b
-0001b720: 617a 7a5c 6e27 290a 2020 2020 2020 2020  azz\n').        
-0001b730: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001b740: 2870 726f 6365 7373 2e73 7464 6f75 742e  (process.stdout.
-0001b750: 7265 6164 2829 2c20 6227 4241 5a5a 5c6e  read(), b'BAZZ\n
-0001b760: 2729 0a20 2020 2020 2020 2070 726f 6365  ').        proce
-0001b770: 7373 2e73 7464 696e 2e63 6c6f 7365 2829  ss.stdin.close()
-0001b780: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001b790: 7365 7274 4571 7561 6c28 7072 6f63 6573  sertEqual(proces
-0001b7a0: 732e 7374 646f 7574 2e72 6561 6428 292c  s.stdout.read(),
-0001b7b0: 2062 2727 290a 2020 2020 2020 2020 7072   b'').        pr
-0001b7c0: 6f63 6573 732e 7761 6974 2829 0a0a 2020  ocess.wait()..  
-0001b7d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001b7e0: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-0001b7f0: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-0001b800: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
-0001b810: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
-0001b820: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
-0001b830: 5f65 7865 635f 6461 7461 285b 2761 776b  _exec_data(['awk
-0001b840: 272c 2027 7b20 7072 696e 7420 746f 7570  ', '{ print toup
-0001b850: 7065 7228 2429 207d 275d 2929 2c0a 2020  per($) }'])),.  
-0001b860: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
-0001b870: 2c20 272f 7631 2f63 6861 6e67 6573 2f31  , '/v1/changes/1
-0001b880: 3233 2f77 6169 7427 2c20 7b27 7469 6d65  23/wait', {'time
-0001b890: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
-0001b8a0: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0001b8b0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
-0001b8c0: 6173 7365 7274 4571 7561 6c28 7374 6469  assertEqual(stdi
-0001b8d0: 6f2e 7365 6e64 732c 205b 0a20 2020 2020  o.sends, [.     
-0001b8e0: 2020 2020 2020 2028 2742 494e 272c 2062         ('BIN', b
-0001b8f0: 2746 6f6f 2042 6172 5c6e 2729 2c0a 2020  'Foo Bar\n'),.  
-0001b900: 2020 2020 2020 2020 2020 2827 4249 4e27            ('BIN'
-0001b910: 2c20 6227 6261 7a7a 5c6e 2729 2c0a 2020  , b'bazz\n'),.  
-0001b920: 2020 2020 2020 2020 2020 2827 5458 5427            ('TXT'
-0001b930: 2c20 277b 2263 6f6d 6d61 6e64 223a 2265  , '{"command":"e
-0001b940: 6e64 227d 2729 2c0a 2020 2020 2020 2020  nd"}'),.        
-0001b950: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0001b960: 5f63 6f6e 6e65 6374 5f77 6562 736f 636b  _connect_websock
-0001b970: 6574 5f65 7272 6f72 2873 656c 6629 3a0a  et_error(self):.
-0001b980: 2020 2020 2020 2020 636c 6173 7320 436c          class Cl
-0001b990: 6965 6e74 284d 6f63 6b43 6c69 656e 7429  ient(MockClient)
-0001b9a0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-0001b9b0: 6620 5f63 6f6e 6e65 6374 5f77 6562 736f  f _connect_webso
-0001b9c0: 636b 6574 2873 656c 662c 2063 6861 6e67  cket(self, chang
-0001b9d0: 655f 6964 2c20 7765 6273 6f63 6b65 745f  e_id, websocket_
-0001b9e0: 6964 293a 0a20 2020 2020 2020 2020 2020  id):.           
-0001b9f0: 2020 2020 2072 6169 7365 2077 6562 736f       raise webso
-0001ba00: 636b 6574 2e57 6562 536f 636b 6574 4578  cket.WebSocketEx
-0001ba10: 6365 7074 696f 6e28 2763 6f6e 6e21 2729  ception('conn!')
-0001ba20: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-0001ba30: 6c69 656e 7420 3d20 436c 6965 6e74 2829  lient = Client()
-0001ba40: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001ba50: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
-0001ba60: 272c 2030 2c20 6368 616e 6765 5f65 7272  ', 0, change_err
-0001ba70: 3d27 6368 616e 6765 2065 7272 6f72 2127  ='change error!'
-0001ba80: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-0001ba90: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-0001baa0: 2870 6562 626c 652e 4368 616e 6765 4572  (pebble.ChangeEr
-0001bab0: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
-0001bac0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0001bad0: 656e 742e 6578 6563 285b 2766 6f6f 275d  ent.exec(['foo']
-0001bae0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001baf0: 7373 6572 7445 7175 616c 2873 7472 2863  ssertEqual(str(c
-0001bb00: 6d2e 6578 6365 7074 696f 6e29 2c20 2763  m.exception), 'c
-0001bb10: 6861 6e67 6520 6572 726f 7221 2729 0a0a  hange error!')..
-0001bb20: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0001bb30: 656e 7420 3d20 436c 6965 6e74 2829 0a20  ent = Client(). 
-0001bb40: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-0001bb50: 7265 7370 6f6e 7365 7328 2731 3233 272c  responses('123',
-0001bb60: 2030 290a 2020 2020 2020 2020 7769 7468   0).        with
-0001bb70: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0001bb80: 6573 2870 6562 626c 652e 436f 6e6e 6563  es(pebble.Connec
-0001bb90: 7469 6f6e 4572 726f 7229 2061 7320 636d  tionError) as cm
-0001bba0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001bbb0: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
-0001bbc0: 2766 6f6f 275d 290a 2020 2020 2020 2020  'foo']).        
-0001bbd0: 7365 6c66 2e61 7373 6572 7449 6e28 7374  self.assertIn(st
-0001bbe0: 7228 636d 2e65 7863 6570 7469 6f6e 292c  r(cm.exception),
-0001bbf0: 2027 756e 6578 7065 6374 6564 2065 7272   'unexpected err
-0001bc00: 6f72 2063 6f6e 6e65 6374 696e 6720 746f  or connecting to
-0001bc10: 2077 6562 736f 636b 6574 733a 2063 6f6e   websockets: con
-0001bc20: 6e21 2729 0a0a 2020 2020 6465 6620 7465  n!')..    def te
-0001bc30: 7374 5f77 6562 736f 636b 6574 5f73 656e  st_websocket_sen
-0001bc40: 645f 7261 6973 6573 2873 656c 6629 3a0a  d_raises(self):.
-0001bc50: 2020 2020 2020 2020 7374 6469 6f2c 2073          stdio, s
-0001bc60: 7464 6572 722c 205f 203d 2073 656c 662e  tderr, _ = self.
-0001bc70: 6164 645f 7265 7370 6f6e 7365 7328 2731  add_responses('1
-0001bc80: 3233 272c 2030 290a 2020 2020 2020 2020  23', 0).        
-0001bc90: 7261 6973 6564 203d 2046 616c 7365 0a0a  raised = False..
-0001bca0: 2020 2020 2020 2020 6465 6620 7365 6e64          def send
-0001bcb0: 5f62 696e 6172 7928 6229 3a0a 2020 2020  _binary(b):.    
-0001bcc0: 2020 2020 2020 2020 6e6f 6e6c 6f63 616c          nonlocal
-0001bcd0: 2072 6169 7365 640a 2020 2020 2020 2020   raised.        
-0001bce0: 2020 2020 7261 6973 6564 203d 2054 7275      raised = Tru
-0001bcf0: 650a 2020 2020 2020 2020 2020 2020 7261  e.            ra
-0001bd00: 6973 6520 4578 6365 7074 696f 6e28 2761  ise Exception('a
-0001bd10: 2073 696d 756c 6174 6564 2065 7272 6f72   simulated error
-0001bd20: 2127 290a 0a20 2020 2020 2020 2073 7464  !')..        std
-0001bd30: 696f 2e73 656e 645f 6269 6e61 7279 203d  io.send_binary =
-0001bd40: 2073 656e 645f 6269 6e61 7279 0a20 2020   send_binary.   
-0001bd50: 2020 2020 2073 7464 696f 2e72 6563 6569       stdio.recei
-0001bd60: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
-0001bd70: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
-0001bd80: 2020 2020 2020 2020 7374 6465 7272 2e72          stderr.r
-0001bd90: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
-0001bda0: 7b22 636f 6d6d 616e 6422 3a22 656e 6422  {"command":"end"
-0001bdb0: 7d27 290a 0a20 2020 2020 2020 2070 726f  }')..        pro
-0001bdc0: 6365 7373 203d 2073 656c 662e 636c 6965  cess = self.clie
-0001bdd0: 6e74 2e65 7865 6328 5b27 6361 7427 5d2c  nt.exec(['cat'],
-0001bde0: 2073 7464 696e 3d27 666f 6f5c 6e62 6172   stdin='foo\nbar
-0001bdf0: 5c6e 2729 0a20 2020 2020 2020 206f 7574  \n').        out
-0001be00: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
-0001be10: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
-0001be20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001be30: 7445 7175 616c 286f 7574 2c20 2727 290a  tEqual(out, '').
-0001be40: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001be50: 6572 7445 7175 616c 2865 7272 2c20 2727  ertEqual(err, ''
-0001be60: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001be70: 7373 6572 7454 7275 6528 7261 6973 6564  ssertTrue(raised
-0001be80: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001be90: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
-0001bea0: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
-0001beb0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-0001bec0: 2827 504f 5354 272c 2027 2f76 312f 6578  ('POST', '/v1/ex
-0001bed0: 6563 272c 204e 6f6e 652c 2073 656c 662e  ec', None, self.
-0001bee0: 6275 696c 645f 6578 6563 5f64 6174 6128  build_exec_data(
-0001bef0: 5b27 6361 7427 5d29 292c 0a20 2020 2020  ['cat'])),.     
-0001bf00: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
-0001bf10: 2f76 312f 6368 616e 6765 732f 3132 332f  /v1/changes/123/
-0001bf20: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
-0001bf30: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
-0001bf40: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
-0001bf50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001bf60: 6572 7445 7175 616c 2873 7464 696f 2e73  ertEqual(stdio.s
-0001bf70: 656e 6473 2c20 5b5d 290a 0a20 2020 2023  ends, [])..    #
-0001bf80: 2059 6f75 2764 206e 6f72 6d61 6c6c 7920   You'd normally 
-0001bf90: 7573 6520 7079 7465 7374 2e6d 6172 6b2e  use pytest.mark.
-0001bfa0: 6669 6c74 6572 7761 726e 696e 6773 2061  filterwarnings a
-0001bfb0: 7320 6120 6465 636f 7261 746f 722c 2062  s a decorator, b
-0001bfc0: 7574 0a20 2020 2023 2050 7974 6573 7455  ut.    # PytestU
-0001bfd0: 6e68 616e 646c 6564 5468 7265 6164 4578  nhandledThreadEx
-0001bfe0: 6365 7074 696f 6e57 6172 6e69 6e67 2069  ceptionWarning i
-0001bff0: 736e 2774 2070 7265 7365 6e74 206f 6e20  sn't present on 
-0001c000: 6f6c 6465 7220 5079 7468 6f6e 2076 6572  older Python ver
-0001c010: 7369 6f6e 732e 0a20 2020 2069 6620 6861  sions..    if ha
-0001c020: 7361 7474 7228 7079 7465 7374 2c20 2750  sattr(pytest, 'P
-0001c030: 7974 6573 7455 6e68 616e 646c 6564 5468  ytestUnhandledTh
-0001c040: 7265 6164 4578 6365 7074 696f 6e57 6172  readExceptionWar
-0001c050: 6e69 6e67 2729 3a0a 2020 2020 2020 2020  ning'):.        
-0001c060: 7465 7374 5f77 6562 736f 636b 6574 5f73  test_websocket_s
-0001c070: 656e 645f 7261 6973 6573 203d 2070 7974  end_raises = pyt
-0001c080: 6573 742e 6d61 726b 2e66 696c 7465 7277  est.mark.filterw
-0001c090: 6172 6e69 6e67 7328 0a20 2020 2020 2020  arnings(.       
-0001c0a0: 2020 2020 2027 6967 6e6f 7265 3a3a 7079       'ignore::py
-0001c0b0: 7465 7374 2e50 7974 6573 7455 6e68 616e  test.PytestUnhan
-0001c0c0: 646c 6564 5468 7265 6164 4578 6365 7074  dledThreadExcept
-0001c0d0: 696f 6e57 6172 6e69 6e67 2729 2874 6573  ionWarning')(tes
-0001c0e0: 745f 7765 6273 6f63 6b65 745f 7365 6e64  t_websocket_send
-0001c0f0: 5f72 6169 7365 7329 0a0a 2020 2020 6465  _raises)..    de
-0001c100: 6620 7465 7374 5f77 6562 736f 636b 6574  f test_websocket
-0001c110: 5f72 6563 765f 7261 6973 6573 2873 656c  _recv_raises(sel
-0001c120: 6629 3a0a 2020 2020 2020 2020 7374 6469  f):.        stdi
-0001c130: 6f2c 2073 7464 6572 722c 205f 203d 2073  o, stderr, _ = s
-0001c140: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
-0001c150: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
-0001c160: 2020 2020 7261 6973 6564 203d 2046 616c      raised = Fal
-0001c170: 7365 0a0a 2020 2020 2020 2020 6465 6620  se..        def 
-0001c180: 7265 6376 2829 3a0a 2020 2020 2020 2020  recv():.        
-0001c190: 2020 2020 6e6f 6e6c 6f63 616c 2072 6169      nonlocal rai
-0001c1a0: 7365 640a 2020 2020 2020 2020 2020 2020  sed.            
-0001c1b0: 7261 6973 6564 203d 2054 7275 650a 2020  raised = True.  
-0001c1c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001c1d0: 4578 6365 7074 696f 6e28 2761 2073 696d  Exception('a sim
-0001c1e0: 756c 6174 6564 2065 7272 6f72 2127 290a  ulated error!').
-0001c1f0: 0a20 2020 2020 2020 2073 7464 696f 2e72  .        stdio.r
-0001c200: 6563 7620 3d20 7265 6376 0a20 2020 2020  ecv = recv.     
-0001c210: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
-0001c220: 6573 2e61 7070 656e 6428 277b 2263 6f6d  es.append('{"com
-0001c230: 6d61 6e64 223a 2265 6e64 227d 2729 0a0a  mand":"end"}')..
-0001c240: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
-0001c250: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
-0001c260: 6563 285b 2763 6174 275d 2c20 7374 6469  ec(['cat'], stdi
-0001c270: 6e3d 2766 6f6f 5c6e 6261 725c 6e27 290a  n='foo\nbar\n').
-0001c280: 2020 2020 2020 2020 6f75 742c 2065 7272          out, err
-0001c290: 203d 2070 726f 6365 7373 2e77 6169 745f   = process.wait_
-0001c2a0: 6f75 7470 7574 2829 0a20 2020 2020 2020  output().       
-0001c2b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001c2c0: 6c28 6f75 742c 2027 2729 0a20 2020 2020  l(out, '').     
-0001c2d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001c2e0: 7561 6c28 6572 722c 2027 2729 0a20 2020  ual(err, '').   
-0001c2f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001c300: 5472 7565 2872 6169 7365 6429 0a0a 2020  True(raised)..  
-0001c310: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001c320: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
-0001c330: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
-0001c340: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
-0001c350: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
-0001c360: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
-0001c370: 5f65 7865 635f 6461 7461 285b 2763 6174  _exec_data(['cat
-0001c380: 275d 2929 2c0a 2020 2020 2020 2020 2020  '])),.          
-0001c390: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
-0001c3a0: 6861 6e67 6573 2f31 3233 2f77 6169 7427  hanges/123/wait'
-0001c3b0: 2c20 7b27 7469 6d65 6f75 7427 3a20 2734  , {'timeout': '4
-0001c3c0: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
-0001c3d0: 2020 2020 2020 2020 5d29 0a20 2020 2020          ]).     
-0001c3e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001c3f0: 7561 6c28 7374 6469 6f2e 7365 6e64 732c  ual(stdio.sends,
-0001c400: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-0001c410: 2742 494e 272c 2062 2766 6f6f 5c6e 6261  'BIN', b'foo\nba
-0001c420: 725c 6e27 292c 0a20 2020 2020 2020 2020  r\n'),.         
-0001c430: 2020 2028 2754 5854 272c 2027 7b22 636f     ('TXT', '{"co
-0001c440: 6d6d 616e 6422 3a22 656e 6422 7d27 292c  mmand":"end"}'),
-0001c450: 0a20 2020 2020 2020 205d 290a 0a20 2020  .        ])..   
-0001c460: 2069 6620 6861 7361 7474 7228 7079 7465   if hasattr(pyte
-0001c470: 7374 2c20 2750 7974 6573 7455 6e68 616e  st, 'PytestUnhan
-0001c480: 646c 6564 5468 7265 6164 4578 6365 7074  dledThreadExcept
-0001c490: 696f 6e57 6172 6e69 6e67 2729 3a0a 2020  ionWarning'):.  
-0001c4a0: 2020 2020 2020 7465 7374 5f77 6562 736f        test_webso
-0001c4b0: 636b 6574 5f72 6563 765f 7261 6973 6573  cket_recv_raises
-0001c4c0: 203d 2070 7974 6573 742e 6d61 726b 2e66   = pytest.mark.f
-0001c4d0: 696c 7465 7277 6172 6e69 6e67 7328 0a20  ilterwarnings(. 
-0001c4e0: 2020 2020 2020 2020 2020 2027 6967 6e6f             'igno
-0001c4f0: 7265 3a3a 7079 7465 7374 2e50 7974 6573  re::pytest.Pytes
-0001c500: 7455 6e68 616e 646c 6564 5468 7265 6164  tUnhandledThread
-0001c510: 4578 6365 7074 696f 6e57 6172 6e69 6e67  ExceptionWarning
-0001c520: 2729 2874 6573 745f 7765 6273 6f63 6b65  ')(test_websocke
-0001c530: 745f 7265 6376 5f72 6169 7365 7329 0a0a  t_recv_raises)..
-0001c540: 0a23 2053 6574 2074 6865 2052 554e 5f52  .# Set the RUN_R
-0001c550: 4541 4c5f 5045 4242 4c45 5f54 4553 5453  EAL_PEBBLE_TESTS
-0001c560: 2065 6e76 6972 6f6e 6d65 6e74 2076 6172   environment var
-0001c570: 6961 626c 6520 746f 2072 756e 2074 6865  iable to run the
-0001c580: 7365 2074 6573 7473 0a23 2061 6761 696e  se tests.# again
-0001c590: 7374 2061 2072 6561 6c20 5065 6262 6c65  st a real Pebble
-0001c5a0: 2073 6572 7665 722e 2046 6f72 2065 7861   server. For exa
-0001c5b0: 6d70 6c65 2c20 696e 206f 6e65 2074 6572  mple, in one ter
-0001c5c0: 6d69 6e61 6c2c 2072 756e 2050 6562 626c  minal, run Pebbl
-0001c5d0: 653a 0a23 0a23 2024 2050 4542 424c 453d  e:.#.# $ PEBBLE=
-0001c5e0: 7e2f 7065 6262 6c65 2070 6562 626c 6520  ~/pebble pebble 
-0001c5f0: 7275 6e20 2d2d 6874 7470 3d3a 3430 3030  run --http=:4000
-0001c600: 0a23 2032 3032 312d 3039 2d32 3054 3034  .# 2021-09-20T04
-0001c610: 3a31 303a 3334 2e39 3334 5a20 5b70 6562  :10:34.934Z [peb
-0001c620: 626c 655d 2053 7461 7274 6564 2064 6165  ble] Started dae
-0001c630: 6d6f 6e0a 230a 2320 496e 2061 6e6f 7468  mon.#.# In anoth
-0001c640: 6572 2074 6572 6d69 6e61 6c2c 2072 756e  er terminal, run
-0001c650: 2074 6865 2074 6573 7473 3a0a 230a 2320   the tests:.#.# 
-0001c660: 2420 736f 7572 6365 202e 746f 782f 756e  $ source .tox/un
-0001c670: 6974 2f62 696e 2f61 6374 6976 6174 650a  it/bin/activate.
-0001c680: 2320 2420 5255 4e5f 5245 414c 5f50 4542  # $ RUN_REAL_PEB
-0001c690: 424c 455f 5445 5354 533d 3120 5045 4242  BLE_TESTS=1 PEBB
-0001c6a0: 4c45 3d7e 2f70 6562 626c 6520 7079 7465  LE=~/pebble pyte
-0001c6b0: 7374 2074 6573 742f 7465 7374 5f70 6562  st test/test_peb
-0001c6c0: 626c 652e 7079 202d 7620 2d6b 2052 6561  ble.py -v -k Rea
-0001c6d0: 6c50 6562 626c 650a 2320 2420 6465 6163  lPebble.# $ deac
-0001c6e0: 7469 7661 7465 0a23 0a40 756e 6974 7465  tivate.#.@unitte
-0001c6f0: 7374 2e73 6b69 7055 6e6c 6573 7328 6f73  st.skipUnless(os
-0001c700: 2e67 6574 656e 7628 2752 554e 5f52 4541  .getenv('RUN_REA
-0001c710: 4c5f 5045 4242 4c45 5f54 4553 5453 2729  L_PEBBLE_TESTS')
-0001c720: 2c20 2752 554e 5f52 4541 4c5f 5045 4242  , 'RUN_REAL_PEBB
-0001c730: 4c45 5f54 4553 5453 206e 6f74 2073 6574  LE_TESTS not set
-0001c740: 2729 0a63 6c61 7373 2054 6573 7452 6561  ').class TestRea
-0001c750: 6c50 6562 626c 6528 756e 6974 7465 7374  lPebble(unittest
-0001c760: 2e54 6573 7443 6173 6529 3a0a 2020 2020  .TestCase):.    
-0001c770: 6465 6620 7365 7455 7028 7365 6c66 293a  def setUp(self):
-0001c780: 0a20 2020 2020 2020 2073 6f63 6b65 745f  .        socket_
-0001c790: 7061 7468 203d 206f 732e 6765 7465 6e76  path = os.getenv
-0001c7a0: 2827 5045 4242 4c45 5f53 4f43 4b45 5427  ('PEBBLE_SOCKET'
-0001c7b0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0001c7c0: 2073 6f63 6b65 745f 7061 7468 2061 6e64   socket_path and
-0001c7d0: 206f 732e 6765 7465 6e76 2827 5045 4242   os.getenv('PEBB
-0001c7e0: 4c45 2729 3a0a 2020 2020 2020 2020 2020  LE'):.          
-0001c7f0: 2020 736f 636b 6574 5f70 6174 6820 3d20    socket_path = 
-0001c800: 6f73 2e70 6174 682e 6a6f 696e 286f 732e  os.path.join(os.
-0001c810: 6765 7465 6e76 2827 5045 4242 4c45 2729  getenv('PEBBLE')
-0001c820: 2c20 272e 7065 6262 6c65 2e73 6f63 6b65  , '.pebble.socke
-0001c830: 7427 290a 2020 2020 2020 2020 6173 7365  t').        asse
-0001c840: 7274 2073 6f63 6b65 745f 7061 7468 2c20  rt socket_path, 
-0001c850: 2750 4542 424c 4520 6f72 2050 4542 424c  'PEBBLE or PEBBL
-0001c860: 455f 534f 434b 4554 206d 7573 7420 6265  E_SOCKET must be
-0001c870: 2073 6574 2069 6620 5255 4e5f 5245 414c   set if RUN_REAL
-0001c880: 5f50 4542 424c 455f 5445 5354 5320 7365  _PEBBLE_TESTS se
-0001c890: 7427 0a0a 2020 2020 2020 2020 7365 6c66  t'..        self
-0001c8a0: 2e63 6c69 656e 7420 3d20 7065 6262 6c65  .client = pebble
-0001c8b0: 2e43 6c69 656e 7428 736f 636b 6574 5f70  .Client(socket_p
-0001c8c0: 6174 683d 736f 636b 6574 5f70 6174 6829  ath=socket_path)
-0001c8d0: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-0001c8e0: 6865 636b 735f 616e 645f 6865 616c 7468  hecks_and_health
-0001c8f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001c900: 7365 6c66 2e63 6c69 656e 742e 6164 645f  self.client.add_
-0001c910: 6c61 7965 7228 276c 6179 6572 272c 207b  layer('layer', {
-0001c920: 0a20 2020 2020 2020 2020 2020 2027 6368  .            'ch
-0001c930: 6563 6b73 273a 207b 0a20 2020 2020 2020  ecks': {.       
-0001c940: 2020 2020 2020 2020 2027 6261 6427 3a20           'bad': 
-0001c950: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0001c960: 2020 2020 2020 276f 7665 7272 6964 6527        'override'
-0001c970: 3a20 2772 6570 6c61 6365 272c 0a20 2020  : 'replace',.   
-0001c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c990: 2027 6c65 7665 6c27 3a20 2772 6561 6479   'level': 'ready
-0001c9a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0001c9b0: 2020 2020 2020 2027 7065 7269 6f64 273a         'period':
-0001c9c0: 2027 3530 6d73 272c 0a20 2020 2020 2020   '50ms',.       
-0001c9d0: 2020 2020 2020 2020 2020 2020 2027 7468               'th
-0001c9e0: 7265 7368 6f6c 6427 3a20 322c 0a20 2020  reshold': 2,.   
-0001c9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca00: 2027 6578 6563 273a 207b 0a20 2020 2020   'exec': {.     
-0001ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca20: 2020 2027 636f 6d6d 616e 6427 3a20 2773     'command': 's
-0001ca30: 6c65 6570 2078 272c 0a20 2020 2020 2020  leep x',.       
-0001ca40: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
-0001ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca60: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0001ca70: 2020 2027 676f 6f64 273a 207b 0a20 2020     'good': {.   
-0001ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca90: 2027 6f76 6572 7269 6465 273a 2027 7265   'override': 're
-0001caa0: 706c 6163 6527 2c0a 2020 2020 2020 2020  place',.        
-0001cab0: 2020 2020 2020 2020 2020 2020 276c 6576              'lev
-0001cac0: 656c 273a 2027 616c 6976 6527 2c0a 2020  el': 'alive',.  
-0001cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cae0: 2020 2770 6572 696f 6427 3a20 2735 306d    'period': '50m
-0001caf0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0001cb00: 2020 2020 2020 2020 2765 7865 6327 3a20          'exec': 
-0001cb10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0001cb20: 2020 2020 2020 2020 2020 2763 6f6d 6d61            'comma
-0001cb30: 6e64 273a 2027 6563 686f 2066 6f6f 272c  nd': 'echo foo',
-0001cb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cb50: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0001cb60: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-0001cb70: 2020 2020 2020 2020 2020 2027 6f74 6865             'othe
-0001cb80: 7227 3a20 7b0a 2020 2020 2020 2020 2020  r': {.          
-0001cb90: 2020 2020 2020 2020 2020 276f 7665 7272            'overr
-0001cba0: 6964 6527 3a20 2772 6570 6c61 6365 272c  ide': 'replace',
-0001cbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cbc0: 2020 2020 2027 6578 6563 273a 207b 0a20       'exec': {. 
-0001cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbe0: 2020 2020 2020 2027 636f 6d6d 616e 6427         'command'
-0001cbf0: 3a20 2765 6368 6f20 6261 7227 2c0a 2020  : 'echo bar',.  
-0001cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc10: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0001cc20: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0001cc30: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-0001cc40: 2c20 636f 6d62 696e 653d 5472 7565 290a  , combine=True).
-0001cc50: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-0001cc60: 7320 7368 6f75 6c64 2061 6c6c 2062 6520  s should all be 
-0001cc70: 2275 7022 2069 6e69 7469 616c 6c79 0a20  "up" initially. 
-0001cc80: 2020 2020 2020 2063 6865 636b 7320 3d20         checks = 
-0001cc90: 7365 6c66 2e63 6c69 656e 742e 6765 745f  self.client.get_
-0001cca0: 6368 6563 6b73 2829 0a20 2020 2020 2020  checks().       
-0001ccb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001ccc0: 6c28 6c65 6e28 6368 6563 6b73 292c 2033  l(len(checks), 3
-0001ccd0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001cce0: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0001ccf0: 735b 305d 2e6e 616d 652c 2027 6261 6427  s[0].name, 'bad'
-0001cd00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001cd10: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0001cd20: 735b 305d 2e6c 6576 656c 2c20 7065 6262  s[0].level, pebb
-0001cd30: 6c65 2e43 6865 636b 4c65 7665 6c2e 5245  le.CheckLevel.RE
-0001cd40: 4144 5929 0a20 2020 2020 2020 2073 656c  ADY).        sel
-0001cd50: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
-0001cd60: 6563 6b73 5b30 5d2e 7374 6174 7573 2c20  ecks[0].status, 
-0001cd70: 7065 6262 6c65 2e43 6865 636b 5374 6174  pebble.CheckStat
-0001cd80: 7573 2e55 5029 0a20 2020 2020 2020 2073  us.UP).        s
-0001cd90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001cda0: 6368 6563 6b73 5b31 5d2e 6e61 6d65 2c20  checks[1].name, 
-0001cdb0: 2767 6f6f 6427 290a 2020 2020 2020 2020  'good').        
-0001cdc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001cdd0: 2863 6865 636b 735b 315d 2e6c 6576 656c  (checks[1].level
-0001cde0: 2c20 7065 6262 6c65 2e43 6865 636b 4c65  , pebble.CheckLe
-0001cdf0: 7665 6c2e 414c 4956 4529 0a20 2020 2020  vel.ALIVE).     
-0001ce00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001ce10: 7561 6c28 6368 6563 6b73 5b31 5d2e 7374  ual(checks[1].st
-0001ce20: 6174 7573 2c20 7065 6262 6c65 2e43 6865  atus, pebble.Che
-0001ce30: 636b 5374 6174 7573 2e55 5029 0a20 2020  ckStatus.UP).   
-0001ce40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001ce50: 4571 7561 6c28 6368 6563 6b73 5b32 5d2e  Equal(checks[2].
-0001ce60: 6e61 6d65 2c20 276f 7468 6572 2729 0a20  name, 'other'). 
-0001ce70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0001ce80: 7274 4571 7561 6c28 6368 6563 6b73 5b32  rtEqual(checks[2
-0001ce90: 5d2e 6c65 7665 6c2c 2070 6562 626c 652e  ].level, pebble.
-0001cea0: 4368 6563 6b4c 6576 656c 2e55 4e53 4554  CheckLevel.UNSET
-0001ceb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001cec0: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
-0001ced0: 735b 325d 2e73 7461 7475 732c 2070 6562  s[2].status, peb
-0001cee0: 626c 652e 4368 6563 6b53 7461 7475 732e  ble.CheckStatus.
-0001cef0: 5550 290a 0a20 2020 2020 2020 2023 2041  UP)..        # A
-0001cf00: 6e64 202f 7631 2f68 6561 6c74 6820 7368  nd /v1/health sh
-0001cf10: 6f75 6c64 2072 6574 7572 6e20 2268 6561  ould return "hea
-0001cf20: 6c74 6879 220a 2020 2020 2020 2020 6865  lthy".        he
-0001cf30: 616c 7468 203d 2073 656c 662e 5f67 6574  alth = self._get
-0001cf40: 5f68 6561 6c74 6828 290a 2020 2020 2020  _health().      
-0001cf50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001cf60: 616c 2868 6561 6c74 682c 207b 0a20 2020  al(health, {.   
-0001cf70: 2020 2020 2020 2020 2027 7265 7375 6c74           'result
-0001cf80: 273a 207b 2768 6561 6c74 6879 273a 2054  ': {'healthy': T
-0001cf90: 7275 657d 2c0a 2020 2020 2020 2020 2020  rue},.          
-0001cfa0: 2020 2773 7461 7475 7327 3a20 274f 4b27    'status': 'OK'
-0001cfb0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001cfc0: 7461 7475 732d 636f 6465 273a 2032 3030  tatus-code': 200
-0001cfd0: 2c0a 2020 2020 2020 2020 2020 2020 2774  ,.            't
-0001cfe0: 7970 6527 3a20 2773 796e 6327 2c0a 2020  ype': 'sync',.  
-0001cff0: 2020 2020 2020 7d29 0a0a 2020 2020 2020        })..      
-0001d000: 2020 2320 4166 7465 7220 7477 6f20 7265    # After two re
-0001d010: 7472 6965 7320 7468 6520 2262 6164 2220  tries the "bad" 
-0001d020: 6368 6563 6b20 7368 6f75 6c64 2067 6f20  check should go 
-0001d030: 646f 776e 0a20 2020 2020 2020 2066 6f72  down.        for
-0001d040: 2069 2069 6e20 7261 6e67 6528 3529 3a0a   i in range(5):.
-0001d050: 2020 2020 2020 2020 2020 2020 6368 6563              chec
-0001d060: 6b73 203d 2073 656c 662e 636c 6965 6e74  ks = self.client
-0001d070: 2e67 6574 5f63 6865 636b 7328 290a 2020  .get_checks().  
-0001d080: 2020 2020 2020 2020 2020 6261 645f 6368            bad_ch
-0001d090: 6563 6b20 3d20 5b63 2066 6f72 2063 2069  eck = [c for c i
-0001d0a0: 6e20 6368 6563 6b73 2069 6620 632e 6e61  n checks if c.na
-0001d0b0: 6d65 203d 3d20 2762 6164 275d 5b30 5d0a  me == 'bad'][0].
-0001d0c0: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-0001d0d0: 6164 5f63 6865 636b 2e73 7461 7475 7320  ad_check.status 
-0001d0e0: 3d3d 2070 6562 626c 652e 4368 6563 6b53  == pebble.CheckS
-0001d0f0: 7461 7475 732e 444f 574e 3a0a 2020 2020  tatus.DOWN:.    
-0001d100: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0001d110: 6b0a 2020 2020 2020 2020 2020 2020 7469  k.            ti
-0001d120: 6d65 2e73 6c65 6570 2830 2e30 3629 0a20  me.sleep(0.06). 
-0001d130: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001d140: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0001d150: 4661 6c73 652c 2027 7469 6d65 6420 6f75  False, 'timed ou
-0001d160: 7420 7761 6974 696e 6720 666f 7220 2262  t waiting for "b
-0001d170: 6164 2220 6368 6563 6b20 746f 2067 6f20  ad" check to go 
-0001d180: 646f 776e 270a 2020 2020 2020 2020 7365  down'.        se
-0001d190: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-0001d1a0: 6164 5f63 6865 636b 2e66 6169 6c75 7265  ad_check.failure
-0001d1b0: 732c 2032 290a 2020 2020 2020 2020 7365  s, 2).        se
-0001d1c0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-0001d1d0: 6164 5f63 6865 636b 2e74 6872 6573 686f  ad_check.thresho
-0001d1e0: 6c64 2c20 3229 0a20 2020 2020 2020 2067  ld, 2).        g
-0001d1f0: 6f6f 645f 6368 6563 6b20 3d20 5b63 2066  ood_check = [c f
-0001d200: 6f72 2063 2069 6e20 6368 6563 6b73 2069  or c in checks i
-0001d210: 6620 632e 6e61 6d65 203d 3d20 2767 6f6f  f c.name == 'goo
-0001d220: 6427 5d5b 305d 0a20 2020 2020 2020 2073  d'][0].        s
-0001d230: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d240: 676f 6f64 5f63 6865 636b 2e73 7461 7475  good_check.statu
-0001d250: 732c 2070 6562 626c 652e 4368 6563 6b53  s, pebble.CheckS
-0001d260: 7461 7475 732e 5550 290a 0a20 2020 2020  tatus.UP)..     
-0001d270: 2020 2023 2041 6e64 202f 7631 2f68 6561     # And /v1/hea
-0001d280: 6c74 6820 7368 6f75 6c64 2072 6574 7572  lth should retur
-0001d290: 6e20 2275 6e68 6561 6c74 6879 2220 2877  n "unhealthy" (w
-0001d2a0: 6974 6820 7374 6174 7573 2048 5454 5020  ith status HTTP 
-0001d2b0: 3530 3229 0a20 2020 2020 2020 2077 6974  502).        wit
-0001d2c0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0001d2d0: 7365 7328 7572 6c6c 6962 2e65 7272 6f72  ses(urllib.error
-0001d2e0: 2e48 5454 5045 7272 6f72 2920 6173 2063  .HTTPError) as c
-0001d2f0: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-0001d300: 656c 662e 5f67 6574 5f68 6561 6c74 6828  elf._get_health(
-0001d310: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001d320: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
-0001d330: 6365 7074 696f 6e2e 636f 6465 2c20 3530  ception.code, 50
-0001d340: 3229 0a20 2020 2020 2020 2068 6561 6c74  2).        healt
-0001d350: 6820 3d20 6a73 6f6e 2e6c 6f61 6473 2863  h = json.loads(c
-0001d360: 6d2e 6578 6365 7074 696f 6e2e 7265 6164  m.exception.read
-0001d370: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
-0001d380: 2e61 7373 6572 7445 7175 616c 2868 6561  .assertEqual(hea
-0001d390: 6c74 682c 207b 0a20 2020 2020 2020 2020  lth, {.         
-0001d3a0: 2020 2027 7265 7375 6c74 273a 207b 2768     'result': {'h
-0001d3b0: 6561 6c74 6879 273a 2046 616c 7365 7d2c  ealthy': False},
-0001d3c0: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
-0001d3d0: 6174 7573 273a 2027 4261 6420 4761 7465  atus': 'Bad Gate
-0001d3e0: 7761 7927 2c0a 2020 2020 2020 2020 2020  way',.          
-0001d3f0: 2020 2773 7461 7475 732d 636f 6465 273a    'status-code':
-0001d400: 2035 3032 2c0a 2020 2020 2020 2020 2020   502,.          
-0001d410: 2020 2774 7970 6527 3a20 2773 796e 6327    'type': 'sync'
-0001d420: 2c0a 2020 2020 2020 2020 7d29 0a0a 2020  ,.        })..  
-0001d430: 2020 2020 2020 2320 5468 656e 2074 6573        # Then tes
-0001d440: 7420 6669 6c74 6572 696e 6720 6279 2063  t filtering by c
-0001d450: 6865 636b 206c 6576 656c 2061 6e64 2062  heck level and b
-0001d460: 7920 6e61 6d65 0a20 2020 2020 2020 2063  y name.        c
-0001d470: 6865 636b 7320 3d20 7365 6c66 2e63 6c69  hecks = self.cli
-0001d480: 656e 742e 6765 745f 6368 6563 6b73 286c  ent.get_checks(l
-0001d490: 6576 656c 3d70 6562 626c 652e 4368 6563  evel=pebble.Chec
-0001d4a0: 6b4c 6576 656c 2e41 4c49 5645 290a 2020  kLevel.ALIVE).  
-0001d4b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001d4c0: 7445 7175 616c 286c 656e 2863 6865 636b  tEqual(len(check
-0001d4d0: 7329 2c20 3129 0a20 2020 2020 2020 2073  s), 1).        s
-0001d4e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d4f0: 6368 6563 6b73 5b30 5d2e 6e61 6d65 2c20  checks[0].name, 
-0001d500: 2767 6f6f 6427 290a 2020 2020 2020 2020  'good').        
-0001d510: 6368 6563 6b73 203d 2073 656c 662e 636c  checks = self.cl
-0001d520: 6965 6e74 2e67 6574 5f63 6865 636b 7328  ient.get_checks(
-0001d530: 6e61 6d65 733d 5b27 676f 6f64 272c 2027  names=['good', '
-0001d540: 6261 6427 5d29 0a20 2020 2020 2020 2073  bad']).        s
-0001d550: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d560: 6c65 6e28 6368 6563 6b73 292c 2032 290a  len(checks), 2).
-0001d570: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001d580: 6572 7445 7175 616c 2863 6865 636b 735b  ertEqual(checks[
-0001d590: 305d 2e6e 616d 652c 2027 6261 6427 290a  0].name, 'bad').
-0001d5a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001d5b0: 6572 7445 7175 616c 2863 6865 636b 735b  ertEqual(checks[
-0001d5c0: 315d 2e6e 616d 652c 2027 676f 6f64 2729  1].name, 'good')
-0001d5d0: 0a0a 2020 2020 6465 6620 5f67 6574 5f68  ..    def _get_h
-0001d5e0: 6561 6c74 6828 7365 6c66 293a 0a20 2020  ealth(self):.   
-0001d5f0: 2020 2020 2066 203d 2075 726c 6c69 622e       f = urllib.
-0001d600: 7265 7175 6573 742e 7572 6c6f 7065 6e28  request.urlopen(
-0001d610: 2768 7474 703a 2f2f 6c6f 6361 6c68 6f73  'http://localhos
-0001d620: 743a 3430 3030 2f76 312f 6865 616c 7468  t:4000/v1/health
-0001d630: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
-0001d640: 6e20 6a73 6f6e 2e6c 6f61 6473 2866 2e72  n json.loads(f.r
-0001d650: 6561 6428 2929 0a0a 2020 2020 6465 6620  ead())..    def 
-0001d660: 7465 7374 5f65 7865 635f 7761 6974 2873  test_exec_wait(s
-0001d670: 656c 6629 3a0a 2020 2020 2020 2020 7072  elf):.        pr
-0001d680: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
-0001d690: 656e 742e 6578 6563 285b 2774 7275 6527  ent.exec(['true'
-0001d6a0: 5d29 0a20 2020 2020 2020 2070 726f 6365  ]).        proce
-0001d6b0: 7373 2e77 6169 7428 290a 0a20 2020 2020  ss.wait()..     
-0001d6c0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0001d6d0: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
-0001d6e0: 2e45 7865 6345 7272 6f72 2920 6173 2063  .ExecError) as c
-0001d6f0: 6d3a 0a20 2020 2020 2020 2020 2020 2070  m:.            p
-0001d700: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
-0001d710: 6965 6e74 2e65 7865 6328 5b27 2f62 696e  ient.exec(['/bin
-0001d720: 2f73 6827 2c20 272d 6327 2c20 2765 7869  /sh', '-c', 'exi
-0001d730: 7420 3432 275d 290a 2020 2020 2020 2020  t 42']).        
-0001d740: 2020 2020 7072 6f63 6573 732e 7761 6974      process.wait
-0001d750: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0001d760: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
-0001d770: 7863 6570 7469 6f6e 2e65 7869 745f 636f  xception.exit_co
-0001d780: 6465 2c20 3432 290a 0a20 2020 2064 6566  de, 42)..    def
-0001d790: 2074 6573 745f 6578 6563 5f77 6169 745f   test_exec_wait_
-0001d7a0: 6f75 7470 7574 2873 656c 6629 3a0a 2020  output(self):.  
-0001d7b0: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
-0001d7c0: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
-0001d7d0: 285b 272f 6269 6e2f 7368 272c 2027 2d63  (['/bin/sh', '-c
-0001d7e0: 272c 2027 6563 686f 204f 5554 3b20 6563  ', 'echo OUT; ec
-0001d7f0: 686f 2045 5252 203e 2632 275d 290a 2020  ho ERR >&2']).  
-0001d800: 2020 2020 2020 6f75 742c 2065 7272 203d        out, err =
-0001d810: 2070 726f 6365 7373 2e77 6169 745f 6f75   process.wait_ou
-0001d820: 7470 7574 2829 0a20 2020 2020 2020 2073  tput().        s
-0001d830: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d840: 6f75 742c 2027 4f55 545c 6e27 290a 2020  out, 'OUT\n').  
-0001d850: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001d860: 7445 7175 616c 2865 7272 2c20 2745 5252  tEqual(err, 'ERR
-0001d870: 5c6e 2729 0a0a 2020 2020 2020 2020 7072  \n')..        pr
-0001d880: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
-0001d890: 656e 742e 6578 6563 285b 272f 6269 6e2f  ent.exec(['/bin/
-0001d8a0: 7368 272c 2027 2d63 272c 2027 6563 686f  sh', '-c', 'echo
-0001d8b0: 204f 5554 3b20 6563 686f 2045 5252 203e   OUT; echo ERR >
-0001d8c0: 2632 275d 2c20 656e 636f 6469 6e67 3d4e  &2'], encoding=N
-0001d8d0: 6f6e 6529 0a20 2020 2020 2020 206f 7574  one).        out
-0001d8e0: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
-0001d8f0: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
-0001d900: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001d910: 7445 7175 616c 286f 7574 2c20 6227 4f55  tEqual(out, b'OU
-0001d920: 545c 6e27 290a 2020 2020 2020 2020 7365  T\n').        se
-0001d930: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-0001d940: 7272 2c20 6227 4552 525c 6e27 290a 0a20  rr, b'ERR\n').. 
-0001d950: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0001d960: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
-0001d970: 6262 6c65 2e45 7865 6345 7272 6f72 2920  bble.ExecError) 
-0001d980: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-0001d990: 2020 2070 726f 6365 7373 203d 2073 656c     process = sel
-0001d9a0: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
-0001d9b0: 2f62 696e 2f73 6827 2c20 272d 6327 2c20  /bin/sh', '-c', 
-0001d9c0: 2765 6368 6f20 4f55 543b 2065 6368 6f20  'echo OUT; echo 
-0001d9d0: 4552 5220 3e26 323b 2065 7869 7420 3432  ERR >&2; exit 42
-0001d9e0: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
-0001d9f0: 7072 6f63 6573 732e 7761 6974 5f6f 7574  process.wait_out
-0001da00: 7075 7428 290a 2020 2020 2020 2020 7365  put().        se
-0001da10: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-0001da20: 6d2e 6578 6365 7074 696f 6e2e 6578 6974  m.exception.exit
-0001da30: 5f63 6f64 652c 2034 3229 0a20 2020 2020  _code, 42).     
-0001da40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001da50: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
-0001da60: 2e73 7464 6f75 742c 2027 4f55 545c 6e27  .stdout, 'OUT\n'
-0001da70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001da80: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
-0001da90: 6365 7074 696f 6e2e 7374 6465 7272 2c20  ception.stderr, 
-0001daa0: 2745 5252 5c6e 2729 0a0a 2020 2020 6465  'ERR\n')..    de
-0001dab0: 6620 7465 7374 5f65 7865 635f 7365 6e64  f test_exec_send
-0001dac0: 5f73 7464 696e 2873 656c 6629 3a0a 2020  _stdin(self):.  
-0001dad0: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
-0001dae0: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
-0001daf0: 285b 2761 776b 272c 2027 7b20 7072 696e  (['awk', '{ prin
-0001db00: 7420 746f 7570 7065 7228 2430 2920 7d27  t toupper($0) }'
-0001db10: 5d2c 2073 7464 696e 3d27 666f 6f5c 6e42  ], stdin='foo\nB
-0001db20: 6172 5c6e 2729 0a20 2020 2020 2020 206f  ar\n').        o
-0001db30: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
-0001db40: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
-0001db50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001db60: 6572 7445 7175 616c 286f 7574 2c20 2746  ertEqual(out, 'F
-0001db70: 4f4f 5c6e 4241 525c 6e27 290a 2020 2020  OO\nBAR\n').    
-0001db80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001db90: 7175 616c 2865 7272 2c20 2727 290a 0a20  qual(err, '').. 
-0001dba0: 2020 2020 2020 2070 726f 6365 7373 203d         process =
-0001dbb0: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
-0001dbc0: 6328 5b27 6177 6b27 2c20 277b 2070 7269  c(['awk', '{ pri
-0001dbd0: 6e74 2074 6f75 7070 6572 2824 3029 207d  nt toupper($0) }
-0001dbe0: 275d 2c20 7374 6469 6e3d 6227 666f 6f5c  '], stdin=b'foo\
-0001dbf0: 6e42 6172 5c6e 272c 0a20 2020 2020 2020  nBar\n',.       
-0001dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc10: 2020 2020 2020 2020 2020 2020 656e 636f              enco
-0001dc20: 6469 6e67 3d4e 6f6e 6529 0a20 2020 2020  ding=None).     
-0001dc30: 2020 206f 7574 2c20 6572 7220 3d20 7072     out, err = pr
-0001dc40: 6f63 6573 732e 7761 6974 5f6f 7574 7075  ocess.wait_outpu
-0001dc50: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0001dc60: 2e61 7373 6572 7445 7175 616c 286f 7574  .assertEqual(out
-0001dc70: 2c20 6227 464f 4f5c 6e42 4152 5c6e 2729  , b'FOO\nBAR\n')
-0001dc80: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001dc90: 7365 7274 4571 7561 6c28 6572 722c 2062  sertEqual(err, b
-0001dca0: 2727 290a 0a20 2020 2064 6566 2074 6573  '')..    def tes
-0001dcb0: 745f 7075 7368 5f70 756c 6c28 7365 6c66  t_push_pull(self
-0001dcc0: 293a 0a20 2020 2020 2020 2066 6e61 6d65  ):.        fname
-0001dcd0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0001dce0: 7465 6d70 6669 6c65 2e67 6574 7465 6d70  tempfile.gettemp
-0001dcf0: 6469 7228 292c 2066 2770 6562 626c 6574  dir(), f'pebblet
-0001dd00: 6573 742d 7b75 7569 642e 7575 6964 3428  est-{uuid.uuid4(
-0001dd10: 297d 2729 0a20 2020 2020 2020 2063 6f6e  )}').        con
-0001dd20: 7465 6e74 203d 2027 666f 6f5c 6e62 6172  tent = 'foo\nbar
-0001dd30: 5c6e 6261 7a2d 3432 270a 2020 2020 2020  \nbaz-42'.      
-0001dd40: 2020 7365 6c66 2e63 6c69 656e 742e 7075    self.client.pu
-0001dd50: 7368 2866 6e61 6d65 2c20 636f 6e74 656e  sh(fname, conten
-0001dd60: 7429 0a20 2020 2020 2020 2077 6974 6820  t).        with 
-0001dd70: 7365 6c66 2e63 6c69 656e 742e 7075 6c6c  self.client.pull
-0001dd80: 2866 6e61 6d65 2920 6173 2066 3a0a 2020  (fname) as f:.  
-0001dd90: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-0001dda0: 2066 2e72 6561 6428 290a 2020 2020 2020   f.read().      
-0001ddb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001ddc0: 7445 7175 616c 2864 6174 612c 2063 6f6e  tEqual(data, con
-0001ddd0: 7465 6e74 290a 2020 2020 2020 2020 6f73  tent).        os
-0001dde0: 2e72 656d 6f76 6528 666e 616d 6529 0a0a  .remove(fname)..
-0001ddf0: 2020 2020 6465 6620 7465 7374 5f65 7865      def test_exe
-0001de00: 635f 7469 6d65 6f75 7428 7365 6c66 293a  c_timeout(self):
-0001de10: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-0001de20: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
-0001de30: 7865 6328 5b27 736c 6565 7027 2c20 2730  xec(['sleep', '0
-0001de40: 2e32 275d 2c20 7469 6d65 6f75 743d 302e  .2'], timeout=0.
-0001de50: 3129 0a20 2020 2020 2020 2077 6974 6820  1).        with 
-0001de60: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0001de70: 7328 7065 6262 6c65 2e43 6861 6e67 6545  s(pebble.ChangeE
-0001de80: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-0001de90: 2020 2020 2020 2020 2070 726f 6365 7373           process
-0001dea0: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
-0001deb0: 7365 6c66 2e61 7373 6572 7449 6e28 2774  self.assertIn('t
-0001dec0: 696d 6564 206f 7574 272c 2063 6d2e 6578  imed out', cm.ex
-0001ded0: 6365 7074 696f 6e2e 6572 7229 0a0a 2020  ception.err)..  
-0001dee0: 2020 6465 6620 7465 7374 5f65 7865 635f    def test_exec_
-0001def0: 776f 726b 696e 675f 6469 7228 7365 6c66  working_dir(self
-0001df00: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
-0001df10: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
-0001df20: 7279 4469 7265 6374 6f72 7928 2920 6173  ryDirectory() as
-0001df30: 2074 656d 705f 6469 723a 0a20 2020 2020   temp_dir:.     
-0001df40: 2020 2020 2020 2070 726f 6365 7373 203d         process =
-0001df50: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
-0001df60: 6328 5b27 7077 6427 5d2c 2077 6f72 6b69  c(['pwd'], worki
-0001df70: 6e67 5f64 6972 3d74 656d 705f 6469 7229  ng_dir=temp_dir)
-0001df80: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001df90: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
-0001dfa0: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
-0001dfb0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-0001dfc0: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
-0001dfd0: 6622 7b74 656d 705f 6469 727d 5c6e 2229  f"{temp_dir}\n")
-0001dfe0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001dff0: 662e 6173 7365 7274 4571 7561 6c28 6572  f.assertEqual(er
-0001e000: 722c 2027 2729 0a0a 2020 2020 6465 6620  r, '')..    def 
-0001e010: 7465 7374 5f65 7865 635f 656e 7669 726f  test_exec_enviro
-0001e020: 6e6d 656e 7428 7365 6c66 293a 0a20 2020  nment(self):.   
-0001e030: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
-0001e040: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
-0001e050: 5b27 2f62 696e 2f73 6827 2c20 272d 6327  ['/bin/sh', '-c'
-0001e060: 2c20 2765 6368 6f20 244f 4e45 2e24 5457  , 'echo $ONE.$TW
-0001e070: 4f2e 2454 4852 4545 275d 2c0a 2020 2020  O.$THREE'],.    
-0001e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e090: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001e0a0: 6e76 6972 6f6e 6d65 6e74 3d7b 274f 4e45  nvironment={'ONE
-0001e0b0: 273a 2027 3127 2c20 2754 574f 273a 2027  ': '1', 'TWO': '
-0001e0c0: 3227 7d29 0a20 2020 2020 2020 206f 7574  2'}).        out
-0001e0d0: 2c20 6572 7220 3d20 7072 6f63 6573 732e  , err = process.
-0001e0e0: 7761 6974 5f6f 7574 7075 7428 290a 2020  wait_output().  
-0001e0f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001e100: 7445 7175 616c 286f 7574 2c20 2731 2e32  tEqual(out, '1.2
-0001e110: 2e5c 6e27 290a 2020 2020 2020 2020 7365  .\n').        se
-0001e120: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-0001e130: 7272 2c20 2727 290a 0a20 2020 2064 6566  rr, '')..    def
-0001e140: 2074 6573 745f 6578 6563 5f73 7472 6561   test_exec_strea
-0001e150: 6d69 6e67 2873 656c 6629 3a0a 2020 2020  ming(self):.    
-0001e160: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
-0001e170: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
-0001e180: 2763 6174 275d 290a 0a20 2020 2020 2020  'cat'])..       
-0001e190: 2064 6566 2073 7464 696e 5f74 6872 6561   def stdin_threa
-0001e1a0: 6428 293a 0a20 2020 2020 2020 2020 2020  d():.           
-0001e1b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0001e1c0: 2020 2020 2020 666f 7220 6c69 6e65 2069        for line i
-0001e1d0: 6e20 5b27 6f6e 655c 6e27 2c20 2732 5c6e  n ['one\n', '2\n
-0001e1e0: 272c 2027 5448 5245 455c 6e27 5d3a 0a20  ', 'THREE\n']:. 
-0001e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e200: 2020 2070 726f 6365 7373 2e73 7464 696e     process.stdin
-0001e210: 2e77 7269 7465 286c 696e 6529 0a20 2020  .write(line).   
-0001e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e230: 2070 726f 6365 7373 2e73 7464 696e 2e66   process.stdin.f
-0001e240: 6c75 7368 2829 0a20 2020 2020 2020 2020  lush().         
-0001e250: 2020 2020 2020 2020 2020 2074 696d 652e             time.
-0001e260: 736c 6565 7028 302e 3129 0a20 2020 2020  sleep(0.1).     
-0001e270: 2020 2020 2020 2066 696e 616c 6c79 3a0a         finally:.
-0001e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e290: 7072 6f63 6573 732e 7374 6469 6e2e 636c  process.stdin.cl
-0001e2a0: 6f73 6528 290a 0a20 2020 2020 2020 2074  ose()..        t
-0001e2b0: 6872 6561 6469 6e67 2e54 6872 6561 6428  hreading.Thread(
-0001e2c0: 7461 7267 6574 3d73 7464 696e 5f74 6872  target=stdin_thr
-0001e2d0: 6561 6429 2e73 7461 7274 2829 0a0a 2020  ead).start()..  
-0001e2e0: 2020 2020 2020 7265 6164 7320 3d20 5b5d        reads = []
-0001e2f0: 0a20 2020 2020 2020 2066 6f72 206c 696e  .        for lin
-0001e300: 6520 696e 2070 726f 6365 7373 2e73 7464  e in process.std
-0001e310: 6f75 743a 0a20 2020 2020 2020 2020 2020  out:.           
-0001e320: 2072 6561 6473 2e61 7070 656e 6428 6c69   reads.append(li
-0001e330: 6e65 290a 0a20 2020 2020 2020 2070 726f  ne)..        pro
-0001e340: 6365 7373 2e77 6169 7428 290a 0a20 2020  cess.wait()..   
-0001e350: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0001e360: 4571 7561 6c28 7265 6164 732c 205b 276f  Equal(reads, ['o
-0001e370: 6e65 5c6e 272c 2027 325c 6e27 2c20 2754  ne\n', '2\n', 'T
-0001e380: 4852 4545 5c6e 275d 290a 0a20 2020 2064  HREE\n'])..    d
-0001e390: 6566 2074 6573 745f 6578 6563 5f73 7472  ef test_exec_str
-0001e3a0: 6561 6d69 6e67 5f62 7974 6573 2873 656c  eaming_bytes(sel
-0001e3b0: 6629 3a0a 2020 2020 2020 2020 7072 6f63  f):.        proc
-0001e3c0: 6573 7320 3d20 7365 6c66 2e63 6c69 656e  ess = self.clien
-0001e3d0: 742e 6578 6563 285b 2763 6174 275d 2c20  t.exec(['cat'], 
-0001e3e0: 656e 636f 6469 6e67 3d4e 6f6e 6529 0a0a  encoding=None)..
-0001e3f0: 2020 2020 2020 2020 6465 6620 7374 6469          def stdi
-0001e400: 6e5f 7468 7265 6164 2829 3a0a 2020 2020  n_thread():.    
-0001e410: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0001e420: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001e430: 206c 696e 6520 696e 205b 6227 6f6e 655c   line in [b'one\
-0001e440: 6e27 2c20 6227 325c 6e27 2c20 6227 5448  n', b'2\n', b'TH
-0001e450: 5245 455c 6e27 5d3a 0a20 2020 2020 2020  REE\n']:.       
-0001e460: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0001e470: 6365 7373 2e73 7464 696e 2e77 7269 7465  cess.stdin.write
-0001e480: 286c 696e 6529 0a20 2020 2020 2020 2020  (line).         
-0001e490: 2020 2020 2020 2020 2020 2070 726f 6365             proce
-0001e4a0: 7373 2e73 7464 696e 2e66 6c75 7368 2829  ss.stdin.flush()
-0001e4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e4c0: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
-0001e4d0: 302e 3129 0a20 2020 2020 2020 2020 2020  0.1).           
-0001e4e0: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-0001e4f0: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
-0001e500: 732e 7374 6469 6e2e 636c 6f73 6528 290a  s.stdin.close().
-0001e510: 0a20 2020 2020 2020 2074 6872 6561 6469  .        threadi
-0001e520: 6e67 2e54 6872 6561 6428 7461 7267 6574  ng.Thread(target
-0001e530: 3d73 7464 696e 5f74 6872 6561 6429 2e73  =stdin_thread).s
-0001e540: 7461 7274 2829 0a0a 2020 2020 2020 2020  tart()..        
-0001e550: 7265 6164 7320 3d20 5b5d 0a20 2020 2020  reads = [].     
-0001e560: 2020 2066 6f72 206c 696e 6520 696e 2070     for line in p
-0001e570: 726f 6365 7373 2e73 7464 6f75 743a 0a20  rocess.stdout:. 
-0001e580: 2020 2020 2020 2020 2020 2072 6561 6473             reads
-0001e590: 2e61 7070 656e 6428 6c69 6e65 290a 0a20  .append(line).. 
-0001e5a0: 2020 2020 2020 2070 726f 6365 7373 2e77         process.w
-0001e5b0: 6169 7428 290a 0a20 2020 2020 2020 2073  ait()..        s
-0001e5c0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001e5d0: 7265 6164 732c 205b 6227 6f6e 655c 6e27  reads, [b'one\n'
-0001e5e0: 2c20 6227 325c 6e27 2c20 6227 5448 5245  , b'2\n', b'THRE
-0001e5f0: 455c 6e27 5d29 0a                        E\n']).
+00014d90: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00014da0: 6e74 2e72 656d 6f76 655f 7061 7468 2827  nt.remove_path('
+00014db0: 2f62 6f6f 2f66 6172 272c 2072 6563 7572  /boo/far', recur
+00014dc0: 7369 7665 3d54 7275 6529 0a0a 2020 2020  sive=True)..    
+00014dd0: 2020 2020 7265 7120 3d20 7b27 6163 7469      req = {'acti
+00014de0: 6f6e 273a 2027 7265 6d6f 7665 272c 2027  on': 'remove', '
+00014df0: 7061 7468 7327 3a20 5b7b 0a20 2020 2020  paths': [{.     
+00014e00: 2020 2020 2020 2027 7061 7468 273a 2027         'path': '
+00014e10: 2f62 6f6f 2f66 6172 272c 0a20 2020 2020  /boo/far',.     
+00014e20: 2020 2020 2020 2027 7265 6375 7273 6976         'recursiv
+00014e30: 6527 3a20 5472 7565 2c0a 2020 2020 2020  e': True,.      
+00014e40: 2020 7d5d 7d0a 2020 2020 2020 2020 7365    }]}.        se
+00014e50: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00014e60: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00014e70: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+00014e80: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+00014e90: 2f66 696c 6573 272c 204e 6f6e 652c 2072  /files', None, r
+00014ea0: 6571 292c 0a20 2020 2020 2020 205d 290a  eq),.        ]).
+00014eb0: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+00014ec0: 6d6f 7665 5f70 6174 685f 6572 726f 7228  move_path_error(
+00014ed0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+00014ee0: 656c 662e 636c 6965 6e74 2e72 6573 706f  elf.client.respo
+00014ef0: 6e73 6573 2e61 7070 656e 6428 7b0a 2020  nses.append({.  
+00014f00: 2020 2020 2020 2020 2020 2272 6573 756c            "resul
+00014f10: 7422 3a20 5b7b 0a20 2020 2020 2020 2020  t": [{.         
+00014f20: 2020 2020 2020 2027 7061 7468 273a 2027         'path': '
+00014f30: 2f62 6f6f 2f66 6172 272c 0a20 2020 2020  /boo/far',.     
+00014f40: 2020 2020 2020 2020 2020 2027 6572 726f             'erro
+00014f50: 7227 3a20 7b0a 2020 2020 2020 2020 2020  r': {.          
+00014f60: 2020 2020 2020 2020 2020 276b 696e 6427            'kind'
+00014f70: 3a20 2767 656e 6572 6963 2d66 696c 652d  : 'generic-file-
+00014f80: 6572 726f 7227 2c0a 2020 2020 2020 2020  error',.        
+00014f90: 2020 2020 2020 2020 2020 2020 276d 6573              'mes
+00014fa0: 7361 6765 273a 2027 736f 6d65 206f 7468  sage': 'some oth
+00014fb0: 6572 2065 7272 6f72 272c 0a20 2020 2020  er error',.     
+00014fc0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00014fd0: 2020 2020 2020 2020 2020 7d5d 2c0a 2020            }],.  
+00014fe0: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
+00014ff0: 7327 3a20 274f 4b27 2c0a 2020 2020 2020  s': 'OK',.      
+00015000: 2020 2020 2020 2773 7461 7475 732d 636f        'status-co
+00015010: 6465 273a 2032 3030 2c0a 2020 2020 2020  de': 200,.      
+00015020: 2020 2020 2020 2774 7970 6527 3a20 2773        'type': 's
+00015030: 796e 6327 2c0a 2020 2020 2020 2020 7d29  ync',.        })
+00015040: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00015050: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00015060: 7065 6262 6c65 2e50 6174 6845 7272 6f72  pebble.PathError
+00015070: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00015080: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00015090: 2e72 656d 6f76 655f 7061 7468 2827 2f62  .remove_path('/b
+000150a0: 6f6f 2f66 6172 2729 0a20 2020 2020 2020  oo/far').       
+000150b0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+000150c0: 7374 616e 6365 2863 6d2e 6578 6365 7074  stance(cm.except
+000150d0: 696f 6e2c 2070 6562 626c 652e 4572 726f  ion, pebble.Erro
+000150e0: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
+000150f0: 6173 7365 7274 4571 7561 6c28 636d 2e65  assertEqual(cm.e
+00015100: 7863 6570 7469 6f6e 2e6b 696e 642c 2027  xception.kind, '
+00015110: 6765 6e65 7269 632d 6669 6c65 2d65 7272  generic-file-err
+00015120: 6f72 2729 0a20 2020 2020 2020 2073 656c  or').        sel
+00015130: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
+00015140: 2e65 7863 6570 7469 6f6e 2e6d 6573 7361  .exception.messa
+00015150: 6765 2c20 2773 6f6d 6520 6f74 6865 7220  ge, 'some other 
+00015160: 6572 726f 7227 290a 0a20 2020 2064 6566  error')..    def
+00015170: 2074 6573 745f 7365 6e64 5f73 6967 6e61   test_send_signa
+00015180: 6c5f 6e61 6d65 2873 656c 6629 3a0a 2020  l_name(self):.  
+00015190: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+000151a0: 742e 7265 7370 6f6e 7365 732e 6170 7065  t.responses.appe
+000151b0: 6e64 287b 0a20 2020 2020 2020 2020 2020  nd({.           
+000151c0: 2027 7265 7375 6c74 273a 2054 7275 652c   'result': True,
+000151d0: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
+000151e0: 6174 7573 273a 2027 4f4b 272c 0a20 2020  atus': 'OK',.   
+000151f0: 2020 2020 2020 2020 2027 7374 6174 7573           'status
+00015200: 2d63 6f64 6527 3a20 3230 302c 0a20 2020  -code': 200,.   
+00015210: 2020 2020 2020 2020 2027 7479 7065 273a           'type':
+00015220: 2027 7379 6e63 272c 0a20 2020 2020 2020   'sync',.       
+00015230: 207d 290a 0a20 2020 2020 2020 2073 656c   })..        sel
+00015240: 662e 636c 6965 6e74 2e73 656e 645f 7369  f.client.send_si
+00015250: 676e 616c 2827 5349 4748 5550 272c 205b  gnal('SIGHUP', [
+00015260: 2773 3127 2c20 2773 3227 5d29 0a0a 2020  's1', 's2'])..  
+00015270: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00015280: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
+00015290: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
+000152a0: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
+000152b0: 5427 2c20 272f 7631 2f73 6967 6e61 6c73  T', '/v1/signals
+000152c0: 272c 204e 6f6e 652c 207b 2773 6967 6e61  ', None, {'signa
+000152d0: 6c27 3a20 2753 4947 4855 5027 2c20 2773  l': 'SIGHUP', 's
+000152e0: 6572 7669 6365 7327 3a20 5b27 7331 272c  ervices': ['s1',
+000152f0: 2027 7332 275d 7d29 2c0a 2020 2020 2020   's2']}),.      
+00015300: 2020 5d29 0a0a 2020 2020 4075 6e69 7474    ])..    @unitt
+00015310: 6573 742e 736b 6970 556e 6c65 7373 2868  est.skipUnless(h
+00015320: 6173 6174 7472 2873 6967 6e61 6c2c 2027  asattr(signal, '
+00015330: 5349 4748 5550 2729 2c20 2773 6967 6e61  SIGHUP'), 'signa
+00015340: 6c20 636f 6e73 7461 6e74 7320 6e6f 7420  l constants not 
+00015350: 7072 6573 656e 7427 290a 2020 2020 6465  present').    de
+00015360: 6620 7465 7374 5f73 656e 645f 7369 676e  f test_send_sign
+00015370: 616c 5f6e 756d 6265 7228 7365 6c66 293a  al_number(self):
+00015380: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00015390: 6965 6e74 2e72 6573 706f 6e73 6573 2e61  ient.responses.a
+000153a0: 7070 656e 6428 7b0a 2020 2020 2020 2020  ppend({.        
+000153b0: 2020 2020 2772 6573 756c 7427 3a20 5472      'result': Tr
+000153c0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+000153d0: 2773 7461 7475 7327 3a20 274f 4b27 2c0a  'status': 'OK',.
+000153e0: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
+000153f0: 7475 732d 636f 6465 273a 2032 3030 2c0a  tus-code': 200,.
+00015400: 2020 2020 2020 2020 2020 2020 2774 7970              'typ
+00015410: 6527 3a20 2773 796e 6327 2c0a 2020 2020  e': 'sync',.    
+00015420: 2020 2020 7d29 0a0a 2020 2020 2020 2020      })..        
+00015430: 7365 6c66 2e63 6c69 656e 742e 7365 6e64  self.client.send
+00015440: 5f73 6967 6e61 6c28 7369 676e 616c 2e53  _signal(signal.S
+00015450: 4947 4855 502c 205b 2773 3127 2c20 2773  IGHUP, ['s1', 's
+00015460: 3227 5d29 0a0a 2020 2020 2020 2020 7365  2'])..        se
+00015470: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00015480: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00015490: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+000154a0: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+000154b0: 2f73 6967 6e61 6c73 272c 204e 6f6e 652c  /signals', None,
+000154c0: 207b 2773 6967 6e61 6c27 3a20 2753 4947   {'signal': 'SIG
+000154d0: 4855 5027 2c20 2773 6572 7669 6365 7327  HUP', 'services'
+000154e0: 3a20 5b27 7331 272c 2027 7332 275d 7d29  : ['s1', 's2']})
+000154f0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+00015500: 2020 6465 6620 7465 7374 5f73 656e 645f    def test_send_
+00015510: 7369 676e 616c 5f74 7970 655f 6572 726f  signal_type_erro
+00015520: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+00015530: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00015540: 7452 6169 7365 7328 5479 7065 4572 726f  tRaises(TypeErro
+00015550: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00015560: 7365 6c66 2e63 6c69 656e 742e 7365 6e64  self.client.send
+00015570: 5f73 6967 6e61 6c28 2753 4947 4855 5027  _signal('SIGHUP'
+00015580: 2c20 2773 686f 756c 642d 6265 2d61 2d6c  , 'should-be-a-l
+00015590: 6973 7427 290a 0a20 2020 2020 2020 2077  ist')..        w
+000155a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+000155b0: 6169 7365 7328 5479 7065 4572 726f 7229  aises(TypeError)
+000155c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000155d0: 6c66 2e63 6c69 656e 742e 7365 6e64 5f73  lf.client.send_s
+000155e0: 6967 6e61 6c28 2753 4947 4855 5027 2c20  ignal('SIGHUP', 
+000155f0: 5b31 2c20 325d 290a 0a20 2020 2064 6566  [1, 2])..    def
+00015600: 2074 6573 745f 6765 745f 6368 6563 6b73   test_get_checks
+00015610: 5f61 6c6c 2873 656c 6629 3a0a 2020 2020  _all(self):.    
+00015620: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+00015630: 7265 7370 6f6e 7365 732e 6170 7065 6e64  responses.append
+00015640: 287b 0a20 2020 2020 2020 2020 2020 2022  ({.            "
+00015650: 7265 7375 6c74 223a 205b 0a20 2020 2020  result": [.     
+00015660: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00015670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015680: 2022 6e61 6d65 223a 2022 6368 6b31 222c   "name": "chk1",
+00015690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000156a0: 2020 2020 2022 7374 6174 7573 223a 2022       "status": "
+000156b0: 7570 222c 0a20 2020 2020 2020 2020 2020  up",.           
+000156c0: 2020 2020 2020 2020 2022 7468 7265 7368           "thresh
+000156d0: 6f6c 6422 3a20 322c 0a20 2020 2020 2020  old": 2,.       
+000156e0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+000156f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00015700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015710: 2020 226e 616d 6522 3a20 2263 686b 3222    "name": "chk2"
+00015720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015730: 2020 2020 2020 226c 6576 656c 223a 2022        "level": "
+00015740: 616c 6976 6522 2c0a 2020 2020 2020 2020  alive",.        
+00015750: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00015760: 7475 7322 3a20 2264 6f77 6e22 2c0a 2020  tus": "down",.  
+00015770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015780: 2020 2266 6169 6c75 7265 7322 3a20 352c    "failures": 5,
+00015790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000157a0: 2020 2020 2022 7468 7265 7368 6f6c 6422       "threshold"
+000157b0: 3a20 332c 0a20 2020 2020 2020 2020 2020  : 3,.           
+000157c0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000157d0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+000157e0: 2020 2273 7461 7475 7322 3a20 224f 4b22    "status": "OK"
+000157f0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+00015800: 7461 7475 732d 636f 6465 223a 2032 3030  tatus-code": 200
+00015810: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00015820: 7970 6522 3a20 2273 796e 6322 0a20 2020  ype": "sync".   
+00015830: 2020 2020 207d 290a 2020 2020 2020 2020       }).        
+00015840: 6368 6563 6b73 203d 2073 656c 662e 636c  checks = self.cl
+00015850: 6965 6e74 2e67 6574 5f63 6865 636b 7328  ient.get_checks(
+00015860: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00015870: 7373 6572 7445 7175 616c 286c 656e 2863  ssertEqual(len(c
+00015880: 6865 636b 7329 2c20 3229 0a20 2020 2020  hecks), 2).     
+00015890: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000158a0: 7561 6c28 6368 6563 6b73 5b30 5d2e 6e61  ual(checks[0].na
+000158b0: 6d65 2c20 2763 686b 3127 290a 2020 2020  me, 'chk1').    
+000158c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000158d0: 7175 616c 2863 6865 636b 735b 305d 2e6c  qual(checks[0].l
+000158e0: 6576 656c 2c20 7065 6262 6c65 2e43 6865  evel, pebble.Che
+000158f0: 636b 4c65 7665 6c2e 554e 5345 5429 0a20  ckLevel.UNSET). 
+00015900: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015910: 7274 4571 7561 6c28 6368 6563 6b73 5b30  rtEqual(checks[0
+00015920: 5d2e 7374 6174 7573 2c20 7065 6262 6c65  ].status, pebble
+00015930: 2e43 6865 636b 5374 6174 7573 2e55 5029  .CheckStatus.UP)
+00015940: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00015950: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
+00015960: 5b30 5d2e 6661 696c 7572 6573 2c20 3029  [0].failures, 0)
+00015970: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00015980: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
+00015990: 5b30 5d2e 7468 7265 7368 6f6c 642c 2032  [0].threshold, 2
+000159a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000159b0: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+000159c0: 735b 315d 2e6e 616d 652c 2027 6368 6b32  s[1].name, 'chk2
+000159d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000159e0: 6173 7365 7274 4571 7561 6c28 6368 6563  assertEqual(chec
+000159f0: 6b73 5b31 5d2e 6c65 7665 6c2c 2070 6562  ks[1].level, peb
+00015a00: 626c 652e 4368 6563 6b4c 6576 656c 2e41  ble.CheckLevel.A
+00015a10: 4c49 5645 290a 2020 2020 2020 2020 7365  LIVE).        se
+00015a20: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00015a30: 6865 636b 735b 315d 2e73 7461 7475 732c  hecks[1].status,
+00015a40: 2070 6562 626c 652e 4368 6563 6b53 7461   pebble.CheckSta
+00015a50: 7475 732e 444f 574e 290a 2020 2020 2020  tus.DOWN).      
+00015a60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00015a70: 616c 2863 6865 636b 735b 315d 2e66 6169  al(checks[1].fai
+00015a80: 6c75 7265 732c 2035 290a 2020 2020 2020  lures, 5).      
+00015a90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00015aa0: 616c 2863 6865 636b 735b 315d 2e74 6872  al(checks[1].thr
+00015ab0: 6573 686f 6c64 2c20 3329 0a0a 2020 2020  eshold, 3)..    
+00015ac0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00015ad0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+00015ae0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+00015af0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+00015b00: 2027 2f76 312f 6368 6563 6b73 272c 207b   '/v1/checks', {
+00015b10: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
+00015b20: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+00015b30: 7374 5f67 6574 5f63 6865 636b 735f 6669  st_get_checks_fi
+00015b40: 6c74 6572 7328 7365 6c66 293a 0a20 2020  lters(self):.   
+00015b50: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+00015b60: 2e72 6573 706f 6e73 6573 2e61 7070 656e  .responses.appen
+00015b70: 6428 7b0a 2020 2020 2020 2020 2020 2020  d({.            
+00015b80: 2272 6573 756c 7422 3a20 5b0a 2020 2020  "result": [.    
+00015b90: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00015ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015bb0: 2020 226e 616d 6522 3a20 2263 686b 3222    "name": "chk2"
+00015bc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015bd0: 2020 2020 2020 226c 6576 656c 223a 2022        "level": "
+00015be0: 7265 6164 7922 2c0a 2020 2020 2020 2020  ready",.        
+00015bf0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00015c00: 7475 7322 3a20 2275 7022 2c0a 2020 2020  tus": "up",.    
+00015c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c20: 2274 6872 6573 686f 6c64 223a 2033 2c0a  "threshold": 3,.
+00015c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c40: 7d2c 0a20 2020 2020 2020 2020 2020 205d  },.            ]
+00015c50: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+00015c60: 7461 7475 7322 3a20 224f 4b22 2c0a 2020  tatus": "OK",.  
+00015c70: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+00015c80: 732d 636f 6465 223a 2032 3030 2c0a 2020  s-code": 200,.  
+00015c90: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+00015ca0: 3a20 2273 796e 6322 0a20 2020 2020 2020  : "sync".       
+00015cb0: 207d 290a 2020 2020 2020 2020 6368 6563   }).        chec
+00015cc0: 6b73 203d 2073 656c 662e 636c 6965 6e74  ks = self.client
+00015cd0: 2e67 6574 5f63 6865 636b 7328 6c65 7665  .get_checks(leve
+00015ce0: 6c3d 7065 6262 6c65 2e43 6865 636b 4c65  l=pebble.CheckLe
+00015cf0: 7665 6c2e 5245 4144 592c 206e 616d 6573  vel.READY, names
+00015d00: 3d5b 2763 686b 3227 5d29 0a20 2020 2020  =['chk2']).     
+00015d10: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00015d20: 7561 6c28 6c65 6e28 6368 6563 6b73 292c  ual(len(checks),
+00015d30: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
+00015d40: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+00015d50: 636b 735b 305d 2e6e 616d 652c 2027 6368  cks[0].name, 'ch
+00015d60: 6b32 2729 0a20 2020 2020 2020 2073 656c  k2').        sel
+00015d70: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00015d80: 6563 6b73 5b30 5d2e 6c65 7665 6c2c 2070  ecks[0].level, p
+00015d90: 6562 626c 652e 4368 6563 6b4c 6576 656c  ebble.CheckLevel
+00015da0: 2e52 4541 4459 290a 2020 2020 2020 2020  .READY).        
+00015db0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00015dc0: 2863 6865 636b 735b 305d 2e73 7461 7475  (checks[0].statu
+00015dd0: 732c 2070 6562 626c 652e 4368 6563 6b53  s, pebble.CheckS
+00015de0: 7461 7475 732e 5550 290a 2020 2020 2020  tatus.UP).      
+00015df0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00015e00: 616c 2863 6865 636b 735b 305d 2e66 6169  al(checks[0].fai
+00015e10: 6c75 7265 732c 2030 290a 2020 2020 2020  lures, 0).      
+00015e20: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00015e30: 616c 2863 6865 636b 735b 305d 2e74 6872  al(checks[0].thr
+00015e40: 6573 686f 6c64 2c20 3329 0a0a 2020 2020  eshold, 3)..    
+00015e50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00015e60: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+00015e70: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+00015e80: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+00015e90: 2027 2f76 312f 6368 6563 6b73 272c 207b   '/v1/checks', {
+00015ea0: 276c 6576 656c 273a 2027 7265 6164 7927  'level': 'ready'
+00015eb0: 2c20 276e 616d 6573 273a 205b 2763 686b  , 'names': ['chk
+00015ec0: 3227 5d7d 2c20 4e6f 6e65 292c 0a20 2020  2']}, None),.   
+00015ed0: 2020 2020 205d 290a 0a20 2020 2064 6566       ])..    def
+00015ee0: 2074 6573 745f 6368 6563 6b6c 6576 656c   test_checklevel
+00015ef0: 5f63 6f6e 7665 7273 696f 6e28 7365 6c66  _conversion(self
+00015f00: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00015f10: 636c 6965 6e74 2e72 6573 706f 6e73 6573  client.responses
+00015f20: 2e61 7070 656e 6428 7b0a 2020 2020 2020  .append({.      
+00015f30: 2020 2020 2020 2272 6573 756c 7422 3a20        "result": 
+00015f40: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00015f50: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00015f60: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+00015f70: 2263 686b 3222 2c0a 2020 2020 2020 2020  "chk2",.        
+00015f80: 2020 2020 2020 2020 2020 2020 226c 6576              "lev
+00015f90: 656c 223a 2022 666f 6f62 6172 2122 2c0a  el": "foobar!",.
+00015fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fb0: 2020 2020 2273 7461 7475 7322 3a20 2275      "status": "u
+00015fc0: 7022 2c0a 2020 2020 2020 2020 2020 2020  p",.            
+00015fd0: 2020 2020 2020 2020 2274 6872 6573 686f          "thresho
+00015fe0: 6c64 223a 2033 2c0a 2020 2020 2020 2020  ld": 3,.        
+00015ff0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00016000: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00016010: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+00016020: 224f 4b22 2c0a 2020 2020 2020 2020 2020  "OK",.          
+00016030: 2020 2273 7461 7475 732d 636f 6465 223a    "status-code":
+00016040: 2032 3030 2c0a 2020 2020 2020 2020 2020   200,.          
+00016050: 2020 2274 7970 6522 3a20 2273 796e 6322    "type": "sync"
+00016060: 0a20 2020 2020 2020 207d 290a 2020 2020  .        }).    
+00016070: 2020 2020 6368 6563 6b73 203d 2073 656c      checks = sel
+00016080: 662e 636c 6965 6e74 2e67 6574 5f63 6865  f.client.get_che
+00016090: 636b 7328 6c65 7665 6c3d 7065 6262 6c65  cks(level=pebble
+000160a0: 2e43 6865 636b 4c65 7665 6c2e 5245 4144  .CheckLevel.READ
+000160b0: 592c 206e 616d 6573 3d5b 2763 686b 3227  Y, names=['chk2'
+000160c0: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+000160d0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+000160e0: 6368 6563 6b73 292c 2031 290a 2020 2020  checks), 1).    
+000160f0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016100: 7175 616c 2863 6865 636b 735b 305d 2e6e  qual(checks[0].n
+00016110: 616d 652c 2027 6368 6b32 2729 0a20 2020  ame, 'chk2').   
+00016120: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00016130: 4571 7561 6c28 6368 6563 6b73 5b30 5d2e  Equal(checks[0].
+00016140: 6c65 7665 6c2c 2027 666f 6f62 6172 2127  level, 'foobar!'
+00016150: 2920 2023 2073 7461 7973 2061 2072 6177  )  # stays a raw
+00016160: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
+00016170: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00016180: 2863 6865 636b 735b 305d 2e73 7461 7475  (checks[0].statu
+00016190: 732c 2070 6562 626c 652e 4368 6563 6b53  s, pebble.CheckS
+000161a0: 7461 7475 732e 5550 290a 2020 2020 2020  tatus.UP).      
+000161b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000161c0: 616c 2863 6865 636b 735b 305d 2e66 6169  al(checks[0].fai
+000161d0: 6c75 7265 732c 2030 290a 2020 2020 2020  lures, 0).      
+000161e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000161f0: 616c 2863 6865 636b 735b 305d 2e74 6872  al(checks[0].thr
+00016200: 6573 686f 6c64 2c20 3329 0a0a 2020 2020  eshold, 3)..    
+00016210: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00016220: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+00016230: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+00016240: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+00016250: 2027 2f76 312f 6368 6563 6b73 272c 207b   '/v1/checks', {
+00016260: 276c 6576 656c 273a 2027 7265 6164 7927  'level': 'ready'
+00016270: 2c20 276e 616d 6573 273a 205b 2763 686b  , 'names': ['chk
+00016280: 3227 5d7d 2c20 4e6f 6e65 292c 0a20 2020  2']}, None),.   
+00016290: 2020 2020 205d 290a 0a0a 636c 6173 7320       ])...class 
+000162a0: 5465 7374 536f 636b 6574 436c 6965 6e74  TestSocketClient
+000162b0: 2875 6e69 7474 6573 742e 5465 7374 4361  (unittest.TestCa
+000162c0: 7365 293a 0a20 2020 2064 6566 2074 6573  se):.    def tes
+000162d0: 745f 736f 636b 6574 5f6e 6f74 5f66 6f75  t_socket_not_fou
+000162e0: 6e64 2873 656c 6629 3a0a 2020 2020 2020  nd(self):.      
+000162f0: 2020 636c 6965 6e74 203d 2070 6562 626c    client = pebbl
+00016300: 652e 436c 6965 6e74 2873 6f63 6b65 745f  e.Client(socket_
+00016310: 7061 7468 3d27 646f 6573 5f6e 6f74 5f65  path='does_not_e
+00016320: 7869 7374 2729 0a20 2020 2020 2020 2077  xist').        w
+00016330: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+00016340: 6169 7365 7328 7065 6262 6c65 2e43 6f6e  aises(pebble.Con
+00016350: 6e65 6374 696f 6e45 7272 6f72 2920 6173  nectionError) as
+00016360: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
+00016370: 2063 6c69 656e 742e 6765 745f 7379 7374   client.get_syst
+00016380: 656d 5f69 6e66 6f28 290a 2020 2020 2020  em_info().      
+00016390: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+000163a0: 6e73 7461 6e63 6528 636d 2e65 7863 6570  nstance(cm.excep
+000163b0: 7469 6f6e 2c20 7065 6262 6c65 2e45 7272  tion, pebble.Err
+000163c0: 6f72 290a 0a20 2020 2064 6566 2074 6573  or)..    def tes
+000163d0: 745f 7265 616c 5f63 6c69 656e 7428 7365  t_real_client(se
+000163e0: 6c66 293a 0a20 2020 2020 2020 2073 6875  lf):.        shu
+000163f0: 7464 6f77 6e2c 2073 6f63 6b65 745f 7061  tdown, socket_pa
+00016400: 7468 203d 2066 616b 655f 7065 6262 6c65  th = fake_pebble
+00016410: 2e73 7461 7274 5f73 6572 7665 7228 290a  .start_server().
+00016420: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00016430: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00016440: 203d 2070 6562 626c 652e 436c 6965 6e74   = pebble.Client
+00016450: 2873 6f63 6b65 745f 7061 7468 3d73 6f63  (socket_path=soc
+00016460: 6b65 745f 7061 7468 290a 2020 2020 2020  ket_path).      
+00016470: 2020 2020 2020 696e 666f 203d 2063 6c69        info = cli
+00016480: 656e 742e 6765 745f 7379 7374 656d 5f69  ent.get_system_i
+00016490: 6e66 6f28 290a 2020 2020 2020 2020 2020  nfo().          
+000164a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000164b0: 616c 2869 6e66 6f2e 7665 7273 696f 6e2c  al(info.version,
+000164c0: 2027 332e 3134 2e31 3539 2729 0a0a 2020   '3.14.159')..  
+000164d0: 2020 2020 2020 2020 2020 6368 616e 6765            change
+000164e0: 5f69 6420 3d20 636c 6965 6e74 2e73 7461  _id = client.sta
+000164f0: 7274 5f73 6572 7669 6365 7328 5b27 666f  rt_services(['fo
+00016500: 6f27 5d2c 2074 696d 656f 7574 3d30 290a  o'], timeout=0).
+00016510: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00016520: 2e61 7373 6572 7445 7175 616c 2863 6861  .assertEqual(cha
+00016530: 6e67 655f 6964 2c20 2731 3233 3427 290a  nge_id, '1234').
+00016540: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00016550: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00016560: 7365 7328 7065 6262 6c65 2e41 5049 4572  ses(pebble.APIEr
+00016570: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
+00016580: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00016590: 6e74 2e73 7461 7274 5f73 6572 7669 6365  nt.start_service
+000165a0: 7328 5b27 6261 7227 5d2c 2074 696d 656f  s(['bar'], timeo
+000165b0: 7574 3d30 290a 2020 2020 2020 2020 2020  ut=0).          
+000165c0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+000165d0: 6e73 7461 6e63 6528 636d 2e65 7863 6570  nstance(cm.excep
+000165e0: 7469 6f6e 2c20 7065 6262 6c65 2e45 7272  tion, pebble.Err
+000165f0: 6f72 290a 2020 2020 2020 2020 2020 2020  or).            
+00016600: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00016610: 2863 6d2e 6578 6365 7074 696f 6e2e 636f  (cm.exception.co
+00016620: 6465 2c20 3430 3029 0a20 2020 2020 2020  de, 400).       
+00016630: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00016640: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
+00016650: 6f6e 2e73 7461 7475 732c 2027 4261 6420  on.status, 'Bad 
+00016660: 5265 7175 6573 7427 290a 2020 2020 2020  Request').      
+00016670: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00016680: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
+00016690: 696f 6e2e 6d65 7373 6167 652c 2027 7365  ion.message, 'se
+000166a0: 7276 6963 6520 2262 6172 2220 646f 6573  rvice "bar" does
+000166b0: 206e 6f74 2065 7869 7374 2729 0a0a 2020   not exist')..  
+000166c0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+000166d0: 2020 2020 2020 2020 2020 2073 6875 7464             shutd
+000166e0: 6f77 6e28 290a 0a0a 636c 6173 7320 5465  own()...class Te
+000166f0: 7374 4578 6563 4572 726f 7228 756e 6974  stExecError(unit
+00016700: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
+00016710: 2020 2020 6465 6620 7465 7374 5f69 6e69      def test_ini
+00016720: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+00016730: 2065 203d 2070 6562 626c 652e 4578 6563   e = pebble.Exec
+00016740: 4572 726f 7228 5b27 666f 6f27 5d2c 2034  Error(['foo'], 4
+00016750: 322c 2027 6f75 7427 2c20 2765 7272 2729  2, 'out', 'err')
+00016760: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016770: 7365 7274 4571 7561 6c28 652e 636f 6d6d  sertEqual(e.comm
+00016780: 616e 642c 205b 2766 6f6f 275d 290a 2020  and, ['foo']).  
+00016790: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000167a0: 7445 7175 616c 2865 2e65 7869 745f 636f  tEqual(e.exit_co
+000167b0: 6465 2c20 3432 290a 2020 2020 2020 2020  de, 42).        
+000167c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000167d0: 2865 2e73 7464 6f75 742c 2027 6f75 7427  (e.stdout, 'out'
+000167e0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000167f0: 7373 6572 7445 7175 616c 2865 2e73 7464  ssertEqual(e.std
+00016800: 6572 722c 2027 6572 7227 290a 0a20 2020  err, 'err')..   
+00016810: 2064 6566 2074 6573 745f 7374 7228 7365   def test_str(se
+00016820: 6c66 293a 0a20 2020 2020 2020 2065 203d  lf):.        e =
+00016830: 2070 6562 626c 652e 4578 6563 4572 726f   pebble.ExecErro
+00016840: 7228 5b27 7827 5d2c 2031 2c20 4e6f 6e65  r(['x'], 1, None
+00016850: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+00016860: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00016870: 2873 7472 2865 292c 2022 6e6f 6e2d 7a65  (str(e), "non-ze
+00016880: 726f 2065 7869 7420 636f 6465 2031 2065  ro exit code 1 e
+00016890: 7865 6375 7469 6e67 205b 2778 275d 2229  xecuting ['x']")
+000168a0: 0a0a 2020 2020 2020 2020 6520 3d20 7065  ..        e = pe
+000168b0: 6262 6c65 2e45 7865 6345 7272 6f72 285b  bble.ExecError([
+000168c0: 2778 275d 2c20 312c 2027 6f6e 6c79 2d6f  'x'], 1, 'only-o
+000168d0: 7574 272c 204e 6f6e 6529 0a20 2020 2020  ut', None).     
+000168e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000168f0: 7561 6c28 7374 7228 6529 2c20 226e 6f6e  ual(str(e), "non
+00016900: 2d7a 6572 6f20 6578 6974 2063 6f64 6520  -zero exit code 
+00016910: 3120 6578 6563 7574 696e 6720 5b27 7827  1 executing ['x'
+00016920: 5d2c 2073 7464 6f75 743d 276f 6e6c 792d  ], stdout='only-
+00016930: 6f75 7427 2229 0a0a 2020 2020 2020 2020  out'")..        
+00016940: 6520 3d20 7065 6262 6c65 2e45 7865 6345  e = pebble.ExecE
+00016950: 7272 6f72 285b 2778 275d 2c20 312c 204e  rror(['x'], 1, N
+00016960: 6f6e 652c 2027 6f6e 6c79 2d65 7272 2729  one, 'only-err')
+00016970: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016980: 7365 7274 4571 7561 6c28 7374 7228 6529  sertEqual(str(e)
+00016990: 2c20 226e 6f6e 2d7a 6572 6f20 6578 6974  , "non-zero exit
+000169a0: 2063 6f64 6520 3120 6578 6563 7574 696e   code 1 executin
+000169b0: 6720 5b27 7827 5d2c 2073 7464 6572 723d  g ['x'], stderr=
+000169c0: 276f 6e6c 792d 6572 7227 2229 0a0a 2020  'only-err'")..  
+000169d0: 2020 2020 2020 6520 3d20 7065 6262 6c65        e = pebble
+000169e0: 2e45 7865 6345 7272 6f72 285b 2761 272c  .ExecError(['a',
+000169f0: 2027 6227 5d2c 2031 2c20 276f 7574 272c   'b'], 1, 'out',
+00016a00: 2027 6572 7227 290a 2020 2020 2020 2020   'err').        
+00016a10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00016a20: 2873 7472 2865 292c 2022 6e6f 6e2d 7a65  (str(e), "non-ze
+00016a30: 726f 2065 7869 7420 636f 6465 2031 2065  ro exit code 1 e
+00016a40: 7865 6375 7469 6e67 205b 2761 272c 2027  xecuting ['a', '
+00016a50: 6227 5d2c 2022 0a20 2020 2020 2020 2020  b'], ".         
+00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a70: 2020 2020 2020 2020 2b20 2273 7464 6f75          + "stdou
+00016a80: 743d 276f 7574 272c 2073 7464 6572 723d  t='out', stderr=
+00016a90: 2765 7272 2722 290a 0a20 2020 2064 6566  'err'")..    def
+00016aa0: 2074 6573 745f 7374 725f 7472 756e 6361   test_str_trunca
+00016ab0: 7465 6428 7365 6c66 293a 0a20 2020 2020  ted(self):.     
+00016ac0: 2020 2065 203d 2070 6562 626c 652e 4578     e = pebble.Ex
+00016ad0: 6563 4572 726f 7228 5b27 666f 6f27 5d2c  ecError(['foo'],
+00016ae0: 2032 2c20 276c 6f6e 676f 7574 272c 2027   2, 'longout', '
+00016af0: 6c6f 6e67 6572 7227 290a 2020 2020 2020  longerr').      
+00016b00: 2020 652e 5354 525f 4d41 585f 4f55 5450    e.STR_MAX_OUTP
+00016b10: 5554 203d 2035 0a20 2020 2020 2020 2073  UT = 5.        s
+00016b20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00016b30: 7374 7228 6529 2c20 226e 6f6e 2d7a 6572  str(e), "non-zer
+00016b40: 6f20 6578 6974 2063 6f64 6520 3220 6578  o exit code 2 ex
+00016b50: 6563 7574 696e 6720 5b27 666f 6f27 5d2c  ecuting ['foo'],
+00016b60: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00016b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b80: 2020 2020 2b20 2273 7464 6f75 743d 276c      + "stdout='l
+00016b90: 6f6e 676f 2720 5b74 7275 6e63 6174 6564  ongo' [truncated
+00016ba0: 5d2c 2073 7464 6572 723d 276c 6f6e 6765  ], stderr='longe
+00016bb0: 2720 5b74 7275 6e63 6174 6564 5d22 290a  ' [truncated]").
+00016bc0: 0a0a 636c 6173 7320 4d6f 636b 5765 6273  ..class MockWebs
+00016bd0: 6f63 6b65 743a 0a20 2020 2064 6566 205f  ocket:.    def _
+00016be0: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
+00016bf0: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
+00016c00: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
+00016c10: 656c 662e 7265 6365 6976 6573 203d 205b  elf.receives = [
+00016c20: 5d0a 0a20 2020 2064 6566 2073 656e 645f  ]..    def send_
+00016c30: 6269 6e61 7279 2873 656c 662c 2062 293a  binary(self, b):
+00016c40: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00016c50: 6e64 732e 6170 7065 6e64 2828 2742 494e  nds.append(('BIN
+00016c60: 272c 2062 2929 0a0a 2020 2020 6465 6620  ', b))..    def 
+00016c70: 7365 6e64 2873 656c 662c 2073 293a 0a20  send(self, s):. 
+00016c80: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
+00016c90: 732e 6170 7065 6e64 2828 2754 5854 272c  s.append(('TXT',
+00016ca0: 2073 2929 0a0a 2020 2020 6465 6620 7265   s))..    def re
+00016cb0: 6376 2873 656c 6629 3a0a 2020 2020 2020  cv(self):.      
+00016cc0: 2020 7265 7475 726e 2073 656c 662e 7265    return self.re
+00016cd0: 6365 6976 6573 2e70 6f70 2830 290a 0a20  ceives.pop(0).. 
+00016ce0: 2020 2064 6566 2073 6875 7464 6f77 6e28     def shutdown(
+00016cf0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
+00016d00: 6173 730a 0a0a 636c 6173 7320 5465 7374  ass...class Test
+00016d10: 4578 6563 2875 6e69 7474 6573 742e 5465  Exec(unittest.Te
+00016d20: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+00016d30: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+00016d40: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00016d50: 7420 3d20 4d6f 636b 436c 6965 6e74 2829  t = MockClient()
+00016d60: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
+00016d70: 6d65 203d 204d 6f63 6b54 696d 6528 290a  me = MockTime().
+00016d80: 2020 2020 2020 2020 7469 6d65 5f70 6174          time_pat
+00016d90: 6368 6572 203d 2075 6e69 7474 6573 742e  cher = unittest.
+00016da0: 6d6f 636b 2e70 6174 6368 2827 6f70 732e  mock.patch('ops.
+00016db0: 7065 6262 6c65 2e74 696d 6527 2c20 7365  pebble.time', se
+00016dc0: 6c66 2e74 696d 6529 0a20 2020 2020 2020  lf.time).       
+00016dd0: 2074 696d 655f 7061 7463 6865 722e 7374   time_patcher.st
+00016de0: 6172 7428 290a 2020 2020 2020 2020 7365  art().        se
+00016df0: 6c66 2e61 6464 436c 6561 6e75 7028 7469  lf.addCleanup(ti
+00016e00: 6d65 5f70 6174 6368 6572 2e73 746f 7029  me_patcher.stop)
+00016e10: 0a0a 2020 2020 6465 6620 6164 645f 7265  ..    def add_re
+00016e20: 7370 6f6e 7365 7328 7365 6c66 2c20 6368  sponses(self, ch
+00016e30: 616e 6765 5f69 642c 2065 7869 745f 636f  ange_id, exit_co
+00016e40: 6465 2c20 6368 616e 6765 5f65 7272 3d4e  de, change_err=N
+00016e50: 6f6e 6529 3a0a 2020 2020 2020 2020 7461  one):.        ta
+00016e60: 736b 5f69 6420 3d20 6622 547b 6368 616e  sk_id = f"T{chan
+00016e70: 6765 5f69 647d 2220 2023 2063 7265 6174  ge_id}"  # creat
+00016e80: 6520 6120 7461 736b 5f69 6420 6261 7365  e a task_id base
+00016e90: 6420 6f6e 2063 6861 6e67 655f 6964 0a20  d on change_id. 
+00016ea0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00016eb0: 6e74 2e72 6573 706f 6e73 6573 2e61 7070  nt.responses.app
+00016ec0: 656e 6428 7b0a 2020 2020 2020 2020 2020  end({.          
+00016ed0: 2020 2763 6861 6e67 6527 3a20 6368 616e    'change': chan
+00016ee0: 6765 5f69 642c 0a20 2020 2020 2020 2020  ge_id,.         
+00016ef0: 2020 2027 7265 7375 6c74 273a 207b 2774     'result': {'t
+00016f00: 6173 6b2d 6964 273a 2074 6173 6b5f 6964  ask-id': task_id
+00016f10: 7d2c 0a20 2020 2020 2020 207d 290a 0a20  },.        }).. 
+00016f20: 2020 2020 2020 2063 6861 6e67 6520 3d20         change = 
+00016f30: 6275 696c 645f 6d6f 636b 5f63 6861 6e67  build_mock_chang
+00016f40: 655f 6469 6374 2863 6861 6e67 655f 6964  e_dict(change_id
+00016f50: 290a 2020 2020 2020 2020 6368 616e 6765  ).        change
+00016f60: 5b27 7461 736b 7327 5d5b 305d 5b27 6461  ['tasks'][0]['da
+00016f70: 7461 275d 203d 207b 2765 7869 742d 636f  ta'] = {'exit-co
+00016f80: 6465 273a 2065 7869 745f 636f 6465 7d0a  de': exit_code}.
+00016f90: 2020 2020 2020 2020 6966 2063 6861 6e67          if chang
+00016fa0: 655f 6572 7220 6973 206e 6f74 204e 6f6e  e_err is not Non
+00016fb0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+00016fc0: 6861 6e67 655b 2765 7272 275d 203d 2063  hange['err'] = c
+00016fd0: 6861 6e67 655f 6572 720a 2020 2020 2020  hange_err.      
+00016fe0: 2020 7365 6c66 2e63 6c69 656e 742e 7265    self.client.re
+00016ff0: 7370 6f6e 7365 732e 6170 7065 6e64 287b  sponses.append({
+00017000: 0a20 2020 2020 2020 2020 2020 2027 7265  .            're
+00017010: 7375 6c74 273a 2063 6861 6e67 652c 0a20  sult': change,. 
+00017020: 2020 2020 2020 207d 290a 0a20 2020 2020         })..     
+00017030: 2020 2073 7464 696f 203d 204d 6f63 6b57     stdio = MockW
+00017040: 6562 736f 636b 6574 2829 0a20 2020 2020  ebsocket().     
+00017050: 2020 2073 7464 6572 7220 3d20 4d6f 636b     stderr = Mock
+00017060: 5765 6273 6f63 6b65 7428 290a 2020 2020  Websocket().    
+00017070: 2020 2020 636f 6e74 726f 6c20 3d20 4d6f      control = Mo
+00017080: 636b 5765 6273 6f63 6b65 7428 290a 2020  ckWebsocket().  
+00017090: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+000170a0: 742e 7765 6273 6f63 6b65 7473 203d 207b  t.websockets = {
+000170b0: 0a20 2020 2020 2020 2020 2020 2028 7461  .            (ta
+000170c0: 736b 5f69 642c 2027 7374 6469 6f27 293a  sk_id, 'stdio'):
+000170d0: 2073 7464 696f 2c0a 2020 2020 2020 2020   stdio,.        
+000170e0: 2020 2020 2874 6173 6b5f 6964 2c20 2773      (task_id, 's
+000170f0: 7464 6572 7227 293a 2073 7464 6572 722c  tderr'): stderr,
+00017100: 0a20 2020 2020 2020 2020 2020 2028 7461  .            (ta
+00017110: 736b 5f69 642c 2027 636f 6e74 726f 6c27  sk_id, 'control'
+00017120: 293a 2063 6f6e 7472 6f6c 2c0a 2020 2020  ): control,.    
+00017130: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
+00017140: 7475 726e 2028 7374 6469 6f2c 2073 7464  turn (stdio, std
+00017150: 6572 722c 2063 6f6e 7472 6f6c 290a 0a20  err, control).. 
+00017160: 2020 2064 6566 2062 7569 6c64 5f65 7865     def build_exe
+00017170: 635f 6461 7461 280a 2020 2020 2020 2020  c_data(.        
+00017180: 2020 2020 7365 6c66 2c20 636f 6d6d 616e      self, comman
+00017190: 642c 2065 6e76 6972 6f6e 6d65 6e74 3d4e  d, environment=N
+000171a0: 6f6e 652c 2077 6f72 6b69 6e67 5f64 6972  one, working_dir
+000171b0: 3d4e 6f6e 652c 2074 696d 656f 7574 3d4e  =None, timeout=N
+000171c0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+000171d0: 2075 7365 725f 6964 3d4e 6f6e 652c 2075   user_id=None, u
+000171e0: 7365 723d 4e6f 6e65 2c20 6772 6f75 705f  ser=None, group_
+000171f0: 6964 3d4e 6f6e 652c 2067 726f 7570 3d4e  id=None, group=N
+00017200: 6f6e 652c 2063 6f6d 6269 6e65 5f73 7464  one, combine_std
+00017210: 6572 723d 4661 6c73 6529 3a0a 2020 2020  err=False):.    
+00017220: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
+00017230: 2020 2020 2020 2020 2027 636f 6d6d 616e           'comman
+00017240: 6427 3a20 636f 6d6d 616e 642c 0a20 2020  d': command,.   
+00017250: 2020 2020 2020 2020 2027 656e 7669 726f           'enviro
+00017260: 6e6d 656e 7427 3a20 656e 7669 726f 6e6d  nment': environm
+00017270: 656e 7420 6f72 207b 7d2c 0a20 2020 2020  ent or {},.     
+00017280: 2020 2020 2020 2027 776f 726b 696e 672d         'working-
+00017290: 6469 7227 3a20 776f 726b 696e 675f 6469  dir': working_di
+000172a0: 722c 0a20 2020 2020 2020 2020 2020 2027  r,.            '
+000172b0: 7469 6d65 6f75 7427 3a20 6627 7b74 696d  timeout': f'{tim
+000172c0: 656f 7574 3a2e 3366 7d73 2720 6966 2074  eout:.3f}s' if t
+000172d0: 696d 656f 7574 2069 7320 6e6f 7420 4e6f  imeout is not No
+000172e0: 6e65 2065 6c73 6520 4e6f 6e65 2c0a 2020  ne else None,.  
+000172f0: 2020 2020 2020 2020 2020 2775 7365 722d            'user-
+00017300: 6964 273a 2075 7365 725f 6964 2c0a 2020  id': user_id,.  
+00017310: 2020 2020 2020 2020 2020 2775 7365 7227            'user'
+00017320: 3a20 7573 6572 2c0a 2020 2020 2020 2020  : user,.        
+00017330: 2020 2020 2767 726f 7570 2d69 6427 3a20      'group-id': 
+00017340: 6772 6f75 705f 6964 2c0a 2020 2020 2020  group_id,.      
+00017350: 2020 2020 2020 2767 726f 7570 273a 2067        'group': g
+00017360: 726f 7570 2c0a 2020 2020 2020 2020 2020  roup,.          
+00017370: 2020 2773 706c 6974 2d73 7464 6572 7227    'split-stderr'
+00017380: 3a20 6e6f 7420 636f 6d62 696e 655f 7374  : not combine_st
+00017390: 6465 7272 2c0a 2020 2020 2020 2020 7d0a  derr,.        }.
+000173a0: 0a20 2020 2064 6566 2074 6573 745f 6172  .    def test_ar
+000173b0: 675f 6572 726f 7273 2873 656c 6629 3a0a  g_errors(self):.
+000173c0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000173d0: 662e 6173 7365 7274 5261 6973 6573 2854  f.assertRaises(T
+000173e0: 7970 6545 7272 6f72 293a 0a20 2020 2020  ypeError):.     
+000173f0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00017400: 6e74 2e65 7865 6328 2766 6f6f 2729 0a20  nt.exec('foo'). 
+00017410: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00017420: 2e61 7373 6572 7452 6169 7365 7328 5661  .assertRaises(Va
+00017430: 6c75 6545 7272 6f72 293a 0a20 2020 2020  lueError):.     
+00017440: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00017450: 6e74 2e65 7865 6328 5b5d 290a 2020 2020  nt.exec([]).    
+00017460: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00017470: 7365 7274 5261 6973 6573 2856 616c 7565  sertRaises(Value
+00017480: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00017490: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+000174a0: 6578 6563 285b 2766 6f6f 275d 2c20 7374  exec(['foo'], st
+000174b0: 6469 6e3d 2773 272c 2065 6e63 6f64 696e  din='s', encodin
+000174c0: 673d 4e6f 6e65 290a 2020 2020 2020 2020  g=None).        
+000174d0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+000174e0: 5261 6973 6573 2856 616c 7565 4572 726f  Raises(ValueErro
+000174f0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00017500: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
+00017510: 285b 2766 6f6f 275d 2c20 7374 6469 6e3d  (['foo'], stdin=
+00017520: 6227 7327 290a 2020 2020 2020 2020 7769  b's').        wi
+00017530: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00017540: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+00017550: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00017560: 662e 636c 6965 6e74 2e65 7865 6328 5b27  f.client.exec(['
+00017570: 666f 6f27 5d2c 2073 7464 696e 3d31 3233  foo'], stdin=123
+00017580: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+00017590: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000175a0: 2856 616c 7565 4572 726f 7229 3a0a 2020  (ValueError):.  
+000175b0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+000175c0: 6c69 656e 742e 6578 6563 285b 2766 6f6f  lient.exec(['foo
+000175d0: 275d 2c20 7374 646f 7574 3d69 6f2e 5374  '], stdout=io.St
+000175e0: 7269 6e67 494f 2829 2c20 7374 6465 7272  ringIO(), stderr
+000175f0: 3d69 6f2e 5374 7269 6e67 494f 2829 2c0a  =io.StringIO(),.
+00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017610: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00017620: 6269 6e65 5f73 7464 6572 723d 5472 7565  bine_stderr=True
+00017630: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00017640: 6e6f 5f77 6169 745f 6361 6c6c 2873 656c  no_wait_call(sel
+00017650: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00017660: 2e61 6464 5f72 6573 706f 6e73 6573 2827  .add_responses('
+00017670: 3132 3327 2c20 3029 0a20 2020 2020 2020  123', 0).       
+00017680: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00017690: 7457 6172 6e73 2852 6573 6f75 7263 6557  tWarns(ResourceW
+000176a0: 6172 6e69 6e67 2920 6173 2063 6d3a 0a20  arning) as cm:. 
+000176b0: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+000176c0: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
+000176d0: 2e65 7865 6328 5b27 7472 7565 275d 290a  .exec(['true']).
+000176e0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+000176f0: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
+00017700: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00017710: 2873 7472 2863 6d2e 7761 726e 696e 6729  (str(cm.warning)
+00017720: 2c20 2745 7865 6350 726f 6365 7373 2069  , 'ExecProcess i
+00017730: 6e73 7461 6e63 6520 6761 7262 6167 6520  nstance garbage 
+00017740: 636f 6c6c 6563 7465 6420 270a 2020 2020  collected '.    
+00017750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017770: 2020 2020 2020 2b20 2777 6974 686f 7574        + 'without
+00017780: 2063 616c 6c20 746f 2077 6169 7428 2920   call to wait() 
+00017790: 6f72 2077 6169 745f 6f75 7470 7574 2829  or wait_output()
+000177a0: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
+000177b0: 5f77 6169 745f 6578 6974 5f7a 6572 6f28  _wait_exit_zero(
+000177c0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+000177d0: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
+000177e0: 7328 2731 3233 272c 2030 290a 0a20 2020  s('123', 0)..   
+000177f0: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
+00017800: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
+00017810: 5b27 7472 7565 275d 290a 2020 2020 2020  ['true']).      
+00017820: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+00017830: 6f74 4e6f 6e65 2870 726f 6365 7373 2e73  otNone(process.s
+00017840: 7464 6f75 7429 0a20 2020 2020 2020 2073  tdout).        s
+00017850: 656c 662e 6173 7365 7274 4973 4e6f 744e  elf.assertIsNotN
+00017860: 6f6e 6528 7072 6f63 6573 732e 7374 6465  one(process.stde
+00017870: 7272 290a 2020 2020 2020 2020 7072 6f63  rr).        proc
+00017880: 6573 732e 7761 6974 2829 0a0a 2020 2020  ess.wait()..    
+00017890: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000178a0: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+000178b0: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+000178c0: 2020 2020 2020 2020 2028 2750 4f53 5427           ('POST'
+000178d0: 2c20 272f 7631 2f65 7865 6327 2c20 4e6f  , '/v1/exec', No
+000178e0: 6e65 2c20 7365 6c66 2e62 7569 6c64 5f65  ne, self.build_e
+000178f0: 7865 635f 6461 7461 285b 2774 7275 6527  xec_data(['true'
+00017900: 5d29 292c 0a20 2020 2020 2020 2020 2020  ])),.           
+00017910: 2028 2747 4554 272c 2027 2f76 312f 6368   ('GET', '/v1/ch
+00017920: 616e 6765 732f 3132 332f 7761 6974 272c  anges/123/wait',
+00017930: 207b 2774 696d 656f 7574 273a 2027 342e   {'timeout': '4.
+00017940: 3030 3073 277d 2c20 4e6f 6e65 292c 0a20  000s'}, None),. 
+00017950: 2020 2020 2020 205d 290a 0a20 2020 2064         ])..    d
+00017960: 6566 2074 6573 745f 7761 6974 5f65 7869  ef test_wait_exi
+00017970: 745f 6e6f 6e7a 6572 6f28 7365 6c66 293a  t_nonzero(self):
+00017980: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00017990: 645f 7265 7370 6f6e 7365 7328 2734 3536  d_responses('456
+000179a0: 272c 2031 290a 0a20 2020 2020 2020 2070  ', 1)..        p
+000179b0: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+000179c0: 6965 6e74 2e65 7865 6328 5b27 6661 6c73  ient.exec(['fals
+000179d0: 6527 5d29 0a20 2020 2020 2020 2077 6974  e']).        wit
+000179e0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+000179f0: 7365 7328 7065 6262 6c65 2e45 7865 6345  ses(pebble.ExecE
+00017a00: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
+00017a10: 2020 2020 2020 2020 2070 726f 6365 7373           process
+00017a20: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
+00017a30: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00017a40: 2863 6d2e 6578 6365 7074 696f 6e2e 636f  (cm.exception.co
+00017a50: 6d6d 616e 642c 205b 2766 616c 7365 275d  mmand, ['false']
+00017a60: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00017a70: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00017a80: 6365 7074 696f 6e2e 6578 6974 5f63 6f64  ception.exit_cod
+00017a90: 652c 2031 290a 2020 2020 2020 2020 7365  e, 1).        se
+00017aa0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00017ab0: 6d2e 6578 6365 7074 696f 6e2e 7374 646f  m.exception.stdo
+00017ac0: 7574 2c20 4e6f 6e65 290a 2020 2020 2020  ut, None).      
+00017ad0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00017ae0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
+00017af0: 7374 6465 7272 2c20 4e6f 6e65 290a 0a20  stderr, None).. 
+00017b00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00017b10: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
+00017b20: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
+00017b30: 2020 2020 2020 2020 2020 2020 2827 504f              ('PO
+00017b40: 5354 272c 2027 2f76 312f 6578 6563 272c  ST', '/v1/exec',
+00017b50: 204e 6f6e 652c 2073 656c 662e 6275 696c   None, self.buil
+00017b60: 645f 6578 6563 5f64 6174 6128 5b27 6661  d_exec_data(['fa
+00017b70: 6c73 6527 5d29 292c 0a20 2020 2020 2020  lse'])),.       
+00017b80: 2020 2020 2028 2747 4554 272c 2027 2f76       ('GET', '/v
+00017b90: 312f 6368 616e 6765 732f 3435 362f 7761  1/changes/456/wa
+00017ba0: 6974 272c 207b 2774 696d 656f 7574 273a  it', {'timeout':
+00017bb0: 2027 342e 3030 3073 277d 2c20 4e6f 6e65   '4.000s'}, None
+00017bc0: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
+00017bd0: 2020 2064 6566 2074 6573 745f 7761 6974     def test_wait
+00017be0: 5f74 696d 656f 7574 2873 656c 6629 3a0a  _timeout(self):.
+00017bf0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00017c00: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
+00017c10: 2c20 3029 0a0a 2020 2020 2020 2020 7072  , 0)..        pr
+00017c20: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
+00017c30: 656e 742e 6578 6563 285b 2774 7275 6527  ent.exec(['true'
+00017c40: 5d2c 2074 696d 656f 7574 3d32 290a 2020  ], timeout=2).  
+00017c50: 2020 2020 2020 7072 6f63 6573 732e 7761        process.wa
+00017c60: 6974 2829 0a0a 2020 2020 2020 2020 7365  it()..        se
+00017c70: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00017c80: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+00017c90: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+00017ca0: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+00017cb0: 2f65 7865 6327 2c20 4e6f 6e65 2c20 7365  /exec', None, se
+00017cc0: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
+00017cd0: 7461 285b 2774 7275 6527 5d2c 2074 696d  ta(['true'], tim
+00017ce0: 656f 7574 3d32 2929 2c0a 2020 2020 2020  eout=2)),.      
+00017cf0: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+00017d00: 7631 2f63 6861 6e67 6573 2f31 3233 2f77  v1/changes/123/w
+00017d10: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
+00017d20: 3a20 2733 2e30 3030 7327 7d2c 204e 6f6e  : '3.000s'}, Non
+00017d30: 6529 2c0a 2020 2020 2020 2020 5d29 0a0a  e),.        ])..
+00017d40: 2020 2020 6465 6620 7465 7374 5f77 6169      def test_wai
+00017d50: 745f 6f74 6865 725f 6172 6773 2873 656c  t_other_args(sel
+00017d60: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00017d70: 2e61 6464 5f72 6573 706f 6e73 6573 2827  .add_responses('
+00017d80: 3132 3327 2c20 3029 0a0a 2020 2020 2020  123', 0)..      
+00017d90: 2020 7072 6f63 6573 7320 3d20 7365 6c66    process = self
+00017da0: 2e63 6c69 656e 742e 6578 6563 280a 2020  .client.exec(.  
+00017db0: 2020 2020 2020 2020 2020 5b27 7472 7565            ['true
+00017dc0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+00017dd0: 656e 7669 726f 6e6d 656e 743d 7b27 4b31  environment={'K1
+00017de0: 273a 2027 5631 272c 2027 4b32 273a 2027  ': 'V1', 'K2': '
+00017df0: 5632 277d 2c0a 2020 2020 2020 2020 2020  V2'},.          
+00017e00: 2020 776f 726b 696e 675f 6469 723d 2757    working_dir='W
+00017e10: 4427 2c0a 2020 2020 2020 2020 2020 2020  D',.            
+00017e20: 7573 6572 5f69 643d 3130 3030 2c0a 2020  user_id=1000,.  
+00017e30: 2020 2020 2020 2020 2020 7573 6572 3d27            user='
+00017e40: 626f 6227 2c0a 2020 2020 2020 2020 2020  bob',.          
+00017e50: 2020 6772 6f75 705f 6964 3d31 3030 302c    group_id=1000,
+00017e60: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
+00017e70: 7570 3d27 7374 6166 6627 2c0a 2020 2020  up='staff',.    
+00017e80: 2020 2020 290a 2020 2020 2020 2020 7072      ).        pr
+00017e90: 6f63 6573 732e 7761 6974 2829 0a0a 2020  ocess.wait()..  
+00017ea0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00017eb0: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
+00017ec0: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
+00017ed0: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
+00017ee0: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
+00017ef0: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
+00017f00: 5f65 7865 635f 6461 7461 280a 2020 2020  _exec_data(.    
+00017f10: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+00017f20: 616e 643d 5b27 7472 7565 275d 2c0a 2020  and=['true'],.  
+00017f30: 2020 2020 2020 2020 2020 2020 2020 656e                en
+00017f40: 7669 726f 6e6d 656e 743d 7b27 4b31 273a  vironment={'K1':
+00017f50: 2027 5631 272c 2027 4b32 273a 2027 5632   'V1', 'K2': 'V2
+00017f60: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00017f70: 2020 2020 776f 726b 696e 675f 6469 723d      working_dir=
+00017f80: 2757 4427 2c0a 2020 2020 2020 2020 2020  'WD',.          
+00017f90: 2020 2020 2020 7573 6572 5f69 643d 3130        user_id=10
+00017fa0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00017fb0: 2020 2020 7573 6572 3d27 626f 6227 2c0a      user='bob',.
+00017fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fd0: 6772 6f75 705f 6964 3d31 3030 302c 0a20  group_id=1000,. 
+00017fe0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00017ff0: 726f 7570 3d27 7374 6166 6627 2c0a 2020  roup='staff',.  
+00018000: 2020 2020 2020 2020 2020 2929 2c0a 2020            )),.  
+00018010: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+00018020: 2c20 272f 7631 2f63 6861 6e67 6573 2f31  , '/v1/changes/1
+00018030: 3233 2f77 6169 7427 2c20 7b27 7469 6d65  23/wait', {'time
+00018040: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
+00018050: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+00018060: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+00018070: 5f77 6169 745f 6368 616e 6765 5f65 7272  _wait_change_err
+00018080: 6f72 2873 656c 6629 3a0a 2020 2020 2020  or(self):.      
+00018090: 2020 7365 6c66 2e61 6464 5f72 6573 706f    self.add_respo
+000180a0: 6e73 6573 2827 3132 3327 2c20 302c 2063  nses('123', 0, c
+000180b0: 6861 6e67 655f 6572 723d 2763 6861 6e67  hange_err='chang
+000180c0: 6520 6572 726f 7221 2729 0a0a 2020 2020  e error!')..    
+000180d0: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
+000180e0: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
+000180f0: 2774 7275 6527 5d29 0a20 2020 2020 2020  'true']).       
+00018100: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00018110: 7452 6169 7365 7328 7065 6262 6c65 2e43  tRaises(pebble.C
+00018120: 6861 6e67 6545 7272 6f72 2920 6173 2063  hangeError) as c
+00018130: 6d3a 0a20 2020 2020 2020 2020 2020 2070  m:.            p
+00018140: 726f 6365 7373 2e77 6169 7428 290a 2020  rocess.wait().  
+00018150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00018160: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
+00018170: 696f 6e2e 6572 722c 2027 6368 616e 6765  ion.err, 'change
+00018180: 2065 7272 6f72 2127 290a 2020 2020 2020   error!').      
+00018190: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000181a0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
+000181b0: 6368 616e 6765 2e69 642c 2027 3132 3327  change.id, '123'
+000181c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000181d0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+000181e0: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
+000181f0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00018200: 2827 504f 5354 272c 2027 2f76 312f 6578  ('POST', '/v1/ex
+00018210: 6563 272c 204e 6f6e 652c 2073 656c 662e  ec', None, self.
+00018220: 6275 696c 645f 6578 6563 5f64 6174 6128  build_exec_data(
+00018230: 5b27 7472 7565 275d 2929 2c0a 2020 2020  ['true'])),.    
+00018240: 2020 2020 2020 2020 2827 4745 5427 2c20          ('GET', 
+00018250: 272f 7631 2f63 6861 6e67 6573 2f31 3233  '/v1/changes/123
+00018260: 2f77 6169 7427 2c20 7b27 7469 6d65 6f75  /wait', {'timeou
+00018270: 7427 3a20 2734 2e30 3030 7327 7d2c 204e  t': '4.000s'}, N
+00018280: 6f6e 6529 2c0a 2020 2020 2020 2020 5d29  one),.        ])
+00018290: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
+000182a0: 656e 645f 7369 676e 616c 2873 656c 6629  end_signal(self)
+000182b0: 3a0a 2020 2020 2020 2020 5f2c 205f 2c20  :.        _, _, 
+000182c0: 636f 6e74 726f 6c20 3d20 7365 6c66 2e61  control = self.a
+000182d0: 6464 5f72 6573 706f 6e73 6573 2827 3132  dd_responses('12
+000182e0: 3327 2c20 3029 0a0a 2020 2020 2020 2020  3', 0)..        
+000182f0: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
+00018300: 6c69 656e 742e 6578 6563 285b 2773 6572  lient.exec(['ser
+00018310: 7665 7227 5d29 0a20 2020 2020 2020 2070  ver']).        p
+00018320: 726f 6365 7373 2e73 656e 645f 7369 676e  rocess.send_sign
+00018330: 616c 2827 5349 4748 5550 2729 0a20 2020  al('SIGHUP').   
+00018340: 2020 2020 206e 756d 5f73 656e 6473 203d       num_sends =
+00018350: 2031 0a20 2020 2020 2020 2069 6620 6861   1.        if ha
+00018360: 7361 7474 7228 7369 676e 616c 2c20 2753  sattr(signal, 'S
+00018370: 4947 4855 5027 293a 0a20 2020 2020 2020  IGHUP'):.       
+00018380: 2020 2020 2070 726f 6365 7373 2e73 656e       process.sen
+00018390: 645f 7369 676e 616c 2831 290a 2020 2020  d_signal(1).    
+000183a0: 2020 2020 2020 2020 7072 6f63 6573 732e          process.
+000183b0: 7365 6e64 5f73 6967 6e61 6c28 7369 676e  send_signal(sign
+000183c0: 616c 2e53 4947 4855 5029 0a20 2020 2020  al.SIGHUP).     
+000183d0: 2020 2020 2020 206e 756d 5f73 656e 6473         num_sends
+000183e0: 202b 3d20 320a 0a20 2020 2020 2020 2070   += 2..        p
+000183f0: 726f 6365 7373 2e77 6169 7428 290a 0a20  rocess.wait().. 
+00018400: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00018410: 7274 4571 7561 6c28 7365 6c66 2e63 6c69  rtEqual(self.cli
+00018420: 656e 742e 7265 7175 6573 7473 2c20 5b0a  ent.requests, [.
+00018430: 2020 2020 2020 2020 2020 2020 2827 504f              ('PO
+00018440: 5354 272c 2027 2f76 312f 6578 6563 272c  ST', '/v1/exec',
+00018450: 204e 6f6e 652c 2073 656c 662e 6275 696c   None, self.buil
+00018460: 645f 6578 6563 5f64 6174 6128 5b27 7365  d_exec_data(['se
+00018470: 7276 6572 275d 2929 2c0a 2020 2020 2020  rver'])),.      
+00018480: 2020 2020 2020 2827 4745 5427 2c20 272f        ('GET', '/
+00018490: 7631 2f63 6861 6e67 6573 2f31 3233 2f77  v1/changes/123/w
+000184a0: 6169 7427 2c20 7b27 7469 6d65 6f75 7427  ait', {'timeout'
+000184b0: 3a20 2734 2e30 3030 7327 7d2c 204e 6f6e  : '4.000s'}, Non
+000184c0: 6529 2c0a 2020 2020 2020 2020 5d29 0a0a  e),.        ])..
+000184d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000184e0: 6572 7445 7175 616c 286c 656e 2863 6f6e  ertEqual(len(con
+000184f0: 7472 6f6c 2e73 656e 6473 292c 206e 756d  trol.sends), num
+00018500: 5f73 656e 6473 290a 2020 2020 2020 2020  _sends).        
+00018510: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00018520: 2863 6f6e 7472 6f6c 2e73 656e 6473 5b30  (control.sends[0
+00018530: 5d5b 305d 2c20 2754 5854 2729 0a20 2020  ][0], 'TXT').   
+00018540: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00018550: 4571 7561 6c28 6a73 6f6e 2e6c 6f61 6473  Equal(json.loads
+00018560: 2863 6f6e 7472 6f6c 2e73 656e 6473 5b30  (control.sends[0
+00018570: 5d5b 315d 292c 0a20 2020 2020 2020 2020  ][1]),.         
+00018580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018590: 7b27 636f 6d6d 616e 6427 3a20 2773 6967  {'command': 'sig
+000185a0: 6e61 6c27 2c20 2773 6967 6e61 6c27 3a20  nal', 'signal': 
+000185b0: 7b27 6e61 6d65 273a 2027 5349 4748 5550  {'name': 'SIGHUP
+000185c0: 277d 7d29 0a20 2020 2020 2020 2069 6620  '}}).        if 
+000185d0: 6861 7361 7474 7228 7369 676e 616c 2c20  hasattr(signal, 
+000185e0: 2753 4947 4855 5027 293a 0a20 2020 2020  'SIGHUP'):.     
+000185f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00018600: 7274 4571 7561 6c28 636f 6e74 726f 6c2e  rtEqual(control.
+00018610: 7365 6e64 735b 315d 5b30 5d2c 2027 5458  sends[1][0], 'TX
+00018620: 5427 290a 2020 2020 2020 2020 2020 2020  T').            
+00018630: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00018640: 286a 736f 6e2e 6c6f 6164 7328 636f 6e74  (json.loads(cont
+00018650: 726f 6c2e 7365 6e64 735b 315d 5b31 5d29  rol.sends[1][1])
+00018660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018670: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00018680: 2763 6f6d 6d61 6e64 273a 2027 7369 676e  'command': 'sign
+00018690: 616c 272c 2027 7369 676e 616c 273a 207b  al', 'signal': {
+000186a0: 276e 616d 6527 3a20 7369 676e 616c 2e53  'name': signal.S
+000186b0: 6967 6e61 6c73 2831 292e 6e61 6d65 7d7d  ignals(1).name}}
+000186c0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000186d0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+000186e0: 6f6e 7472 6f6c 2e73 656e 6473 5b32 5d5b  ontrol.sends[2][
+000186f0: 305d 2c20 2754 5854 2729 0a20 2020 2020  0], 'TXT').     
+00018700: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00018710: 7274 4571 7561 6c28 6a73 6f6e 2e6c 6f61  rtEqual(json.loa
+00018720: 6473 2863 6f6e 7472 6f6c 2e73 656e 6473  ds(control.sends
+00018730: 5b32 5d5b 315d 292c 0a20 2020 2020 2020  [2][1]),.       
+00018740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018750: 2020 2020 2020 7b27 636f 6d6d 616e 6427        {'command'
+00018760: 3a20 2773 6967 6e61 6c27 2c20 2773 6967  : 'signal', 'sig
+00018770: 6e61 6c27 3a20 7b27 6e61 6d65 273a 2027  nal': {'name': '
+00018780: 5349 4748 5550 277d 7d29 0a0a 2020 2020  SIGHUP'}})..    
+00018790: 6465 6620 7465 7374 5f77 6169 745f 6f75  def test_wait_ou
+000187a0: 7470 7574 2873 656c 6629 3a0a 2020 2020  tput(self):.    
+000187b0: 2020 2020 7374 6469 6f2c 2073 7464 6572      stdio, stder
+000187c0: 722c 205f 203d 2073 656c 662e 6164 645f  r, _ = self.add_
+000187d0: 7265 7370 6f6e 7365 7328 2731 3233 272c  responses('123',
+000187e0: 2030 290a 2020 2020 2020 2020 7374 6469   0).        stdi
+000187f0: 6f2e 7265 6365 6976 6573 2e61 7070 656e  o.receives.appen
+00018800: 6428 6227 5079 7468 6f6e 2033 2e38 2e31  d(b'Python 3.8.1
+00018810: 305c 6e27 290a 2020 2020 2020 2020 7374  0\n').        st
+00018820: 6469 6f2e 7265 6365 6976 6573 2e61 7070  dio.receives.app
+00018830: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
+00018840: 2265 6e64 227d 2729 0a20 2020 2020 2020  "end"}').       
+00018850: 2073 7464 6572 722e 7265 6365 6976 6573   stderr.receives
+00018860: 2e61 7070 656e 6428 277b 2263 6f6d 6d61  .append('{"comma
+00018870: 6e64 223a 2265 6e64 227d 2729 0a0a 2020  nd":"end"}')..  
+00018880: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
+00018890: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
+000188a0: 285b 2770 7974 686f 6e33 272c 2027 2d2d  (['python3', '--
+000188b0: 7665 7273 696f 6e27 5d29 0a20 2020 2020  version']).     
+000188c0: 2020 206f 7574 2c20 6572 7220 3d20 7072     out, err = pr
+000188d0: 6f63 6573 732e 7761 6974 5f6f 7574 7075  ocess.wait_outpu
+000188e0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+000188f0: 2e61 7373 6572 7445 7175 616c 286f 7574  .assertEqual(out
+00018900: 2c20 2750 7974 686f 6e20 332e 382e 3130  , 'Python 3.8.10
+00018910: 5c6e 2729 0a20 2020 2020 2020 2073 656c  \n').        sel
+00018920: 662e 6173 7365 7274 4571 7561 6c28 6572  f.assertEqual(er
+00018930: 722c 2027 2729 0a0a 2020 2020 2020 2020  r, '')..        
+00018940: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00018950: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+00018960: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+00018970: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
+00018980: 7631 2f65 7865 6327 2c20 4e6f 6e65 2c20  v1/exec', None, 
+00018990: 7365 6c66 2e62 7569 6c64 5f65 7865 635f  self.build_exec_
+000189a0: 6461 7461 285b 2770 7974 686f 6e33 272c  data(['python3',
+000189b0: 2027 2d2d 7665 7273 696f 6e27 5d29 292c   '--version'])),
+000189c0: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+000189d0: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
+000189e0: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
+000189f0: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
+00018a00: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
+00018a10: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
+00018a20: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00018a30: 7464 696f 2e73 656e 6473 2c20 5b5d 290a  tdio.sends, []).
+00018a40: 0a20 2020 2064 6566 2074 6573 745f 7761  .    def test_wa
+00018a50: 6974 5f6f 7574 7075 745f 636f 6d62 696e  it_output_combin
+00018a60: 655f 7374 6465 7272 2873 656c 6629 3a0a  e_stderr(self):.
+00018a70: 2020 2020 2020 2020 7374 6469 6f2c 205f          stdio, _
+00018a80: 2c20 5f20 3d20 7365 6c66 2e61 6464 5f72  , _ = self.add_r
+00018a90: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
+00018aa0: 3029 0a20 2020 2020 2020 2073 7464 696f  0).        stdio
+00018ab0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+00018ac0: 2862 2769 6e76 616c 6964 2074 696d 6520  (b'invalid time 
+00018ad0: 696e 7465 7276 616c 5c6e 2729 0a20 2020  interval\n').   
+00018ae0: 2020 2020 2073 7464 696f 2e72 6563 6569       stdio.recei
+00018af0: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
+00018b00: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
+00018b10: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00018b20: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+00018b30: 7865 6328 5b27 736c 6565 7027 2c20 2778  xec(['sleep', 'x
+00018b40: 275d 2c20 636f 6d62 696e 655f 7374 6465  '], combine_stde
+00018b50: 7272 3d54 7275 6529 0a20 2020 2020 2020  rr=True).       
+00018b60: 206f 7574 2c20 6572 7220 3d20 7072 6f63   out, err = proc
+00018b70: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
+00018b80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00018b90: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
+00018ba0: 2769 6e76 616c 6964 2074 696d 6520 696e  'invalid time in
+00018bb0: 7465 7276 616c 5c6e 2729 0a20 2020 2020  terval\n').     
+00018bc0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+00018bd0: 4e6f 6e65 2865 7272 290a 2020 2020 2020  None(err).      
+00018be0: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+00018bf0: 6f6e 6528 7072 6f63 6573 732e 7374 6465  one(process.stde
+00018c00: 7272 290a 0a20 2020 2020 2020 2065 7865  rr)..        exe
+00018c10: 635f 6461 7461 203d 2073 656c 662e 6275  c_data = self.bu
+00018c20: 696c 645f 6578 6563 5f64 6174 6128 5b27  ild_exec_data(['
+00018c30: 736c 6565 7027 2c20 2778 275d 2c20 636f  sleep', 'x'], co
+00018c40: 6d62 696e 655f 7374 6465 7272 3d54 7275  mbine_stderr=Tru
+00018c50: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00018c60: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+00018c70: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
+00018c80: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00018c90: 2827 504f 5354 272c 2027 2f76 312f 6578  ('POST', '/v1/ex
+00018ca0: 6563 272c 204e 6f6e 652c 2065 7865 635f  ec', None, exec_
+00018cb0: 6461 7461 292c 0a20 2020 2020 2020 2020  data),.         
+00018cc0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+00018cd0: 6368 616e 6765 732f 3132 332f 7761 6974  changes/123/wait
+00018ce0: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
+00018cf0: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
+00018d00: 0a20 2020 2020 2020 205d 290a 2020 2020  .        ]).    
+00018d10: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00018d20: 7175 616c 2873 7464 696f 2e73 656e 6473  qual(stdio.sends
+00018d30: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+00018d40: 6573 745f 7761 6974 5f6f 7574 7075 745f  est_wait_output_
+00018d50: 6279 7465 7328 7365 6c66 293a 0a20 2020  bytes(self):.   
+00018d60: 2020 2020 2073 7464 696f 2c20 7374 6465       stdio, stde
+00018d70: 7272 2c20 5f20 3d20 7365 6c66 2e61 6464  rr, _ = self.add
+00018d80: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
+00018d90: 2c20 3029 0a20 2020 2020 2020 2073 7464  , 0).        std
+00018da0: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
+00018db0: 6e64 2862 2750 7974 686f 6e20 332e 382e  nd(b'Python 3.8.
+00018dc0: 3130 5c6e 2729 0a20 2020 2020 2020 2073  10\n').        s
+00018dd0: 7464 696f 2e72 6563 6569 7665 732e 6170  tdio.receives.ap
+00018de0: 7065 6e64 2827 7b22 636f 6d6d 616e 6422  pend('{"command"
+00018df0: 3a22 656e 6422 7d27 290a 2020 2020 2020  :"end"}').      
+00018e00: 2020 7374 6465 7272 2e72 6563 6569 7665    stderr.receive
+00018e10: 732e 6170 7065 6e64 2827 7b22 636f 6d6d  s.append('{"comm
+00018e20: 616e 6422 3a22 656e 6422 7d27 290a 0a20  and":"end"}').. 
+00018e30: 2020 2020 2020 2070 726f 6365 7373 203d         process =
+00018e40: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
+00018e50: 6328 5b27 7079 7468 6f6e 3327 2c20 272d  c(['python3', '-
+00018e60: 2d76 6572 7369 6f6e 275d 2c20 656e 636f  -version'], enco
+00018e70: 6469 6e67 3d4e 6f6e 6529 0a20 2020 2020  ding=None).     
+00018e80: 2020 206f 7574 2c20 6572 7220 3d20 7072     out, err = pr
+00018e90: 6f63 6573 732e 7761 6974 5f6f 7574 7075  ocess.wait_outpu
+00018ea0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+00018eb0: 2e61 7373 6572 7445 7175 616c 286f 7574  .assertEqual(out
+00018ec0: 2c20 6227 5079 7468 6f6e 2033 2e38 2e31  , b'Python 3.8.1
+00018ed0: 305c 6e27 290a 2020 2020 2020 2020 7365  0\n').        se
+00018ee0: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
+00018ef0: 7272 2c20 6227 2729 0a0a 2020 2020 2020  rr, b'')..      
+00018f00: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00018f10: 616c 2873 656c 662e 636c 6965 6e74 2e72  al(self.client.r
+00018f20: 6571 7565 7374 732c 205b 0a20 2020 2020  equests, [.     
+00018f30: 2020 2020 2020 2028 2750 4f53 5427 2c20         ('POST', 
+00018f40: 272f 7631 2f65 7865 6327 2c20 4e6f 6e65  '/v1/exec', None
+00018f50: 2c20 7365 6c66 2e62 7569 6c64 5f65 7865  , self.build_exe
+00018f60: 635f 6461 7461 285b 2770 7974 686f 6e33  c_data(['python3
+00018f70: 272c 2027 2d2d 7665 7273 696f 6e27 5d29  ', '--version'])
+00018f80: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00018f90: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+00018fa0: 6765 732f 3132 332f 7761 6974 272c 207b  ges/123/wait', {
+00018fb0: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
+00018fc0: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
+00018fd0: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
+00018fe0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00018ff0: 2873 7464 696f 2e73 656e 6473 2c20 5b5d  (stdio.sends, []
+00019000: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00019010: 7761 6974 5f6f 7574 7075 745f 6578 6974  wait_output_exit
+00019020: 5f6e 6f6e 7a65 726f 2873 656c 6629 3a0a  _nonzero(self):.
+00019030: 2020 2020 2020 2020 7374 6469 6f2c 2073          stdio, s
+00019040: 7464 6572 722c 205f 203d 2073 656c 662e  tderr, _ = self.
+00019050: 6164 645f 7265 7370 6f6e 7365 7328 2731  add_responses('1
+00019060: 3233 272c 2030 290a 2020 2020 2020 2020  23', 0).        
+00019070: 7374 6469 6f2e 7265 6365 6976 6573 2e61  stdio.receives.a
+00019080: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
+00019090: 223a 2265 6e64 227d 2729 0a20 2020 2020  ":"end"}').     
+000190a0: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
+000190b0: 6573 2e61 7070 656e 6428 6227 6669 6c65  es.append(b'file
+000190c0: 206e 6f74 2066 6f75 6e64 3a20 785c 6e27   not found: x\n'
+000190d0: 290a 2020 2020 2020 2020 7374 6465 7272  ).        stderr
+000190e0: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+000190f0: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
+00019100: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
+00019110: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+00019120: 6965 6e74 2e65 7865 6328 5b27 6c73 272c  ient.exec(['ls',
+00019130: 2027 7827 5d29 0a20 2020 2020 2020 206f   'x']).        o
+00019140: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
+00019150: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
+00019160: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00019170: 6572 7445 7175 616c 286f 7574 2c20 2727  ertEqual(out, ''
+00019180: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00019190: 7373 6572 7445 7175 616c 2865 7272 2c20  ssertEqual(err, 
+000191a0: 2766 696c 6520 6e6f 7420 666f 756e 643a  'file not found:
+000191b0: 2078 5c6e 2729 0a0a 2020 2020 2020 2020   x\n')..        
+000191c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000191d0: 2873 656c 662e 636c 6965 6e74 2e72 6571  (self.client.req
+000191e0: 7565 7374 732c 205b 0a20 2020 2020 2020  uests, [.       
+000191f0: 2020 2020 2028 2750 4f53 5427 2c20 272f       ('POST', '/
+00019200: 7631 2f65 7865 6327 2c20 4e6f 6e65 2c20  v1/exec', None, 
+00019210: 7365 6c66 2e62 7569 6c64 5f65 7865 635f  self.build_exec_
+00019220: 6461 7461 285b 276c 7327 2c20 2778 275d  data(['ls', 'x']
+00019230: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00019240: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
+00019250: 6e67 6573 2f31 3233 2f77 6169 7427 2c20  nges/123/wait', 
+00019260: 7b27 7469 6d65 6f75 7427 3a20 2734 2e30  {'timeout': '4.0
+00019270: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
+00019280: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
+00019290: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000192a0: 6c28 7374 6469 6f2e 7365 6e64 732c 205b  l(stdio.sends, [
+000192b0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+000192c0: 5f77 6169 745f 6f75 7470 7574 5f65 7869  _wait_output_exi
+000192d0: 745f 6e6f 6e7a 6572 6f5f 636f 6d62 696e  t_nonzero_combin
+000192e0: 655f 7374 6465 7272 2873 656c 6629 3a0a  e_stderr(self):.
+000192f0: 2020 2020 2020 2020 7374 6469 6f2c 205f          stdio, _
+00019300: 2c20 5f20 3d20 7365 6c66 2e61 6464 5f72  , _ = self.add_r
+00019310: 6573 706f 6e73 6573 2827 3132 3327 2c20  esponses('123', 
+00019320: 3029 0a20 2020 2020 2020 2073 7464 696f  0).        stdio
+00019330: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+00019340: 2862 2766 696c 6520 6e6f 7420 666f 756e  (b'file not foun
+00019350: 643a 2078 5c6e 2729 0a20 2020 2020 2020  d: x\n').       
+00019360: 2073 7464 696f 2e72 6563 6569 7665 732e   stdio.receives.
+00019370: 6170 7065 6e64 2827 7b22 636f 6d6d 616e  append('{"comman
+00019380: 6422 3a22 656e 6422 7d27 290a 0a20 2020  d":"end"}')..   
+00019390: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
+000193a0: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
+000193b0: 5b27 6c73 272c 2027 7827 5d2c 2063 6f6d  ['ls', 'x'], com
+000193c0: 6269 6e65 5f73 7464 6572 723d 5472 7565  bine_stderr=True
+000193d0: 290a 2020 2020 2020 2020 6f75 742c 2065  ).        out, e
+000193e0: 7272 203d 2070 726f 6365 7373 2e77 6169  rr = process.wai
+000193f0: 745f 6f75 7470 7574 2829 0a20 2020 2020  t_output().     
+00019400: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00019410: 7561 6c28 6f75 742c 2027 6669 6c65 206e  ual(out, 'file n
+00019420: 6f74 2066 6f75 6e64 3a20 785c 6e27 290a  ot found: x\n').
+00019430: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00019440: 6572 7449 734e 6f6e 6528 6572 7229 0a0a  ertIsNone(err)..
+00019450: 2020 2020 2020 2020 6578 6563 5f64 6174          exec_dat
+00019460: 6120 3d20 7365 6c66 2e62 7569 6c64 5f65  a = self.build_e
+00019470: 7865 635f 6461 7461 285b 276c 7327 2c20  xec_data(['ls', 
+00019480: 2778 275d 2c20 636f 6d62 696e 655f 7374  'x'], combine_st
+00019490: 6465 7272 3d54 7275 6529 0a20 2020 2020  derr=True).     
+000194a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000194b0: 7561 6c28 7365 6c66 2e63 6c69 656e 742e  ual(self.client.
+000194c0: 7265 7175 6573 7473 2c20 5b0a 2020 2020  requests, [.    
+000194d0: 2020 2020 2020 2020 2827 504f 5354 272c          ('POST',
+000194e0: 2027 2f76 312f 6578 6563 272c 204e 6f6e   '/v1/exec', Non
+000194f0: 652c 2065 7865 635f 6461 7461 292c 0a20  e, exec_data),. 
+00019500: 2020 2020 2020 2020 2020 2028 2747 4554             ('GET
+00019510: 272c 2027 2f76 312f 6368 616e 6765 732f  ', '/v1/changes/
+00019520: 3132 332f 7761 6974 272c 207b 2774 696d  123/wait', {'tim
+00019530: 656f 7574 273a 2027 342e 3030 3073 277d  eout': '4.000s'}
+00019540: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+00019550: 205d 290a 2020 2020 2020 2020 7365 6c66   ]).        self
+00019560: 2e61 7373 6572 7445 7175 616c 2873 7464  .assertEqual(std
+00019570: 696f 2e73 656e 6473 2c20 5b5d 290a 0a20  io.sends, []).. 
+00019580: 2020 2064 6566 2074 6573 745f 7761 6974     def test_wait
+00019590: 5f6f 7574 7075 745f 7365 6e64 5f73 7464  _output_send_std
+000195a0: 696e 2873 656c 6629 3a0a 2020 2020 2020  in(self):.      
+000195b0: 2020 7374 6469 6f2c 2073 7464 6572 722c    stdio, stderr,
+000195c0: 205f 203d 2073 656c 662e 6164 645f 7265   _ = self.add_re
+000195d0: 7370 6f6e 7365 7328 2731 3233 272c 2030  sponses('123', 0
+000195e0: 290a 2020 2020 2020 2020 7374 6469 6f2e  ).        stdio.
+000195f0: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
+00019600: 6227 464f 4f5c 6e42 4152 5c6e 2729 0a20  b'FOO\nBAR\n'). 
+00019610: 2020 2020 2020 2073 7464 696f 2e72 6563         stdio.rec
+00019620: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
+00019630: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
+00019640: 290a 2020 2020 2020 2020 7374 6465 7272  ).        stderr
+00019650: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+00019660: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
+00019670: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
+00019680: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+00019690: 6965 6e74 2e65 7865 6328 5b27 6177 6b27  ient.exec(['awk'
+000196a0: 2c20 277b 2070 7269 6e74 2074 6f75 7070  , '{ print toupp
+000196b0: 6572 2824 2920 7d27 5d2c 2073 7464 696e  er($) }'], stdin
+000196c0: 3d27 666f 6f5c 6e62 6172 5c6e 2729 0a20  ='foo\nbar\n'). 
+000196d0: 2020 2020 2020 206f 7574 2c20 6572 7220         out, err 
+000196e0: 3d20 7072 6f63 6573 732e 7761 6974 5f6f  = process.wait_o
+000196f0: 7574 7075 7428 290a 2020 2020 2020 2020  utput().        
+00019700: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00019710: 286f 7574 2c20 2746 4f4f 5c6e 4241 525c  (out, 'FOO\nBAR\
+00019720: 6e27 290a 2020 2020 2020 2020 7365 6c66  n').        self
+00019730: 2e61 7373 6572 7445 7175 616c 2865 7272  .assertEqual(err
+00019740: 2c20 2727 290a 0a20 2020 2020 2020 2073  , '')..        s
+00019750: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00019760: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+00019770: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+00019780: 2020 2020 2827 504f 5354 272c 2027 2f76      ('POST', '/v
+00019790: 312f 6578 6563 272c 204e 6f6e 652c 2073  1/exec', None, s
+000197a0: 656c 662e 6275 696c 645f 6578 6563 5f64  elf.build_exec_d
+000197b0: 6174 6128 5b27 6177 6b27 2c20 277b 2070  ata(['awk', '{ p
+000197c0: 7269 6e74 2074 6f75 7070 6572 2824 2920  rint toupper($) 
+000197d0: 7d27 5d29 292c 0a20 2020 2020 2020 2020  }'])),.         
+000197e0: 2020 2028 2747 4554 272c 2027 2f76 312f     ('GET', '/v1/
+000197f0: 6368 616e 6765 732f 3132 332f 7761 6974  changes/123/wait
+00019800: 272c 207b 2774 696d 656f 7574 273a 2027  ', {'timeout': '
+00019810: 342e 3030 3073 277d 2c20 4e6f 6e65 292c  4.000s'}, None),
+00019820: 0a20 2020 2020 2020 205d 290a 2020 2020  .        ]).    
+00019830: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00019840: 7175 616c 2873 7464 696f 2e73 656e 6473  qual(stdio.sends
+00019850: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00019860: 2827 4249 4e27 2c20 6227 666f 6f5c 6e62  ('BIN', b'foo\nb
+00019870: 6172 5c6e 2729 2c0a 2020 2020 2020 2020  ar\n'),.        
+00019880: 2020 2020 2827 5458 5427 2c20 277b 2263      ('TXT', '{"c
+00019890: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
+000198a0: 2c0a 2020 2020 2020 2020 5d29 0a0a 2020  ,.        ])..  
+000198b0: 2020 6465 6620 7465 7374 5f77 6169 745f    def test_wait_
+000198c0: 6f75 7470 7574 5f73 656e 645f 7374 6469  output_send_stdi
+000198d0: 6e5f 6279 7465 7328 7365 6c66 293a 0a20  n_bytes(self):. 
+000198e0: 2020 2020 2020 2073 7464 696f 2c20 7374         stdio, st
+000198f0: 6465 7272 2c20 5f20 3d20 7365 6c66 2e61  derr, _ = self.a
+00019900: 6464 5f72 6573 706f 6e73 6573 2827 3132  dd_responses('12
+00019910: 3327 2c20 3029 0a20 2020 2020 2020 2073  3', 0).        s
+00019920: 7464 696f 2e72 6563 6569 7665 732e 6170  tdio.receives.ap
+00019930: 7065 6e64 2862 2746 4f4f 5c6e 4241 525c  pend(b'FOO\nBAR\
+00019940: 6e27 290a 2020 2020 2020 2020 7374 6469  n').        stdi
+00019950: 6f2e 7265 6365 6976 6573 2e61 7070 656e  o.receives.appen
+00019960: 6428 277b 2263 6f6d 6d61 6e64 223a 2265  d('{"command":"e
+00019970: 6e64 227d 2729 0a20 2020 2020 2020 2073  nd"}').        s
+00019980: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
+00019990: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
+000199a0: 223a 2265 6e64 227d 2729 0a0a 2020 2020  ":"end"}')..    
+000199b0: 2020 2020 7072 6f63 6573 7320 3d20 7365      process = se
+000199c0: 6c66 2e63 6c69 656e 742e 6578 6563 285b  lf.client.exec([
+000199d0: 2761 776b 272c 2027 7b20 7072 696e 7420  'awk', '{ print 
+000199e0: 746f 7570 7065 7228 2429 207d 275d 2c20  toupper($) }'], 
+000199f0: 7374 6469 6e3d 6227 666f 6f5c 6e62 6172  stdin=b'foo\nbar
+00019a00: 5c6e 272c 0a20 2020 2020 2020 2020 2020  \n',.           
+00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a20: 2020 2020 2020 2020 656e 636f 6469 6e67          encoding
+00019a30: 3d4e 6f6e 6529 0a20 2020 2020 2020 206f  =None).        o
+00019a40: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
+00019a50: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
+00019a60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00019a70: 6572 7445 7175 616c 286f 7574 2c20 6227  ertEqual(out, b'
+00019a80: 464f 4f5c 6e42 4152 5c6e 2729 0a20 2020  FOO\nBAR\n').   
+00019a90: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00019aa0: 4571 7561 6c28 6572 722c 2062 2727 290a  Equal(err, b'').
+00019ab0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00019ac0: 7365 7274 4571 7561 6c28 7365 6c66 2e63  sertEqual(self.c
+00019ad0: 6c69 656e 742e 7265 7175 6573 7473 2c20  lient.requests, 
+00019ae0: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+00019af0: 504f 5354 272c 2027 2f76 312f 6578 6563  POST', '/v1/exec
+00019b00: 272c 204e 6f6e 652c 2073 656c 662e 6275  ', None, self.bu
+00019b10: 696c 645f 6578 6563 5f64 6174 6128 5b27  ild_exec_data(['
+00019b20: 6177 6b27 2c20 277b 2070 7269 6e74 2074  awk', '{ print t
+00019b30: 6f75 7070 6572 2824 2920 7d27 5d29 292c  oupper($) }'])),
+00019b40: 0a20 2020 2020 2020 2020 2020 2028 2747  .            ('G
+00019b50: 4554 272c 2027 2f76 312f 6368 616e 6765  ET', '/v1/change
+00019b60: 732f 3132 332f 7761 6974 272c 207b 2774  s/123/wait', {'t
+00019b70: 696d 656f 7574 273a 2027 342e 3030 3073  imeout': '4.000s
+00019b80: 277d 2c20 4e6f 6e65 292c 0a20 2020 2020  '}, None),.     
+00019b90: 2020 205d 290a 2020 2020 2020 2020 7365     ]).        se
+00019ba0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+00019bb0: 7464 696f 2e73 656e 6473 2c20 5b0a 2020  tdio.sends, [.  
+00019bc0: 2020 2020 2020 2020 2020 2827 4249 4e27            ('BIN'
+00019bd0: 2c20 6227 666f 6f5c 6e62 6172 5c6e 2729  , b'foo\nbar\n')
+00019be0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
+00019bf0: 5458 5427 2c20 277b 2263 6f6d 6d61 6e64  TXT', '{"command
+00019c00: 223a 2265 6e64 227d 2729 2c0a 2020 2020  ":"end"}'),.    
+00019c10: 2020 2020 5d29 0a0a 2020 2020 6465 6620      ])..    def 
+00019c20: 7465 7374 5f77 6169 745f 6f75 7470 7574  test_wait_output
+00019c30: 5f62 6164 5f63 6f6d 6d61 6e64 2873 656c  _bad_command(sel
+00019c40: 6629 3a0a 2020 2020 2020 2020 7374 6469  f):.        stdi
+00019c50: 6f2c 2073 7464 6572 722c 205f 203d 2073  o, stderr, _ = s
+00019c60: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
+00019c70: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
+00019c80: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
+00019c90: 6573 2e61 7070 656e 6428 6227 5079 7468  es.append(b'Pyth
+00019ca0: 6f6e 2033 2e38 2e31 305c 6e27 290a 2020  on 3.8.10\n').  
+00019cb0: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
+00019cc0: 6976 6573 2e61 7070 656e 6428 276e 6f74  ives.append('not
+00019cd0: 206a 736f 6e27 2920 2023 2062 6164 204a   json')  # bad J
+00019ce0: 534f 4e20 7368 6f75 6c64 2062 6520 6967  SON should be ig
+00019cf0: 6e6f 7265 640a 2020 2020 2020 2020 7374  nored.        st
+00019d00: 6469 6f2e 7265 6365 6976 6573 2e61 7070  dio.receives.app
+00019d10: 656e 6428 277b 2263 6f6d 6d61 6e64 223a  end('{"command":
+00019d20: 2266 6f6f 227d 2729 2020 2320 756e 6b6e  "foo"}')  # unkn
+00019d30: 6f77 6e20 636f 6d6d 616e 6420 7368 6f75  own command shou
+00019d40: 6c64 2062 6520 6967 6e6f 7265 640a 2020  ld be ignored.  
+00019d50: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
+00019d60: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
+00019d70: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
+00019d80: 0a20 2020 2020 2020 2073 7464 6572 722e  .        stderr.
+00019d90: 7265 6365 6976 6573 2e61 7070 656e 6428  receives.append(
+00019da0: 277b 2263 6f6d 6d61 6e64 223a 2265 6e64  '{"command":"end
+00019db0: 227d 2729 0a0a 2020 2020 2020 2020 7769  "}')..        wi
+00019dc0: 7468 2073 656c 662e 6173 7365 7274 4c6f  th self.assertLo
+00019dd0: 6773 2827 6f70 732e 7065 6262 6c65 272c  gs('ops.pebble',
+00019de0: 206c 6576 656c 3d27 5741 524e 494e 4727   level='WARNING'
+00019df0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00019e00: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
+00019e10: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
+00019e20: 5b27 7079 7468 6f6e 3327 2c20 272d 2d76  ['python3', '--v
+00019e30: 6572 7369 6f6e 275d 290a 2020 2020 2020  ersion']).      
+00019e40: 2020 2020 2020 6f75 742c 2065 7272 203d        out, err =
+00019e50: 2070 726f 6365 7373 2e77 6169 745f 6f75   process.wait_ou
+00019e60: 7470 7574 2829 0a20 2020 2020 2020 2073  tput().        s
+00019e70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00019e80: 636d 2e6f 7574 7075 742c 205b 0a20 2020  cm.output, [.   
+00019e90: 2020 2020 2020 2020 2022 5741 524e 494e           "WARNIN
+00019ea0: 473a 6f70 732e 7065 6262 6c65 3a43 616e  G:ops.pebble:Can
+00019eb0: 6e6f 7420 6465 636f 6465 2049 2f4f 2063  not decode I/O c
+00019ec0: 6f6d 6d61 6e64 2028 696e 7661 6c69 6420  ommand (invalid 
+00019ed0: 4a53 4f4e 2922 2c0a 2020 2020 2020 2020  JSON)",.        
+00019ee0: 2020 2020 2257 4152 4e49 4e47 3a6f 7073      "WARNING:ops
+00019ef0: 2e70 6562 626c 653a 496e 7661 6c69 6420  .pebble:Invalid 
+00019f00: 492f 4f20 636f 6d6d 616e 6420 2766 6f6f  I/O command 'foo
+00019f10: 2722 2c0a 2020 2020 2020 2020 5d29 0a0a  '",.        ])..
+00019f20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00019f30: 6572 7445 7175 616c 286f 7574 2c20 2750  ertEqual(out, 'P
+00019f40: 7974 686f 6e20 332e 382e 3130 5c6e 2729  ython 3.8.10\n')
+00019f50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00019f60: 7365 7274 4571 7561 6c28 6572 722c 2027  sertEqual(err, '
+00019f70: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+00019f80: 2e61 7373 6572 7445 7175 616c 2873 656c  .assertEqual(sel
+00019f90: 662e 636c 6965 6e74 2e72 6571 7565 7374  f.client.request
+00019fa0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+00019fb0: 2028 2750 4f53 5427 2c20 272f 7631 2f65   ('POST', '/v1/e
+00019fc0: 7865 6327 2c20 4e6f 6e65 2c20 7365 6c66  xec', None, self
+00019fd0: 2e62 7569 6c64 5f65 7865 635f 6461 7461  .build_exec_data
+00019fe0: 285b 2770 7974 686f 6e33 272c 2027 2d2d  (['python3', '--
+00019ff0: 7665 7273 696f 6e27 5d29 292c 0a20 2020  version'])),.   
+0001a000: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+0001a010: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
+0001a020: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
+0001a030: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
+0001a040: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
+0001a050: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001a060: 7373 6572 7445 7175 616c 2873 7464 696f  ssertEqual(stdio
+0001a070: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
+0001a080: 2064 6566 2074 6573 745f 7761 6974 5f70   def test_wait_p
+0001a090: 6173 7365 645f 6f75 7470 7574 2873 656c  assed_output(sel
+0001a0a0: 6629 3a0a 2020 2020 2020 2020 696f 5f77  f):.        io_w
+0001a0b0: 732c 2073 7464 6572 722c 205f 203d 2073  s, stderr, _ = s
+0001a0c0: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
+0001a0d0: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
+0001a0e0: 2020 2020 696f 5f77 732e 7265 6365 6976      io_ws.receiv
+0001a0f0: 6573 2e61 7070 656e 6428 6227 666f 6f5c  es.append(b'foo\
+0001a100: 6e27 290a 2020 2020 2020 2020 696f 5f77  n').        io_w
+0001a110: 732e 7265 6365 6976 6573 2e61 7070 656e  s.receives.appen
+0001a120: 6428 277b 2263 6f6d 6d61 6e64 223a 2265  d('{"command":"e
+0001a130: 6e64 227d 2729 0a20 2020 2020 2020 2073  nd"}').        s
+0001a140: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
+0001a150: 7070 656e 6428 6227 736f 6d65 2065 7272  ppend(b'some err
+0001a160: 6f72 5c6e 2729 0a20 2020 2020 2020 2073  or\n').        s
+0001a170: 7464 6572 722e 7265 6365 6976 6573 2e61  tderr.receives.a
+0001a180: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
+0001a190: 223a 2265 6e64 227d 2729 0a0a 2020 2020  ":"end"}')..    
+0001a1a0: 2020 2020 6f75 7420 3d20 696f 2e53 7472      out = io.Str
+0001a1b0: 696e 6749 4f28 290a 2020 2020 2020 2020  ingIO().        
+0001a1c0: 6572 7220 3d20 696f 2e53 7472 696e 6749  err = io.StringI
+0001a1d0: 4f28 290a 2020 2020 2020 2020 7072 6f63  O().        proc
+0001a1e0: 6573 7320 3d20 7365 6c66 2e63 6c69 656e  ess = self.clien
+0001a1f0: 742e 6578 6563 285b 2765 6368 6f27 2c20  t.exec(['echo', 
+0001a200: 2766 6f6f 275d 2c20 7374 646f 7574 3d6f  'foo'], stdout=o
+0001a210: 7574 2c20 7374 6465 7272 3d65 7272 290a  ut, stderr=err).
+0001a220: 2020 2020 2020 2020 7072 6f63 6573 732e          process.
+0001a230: 7761 6974 2829 0a20 2020 2020 2020 2073  wait().        s
+0001a240: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001a250: 6f75 742e 6765 7476 616c 7565 2829 2c20  out.getvalue(), 
+0001a260: 2766 6f6f 5c6e 2729 0a20 2020 2020 2020  'foo\n').       
+0001a270: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001a280: 6c28 6572 722e 6765 7476 616c 7565 2829  l(err.getvalue()
+0001a290: 2c20 2773 6f6d 6520 6572 726f 725c 6e27  , 'some error\n'
+0001a2a0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0001a2b0: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0001a2c0: 2e63 6c69 656e 742e 7265 7175 6573 7473  .client.requests
+0001a2d0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+0001a2e0: 2827 504f 5354 272c 2027 2f76 312f 6578  ('POST', '/v1/ex
+0001a2f0: 6563 272c 204e 6f6e 652c 2073 656c 662e  ec', None, self.
+0001a300: 6275 696c 645f 6578 6563 5f64 6174 6128  build_exec_data(
+0001a310: 5b27 6563 686f 272c 2027 666f 6f27 5d29  ['echo', 'foo'])
+0001a320: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+0001a330: 2747 4554 272c 2027 2f76 312f 6368 616e  'GET', '/v1/chan
+0001a340: 6765 732f 3132 332f 7761 6974 272c 207b  ges/123/wait', {
+0001a350: 2774 696d 656f 7574 273a 2027 342e 3030  'timeout': '4.00
+0001a360: 3073 277d 2c20 4e6f 6e65 292c 0a20 2020  0s'}, None),.   
+0001a370: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
+0001a380: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001a390: 2869 6f5f 7773 2e73 656e 6473 2c20 5b5d  (io_ws.sends, []
+0001a3a0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001a3b0: 7761 6974 5f70 6173 7365 645f 6f75 7470  wait_passed_outp
+0001a3c0: 7574 5f63 6f6d 6269 6e65 5f73 7464 6572  ut_combine_stder
+0001a3d0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+0001a3e0: 2069 6f5f 7773 2c20 5f2c 205f 203d 2073   io_ws, _, _ = s
+0001a3f0: 656c 662e 6164 645f 7265 7370 6f6e 7365  elf.add_response
+0001a400: 7328 2731 3233 272c 2030 290a 2020 2020  s('123', 0).    
+0001a410: 2020 2020 696f 5f77 732e 7265 6365 6976      io_ws.receiv
+0001a420: 6573 2e61 7070 656e 6428 6227 666f 6f5c  es.append(b'foo\
+0001a430: 6e27 290a 2020 2020 2020 2020 696f 5f77  n').        io_w
+0001a440: 732e 7265 6365 6976 6573 2e61 7070 656e  s.receives.appen
+0001a450: 6428 6227 736f 6d65 2065 7272 6f72 5c6e  d(b'some error\n
+0001a460: 2729 0a20 2020 2020 2020 2069 6f5f 7773  ').        io_ws
+0001a470: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+0001a480: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
+0001a490: 6422 7d27 290a 0a20 2020 2020 2020 206f  d"}')..        o
+0001a4a0: 7574 203d 2069 6f2e 5374 7269 6e67 494f  ut = io.StringIO
+0001a4b0: 2829 0a20 2020 2020 2020 2070 726f 6365  ().        proce
+0001a4c0: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
+0001a4d0: 2e65 7865 6328 5b27 6563 686f 272c 2027  .exec(['echo', '
+0001a4e0: 666f 6f27 5d2c 2073 7464 6f75 743d 6f75  foo'], stdout=ou
+0001a4f0: 742c 2063 6f6d 6269 6e65 5f73 7464 6572  t, combine_stder
+0001a500: 723d 5472 7565 290a 2020 2020 2020 2020  r=True).        
+0001a510: 7072 6f63 6573 732e 7761 6974 2829 0a20  process.wait(). 
+0001a520: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001a530: 7274 4571 7561 6c28 6f75 742e 6765 7476  rtEqual(out.getv
+0001a540: 616c 7565 2829 2c20 2766 6f6f 5c6e 736f  alue(), 'foo\nso
+0001a550: 6d65 2065 7272 6f72 5c6e 2729 0a20 2020  me error\n').   
+0001a560: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001a570: 4973 4e6f 6e65 2870 726f 6365 7373 2e73  IsNone(process.s
+0001a580: 7464 6572 7229 0a0a 2020 2020 2020 2020  tderr)..        
+0001a590: 6578 6563 5f64 6174 6120 3d20 7365 6c66  exec_data = self
+0001a5a0: 2e62 7569 6c64 5f65 7865 635f 6461 7461  .build_exec_data
+0001a5b0: 285b 2765 6368 6f27 2c20 2766 6f6f 275d  (['echo', 'foo']
+0001a5c0: 2c20 636f 6d62 696e 655f 7374 6465 7272  , combine_stderr
+0001a5d0: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
+0001a5e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001a5f0: 7365 6c66 2e63 6c69 656e 742e 7265 7175  self.client.requ
+0001a600: 6573 7473 2c20 5b0a 2020 2020 2020 2020  ests, [.        
+0001a610: 2020 2020 2827 504f 5354 272c 2027 2f76      ('POST', '/v
+0001a620: 312f 6578 6563 272c 204e 6f6e 652c 2065  1/exec', None, e
+0001a630: 7865 635f 6461 7461 292c 0a20 2020 2020  xec_data),.     
+0001a640: 2020 2020 2020 2028 2747 4554 272c 2027         ('GET', '
+0001a650: 2f76 312f 6368 616e 6765 732f 3132 332f  /v1/changes/123/
+0001a660: 7761 6974 272c 207b 2774 696d 656f 7574  wait', {'timeout
+0001a670: 273a 2027 342e 3030 3073 277d 2c20 4e6f  ': '4.000s'}, No
+0001a680: 6e65 292c 0a20 2020 2020 2020 205d 290a  ne),.        ]).
+0001a690: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001a6a0: 6572 7445 7175 616c 2869 6f5f 7773 2e73  ertEqual(io_ws.s
+0001a6b0: 656e 6473 2c20 5b5d 290a 0a20 2020 2064  ends, [])..    d
+0001a6c0: 6566 2074 6573 745f 7761 6974 5f70 6173  ef test_wait_pas
+0001a6d0: 7365 645f 6f75 7470 7574 5f62 7974 6573  sed_output_bytes
+0001a6e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001a6f0: 696f 5f77 732c 2073 7464 6572 722c 205f  io_ws, stderr, _
+0001a700: 203d 2073 656c 662e 6164 645f 7265 7370   = self.add_resp
+0001a710: 6f6e 7365 7328 2731 3233 272c 2030 290a  onses('123', 0).
+0001a720: 2020 2020 2020 2020 696f 5f77 732e 7265          io_ws.re
+0001a730: 6365 6976 6573 2e61 7070 656e 6428 6227  ceives.append(b'
+0001a740: 666f 6f5c 6e27 290a 2020 2020 2020 2020  foo\n').        
+0001a750: 696f 5f77 732e 7265 6365 6976 6573 2e61  io_ws.receives.a
+0001a760: 7070 656e 6428 277b 2263 6f6d 6d61 6e64  ppend('{"command
+0001a770: 223a 2265 6e64 227d 2729 0a20 2020 2020  ":"end"}').     
+0001a780: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
+0001a790: 6573 2e61 7070 656e 6428 6227 736f 6d65  es.append(b'some
+0001a7a0: 2065 7272 6f72 5c6e 2729 0a20 2020 2020   error\n').     
+0001a7b0: 2020 2073 7464 6572 722e 7265 6365 6976     stderr.receiv
+0001a7c0: 6573 2e61 7070 656e 6428 277b 2263 6f6d  es.append('{"com
+0001a7d0: 6d61 6e64 223a 2265 6e64 227d 2729 0a0a  mand":"end"}')..
+0001a7e0: 2020 2020 2020 2020 6f75 7420 3d20 696f          out = io
+0001a7f0: 2e42 7974 6573 494f 2829 0a20 2020 2020  .BytesIO().     
+0001a800: 2020 2065 7272 203d 2069 6f2e 4279 7465     err = io.Byte
+0001a810: 7349 4f28 290a 2020 2020 2020 2020 7072  sIO().        pr
+0001a820: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
+0001a830: 656e 742e 6578 6563 285b 2765 6368 6f27  ent.exec(['echo'
+0001a840: 2c20 2766 6f6f 275d 2c20 7374 646f 7574  , 'foo'], stdout
+0001a850: 3d6f 7574 2c20 7374 6465 7272 3d65 7272  =out, stderr=err
+0001a860: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
+0001a870: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+0001a880: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
+0001a890: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001a8a0: 286f 7574 2e67 6574 7661 6c75 6528 292c  (out.getvalue(),
+0001a8b0: 2062 2766 6f6f 5c6e 2729 0a20 2020 2020   b'foo\n').     
+0001a8c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001a8d0: 7561 6c28 6572 722e 6765 7476 616c 7565  ual(err.getvalue
+0001a8e0: 2829 2c20 6227 736f 6d65 2065 7272 6f72  (), b'some error
+0001a8f0: 5c6e 2729 0a0a 2020 2020 2020 2020 7365  \n')..        se
+0001a900: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
+0001a910: 656c 662e 636c 6965 6e74 2e72 6571 7565  elf.client.reque
+0001a920: 7374 732c 205b 0a20 2020 2020 2020 2020  sts, [.         
+0001a930: 2020 2028 2750 4f53 5427 2c20 272f 7631     ('POST', '/v1
+0001a940: 2f65 7865 6327 2c20 4e6f 6e65 2c20 7365  /exec', None, se
+0001a950: 6c66 2e62 7569 6c64 5f65 7865 635f 6461  lf.build_exec_da
+0001a960: 7461 285b 2765 6368 6f27 2c20 2766 6f6f  ta(['echo', 'foo
+0001a970: 275d 2929 2c0a 2020 2020 2020 2020 2020  '])),.          
+0001a980: 2020 2827 4745 5427 2c20 272f 7631 2f63    ('GET', '/v1/c
+0001a990: 6861 6e67 6573 2f31 3233 2f77 6169 7427  hanges/123/wait'
+0001a9a0: 2c20 7b27 7469 6d65 6f75 7427 3a20 2734  , {'timeout': '4
+0001a9b0: 2e30 3030 7327 7d2c 204e 6f6e 6529 2c0a  .000s'}, None),.
+0001a9c0: 2020 2020 2020 2020 5d29 0a20 2020 2020          ]).     
+0001a9d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001a9e0: 7561 6c28 696f 5f77 732e 7365 6e64 732c  ual(io_ws.sends,
+0001a9f0: 205b 5d29 0a0a 2020 2020 6465 6620 7465   [])..    def te
+0001aa00: 7374 5f77 6169 745f 7061 7373 6564 5f6f  st_wait_passed_o
+0001aa10: 7574 7075 745f 6261 645f 636f 6d6d 616e  utput_bad_comman
+0001aa20: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+0001aa30: 2069 6f5f 7773 2c20 7374 6465 7272 2c20   io_ws, stderr, 
+0001aa40: 5f20 3d20 7365 6c66 2e61 6464 5f72 6573  _ = self.add_res
+0001aa50: 706f 6e73 6573 2827 3132 3327 2c20 3029  ponses('123', 0)
+0001aa60: 0a20 2020 2020 2020 2069 6f5f 7773 2e72  .        io_ws.r
+0001aa70: 6563 6569 7665 732e 6170 7065 6e64 2862  eceives.append(b
+0001aa80: 2766 6f6f 5c6e 2729 0a20 2020 2020 2020  'foo\n').       
+0001aa90: 2069 6f5f 7773 2e72 6563 6569 7665 732e   io_ws.receives.
+0001aaa0: 6170 7065 6e64 2827 6e6f 7420 6a73 6f6e  append('not json
+0001aab0: 2729 2020 2320 6261 6420 4a53 4f4e 2073  ')  # bad JSON s
+0001aac0: 686f 756c 6420 6265 2069 676e 6f72 6564  hould be ignored
+0001aad0: 0a20 2020 2020 2020 2069 6f5f 7773 2e72  .        io_ws.r
+0001aae0: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
+0001aaf0: 7b22 636f 6d6d 616e 6422 3a22 666f 6f22  {"command":"foo"
+0001ab00: 7d27 2920 2023 2075 6e6b 6e6f 776e 2063  }')  # unknown c
+0001ab10: 6f6d 6d61 6e64 2073 686f 756c 6420 6265  ommand should be
+0001ab20: 2069 676e 6f72 6564 0a20 2020 2020 2020   ignored.       
+0001ab30: 2069 6f5f 7773 2e72 6563 6569 7665 732e   io_ws.receives.
+0001ab40: 6170 7065 6e64 2827 7b22 636f 6d6d 616e  append('{"comman
+0001ab50: 6422 3a22 656e 6422 7d27 290a 2020 2020  d":"end"}').    
+0001ab60: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
+0001ab70: 7665 732e 6170 7065 6e64 2862 2773 6f6d  ves.append(b'som
+0001ab80: 6520 6572 726f 725c 6e27 290a 2020 2020  e error\n').    
+0001ab90: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
+0001aba0: 7665 732e 6170 7065 6e64 2827 7b22 636f  ves.append('{"co
+0001abb0: 6d6d 616e 6422 3a22 656e 6422 7d27 290a  mmand":"end"}').
+0001abc0: 0a20 2020 2020 2020 206f 7574 203d 2069  .        out = i
+0001abd0: 6f2e 5374 7269 6e67 494f 2829 0a20 2020  o.StringIO().   
+0001abe0: 2020 2020 2065 7272 203d 2069 6f2e 5374       err = io.St
+0001abf0: 7269 6e67 494f 2829 0a0a 2020 2020 2020  ringIO()..      
+0001ac00: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0001ac10: 7274 4c6f 6773 2827 6f70 732e 7065 6262  rtLogs('ops.pebb
+0001ac20: 6c65 272c 206c 6576 656c 3d27 5741 524e  le', level='WARN
+0001ac30: 494e 4727 2920 6173 2063 6d3a 0a20 2020  ING') as cm:.   
+0001ac40: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0001ac50: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+0001ac60: 7865 6328 5b27 6563 686f 272c 2027 666f  xec(['echo', 'fo
+0001ac70: 6f27 5d2c 2073 7464 6f75 743d 6f75 742c  o'], stdout=out,
+0001ac80: 2073 7464 6572 723d 6572 7229 0a20 2020   stderr=err).   
+0001ac90: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0001aca0: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
+0001acb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001acc0: 2863 6d2e 6f75 7470 7574 2c20 5b0a 2020  (cm.output, [.  
+0001acd0: 2020 2020 2020 2020 2020 2257 4152 4e49            "WARNI
+0001ace0: 4e47 3a6f 7073 2e70 6562 626c 653a 4361  NG:ops.pebble:Ca
+0001acf0: 6e6e 6f74 2064 6563 6f64 6520 492f 4f20  nnot decode I/O 
+0001ad00: 636f 6d6d 616e 6420 2869 6e76 616c 6964  command (invalid
+0001ad10: 204a 534f 4e29 222c 0a20 2020 2020 2020   JSON)",.       
+0001ad20: 2020 2020 2022 5741 524e 494e 473a 6f70       "WARNING:op
+0001ad30: 732e 7065 6262 6c65 3a49 6e76 616c 6964  s.pebble:Invalid
+0001ad40: 2049 2f4f 2063 6f6d 6d61 6e64 2027 666f   I/O command 'fo
+0001ad50: 6f27 222c 0a20 2020 2020 2020 205d 290a  o'",.        ]).
+0001ad60: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001ad70: 7365 7274 4571 7561 6c28 6f75 742e 6765  sertEqual(out.ge
+0001ad80: 7476 616c 7565 2829 2c20 2766 6f6f 5c6e  tvalue(), 'foo\n
+0001ad90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001ada0: 6173 7365 7274 4571 7561 6c28 6572 722e  assertEqual(err.
+0001adb0: 6765 7476 616c 7565 2829 2c20 2773 6f6d  getvalue(), 'som
+0001adc0: 6520 6572 726f 725c 6e27 290a 0a20 2020  e error\n')..   
+0001add0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001ade0: 4571 7561 6c28 7365 6c66 2e63 6c69 656e  Equal(self.clien
+0001adf0: 742e 7265 7175 6573 7473 2c20 5b0a 2020  t.requests, [.  
+0001ae00: 2020 2020 2020 2020 2020 2827 504f 5354            ('POST
+0001ae10: 272c 2027 2f76 312f 6578 6563 272c 204e  ', '/v1/exec', N
+0001ae20: 6f6e 652c 2073 656c 662e 6275 696c 645f  one, self.build_
+0001ae30: 6578 6563 5f64 6174 6128 5b27 6563 686f  exec_data(['echo
+0001ae40: 272c 2027 666f 6f27 5d29 292c 0a20 2020  ', 'foo'])),.   
+0001ae50: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+0001ae60: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
+0001ae70: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
+0001ae80: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
+0001ae90: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
+0001aea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001aeb0: 7373 6572 7445 7175 616c 2869 6f5f 7773  ssertEqual(io_ws
+0001aec0: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
+0001aed0: 2064 6566 2074 6573 745f 7761 6974 5f66   def test_wait_f
+0001aee0: 696c 655f 696f 2873 656c 6629 3a0a 2020  ile_io(self):.  
+0001aef0: 2020 2020 2020 6669 6e20 3d20 7465 6d70        fin = temp
+0001af00: 6669 6c65 2e54 656d 706f 7261 7279 4669  file.TemporaryFi
+0001af10: 6c65 286d 6f64 653d 2777 2b27 2c20 656e  le(mode='w+', en
+0001af20: 636f 6469 6e67 3d27 7574 662d 3827 290a  coding='utf-8').
+0001af30: 2020 2020 2020 2020 6f75 7420 3d20 7465          out = te
+0001af40: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
+0001af50: 4669 6c65 286d 6f64 653d 2777 2b27 2c20  File(mode='w+', 
+0001af60: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
+0001af70: 290a 2020 2020 2020 2020 6572 7220 3d20  ).        err = 
+0001af80: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
+0001af90: 7279 4669 6c65 286d 6f64 653d 2777 2b27  ryFile(mode='w+'
+0001afa0: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
+0001afb0: 3827 290a 2020 2020 2020 2020 7472 793a  8').        try:
+0001afc0: 0a20 2020 2020 2020 2020 2020 2066 696e  .            fin
+0001afd0: 2e77 7269 7465 2827 666f 6f5c 6e27 290a  .write('foo\n').
+0001afe0: 2020 2020 2020 2020 2020 2020 6669 6e2e              fin.
+0001aff0: 7365 656b 2830 290a 0a20 2020 2020 2020  seek(0)..       
+0001b000: 2020 2020 2069 6f5f 7773 2c20 7374 6465       io_ws, stde
+0001b010: 7272 2c20 5f20 3d20 7365 6c66 2e61 6464  rr, _ = self.add
+0001b020: 5f72 6573 706f 6e73 6573 2827 3132 3327  _responses('123'
+0001b030: 2c20 3029 0a20 2020 2020 2020 2020 2020  , 0).           
+0001b040: 2069 6f5f 7773 2e72 6563 6569 7665 732e   io_ws.receives.
+0001b050: 6170 7065 6e64 2862 2766 6f6f 5c6e 2729  append(b'foo\n')
+0001b060: 0a20 2020 2020 2020 2020 2020 2069 6f5f  .            io_
+0001b070: 7773 2e72 6563 6569 7665 732e 6170 7065  ws.receives.appe
+0001b080: 6e64 2827 7b22 636f 6d6d 616e 6422 3a22  nd('{"command":"
+0001b090: 656e 6422 7d27 290a 2020 2020 2020 2020  end"}').        
+0001b0a0: 2020 2020 7374 6465 7272 2e72 6563 6569      stderr.recei
+0001b0b0: 7665 732e 6170 7065 6e64 2862 2773 6f6d  ves.append(b'som
+0001b0c0: 6520 6572 726f 725c 6e27 290a 2020 2020  e error\n').    
+0001b0d0: 2020 2020 2020 2020 7374 6465 7272 2e72          stderr.r
+0001b0e0: 6563 6569 7665 732e 6170 7065 6e64 2827  eceives.append('
+0001b0f0: 7b22 636f 6d6d 616e 6422 3a22 656e 6422  {"command":"end"
+0001b100: 7d27 290a 0a20 2020 2020 2020 2020 2020  }')..           
+0001b110: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
+0001b120: 636c 6965 6e74 2e65 7865 6328 5b27 6563  client.exec(['ec
+0001b130: 686f 272c 2027 666f 6f27 5d2c 2073 7464  ho', 'foo'], std
+0001b140: 696e 3d66 696e 2c20 7374 646f 7574 3d6f  in=fin, stdout=o
+0001b150: 7574 2c20 7374 6465 7272 3d65 7272 290a  ut, stderr=err).
+0001b160: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0001b170: 6573 732e 7761 6974 2829 0a0a 2020 2020  ess.wait()..    
+0001b180: 2020 2020 2020 2020 6f75 742e 7365 656b          out.seek
+0001b190: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
+0001b1a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001b1b0: 286f 7574 2e72 6561 6428 292c 2027 666f  (out.read(), 'fo
+0001b1c0: 6f5c 6e27 290a 2020 2020 2020 2020 2020  o\n').          
+0001b1d0: 2020 6572 722e 7365 656b 2830 290a 2020    err.seek(0).  
+0001b1e0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+0001b1f0: 7373 6572 7445 7175 616c 2865 7272 2e72  ssertEqual(err.r
+0001b200: 6561 6428 292c 2027 736f 6d65 2065 7272  ead(), 'some err
+0001b210: 6f72 5c6e 2729 0a0a 2020 2020 2020 2020  or\n')..        
+0001b220: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b230: 7175 616c 2873 656c 662e 636c 6965 6e74  qual(self.client
+0001b240: 2e72 6571 7565 7374 732c 205b 0a20 2020  .requests, [.   
+0001b250: 2020 2020 2020 2020 2020 2020 2028 2750               ('P
+0001b260: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
+0001b270: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
+0001b280: 6c64 5f65 7865 635f 6461 7461 285b 2765  ld_exec_data(['e
+0001b290: 6368 6f27 2c20 2766 6f6f 275d 2929 2c0a  cho', 'foo'])),.
+0001b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2b0: 2827 4745 5427 2c20 272f 7631 2f63 6861  ('GET', '/v1/cha
+0001b2c0: 6e67 6573 2f31 3233 2f77 6169 7427 2c20  nges/123/wait', 
+0001b2d0: 7b27 7469 6d65 6f75 7427 3a20 2734 2e30  {'timeout': '4.0
+0001b2e0: 3030 7327 7d2c 204e 6f6e 6529 2c0a 2020  00s'}, None),.  
+0001b2f0: 2020 2020 2020 2020 2020 5d29 0a20 2020            ]).   
+0001b300: 2020 2020 2020 2020 2073 656c 662e 6173           self.as
+0001b310: 7365 7274 4571 7561 6c28 696f 5f77 732e  sertEqual(io_ws.
+0001b320: 7365 6e64 732c 205b 0a20 2020 2020 2020  sends, [.       
+0001b330: 2020 2020 2020 2020 2028 2742 494e 272c           ('BIN',
+0001b340: 2062 2766 6f6f 5c6e 2729 2c0a 2020 2020   b'foo\n'),.    
+0001b350: 2020 2020 2020 2020 2020 2020 2827 5458              ('TX
+0001b360: 5427 2c20 277b 2263 6f6d 6d61 6e64 223a  T', '{"command":
+0001b370: 2265 6e64 227d 2729 2c0a 2020 2020 2020  "end"}'),.      
+0001b380: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
+0001b390: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
+0001b3a0: 2020 2020 2020 6669 6e2e 636c 6f73 6528        fin.close(
+0001b3b0: 290a 2020 2020 2020 2020 2020 2020 6f75  ).            ou
+0001b3c0: 742e 636c 6f73 6528 290a 2020 2020 2020  t.close().      
+0001b3d0: 2020 2020 2020 6572 722e 636c 6f73 6528        err.close(
+0001b3e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001b3f0: 7761 6974 5f72 6574 7572 6e65 645f 696f  wait_returned_io
+0001b400: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001b410: 7374 6469 6f2c 2073 7464 6572 722c 205f  stdio, stderr, _
+0001b420: 203d 2073 656c 662e 6164 645f 7265 7370   = self.add_resp
+0001b430: 6f6e 7365 7328 2731 3233 272c 2030 290a  onses('123', 0).
+0001b440: 2020 2020 2020 2020 7374 6469 6f2e 7265          stdio.re
+0001b450: 6365 6976 6573 2e61 7070 656e 6428 6227  ceives.append(b'
+0001b460: 464f 4f20 4241 525c 6e27 290a 2020 2020  FOO BAR\n').    
+0001b470: 2020 2020 7374 6469 6f2e 7265 6365 6976      stdio.receiv
+0001b480: 6573 2e61 7070 656e 6428 6227 4241 5a5a  es.append(b'BAZZ
+0001b490: 5c6e 2729 0a20 2020 2020 2020 2073 7464  \n').        std
+0001b4a0: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
+0001b4b0: 6e64 2827 7b22 636f 6d6d 616e 6422 3a22  nd('{"command":"
+0001b4c0: 656e 6422 7d27 290a 0a20 2020 2020 2020  end"}')..       
+0001b4d0: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
+0001b4e0: 636c 6965 6e74 2e65 7865 6328 5b27 6177  client.exec(['aw
+0001b4f0: 6b27 2c20 277b 2070 7269 6e74 2074 6f75  k', '{ print tou
+0001b500: 7070 6572 2824 2920 7d27 5d29 0a20 2020  pper($) }']).   
+0001b510: 2020 2020 2070 726f 6365 7373 2e73 7464       process.std
+0001b520: 696e 2e77 7269 7465 2827 466f 6f20 4261  in.write('Foo Ba
+0001b530: 725c 6e27 290a 2020 2020 2020 2020 7365  r\n').        se
+0001b540: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+0001b550: 726f 6365 7373 2e73 7464 6f75 742e 7265  rocess.stdout.re
+0001b560: 6164 2834 292c 2027 464f 4f20 2729 0a20  ad(4), 'FOO '). 
+0001b570: 2020 2020 2020 2070 726f 6365 7373 2e73         process.s
+0001b580: 7464 696e 2e77 7269 7465 2827 6261 7a7a  tdin.write('bazz
+0001b590: 5c6e 2729 0a20 2020 2020 2020 2073 656c  \n').        sel
+0001b5a0: 662e 6173 7365 7274 4571 7561 6c28 7072  f.assertEqual(pr
+0001b5b0: 6f63 6573 732e 7374 646f 7574 2e72 6561  ocess.stdout.rea
+0001b5c0: 6428 292c 2027 4241 525c 6e42 415a 5a5c  d(), 'BAR\nBAZZ\
+0001b5d0: 6e27 290a 2020 2020 2020 2020 7072 6f63  n').        proc
+0001b5e0: 6573 732e 7374 6469 6e2e 636c 6f73 6528  ess.stdin.close(
+0001b5f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001b600: 7373 6572 7445 7175 616c 2870 726f 6365  ssertEqual(proce
+0001b610: 7373 2e73 7464 6f75 742e 7265 6164 2829  ss.stdout.read()
+0001b620: 2c20 2727 290a 2020 2020 2020 2020 7072  , '').        pr
+0001b630: 6f63 6573 732e 7761 6974 2829 0a0a 2020  ocess.wait()..  
+0001b640: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b650: 7445 7175 616c 2873 656c 662e 636c 6965  tEqual(self.clie
+0001b660: 6e74 2e72 6571 7565 7374 732c 205b 0a20  nt.requests, [. 
+0001b670: 2020 2020 2020 2020 2020 2028 2750 4f53             ('POS
+0001b680: 5427 2c20 272f 7631 2f65 7865 6327 2c20  T', '/v1/exec', 
+0001b690: 4e6f 6e65 2c20 7365 6c66 2e62 7569 6c64  None, self.build
+0001b6a0: 5f65 7865 635f 6461 7461 285b 2761 776b  _exec_data(['awk
+0001b6b0: 272c 2027 7b20 7072 696e 7420 746f 7570  ', '{ print toup
+0001b6c0: 7065 7228 2429 207d 275d 2929 2c0a 2020  per($) }'])),.  
+0001b6d0: 2020 2020 2020 2020 2020 2827 4745 5427            ('GET'
+0001b6e0: 2c20 272f 7631 2f63 6861 6e67 6573 2f31  , '/v1/changes/1
+0001b6f0: 3233 2f77 6169 7427 2c20 7b27 7469 6d65  23/wait', {'time
+0001b700: 6f75 7427 3a20 2734 2e30 3030 7327 7d2c  out': '4.000s'},
+0001b710: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0001b720: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+0001b730: 6173 7365 7274 4571 7561 6c28 7374 6469  assertEqual(stdi
+0001b740: 6f2e 7365 6e64 732c 205b 0a20 2020 2020  o.sends, [.     
+0001b750: 2020 2020 2020 2028 2742 494e 272c 2062         ('BIN', b
+0001b760: 2746 6f6f 2042 6172 5c6e 6261 7a7a 5c6e  'Foo Bar\nbazz\n
+0001b770: 2729 2c20 2023 2054 6578 7449 4f57 7261  '),  # TextIOWra
+0001b780: 7070 6572 2067 726f 7570 7320 7468 6520  pper groups the 
+0001b790: 7772 6974 6573 2074 6f67 6574 6865 720a  writes together.
+0001b7a0: 2020 2020 2020 2020 2020 2020 2827 5458              ('TX
+0001b7b0: 5427 2c20 277b 2263 6f6d 6d61 6e64 223a  T', '{"command":
+0001b7c0: 2265 6e64 227d 2729 2c0a 2020 2020 2020  "end"}'),.      
+0001b7d0: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0001b7e0: 7374 5f77 6169 745f 7265 7475 726e 6564  st_wait_returned
+0001b7f0: 5f69 6f5f 6279 7465 7328 7365 6c66 293a  _io_bytes(self):
+0001b800: 0a20 2020 2020 2020 2073 7464 696f 2c20  .        stdio, 
+0001b810: 7374 6465 7272 2c20 5f20 3d20 7365 6c66  stderr, _ = self
+0001b820: 2e61 6464 5f72 6573 706f 6e73 6573 2827  .add_responses('
+0001b830: 3132 3327 2c20 3029 0a20 2020 2020 2020  123', 0).       
+0001b840: 2073 7464 696f 2e72 6563 6569 7665 732e   stdio.receives.
+0001b850: 6170 7065 6e64 2862 2746 4f4f 2042 4152  append(b'FOO BAR
+0001b860: 5c6e 2729 0a20 2020 2020 2020 2073 7464  \n').        std
+0001b870: 696f 2e72 6563 6569 7665 732e 6170 7065  io.receives.appe
+0001b880: 6e64 2862 2742 415a 5a5c 6e27 290a 2020  nd(b'BAZZ\n').  
+0001b890: 2020 2020 2020 7374 6469 6f2e 7265 6365        stdio.rece
+0001b8a0: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
+0001b8b0: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
+0001b8c0: 0a0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+0001b8d0: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+0001b8e0: 6578 6563 285b 2761 776b 272c 2027 7b20  exec(['awk', '{ 
+0001b8f0: 7072 696e 7420 746f 7570 7065 7228 2429  print toupper($)
+0001b900: 207d 275d 2c20 656e 636f 6469 6e67 3d4e   }'], encoding=N
+0001b910: 6f6e 6529 0a20 2020 2020 2020 2070 726f  one).        pro
+0001b920: 6365 7373 2e73 7464 696e 2e77 7269 7465  cess.stdin.write
+0001b930: 2862 2746 6f6f 2042 6172 5c6e 2729 0a20  (b'Foo Bar\n'). 
+0001b940: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001b950: 7274 4571 7561 6c28 7072 6f63 6573 732e  rtEqual(process.
+0001b960: 7374 646f 7574 2e72 6561 6428 3429 2c20  stdout.read(4), 
+0001b970: 6227 464f 4f20 2729 0a20 2020 2020 2020  b'FOO ').       
+0001b980: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001b990: 6c28 7072 6f63 6573 732e 7374 646f 7574  l(process.stdout
+0001b9a0: 2e72 6561 6428 292c 2062 2742 4152 5c6e  .read(), b'BAR\n
+0001b9b0: 2729 0a20 2020 2020 2020 2070 726f 6365  ').        proce
+0001b9c0: 7373 2e73 7464 696e 2e77 7269 7465 2862  ss.stdin.write(b
+0001b9d0: 2762 617a 7a5c 6e27 290a 2020 2020 2020  'bazz\n').      
+0001b9e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001b9f0: 616c 2870 726f 6365 7373 2e73 7464 6f75  al(process.stdou
+0001ba00: 742e 7265 6164 2829 2c20 6227 4241 5a5a  t.read(), b'BAZZ
+0001ba10: 5c6e 2729 0a20 2020 2020 2020 2070 726f  \n').        pro
+0001ba20: 6365 7373 2e73 7464 696e 2e63 6c6f 7365  cess.stdin.close
+0001ba30: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0001ba40: 6173 7365 7274 4571 7561 6c28 7072 6f63  assertEqual(proc
+0001ba50: 6573 732e 7374 646f 7574 2e72 6561 6428  ess.stdout.read(
+0001ba60: 292c 2062 2727 290a 2020 2020 2020 2020  ), b'').        
+0001ba70: 7072 6f63 6573 732e 7761 6974 2829 0a0a  process.wait()..
+0001ba80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001ba90: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+0001baa0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+0001bab0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
+0001bac0: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
+0001bad0: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
+0001bae0: 6c64 5f65 7865 635f 6461 7461 285b 2761  ld_exec_data(['a
+0001baf0: 776b 272c 2027 7b20 7072 696e 7420 746f  wk', '{ print to
+0001bb00: 7570 7065 7228 2429 207d 275d 2929 2c0a  upper($) }'])),.
+0001bb10: 2020 2020 2020 2020 2020 2020 2827 4745              ('GE
+0001bb20: 5427 2c20 272f 7631 2f63 6861 6e67 6573  T', '/v1/changes
+0001bb30: 2f31 3233 2f77 6169 7427 2c20 7b27 7469  /123/wait', {'ti
+0001bb40: 6d65 6f75 7427 3a20 2734 2e30 3030 7327  meout': '4.000s'
+0001bb50: 7d2c 204e 6f6e 6529 2c0a 2020 2020 2020  }, None),.      
+0001bb60: 2020 5d29 0a20 2020 2020 2020 2073 656c    ]).        sel
+0001bb70: 662e 6173 7365 7274 4571 7561 6c28 7374  f.assertEqual(st
+0001bb80: 6469 6f2e 7365 6e64 732c 205b 0a20 2020  dio.sends, [.   
+0001bb90: 2020 2020 2020 2020 2028 2742 494e 272c           ('BIN',
+0001bba0: 2062 2746 6f6f 2042 6172 5c6e 2729 2c0a   b'Foo Bar\n'),.
+0001bbb0: 2020 2020 2020 2020 2020 2020 2827 4249              ('BI
+0001bbc0: 4e27 2c20 6227 6261 7a7a 5c6e 2729 2c0a  N', b'bazz\n'),.
+0001bbd0: 2020 2020 2020 2020 2020 2020 2827 5458              ('TX
+0001bbe0: 5427 2c20 277b 2263 6f6d 6d61 6e64 223a  T', '{"command":
+0001bbf0: 2265 6e64 227d 2729 2c0a 2020 2020 2020  "end"}'),.      
+0001bc00: 2020 5d29 0a0a 2020 2020 6465 6620 7465    ])..    def te
+0001bc10: 7374 5f63 6f6e 6e65 6374 5f77 6562 736f  st_connect_webso
+0001bc20: 636b 6574 5f65 7272 6f72 2873 656c 6629  cket_error(self)
+0001bc30: 3a0a 2020 2020 2020 2020 636c 6173 7320  :.        class 
+0001bc40: 436c 6965 6e74 284d 6f63 6b43 6c69 656e  Client(MockClien
+0001bc50: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+0001bc60: 6465 6620 5f63 6f6e 6e65 6374 5f77 6562  def _connect_web
+0001bc70: 736f 636b 6574 2873 656c 662c 2063 6861  socket(self, cha
+0001bc80: 6e67 655f 6964 2c20 7765 6273 6f63 6b65  nge_id, websocke
+0001bc90: 745f 6964 293a 0a20 2020 2020 2020 2020  t_id):.         
+0001bca0: 2020 2020 2020 2072 6169 7365 2077 6562         raise web
+0001bcb0: 736f 636b 6574 2e57 6562 536f 636b 6574  socket.WebSocket
+0001bcc0: 4578 6365 7074 696f 6e28 2763 6f6e 6e21  Exception('conn!
+0001bcd0: 2729 0a0a 2020 2020 2020 2020 7365 6c66  ')..        self
+0001bce0: 2e63 6c69 656e 7420 3d20 436c 6965 6e74  .client = Client
+0001bcf0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0001bd00: 6164 645f 7265 7370 6f6e 7365 7328 2731  add_responses('1
+0001bd10: 3233 272c 2030 2c20 6368 616e 6765 5f65  23', 0, change_e
+0001bd20: 7272 3d27 6368 616e 6765 2065 7272 6f72  rr='change error
+0001bd30: 2127 290a 2020 2020 2020 2020 7769 7468  !').        with
+0001bd40: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0001bd50: 6573 2870 6562 626c 652e 4368 616e 6765  es(pebble.Change
+0001bd60: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
+0001bd70: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0001bd80: 6c69 656e 742e 6578 6563 285b 2766 6f6f  lient.exec(['foo
+0001bd90: 275d 290a 2020 2020 2020 2020 7365 6c66  ']).        self
+0001bda0: 2e61 7373 6572 7445 7175 616c 2873 7472  .assertEqual(str
+0001bdb0: 2863 6d2e 6578 6365 7074 696f 6e29 2c20  (cm.exception), 
+0001bdc0: 2763 6861 6e67 6520 6572 726f 7221 2729  'change error!')
+0001bdd0: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+0001bde0: 6c69 656e 7420 3d20 436c 6965 6e74 2829  lient = Client()
+0001bdf0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001be00: 645f 7265 7370 6f6e 7365 7328 2731 3233  d_responses('123
+0001be10: 272c 2030 290a 2020 2020 2020 2020 7769  ', 0).        wi
+0001be20: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0001be30: 6973 6573 2870 6562 626c 652e 436f 6e6e  ises(pebble.Conn
+0001be40: 6563 7469 6f6e 4572 726f 7229 2061 7320  ectionError) as 
+0001be50: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
+0001be60: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
+0001be70: 285b 2766 6f6f 275d 290a 2020 2020 2020  (['foo']).      
+0001be80: 2020 7365 6c66 2e61 7373 6572 7449 6e28    self.assertIn(
+0001be90: 7374 7228 636d 2e65 7863 6570 7469 6f6e  str(cm.exception
+0001bea0: 292c 2027 756e 6578 7065 6374 6564 2065  ), 'unexpected e
+0001beb0: 7272 6f72 2063 6f6e 6e65 6374 696e 6720  rror connecting 
+0001bec0: 746f 2077 6562 736f 636b 6574 733a 2063  to websockets: c
+0001bed0: 6f6e 6e21 2729 0a0a 2020 2020 6465 6620  onn!')..    def 
+0001bee0: 7465 7374 5f77 6562 736f 636b 6574 5f73  test_websocket_s
+0001bef0: 656e 645f 7261 6973 6573 2873 656c 6629  end_raises(self)
+0001bf00: 3a0a 2020 2020 2020 2020 7374 6469 6f2c  :.        stdio,
+0001bf10: 2073 7464 6572 722c 205f 203d 2073 656c   stderr, _ = sel
+0001bf20: 662e 6164 645f 7265 7370 6f6e 7365 7328  f.add_responses(
+0001bf30: 2731 3233 272c 2030 290a 2020 2020 2020  '123', 0).      
+0001bf40: 2020 7261 6973 6564 203d 2046 616c 7365    raised = False
+0001bf50: 0a0a 2020 2020 2020 2020 6465 6620 7365  ..        def se
+0001bf60: 6e64 5f62 696e 6172 7928 6229 3a0a 2020  nd_binary(b):.  
+0001bf70: 2020 2020 2020 2020 2020 6e6f 6e6c 6f63            nonloc
+0001bf80: 616c 2072 6169 7365 640a 2020 2020 2020  al raised.      
+0001bf90: 2020 2020 2020 7261 6973 6564 203d 2054        raised = T
+0001bfa0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0001bfb0: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0001bfc0: 2761 2073 696d 756c 6174 6564 2065 7272  'a simulated err
+0001bfd0: 6f72 2127 290a 0a20 2020 2020 2020 2073  or!')..        s
+0001bfe0: 7464 696f 2e73 656e 645f 6269 6e61 7279  tdio.send_binary
+0001bff0: 203d 2073 656e 645f 6269 6e61 7279 0a20   = send_binary. 
+0001c000: 2020 2020 2020 2073 7464 696f 2e72 6563         stdio.rec
+0001c010: 6569 7665 732e 6170 7065 6e64 2827 7b22  eives.append('{"
+0001c020: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
+0001c030: 290a 2020 2020 2020 2020 7374 6465 7272  ).        stderr
+0001c040: 2e72 6563 6569 7665 732e 6170 7065 6e64  .receives.append
+0001c050: 2827 7b22 636f 6d6d 616e 6422 3a22 656e  ('{"command":"en
+0001c060: 6422 7d27 290a 0a20 2020 2020 2020 2070  d"}')..        p
+0001c070: 726f 6365 7373 203d 2073 656c 662e 636c  rocess = self.cl
+0001c080: 6965 6e74 2e65 7865 6328 5b27 6361 7427  ient.exec(['cat'
+0001c090: 5d2c 2073 7464 696e 3d27 666f 6f5c 6e62  ], stdin='foo\nb
+0001c0a0: 6172 5c6e 2729 0a20 2020 2020 2020 206f  ar\n').        o
+0001c0b0: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
+0001c0c0: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
+0001c0d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001c0e0: 6572 7445 7175 616c 286f 7574 2c20 2727  ertEqual(out, ''
+0001c0f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001c100: 7373 6572 7445 7175 616c 2865 7272 2c20  ssertEqual(err, 
+0001c110: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0001c120: 2e61 7373 6572 7454 7275 6528 7261 6973  .assertTrue(rais
+0001c130: 6564 290a 0a20 2020 2020 2020 2073 656c  ed)..        sel
+0001c140: 662e 6173 7365 7274 4571 7561 6c28 7365  f.assertEqual(se
+0001c150: 6c66 2e63 6c69 656e 742e 7265 7175 6573  lf.client.reques
+0001c160: 7473 2c20 5b0a 2020 2020 2020 2020 2020  ts, [.          
+0001c170: 2020 2827 504f 5354 272c 2027 2f76 312f    ('POST', '/v1/
+0001c180: 6578 6563 272c 204e 6f6e 652c 2073 656c  exec', None, sel
+0001c190: 662e 6275 696c 645f 6578 6563 5f64 6174  f.build_exec_dat
+0001c1a0: 6128 5b27 6361 7427 5d29 292c 0a20 2020  a(['cat'])),.   
+0001c1b0: 2020 2020 2020 2020 2028 2747 4554 272c           ('GET',
+0001c1c0: 2027 2f76 312f 6368 616e 6765 732f 3132   '/v1/changes/12
+0001c1d0: 332f 7761 6974 272c 207b 2774 696d 656f  3/wait', {'timeo
+0001c1e0: 7574 273a 2027 342e 3030 3073 277d 2c20  ut': '4.000s'}, 
+0001c1f0: 4e6f 6e65 292c 0a20 2020 2020 2020 205d  None),.        ]
+0001c200: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001c210: 7373 6572 7445 7175 616c 2873 7464 696f  ssertEqual(stdio
+0001c220: 2e73 656e 6473 2c20 5b5d 290a 0a20 2020  .sends, [])..   
+0001c230: 2023 2059 6f75 2764 206e 6f72 6d61 6c6c   # You'd normall
+0001c240: 7920 7573 6520 7079 7465 7374 2e6d 6172  y use pytest.mar
+0001c250: 6b2e 6669 6c74 6572 7761 726e 696e 6773  k.filterwarnings
+0001c260: 2061 7320 6120 6465 636f 7261 746f 722c   as a decorator,
+0001c270: 2062 7574 0a20 2020 2023 2050 7974 6573   but.    # Pytes
+0001c280: 7455 6e68 616e 646c 6564 5468 7265 6164  tUnhandledThread
+0001c290: 4578 6365 7074 696f 6e57 6172 6e69 6e67  ExceptionWarning
+0001c2a0: 2069 736e 2774 2070 7265 7365 6e74 206f   isn't present o
+0001c2b0: 6e20 6f6c 6465 7220 5079 7468 6f6e 2076  n older Python v
+0001c2c0: 6572 7369 6f6e 732e 0a20 2020 2069 6620  ersions..    if 
+0001c2d0: 6861 7361 7474 7228 7079 7465 7374 2c20  hasattr(pytest, 
+0001c2e0: 2750 7974 6573 7455 6e68 616e 646c 6564  'PytestUnhandled
+0001c2f0: 5468 7265 6164 4578 6365 7074 696f 6e57  ThreadExceptionW
+0001c300: 6172 6e69 6e67 2729 3a0a 2020 2020 2020  arning'):.      
+0001c310: 2020 7465 7374 5f77 6562 736f 636b 6574    test_websocket
+0001c320: 5f73 656e 645f 7261 6973 6573 203d 2070  _send_raises = p
+0001c330: 7974 6573 742e 6d61 726b 2e66 696c 7465  ytest.mark.filte
+0001c340: 7277 6172 6e69 6e67 7328 0a20 2020 2020  rwarnings(.     
+0001c350: 2020 2020 2020 2027 6967 6e6f 7265 3a3a         'ignore::
+0001c360: 7079 7465 7374 2e50 7974 6573 7455 6e68  pytest.PytestUnh
+0001c370: 616e 646c 6564 5468 7265 6164 4578 6365  andledThreadExce
+0001c380: 7074 696f 6e57 6172 6e69 6e67 2729 2874  ptionWarning')(t
+0001c390: 6573 745f 7765 6273 6f63 6b65 745f 7365  est_websocket_se
+0001c3a0: 6e64 5f72 6169 7365 7329 0a0a 2020 2020  nd_raises)..    
+0001c3b0: 6465 6620 7465 7374 5f77 6562 736f 636b  def test_websock
+0001c3c0: 6574 5f72 6563 765f 7261 6973 6573 2873  et_recv_raises(s
+0001c3d0: 656c 6629 3a0a 2020 2020 2020 2020 7374  elf):.        st
+0001c3e0: 6469 6f2c 2073 7464 6572 722c 205f 203d  dio, stderr, _ =
+0001c3f0: 2073 656c 662e 6164 645f 7265 7370 6f6e   self.add_respon
+0001c400: 7365 7328 2731 3233 272c 2030 290a 2020  ses('123', 0).  
+0001c410: 2020 2020 2020 7261 6973 6564 203d 2046        raised = F
+0001c420: 616c 7365 0a0a 2020 2020 2020 2020 6465  alse..        de
+0001c430: 6620 7265 6376 2829 3a0a 2020 2020 2020  f recv():.      
+0001c440: 2020 2020 2020 6e6f 6e6c 6f63 616c 2072        nonlocal r
+0001c450: 6169 7365 640a 2020 2020 2020 2020 2020  aised.          
+0001c460: 2020 7261 6973 6564 203d 2054 7275 650a    raised = True.
+0001c470: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001c480: 6520 4578 6365 7074 696f 6e28 2761 2073  e Exception('a s
+0001c490: 696d 756c 6174 6564 2065 7272 6f72 2127  imulated error!'
+0001c4a0: 290a 0a20 2020 2020 2020 2073 7464 696f  )..        stdio
+0001c4b0: 2e72 6563 7620 3d20 7265 6376 0a20 2020  .recv = recv.   
+0001c4c0: 2020 2020 2073 7464 6572 722e 7265 6365       stderr.rece
+0001c4d0: 6976 6573 2e61 7070 656e 6428 277b 2263  ives.append('{"c
+0001c4e0: 6f6d 6d61 6e64 223a 2265 6e64 227d 2729  ommand":"end"}')
+0001c4f0: 0a0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+0001c500: 7320 3d20 7365 6c66 2e63 6c69 656e 742e  s = self.client.
+0001c510: 6578 6563 285b 2763 6174 275d 2c20 7374  exec(['cat'], st
+0001c520: 6469 6e3d 2766 6f6f 5c6e 6261 725c 6e27  din='foo\nbar\n'
+0001c530: 290a 2020 2020 2020 2020 6f75 742c 2065  ).        out, e
+0001c540: 7272 203d 2070 726f 6365 7373 2e77 6169  rr = process.wai
+0001c550: 745f 6f75 7470 7574 2829 0a20 2020 2020  t_output().     
+0001c560: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001c570: 7561 6c28 6f75 742c 2027 2729 0a20 2020  ual(out, '').   
+0001c580: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001c590: 4571 7561 6c28 6572 722c 2027 2729 0a20  Equal(err, ''). 
+0001c5a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001c5b0: 7274 5472 7565 2872 6169 7365 6429 0a0a  rtTrue(raised)..
+0001c5c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001c5d0: 6572 7445 7175 616c 2873 656c 662e 636c  ertEqual(self.cl
+0001c5e0: 6965 6e74 2e72 6571 7565 7374 732c 205b  ient.requests, [
+0001c5f0: 0a20 2020 2020 2020 2020 2020 2028 2750  .            ('P
+0001c600: 4f53 5427 2c20 272f 7631 2f65 7865 6327  OST', '/v1/exec'
+0001c610: 2c20 4e6f 6e65 2c20 7365 6c66 2e62 7569  , None, self.bui
+0001c620: 6c64 5f65 7865 635f 6461 7461 285b 2763  ld_exec_data(['c
+0001c630: 6174 275d 2929 2c0a 2020 2020 2020 2020  at'])),.        
+0001c640: 2020 2020 2827 4745 5427 2c20 272f 7631      ('GET', '/v1
+0001c650: 2f63 6861 6e67 6573 2f31 3233 2f77 6169  /changes/123/wai
+0001c660: 7427 2c20 7b27 7469 6d65 6f75 7427 3a20  t', {'timeout': 
+0001c670: 2734 2e30 3030 7327 7d2c 204e 6f6e 6529  '4.000s'}, None)
+0001c680: 2c0a 2020 2020 2020 2020 5d29 0a20 2020  ,.        ]).   
+0001c690: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001c6a0: 4571 7561 6c28 7374 6469 6f2e 7365 6e64  Equal(stdio.send
+0001c6b0: 732c 205b 0a20 2020 2020 2020 2020 2020  s, [.           
+0001c6c0: 2028 2742 494e 272c 2062 2766 6f6f 5c6e   ('BIN', b'foo\n
+0001c6d0: 6261 725c 6e27 292c 0a20 2020 2020 2020  bar\n'),.       
+0001c6e0: 2020 2020 2028 2754 5854 272c 2027 7b22       ('TXT', '{"
+0001c6f0: 636f 6d6d 616e 6422 3a22 656e 6422 7d27  command":"end"}'
+0001c700: 292c 0a20 2020 2020 2020 205d 290a 0a20  ),.        ]).. 
+0001c710: 2020 2069 6620 6861 7361 7474 7228 7079     if hasattr(py
+0001c720: 7465 7374 2c20 2750 7974 6573 7455 6e68  test, 'PytestUnh
+0001c730: 616e 646c 6564 5468 7265 6164 4578 6365  andledThreadExce
+0001c740: 7074 696f 6e57 6172 6e69 6e67 2729 3a0a  ptionWarning'):.
+0001c750: 2020 2020 2020 2020 7465 7374 5f77 6562          test_web
+0001c760: 736f 636b 6574 5f72 6563 765f 7261 6973  socket_recv_rais
+0001c770: 6573 203d 2070 7974 6573 742e 6d61 726b  es = pytest.mark
+0001c780: 2e66 696c 7465 7277 6172 6e69 6e67 7328  .filterwarnings(
+0001c790: 0a20 2020 2020 2020 2020 2020 2027 6967  .            'ig
+0001c7a0: 6e6f 7265 3a3a 7079 7465 7374 2e50 7974  nore::pytest.Pyt
+0001c7b0: 6573 7455 6e68 616e 646c 6564 5468 7265  estUnhandledThre
+0001c7c0: 6164 4578 6365 7074 696f 6e57 6172 6e69  adExceptionWarni
+0001c7d0: 6e67 2729 2874 6573 745f 7765 6273 6f63  ng')(test_websoc
+0001c7e0: 6b65 745f 7265 6376 5f72 6169 7365 7329  ket_recv_raises)
+0001c7f0: 0a0a 0a23 2053 6574 2074 6865 2052 554e  ...# Set the RUN
+0001c800: 5f52 4541 4c5f 5045 4242 4c45 5f54 4553  _REAL_PEBBLE_TES
+0001c810: 5453 2065 6e76 6972 6f6e 6d65 6e74 2076  TS environment v
+0001c820: 6172 6961 626c 6520 746f 2072 756e 2074  ariable to run t
+0001c830: 6865 7365 2074 6573 7473 0a23 2061 6761  hese tests.# aga
+0001c840: 696e 7374 2061 2072 6561 6c20 5065 6262  inst a real Pebb
+0001c850: 6c65 2073 6572 7665 722e 2046 6f72 2065  le server. For e
+0001c860: 7861 6d70 6c65 2c20 696e 206f 6e65 2074  xample, in one t
+0001c870: 6572 6d69 6e61 6c2c 2072 756e 2050 6562  erminal, run Peb
+0001c880: 626c 653a 0a23 0a23 2024 2050 4542 424c  ble:.#.# $ PEBBL
+0001c890: 453d 7e2f 7065 6262 6c65 2070 6562 626c  E=~/pebble pebbl
+0001c8a0: 6520 7275 6e20 2d2d 6874 7470 3d3a 3430  e run --http=:40
+0001c8b0: 3030 0a23 2032 3032 312d 3039 2d32 3054  00.# 2021-09-20T
+0001c8c0: 3034 3a31 303a 3334 2e39 3334 5a20 5b70  04:10:34.934Z [p
+0001c8d0: 6562 626c 655d 2053 7461 7274 6564 2064  ebble] Started d
+0001c8e0: 6165 6d6f 6e0a 230a 2320 496e 2061 6e6f  aemon.#.# In ano
+0001c8f0: 7468 6572 2074 6572 6d69 6e61 6c2c 2072  ther terminal, r
+0001c900: 756e 2074 6865 2074 6573 7473 3a0a 230a  un the tests:.#.
+0001c910: 2320 2420 736f 7572 6365 202e 746f 782f  # $ source .tox/
+0001c920: 756e 6974 2f62 696e 2f61 6374 6976 6174  unit/bin/activat
+0001c930: 650a 2320 2420 5255 4e5f 5245 414c 5f50  e.# $ RUN_REAL_P
+0001c940: 4542 424c 455f 5445 5354 533d 3120 5045  EBBLE_TESTS=1 PE
+0001c950: 4242 4c45 3d7e 2f70 6562 626c 6520 7079  BBLE=~/pebble py
+0001c960: 7465 7374 2074 6573 742f 7465 7374 5f70  test test/test_p
+0001c970: 6562 626c 652e 7079 202d 7620 2d6b 2052  ebble.py -v -k R
+0001c980: 6561 6c50 6562 626c 650a 2320 2420 6465  ealPebble.# $ de
+0001c990: 6163 7469 7661 7465 0a23 0a40 756e 6974  activate.#.@unit
+0001c9a0: 7465 7374 2e73 6b69 7055 6e6c 6573 7328  test.skipUnless(
+0001c9b0: 6f73 2e67 6574 656e 7628 2752 554e 5f52  os.getenv('RUN_R
+0001c9c0: 4541 4c5f 5045 4242 4c45 5f54 4553 5453  EAL_PEBBLE_TESTS
+0001c9d0: 2729 2c20 2752 554e 5f52 4541 4c5f 5045  '), 'RUN_REAL_PE
+0001c9e0: 4242 4c45 5f54 4553 5453 206e 6f74 2073  BBLE_TESTS not s
+0001c9f0: 6574 2729 0a63 6c61 7373 2054 6573 7452  et').class TestR
+0001ca00: 6561 6c50 6562 626c 6528 756e 6974 7465  ealPebble(unitte
+0001ca10: 7374 2e54 6573 7443 6173 6529 3a0a 2020  st.TestCase):.  
+0001ca20: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
+0001ca30: 293a 0a20 2020 2020 2020 2073 6f63 6b65  ):.        socke
+0001ca40: 745f 7061 7468 203d 206f 732e 6765 7465  t_path = os.gete
+0001ca50: 6e76 2827 5045 4242 4c45 5f53 4f43 4b45  nv('PEBBLE_SOCKE
+0001ca60: 5427 290a 2020 2020 2020 2020 6966 206e  T').        if n
+0001ca70: 6f74 2073 6f63 6b65 745f 7061 7468 2061  ot socket_path a
+0001ca80: 6e64 206f 732e 6765 7465 6e76 2827 5045  nd os.getenv('PE
+0001ca90: 4242 4c45 2729 3a0a 2020 2020 2020 2020  BBLE'):.        
+0001caa0: 2020 2020 736f 636b 6574 5f70 6174 6820      socket_path 
+0001cab0: 3d20 6f73 2e70 6174 682e 6a6f 696e 286f  = os.path.join(o
+0001cac0: 732e 6765 7465 6e76 2827 5045 4242 4c45  s.getenv('PEBBLE
+0001cad0: 2729 2c20 272e 7065 6262 6c65 2e73 6f63  '), '.pebble.soc
+0001cae0: 6b65 7427 290a 2020 2020 2020 2020 6173  ket').        as
+0001caf0: 7365 7274 2073 6f63 6b65 745f 7061 7468  sert socket_path
+0001cb00: 2c20 2750 4542 424c 4520 6f72 2050 4542  , 'PEBBLE or PEB
+0001cb10: 424c 455f 534f 434b 4554 206d 7573 7420  BLE_SOCKET must 
+0001cb20: 6265 2073 6574 2069 6620 5255 4e5f 5245  be set if RUN_RE
+0001cb30: 414c 5f50 4542 424c 455f 5445 5354 5320  AL_PEBBLE_TESTS 
+0001cb40: 7365 7427 0a0a 2020 2020 2020 2020 7365  set'..        se
+0001cb50: 6c66 2e63 6c69 656e 7420 3d20 7065 6262  lf.client = pebb
+0001cb60: 6c65 2e43 6c69 656e 7428 736f 636b 6574  le.Client(socket
+0001cb70: 5f70 6174 683d 736f 636b 6574 5f70 6174  _path=socket_pat
+0001cb80: 6829 0a0a 2020 2020 6465 6620 7465 7374  h)..    def test
+0001cb90: 5f63 6865 636b 735f 616e 645f 6865 616c  _checks_and_heal
+0001cba0: 7468 2873 656c 6629 3a0a 2020 2020 2020  th(self):.      
+0001cbb0: 2020 7365 6c66 2e63 6c69 656e 742e 6164    self.client.ad
+0001cbc0: 645f 6c61 7965 7228 276c 6179 6572 272c  d_layer('layer',
+0001cbd0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+0001cbe0: 6368 6563 6b73 273a 207b 0a20 2020 2020  checks': {.     
+0001cbf0: 2020 2020 2020 2020 2020 2027 6261 6427             'bad'
+0001cc00: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+0001cc10: 2020 2020 2020 2020 276f 7665 7272 6964          'overrid
+0001cc20: 6527 3a20 2772 6570 6c61 6365 272c 0a20  e': 'replace',. 
+0001cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc40: 2020 2027 6c65 7665 6c27 3a20 2772 6561     'level': 'rea
+0001cc50: 6479 272c 0a20 2020 2020 2020 2020 2020  dy',.           
+0001cc60: 2020 2020 2020 2020 2027 7065 7269 6f64           'period
+0001cc70: 273a 2027 3530 6d73 272c 0a20 2020 2020  ': '50ms',.     
+0001cc80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001cc90: 7468 7265 7368 6f6c 6427 3a20 322c 0a20  threshold': 2,. 
+0001cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ccb0: 2020 2027 6578 6563 273a 207b 0a20 2020     'exec': {.   
+0001ccc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ccd0: 2020 2020 2027 636f 6d6d 616e 6427 3a20       'command': 
+0001cce0: 2773 6c65 6570 2078 272c 0a20 2020 2020  'sleep x',.     
+0001ccf0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0001cd00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001cd10: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0001cd20: 2020 2020 2027 676f 6f64 273a 207b 0a20       'good': {. 
+0001cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd40: 2020 2027 6f76 6572 7269 6465 273a 2027     'override': '
+0001cd50: 7265 706c 6163 6527 2c0a 2020 2020 2020  replace',.      
+0001cd60: 2020 2020 2020 2020 2020 2020 2020 276c                'l
+0001cd70: 6576 656c 273a 2027 616c 6976 6527 2c0a  evel': 'alive',.
+0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd90: 2020 2020 2770 6572 696f 6427 3a20 2735      'period': '5
+0001cda0: 306d 7327 2c0a 2020 2020 2020 2020 2020  0ms',.          
+0001cdb0: 2020 2020 2020 2020 2020 2765 7865 6327            'exec'
+0001cdc0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+0001cdd0: 2020 2020 2020 2020 2020 2020 2763 6f6d              'com
+0001cde0: 6d61 6e64 273a 2027 6563 686f 2066 6f6f  mand': 'echo foo
+0001cdf0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001ce00: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0001ce10: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0001ce20: 2020 2020 2020 2020 2020 2020 2027 6f74               'ot
+0001ce30: 6865 7227 3a20 7b0a 2020 2020 2020 2020  her': {.        
+0001ce40: 2020 2020 2020 2020 2020 2020 276f 7665              'ove
+0001ce50: 7272 6964 6527 3a20 2772 6570 6c61 6365  rride': 'replace
+0001ce60: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001ce70: 2020 2020 2020 2027 6578 6563 273a 207b         'exec': {
+0001ce80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ce90: 2020 2020 2020 2020 2027 636f 6d6d 616e           'comman
+0001cea0: 6427 3a20 2765 6368 6f20 6261 7227 2c0a  d': 'echo bar',.
+0001ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cec0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0001ced0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0001cee0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0001cef0: 207d 2c20 636f 6d62 696e 653d 5472 7565   }, combine=True
+0001cf00: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
+0001cf10: 636b 7320 7368 6f75 6c64 2061 6c6c 2062  cks should all b
+0001cf20: 6520 2275 7022 2069 6e69 7469 616c 6c79  e "up" initially
+0001cf30: 0a20 2020 2020 2020 2063 6865 636b 7320  .        checks 
+0001cf40: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
+0001cf50: 745f 6368 6563 6b73 2829 0a20 2020 2020  t_checks().     
+0001cf60: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001cf70: 7561 6c28 6c65 6e28 6368 6563 6b73 292c  ual(len(checks),
+0001cf80: 2033 290a 2020 2020 2020 2020 7365 6c66   3).        self
+0001cf90: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+0001cfa0: 636b 735b 305d 2e6e 616d 652c 2027 6261  cks[0].name, 'ba
+0001cfb0: 6427 290a 2020 2020 2020 2020 7365 6c66  d').        self
+0001cfc0: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+0001cfd0: 636b 735b 305d 2e6c 6576 656c 2c20 7065  cks[0].level, pe
+0001cfe0: 6262 6c65 2e43 6865 636b 4c65 7665 6c2e  bble.CheckLevel.
+0001cff0: 5245 4144 5929 0a20 2020 2020 2020 2073  READY).        s
+0001d000: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001d010: 6368 6563 6b73 5b30 5d2e 7374 6174 7573  checks[0].status
+0001d020: 2c20 7065 6262 6c65 2e43 6865 636b 5374  , pebble.CheckSt
+0001d030: 6174 7573 2e55 5029 0a20 2020 2020 2020  atus.UP).       
+0001d040: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d050: 6c28 6368 6563 6b73 5b31 5d2e 6e61 6d65  l(checks[1].name
+0001d060: 2c20 2767 6f6f 6427 290a 2020 2020 2020  , 'good').      
+0001d070: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001d080: 616c 2863 6865 636b 735b 315d 2e6c 6576  al(checks[1].lev
+0001d090: 656c 2c20 7065 6262 6c65 2e43 6865 636b  el, pebble.Check
+0001d0a0: 4c65 7665 6c2e 414c 4956 4529 0a20 2020  Level.ALIVE).   
+0001d0b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001d0c0: 4571 7561 6c28 6368 6563 6b73 5b31 5d2e  Equal(checks[1].
+0001d0d0: 7374 6174 7573 2c20 7065 6262 6c65 2e43  status, pebble.C
+0001d0e0: 6865 636b 5374 6174 7573 2e55 5029 0a20  heckStatus.UP). 
+0001d0f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001d100: 7274 4571 7561 6c28 6368 6563 6b73 5b32  rtEqual(checks[2
+0001d110: 5d2e 6e61 6d65 2c20 276f 7468 6572 2729  ].name, 'other')
+0001d120: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001d130: 7365 7274 4571 7561 6c28 6368 6563 6b73  sertEqual(checks
+0001d140: 5b32 5d2e 6c65 7665 6c2c 2070 6562 626c  [2].level, pebbl
+0001d150: 652e 4368 6563 6b4c 6576 656c 2e55 4e53  e.CheckLevel.UNS
+0001d160: 4554 290a 2020 2020 2020 2020 7365 6c66  ET).        self
+0001d170: 2e61 7373 6572 7445 7175 616c 2863 6865  .assertEqual(che
+0001d180: 636b 735b 325d 2e73 7461 7475 732c 2070  cks[2].status, p
+0001d190: 6562 626c 652e 4368 6563 6b53 7461 7475  ebble.CheckStatu
+0001d1a0: 732e 5550 290a 0a20 2020 2020 2020 2023  s.UP)..        #
+0001d1b0: 2041 6e64 202f 7631 2f68 6561 6c74 6820   And /v1/health 
+0001d1c0: 7368 6f75 6c64 2072 6574 7572 6e20 2268  should return "h
+0001d1d0: 6561 6c74 6879 220a 2020 2020 2020 2020  ealthy".        
+0001d1e0: 6865 616c 7468 203d 2073 656c 662e 5f67  health = self._g
+0001d1f0: 6574 5f68 6561 6c74 6828 290a 2020 2020  et_health().    
+0001d200: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001d210: 7175 616c 2868 6561 6c74 682c 207b 0a20  qual(health, {. 
+0001d220: 2020 2020 2020 2020 2020 2027 7265 7375             'resu
+0001d230: 6c74 273a 207b 2768 6561 6c74 6879 273a  lt': {'healthy':
+0001d240: 2054 7275 657d 2c0a 2020 2020 2020 2020   True},.        
+0001d250: 2020 2020 2773 7461 7475 7327 3a20 274f      'status': 'O
+0001d260: 4b27 2c0a 2020 2020 2020 2020 2020 2020  K',.            
+0001d270: 2773 7461 7475 732d 636f 6465 273a 2032  'status-code': 2
+0001d280: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+0001d290: 2774 7970 6527 3a20 2773 796e 6327 2c0a  'type': 'sync',.
+0001d2a0: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
+0001d2b0: 2020 2020 2320 4166 7465 7220 7477 6f20      # After two 
+0001d2c0: 7265 7472 6965 7320 7468 6520 2262 6164  retries the "bad
+0001d2d0: 2220 6368 6563 6b20 7368 6f75 6c64 2067  " check should g
+0001d2e0: 6f20 646f 776e 0a20 2020 2020 2020 2066  o down.        f
+0001d2f0: 6f72 2069 2069 6e20 7261 6e67 6528 3529  or i in range(5)
+0001d300: 3a0a 2020 2020 2020 2020 2020 2020 6368  :.            ch
+0001d310: 6563 6b73 203d 2073 656c 662e 636c 6965  ecks = self.clie
+0001d320: 6e74 2e67 6574 5f63 6865 636b 7328 290a  nt.get_checks().
+0001d330: 2020 2020 2020 2020 2020 2020 6261 645f              bad_
+0001d340: 6368 6563 6b20 3d20 5b63 2066 6f72 2063  check = [c for c
+0001d350: 2069 6e20 6368 6563 6b73 2069 6620 632e   in checks if c.
+0001d360: 6e61 6d65 203d 3d20 2762 6164 275d 5b30  name == 'bad'][0
+0001d370: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+0001d380: 2062 6164 5f63 6865 636b 2e73 7461 7475   bad_check.statu
+0001d390: 7320 3d3d 2070 6562 626c 652e 4368 6563  s == pebble.Chec
+0001d3a0: 6b53 7461 7475 732e 444f 574e 3a0a 2020  kStatus.DOWN:.  
+0001d3b0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+0001d3c0: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
+0001d3d0: 7469 6d65 2e73 6c65 6570 2830 2e30 3629  time.sleep(0.06)
+0001d3e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001d3f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001d400: 7420 4661 6c73 652c 2027 7469 6d65 6420  t False, 'timed 
+0001d410: 6f75 7420 7761 6974 696e 6720 666f 7220  out waiting for 
+0001d420: 2262 6164 2220 6368 6563 6b20 746f 2067  "bad" check to g
+0001d430: 6f20 646f 776e 270a 2020 2020 2020 2020  o down'.        
+0001d440: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001d450: 2862 6164 5f63 6865 636b 2e66 6169 6c75  (bad_check.failu
+0001d460: 7265 732c 2032 290a 2020 2020 2020 2020  res, 2).        
+0001d470: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001d480: 2862 6164 5f63 6865 636b 2e74 6872 6573  (bad_check.thres
+0001d490: 686f 6c64 2c20 3229 0a20 2020 2020 2020  hold, 2).       
+0001d4a0: 2067 6f6f 645f 6368 6563 6b20 3d20 5b63   good_check = [c
+0001d4b0: 2066 6f72 2063 2069 6e20 6368 6563 6b73   for c in checks
+0001d4c0: 2069 6620 632e 6e61 6d65 203d 3d20 2767   if c.name == 'g
+0001d4d0: 6f6f 6427 5d5b 305d 0a20 2020 2020 2020  ood'][0].       
+0001d4e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d4f0: 6c28 676f 6f64 5f63 6865 636b 2e73 7461  l(good_check.sta
+0001d500: 7475 732c 2070 6562 626c 652e 4368 6563  tus, pebble.Chec
+0001d510: 6b53 7461 7475 732e 5550 290a 0a20 2020  kStatus.UP)..   
+0001d520: 2020 2020 2023 2041 6e64 202f 7631 2f68       # And /v1/h
+0001d530: 6561 6c74 6820 7368 6f75 6c64 2072 6574  ealth should ret
+0001d540: 7572 6e20 2275 6e68 6561 6c74 6879 2220  urn "unhealthy" 
+0001d550: 2877 6974 6820 7374 6174 7573 2048 5454  (with status HTT
+0001d560: 5020 3530 3229 0a20 2020 2020 2020 2077  P 502).        w
+0001d570: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0001d580: 6169 7365 7328 7572 6c6c 6962 2e65 7272  aises(urllib.err
+0001d590: 6f72 2e48 5454 5045 7272 6f72 2920 6173  or.HTTPError) as
+0001d5a0: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
+0001d5b0: 2073 656c 662e 5f67 6574 5f68 6561 6c74   self._get_healt
+0001d5c0: 6828 290a 2020 2020 2020 2020 7365 6c66  h().        self
+0001d5d0: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
+0001d5e0: 6578 6365 7074 696f 6e2e 636f 6465 2c20  exception.code, 
+0001d5f0: 3530 3229 0a20 2020 2020 2020 2068 6561  502).        hea
+0001d600: 6c74 6820 3d20 6a73 6f6e 2e6c 6f61 6473  lth = json.loads
+0001d610: 2863 6d2e 6578 6365 7074 696f 6e2e 7265  (cm.exception.re
+0001d620: 6164 2829 290a 2020 2020 2020 2020 7365  ad()).        se
+0001d630: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+0001d640: 6561 6c74 682c 207b 0a20 2020 2020 2020  ealth, {.       
+0001d650: 2020 2020 2027 7265 7375 6c74 273a 207b       'result': {
+0001d660: 2768 6561 6c74 6879 273a 2046 616c 7365  'healthy': False
+0001d670: 7d2c 0a20 2020 2020 2020 2020 2020 2027  },.            '
+0001d680: 7374 6174 7573 273a 2027 4261 6420 4761  status': 'Bad Ga
+0001d690: 7465 7761 7927 2c0a 2020 2020 2020 2020  teway',.        
+0001d6a0: 2020 2020 2773 7461 7475 732d 636f 6465      'status-code
+0001d6b0: 273a 2035 3032 2c0a 2020 2020 2020 2020  ': 502,.        
+0001d6c0: 2020 2020 2774 7970 6527 3a20 2773 796e      'type': 'syn
+0001d6d0: 6327 2c0a 2020 2020 2020 2020 7d29 0a0a  c',.        })..
+0001d6e0: 2020 2020 2020 2020 2320 5468 656e 2074          # Then t
+0001d6f0: 6573 7420 6669 6c74 6572 696e 6720 6279  est filtering by
+0001d700: 2063 6865 636b 206c 6576 656c 2061 6e64   check level and
+0001d710: 2062 7920 6e61 6d65 0a20 2020 2020 2020   by name.       
+0001d720: 2063 6865 636b 7320 3d20 7365 6c66 2e63   checks = self.c
+0001d730: 6c69 656e 742e 6765 745f 6368 6563 6b73  lient.get_checks
+0001d740: 286c 6576 656c 3d70 6562 626c 652e 4368  (level=pebble.Ch
+0001d750: 6563 6b4c 6576 656c 2e41 4c49 5645 290a  eckLevel.ALIVE).
+0001d760: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001d770: 6572 7445 7175 616c 286c 656e 2863 6865  ertEqual(len(che
+0001d780: 636b 7329 2c20 3129 0a20 2020 2020 2020  cks), 1).       
+0001d790: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d7a0: 6c28 6368 6563 6b73 5b30 5d2e 6e61 6d65  l(checks[0].name
+0001d7b0: 2c20 2767 6f6f 6427 290a 2020 2020 2020  , 'good').      
+0001d7c0: 2020 6368 6563 6b73 203d 2073 656c 662e    checks = self.
+0001d7d0: 636c 6965 6e74 2e67 6574 5f63 6865 636b  client.get_check
+0001d7e0: 7328 6e61 6d65 733d 5b27 676f 6f64 272c  s(names=['good',
+0001d7f0: 2027 6261 6427 5d29 0a20 2020 2020 2020   'bad']).       
+0001d800: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001d810: 6c28 6c65 6e28 6368 6563 6b73 292c 2032  l(len(checks), 2
+0001d820: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001d830: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0001d840: 735b 305d 2e6e 616d 652c 2027 6261 6427  s[0].name, 'bad'
+0001d850: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001d860: 7373 6572 7445 7175 616c 2863 6865 636b  ssertEqual(check
+0001d870: 735b 315d 2e6e 616d 652c 2027 676f 6f64  s[1].name, 'good
+0001d880: 2729 0a0a 2020 2020 6465 6620 5f67 6574  ')..    def _get
+0001d890: 5f68 6561 6c74 6828 7365 6c66 293a 0a20  _health(self):. 
+0001d8a0: 2020 2020 2020 2066 203d 2075 726c 6c69         f = urlli
+0001d8b0: 622e 7265 7175 6573 742e 7572 6c6f 7065  b.request.urlope
+0001d8c0: 6e28 2768 7474 703a 2f2f 6c6f 6361 6c68  n('http://localh
+0001d8d0: 6f73 743a 3430 3030 2f76 312f 6865 616c  ost:4000/v1/heal
+0001d8e0: 7468 2729 0a20 2020 2020 2020 2072 6574  th').        ret
+0001d8f0: 7572 6e20 6a73 6f6e 2e6c 6f61 6473 2866  urn json.loads(f
+0001d900: 2e72 6561 6428 2929 0a0a 2020 2020 6465  .read())..    de
+0001d910: 6620 7465 7374 5f65 7865 635f 7761 6974  f test_exec_wait
+0001d920: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001d930: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
+0001d940: 6c69 656e 742e 6578 6563 285b 2774 7275  lient.exec(['tru
+0001d950: 6527 5d29 0a20 2020 2020 2020 2070 726f  e']).        pro
+0001d960: 6365 7373 2e77 6169 7428 290a 0a20 2020  cess.wait()..   
+0001d970: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0001d980: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
+0001d990: 6c65 2e45 7865 6345 7272 6f72 2920 6173  le.ExecError) as
+0001d9a0: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
+0001d9b0: 2070 726f 6365 7373 203d 2073 656c 662e   process = self.
+0001d9c0: 636c 6965 6e74 2e65 7865 6328 5b27 2f62  client.exec(['/b
+0001d9d0: 696e 2f73 6827 2c20 272d 6327 2c20 2765  in/sh', '-c', 'e
+0001d9e0: 7869 7420 3432 275d 290a 2020 2020 2020  xit 42']).      
+0001d9f0: 2020 2020 2020 7072 6f63 6573 732e 7761        process.wa
+0001da00: 6974 2829 0a20 2020 2020 2020 2073 656c  it().        sel
+0001da10: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
+0001da20: 2e65 7863 6570 7469 6f6e 2e65 7869 745f  .exception.exit_
+0001da30: 636f 6465 2c20 3432 290a 0a20 2020 2064  code, 42)..    d
+0001da40: 6566 2074 6573 745f 6578 6563 5f77 6169  ef test_exec_wai
+0001da50: 745f 6f75 7470 7574 2873 656c 6629 3a0a  t_output(self):.
+0001da60: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
+0001da70: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
+0001da80: 6563 285b 272f 6269 6e2f 7368 272c 2027  ec(['/bin/sh', '
+0001da90: 2d63 272c 2027 6563 686f 204f 5554 3b20  -c', 'echo OUT; 
+0001daa0: 6563 686f 2045 5252 203e 2632 275d 290a  echo ERR >&2']).
+0001dab0: 2020 2020 2020 2020 6f75 742c 2065 7272          out, err
+0001dac0: 203d 2070 726f 6365 7373 2e77 6169 745f   = process.wait_
+0001dad0: 6f75 7470 7574 2829 0a20 2020 2020 2020  output().       
+0001dae0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001daf0: 6c28 6f75 742c 2027 4f55 545c 6e27 290a  l(out, 'OUT\n').
+0001db00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001db10: 6572 7445 7175 616c 2865 7272 2c20 2745  ertEqual(err, 'E
+0001db20: 5252 5c6e 2729 0a0a 2020 2020 2020 2020  RR\n')..        
+0001db30: 7072 6f63 6573 7320 3d20 7365 6c66 2e63  process = self.c
+0001db40: 6c69 656e 742e 6578 6563 285b 272f 6269  lient.exec(['/bi
+0001db50: 6e2f 7368 272c 2027 2d63 272c 2027 6563  n/sh', '-c', 'ec
+0001db60: 686f 204f 5554 3b20 6563 686f 2045 5252  ho OUT; echo ERR
+0001db70: 203e 2632 275d 2c20 656e 636f 6469 6e67   >&2'], encoding
+0001db80: 3d4e 6f6e 6529 0a20 2020 2020 2020 206f  =None).        o
+0001db90: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
+0001dba0: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
+0001dbb0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001dbc0: 6572 7445 7175 616c 286f 7574 2c20 6227  ertEqual(out, b'
+0001dbd0: 4f55 545c 6e27 290a 2020 2020 2020 2020  OUT\n').        
+0001dbe0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001dbf0: 2865 7272 2c20 6227 4552 525c 6e27 290a  (err, b'ERR\n').
+0001dc00: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0001dc10: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0001dc20: 7065 6262 6c65 2e45 7865 6345 7272 6f72  pebble.ExecError
+0001dc30: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+0001dc40: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
+0001dc50: 656c 662e 636c 6965 6e74 2e65 7865 6328  elf.client.exec(
+0001dc60: 5b27 2f62 696e 2f73 6827 2c20 272d 6327  ['/bin/sh', '-c'
+0001dc70: 2c20 2765 6368 6f20 4f55 543b 2065 6368  , 'echo OUT; ech
+0001dc80: 6f20 4552 5220 3e26 323b 2065 7869 7420  o ERR >&2; exit 
+0001dc90: 3432 275d 290a 2020 2020 2020 2020 2020  42']).          
+0001dca0: 2020 7072 6f63 6573 732e 7761 6974 5f6f    process.wait_o
+0001dcb0: 7574 7075 7428 290a 2020 2020 2020 2020  utput().        
+0001dcc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001dcd0: 2863 6d2e 6578 6365 7074 696f 6e2e 6578  (cm.exception.ex
+0001dce0: 6974 5f63 6f64 652c 2034 3229 0a20 2020  it_code, 42).   
+0001dcf0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001dd00: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
+0001dd10: 6f6e 2e73 7464 6f75 742c 2027 4f55 545c  on.stdout, 'OUT\
+0001dd20: 6e27 290a 2020 2020 2020 2020 7365 6c66  n').        self
+0001dd30: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
+0001dd40: 6578 6365 7074 696f 6e2e 7374 6465 7272  exception.stderr
+0001dd50: 2c20 2745 5252 5c6e 2729 0a0a 2020 2020  , 'ERR\n')..    
+0001dd60: 6465 6620 7465 7374 5f65 7865 635f 7365  def test_exec_se
+0001dd70: 6e64 5f73 7464 696e 2873 656c 6629 3a0a  nd_stdin(self):.
+0001dd80: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
+0001dd90: 3d20 7365 6c66 2e63 6c69 656e 742e 6578  = self.client.ex
+0001dda0: 6563 285b 2761 776b 272c 2027 7b20 7072  ec(['awk', '{ pr
+0001ddb0: 696e 7420 746f 7570 7065 7228 2430 2920  int toupper($0) 
+0001ddc0: 7d27 5d2c 2073 7464 696e 3d27 666f 6f5c  }'], stdin='foo\
+0001ddd0: 6e42 6172 5c6e 2729 0a20 2020 2020 2020  nBar\n').       
+0001dde0: 206f 7574 2c20 6572 7220 3d20 7072 6f63   out, err = proc
+0001ddf0: 6573 732e 7761 6974 5f6f 7574 7075 7428  ess.wait_output(
+0001de00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001de10: 7373 6572 7445 7175 616c 286f 7574 2c20  ssertEqual(out, 
+0001de20: 2746 4f4f 5c6e 4241 525c 6e27 290a 2020  'FOO\nBAR\n').  
+0001de30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001de40: 7445 7175 616c 2865 7272 2c20 2727 290a  tEqual(err, '').
+0001de50: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+0001de60: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+0001de70: 7865 6328 5b27 6177 6b27 2c20 277b 2070  xec(['awk', '{ p
+0001de80: 7269 6e74 2074 6f75 7070 6572 2824 3029  rint toupper($0)
+0001de90: 207d 275d 2c20 7374 6469 6e3d 6227 666f   }'], stdin=b'fo
+0001dea0: 6f5c 6e42 6172 5c6e 272c 0a20 2020 2020  o\nBar\n',.     
+0001deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dec0: 2020 2020 2020 2020 2020 2020 2020 656e                en
+0001ded0: 636f 6469 6e67 3d4e 6f6e 6529 0a20 2020  coding=None).   
+0001dee0: 2020 2020 206f 7574 2c20 6572 7220 3d20       out, err = 
+0001def0: 7072 6f63 6573 732e 7761 6974 5f6f 7574  process.wait_out
+0001df00: 7075 7428 290a 2020 2020 2020 2020 7365  put().        se
+0001df10: 6c66 2e61 7373 6572 7445 7175 616c 286f  lf.assertEqual(o
+0001df20: 7574 2c20 6227 464f 4f5c 6e42 4152 5c6e  ut, b'FOO\nBAR\n
+0001df30: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001df40: 6173 7365 7274 4571 7561 6c28 6572 722c  assertEqual(err,
+0001df50: 2062 2727 290a 0a20 2020 2064 6566 2074   b'')..    def t
+0001df60: 6573 745f 7075 7368 5f70 756c 6c28 7365  est_push_pull(se
+0001df70: 6c66 293a 0a20 2020 2020 2020 2066 6e61  lf):.        fna
+0001df80: 6d65 203d 206f 732e 7061 7468 2e6a 6f69  me = os.path.joi
+0001df90: 6e28 7465 6d70 6669 6c65 2e67 6574 7465  n(tempfile.gette
+0001dfa0: 6d70 6469 7228 292c 2066 2770 6562 626c  mpdir(), f'pebbl
+0001dfb0: 6574 6573 742d 7b75 7569 642e 7575 6964  etest-{uuid.uuid
+0001dfc0: 3428 297d 2729 0a20 2020 2020 2020 2063  4()}').        c
+0001dfd0: 6f6e 7465 6e74 203d 2027 666f 6f5c 6e62  ontent = 'foo\nb
+0001dfe0: 6172 5c6e 6261 7a2d 3432 270a 2020 2020  ar\nbaz-42'.    
+0001dff0: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0001e000: 7075 7368 2866 6e61 6d65 2c20 636f 6e74  push(fname, cont
+0001e010: 656e 7429 0a20 2020 2020 2020 2077 6974  ent).        wit
+0001e020: 6820 7365 6c66 2e63 6c69 656e 742e 7075  h self.client.pu
+0001e030: 6c6c 2866 6e61 6d65 2920 6173 2066 3a0a  ll(fname) as f:.
+0001e040: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0001e050: 203d 2066 2e72 6561 6428 290a 2020 2020   = f.read().    
+0001e060: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001e070: 6572 7445 7175 616c 2864 6174 612c 2063  ertEqual(data, c
+0001e080: 6f6e 7465 6e74 290a 2020 2020 2020 2020  ontent).        
+0001e090: 6f73 2e72 656d 6f76 6528 666e 616d 6529  os.remove(fname)
+0001e0a0: 0a0a 2020 2020 6465 6620 7465 7374 5f65  ..    def test_e
+0001e0b0: 7865 635f 7469 6d65 6f75 7428 7365 6c66  xec_timeout(self
+0001e0c0: 293a 0a20 2020 2020 2020 2070 726f 6365  ):.        proce
+0001e0d0: 7373 203d 2073 656c 662e 636c 6965 6e74  ss = self.client
+0001e0e0: 2e65 7865 6328 5b27 736c 6565 7027 2c20  .exec(['sleep', 
+0001e0f0: 2730 2e32 275d 2c20 7469 6d65 6f75 743d  '0.2'], timeout=
+0001e100: 302e 3129 0a20 2020 2020 2020 2077 6974  0.1).        wit
+0001e110: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0001e120: 7365 7328 7065 6262 6c65 2e43 6861 6e67  ses(pebble.Chang
+0001e130: 6545 7272 6f72 2920 6173 2063 6d3a 0a20  eError) as cm:. 
+0001e140: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+0001e150: 7373 2e77 6169 7428 290a 2020 2020 2020  ss.wait().      
+0001e160: 2020 7365 6c66 2e61 7373 6572 7449 6e28    self.assertIn(
+0001e170: 2774 696d 6564 206f 7574 272c 2063 6d2e  'timed out', cm.
+0001e180: 6578 6365 7074 696f 6e2e 6572 7229 0a0a  exception.err)..
+0001e190: 2020 2020 6465 6620 7465 7374 5f65 7865      def test_exe
+0001e1a0: 635f 776f 726b 696e 675f 6469 7228 7365  c_working_dir(se
+0001e1b0: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
+0001e1c0: 6820 7465 6d70 6669 6c65 2e54 656d 706f  h tempfile.Tempo
+0001e1d0: 7261 7279 4469 7265 6374 6f72 7928 2920  raryDirectory() 
+0001e1e0: 6173 2074 656d 705f 6469 723a 0a20 2020  as temp_dir:.   
+0001e1f0: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0001e200: 203d 2073 656c 662e 636c 6965 6e74 2e65   = self.client.e
+0001e210: 7865 6328 5b27 7077 6427 5d2c 2077 6f72  xec(['pwd'], wor
+0001e220: 6b69 6e67 5f64 6972 3d74 656d 705f 6469  king_dir=temp_di
+0001e230: 7229 0a20 2020 2020 2020 2020 2020 206f  r).            o
+0001e240: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
+0001e250: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
+0001e260: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e270: 2e61 7373 6572 7445 7175 616c 286f 7574  .assertEqual(out
+0001e280: 2c20 6622 7b74 656d 705f 6469 727d 5c6e  , f"{temp_dir}\n
+0001e290: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
+0001e2a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001e2b0: 6572 722c 2027 2729 0a0a 2020 2020 6465  err, '')..    de
+0001e2c0: 6620 7465 7374 5f65 7865 635f 656e 7669  f test_exec_envi
+0001e2d0: 726f 6e6d 656e 7428 7365 6c66 293a 0a20  ronment(self):. 
+0001e2e0: 2020 2020 2020 2070 726f 6365 7373 203d         process =
+0001e2f0: 2073 656c 662e 636c 6965 6e74 2e65 7865   self.client.exe
+0001e300: 6328 5b27 2f62 696e 2f73 6827 2c20 272d  c(['/bin/sh', '-
+0001e310: 6327 2c20 2765 6368 6f20 244f 4e45 2e24  c', 'echo $ONE.$
+0001e320: 5457 4f2e 2454 4852 4545 275d 2c0a 2020  TWO.$THREE'],.  
+0001e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e350: 2065 6e76 6972 6f6e 6d65 6e74 3d7b 274f   environment={'O
+0001e360: 4e45 273a 2027 3127 2c20 2754 574f 273a  NE': '1', 'TWO':
+0001e370: 2027 3227 7d29 0a20 2020 2020 2020 206f   '2'}).        o
+0001e380: 7574 2c20 6572 7220 3d20 7072 6f63 6573  ut, err = proces
+0001e390: 732e 7761 6974 5f6f 7574 7075 7428 290a  s.wait_output().
+0001e3a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001e3b0: 6572 7445 7175 616c 286f 7574 2c20 2731  ertEqual(out, '1
+0001e3c0: 2e32 2e5c 6e27 290a 2020 2020 2020 2020  .2.\n').        
+0001e3d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001e3e0: 2865 7272 2c20 2727 290a 0a20 2020 2064  (err, '')..    d
+0001e3f0: 6566 2074 6573 745f 6578 6563 5f73 7472  ef test_exec_str
+0001e400: 6561 6d69 6e67 2873 656c 6629 3a0a 2020  eaming(self):.  
+0001e410: 2020 2020 2020 7072 6f63 6573 7320 3d20        process = 
+0001e420: 7365 6c66 2e63 6c69 656e 742e 6578 6563  self.client.exec
+0001e430: 285b 2763 6174 275d 290a 0a20 2020 2020  (['cat'])..     
+0001e440: 2020 2064 6566 2073 7464 696e 5f74 6872     def stdin_thr
+0001e450: 6561 6428 293a 0a20 2020 2020 2020 2020  ead():.         
+0001e460: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001e470: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
+0001e480: 2069 6e20 5b27 6f6e 655c 6e27 2c20 2732   in ['one\n', '2
+0001e490: 5c6e 272c 2027 5448 5245 455c 6e27 5d3a  \n', 'THREE\n']:
+0001e4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e4b0: 2020 2020 2070 726f 6365 7373 2e73 7464       process.std
+0001e4c0: 696e 2e77 7269 7465 286c 696e 6529 0a20  in.write(line). 
+0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4e0: 2020 2070 726f 6365 7373 2e73 7464 696e     process.stdin
+0001e4f0: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
+0001e500: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+0001e510: 652e 736c 6565 7028 302e 3129 0a20 2020  e.sleep(0.1).   
+0001e520: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
+0001e530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e540: 2020 7072 6f63 6573 732e 7374 6469 6e2e    process.stdin.
+0001e550: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
+0001e560: 2074 6872 6561 6469 6e67 2e54 6872 6561   threading.Threa
+0001e570: 6428 7461 7267 6574 3d73 7464 696e 5f74  d(target=stdin_t
+0001e580: 6872 6561 6429 2e73 7461 7274 2829 0a0a  hread).start()..
+0001e590: 2020 2020 2020 2020 7265 6164 7320 3d20          reads = 
+0001e5a0: 5b5d 0a20 2020 2020 2020 2066 6f72 206c  [].        for l
+0001e5b0: 696e 6520 696e 2070 726f 6365 7373 2e73  ine in process.s
+0001e5c0: 7464 6f75 743a 0a20 2020 2020 2020 2020  tdout:.         
+0001e5d0: 2020 2072 6561 6473 2e61 7070 656e 6428     reads.append(
+0001e5e0: 6c69 6e65 290a 0a20 2020 2020 2020 2070  line)..        p
+0001e5f0: 726f 6365 7373 2e77 6169 7428 290a 0a20  rocess.wait().. 
+0001e600: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001e610: 7274 4571 7561 6c28 7265 6164 732c 205b  rtEqual(reads, [
+0001e620: 276f 6e65 5c6e 272c 2027 325c 6e27 2c20  'one\n', '2\n', 
+0001e630: 2754 4852 4545 5c6e 275d 290a 0a20 2020  'THREE\n'])..   
+0001e640: 2064 6566 2074 6573 745f 6578 6563 5f73   def test_exec_s
+0001e650: 7472 6561 6d69 6e67 5f62 7974 6573 2873  treaming_bytes(s
+0001e660: 656c 6629 3a0a 2020 2020 2020 2020 7072  elf):.        pr
+0001e670: 6f63 6573 7320 3d20 7365 6c66 2e63 6c69  ocess = self.cli
+0001e680: 656e 742e 6578 6563 285b 2763 6174 275d  ent.exec(['cat']
+0001e690: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
+0001e6a0: 0a0a 2020 2020 2020 2020 6465 6620 7374  ..        def st
+0001e6b0: 6469 6e5f 7468 7265 6164 2829 3a0a 2020  din_thread():.  
+0001e6c0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0001e6d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001e6e0: 6f72 206c 696e 6520 696e 205b 6227 6f6e  or line in [b'on
+0001e6f0: 655c 6e27 2c20 6227 325c 6e27 2c20 6227  e\n', b'2\n', b'
+0001e700: 5448 5245 455c 6e27 5d3a 0a20 2020 2020  THREE\n']:.     
+0001e710: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001e720: 726f 6365 7373 2e73 7464 696e 2e77 7269  rocess.stdin.wri
+0001e730: 7465 286c 696e 6529 0a20 2020 2020 2020  te(line).       
+0001e740: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+0001e750: 6365 7373 2e73 7464 696e 2e66 6c75 7368  cess.stdin.flush
+0001e760: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001e770: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+0001e780: 7028 302e 3129 0a20 2020 2020 2020 2020  p(0.1).         
+0001e790: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+0001e7a0: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0001e7b0: 6573 732e 7374 6469 6e2e 636c 6f73 6528  ess.stdin.close(
+0001e7c0: 290a 0a20 2020 2020 2020 2074 6872 6561  )..        threa
+0001e7d0: 6469 6e67 2e54 6872 6561 6428 7461 7267  ding.Thread(targ
+0001e7e0: 6574 3d73 7464 696e 5f74 6872 6561 6429  et=stdin_thread)
+0001e7f0: 2e73 7461 7274 2829 0a0a 2020 2020 2020  .start()..      
+0001e800: 2020 7265 6164 7320 3d20 5b5d 0a20 2020    reads = [].   
+0001e810: 2020 2020 2066 6f72 206c 696e 6520 696e       for line in
+0001e820: 2070 726f 6365 7373 2e73 7464 6f75 743a   process.stdout:
+0001e830: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
+0001e840: 6473 2e61 7070 656e 6428 6c69 6e65 290a  ds.append(line).
+0001e850: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+0001e860: 2e77 6169 7428 290a 0a20 2020 2020 2020  .wait()..       
+0001e870: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001e880: 6c28 7265 6164 732c 205b 6227 6f6e 655c  l(reads, [b'one\
+0001e890: 6e27 2c20 6227 325c 6e27 2c20 6227 5448  n', b'2\n', b'TH
+0001e8a0: 5245 455c 6e27 5d29 0a                   REE\n']).
```

### Comparing `ops-2.1.1/test/test_private.py` & `ops-2.2.0/test/test_private.py`

 * *Files identical despite different names*

### Comparing `ops-2.1.1/test/test_storage.py` & `ops-2.2.0/test/test_storage.py`

 * *Files 12% similar despite different names*

```diff
@@ -20,32 +20,32 @@
 import sys
 import tempfile
 from test.test_helpers import BaseTestCase, fake_script, fake_script_calls
 from textwrap import dedent
 
 import yaml
 
-from ops import framework, storage
+import ops
 
 
 class StoragePermutations(abc.ABC):
 
-    def create_framework(self) -> framework.Framework:
+    def create_framework(self) -> ops.Framework:
         """Create a Framework that we can use to test the backend storage."""
-        return framework.Framework(self.create_storage(), None, None, None)
+        return ops.Framework(self.create_storage(), None, None, None)
 
     @abc.abstractmethod
-    def create_storage(self) -> storage.SQLiteStorage:
+    def create_storage(self) -> ops.storage.SQLiteStorage:
         """Create a Storage backend that we can interact with."""
         return NotImplemented
 
     def test_save_and_load_snapshot(self):
         f = self.create_framework()
 
-        class Sample(framework.Object):
+        class Sample(ops.Object):
 
             def __init__(self, parent, key, content):
                 super().__init__(parent, key)
                 self.content = content
 
             def snapshot(self):
                 return {'content': self.content}
@@ -70,29 +70,29 @@
         gc.collect()
         res = f.load_snapshot(handle)
         self.assertEqual(data, res.content)
 
     def test_emit_event(self):
         f = self.create_framework()
 
-        class Evt(framework.EventBase):
+        class Evt(ops.EventBase):
             def __init__(self, handle, content):
                 super().__init__(handle)
                 self.content = content
 
             def snapshot(self):
                 return self.content
 
             def restore(self, content):
                 self.content = content
 
-        class Events(framework.ObjectEvents):
-            event = framework.EventSource(Evt)
+        class Events(ops.ObjectEvents):
+            event = ops.EventSource(Evt)
 
-        class Sample(framework.Object):
+        class Sample(ops.Object):
 
             on = Events()
 
             def __init__(self, parent, key):
                 super().__init__(parent, key)
                 self.observed_content = None
                 self.framework.observe(self.on.event, self._on_event)
@@ -117,45 +117,45 @@
         self.assertEqual({'three': 4}, store.load_snapshot('foo'))
 
     def test_drop_snapshot(self):
         store = self.create_storage()
         store.save_snapshot('foo', {1: 2})
         self.assertEqual({1: 2}, store.load_snapshot('foo'))
         store.drop_snapshot('foo')
-        with self.assertRaises(storage.NoSnapshotError):
+        with self.assertRaises(ops.storage.NoSnapshotError):
             store.load_snapshot('foo')
 
     def test_save_snapshot_empty_string(self):
         store = self.create_storage()
-        with self.assertRaises(storage.NoSnapshotError):
+        with self.assertRaises(ops.storage.NoSnapshotError):
             store.load_snapshot('foo')
         store.save_snapshot('foo', '')
         self.assertEqual('', store.load_snapshot('foo'))
         store.drop_snapshot('foo')
-        with self.assertRaises(storage.NoSnapshotError):
+        with self.assertRaises(ops.storage.NoSnapshotError):
             store.load_snapshot('foo')
 
     def test_save_snapshot_none(self):
         store = self.create_storage()
-        with self.assertRaises(storage.NoSnapshotError):
+        with self.assertRaises(ops.storage.NoSnapshotError):
             store.load_snapshot('bar')
         store.save_snapshot('bar', None)
         self.assertEqual(None, store.load_snapshot('bar'))
         store.drop_snapshot('bar')
-        with self.assertRaises(storage.NoSnapshotError):
+        with self.assertRaises(ops.storage.NoSnapshotError):
             store.load_snapshot('bar')
 
     def test_save_snapshot_zero(self):
         store = self.create_storage()
-        with self.assertRaises(storage.NoSnapshotError):
+        with self.assertRaises(ops.storage.NoSnapshotError):
             store.load_snapshot('zero')
         store.save_snapshot('zero', 0)
         self.assertEqual(0, store.load_snapshot('zero'))
         store.drop_snapshot('zero')
-        with self.assertRaises(storage.NoSnapshotError):
+        with self.assertRaises(ops.storage.NoSnapshotError):
             store.load_snapshot('zero')
 
     def test_save_notice(self):
         store = self.create_storage()
         store.save_notice('event', 'observer', 'method')
         self.assertEqual(
             list(store.notices('event')),
@@ -199,15 +199,15 @@
              ('event', 'observer', 'method2'),
              ])
 
 
 class TestSQLiteStorage(StoragePermutations, BaseTestCase):
 
     def create_storage(self):
-        return storage.SQLiteStorage(':memory:')
+        return ops.storage.SQLiteStorage(':memory:')
 
 
 def setup_juju_backend(test_case, state_file):
     """Create fake scripts for pretending to be state-set and state-get."""
     template_args = {
         'executable': str(pathlib.Path(sys.executable).as_posix()),
         'pthpth': repr(os.path.dirname(pathlib.__file__))[1:-1],
@@ -277,46 +277,46 @@
 
     def create_storage(self):
         fd, fn = tempfile.mkstemp(prefix='tmp-ops-test-state-')
         os.close(fd)
         state_file = pathlib.Path(fn)
         self.addCleanup(state_file.unlink)
         setup_juju_backend(self, state_file)
-        return storage.JujuStorage()
+        return ops.storage.JujuStorage()
 
 
 class TestSimpleLoader(BaseTestCase):
 
     def test_is_c_loader(self):
-        loader = storage._SimpleLoader(io.StringIO(''))
+        loader = ops.storage._SimpleLoader(io.StringIO(''))
         if getattr(yaml, 'CSafeLoader', None) is not None:
             self.assertIsInstance(loader, yaml.CSafeLoader)
         else:
             self.assertIsInstance(loader, yaml.SafeLoader)
 
     def test_is_c_dumper(self):
-        dumper = storage._SimpleDumper(io.StringIO(''))
+        dumper = ops.storage._SimpleDumper(io.StringIO(''))
         if getattr(yaml, 'CSafeDumper', None) is not None:
             self.assertIsInstance(dumper, yaml.CSafeDumper)
         else:
             self.assertIsInstance(dumper, yaml.SafeDumper)
 
     def test_handles_tuples(self):
-        raw = yaml.dump((1, 'tuple'), Dumper=storage._SimpleDumper)
-        parsed = yaml.load(raw, Loader=storage._SimpleLoader)
+        raw = yaml.dump((1, 'tuple'), Dumper=ops.storage._SimpleDumper)
+        parsed = yaml.load(raw, Loader=ops.storage._SimpleLoader)
         self.assertEqual(parsed, (1, 'tuple'))
 
     def assertRefused(self, obj):  # noqa: N802
         # We shouldn't allow them to be written
         with self.assertRaises(yaml.representer.RepresenterError):
-            yaml.dump(obj, Dumper=storage._SimpleDumper)
+            yaml.dump(obj, Dumper=ops.storage._SimpleDumper)
         # If they did somehow end up written, we shouldn't be able to load them
         raw = yaml.dump(obj, Dumper=yaml.Dumper)
         with self.assertRaises(yaml.constructor.ConstructorError):
-            yaml.load(raw, Loader=storage._SimpleLoader)
+            yaml.load(raw, Loader=ops.storage._SimpleLoader)
 
     def test_forbids_some_types(self):
         self.assertRefused(1 + 2j)
         self.assertRefused({'foo': 1 + 2j})
         self.assertRefused(frozenset(['foo', 'bar']))
         self.assertRefused(bytearray(b'foo'))
         self.assertRefused(object())
@@ -326,28 +326,28 @@
         f = Foo()
         self.assertRefused(f)
 
 
 class TestJujuStateBackend(BaseTestCase):
 
     def test_is_not_available(self):
-        self.assertFalse(storage.juju_backend_available())
+        self.assertFalse(ops.storage.juju_backend_available())
 
     def test_is_available(self):
         fake_script(self, 'state-get', 'echo ""')
-        self.assertTrue(storage.juju_backend_available())
+        self.assertTrue(ops.storage.juju_backend_available())
         self.assertEqual(fake_script_calls(self, clear=True), [])
 
     def test_set_encodes_args(self):
         t = tempfile.NamedTemporaryFile()
         try:
             fake_script(self, 'state-set', dedent("""
                 cat >> {}
                 """).format(pathlib.Path(t.name).as_posix()))
-            backend = storage._JujuStorageBackend()
+            backend = ops.storage._JujuStorageBackend()
             backend.set('key', {'foo': 2})
             self.assertEqual(fake_script_calls(self, clear=True), [
                 ['state-set', '--file', '-'],
             ])
             t.seek(0)
             content = t.read()
         finally:
@@ -357,28 +357,28 @@
               {foo: 2}
             """))
 
     def test_get(self):
         fake_script(self, 'state-get', dedent("""
             echo 'foo: "bar"'
             """))
-        backend = storage._JujuStorageBackend()
+        backend = ops.storage._JujuStorageBackend()
         value = backend.get('key')
         self.assertEqual(value, {'foo': 'bar'})
         self.assertEqual(fake_script_calls(self, clear=True), [
             ['state-get', 'key'],
         ])
 
     def test_set_and_get_complex_value(self):
         t = tempfile.NamedTemporaryFile()
         try:
             fake_script(self, 'state-set', dedent("""
                 cat >> {}
                 """).format(pathlib.Path(t.name).as_posix()))
-            backend = storage._JujuStorageBackend()
+            backend = ops.storage._JujuStorageBackend()
             complex_val = {
                 'foo': 2,
                 3: [1, 2, '3'],
                 'four': {2, 3},
                 'five': {'a': 2, 'b': 3.0},
                 'six': ('a', 'b'),
                 'seven': b'1234',
@@ -390,15 +390,15 @@
             t.seek(0)
             content = t.read()
         finally:
             t.close()
         outer = yaml.safe_load(content)
         key = 'Class[foo]/_stored'
         self.assertEqual(list(outer.keys()), [key])
-        inner = yaml.load(outer[key], Loader=storage._SimpleLoader)
+        inner = yaml.load(outer[key], Loader=ops.storage._SimpleLoader)
         self.assertEqual(complex_val, inner)
         self.assertEqual(content.decode('utf-8'), dedent("""\
             "Class[foo]/_stored": |
               foo: 2
               3: [1, 2, '3']
               four: !!set {2: null, 3: null}
               five: {a: 2, b: 3.0}
```

### Comparing `ops-2.1.1/test/test_testing.py` & `ops-2.2.0/test/test_testing.py`

 * *Files 6% similar despite different names*

```diff
@@ -35,11382 +35,11926 @@
 00000220: 640a 2320 6c69 6d69 7461 7469 6f6e 7320  d.# limitations 
 00000230: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
 00000240: 652e 0a0a 696d 706f 7274 2063 6f6c 6c65  e...import colle
 00000250: 6374 696f 6e73 0a69 6d70 6f72 7420 6461  ctions.import da
 00000260: 7465 7469 6d65 0a69 6d70 6f72 7420 696d  tetime.import im
 00000270: 706f 7274 6c69 620a 696d 706f 7274 2069  portlib.import i
 00000280: 6e73 7065 6374 0a69 6d70 6f72 7420 696f  nspect.import io
-00000290: 0a69 6d70 6f72 7420 6f73 0a69 6d70 6f72  .import os.impor
-000002a0: 7420 7061 7468 6c69 620a 696d 706f 7274  t pathlib.import
-000002b0: 2070 6c61 7466 6f72 6d0a 696d 706f 7274   platform.import
-000002c0: 2073 6875 7469 6c0a 696d 706f 7274 2073   shutil.import s
-000002d0: 7973 0a69 6d70 6f72 7420 7465 6d70 6669  ys.import tempfi
-000002e0: 6c65 0a69 6d70 6f72 7420 7465 7874 7772  le.import textwr
-000002f0: 6170 0a69 6d70 6f72 7420 756e 6974 7465  ap.import unitte
-00000300: 7374 0a69 6d70 6f72 7420 7575 6964 0a66  st.import uuid.f
-00000310: 726f 6d20 696f 2069 6d70 6f72 7420 4279  rom io import By
-00000320: 7465 7349 4f2c 2053 7472 696e 6749 4f0a  tesIO, StringIO.
-00000330: 6672 6f6d 2075 6e69 7474 6573 742e 6d6f  from unittest.mo
-00000340: 636b 2069 6d70 6f72 7420 4d61 6769 634d  ck import MagicM
-00000350: 6f63 6b0a 0a69 6d70 6f72 7420 7079 7465  ock..import pyte
-00000360: 7374 0a69 6d70 6f72 7420 7961 6d6c 0a0a  st.import yaml..
-00000370: 696d 706f 7274 206f 7073 2e74 6573 7469  import ops.testi
-00000380: 6e67 0a66 726f 6d20 6f70 7320 696d 706f  ng.from ops impo
-00000390: 7274 206d 6f64 656c 2c20 7065 6262 6c65  rt model, pebble
-000003a0: 0a66 726f 6d20 6f70 732e 6368 6172 6d20  .from ops.charm 
-000003b0: 696d 706f 7274 2028 0a20 2020 2043 6861  import (.    Cha
-000003c0: 726d 4261 7365 2c0a 2020 2020 5065 6262  rmBase,.    Pebb
-000003d0: 6c65 5265 6164 7945 7665 6e74 2c0a 2020  leReadyEvent,.  
-000003e0: 2020 5265 6c61 7469 6f6e 4465 7061 7274    RelationDepart
-000003f0: 6564 4576 656e 742c 0a20 2020 2052 656c  edEvent,.    Rel
-00000400: 6174 696f 6e45 7665 6e74 2c0a 2020 2020  ationEvent,.    
-00000410: 5374 6f72 6167 6541 7474 6163 6865 6445  StorageAttachedE
-00000420: 7665 6e74 2c0a 2020 2020 5374 6f72 6167  vent,.    Storag
-00000430: 6544 6574 6163 6869 6e67 4576 656e 742c  eDetachingEvent,
-00000440: 0a29 0a66 726f 6d20 6f70 732e 6672 616d  .).from ops.fram
-00000450: 6577 6f72 6b20 696d 706f 7274 2046 7261  ework import Fra
-00000460: 6d65 776f 726b 2c20 4f62 6a65 6374 0a66  mework, Object.f
-00000470: 726f 6d20 6f70 732e 6d6f 6465 6c20 696d  rom ops.model im
-00000480: 706f 7274 2028 0a20 2020 2041 6374 6976  port (.    Activ
-00000490: 6553 7461 7475 732c 0a20 2020 2041 7070  eStatus,.    App
-000004a0: 6c69 6361 7469 6f6e 2c0a 2020 2020 4d61  lication,.    Ma
-000004b0: 696e 7465 6e61 6e63 6553 7461 7475 732c  intenanceStatus,
-000004c0: 0a20 2020 204d 6f64 656c 4572 726f 722c  .    ModelError,
-000004d0: 0a20 2020 2052 656c 6174 696f 6e4e 6f74  .    RelationNot
-000004e0: 466f 756e 6445 7272 6f72 2c0a 2020 2020  FoundError,.    
-000004f0: 556e 6974 2c0a 2020 2020 556e 6b6e 6f77  Unit,.    Unknow
-00000500: 6e53 7461 7475 732c 0a20 2020 205f 4d6f  nStatus,.    _Mo
-00000510: 6465 6c42 6163 6b65 6e64 2c0a 290a 6672  delBackend,.).fr
-00000520: 6f6d 206f 7073 2e74 6573 7469 6e67 2069  om ops.testing i
-00000530: 6d70 6f72 7420 280a 2020 2020 4861 726e  mport (.    Harn
-00000540: 6573 732c 0a20 2020 204e 6f6e 4162 736f  ess,.    NonAbso
-00000550: 6c75 7465 5061 7468 4572 726f 722c 0a20  lutePathError,. 
-00000560: 2020 205f 4469 7265 6374 6f72 792c 0a20     _Directory,. 
-00000570: 2020 205f 5465 7374 696e 6746 696c 6573     _TestingFiles
-00000580: 7973 7465 6d2c 0a20 2020 205f 5465 7374  ystem,.    _Test
-00000590: 696e 6750 6562 626c 6543 6c69 656e 742c  ingPebbleClient,
-000005a0: 0a20 2020 205f 5465 7374 696e 6753 746f  .    _TestingSto
-000005b0: 7261 6765 4d6f 756e 742c 0a29 0a0a 6973  rageMount,.)..is
-000005c0: 5f6c 696e 7578 203d 2070 6c61 7466 6f72  _linux = platfor
-000005d0: 6d2e 7379 7374 656d 2829 203d 3d20 274c  m.system() == 'L
-000005e0: 696e 7578 270a 0a0a 636c 6173 7320 5365  inux'...class Se
-000005f0: 744c 6561 6465 7245 7272 6f72 5465 7374  tLeaderErrorTest
-00000600: 6572 2843 6861 726d 4261 7365 293a 0a20  er(CharmBase):. 
-00000610: 2020 2022 2222 5365 7473 2070 6565 7220     """Sets peer 
-00000620: 7265 6c61 7469 6f6e 2064 6174 6120 696e  relation data in
-00000630: 7369 6465 206c 6561 6465 722d 656c 6563  side leader-elec
-00000640: 7465 642e 2222 220a 0a20 2020 2064 6566  ted."""..    def
-00000650: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00000660: 6672 616d 6577 6f72 6b29 3a0a 2020 2020  framework):.    
-00000670: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00000680: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
-00000690: 2020 2020 2020 2020 7365 6c66 2e5f 7065          self._pe
-000006a0: 6572 5f6e 616d 6520 3d20 2770 6565 7227  er_name = 'peer'
-000006b0: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
-000006c0: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
-000006d0: 7365 6c66 2e6f 6e2e 6c65 6164 6572 5f65  self.on.leader_e
-000006e0: 6c65 6374 6564 2c0a 2020 2020 2020 2020  lected,.        
-000006f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000700: 2020 2020 2020 2073 656c 662e 5f6f 6e5f         self._on_
-00000710: 6c65 6164 6572 5f65 6c65 6374 6564 290a  leader_elected).
-00000720: 0a20 2020 2064 6566 205f 6f6e 5f6c 6561  .    def _on_lea
-00000730: 6465 725f 656c 6563 7465 6428 7365 6c66  der_elected(self
-00000740: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
-00000750: 2020 7065 6572 7320 3d20 7365 6c66 2e6d    peers = self.m
-00000760: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
-00000770: 6e28 7365 6c66 2e5f 7065 6572 5f6e 616d  n(self._peer_nam
-00000780: 6529 0a20 2020 2020 2020 2070 6565 7273  e).        peers
-00000790: 2e64 6174 615b 7365 6c66 2e61 7070 5d5b  .data[self.app][
-000007a0: 2266 6f6f 225d 203d 2022 6261 7222 0a0a  "foo"] = "bar"..
-000007b0: 0a63 6c61 7373 2053 746f 7261 6765 5465  .class StorageTe
-000007c0: 7374 6572 2843 6861 726d 4261 7365 293a  ster(CharmBase):
-000007d0: 0a20 2020 2022 2222 5265 636f 7264 2074  .    """Record t
-000007e0: 6865 2072 656c 6174 696f 6e2d 6368 616e  he relation-chan
-000007f0: 6765 6420 6576 656e 7473 2e22 2222 0a0a  ged events."""..
-00000800: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00000810: 2873 656c 662c 2066 7261 6d65 776f 726b  (self, framework
-00000820: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
-00000830: 2829 2e5f 5f69 6e69 745f 5f28 6672 616d  ().__init__(fram
-00000840: 6577 6f72 6b29 0a20 2020 2020 2020 2073  ework).        s
-00000850: 656c 662e 6f62 7365 7276 6564 5f65 7665  elf.observed_eve
-00000860: 6e74 7320 3d20 5b5d 0a20 2020 2020 2020  nts = [].       
-00000870: 2073 656c 662e 6672 616d 6577 6f72 6b2e   self.framework.
-00000880: 6f62 7365 7276 6528 7365 6c66 2e6f 6e2e  observe(self.on.
-00000890: 7465 7374 5f73 746f 7261 6765 5f61 7474  test_storage_att
-000008a0: 6163 6865 642c 0a20 2020 2020 2020 2020  ached,.         
-000008b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000008c0: 2020 2020 2020 7365 6c66 2e5f 6f6e 5f74        self._on_t
-000008d0: 6573 745f 7374 6f72 6167 655f 6174 7461  est_storage_atta
-000008e0: 6368 6564 290a 2020 2020 2020 2020 7365  ched).        se
-000008f0: 6c66 2e66 7261 6d65 776f 726b 2e6f 6273  lf.framework.obs
-00000900: 6572 7665 2873 656c 662e 6f6e 2e74 6573  erve(self.on.tes
-00000910: 745f 7374 6f72 6167 655f 6465 7461 6368  t_storage_detach
-00000920: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-00000930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000940: 2020 2020 7365 6c66 2e5f 6f6e 5f74 6573      self._on_tes
-00000950: 745f 7374 6f72 6167 655f 6465 7461 6368  t_storage_detach
-00000960: 696e 6729 0a0a 2020 2020 6465 6620 5f6f  ing)..    def _o
-00000970: 6e5f 7465 7374 5f73 746f 7261 6765 5f61  n_test_storage_a
-00000980: 7474 6163 6865 6428 7365 6c66 2c20 6576  ttached(self, ev
-00000990: 656e 7429 3a0a 2020 2020 2020 2020 7365  ent):.        se
-000009a0: 6c66 2e6f 6273 6572 7665 645f 6576 656e  lf.observed_even
-000009b0: 7473 2e61 7070 656e 6428 6576 656e 7429  ts.append(event)
-000009c0: 0a0a 2020 2020 6465 6620 5f6f 6e5f 7465  ..    def _on_te
-000009d0: 7374 5f73 746f 7261 6765 5f64 6574 6163  st_storage_detac
-000009e0: 6869 6e67 2873 656c 662c 2065 7665 6e74  hing(self, event
-000009f0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00000a00: 6f62 7365 7276 6564 5f65 7665 6e74 732e  observed_events.
-00000a10: 6170 7065 6e64 2865 7665 6e74 290a 0a0a  append(event)...
-00000a20: 636c 6173 7320 5374 6f72 6167 6557 6974  class StorageWit
-00000a30: 6848 7970 6865 6e73 4865 6c70 6572 284f  hHyphensHelper(O
-00000a40: 626a 6563 7429 3a0a 2020 2020 6465 6620  bject):.    def 
-00000a50: 5f5f 696e 6974 5f5f 2873 656c 662c 2070  __init__(self, p
-00000a60: 6172 656e 742c 206b 6579 293a 0a20 2020  arent, key):.   
-00000a70: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
-00000a80: 6e69 745f 5f28 7061 7265 6e74 2c20 6b65  nit__(parent, ke
-00000a90: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
-00000aa0: 6368 616e 6765 7320 3d20 5b5d 0a20 2020  changes = [].   
-00000ab0: 2020 2020 2070 6172 656e 742e 6672 616d       parent.fram
-00000ac0: 6577 6f72 6b2e 6f62 7365 7276 6528 7061  ework.observe(pa
-00000ad0: 7265 6e74 2e6f 6e2e 7465 7374 5f77 6974  rent.on.test_wit
-00000ae0: 685f 6879 7068 656e 735f 7374 6f72 6167  h_hyphens_storag
-00000af0: 655f 6174 7461 6368 6564 2c0a 2020 2020  e_attached,.    
-00000b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000b10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00000b20: 662e 6f6e 5f73 746f 7261 6765 5f63 6861  f.on_storage_cha
-00000b30: 6e67 6564 290a 2020 2020 2020 2020 7061  nged).        pa
-00000b40: 7265 6e74 2e66 7261 6d65 776f 726b 2e6f  rent.framework.o
-00000b50: 6273 6572 7665 2870 6172 656e 742e 6f6e  bserve(parent.on
-00000b60: 2e74 6573 745f 7769 7468 5f68 7970 6865  .test_with_hyphe
-00000b70: 6e73 5f73 746f 7261 6765 5f64 6574 6163  ns_storage_detac
-00000b80: 6869 6e67 2c0a 2020 2020 2020 2020 2020  hing,.          
-00000b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000ba0: 2020 2020 2020 2073 656c 662e 6f6e 5f73         self.on_s
-00000bb0: 746f 7261 6765 5f63 6861 6e67 6564 290a  torage_changed).
-00000bc0: 0a20 2020 2064 6566 206f 6e5f 7374 6f72  .    def on_stor
-00000bd0: 6167 655f 6368 616e 6765 6428 7365 6c66  age_changed(self
-00000be0: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
-00000bf0: 2020 7365 6c66 2e63 6861 6e67 6573 2e61    self.changes.a
-00000c00: 7070 656e 6428 6576 656e 7429 0a0a 0a63  ppend(event)...c
-00000c10: 6c61 7373 2054 6573 7448 6172 6e65 7373  lass TestHarness
-00000c20: 2875 6e69 7474 6573 742e 5465 7374 4361  (unittest.TestCa
-00000c30: 7365 293a 0a0a 2020 2020 6465 6620 7465  se):..    def te
-00000c40: 7374 5f61 6464 5f72 656c 6174 696f 6e28  st_add_relation(
-00000c50: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-00000c60: 6172 6e65 7373 203d 2048 6172 6e65 7373  arness = Harness
-00000c70: 2843 6861 726d 4261 7365 2c20 6d65 7461  (CharmBase, meta
-00000c80: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00000c90: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
-00000ca0: 2020 2020 2020 2020 2020 2020 7265 7175              requ
-00000cb0: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
-00000cc0: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
-00000cd0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00000ce0: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
-00000cf0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-00000d00: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00000d10: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-00000d20: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-00000d30: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
-00000d40: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-00000d50: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
-00000d60: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00000d70: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
-00000d80: 2872 656c 5f69 642c 2069 6e74 290a 2020  (rel_id, int).  
-00000d90: 2020 2020 2020 6261 636b 656e 6420 3d20        backend = 
-00000da0: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
-00000db0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00000dc0: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
-00000dd0: 642e 7265 6c61 7469 6f6e 5f69 6473 2827  d.relation_ids('
-00000de0: 6462 2729 2c20 5b72 656c 5f69 645d 290a  db'), [rel_id]).
-00000df0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00000e00: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
-00000e10: 2e72 656c 6174 696f 6e5f 6c69 7374 2872  .relation_list(r
-00000e20: 656c 5f69 6429 2c20 5b5d 290a 2020 2020  el_id), []).    
-00000e30: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-00000e40: 7468 6520 696e 6974 6961 6c20 6461 7461  the initial data
-00000e50: 2062 6167 7320 666f 7220 6f75 7220 6170   bags for our ap
-00000e60: 7020 616e 6420 756e 6974 2061 7265 2065  p and unit are e
-00000e70: 6d70 7479 2e0a 2020 2020 2020 2020 7365  mpty..        se
-00000e80: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-00000e90: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-00000ea0: 6765 7428 7265 6c5f 6964 2c20 2774 6573  get(rel_id, 'tes
-00000eb0: 742d 6170 7027 2c20 6973 5f61 7070 3d54  t-app', is_app=T
-00000ec0: 7275 6529 2c20 7b7d 290a 2020 2020 2020  rue), {}).      
-00000ed0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00000ee0: 616c 2862 6163 6b65 6e64 2e72 656c 6174  al(backend.relat
-00000ef0: 696f 6e5f 6765 7428 7265 6c5f 6964 2c20  ion_get(rel_id, 
-00000f00: 2774 6573 742d 6170 702f 3027 2c20 6973  'test-app/0', is
-00000f10: 5f61 7070 3d46 616c 7365 292c 207b 7d29  _app=False), {})
-00000f20: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-00000f30: 616e 5f63 6f6e 6e65 6374 5f64 6566 6175  an_connect_defau
-00000f40: 6c74 2873 656c 6629 3a0a 2020 2020 2020  lt(self):.      
-00000f50: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-00000f60: 6573 7328 4368 6172 6d42 6173 652c 206d  ess(CharmBase, m
-00000f70: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-00000f80: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-00000f90: 7070 0a20 2020 2020 2020 2020 2020 2063  pp.            c
-00000fa0: 6f6e 7461 696e 6572 733a 0a20 2020 2020  ontainers:.     
-00000fb0: 2020 2020 2020 2020 2066 6f6f 3a0a 2020           foo:.  
-00000fc0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00000fd0: 736f 7572 6365 3a20 666f 6f2d 696d 6167  source: foo-imag
-00000fe0: 650a 2020 2020 2020 2020 2020 2020 2727  e.            ''
-00000ff0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00001000: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00001010: 7373 2e63 6c65 616e 7570 290a 0a20 2020  ss.cleanup)..   
-00001020: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
-00001030: 696e 2829 0a20 2020 2020 2020 2063 203d  in().        c =
-00001040: 2068 6172 6e65 7373 2e6d 6f64 656c 2e75   harness.model.u
-00001050: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
-00001060: 7228 2766 6f6f 2729 0a0a 2020 2020 2020  r('foo')..      
-00001070: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-00001080: 7365 2863 2e63 616e 5f63 6f6e 6e65 6374  se(c.can_connect
-00001090: 2829 290a 2020 2020 2020 2020 7769 7468  ()).        with
-000010a0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-000010b0: 6573 2870 6562 626c 652e 436f 6e6e 6563  es(pebble.Connec
-000010c0: 7469 6f6e 4572 726f 7229 3a0a 2020 2020  tionError):.    
-000010d0: 2020 2020 2020 2020 632e 6765 745f 706c          c.get_pl
-000010e0: 616e 2829 0a0a 2020 2020 2020 2020 6861  an()..        ha
-000010f0: 726e 6573 732e 7365 745f 6361 6e5f 636f  rness.set_can_co
-00001100: 6e6e 6563 7428 2766 6f6f 272c 2054 7275  nnect('foo', Tru
-00001110: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00001120: 6173 7365 7274 5472 7565 2863 2e63 616e  assertTrue(c.can
-00001130: 5f63 6f6e 6e65 6374 2829 290a 0a20 2020  _connect())..   
-00001140: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-00001150: 5f63 616e 5f63 6f6e 6e65 6374 2827 666f  _can_connect('fo
-00001160: 6f27 2c20 4661 6c73 6529 0a20 2020 2020  o', False).     
-00001170: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
-00001180: 6c73 6528 632e 6361 6e5f 636f 6e6e 6563  lse(c.can_connec
-00001190: 7428 2929 0a0a 2020 2020 2020 2020 6861  t())..        ha
-000011a0: 726e 6573 732e 636f 6e74 6169 6e65 725f  rness.container_
-000011b0: 7065 6262 6c65 5f72 6561 6479 2827 666f  pebble_ready('fo
-000011c0: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
-000011d0: 2e61 7373 6572 7454 7275 6528 632e 6361  .assertTrue(c.ca
-000011e0: 6e5f 636f 6e6e 6563 7428 2929 0a20 2020  n_connect()).   
-000011f0: 2020 2020 2063 2e67 6574 5f70 6c61 6e28       c.get_plan(
-00001200: 2920 2023 2073 686f 756c 646e 2774 2072  )  # shouldn't r
-00001210: 6169 7365 2043 6f6e 6e65 6374 696f 6e45  aise ConnectionE
-00001220: 7272 6f72 0a0a 2020 2020 6465 6620 7465  rror..    def te
-00001230: 7374 5f63 616e 5f63 6f6e 6e65 6374 5f62  st_can_connect_b
-00001240: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
-00001250: 6c5f 686f 6f6b 7328 7365 6c66 293a 0a20  l_hooks(self):. 
-00001260: 2020 2020 2020 2070 6562 626c 655f 7265         pebble_re
-00001270: 6164 795f 6361 6c6c 7320 3d20 636f 6c6c  ady_calls = coll
-00001280: 6563 7469 6f6e 732e 6465 6661 756c 7464  ections.defaultd
-00001290: 6963 7428 696e 7429 0a0a 2020 2020 2020  ict(int)..      
-000012a0: 2020 636c 6173 7320 4d79 4368 6172 6d28    class MyCharm(
-000012b0: 4368 6172 6d42 6173 6529 3a0a 2020 2020  CharmBase):.    
-000012c0: 2020 2020 2020 2020 6465 6620 5f5f 696e          def __in
-000012d0: 6974 5f5f 2873 656c 662c 202a 6172 6773  it__(self, *args
-000012e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000012f0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-00001300: 745f 5f28 2a61 7267 7329 0a20 2020 2020  t__(*args).     
-00001310: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00001320: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
-00001330: 6528 7365 6c66 2e6f 6e2e 666f 6f5f 7065  e(self.on.foo_pe
-00001340: 6262 6c65 5f72 6561 6479 2c20 7365 6c66  bble_ready, self
-00001350: 2e5f 6f6e 5f70 6562 626c 655f 7265 6164  ._on_pebble_read
-00001360: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
-00001370: 2020 2073 656c 662e 6672 616d 6577 6f72     self.framewor
-00001380: 6b2e 6f62 7365 7276 6528 7365 6c66 2e6f  k.observe(self.o
-00001390: 6e2e 6261 725f 7065 6262 6c65 5f72 6561  n.bar_pebble_rea
-000013a0: 6479 2c20 7365 6c66 2e5f 6f6e 5f70 6562  dy, self._on_peb
-000013b0: 626c 655f 7265 6164 7929 0a0a 2020 2020  ble_ready)..    
-000013c0: 2020 2020 2020 2020 6465 6620 5f6f 6e5f          def _on_
-000013d0: 7065 6262 6c65 5f72 6561 6479 2873 656c  pebble_ready(sel
-000013e0: 662c 2065 7665 6e74 3a20 5065 6262 6c65  f, event: Pebble
-000013f0: 5265 6164 7945 7665 6e74 293a 0a20 2020  ReadyEvent):.   
-00001400: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00001410: 6572 7420 6576 656e 742e 776f 726b 6c6f  ert event.worklo
-00001420: 6164 2e63 616e 5f63 6f6e 6e65 6374 2829  ad.can_connect()
-00001430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001440: 2070 6562 626c 655f 7265 6164 795f 6361   pebble_ready_ca
-00001450: 6c6c 735b 6576 656e 742e 776f 726b 6c6f  lls[event.worklo
-00001460: 6164 2e6e 616d 655d 202b 3d20 310a 0a20  ad.name] += 1.. 
-00001470: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-00001480: 2048 6172 6e65 7373 284d 7943 6861 726d   Harness(MyCharm
-00001490: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-000014a0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-000014b0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-000014c0: 2020 636f 6e74 6169 6e65 7273 3a0a 2020    containers:.  
-000014d0: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
-000014e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000014f0: 2072 6573 6f75 7263 653a 2066 6f6f 2d69   resource: foo-i
-00001500: 6d61 6765 0a20 2020 2020 2020 2020 2020  mage.           
-00001510: 2020 2062 6172 3a0a 2020 2020 2020 2020     bar:.        
-00001520: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-00001530: 3a20 6261 722d 696d 6167 650a 2020 2020  : bar-image.    
-00001540: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00001550: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00001560: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00001570: 616e 7570 290a 0a20 2020 2020 2020 2068  anup)..        h
-00001580: 6172 6e65 7373 2e62 6567 696e 5f77 6974  arness.begin_wit
-00001590: 685f 696e 6974 6961 6c5f 686f 6f6b 7328  h_initial_hooks(
-000015a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000015b0: 7373 6572 7445 7175 616c 2864 6963 7428  ssertEqual(dict(
-000015c0: 7065 6262 6c65 5f72 6561 6479 5f63 616c  pebble_ready_cal
-000015d0: 6c73 292c 207b 2766 6f6f 273a 2031 2c20  ls), {'foo': 1, 
-000015e0: 2762 6172 273a 2031 7d29 0a20 2020 2020  'bar': 1}).     
-000015f0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00001600: 7565 2868 6172 6e65 7373 2e6d 6f64 656c  ue(harness.model
-00001610: 2e75 6e69 742e 636f 6e74 6169 6e65 7273  .unit.containers
-00001620: 5b27 666f 6f27 5d2e 6361 6e5f 636f 6e6e  ['foo'].can_conn
-00001630: 6563 7428 2929 0a20 2020 2020 2020 2073  ect()).        s
-00001640: 656c 662e 6173 7365 7274 5472 7565 2868  elf.assertTrue(h
-00001650: 6172 6e65 7373 2e6d 6f64 656c 2e75 6e69  arness.model.uni
-00001660: 742e 636f 6e74 6169 6e65 7273 5b27 6261  t.containers['ba
-00001670: 7227 5d2e 6361 6e5f 636f 6e6e 6563 7428  r'].can_connect(
-00001680: 2929 0a0a 2020 2020 2020 2020 6861 726e  ))..        harn
-00001690: 6573 732e 7365 745f 6361 6e5f 636f 6e6e  ess.set_can_conn
-000016a0: 6563 7428 2766 6f6f 272c 2046 616c 7365  ect('foo', False
-000016b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000016c0: 7373 6572 7446 616c 7365 2868 6172 6e65  ssertFalse(harne
-000016d0: 7373 2e6d 6f64 656c 2e75 6e69 742e 636f  ss.model.unit.co
-000016e0: 6e74 6169 6e65 7273 5b27 666f 6f27 5d2e  ntainers['foo'].
-000016f0: 6361 6e5f 636f 6e6e 6563 7428 2929 0a0a  can_connect())..
-00001700: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00001710: 7365 745f 6361 6e5f 636f 6e6e 6563 7428  set_can_connect(
-00001720: 2766 6f6f 272c 2054 7275 6529 0a20 2020  'foo', True).   
-00001730: 2020 2020 2063 6f6e 7461 696e 6572 203d       container =
-00001740: 2068 6172 6e65 7373 2e6d 6f64 656c 2e75   harness.model.u
-00001750: 6e69 742e 636f 6e74 6169 6e65 7273 5b27  nit.containers['
-00001760: 666f 6f27 5d0a 2020 2020 2020 2020 7365  foo'].        se
-00001770: 6c66 2e61 7373 6572 7454 7275 6528 636f  lf.assertTrue(co
-00001780: 6e74 6169 6e65 722e 6361 6e5f 636f 6e6e  ntainer.can_conn
-00001790: 6563 7428 2929 0a20 2020 2020 2020 2063  ect()).        c
-000017a0: 6f6e 7461 696e 6572 2e67 6574 5f70 6c61  ontainer.get_pla
-000017b0: 6e28 2920 2023 2073 686f 756c 646e 2774  n()  # shouldn't
-000017c0: 2072 6169 7365 2043 6f6e 6e65 6374 696f   raise Connectio
-000017d0: 6e45 7272 6f72 0a0a 2020 2020 6465 6620  nError..    def 
-000017e0: 7465 7374 5f61 6464 5f72 656c 6174 696f  test_add_relatio
-000017f0: 6e5f 616e 645f 756e 6974 2873 656c 6629  n_and_unit(self)
-00001800: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-00001810: 7320 3d20 4861 726e 6573 7328 4368 6172  s = Harness(Char
-00001820: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-00001830: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00001840: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-00001850: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00001860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001870: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-00001880: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-00001890: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-000018a0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-000018b0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-000018c0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-000018d0: 7570 290a 2020 2020 2020 2020 7265 6c5f  up).        rel_
-000018e0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-000018f0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-00001900: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
-00001910: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00001920: 7449 7349 6e73 7461 6e63 6528 7265 6c5f  tIsInstance(rel_
-00001930: 6964 2c20 696e 7429 0a20 2020 2020 2020  id, int).       
-00001940: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00001950: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
-00001960: 642c 2027 706f 7374 6772 6573 716c 2f30  d, 'postgresql/0
-00001970: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-00001980: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
-00001990: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
-000019a0: 2770 6f73 7467 7265 7371 6c2f 3027 2c20  'postgresql/0', 
-000019b0: 7b27 666f 6f27 3a20 2762 6172 277d 290a  {'foo': 'bar'}).
-000019c0: 2020 2020 2020 2020 6261 636b 656e 6420          backend 
-000019d0: 3d20 6861 726e 6573 732e 5f62 6163 6b65  = harness._backe
-000019e0: 6e64 0a20 2020 2020 2020 2073 656c 662e  nd.        self.
-000019f0: 6173 7365 7274 4571 7561 6c28 6261 636b  assertEqual(back
-00001a00: 656e 642e 7265 6c61 7469 6f6e 5f69 6473  end.relation_ids
-00001a10: 2827 6462 2729 2c20 5b72 656c 5f69 645d  ('db'), [rel_id]
-00001a20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00001a30: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
-00001a40: 6e64 2e72 656c 6174 696f 6e5f 6c69 7374  nd.relation_list
-00001a50: 2872 656c 5f69 6429 2c20 5b27 706f 7374  (rel_id), ['post
-00001a60: 6772 6573 716c 2f30 275d 290a 2020 2020  gresql/0']).    
-00001a70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00001a80: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00001a90: 2020 6261 636b 656e 642e 7265 6c61 7469    backend.relati
-00001aa0: 6f6e 5f67 6574 2872 656c 5f69 642c 2027  on_get(rel_id, '
-00001ab0: 706f 7374 6772 6573 716c 2f30 272c 2069  postgresql/0', i
-00001ac0: 735f 6170 703d 4661 6c73 6529 2c0a 2020  s_app=False),.  
-00001ad0: 2020 2020 2020 2020 2020 7b27 666f 6f27            {'foo'
-00001ae0: 3a20 2762 6172 277d 290a 0a20 2020 2064  : 'bar'})..    d
-00001af0: 6566 2074 6573 745f 6164 645f 7265 6c61  ef test_add_rela
-00001b00: 7469 6f6e 5f77 6974 685f 7265 6d6f 7465  tion_with_remote
-00001b10: 5f61 7070 5f64 6174 6128 7365 6c66 293a  _app_data(self):
-00001b20: 0a20 2020 2020 2020 2023 206c 616e 6775  .        # langu
-00001b30: 6167 653d 5941 4d4c 0a20 2020 2020 2020  age=YAML.       
-00001b40: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-00001b50: 7373 2843 6861 726d 4261 7365 2c20 6d65  ss(CharmBase, me
-00001b60: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00001b70: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00001b80: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00001b90: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00001ba0: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-00001bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001bc0: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00001bd0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00001be0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00001bf0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00001c00: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00001c10: 2020 2072 656d 6f74 655f 6170 7020 3d20     remote_app = 
-00001c20: 2770 6f73 7467 7265 7371 6c27 0a20 2020  'postgresql'.   
-00001c30: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
-00001c40: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00001c50: 6f6e 2827 6462 272c 2072 656d 6f74 655f  on('db', remote_
-00001c60: 6170 7029 0a20 2020 2020 2020 2068 6172  app).        har
-00001c70: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-00001c80: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-00001c90: 2c20 2770 6f73 7467 7265 7371 6c27 2c20  , 'postgresql', 
-00001ca0: 7b27 6170 7027 3a20 2764 6174 6127 7d29  {'app': 'data'})
-00001cb0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00001cc0: 7365 7274 4973 496e 7374 616e 6365 2872  sertIsInstance(r
-00001cd0: 656c 5f69 642c 2069 6e74 290a 2020 2020  el_id, int).    
-00001ce0: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
-00001cf0: 726e 6573 732e 5f62 6163 6b65 6e64 0a20  rness._backend. 
-00001d00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00001d10: 7274 4571 7561 6c28 5b72 656c 5f69 645d  rtEqual([rel_id]
-00001d20: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
-00001d30: 6f6e 5f69 6473 2827 6462 2729 290a 2020  on_ids('db')).  
-00001d40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00001d50: 7445 7175 616c 287b 2761 7070 273a 2027  tEqual({'app': '
-00001d60: 6461 7461 277d 2c20 6261 636b 656e 642e  data'}, backend.
-00001d70: 7265 6c61 7469 6f6e 5f67 6574 2872 656c  relation_get(rel
-00001d80: 5f69 642c 2072 656d 6f74 655f 6170 702c  _id, remote_app,
-00001d90: 2069 735f 6170 703d 5472 7565 2929 0a0a   is_app=True))..
-00001da0: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
-00001db0: 5f72 656c 6174 696f 6e5f 7769 7468 5f6f  _relation_with_o
-00001dc0: 7572 5f69 6e69 7469 616c 5f64 6174 6128  ur_initial_data(
-00001dd0: 7365 6c66 293a 0a0a 2020 2020 2020 2020  self):..        
-00001de0: 636c 6173 7320 496e 6974 6961 6c44 6174  class InitialDat
-00001df0: 6154 6573 7465 7228 4368 6172 6d42 6173  aTester(CharmBas
-00001e00: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00001e10: 2222 2252 6563 6f72 6420 7468 6520 7265  """Record the re
-00001e20: 6c61 7469 6f6e 2d63 6861 6e67 6564 2065  lation-changed e
-00001e30: 7665 6e74 732e 2222 220a 0a20 2020 2020  vents."""..     
-00001e40: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
-00001e50: 745f 5f28 7365 6c66 2c20 6672 616d 6577  t__(self, framew
-00001e60: 6f72 6b29 3a0a 2020 2020 2020 2020 2020  ork):.          
-00001e70: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-00001e80: 696e 6974 5f5f 2866 7261 6d65 776f 726b  init__(framework
-00001e90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00001ea0: 2020 7365 6c66 2e6f 6273 6572 7665 645f    self.observed_
-00001eb0: 6576 656e 7473 203d 205b 5d0a 2020 2020  events = [].    
-00001ec0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00001ed0: 2e66 7261 6d65 776f 726b 2e6f 6273 6572  .framework.obser
-00001ee0: 7665 2873 656c 662e 6f6e 2e64 625f 7265  ve(self.on.db_re
-00001ef0: 6c61 7469 6f6e 5f63 6861 6e67 6564 2c20  lation_changed, 
-00001f00: 7365 6c66 2e5f 6f6e 5f64 625f 7265 6c61  self._on_db_rela
-00001f10: 7469 6f6e 5f63 6861 6e67 6564 290a 0a20  tion_changed).. 
-00001f20: 2020 2020 2020 2020 2020 2064 6566 205f             def _
-00001f30: 6f6e 5f64 625f 7265 6c61 7469 6f6e 5f63  on_db_relation_c
-00001f40: 6861 6e67 6564 2873 656c 662c 2065 7665  hanged(self, eve
-00001f50: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-00001f60: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
-00001f70: 6564 5f65 7665 6e74 732e 6170 7065 6e64  ed_events.append
-00001f80: 2865 7665 6e74 290a 0a20 2020 2020 2020  (event)..       
-00001f90: 2023 206c 616e 6775 6167 653d 5941 4d4c   # language=YAML
-00001fa0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00001fb0: 203d 2048 6172 6e65 7373 2849 6e69 7469   = Harness(Initi
-00001fc0: 616c 4461 7461 5465 7374 6572 2c20 6d65  alDataTester, me
-00001fd0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00001fe0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00001ff0: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00002000: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00002010: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-00002020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002030: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00002040: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00002050: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00002060: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00002070: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00002080: 2020 2072 656c 5f69 6420 3d20 6861 726e     rel_id = harn
-00002090: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-000020a0: 2827 6462 272c 2027 706f 7374 6772 6573  ('db', 'postgres
-000020b0: 716c 2729 0a20 2020 2020 2020 2068 6172  ql').        har
-000020c0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-000020d0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-000020e0: 2c20 2774 6573 742d 6170 7027 2c20 7b27  , 'test-app', {'
-000020f0: 6b27 3a20 2776 3127 7d29 0a20 2020 2020  k': 'v1'}).     
-00002100: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00002110: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-00002120: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
-00002130: 702f 3027 2c20 7b27 696e 6772 6573 732d  p/0', {'ingress-
-00002140: 6164 6472 6573 7327 3a20 2731 3932 2e30  address': '192.0
-00002150: 2e32 2e31 277d 290a 2020 2020 2020 2020  .2.1'}).        
-00002160: 6261 636b 656e 6420 3d20 6861 726e 6573  backend = harnes
-00002170: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
-00002180: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00002190: 7561 6c28 7b27 6b27 3a20 2776 3127 7d2c  ual({'k': 'v1'},
-000021a0: 2062 6163 6b65 6e64 2e72 656c 6174 696f   backend.relatio
-000021b0: 6e5f 6765 7428 7265 6c5f 6964 2c20 2774  n_get(rel_id, 't
-000021c0: 6573 742d 6170 7027 2c20 6973 5f61 7070  est-app', is_app
-000021d0: 3d54 7275 6529 290a 2020 2020 2020 2020  =True)).        
-000021e0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000021f0: 287b 2769 6e67 7265 7373 2d61 6464 7265  ({'ingress-addre
-00002200: 7373 273a 2027 3139 322e 302e 322e 3127  ss': '192.0.2.1'
-00002210: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00002220: 2020 2020 2020 2020 2020 2020 6261 636b              back
-00002230: 656e 642e 7265 6c61 7469 6f6e 5f67 6574  end.relation_get
-00002240: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
-00002250: 7070 2f30 272c 2069 735f 6170 703d 4661  pp/0', is_app=Fa
-00002260: 6c73 6529 290a 0a20 2020 2020 2020 2068  lse))..        h
-00002270: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
-00002280: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00002290: 7274 4571 7561 6c28 7b27 6b27 3a20 2776  rtEqual({'k': 'v
-000022a0: 3127 7d2c 2062 6163 6b65 6e64 2e72 656c  1'}, backend.rel
-000022b0: 6174 696f 6e5f 6765 7428 7265 6c5f 6964  ation_get(rel_id
-000022c0: 2c20 2774 6573 742d 6170 7027 2c20 6973  , 'test-app', is
-000022d0: 5f61 7070 3d54 7275 6529 290a 2020 2020  _app=True)).    
-000022e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000022f0: 7175 616c 287b 2769 6e67 7265 7373 2d61  qual({'ingress-a
-00002300: 6464 7265 7373 273a 2027 3139 322e 302e  ddress': '192.0.
-00002310: 322e 3127 7d2c 0a20 2020 2020 2020 2020  2.1'},.         
-00002320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002330: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
-00002340: 5f67 6574 2872 656c 5f69 642c 2027 7465  _get(rel_id, 'te
-00002350: 7374 2d61 7070 2f30 272c 2069 735f 6170  st-app/0', is_ap
-00002360: 703d 4661 6c73 6529 290a 2020 2020 2020  p=False)).      
-00002370: 2020 2320 4d61 6b65 2073 7572 6520 6e6f    # Make sure no
-00002380: 2072 656c 6174 696f 6e2d 6368 616e 6765   relation-change
-00002390: 6420 6576 656e 7473 2061 7265 2065 6d69  d events are emi
-000023a0: 7474 6564 2066 6f72 206f 7572 206f 776e  tted for our own
-000023b0: 2064 6174 6120 6261 6773 2e0a 2020 2020   data bags..    
-000023c0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000023d0: 7175 616c 285b 5d2c 2068 6172 6e65 7373  qual([], harness
-000023e0: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
-000023f0: 6576 656e 7473 290a 0a20 2020 2020 2020  events)..       
-00002400: 2023 2041 2072 656d 6f74 6520 756e 6974   # A remote unit
-00002410: 2063 616e 2073 7469 6c6c 2075 7064 6174   can still updat
-00002420: 6520 6f75 7220 6170 7020 7265 6c61 7469  e our app relati
-00002430: 6f6e 2064 6174 6120 6261 6720 7369 6e63  on data bag sinc
-00002440: 6520 6f75 7220 756e 6974 2069 7320 6e6f  e our unit is no
-00002450: 7420 6120 6c65 6164 6572 2e0a 2020 2020  t a leader..    
-00002460: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-00002470: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-00002480: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
-00002490: 7070 272c 207b 276b 273a 2027 7632 277d  pp', {'k': 'v2'}
-000024a0: 290a 2020 2020 2020 2020 2320 416e 6420  ).        # And 
-000024b0: 7765 2067 6574 2061 6e20 6576 656e 740a  we get an event.
-000024c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000024d0: 6572 7445 7175 616c 285b 5d2c 2068 6172  ertEqual([], har
-000024e0: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
-000024f0: 7665 645f 6576 656e 7473 290a 2020 2020  ved_events).    
-00002500: 2020 2020 2320 5765 2063 616e 2061 6c73      # We can als
-00002510: 6f20 7570 6461 7465 206f 7572 206f 776e  o update our own
-00002520: 2072 656c 6174 696f 6e20 6461 7461 2c20   relation data, 
-00002530: 6576 656e 2069 6620 6974 2069 7320 6120  even if it is a 
-00002540: 6269 7420 2763 6865 6174 7927 0a20 2020  bit 'cheaty'.   
-00002550: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-00002560: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00002570: 6128 7265 6c5f 6964 2c20 2774 6573 742d  a(rel_id, 'test-
-00002580: 6170 702f 3027 2c20 7b27 696e 6772 6573  app/0', {'ingres
-00002590: 732d 6164 6472 6573 7327 3a20 2731 3932  s-address': '192
-000025a0: 2e30 2e32 2e32 277d 290a 2020 2020 2020  .0.2.2'}).      
-000025b0: 2020 2320 4275 7420 6e6f 2065 7665 6e74    # But no event
-000025c0: 2068 6170 7065 6e73 0a0a 2020 2020 2020   happens..      
-000025d0: 2020 2320 5570 6461 7469 6e67 206f 7572    # Updating our
-000025e0: 2064 6174 6120 6170 7020 7265 6c61 7469   data app relati
-000025f0: 6f6e 2064 6174 6120 6261 6720 616e 6420  on data bag and 
-00002600: 6f75 7220 756e 6974 2064 6174 6120 6261  our unit data ba
-00002610: 6720 646f 6573 206e 6f74 2067 656e 6572  g does not gener
-00002620: 6174 6520 6576 656e 7473 2e0a 2020 2020  ate events..    
-00002630: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-00002640: 6c65 6164 6572 2854 7275 6529 0a20 2020  leader(True).   
-00002650: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-00002660: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00002670: 6128 7265 6c5f 6964 2c20 2774 6573 742d  a(rel_id, 'test-
-00002680: 6170 7027 2c20 7b27 6b27 3a20 2776 3327  app', {'k': 'v3'
-00002690: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
-000026a0: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
-000026b0: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
-000026c0: 2774 6573 742d 6170 702f 3027 2c20 7b27  'test-app/0', {'
-000026d0: 696e 6772 6573 732d 6164 6472 6573 7327  ingress-address'
-000026e0: 3a20 2731 3932 2e30 2e32 2e32 277d 290a  : '192.0.2.2'}).
-000026f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00002700: 6572 7445 7175 616c 285b 5d2c 2068 6172  ertEqual([], har
-00002710: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
-00002720: 7665 645f 6576 656e 7473 290a 0a20 2020  ved_events)..   
-00002730: 2064 6566 2074 6573 745f 6164 645f 7065   def test_add_pe
-00002740: 6572 5f72 656c 6174 696f 6e5f 7769 7468  er_relation_with
-00002750: 5f69 6e69 7469 616c 5f64 6174 615f 6c65  _initial_data_le
-00002760: 6164 6572 2873 656c 6629 3a0a 0a20 2020  ader(self):..   
-00002770: 2020 2020 2063 6c61 7373 2049 6e69 7469       class Initi
-00002780: 616c 4461 7461 5465 7374 6572 2843 6861  alDataTester(Cha
-00002790: 726d 4261 7365 293a 0a20 2020 2020 2020  rmBase):.       
-000027a0: 2020 2020 2022 2222 5265 636f 7264 2074       """Record t
-000027b0: 6865 2072 656c 6174 696f 6e2d 6368 616e  he relation-chan
-000027c0: 6765 6420 6576 656e 7473 2e22 2222 0a0a  ged events."""..
-000027d0: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-000027e0: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
-000027f0: 7261 6d65 776f 726b 293a 0a20 2020 2020  ramework):.     
-00002800: 2020 2020 2020 2020 2020 2073 7570 6572             super
-00002810: 2829 2e5f 5f69 6e69 745f 5f28 6672 616d  ().__init__(fram
-00002820: 6577 6f72 6b29 0a20 2020 2020 2020 2020  ework).         
-00002830: 2020 2020 2020 2073 656c 662e 6f62 7365         self.obse
-00002840: 7276 6564 5f65 7665 6e74 7320 3d20 5b5d  rved_events = []
-00002850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002860: 2073 656c 662e 6672 616d 6577 6f72 6b2e   self.framework.
-00002870: 6f62 7365 7276 6528 7365 6c66 2e6f 6e2e  observe(self.on.
-00002880: 636c 7573 7465 725f 7265 6c61 7469 6f6e  cluster_relation
-00002890: 5f63 6861 6e67 6564 2c0a 2020 2020 2020  _changed,.      
-000028a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000028b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000028c0: 2073 656c 662e 5f6f 6e5f 636c 7573 7465   self._on_cluste
-000028d0: 725f 7265 6c61 7469 6f6e 5f63 6861 6e67  r_relation_chang
-000028e0: 6564 290a 0a20 2020 2020 2020 2020 2020  ed)..           
-000028f0: 2064 6566 205f 6f6e 5f63 6c75 7374 6572   def _on_cluster
-00002900: 5f72 656c 6174 696f 6e5f 6368 616e 6765  _relation_change
-00002910: 6428 7365 6c66 2c20 6576 656e 7429 3a0a  d(self, event):.
-00002920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002930: 7365 6c66 2e6f 6273 6572 7665 645f 6576  self.observed_ev
-00002940: 656e 7473 2e61 7070 656e 6428 6576 656e  ents.append(even
-00002950: 7429 0a0a 2020 2020 2020 2020 2320 6c61  t)..        # la
-00002960: 6e67 7561 6765 3d59 414d 4c0a 2020 2020  nguage=YAML.    
-00002970: 2020 2020 6861 726e 6573 7320 3d20 4861      harness = Ha
-00002980: 726e 6573 7328 496e 6974 6961 6c44 6174  rness(InitialDat
-00002990: 6154 6573 7465 722c 206d 6574 613d 2727  aTester, meta=''
-000029a0: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-000029b0: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-000029c0: 2020 2020 2020 2020 2070 6565 7273 3a0a           peers:.
-000029d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029e0: 636c 7573 7465 723a 0a20 2020 2020 2020  cluster:.       
-000029f0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-00002a00: 6572 6661 6365 3a20 636c 7573 7465 720a  erface: cluster.
-00002a10: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00002a20: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00002a30: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00002a40: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00002a50: 2020 2320 544f 444f 3a20 646d 6974 7269    # TODO: dmitri
-00002a60: 6973 2032 3032 302d 3034 2d30 3720 7465  is 2020-04-07 te
-00002a70: 7374 2061 206d 696e 696f 6e20 756e 6974  st a minion unit
-00002a80: 2061 6e64 2069 6e69 7469 616c 2070 6565   and initial pee
-00002a90: 7220 7265 6c61 7469 6f6e 2061 7070 2064  r relation app d
-00002aa0: 6174 610a 2020 2020 2020 2020 2320 6576  ata.        # ev
-00002ab0: 656e 7473 2077 6865 6e20 7468 6520 6861  ents when the ha
-00002ac0: 726e 6573 7320 6265 6769 6e73 2074 6f20  rness begins to 
-00002ad0: 656d 6974 2065 7665 6e74 7320 666f 7220  emit events for 
-00002ae0: 696e 6974 6961 6c20 6461 7461 2e0a 2020  initial data..  
-00002af0: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-00002b00: 745f 6c65 6164 6572 2869 735f 6c65 6164  t_leader(is_lead
-00002b10: 6572 3d54 7275 6529 0a20 2020 2020 2020  er=True).       
-00002b20: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
-00002b30: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-00002b40: 636c 7573 7465 7227 2c20 2774 6573 742d  cluster', 'test-
-00002b50: 6170 7027 290a 2020 2020 2020 2020 6861  app').        ha
-00002b60: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00002b70: 6174 696f 6e5f 6461 7461 2872 656c 5f69  ation_data(rel_i
-00002b80: 642c 2027 7465 7374 2d61 7070 272c 207b  d, 'test-app', {
-00002b90: 276b 273a 2027 7627 7d29 0a20 2020 2020  'k': 'v'}).     
-00002ba0: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00002bb0: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-00002bc0: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
-00002bd0: 702f 3027 2c20 7b27 696e 6772 6573 732d  p/0', {'ingress-
-00002be0: 6164 6472 6573 7327 3a20 2731 3932 2e30  address': '192.0
-00002bf0: 2e32 2e31 277d 290a 2020 2020 2020 2020  .2.1'}).        
-00002c00: 6261 636b 656e 6420 3d20 6861 726e 6573  backend = harnes
-00002c10: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
-00002c20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00002c30: 7561 6c28 7b27 6b27 3a20 2776 277d 2c20  ual({'k': 'v'}, 
-00002c40: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
-00002c50: 5f67 6574 2872 656c 5f69 642c 2027 7465  _get(rel_id, 'te
-00002c60: 7374 2d61 7070 272c 2069 735f 6170 703d  st-app', is_app=
-00002c70: 5472 7565 2929 0a20 2020 2020 2020 2073  True)).        s
-00002c80: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00002c90: 7b27 696e 6772 6573 732d 6164 6472 6573  {'ingress-addres
-00002ca0: 7327 3a20 2731 3932 2e30 2e32 2e31 277d  s': '192.0.2.1'}
-00002cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002cc0: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-00002cd0: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
-00002ce0: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
-00002cf0: 702f 3027 2c20 6973 5f61 7070 3d46 616c  p/0', is_app=Fal
-00002d00: 7365 2929 0a0a 2020 2020 2020 2020 6861  se))..        ha
-00002d10: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-00002d20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00002d30: 7445 7175 616c 287b 276b 273a 2027 7627  tEqual({'k': 'v'
-00002d40: 7d2c 2062 6163 6b65 6e64 2e72 656c 6174  }, backend.relat
-00002d50: 696f 6e5f 6765 7428 7265 6c5f 6964 2c20  ion_get(rel_id, 
-00002d60: 2774 6573 742d 6170 7027 2c20 6973 5f61  'test-app', is_a
-00002d70: 7070 3d54 7275 6529 290a 2020 2020 2020  pp=True)).      
-00002d80: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00002d90: 616c 287b 2769 6e67 7265 7373 2d61 6464  al({'ingress-add
-00002da0: 7265 7373 273a 2027 3139 322e 302e 322e  ress': '192.0.2.
-00002db0: 3127 7d2c 0a20 2020 2020 2020 2020 2020  1'},.           
-00002dc0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00002dd0: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-00002de0: 6574 2872 656c 5f69 642c 2027 7465 7374  et(rel_id, 'test
-00002df0: 2d61 7070 2f30 272c 2069 735f 6170 703d  -app/0', is_app=
-00002e00: 4661 6c73 6529 290a 2020 2020 2020 2020  False)).        
-00002e10: 2320 4d61 6b65 2073 7572 6520 6e6f 2072  # Make sure no r
-00002e20: 656c 6174 696f 6e2d 6368 616e 6765 6420  elation-changed 
-00002e30: 6576 656e 7473 2061 7265 2065 6d69 7474  events are emitt
-00002e40: 6564 2066 6f72 206f 7572 206f 776e 2064  ed for our own d
-00002e50: 6174 6120 6261 6773 2e0a 2020 2020 2020  ata bags..      
-00002e60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00002e70: 616c 285b 5d2c 2068 6172 6e65 7373 2e63  al([], harness.c
-00002e80: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
-00002e90: 656e 7473 290a 0a20 2020 2020 2020 2023  ents)..        #
-00002ea0: 2055 7064 6174 696e 6720 6f75 7220 6170   Updating our ap
-00002eb0: 7020 7265 6c61 7469 6f6e 2064 6174 6120  p relation data 
-00002ec0: 6261 6720 616e 6420 6f75 7220 756e 6974  bag and our unit
-00002ed0: 2064 6174 6120 6261 6720 646f 6573 206e   data bag does n
-00002ee0: 6f74 2074 7269 6767 6572 2065 7665 6e74  ot trigger event
-00002ef0: 730a 2020 2020 2020 2020 6861 726e 6573  s.        harnes
-00002f00: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00002f10: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
-00002f20: 7465 7374 2d61 7070 272c 207b 276b 273a  test-app', {'k':
-00002f30: 2027 7632 277d 290a 2020 2020 2020 2020   'v2'}).        
-00002f40: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
-00002f50: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
-00002f60: 5f69 642c 2027 7465 7374 2d61 7070 2f30  _id, 'test-app/0
-00002f70: 272c 207b 2769 6e67 7265 7373 2d61 6464  ', {'ingress-add
-00002f80: 7265 7373 273a 2027 3139 322e 302e 322e  ress': '192.0.2.
-00002f90: 3227 7d29 0a20 2020 2020 2020 2073 656c  2'}).        sel
-00002fa0: 662e 6173 7365 7274 4571 7561 6c28 5b5d  f.assertEqual([]
-00002fb0: 2c20 6861 726e 6573 732e 6368 6172 6d2e  , harness.charm.
-00002fc0: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
-00002fd0: 0a0a 2020 2020 2020 2020 2320 4966 206f  ..        # If o
-00002fe0: 7572 2075 6e69 7420 6265 636f 6d65 7320  ur unit becomes 
-00002ff0: 6120 6d69 6e69 6f6e 2c20 7570 6461 7469  a minion, updati
-00003000: 6e67 2061 7070 2072 656c 6174 696f 6e20  ng app relation 
-00003010: 6461 7461 2069 6e64 6972 6563 746c 7920  data indirectly 
-00003020: 6265 636f 6d65 7320 706f 7373 6962 6c65  becomes possible
-00003030: 0a20 2020 2020 2020 2023 2061 6e64 206f  .        # and o
-00003040: 7572 2063 6861 726d 2067 6574 7320 6e6f  ur charm gets no
-00003050: 7469 6669 6361 7469 6f6e 732e 0a20 2020  tifications..   
-00003060: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-00003070: 5f6c 6561 6465 7228 4661 6c73 6529 0a20  _leader(False). 
-00003080: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
-00003090: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-000030a0: 6174 6128 7265 6c5f 6964 2c20 2774 6573  ata(rel_id, 'tes
-000030b0: 742d 6170 7027 2c20 7b27 6b27 3a20 2776  t-app', {'k': 'v
-000030c0: 3327 7d29 0a20 2020 2020 2020 2073 656c  3'}).        sel
-000030d0: 662e 6173 7365 7274 4571 7561 6c28 7b27  f.assertEqual({'
-000030e0: 6b27 3a20 2776 3327 7d2c 2062 6163 6b65  k': 'v3'}, backe
-000030f0: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
-00003100: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
-00003110: 7027 2c20 6973 5f61 7070 3d54 7275 6529  p', is_app=True)
-00003120: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00003130: 7373 6572 7454 7275 6528 6c65 6e28 6861  ssertTrue(len(ha
-00003140: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-00003150: 7276 6564 5f65 7665 6e74 7329 2c20 3129  rved_events), 1)
-00003160: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00003170: 7365 7274 4973 496e 7374 616e 6365 2868  sertIsInstance(h
-00003180: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
-00003190: 6572 7665 645f 6576 656e 7473 5b30 5d2c  erved_events[0],
-000031a0: 2052 656c 6174 696f 6e45 7665 6e74 290a   RelationEvent).
-000031b0: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
-000031c0: 6c61 7469 6f6e 5f67 6574 5f77 6865 6e5f  lation_get_when_
-000031d0: 6272 6f6b 656e 2873 656c 6629 3a0a 2020  broken(self):.  
-000031e0: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
-000031f0: 4861 726e 6573 7328 5265 6c61 7469 6f6e  Harness(Relation
-00003200: 4272 6f6b 656e 5465 7374 6572 2c20 6d65  BrokenTester, me
-00003210: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00003220: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00003230: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00003240: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00003250: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
-00003260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003270: 2069 6e74 6572 6661 6365 3a20 666f 6f66   interface: foof
-00003280: 6f6f 0a20 2020 2020 2020 2020 2020 2027  oo.            '
-00003290: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-000032a0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-000032b0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-000032c0: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
-000032d0: 696e 2829 0a20 2020 2020 2020 2068 6172  in().        har
-000032e0: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
-000032f0: 7665 5f72 656c 6174 696f 6e5f 6576 656e  ve_relation_even
-00003300: 7473 2827 666f 6f27 290a 0a20 2020 2020  ts('foo')..     
-00003310: 2020 2023 2072 656c 6174 696f 6e20 7265     # relation re
-00003320: 6d6f 7465 2061 7070 2069 7320 4e6f 6e65  mote app is None
-00003330: 2074 6f20 6d69 7272 6f72 2070 726f 6475   to mirror produ
-00003340: 6374 696f 6e20 4a75 6a75 2062 6568 6176  ction Juju behav
-00003350: 696f 7220 7768 6572 6520 4a75 6a75 2064  ior where Juju d
-00003360: 6f65 736e 2774 0a20 2020 2020 2020 2023  oesn't.        #
-00003370: 2063 6f6d 6d75 6e69 6361 7465 2074 6865   communicate the
-00003380: 2072 656d 6f74 6520 6170 7020 746f 206f   remote app to o
-00003390: 7073 2e0a 2020 2020 2020 2020 7265 6c5f  ps..        rel_
-000033a0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-000033b0: 5f72 656c 6174 696f 6e28 2766 6f6f 272c  _relation('foo',
-000033c0: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
-000033d0: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-000033e0: 6573 284b 6579 4572 726f 722c 206d 6174  es(KeyError, mat
-000033f0: 6368 3d27 7472 7969 6e67 2074 6f20 6163  ch='trying to ac
-00003400: 6365 7373 2072 656d 6f74 6520 6170 7020  cess remote app 
-00003410: 6461 7461 2729 3a0a 2020 2020 2020 2020  data'):.        
-00003420: 2020 2020 6861 726e 6573 732e 7265 6d6f      harness.remo
-00003430: 7665 5f72 656c 6174 696f 6e28 7265 6c5f  ve_relation(rel_
-00003440: 6964 290a 0a20 2020 2064 6566 2074 6573  id)..    def tes
-00003450: 745f 7265 6d6f 7665 5f72 656c 6174 696f  t_remove_relatio
-00003460: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00003470: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-00003480: 7373 2852 656c 6174 696f 6e45 7665 6e74  ss(RelationEvent
-00003490: 4368 6172 6d2c 206d 6574 613d 2727 270a  Charm, meta='''.
-000034a0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-000034b0: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-000034c0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-000034d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000034e0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-000034f0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-00003500: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-00003510: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00003520: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00003530: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00003540: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-00003550: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-00003560: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
-00003570: 6d2e 6f62 7365 7276 655f 7265 6c61 7469  m.observe_relati
-00003580: 6f6e 5f65 7665 6e74 7328 2764 6227 290a  on_events('db').
-00003590: 2020 2020 2020 2020 2320 4669 7273 7420          # First 
-000035a0: 6372 6561 7465 2061 2072 656c 6174 696f  create a relatio
-000035b0: 6e0a 2020 2020 2020 2020 7265 6c5f 6964  n.        rel_id
-000035c0: 203d 2068 6172 6e65 7373 2e61 6464 5f72   = harness.add_r
-000035d0: 656c 6174 696f 6e28 2764 6227 2c20 2770  elation('db', 'p
-000035e0: 6f73 7467 7265 7371 6c27 290a 2020 2020  ostgresql').    
-000035f0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-00003600: 7349 6e73 7461 6e63 6528 7265 6c5f 6964  sInstance(rel_id
-00003610: 2c20 696e 7429 0a20 2020 2020 2020 2068  , int).        h
-00003620: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00003630: 696f 6e5f 756e 6974 2872 656c 5f69 642c  ion_unit(rel_id,
-00003640: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
-00003650: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
-00003660: 203d 2068 6172 6e65 7373 2e5f 6261 636b   = harness._back
-00003670: 656e 640a 2020 2020 2020 2020 2320 4368  end.        # Ch
-00003680: 6563 6b20 7265 6c61 7469 6f6e 2077 6173  eck relation was
-00003690: 2063 7265 6174 6564 0a20 2020 2020 2020   created.       
-000036a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000036b0: 6c28 6261 636b 656e 642e 7265 6c61 7469  l(backend.relati
-000036c0: 6f6e 5f69 6473 2827 6462 2729 2c20 5b72  on_ids('db'), [r
-000036d0: 656c 5f69 645d 290a 2020 2020 2020 2020  el_id]).        
-000036e0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000036f0: 2862 6163 6b65 6e64 2e72 656c 6174 696f  (backend.relatio
-00003700: 6e5f 6c69 7374 2872 656c 5f69 6429 2c20  n_list(rel_id), 
-00003710: 5b27 706f 7374 6772 6573 716c 2f30 275d  ['postgresql/0']
-00003720: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00003730: 732e 6368 6172 6d2e 6765 745f 6368 616e  s.charm.get_chan
-00003740: 6765 7328 7265 7365 743d 5472 7565 2920  ges(reset=True) 
-00003750: 2023 2063 7265 6174 6564 2065 7665 6e74   # created event
-00003760: 2069 676e 6f72 6564 0a20 2020 2020 2020   ignored.       
-00003770: 2023 204e 6f77 2072 656d 6f76 6520 7265   # Now remove re
-00003780: 6c61 7469 6f6e 0a20 2020 2020 2020 2068  lation.        h
-00003790: 6172 6e65 7373 2e72 656d 6f76 655f 7265  arness.remove_re
-000037a0: 6c61 7469 6f6e 2872 656c 5f69 6429 0a20  lation(rel_id). 
-000037b0: 2020 2020 2020 2023 2043 6865 636b 2072         # Check r
-000037c0: 656c 6174 696f 6e20 6e6f 206c 6f6e 6765  elation no longe
-000037d0: 7220 6578 6973 7473 0a20 2020 2020 2020  r exists.       
-000037e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000037f0: 6c28 6261 636b 656e 642e 7265 6c61 7469  l(backend.relati
-00003800: 6f6e 5f69 6473 2827 6462 2729 2c20 5b5d  on_ids('db'), []
-00003810: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00003820: 7373 6572 7452 6169 7365 7328 5265 6c61  ssertRaises(Rela
-00003830: 7469 6f6e 4e6f 7446 6f75 6e64 4572 726f  tionNotFoundErro
-00003840: 722c 2062 6163 6b65 6e64 2e72 656c 6174  r, backend.relat
-00003850: 696f 6e5f 6c69 7374 2c20 7265 6c5f 6964  ion_list, rel_id
-00003860: 290a 2020 2020 2020 2020 2320 4368 6563  ).        # Chec
-00003870: 6b20 7265 6c61 7469 6f6e 2062 726f 6b65  k relation broke
-00003880: 6e20 6576 656e 7420 6973 2072 6169 7365  n event is raise
-00003890: 6420 7769 7468 2063 6f72 7265 6374 2064  d with correct d
-000038a0: 6174 610a 2020 2020 2020 2020 6368 616e  ata.        chan
-000038b0: 6765 7320 3d20 6861 726e 6573 732e 6368  ges = harness.ch
-000038c0: 6172 6d2e 6765 745f 6368 616e 6765 7328  arm.get_changes(
-000038d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000038e0: 7373 6572 7445 7175 616c 2863 6861 6e67  ssertEqual(chang
-000038f0: 6573 5b30 5d2c 0a20 2020 2020 2020 2020  es[0],.         
-00003900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003910: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
-00003920: 6f6e 2d64 6570 6172 7465 6427 2c0a 2020  on-departed',.  
-00003930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003940: 2020 2020 2020 2020 2772 656c 6174 696f          'relatio
-00003950: 6e27 3a20 2764 6227 2c0a 2020 2020 2020  n': 'db',.      
-00003960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003970: 2020 2020 2764 6174 6127 3a20 7b27 6170      'data': {'ap
-00003980: 7027 3a20 2770 6f73 7467 7265 7371 6c27  p': 'postgresql'
-00003990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000039a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039b0: 2020 2020 2027 756e 6974 273a 2027 706f       'unit': 'po
-000039c0: 7374 6772 6573 716c 2f30 272c 0a20 2020  stgresql/0',.   
-000039d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039f0: 2764 6570 6172 7469 6e67 5f75 6e69 7427  'departing_unit'
-00003a00: 3a20 2770 6f73 7467 7265 7371 6c2f 3027  : 'postgresql/0'
-00003a10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00000290: 0a69 6d70 6f72 7420 6970 6164 6472 6573  .import ipaddres
+000002a0: 730a 696d 706f 7274 206f 730a 696d 706f  s.import os.impo
+000002b0: 7274 2070 6174 686c 6962 0a69 6d70 6f72  rt pathlib.impor
+000002c0: 7420 706c 6174 666f 726d 0a69 6d70 6f72  t platform.impor
+000002d0: 7420 7368 7574 696c 0a69 6d70 6f72 7420  t shutil.import 
+000002e0: 7379 730a 696d 706f 7274 2074 656d 7066  sys.import tempf
+000002f0: 696c 650a 696d 706f 7274 2074 6578 7477  ile.import textw
+00000300: 7261 700a 696d 706f 7274 2075 6e69 7474  rap.import unitt
+00000310: 6573 740a 696d 706f 7274 2075 7569 640a  est.import uuid.
+00000320: 6672 6f6d 2069 6f20 696d 706f 7274 2042  from io import B
+00000330: 7974 6573 494f 2c20 5374 7269 6e67 494f  ytesIO, StringIO
+00000340: 0a66 726f 6d20 756e 6974 7465 7374 2e6d  .from unittest.m
+00000350: 6f63 6b20 696d 706f 7274 204d 6167 6963  ock import Magic
+00000360: 4d6f 636b 0a0a 696d 706f 7274 2070 7974  Mock..import pyt
+00000370: 6573 740a 696d 706f 7274 2079 616d 6c0a  est.import yaml.
+00000380: 0a69 6d70 6f72 7420 6f70 730a 696d 706f  .import ops.impo
+00000390: 7274 206f 7073 2e74 6573 7469 6e67 0a66  rt ops.testing.f
+000003a0: 726f 6d20 6f70 7320 696d 706f 7274 2070  rom ops import p
+000003b0: 6562 626c 650a 6672 6f6d 206f 7073 2e6d  ebble.from ops.m
+000003c0: 6f64 656c 2069 6d70 6f72 7420 5f4d 6f64  odel import _Mod
+000003d0: 656c 4261 636b 656e 640a 6672 6f6d 206f  elBackend.from o
+000003e0: 7073 2e74 6573 7469 6e67 2069 6d70 6f72  ps.testing impor
+000003f0: 7420 280a 2020 2020 4e6f 6e41 6273 6f6c  t (.    NonAbsol
+00000400: 7574 6550 6174 6845 7272 6f72 2c0a 2020  utePathError,.  
+00000410: 2020 5f44 6972 6563 746f 7279 2c0a 2020    _Directory,.  
+00000420: 2020 5f54 6573 7469 6e67 4669 6c65 7379    _TestingFilesy
+00000430: 7374 656d 2c0a 2020 2020 5f54 6573 7469  stem,.    _Testi
+00000440: 6e67 5065 6262 6c65 436c 6965 6e74 2c0a  ngPebbleClient,.
+00000450: 2020 2020 5f54 6573 7469 6e67 5374 6f72      _TestingStor
+00000460: 6167 654d 6f75 6e74 2c0a 290a 0a69 735f  ageMount,.)..is_
+00000470: 6c69 6e75 7820 3d20 706c 6174 666f 726d  linux = platform
+00000480: 2e73 7973 7465 6d28 2920 3d3d 2027 4c69  .system() == 'Li
+00000490: 6e75 7827 0a0a 0a63 6c61 7373 2053 6574  nux'...class Set
+000004a0: 4c65 6164 6572 4572 726f 7254 6573 7465  LeaderErrorTeste
+000004b0: 7228 6f70 732e 4368 6172 6d42 6173 6529  r(ops.CharmBase)
+000004c0: 3a0a 2020 2020 2222 2253 6574 7320 7065  :.    """Sets pe
+000004d0: 6572 2072 656c 6174 696f 6e20 6461 7461  er relation data
+000004e0: 2069 6e73 6964 6520 6c65 6164 6572 2d65   inside leader-e
+000004f0: 6c65 6374 6564 2e22 2222 0a0a 2020 2020  lected."""..    
+00000500: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00000510: 662c 2066 7261 6d65 776f 726b 293a 0a20  f, framework):. 
+00000520: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+00000530: 5f69 6e69 745f 5f28 6672 616d 6577 6f72  _init__(framewor
+00000540: 6b29 0a20 2020 2020 2020 2073 656c 662e  k).        self.
+00000550: 5f70 6565 725f 6e61 6d65 203d 2027 7065  _peer_name = 'pe
+00000560: 6572 270a 2020 2020 2020 2020 7365 6c66  er'.        self
+00000570: 2e66 7261 6d65 776f 726b 2e6f 6273 6572  .framework.obser
+00000580: 7665 2873 656c 662e 6f6e 2e6c 6561 6465  ve(self.on.leade
+00000590: 725f 656c 6563 7465 642c 0a20 2020 2020  r_elected,.     
+000005a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000005b0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000005c0: 6f6e 5f6c 6561 6465 725f 656c 6563 7465  on_leader_electe
+000005d0: 6429 0a0a 2020 2020 6465 6620 5f6f 6e5f  d)..    def _on_
+000005e0: 6c65 6164 6572 5f65 6c65 6374 6564 2873  leader_elected(s
+000005f0: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
+00000600: 2020 2020 2070 6565 7273 203d 2073 656c       peers = sel
+00000610: 662e 6d6f 6465 6c2e 6765 745f 7265 6c61  f.model.get_rela
+00000620: 7469 6f6e 2873 656c 662e 5f70 6565 725f  tion(self._peer_
+00000630: 6e61 6d65 290a 2020 2020 2020 2020 7065  name).        pe
+00000640: 6572 732e 6461 7461 5b73 656c 662e 6170  ers.data[self.ap
+00000650: 705d 5b22 666f 6f22 5d20 3d20 2262 6172  p]["foo"] = "bar
+00000660: 220a 0a0a 636c 6173 7320 5374 6f72 6167  "...class Storag
+00000670: 6554 6573 7465 7228 6f70 732e 4368 6172  eTester(ops.Char
+00000680: 6d42 6173 6529 3a0a 2020 2020 2222 2252  mBase):.    """R
+00000690: 6563 6f72 6420 7468 6520 7265 6c61 7469  ecord the relati
+000006a0: 6f6e 2d63 6861 6e67 6564 2065 7665 6e74  on-changed event
+000006b0: 732e 2222 220a 0a20 2020 2064 6566 205f  s."""..    def _
+000006c0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6672  _init__(self, fr
+000006d0: 616d 6577 6f72 6b29 3a0a 2020 2020 2020  amework):.      
+000006e0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+000006f0: 5f5f 2866 7261 6d65 776f 726b 290a 2020  __(framework).  
+00000700: 2020 2020 2020 7365 6c66 2e6f 6273 6572        self.obser
+00000710: 7665 645f 6576 656e 7473 203d 205b 5d0a  ved_events = [].
+00000720: 2020 2020 2020 2020 7365 6c66 2e66 7261          self.fra
+00000730: 6d65 776f 726b 2e6f 6273 6572 7665 2873  mework.observe(s
+00000740: 656c 662e 6f6e 2e74 6573 745f 7374 6f72  elf.on.test_stor
+00000750: 6167 655f 6174 7461 6368 6564 2c0a 2020  age_attached,.  
+00000760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000770: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00000780: 662e 5f6f 6e5f 7465 7374 5f73 746f 7261  f._on_test_stora
+00000790: 6765 5f61 7474 6163 6865 6429 0a20 2020  ge_attached).   
+000007a0: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
+000007b0: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
+000007c0: 2e6f 6e2e 7465 7374 5f73 746f 7261 6765  .on.test_storage
+000007d0: 5f64 6574 6163 6869 6e67 2c0a 2020 2020  _detaching,.    
+000007e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000007f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000800: 5f6f 6e5f 7465 7374 5f73 746f 7261 6765  _on_test_storage
+00000810: 5f64 6574 6163 6869 6e67 290a 0a20 2020  _detaching)..   
+00000820: 2064 6566 205f 6f6e 5f74 6573 745f 7374   def _on_test_st
+00000830: 6f72 6167 655f 6174 7461 6368 6564 2873  orage_attached(s
+00000840: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
+00000850: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
+00000860: 6564 5f65 7665 6e74 732e 6170 7065 6e64  ed_events.append
+00000870: 2865 7665 6e74 290a 0a20 2020 2064 6566  (event)..    def
+00000880: 205f 6f6e 5f74 6573 745f 7374 6f72 6167   _on_test_storag
+00000890: 655f 6465 7461 6368 696e 6728 7365 6c66  e_detaching(self
+000008a0: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
+000008b0: 2020 7365 6c66 2e6f 6273 6572 7665 645f    self.observed_
+000008c0: 6576 656e 7473 2e61 7070 656e 6428 6576  events.append(ev
+000008d0: 656e 7429 0a0a 0a63 6c61 7373 2053 746f  ent)...class Sto
+000008e0: 7261 6765 5769 7468 4879 7068 656e 7348  rageWithHyphensH
+000008f0: 656c 7065 7228 6f70 732e 4f62 6a65 6374  elper(ops.Object
+00000900: 293a 0a20 2020 2064 6566 205f 5f69 6e69  ):.    def __ini
+00000910: 745f 5f28 7365 6c66 2c20 7061 7265 6e74  t__(self, parent
+00000920: 2c20 6b65 7929 3a0a 2020 2020 2020 2020  , key):.        
+00000930: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00000940: 2870 6172 656e 742c 206b 6579 290a 2020  (parent, key).  
+00000950: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
+00000960: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+00000970: 7061 7265 6e74 2e66 7261 6d65 776f 726b  parent.framework
+00000980: 2e6f 6273 6572 7665 2870 6172 656e 742e  .observe(parent.
+00000990: 6f6e 2e74 6573 745f 7769 7468 5f68 7970  on.test_with_hyp
+000009a0: 6865 6e73 5f73 746f 7261 6765 5f61 7474  hens_storage_att
+000009b0: 6163 6865 642c 0a20 2020 2020 2020 2020  ached,.         
+000009c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000009d0: 2020 2020 2020 2020 7365 6c66 2e6f 6e5f          self.on_
+000009e0: 7374 6f72 6167 655f 6368 616e 6765 6429  storage_changed)
+000009f0: 0a20 2020 2020 2020 2070 6172 656e 742e  .        parent.
+00000a00: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
+00000a10: 6528 7061 7265 6e74 2e6f 6e2e 7465 7374  e(parent.on.test
+00000a20: 5f77 6974 685f 6879 7068 656e 735f 7374  _with_hyphens_st
+00000a30: 6f72 6167 655f 6465 7461 6368 696e 672c  orage_detaching,
+00000a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000a60: 2020 7365 6c66 2e6f 6e5f 7374 6f72 6167    self.on_storag
+00000a70: 655f 6368 616e 6765 6429 0a0a 2020 2020  e_changed)..    
+00000a80: 6465 6620 6f6e 5f73 746f 7261 6765 5f63  def on_storage_c
+00000a90: 6861 6e67 6564 2873 656c 662c 2065 7665  hanged(self, eve
+00000aa0: 6e74 293a 0a20 2020 2020 2020 2073 656c  nt):.        sel
+00000ab0: 662e 6368 616e 6765 732e 6170 7065 6e64  f.changes.append
+00000ac0: 2865 7665 6e74 290a 0a0a 636c 6173 7320  (event)...class 
+00000ad0: 5465 7374 4861 726e 6573 7328 756e 6974  TestHarness(unit
+00000ae0: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
+00000af0: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+00000b00: 645f 7265 6c61 7469 6f6e 2873 656c 6629  d_relation(self)
+00000b10: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+00000b20: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00000b30: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+00000b40: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+00000b50: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00000b60: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
+00000b70: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+00000b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000b90: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+00000ba0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+00000bb0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+00000bc0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00000bd0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00000be0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00000bf0: 7570 290a 2020 2020 2020 2020 7265 6c5f  up).        rel_
+00000c00: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00000c10: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+00000c20: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
+00000c30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00000c40: 7449 7349 6e73 7461 6e63 6528 7265 6c5f  tIsInstance(rel_
+00000c50: 6964 2c20 696e 7429 0a20 2020 2020 2020  id, int).       
+00000c60: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+00000c70: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
+00000c80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00000c90: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00000ca0: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
+00000cb0: 205b 7265 6c5f 6964 5d29 0a20 2020 2020   [rel_id]).     
+00000cc0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00000cd0: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
+00000ce0: 7469 6f6e 5f6c 6973 7428 7265 6c5f 6964  tion_list(rel_id
+00000cf0: 292c 205b 5d29 0a20 2020 2020 2020 2023  ), []).        #
+00000d00: 204d 616b 6520 7375 7265 2074 6865 2069   Make sure the i
+00000d10: 6e69 7469 616c 2064 6174 6120 6261 6773  nitial data bags
+00000d20: 2066 6f72 206f 7572 2061 7070 2061 6e64   for our app and
+00000d30: 2075 6e69 7420 6172 6520 656d 7074 792e   unit are empty.
+00000d40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00000d50: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
+00000d60: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
+00000d70: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00000d80: 272c 2069 735f 6170 703d 5472 7565 292c  ', is_app=True),
+00000d90: 207b 7d29 0a20 2020 2020 2020 2073 656c   {}).        sel
+00000da0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+00000db0: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
+00000dc0: 6574 2872 656c 5f69 642c 2027 7465 7374  et(rel_id, 'test
+00000dd0: 2d61 7070 2f30 272c 2069 735f 6170 703d  -app/0', is_app=
+00000de0: 4661 6c73 6529 2c20 7b7d 290a 0a20 2020  False), {})..   
+00000df0: 2064 6566 2074 6573 745f 6361 6e5f 636f   def test_can_co
+00000e00: 6e6e 6563 745f 6465 6661 756c 7428 7365  nnect_default(se
+00000e10: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+00000e20: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00000e30: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
+00000e40: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
+00000e50: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+00000e60: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+00000e70: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
+00000e80: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
+00000e90: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
+00000ea0: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+00000eb0: 653a 2066 6f6f 2d69 6d61 6765 0a20 2020  e: foo-image.   
+00000ec0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00000ed0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+00000ee0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+00000ef0: 6561 6e75 7029 0a0a 2020 2020 2020 2020  eanup)..        
+00000f00: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+00000f10: 2020 2020 2020 2020 6320 3d20 6861 726e          c = harn
+00000f20: 6573 732e 6d6f 6465 6c2e 756e 6974 2e67  ess.model.unit.g
+00000f30: 6574 5f63 6f6e 7461 696e 6572 2827 666f  et_container('fo
+00000f40: 6f27 290a 0a20 2020 2020 2020 2073 656c  o')..        sel
+00000f50: 662e 6173 7365 7274 4661 6c73 6528 632e  f.assertFalse(c.
+00000f60: 6361 6e5f 636f 6e6e 6563 7428 2929 0a20  can_connect()). 
+00000f70: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00000f80: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+00000f90: 6262 6c65 2e43 6f6e 6e65 6374 696f 6e45  bble.ConnectionE
+00000fa0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00000fb0: 2020 2063 2e67 6574 5f70 6c61 6e28 290a     c.get_plan().
+00000fc0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00000fd0: 2e73 6574 5f63 616e 5f63 6f6e 6e65 6374  .set_can_connect
+00000fe0: 2827 666f 6f27 2c20 5472 7565 290a 2020  ('foo', True).  
+00000ff0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00001000: 7454 7275 6528 632e 6361 6e5f 636f 6e6e  tTrue(c.can_conn
+00001010: 6563 7428 2929 0a0a 2020 2020 2020 2020  ect())..        
+00001020: 6861 726e 6573 732e 7365 745f 6361 6e5f  harness.set_can_
+00001030: 636f 6e6e 6563 7428 2766 6f6f 272c 2046  connect('foo', F
+00001040: 616c 7365 290a 2020 2020 2020 2020 7365  alse).        se
+00001050: 6c66 2e61 7373 6572 7446 616c 7365 2863  lf.assertFalse(c
+00001060: 2e63 616e 5f63 6f6e 6e65 6374 2829 290a  .can_connect()).
+00001070: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00001080: 2e63 6f6e 7461 696e 6572 5f70 6562 626c  .container_pebbl
+00001090: 655f 7265 6164 7928 2766 6f6f 2729 0a20  e_ready('foo'). 
+000010a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000010b0: 7274 5472 7565 2863 2e63 616e 5f63 6f6e  rtTrue(c.can_con
+000010c0: 6e65 6374 2829 290a 2020 2020 2020 2020  nect()).        
+000010d0: 632e 6765 745f 706c 616e 2829 2020 2320  c.get_plan()  # 
+000010e0: 7368 6f75 6c64 6e27 7420 7261 6973 6520  shouldn't raise 
+000010f0: 436f 6e6e 6563 7469 6f6e 4572 726f 720a  ConnectionError.
+00001100: 0a20 2020 2064 6566 2074 6573 745f 6361  .    def test_ca
+00001110: 6e5f 636f 6e6e 6563 745f 6265 6769 6e5f  n_connect_begin_
+00001120: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
+00001130: 6b73 2873 656c 6629 3a0a 2020 2020 2020  ks(self):.      
+00001140: 2020 7065 6262 6c65 5f72 6561 6479 5f63    pebble_ready_c
+00001150: 616c 6c73 203d 2063 6f6c 6c65 6374 696f  alls = collectio
+00001160: 6e73 2e64 6566 6175 6c74 6469 6374 2869  ns.defaultdict(i
+00001170: 6e74 290a 0a20 2020 2020 2020 2063 6c61  nt)..        cla
+00001180: 7373 204d 7943 6861 726d 286f 7073 2e43  ss MyCharm(ops.C
+00001190: 6861 726d 4261 7365 293a 0a20 2020 2020  harmBase):.     
+000011a0: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
+000011b0: 745f 5f28 7365 6c66 2c20 2a61 7267 7329  t__(self, *args)
+000011c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000011d0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+000011e0: 5f5f 282a 6172 6773 290a 2020 2020 2020  __(*args).      
+000011f0: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+00001200: 7261 6d65 776f 726b 2e6f 6273 6572 7665  ramework.observe
+00001210: 2873 656c 662e 6f6e 2e66 6f6f 5f70 6562  (self.on.foo_peb
+00001220: 626c 655f 7265 6164 792c 2073 656c 662e  ble_ready, self.
+00001230: 5f6f 6e5f 7065 6262 6c65 5f72 6561 6479  _on_pebble_ready
+00001240: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00001250: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
+00001260: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
+00001270: 2e62 6172 5f70 6562 626c 655f 7265 6164  .bar_pebble_read
+00001280: 792c 2073 656c 662e 5f6f 6e5f 7065 6262  y, self._on_pebb
+00001290: 6c65 5f72 6561 6479 290a 0a20 2020 2020  le_ready)..     
+000012a0: 2020 2020 2020 2064 6566 205f 6f6e 5f70         def _on_p
+000012b0: 6562 626c 655f 7265 6164 7928 7365 6c66  ebble_ready(self
+000012c0: 2c20 6576 656e 743a 206f 7073 2e50 6562  , event: ops.Peb
+000012d0: 626c 6552 6561 6479 4576 656e 7429 3a0a  bleReadyEvent):.
+000012e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000012f0: 6173 7365 7274 2065 7665 6e74 2e77 6f72  assert event.wor
+00001300: 6b6c 6f61 642e 6361 6e5f 636f 6e6e 6563  kload.can_connec
+00001310: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00001320: 2020 2020 7065 6262 6c65 5f72 6561 6479      pebble_ready
+00001330: 5f63 616c 6c73 5b65 7665 6e74 2e77 6f72  _calls[event.wor
+00001340: 6b6c 6f61 642e 6e61 6d65 5d20 2b3d 2031  kload.name] += 1
+00001350: 0a0a 2020 2020 2020 2020 6861 726e 6573  ..        harnes
+00001360: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00001370: 4861 726e 6573 7328 4d79 4368 6172 6d2c  Harness(MyCharm,
+00001380: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00001390: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+000013a0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+000013b0: 2063 6f6e 7461 696e 6572 733a 0a20 2020   containers:.   
+000013c0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+000013d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000013e0: 7265 736f 7572 6365 3a20 666f 6f2d 696d  resource: foo-im
+000013f0: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
+00001400: 2020 6261 723a 0a20 2020 2020 2020 2020    bar:.         
+00001410: 2020 2020 2020 2072 6573 6f75 7263 653a         resource:
+00001420: 2062 6172 2d69 6d61 6765 0a20 2020 2020   bar-image.     
+00001430: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+00001440: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+00001450: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+00001460: 6e75 7029 0a0a 2020 2020 2020 2020 6861  nup)..        ha
+00001470: 726e 6573 732e 6265 6769 6e5f 7769 7468  rness.begin_with
+00001480: 5f69 6e69 7469 616c 5f68 6f6f 6b73 2829  _initial_hooks()
+00001490: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000014a0: 7365 7274 4571 7561 6c28 6469 6374 2870  sertEqual(dict(p
+000014b0: 6562 626c 655f 7265 6164 795f 6361 6c6c  ebble_ready_call
+000014c0: 7329 2c20 7b27 666f 6f27 3a20 312c 2027  s), {'foo': 1, '
+000014d0: 6261 7227 3a20 317d 290a 2020 2020 2020  bar': 1}).      
+000014e0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
+000014f0: 6528 6861 726e 6573 732e 6d6f 6465 6c2e  e(harness.model.
+00001500: 756e 6974 2e63 6f6e 7461 696e 6572 735b  unit.containers[
+00001510: 2766 6f6f 275d 2e63 616e 5f63 6f6e 6e65  'foo'].can_conne
+00001520: 6374 2829 290a 2020 2020 2020 2020 7365  ct()).        se
+00001530: 6c66 2e61 7373 6572 7454 7275 6528 6861  lf.assertTrue(ha
+00001540: 726e 6573 732e 6d6f 6465 6c2e 756e 6974  rness.model.unit
+00001550: 2e63 6f6e 7461 696e 6572 735b 2762 6172  .containers['bar
+00001560: 275d 2e63 616e 5f63 6f6e 6e65 6374 2829  '].can_connect()
+00001570: 290a 0a20 2020 2020 2020 2068 6172 6e65  )..        harne
+00001580: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
+00001590: 6374 2827 666f 6f27 2c20 4661 6c73 6529  ct('foo', False)
+000015a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000015b0: 7365 7274 4661 6c73 6528 6861 726e 6573  sertFalse(harnes
+000015c0: 732e 6d6f 6465 6c2e 756e 6974 2e63 6f6e  s.model.unit.con
+000015d0: 7461 696e 6572 735b 2766 6f6f 275d 2e63  tainers['foo'].c
+000015e0: 616e 5f63 6f6e 6e65 6374 2829 290a 0a20  an_connect()).. 
+000015f0: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
+00001600: 6574 5f63 616e 5f63 6f6e 6e65 6374 2827  et_can_connect('
+00001610: 666f 6f27 2c20 5472 7565 290a 2020 2020  foo', True).    
+00001620: 2020 2020 636f 6e74 6169 6e65 7220 3d20      container = 
+00001630: 6861 726e 6573 732e 6d6f 6465 6c2e 756e  harness.model.un
+00001640: 6974 2e63 6f6e 7461 696e 6572 735b 2766  it.containers['f
+00001650: 6f6f 275d 0a20 2020 2020 2020 2073 656c  oo'].        sel
+00001660: 662e 6173 7365 7274 5472 7565 2863 6f6e  f.assertTrue(con
+00001670: 7461 696e 6572 2e63 616e 5f63 6f6e 6e65  tainer.can_conne
+00001680: 6374 2829 290a 2020 2020 2020 2020 636f  ct()).        co
+00001690: 6e74 6169 6e65 722e 6765 745f 706c 616e  ntainer.get_plan
+000016a0: 2829 2020 2320 7368 6f75 6c64 6e27 7420  ()  # shouldn't 
+000016b0: 7261 6973 6520 436f 6e6e 6563 7469 6f6e  raise Connection
+000016c0: 4572 726f 720a 0a20 2020 2064 6566 2074  Error..    def t
+000016d0: 6573 745f 6164 645f 7265 6c61 7469 6f6e  est_add_relation
+000016e0: 5f61 6e64 5f75 6e69 7428 7365 6c66 293a  _and_unit(self):
+000016f0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00001700: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+00001710: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+00001720: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+00001730: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+00001740: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+00001750: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
+00001760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001770: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
+00001780: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+00001790: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
+000017a0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+000017b0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+000017c0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+000017d0: 7029 0a20 2020 2020 2020 2072 656c 5f69  p).        rel_i
+000017e0: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+000017f0: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+00001800: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
+00001810: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00001820: 4973 496e 7374 616e 6365 2872 656c 5f69  IsInstance(rel_i
+00001830: 642c 2069 6e74 290a 2020 2020 2020 2020  d, int).        
+00001840: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00001850: 7469 6f6e 5f75 6e69 7428 7265 6c5f 6964  tion_unit(rel_id
+00001860: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+00001870: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00001880: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00001890: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
+000018a0: 706f 7374 6772 6573 716c 2f30 272c 207b  postgresql/0', {
+000018b0: 2766 6f6f 273a 2027 6261 7227 7d29 0a20  'foo': 'bar'}). 
+000018c0: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
+000018d0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
+000018e0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
+000018f0: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
+00001900: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
+00001910: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
+00001920: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00001930: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
+00001940: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
+00001950: 7265 6c5f 6964 292c 205b 2770 6f73 7467  rel_id), ['postg
+00001960: 7265 7371 6c2f 3027 5d29 0a20 2020 2020  resql/0']).     
+00001970: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00001980: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+00001990: 2062 6163 6b65 6e64 2e72 656c 6174 696f   backend.relatio
+000019a0: 6e5f 6765 7428 7265 6c5f 6964 2c20 2770  n_get(rel_id, 'p
+000019b0: 6f73 7467 7265 7371 6c2f 3027 2c20 6973  ostgresql/0', is
+000019c0: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
+000019d0: 2020 2020 2020 2020 207b 2766 6f6f 273a           {'foo':
+000019e0: 2027 6261 7227 7d29 0a0a 2020 2020 6465   'bar'})..    de
+000019f0: 6620 7465 7374 5f61 6464 5f72 656c 6174  f test_add_relat
+00001a00: 696f 6e5f 7769 7468 5f72 656d 6f74 655f  ion_with_remote_
+00001a10: 6170 705f 6461 7461 2873 656c 6629 3a0a  app_data(self):.
+00001a20: 2020 2020 2020 2020 2320 6c61 6e67 7561          # langua
+00001a30: 6765 3d59 414d 4c0a 2020 2020 2020 2020  ge=YAML.        
+00001a40: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+00001a50: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+00001a60: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+00001a70: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00001a80: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00001a90: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00001aa0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00001ab0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+00001ac0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00001ad0: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+00001ae0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00001af0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00001b00: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00001b10: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00001b20: 2020 7265 6d6f 7465 5f61 7070 203d 2027    remote_app = '
+00001b30: 706f 7374 6772 6573 716c 270a 2020 2020  postgresql'.    
+00001b40: 2020 2020 7265 6c5f 6964 203d 2068 6172      rel_id = har
+00001b50: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00001b60: 6e28 2764 6227 2c20 7265 6d6f 7465 5f61  n('db', remote_a
+00001b70: 7070 290a 2020 2020 2020 2020 6861 726e  pp).        harn
+00001b80: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00001b90: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00001ba0: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
+00001bb0: 2761 7070 273a 2027 6461 7461 277d 290a  'app': 'data'}).
+00001bc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00001bd0: 6572 7449 7349 6e73 7461 6e63 6528 7265  ertIsInstance(re
+00001be0: 6c5f 6964 2c20 696e 7429 0a20 2020 2020  l_id, int).     
+00001bf0: 2020 2062 6163 6b65 6e64 203d 2068 6172     backend = har
+00001c00: 6e65 7373 2e5f 6261 636b 656e 640a 2020  ness._backend.  
+00001c10: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00001c20: 7445 7175 616c 285b 7265 6c5f 6964 5d2c  tEqual([rel_id],
+00001c30: 2062 6163 6b65 6e64 2e72 656c 6174 696f   backend.relatio
+00001c40: 6e5f 6964 7328 2764 6227 2929 0a20 2020  n_ids('db')).   
+00001c50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00001c60: 4571 7561 6c28 7b27 6170 7027 3a20 2764  Equal({'app': 'd
+00001c70: 6174 6127 7d2c 2062 6163 6b65 6e64 2e72  ata'}, backend.r
+00001c80: 656c 6174 696f 6e5f 6765 7428 7265 6c5f  elation_get(rel_
+00001c90: 6964 2c20 7265 6d6f 7465 5f61 7070 2c20  id, remote_app, 
+00001ca0: 6973 5f61 7070 3d54 7275 6529 290a 0a20  is_app=True)).. 
+00001cb0: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
+00001cc0: 7265 6c61 7469 6f6e 5f77 6974 685f 6f75  relation_with_ou
+00001cd0: 725f 696e 6974 6961 6c5f 6461 7461 2873  r_initial_data(s
+00001ce0: 656c 6629 3a0a 0a20 2020 2020 2020 2063  elf):..        c
+00001cf0: 6c61 7373 2049 6e69 7469 616c 4461 7461  lass InitialData
+00001d00: 5465 7374 6572 286f 7073 2e43 6861 726d  Tester(ops.Charm
+00001d10: 4261 7365 293a 0a20 2020 2020 2020 2020  Base):.         
+00001d20: 2020 2022 2222 5265 636f 7264 2074 6865     """Record the
+00001d30: 2072 656c 6174 696f 6e2d 6368 616e 6765   relation-change
+00001d40: 6420 6576 656e 7473 2e22 2222 0a0a 2020  d events."""..  
+00001d50: 2020 2020 2020 2020 2020 6465 6620 5f5f            def __
+00001d60: 696e 6974 5f5f 2873 656c 662c 2066 7261  init__(self, fra
+00001d70: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
+00001d80: 2020 2020 2020 2020 2073 7570 6572 2829           super()
+00001d90: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
+00001da0: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
+00001db0: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
+00001dc0: 6564 5f65 7665 6e74 7320 3d20 5b5d 0a20  ed_events = []. 
+00001dd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00001de0: 656c 662e 6672 616d 6577 6f72 6b2e 6f62  elf.framework.ob
+00001df0: 7365 7276 6528 7365 6c66 2e6f 6e2e 6462  serve(self.on.db
+00001e00: 5f72 656c 6174 696f 6e5f 6368 616e 6765  _relation_change
+00001e10: 642c 2073 656c 662e 5f6f 6e5f 6462 5f72  d, self._on_db_r
+00001e20: 656c 6174 696f 6e5f 6368 616e 6765 6429  elation_changed)
+00001e30: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00001e40: 6620 5f6f 6e5f 6462 5f72 656c 6174 696f  f _on_db_relatio
+00001e50: 6e5f 6368 616e 6765 6428 7365 6c66 2c20  n_changed(self, 
+00001e60: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
+00001e70: 2020 2020 2020 2020 7365 6c66 2e6f 6273          self.obs
+00001e80: 6572 7665 645f 6576 656e 7473 2e61 7070  erved_events.app
+00001e90: 656e 6428 6576 656e 7429 0a0a 2020 2020  end(event)..    
+00001ea0: 2020 2020 2320 6c61 6e67 7561 6765 3d59      # language=Y
+00001eb0: 414d 4c0a 2020 2020 2020 2020 6861 726e  AML.        harn
+00001ec0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00001ed0: 672e 4861 726e 6573 7328 496e 6974 6961  g.Harness(Initia
+00001ee0: 6c44 6174 6154 6573 7465 722c 206d 6574  lDataTester, met
+00001ef0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00001f00: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00001f10: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00001f20: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00001f30: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+00001f40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00001f50: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+00001f60: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00001f70: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+00001f80: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00001f90: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00001fa0: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
+00001fb0: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00001fc0: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
+00001fd0: 6c27 290a 2020 2020 2020 2020 6861 726e  l').        harn
+00001fe0: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00001ff0: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00002000: 2027 7465 7374 2d61 7070 272c 207b 276b   'test-app', {'k
+00002010: 273a 2027 7631 277d 290a 2020 2020 2020  ': 'v1'}).      
+00002020: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00002030: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00002040: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00002050: 2f30 272c 207b 2769 6e67 7265 7373 2d61  /0', {'ingress-a
+00002060: 6464 7265 7373 273a 2027 3139 322e 302e  ddress': '192.0.
+00002070: 322e 3127 7d29 0a20 2020 2020 2020 2062  2.1'}).        b
+00002080: 6163 6b65 6e64 203d 2068 6172 6e65 7373  ackend = harness
+00002090: 2e5f 6261 636b 656e 640a 2020 2020 2020  ._backend.      
+000020a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000020b0: 616c 287b 276b 273a 2027 7631 277d 2c20  al({'k': 'v1'}, 
+000020c0: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
+000020d0: 5f67 6574 2872 656c 5f69 642c 2027 7465  _get(rel_id, 'te
+000020e0: 7374 2d61 7070 272c 2069 735f 6170 703d  st-app', is_app=
+000020f0: 5472 7565 2929 0a20 2020 2020 2020 2073  True)).        s
+00002100: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00002110: 7b27 696e 6772 6573 732d 6164 6472 6573  {'ingress-addres
+00002120: 7327 3a20 2731 3932 2e30 2e32 2e31 277d  s': '192.0.2.1'}
+00002130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002140: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
+00002150: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
+00002160: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
+00002170: 702f 3027 2c20 6973 5f61 7070 3d46 616c  p/0', is_app=Fal
+00002180: 7365 2929 0a0a 2020 2020 2020 2020 6861  se))..        ha
+00002190: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+000021a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000021b0: 7445 7175 616c 287b 276b 273a 2027 7631  tEqual({'k': 'v1
+000021c0: 277d 2c20 6261 636b 656e 642e 7265 6c61  '}, backend.rela
+000021d0: 7469 6f6e 5f67 6574 2872 656c 5f69 642c  tion_get(rel_id,
+000021e0: 2027 7465 7374 2d61 7070 272c 2069 735f   'test-app', is_
+000021f0: 6170 703d 5472 7565 2929 0a20 2020 2020  app=True)).     
+00002200: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00002210: 7561 6c28 7b27 696e 6772 6573 732d 6164  ual({'ingress-ad
+00002220: 6472 6573 7327 3a20 2731 3932 2e30 2e32  dress': '192.0.2
+00002230: 2e31 277d 2c0a 2020 2020 2020 2020 2020  .1'},.          
+00002240: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00002250: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00002260: 6765 7428 7265 6c5f 6964 2c20 2774 6573  get(rel_id, 'tes
+00002270: 742d 6170 702f 3027 2c20 6973 5f61 7070  t-app/0', is_app
+00002280: 3d46 616c 7365 2929 0a20 2020 2020 2020  =False)).       
+00002290: 2023 204d 616b 6520 7375 7265 206e 6f20   # Make sure no 
+000022a0: 7265 6c61 7469 6f6e 2d63 6861 6e67 6564  relation-changed
+000022b0: 2065 7665 6e74 7320 6172 6520 656d 6974   events are emit
+000022c0: 7465 6420 666f 7220 6f75 7220 6f77 6e20  ted for our own 
+000022d0: 6461 7461 2062 6167 732e 0a20 2020 2020  data bags..     
+000022e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000022f0: 7561 6c28 5b5d 2c20 6861 726e 6573 732e  ual([], harness.
+00002300: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+00002310: 7665 6e74 7329 0a0a 2020 2020 2020 2020  vents)..        
+00002320: 2320 4120 7265 6d6f 7465 2075 6e69 7420  # A remote unit 
+00002330: 6361 6e20 7374 696c 6c20 7570 6461 7465  can still update
+00002340: 206f 7572 2061 7070 2072 656c 6174 696f   our app relatio
+00002350: 6e20 6461 7461 2062 6167 2073 696e 6365  n data bag since
+00002360: 206f 7572 2075 6e69 7420 6973 206e 6f74   our unit is not
+00002370: 2061 206c 6561 6465 722e 0a20 2020 2020   a leader..     
+00002380: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
+00002390: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+000023a0: 7265 6c5f 6964 2c20 2774 6573 742d 6170  rel_id, 'test-ap
+000023b0: 7027 2c20 7b27 6b27 3a20 2776 3227 7d29  p', {'k': 'v2'})
+000023c0: 0a20 2020 2020 2020 2023 2041 6e64 2077  .        # And w
+000023d0: 6520 6765 7420 616e 2065 7665 6e74 0a20  e get an event. 
+000023e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000023f0: 7274 4571 7561 6c28 5b5d 2c20 6861 726e  rtEqual([], harn
+00002400: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+00002410: 6564 5f65 7665 6e74 7329 0a20 2020 2020  ed_events).     
+00002420: 2020 2023 2057 6520 6361 6e20 616c 736f     # We can also
+00002430: 2075 7064 6174 6520 6f75 7220 6f77 6e20   update our own 
+00002440: 7265 6c61 7469 6f6e 2064 6174 612c 2065  relation data, e
+00002450: 7665 6e20 6966 2069 7420 6973 2061 2062  ven if it is a b
+00002460: 6974 2027 6368 6561 7479 270a 2020 2020  it 'cheaty'.    
+00002470: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00002480: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00002490: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
+000024a0: 7070 2f30 272c 207b 2769 6e67 7265 7373  pp/0', {'ingress
+000024b0: 2d61 6464 7265 7373 273a 2027 3139 322e  -address': '192.
+000024c0: 302e 322e 3227 7d29 0a20 2020 2020 2020  0.2.2'}).       
+000024d0: 2023 2042 7574 206e 6f20 6576 656e 7420   # But no event 
+000024e0: 6861 7070 656e 730a 0a20 2020 2020 2020  happens..       
+000024f0: 2023 2055 7064 6174 696e 6720 6f75 7220   # Updating our 
+00002500: 6461 7461 2061 7070 2072 656c 6174 696f  data app relatio
+00002510: 6e20 6461 7461 2062 6167 2061 6e64 206f  n data bag and o
+00002520: 7572 2075 6e69 7420 6461 7461 2062 6167  ur unit data bag
+00002530: 2064 6f65 7320 6e6f 7420 6765 6e65 7261   does not genera
+00002540: 7465 2065 7665 6e74 732e 0a20 2020 2020  te events..     
+00002550: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
+00002560: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
+00002570: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00002580: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+00002590: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
+000025a0: 7070 272c 207b 276b 273a 2027 7633 277d  pp', {'k': 'v3'}
+000025b0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+000025c0: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+000025d0: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
+000025e0: 7465 7374 2d61 7070 2f30 272c 207b 2769  test-app/0', {'i
+000025f0: 6e67 7265 7373 2d61 6464 7265 7373 273a  ngress-address':
+00002600: 2027 3139 322e 302e 322e 3227 7d29 0a20   '192.0.2.2'}). 
+00002610: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00002620: 7274 4571 7561 6c28 5b5d 2c20 6861 726e  rtEqual([], harn
+00002630: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+00002640: 6564 5f65 7665 6e74 7329 0a0a 2020 2020  ed_events)..    
+00002650: 6465 6620 7465 7374 5f61 6464 5f70 6565  def test_add_pee
+00002660: 725f 7265 6c61 7469 6f6e 5f77 6974 685f  r_relation_with_
+00002670: 696e 6974 6961 6c5f 6461 7461 5f6c 6561  initial_data_lea
+00002680: 6465 7228 7365 6c66 293a 0a0a 2020 2020  der(self):..    
+00002690: 2020 2020 636c 6173 7320 496e 6974 6961      class Initia
+000026a0: 6c44 6174 6154 6573 7465 7228 6f70 732e  lDataTester(ops.
+000026b0: 4368 6172 6d42 6173 6529 3a0a 2020 2020  CharmBase):.    
+000026c0: 2020 2020 2020 2020 2222 2252 6563 6f72          """Recor
+000026d0: 6420 7468 6520 7265 6c61 7469 6f6e 2d63  d the relation-c
+000026e0: 6861 6e67 6564 2065 7665 6e74 732e 2222  hanged events.""
+000026f0: 220a 0a20 2020 2020 2020 2020 2020 2064  "..            d
+00002700: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00002710: 2c20 6672 616d 6577 6f72 6b29 3a0a 2020  , framework):.  
+00002720: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00002730: 7065 7228 292e 5f5f 696e 6974 5f5f 2866  per().__init__(f
+00002740: 7261 6d65 776f 726b 290a 2020 2020 2020  ramework).      
+00002750: 2020 2020 2020 2020 2020 7365 6c66 2e6f            self.o
+00002760: 6273 6572 7665 645f 6576 656e 7473 203d  bserved_events =
+00002770: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00002780: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
+00002790: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
+000027a0: 6f6e 2e63 6c75 7374 6572 5f72 656c 6174  on.cluster_relat
+000027b0: 696f 6e5f 6368 616e 6765 642c 0a20 2020  ion_changed,.   
+000027c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027e0: 2020 2020 7365 6c66 2e5f 6f6e 5f63 6c75      self._on_clu
+000027f0: 7374 6572 5f72 656c 6174 696f 6e5f 6368  ster_relation_ch
+00002800: 616e 6765 6429 0a0a 2020 2020 2020 2020  anged)..        
+00002810: 2020 2020 6465 6620 5f6f 6e5f 636c 7573      def _on_clus
+00002820: 7465 725f 7265 6c61 7469 6f6e 5f63 6861  ter_relation_cha
+00002830: 6e67 6564 2873 656c 662c 2065 7665 6e74  nged(self, event
+00002840: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00002850: 2020 2073 656c 662e 6f62 7365 7276 6564     self.observed
+00002860: 5f65 7665 6e74 732e 6170 7065 6e64 2865  _events.append(e
+00002870: 7665 6e74 290a 0a20 2020 2020 2020 2023  vent)..        #
+00002880: 206c 616e 6775 6167 653d 5941 4d4c 0a20   language=YAML. 
+00002890: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+000028a0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+000028b0: 6e65 7373 2849 6e69 7469 616c 4461 7461  ness(InitialData
+000028c0: 5465 7374 6572 2c20 6d65 7461 3d27 2727  Tester, meta='''
+000028d0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+000028e0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+000028f0: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
+00002900: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00002910: 6c75 7374 6572 3a0a 2020 2020 2020 2020  luster:.        
+00002920: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00002930: 7266 6163 653a 2063 6c75 7374 6572 0a20  rface: cluster. 
+00002940: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00002950: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00002960: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00002970: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00002980: 2023 2054 4f44 4f3a 2064 6d69 7472 6969   # TODO: dmitrii
+00002990: 7320 3230 3230 2d30 342d 3037 2074 6573  s 2020-04-07 tes
+000029a0: 7420 6120 6d69 6e69 6f6e 2075 6e69 7420  t a minion unit 
+000029b0: 616e 6420 696e 6974 6961 6c20 7065 6572  and initial peer
+000029c0: 2072 656c 6174 696f 6e20 6170 7020 6461   relation app da
+000029d0: 7461 0a20 2020 2020 2020 2023 2065 7665  ta.        # eve
+000029e0: 6e74 7320 7768 656e 2074 6865 2068 6172  nts when the har
+000029f0: 6e65 7373 2062 6567 696e 7320 746f 2065  ness begins to e
+00002a00: 6d69 7420 6576 656e 7473 2066 6f72 2069  mit events for i
+00002a10: 6e69 7469 616c 2064 6174 612e 0a20 2020  nitial data..   
+00002a20: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+00002a30: 5f6c 6561 6465 7228 6973 5f6c 6561 6465  _leader(is_leade
+00002a40: 723d 5472 7565 290a 2020 2020 2020 2020  r=True).        
+00002a50: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+00002a60: 2e61 6464 5f72 656c 6174 696f 6e28 2763  .add_relation('c
+00002a70: 6c75 7374 6572 272c 2027 7465 7374 2d61  luster', 'test-a
+00002a80: 7070 2729 0a20 2020 2020 2020 2068 6172  pp').        har
+00002a90: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00002aa0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00002ab0: 2c20 2774 6573 742d 6170 7027 2c20 7b27  , 'test-app', {'
+00002ac0: 6b27 3a20 2776 277d 290a 2020 2020 2020  k': 'v'}).      
+00002ad0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00002ae0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00002af0: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00002b00: 2f30 272c 207b 2769 6e67 7265 7373 2d61  /0', {'ingress-a
+00002b10: 6464 7265 7373 273a 2027 3139 322e 302e  ddress': '192.0.
+00002b20: 322e 3127 7d29 0a20 2020 2020 2020 2062  2.1'}).        b
+00002b30: 6163 6b65 6e64 203d 2068 6172 6e65 7373  ackend = harness
+00002b40: 2e5f 6261 636b 656e 640a 2020 2020 2020  ._backend.      
+00002b50: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00002b60: 616c 287b 276b 273a 2027 7627 7d2c 2062  al({'k': 'v'}, b
+00002b70: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00002b80: 6765 7428 7265 6c5f 6964 2c20 2774 6573  get(rel_id, 'tes
+00002b90: 742d 6170 7027 2c20 6973 5f61 7070 3d54  t-app', is_app=T
+00002ba0: 7275 6529 290a 2020 2020 2020 2020 7365  rue)).        se
+00002bb0: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
+00002bc0: 2769 6e67 7265 7373 2d61 6464 7265 7373  'ingress-address
+00002bd0: 273a 2027 3139 322e 302e 322e 3127 7d2c  ': '192.0.2.1'},
+00002be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002bf0: 2020 2020 2020 2020 2020 6261 636b 656e            backen
+00002c00: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
+00002c10: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00002c20: 2f30 272c 2069 735f 6170 703d 4661 6c73  /0', is_app=Fals
+00002c30: 6529 290a 0a20 2020 2020 2020 2068 6172  e))..        har
+00002c40: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+00002c50: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00002c60: 4571 7561 6c28 7b27 6b27 3a20 2776 277d  Equal({'k': 'v'}
+00002c70: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
+00002c80: 6f6e 5f67 6574 2872 656c 5f69 642c 2027  on_get(rel_id, '
+00002c90: 7465 7374 2d61 7070 272c 2069 735f 6170  test-app', is_ap
+00002ca0: 703d 5472 7565 2929 0a20 2020 2020 2020  p=True)).       
+00002cb0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00002cc0: 6c28 7b27 696e 6772 6573 732d 6164 6472  l({'ingress-addr
+00002cd0: 6573 7327 3a20 2731 3932 2e30 2e32 2e31  ess': '192.0.2.1
+00002ce0: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00002cf0: 2020 2020 2020 2020 2020 2020 2062 6163               bac
+00002d00: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00002d10: 7428 7265 6c5f 6964 2c20 2774 6573 742d  t(rel_id, 'test-
+00002d20: 6170 702f 3027 2c20 6973 5f61 7070 3d46  app/0', is_app=F
+00002d30: 616c 7365 2929 0a20 2020 2020 2020 2023  alse)).        #
+00002d40: 204d 616b 6520 7375 7265 206e 6f20 7265   Make sure no re
+00002d50: 6c61 7469 6f6e 2d63 6861 6e67 6564 2065  lation-changed e
+00002d60: 7665 6e74 7320 6172 6520 656d 6974 7465  vents are emitte
+00002d70: 6420 666f 7220 6f75 7220 6f77 6e20 6461  d for our own da
+00002d80: 7461 2062 6167 732e 0a20 2020 2020 2020  ta bags..       
+00002d90: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00002da0: 6c28 5b5d 2c20 6861 726e 6573 732e 6368  l([], harness.ch
+00002db0: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
+00002dc0: 6e74 7329 0a0a 2020 2020 2020 2020 2320  nts)..        # 
+00002dd0: 5570 6461 7469 6e67 206f 7572 2061 7070  Updating our app
+00002de0: 2072 656c 6174 696f 6e20 6461 7461 2062   relation data b
+00002df0: 6167 2061 6e64 206f 7572 2075 6e69 7420  ag and our unit 
+00002e00: 6461 7461 2062 6167 2064 6f65 7320 6e6f  data bag does no
+00002e10: 7420 7472 6967 6765 7220 6576 656e 7473  t trigger events
+00002e20: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00002e30: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+00002e40: 5f64 6174 6128 7265 6c5f 6964 2c20 2774  _data(rel_id, 't
+00002e50: 6573 742d 6170 7027 2c20 7b27 6b27 3a20  est-app', {'k': 
+00002e60: 2776 3227 7d29 0a20 2020 2020 2020 2068  'v2'}).        h
+00002e70: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+00002e80: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+00002e90: 6964 2c20 2774 6573 742d 6170 702f 3027  id, 'test-app/0'
+00002ea0: 2c20 7b27 696e 6772 6573 732d 6164 6472  , {'ingress-addr
+00002eb0: 6573 7327 3a20 2731 3932 2e30 2e32 2e32  ess': '192.0.2.2
+00002ec0: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
+00002ed0: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
+00002ee0: 2068 6172 6e65 7373 2e63 6861 726d 2e6f   harness.charm.o
+00002ef0: 6273 6572 7665 645f 6576 656e 7473 290a  bserved_events).
+00002f00: 0a20 2020 2020 2020 2023 2049 6620 6f75  .        # If ou
+00002f10: 7220 756e 6974 2062 6563 6f6d 6573 2061  r unit becomes a
+00002f20: 206d 696e 696f 6e2c 2075 7064 6174 696e   minion, updatin
+00002f30: 6720 6170 7020 7265 6c61 7469 6f6e 2064  g app relation d
+00002f40: 6174 6120 696e 6469 7265 6374 6c79 2062  ata indirectly b
+00002f50: 6563 6f6d 6573 2070 6f73 7369 626c 650a  ecomes possible.
+00002f60: 2020 2020 2020 2020 2320 616e 6420 6f75          # and ou
+00002f70: 7220 6368 6172 6d20 6765 7473 206e 6f74  r charm gets not
+00002f80: 6966 6963 6174 696f 6e73 2e0a 2020 2020  ifications..    
+00002f90: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
+00002fa0: 6c65 6164 6572 2846 616c 7365 290a 2020  leader(False).  
+00002fb0: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+00002fc0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00002fd0: 7461 2872 656c 5f69 642c 2027 7465 7374  ta(rel_id, 'test
+00002fe0: 2d61 7070 272c 207b 276b 273a 2027 7633  -app', {'k': 'v3
+00002ff0: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
+00003000: 2e61 7373 6572 7445 7175 616c 287b 276b  .assertEqual({'k
+00003010: 273a 2027 7633 277d 2c20 6261 636b 656e  ': 'v3'}, backen
+00003020: 642e 7265 6c61 7469 6f6e 5f67 6574 2872  d.relation_get(r
+00003030: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00003040: 272c 2069 735f 6170 703d 5472 7565 2929  ', is_app=True))
+00003050: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00003060: 7365 7274 5472 7565 286c 656e 2868 6172  sertTrue(len(har
+00003070: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
+00003080: 7665 645f 6576 656e 7473 292c 2031 290a  ved_events), 1).
+00003090: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000030a0: 6572 7449 7349 6e73 7461 6e63 6528 6861  ertIsInstance(ha
+000030b0: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+000030c0: 7276 6564 5f65 7665 6e74 735b 305d 2c20  rved_events[0], 
+000030d0: 6f70 732e 5265 6c61 7469 6f6e 4576 656e  ops.RelationEven
+000030e0: 7429 0a0a 2020 2020 6465 6620 7465 7374  t)..    def test
+000030f0: 5f72 656c 6174 696f 6e5f 6765 745f 7768  _relation_get_wh
+00003100: 656e 5f62 726f 6b65 6e28 7365 6c66 293a  en_broken(self):
+00003110: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00003120: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+00003130: 6172 6e65 7373 2852 656c 6174 696f 6e42  arness(RelationB
+00003140: 726f 6b65 6e54 6573 7465 722c 206d 6574  rokenTester, met
+00003150: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00003160: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00003170: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00003180: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+00003190: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+000031a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000031b0: 696e 7465 7266 6163 653a 2066 6f6f 666f  interface: foofo
+000031c0: 6f0a 2020 2020 2020 2020 2020 2020 2727  o.            ''
+000031d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+000031e0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+000031f0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+00003200: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
+00003210: 6e28 290a 2020 2020 2020 2020 6861 726e  n().        harn
+00003220: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+00003230: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
+00003240: 7328 2766 6f6f 2729 0a0a 2020 2020 2020  s('foo')..      
+00003250: 2020 2320 7265 6c61 7469 6f6e 2072 656d    # relation rem
+00003260: 6f74 6520 6170 7020 6973 204e 6f6e 6520  ote app is None 
+00003270: 746f 206d 6972 726f 7220 7072 6f64 7563  to mirror produc
+00003280: 7469 6f6e 204a 756a 7520 6265 6861 7669  tion Juju behavi
+00003290: 6f72 2077 6865 7265 204a 756a 7520 646f  or where Juju do
+000032a0: 6573 6e27 740a 2020 2020 2020 2020 2320  esn't.        # 
+000032b0: 636f 6d6d 756e 6963 6174 6520 7468 6520  communicate the 
+000032c0: 7265 6d6f 7465 2061 7070 2074 6f20 6f70  remote app to op
+000032d0: 732e 0a20 2020 2020 2020 2072 656c 5f69  s..        rel_i
+000032e0: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+000032f0: 7265 6c61 7469 6f6e 2827 666f 6f27 2c20  relation('foo', 
+00003300: 4e6f 6e65 290a 0a20 2020 2020 2020 2077  None)..        w
+00003310: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
+00003320: 7328 4b65 7945 7272 6f72 2c20 6d61 7463  s(KeyError, matc
+00003330: 683d 2774 7279 696e 6720 746f 2061 6363  h='trying to acc
+00003340: 6573 7320 7265 6d6f 7465 2061 7070 2064  ess remote app d
+00003350: 6174 6127 293a 0a20 2020 2020 2020 2020  ata'):.         
+00003360: 2020 2068 6172 6e65 7373 2e72 656d 6f76     harness.remov
+00003370: 655f 7265 6c61 7469 6f6e 2872 656c 5f69  e_relation(rel_i
+00003380: 6429 0a0a 2020 2020 6465 6620 7465 7374  d)..    def test
+00003390: 5f72 656d 6f76 655f 7265 6c61 7469 6f6e  _remove_relation
+000033a0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000033b0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+000033c0: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
+000033d0: 6c61 7469 6f6e 4576 656e 7443 6861 726d  lationEventCharm
+000033e0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+000033f0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+00003400: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+00003410: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+00003420: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00003430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003440: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+00003450: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+00003460: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00003470: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00003480: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00003490: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+000034a0: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
+000034b0: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
+000034c0: 6572 7665 5f72 656c 6174 696f 6e5f 6576  erve_relation_ev
+000034d0: 656e 7473 2827 6462 2729 0a20 2020 2020  ents('db').     
+000034e0: 2020 2023 2046 6972 7374 2063 7265 6174     # First creat
+000034f0: 6520 6120 7265 6c61 7469 6f6e 0a20 2020  e a relation.   
+00003500: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
+00003510: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00003520: 6f6e 2827 6462 272c 2027 706f 7374 6772  on('db', 'postgr
+00003530: 6573 716c 2729 0a20 2020 2020 2020 2073  esql').        s
+00003540: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+00003550: 616e 6365 2872 656c 5f69 642c 2069 6e74  ance(rel_id, int
+00003560: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00003570: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+00003580: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
+00003590: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
+000035a0: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
+000035b0: 726e 6573 732e 5f62 6163 6b65 6e64 0a20  rness._backend. 
+000035c0: 2020 2020 2020 2023 2043 6865 636b 2072         # Check r
+000035d0: 656c 6174 696f 6e20 7761 7320 6372 6561  elation was crea
+000035e0: 7465 640a 2020 2020 2020 2020 7365 6c66  ted.        self
+000035f0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+00003600: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
+00003610: 7328 2764 6227 292c 205b 7265 6c5f 6964  s('db'), [rel_id
+00003620: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00003630: 6173 7365 7274 4571 7561 6c28 6261 636b  assertEqual(back
+00003640: 656e 642e 7265 6c61 7469 6f6e 5f6c 6973  end.relation_lis
+00003650: 7428 7265 6c5f 6964 292c 205b 2770 6f73  t(rel_id), ['pos
+00003660: 7467 7265 7371 6c2f 3027 5d29 0a20 2020  tgresql/0']).   
+00003670: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+00003680: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+00003690: 6573 6574 3d54 7275 6529 2020 2320 6372  eset=True)  # cr
+000036a0: 6561 7465 6420 6576 656e 7420 6967 6e6f  eated event igno
+000036b0: 7265 640a 2020 2020 2020 2020 2320 4e6f  red.        # No
+000036c0: 7720 7265 6d6f 7665 2072 656c 6174 696f  w remove relatio
+000036d0: 6e0a 2020 2020 2020 2020 6861 726e 6573  n.        harnes
+000036e0: 732e 7265 6d6f 7665 5f72 656c 6174 696f  s.remove_relatio
+000036f0: 6e28 7265 6c5f 6964 290a 2020 2020 2020  n(rel_id).      
+00003700: 2020 2320 4368 6563 6b20 7265 6c61 7469    # Check relati
+00003710: 6f6e 206e 6f20 6c6f 6e67 6572 2065 7869  on no longer exi
+00003720: 7374 730a 2020 2020 2020 2020 7365 6c66  sts.        self
+00003730: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+00003740: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
+00003750: 7328 2764 6227 292c 205b 5d29 0a20 2020  s('db'), []).   
+00003760: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00003770: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+00003780: 696f 6e4e 6f74 466f 756e 6445 7272 6f72  ionNotFoundError
+00003790: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
+000037a0: 6f6e 5f6c 6973 742c 2072 656c 5f69 6429  on_list, rel_id)
+000037b0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+000037c0: 2072 656c 6174 696f 6e20 6272 6f6b 656e   relation broken
+000037d0: 2065 7665 6e74 2069 7320 7261 6973 6564   event is raised
+000037e0: 2077 6974 6820 636f 7272 6563 7420 6461   with correct da
+000037f0: 7461 0a20 2020 2020 2020 2063 6861 6e67  ta.        chang
+00003800: 6573 203d 2068 6172 6e65 7373 2e63 6861  es = harness.cha
+00003810: 726d 2e67 6574 5f63 6861 6e67 6573 2829  rm.get_changes()
+00003820: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00003830: 7365 7274 4571 7561 6c28 6368 616e 6765  sertEqual(change
+00003840: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+00003850: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00003860: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
+00003870: 6e2d 6465 7061 7274 6564 272c 0a20 2020  n-departed',.   
+00003880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003890: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+000038a0: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
+000038b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038c0: 2020 2027 6461 7461 273a 207b 2761 7070     'data': {'app
+000038d0: 273a 2027 706f 7374 6772 6573 716c 272c  ': 'postgresql',
+000038e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000038f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003900: 2020 2020 2775 6e69 7427 3a20 2770 6f73      'unit': 'pos
+00003910: 7467 7265 7371 6c2f 3027 2c0a 2020 2020  tgresql/0',.    
+00003920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003930: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00003940: 6465 7061 7274 696e 675f 756e 6974 273a  departing_unit':
+00003950: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
+00003960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003980: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
+00003990: 273a 2030 7d7d 290a 2020 2020 2020 2020  ': 0}}).        
+000039a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000039b0: 2863 6861 6e67 6573 5b31 5d2c 0a20 2020  (changes[1],.   
+000039c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000039d0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+000039e0: 7265 6c61 7469 6f6e 2d62 726f 6b65 6e27  relation-broken'
+000039f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003a00: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+00003a10: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
 00003a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a30: 2020 2020 2027 7265 6c61 7469 6f6e 5f69       'relation_i
-00003a40: 6427 3a20 307d 7d29 0a20 2020 2020 2020  d': 0}}).       
-00003a50: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00003a60: 6c28 6368 616e 6765 735b 315d 2c0a 2020  l(changes[1],.  
-00003a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a80: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-00003a90: 2772 656c 6174 696f 6e2d 6272 6f6b 656e  'relation-broken
-00003aa0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00003ab0: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00003ac0: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
-00003ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ae0: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
-00003af0: 207b 2761 7070 273a 2027 706f 7374 6772   {'app': 'postgr
-00003b00: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
-00003b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b20: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
-00003b30: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00003b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b50: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-00003b60: 7469 6f6e 5f69 6427 3a20 7265 6c5f 6964  tion_id': rel_id
-00003b70: 7d7d 290a 0a20 2020 2064 6566 2074 6573  }})..    def tes
-00003b80: 745f 7265 6d6f 7665 5f73 7065 6369 6669  t_remove_specifi
-00003b90: 635f 7265 6c61 7469 6f6e 5f69 6428 7365  c_relation_id(se
-00003ba0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-00003bb0: 6e65 7373 203d 2048 6172 6e65 7373 2852  ness = Harness(R
-00003bc0: 656c 6174 696f 6e45 7665 6e74 4368 6172  elationEventChar
-00003bd0: 6d2c 206d 6574 613d 2727 270a 2020 2020  m, meta='''.    
-00003be0: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-00003bf0: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
-00003c00: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
-00003c10: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-00003c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003c30: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-00003c40: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
-00003c50: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-00003c60: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-00003c70: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-00003c80: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00003c90: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
-00003ca0: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
-00003cb0: 7365 7276 655f 7265 6c61 7469 6f6e 5f65  serve_relation_e
-00003cc0: 7665 6e74 7328 2764 6227 290a 0a20 2020  vents('db')..   
-00003cd0: 2020 2020 2023 2043 7265 6174 6520 7468       # Create th
-00003ce0: 6520 6669 7273 7420 7265 6c61 7469 6f6e  e first relation
-00003cf0: 0a20 2020 2020 2020 2072 656c 5f69 645f  .        rel_id_
-00003d00: 3120 3d20 6861 726e 6573 732e 6164 645f  1 = harness.add_
-00003d10: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
-00003d20: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
-00003d30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00003d40: 4973 496e 7374 616e 6365 2872 656c 5f69  IsInstance(rel_i
-00003d50: 645f 312c 2069 6e74 290a 2020 2020 2020  d_1, int).      
-00003d60: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
-00003d70: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-00003d80: 6964 5f31 2c20 2770 6f73 7467 7265 7371  id_1, 'postgresq
-00003d90: 6c2f 3027 290a 2020 2020 2020 2020 6261  l/0').        ba
-00003da0: 636b 656e 6420 3d20 6861 726e 6573 732e  ckend = harness.
-00003db0: 5f62 6163 6b65 6e64 0a20 2020 2020 2020  _backend.       
-00003dc0: 2023 2043 6865 636b 2072 656c 6174 696f   # Check relatio
-00003dd0: 6e20 7761 7320 6372 6561 7465 640a 2020  n was created.  
-00003de0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00003df0: 7449 6e28 7265 6c5f 6964 5f31 2c20 6261  tIn(rel_id_1, ba
-00003e00: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
-00003e10: 6473 2827 6462 2729 290a 2020 2020 2020  ds('db')).      
-00003e20: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00003e30: 616c 2862 6163 6b65 6e64 2e72 656c 6174  al(backend.relat
-00003e40: 696f 6e5f 6c69 7374 2872 656c 5f69 645f  ion_list(rel_id_
-00003e50: 3129 2c20 5b27 706f 7374 6772 6573 716c  1), ['postgresql
-00003e60: 2f30 275d 290a 2020 2020 2020 2020 6861  /0']).        ha
-00003e70: 726e 6573 732e 6368 6172 6d2e 6765 745f  rness.charm.get_
-00003e80: 6368 616e 6765 7328 7265 7365 743d 5472  changes(reset=Tr
-00003e90: 7565 2920 2023 2063 7265 6174 6564 2065  ue)  # created e
-00003ea0: 7665 6e74 2069 676e 6f72 6564 0a0a 2020  vent ignored..  
-00003eb0: 2020 2020 2020 2320 4372 6561 7465 2074        # Create t
-00003ec0: 6865 2073 6563 6f6e 6420 7265 6c61 7469  he second relati
-00003ed0: 6f6e 0a20 2020 2020 2020 2072 656c 5f69  on.        rel_i
-00003ee0: 645f 3220 3d20 6861 726e 6573 732e 6164  d_2 = harness.ad
-00003ef0: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
-00003f00: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
-00003f10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00003f20: 7274 4973 496e 7374 616e 6365 2872 656c  rtIsInstance(rel
-00003f30: 5f69 645f 322c 2069 6e74 290a 2020 2020  _id_2, int).    
-00003f40: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-00003f50: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-00003f60: 6c5f 6964 5f32 2c20 2770 6f73 7467 7265  l_id_2, 'postgre
-00003f70: 7371 6c2f 3127 290a 2020 2020 2020 2020  sql/1').        
-00003f80: 6261 636b 656e 6420 3d20 6861 726e 6573  backend = harnes
-00003f90: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
-00003fa0: 2020 2023 2043 6865 636b 2072 656c 6174     # Check relat
-00003fb0: 696f 6e20 7761 7320 6372 6561 7465 6420  ion was created 
-00003fc0: 616e 6420 626f 7468 2072 656c 6174 696f  and both relatio
-00003fd0: 6e73 2065 7869 7374 0a20 2020 2020 2020  ns exist.       
-00003fe0: 2073 656c 662e 6173 7365 7274 496e 2872   self.assertIn(r
-00003ff0: 656c 5f69 645f 312c 2062 6163 6b65 6e64  el_id_1, backend
-00004000: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
-00004010: 6227 2929 0a20 2020 2020 2020 2073 656c  b')).        sel
-00004020: 662e 6173 7365 7274 496e 2872 656c 5f69  f.assertIn(rel_i
-00004030: 645f 322c 2062 6163 6b65 6e64 2e72 656c  d_2, backend.rel
-00004040: 6174 696f 6e5f 6964 7328 2764 6227 2929  ation_ids('db'))
-00004050: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00004060: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
-00004070: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
-00004080: 7265 6c5f 6964 5f32 292c 205b 2770 6f73  rel_id_2), ['pos
-00004090: 7467 7265 7371 6c2f 3127 5d29 0a20 2020  tgresql/1']).   
-000040a0: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
-000040b0: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
-000040c0: 6573 6574 3d54 7275 6529 2020 2320 6372  eset=True)  # cr
-000040d0: 6561 7465 6420 6576 656e 7420 6967 6e6f  eated event igno
-000040e0: 7265 640a 0a20 2020 2020 2020 2023 204e  red..        # N
-000040f0: 6f77 2072 656d 6f76 6520 7365 636f 6e64  ow remove second
-00004100: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
-00004110: 2020 6861 726e 6573 732e 7265 6d6f 7665    harness.remove
-00004120: 5f72 656c 6174 696f 6e28 7265 6c5f 6964  _relation(rel_id
-00004130: 5f32 290a 2020 2020 2020 2020 2320 4368  _2).        # Ch
-00004140: 6563 6b20 7365 636f 6e64 2072 656c 6174  eck second relat
-00004150: 696f 6e20 6e6f 206c 6f6e 6765 7220 6578  ion no longer ex
-00004160: 6973 7473 2062 7574 2066 6972 7374 2064  ists but first d
-00004170: 6f65 730a 2020 2020 2020 2020 7365 6c66  oes.        self
-00004180: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
-00004190: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
-000041a0: 7328 2764 6227 292c 205b 7265 6c5f 6964  s('db'), [rel_id
-000041b0: 5f31 5d29 0a20 2020 2020 2020 2073 656c  _1]).        sel
-000041c0: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
-000041d0: 656c 6174 696f 6e4e 6f74 466f 756e 6445  elationNotFoundE
-000041e0: 7272 6f72 2c20 6261 636b 656e 642e 7265  rror, backend.re
-000041f0: 6c61 7469 6f6e 5f6c 6973 742c 2072 656c  lation_list, rel
-00004200: 5f69 645f 3229 0a0a 2020 2020 2020 2020  _id_2)..        
-00004210: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
-00004220: 2062 726f 6b65 6e20 6576 656e 7420 6973   broken event is
-00004230: 2072 6169 7365 6420 7769 7468 2063 6f72   raised with cor
-00004240: 7265 6374 2064 6174 610a 2020 2020 2020  rect data.      
-00004250: 2020 6368 616e 6765 7320 3d20 6861 726e    changes = harn
-00004260: 6573 732e 6368 6172 6d2e 6765 745f 6368  ess.charm.get_ch
-00004270: 616e 6765 7328 290a 2020 2020 2020 2020  anges().        
-00004280: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00004290: 2863 6861 6e67 6573 5b30 5d2c 0a20 2020  (changes[0],.   
+00003a30: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
+00003a40: 7b27 6170 7027 3a20 2770 6f73 7467 7265  {'app': 'postgre
+00003a50: 7371 6c27 2c0a 2020 2020 2020 2020 2020  sql',.          
+00003a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a70: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
+00003a80: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00003a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003aa0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00003ab0: 696f 6e5f 6964 273a 2072 656c 5f69 647d  ion_id': rel_id}
+00003ac0: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
+00003ad0: 5f72 656d 6f76 655f 7370 6563 6966 6963  _remove_specific
+00003ae0: 5f72 656c 6174 696f 6e5f 6964 2873 656c  _relation_id(sel
+00003af0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00003b00: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00003b10: 672e 4861 726e 6573 7328 5265 6c61 7469  g.Harness(Relati
+00003b20: 6f6e 4576 656e 7443 6861 726d 2c20 6d65  onEventCharm, me
+00003b30: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+00003b40: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+00003b50: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+00003b60: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+00003b70: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
+00003b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b90: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00003ba0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00003bb0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00003bc0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00003bd0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00003be0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00003bf0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+00003c00: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+00003c10: 5f72 656c 6174 696f 6e5f 6576 656e 7473  _relation_events
+00003c20: 2827 6462 2729 0a0a 2020 2020 2020 2020  ('db')..        
+00003c30: 2320 4372 6561 7465 2074 6865 2066 6972  # Create the fir
+00003c40: 7374 2072 656c 6174 696f 6e0a 2020 2020  st relation.    
+00003c50: 2020 2020 7265 6c5f 6964 5f31 203d 2068      rel_id_1 = h
+00003c60: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00003c70: 696f 6e28 2764 6227 2c20 2770 6f73 7467  ion('db', 'postg
+00003c80: 7265 7371 6c27 290a 2020 2020 2020 2020  resql').        
+00003c90: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+00003ca0: 7461 6e63 6528 7265 6c5f 6964 5f31 2c20  tance(rel_id_1, 
+00003cb0: 696e 7429 0a20 2020 2020 2020 2068 6172  int).        har
+00003cc0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00003cd0: 6e5f 756e 6974 2872 656c 5f69 645f 312c  n_unit(rel_id_1,
+00003ce0: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
+00003cf0: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
+00003d00: 203d 2068 6172 6e65 7373 2e5f 6261 636b   = harness._back
+00003d10: 656e 640a 2020 2020 2020 2020 2320 4368  end.        # Ch
+00003d20: 6563 6b20 7265 6c61 7469 6f6e 2077 6173  eck relation was
+00003d30: 2063 7265 6174 6564 0a20 2020 2020 2020   created.       
+00003d40: 2073 656c 662e 6173 7365 7274 496e 2872   self.assertIn(r
+00003d50: 656c 5f69 645f 312c 2062 6163 6b65 6e64  el_id_1, backend
+00003d60: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
+00003d70: 6227 2929 0a20 2020 2020 2020 2073 656c  b')).        sel
+00003d80: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+00003d90: 636b 656e 642e 7265 6c61 7469 6f6e 5f6c  ckend.relation_l
+00003da0: 6973 7428 7265 6c5f 6964 5f31 292c 205b  ist(rel_id_1), [
+00003db0: 2770 6f73 7467 7265 7371 6c2f 3027 5d29  'postgresql/0'])
+00003dc0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00003dd0: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
+00003de0: 6573 2872 6573 6574 3d54 7275 6529 2020  es(reset=True)  
+00003df0: 2320 6372 6561 7465 6420 6576 656e 7420  # created event 
+00003e00: 6967 6e6f 7265 640a 0a20 2020 2020 2020  ignored..       
+00003e10: 2023 2043 7265 6174 6520 7468 6520 7365   # Create the se
+00003e20: 636f 6e64 2072 656c 6174 696f 6e0a 2020  cond relation.  
+00003e30: 2020 2020 2020 7265 6c5f 6964 5f32 203d        rel_id_2 =
+00003e40: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+00003e50: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
+00003e60: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
+00003e70: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+00003e80: 6e73 7461 6e63 6528 7265 6c5f 6964 5f32  nstance(rel_id_2
+00003e90: 2c20 696e 7429 0a20 2020 2020 2020 2068  , int).        h
+00003ea0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00003eb0: 696f 6e5f 756e 6974 2872 656c 5f69 645f  ion_unit(rel_id_
+00003ec0: 322c 2027 706f 7374 6772 6573 716c 2f31  2, 'postgresql/1
+00003ed0: 2729 0a20 2020 2020 2020 2062 6163 6b65  ').        backe
+00003ee0: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
+00003ef0: 636b 656e 640a 2020 2020 2020 2020 2320  ckend.        # 
+00003f00: 4368 6563 6b20 7265 6c61 7469 6f6e 2077  Check relation w
+00003f10: 6173 2063 7265 6174 6564 2061 6e64 2062  as created and b
+00003f20: 6f74 6820 7265 6c61 7469 6f6e 7320 6578  oth relations ex
+00003f30: 6973 740a 2020 2020 2020 2020 7365 6c66  ist.        self
+00003f40: 2e61 7373 6572 7449 6e28 7265 6c5f 6964  .assertIn(rel_id
+00003f50: 5f31 2c20 6261 636b 656e 642e 7265 6c61  _1, backend.rela
+00003f60: 7469 6f6e 5f69 6473 2827 6462 2729 290a  tion_ids('db')).
+00003f70: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00003f80: 6572 7449 6e28 7265 6c5f 6964 5f32 2c20  ertIn(rel_id_2, 
+00003f90: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
+00003fa0: 5f69 6473 2827 6462 2729 290a 2020 2020  _ids('db')).    
+00003fb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00003fc0: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00003fd0: 6174 696f 6e5f 6c69 7374 2872 656c 5f69  ation_list(rel_i
+00003fe0: 645f 3229 2c20 5b27 706f 7374 6772 6573  d_2), ['postgres
+00003ff0: 716c 2f31 275d 290a 2020 2020 2020 2020  ql/1']).        
+00004000: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
+00004010: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
+00004020: 5472 7565 2920 2023 2063 7265 6174 6564  True)  # created
+00004030: 2065 7665 6e74 2069 676e 6f72 6564 0a0a   event ignored..
+00004040: 2020 2020 2020 2020 2320 4e6f 7720 7265          # Now re
+00004050: 6d6f 7665 2073 6563 6f6e 6420 7265 6c61  move second rela
+00004060: 7469 6f6e 0a20 2020 2020 2020 2068 6172  tion.        har
+00004070: 6e65 7373 2e72 656d 6f76 655f 7265 6c61  ness.remove_rela
+00004080: 7469 6f6e 2872 656c 5f69 645f 3229 0a20  tion(rel_id_2). 
+00004090: 2020 2020 2020 2023 2043 6865 636b 2073         # Check s
+000040a0: 6563 6f6e 6420 7265 6c61 7469 6f6e 206e  econd relation n
+000040b0: 6f20 6c6f 6e67 6572 2065 7869 7374 7320  o longer exists 
+000040c0: 6275 7420 6669 7273 7420 646f 6573 0a20  but first does. 
+000040d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000040e0: 7274 4571 7561 6c28 6261 636b 656e 642e  rtEqual(backend.
+000040f0: 7265 6c61 7469 6f6e 5f69 6473 2827 6462  relation_ids('db
+00004100: 2729 2c20 5b72 656c 5f69 645f 315d 290a  '), [rel_id_1]).
+00004110: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00004120: 6572 7452 6169 7365 7328 6f70 732e 5265  ertRaises(ops.Re
+00004130: 6c61 7469 6f6e 4e6f 7446 6f75 6e64 4572  lationNotFoundEr
+00004140: 726f 722c 2062 6163 6b65 6e64 2e72 656c  ror, backend.rel
+00004150: 6174 696f 6e5f 6c69 7374 2c20 7265 6c5f  ation_list, rel_
+00004160: 6964 5f32 290a 0a20 2020 2020 2020 2023  id_2)..        #
+00004170: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
+00004180: 6272 6f6b 656e 2065 7665 6e74 2069 7320  broken event is 
+00004190: 7261 6973 6564 2077 6974 6820 636f 7272  raised with corr
+000041a0: 6563 7420 6461 7461 0a20 2020 2020 2020  ect data.       
+000041b0: 2063 6861 6e67 6573 203d 2068 6172 6e65   changes = harne
+000041c0: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
+000041d0: 6e67 6573 2829 0a20 2020 2020 2020 2073  nges().        s
+000041e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+000041f0: 6368 616e 6765 735b 305d 2c0a 2020 2020  changes[0],.    
+00004200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004210: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+00004220: 656c 6174 696f 6e2d 6465 7061 7274 6564  elation-departed
+00004230: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00004240: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00004250: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
+00004260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004270: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
+00004280: 207b 2761 7070 273a 2027 706f 7374 6772   {'app': 'postgr
+00004290: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
 000042a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042b0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-000042c0: 7265 6c61 7469 6f6e 2d64 6570 6172 7465  relation-departe
-000042d0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-000042e0: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-000042f0: 656c 6174 696f 6e27 3a20 2764 6227 2c0a  elation': 'db',.
-00004300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004310: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
-00004320: 3a20 7b27 6170 7027 3a20 2770 6f73 7467  : {'app': 'postg
-00004330: 7265 7371 6c27 2c0a 2020 2020 2020 2020  resql',.        
-00004340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004350: 2020 2020 2020 2020 2020 2027 756e 6974             'unit
-00004360: 273a 2027 706f 7374 6772 6573 716c 2f31  ': 'postgresql/1
-00004370: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000042b0: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
+000042c0: 3a20 2770 6f73 7467 7265 7371 6c2f 3127  : 'postgresql/1'
+000042d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000042e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042f0: 2020 2020 2027 6465 7061 7274 696e 675f       'departing_
+00004300: 756e 6974 273a 2027 706f 7374 6772 6573  unit': 'postgres
+00004310: 716c 2f31 272c 0a20 2020 2020 2020 2020  ql/1',.         
+00004320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004330: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00004340: 696f 6e5f 6964 273a 2072 656c 5f69 645f  ion_id': rel_id_
+00004350: 327d 7d29 0a20 2020 2020 2020 2073 656c  2}}).        sel
+00004360: 662e 6173 7365 7274 4571 7561 6c28 6368  f.assertEqual(ch
+00004370: 616e 6765 735b 315d 2c0a 2020 2020 2020  anges[1],.      
 00004380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004390: 2020 2020 2020 2764 6570 6172 7469 6e67        'departing
-000043a0: 5f75 6e69 7427 3a20 2770 6f73 7467 7265  _unit': 'postgre
-000043b0: 7371 6c2f 3127 2c0a 2020 2020 2020 2020  sql/1',.        
-000043c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043d0: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-000043e0: 7469 6f6e 5f69 6427 3a20 7265 6c5f 6964  tion_id': rel_id
-000043f0: 5f32 7d7d 290a 2020 2020 2020 2020 7365  _2}}).        se
-00004400: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00004410: 6861 6e67 6573 5b31 5d2c 0a20 2020 2020  hanges[1],.     
+00004390: 2020 207b 276e 616d 6527 3a20 2772 656c     {'name': 'rel
+000043a0: 6174 696f 6e2d 6272 6f6b 656e 272c 0a20  ation-broken',. 
+000043b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043c0: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+000043d0: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
+000043e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043f0: 2020 2020 2027 6461 7461 273a 207b 2761       'data': {'a
+00004400: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
+00004410: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
 00004420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004430: 2020 2020 7b27 6e61 6d65 273a 2027 7265      {'name': 're
-00004440: 6c61 7469 6f6e 2d62 726f 6b65 6e27 2c0a  lation-broken',.
+00004430: 2020 2020 2020 2775 6e69 7427 3a20 4e6f        'unit': No
+00004440: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
 00004450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004460: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00004470: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
-00004480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004490: 2020 2020 2020 2764 6174 6127 3a20 7b27        'data': {'
-000044a0: 6170 7027 3a20 2770 6f73 7467 7265 7371  app': 'postgresq
-000044b0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000044c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044d0: 2020 2020 2020 2027 756e 6974 273a 204e         'unit': N
-000044e0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000044f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004500: 2020 2020 2020 2020 2772 656c 6174 696f          'relatio
-00004510: 6e5f 6964 273a 2072 656c 5f69 645f 327d  n_id': rel_id_2}
-00004520: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
-00004530: 5f72 656d 6f76 696e 675f 696e 7661 6c69  _removing_invali
-00004540: 645f 7265 6c61 7469 6f6e 5f69 645f 7261  d_relation_id_ra
-00004550: 6973 6573 5f65 7863 6570 7469 6f6e 2873  ises_exception(s
-00004560: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-00004570: 726e 6573 7320 3d20 4861 726e 6573 7328  rness = Harness(
-00004580: 5265 6c61 7469 6f6e 4576 656e 7443 6861  RelationEventCha
-00004590: 726d 2c20 6d65 7461 3d27 2727 0a20 2020  rm, meta='''.   
-000045a0: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
-000045b0: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
-000045c0: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
-000045d0: 2020 2020 2020 2020 2020 2020 2020 6462                db
-000045e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000045f0: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
-00004600: 2070 6773 716c 0a20 2020 2020 2020 2020   pgsql.         
-00004610: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00004620: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-00004630: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00004640: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00004650: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-00004660: 2068 6172 6e65 7373 2e63 6861 726d 2e6f   harness.charm.o
-00004670: 6273 6572 7665 5f72 656c 6174 696f 6e5f  bserve_relation_
-00004680: 6576 656e 7473 2827 6462 2729 0a20 2020  events('db').   
-00004690: 2020 2020 2023 2046 6972 7374 2063 7265       # First cre
-000046a0: 6174 6520 6120 7265 6c61 7469 6f6e 0a20  ate a relation. 
-000046b0: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
-000046c0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-000046d0: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
-000046e0: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
-000046f0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-00004700: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
-00004710: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
-00004720: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00004730: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
-00004740: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
-00004750: 2020 2020 2020 6261 636b 656e 6420 3d20        backend = 
-00004760: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
-00004770: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00004780: 2072 656c 6174 696f 6e20 7761 7320 6372   relation was cr
-00004790: 6561 7465 640a 2020 2020 2020 2020 7365  eated.        se
-000047a0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-000047b0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-000047c0: 6964 7328 2764 6227 292c 205b 7265 6c5f  ids('db'), [rel_
-000047d0: 6964 5d29 0a20 2020 2020 2020 2073 656c  id]).        sel
-000047e0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-000047f0: 636b 656e 642e 7265 6c61 7469 6f6e 5f6c  ckend.relation_l
-00004800: 6973 7428 7265 6c5f 6964 292c 205b 2770  ist(rel_id), ['p
-00004810: 6f73 7467 7265 7371 6c2f 3027 5d29 0a20  ostgresql/0']). 
-00004820: 2020 2020 2020 2068 6172 6e65 7373 2e63         harness.c
-00004830: 6861 726d 2e67 6574 5f63 6861 6e67 6573  harm.get_changes
-00004840: 2872 6573 6574 3d54 7275 6529 2020 2320  (reset=True)  # 
-00004850: 6372 6561 7465 6420 6576 656e 7420 6967  created event ig
-00004860: 6e6f 7265 640a 2020 2020 2020 2020 2320  nored.        # 
-00004870: 4368 6563 6b20 6578 6365 7074 696f 6e20  Check exception 
-00004880: 6973 2072 6169 7365 6420 6966 2072 656c  is raised if rel
-00004890: 6174 696f 6e20 6964 2069 7320 696e 7661  ation id is inva
-000048a0: 6c69 640a 2020 2020 2020 2020 7769 7468  lid.        with
-000048b0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-000048c0: 6573 2852 656c 6174 696f 6e4e 6f74 466f  es(RelationNotFo
-000048d0: 756e 6445 7272 6f72 293a 0a20 2020 2020  undError):.     
-000048e0: 2020 2020 2020 2068 6172 6e65 7373 2e72         harness.r
-000048f0: 656d 6f76 655f 7265 6c61 7469 6f6e 2872  emove_relation(r
-00004900: 656c 5f69 6420 2b20 3129 0a0a 2020 2020  el_id + 1)..    
-00004910: 6465 6620 7465 7374 5f72 656d 6f76 655f  def test_remove_
-00004920: 7265 6c61 7469 6f6e 5f75 6e69 7428 7365  relation_unit(se
-00004930: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-00004940: 6e65 7373 203d 2048 6172 6e65 7373 2852  ness = Harness(R
-00004950: 656c 6174 696f 6e45 7665 6e74 4368 6172  elationEventChar
-00004960: 6d2c 206d 6574 613d 2727 270a 2020 2020  m, meta='''.    
-00004970: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-00004980: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
-00004990: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
-000049a0: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-000049b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000049c0: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-000049d0: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
-000049e0: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-000049f0: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-00004a00: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-00004a10: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00004a20: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
-00004a30: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
-00004a40: 7365 7276 655f 7265 6c61 7469 6f6e 5f65  serve_relation_e
-00004a50: 7665 6e74 7328 2764 6227 290a 2020 2020  vents('db').    
-00004a60: 2020 2020 2320 4669 7273 7420 6164 6420      # First add 
-00004a70: 6120 7265 6c61 7469 6f6e 2061 6e64 2075  a relation and u
-00004a80: 6e69 740a 2020 2020 2020 2020 7265 6c5f  nit.        rel_
-00004a90: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-00004aa0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
-00004ab0: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
-00004ac0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00004ad0: 7449 7349 6e73 7461 6e63 6528 7265 6c5f  tIsInstance(rel_
-00004ae0: 6964 2c20 696e 7429 0a20 2020 2020 2020  id, int).       
-00004af0: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00004b00: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
-00004b10: 642c 2027 706f 7374 6772 6573 716c 2f30  d, 'postgresql/0
-00004b20: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-00004b30: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
-00004b40: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
-00004b50: 2770 6f73 7467 7265 7371 6c2f 3027 2c20  'postgresql/0', 
-00004b60: 7b27 666f 6f27 3a20 2762 6172 277d 290a  {'foo': 'bar'}).
-00004b70: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-00004b80: 7265 6c61 7469 6f6e 2061 6e64 2075 6e69  relation and uni
-00004b90: 7420 7765 7265 2063 7265 6174 6564 0a20  t were created. 
-00004ba0: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
-00004bb0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
-00004bc0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
-00004bd0: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
-00004be0: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
-00004bf0: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
-00004c00: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00004c10: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
-00004c20: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
-00004c30: 7265 6c5f 6964 292c 205b 2770 6f73 7467  rel_id), ['postg
-00004c40: 7265 7371 6c2f 3027 5d29 0a20 2020 2020  resql/0']).     
-00004c50: 2020 2068 6172 6e65 7373 2e63 6861 726d     harness.charm
-00004c60: 2e67 6574 5f63 6861 6e67 6573 2872 6573  .get_changes(res
-00004c70: 6574 3d54 7275 6529 2020 2320 6967 6e6f  et=True)  # igno
-00004c80: 7265 2072 656c 6174 696f 6e20 6372 6561  re relation crea
-00004c90: 7465 6420 6576 656e 7473 0a20 2020 2020  ted events.     
-00004ca0: 2020 2072 656c 6174 696f 6e20 3d20 6861     relation = ha
-00004cb0: 726e 6573 732e 6368 6172 6d2e 6d6f 6465  rness.charm.mode
-00004cc0: 6c2e 6765 745f 7265 6c61 7469 6f6e 2827  l.get_relation('
-00004cd0: 6462 2729 0a20 2020 2020 2020 2073 656c  db').        sel
-00004ce0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-00004cf0: 6e28 7265 6c61 7469 6f6e 2e75 6e69 7473  n(relation.units
-00004d00: 292c 2031 290a 2020 2020 2020 2020 2320  ), 1).        # 
-00004d10: 4368 6563 6b20 7265 6c61 7469 6f6e 2064  Check relation d
-00004d20: 6174 6120 6973 2063 6f72 7265 6374 0a20  ata is correct. 
-00004d30: 2020 2020 2020 2072 656c 5f75 6e69 7420         rel_unit 
-00004d40: 3d20 6861 726e 6573 732e 6368 6172 6d2e  = harness.charm.
-00004d50: 6d6f 6465 6c2e 6765 745f 756e 6974 2827  model.get_unit('
-00004d60: 706f 7374 6772 6573 716c 2f30 2729 0a20  postgresql/0'). 
-00004d70: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00004d80: 7274 4571 7561 6c28 7265 6c61 7469 6f6e  rtEqual(relation
-00004d90: 2e64 6174 615b 7265 6c5f 756e 6974 5d5b  .data[rel_unit][
-00004da0: 2766 6f6f 275d 2c20 2762 6172 2729 0a20  'foo'], 'bar'). 
-00004db0: 2020 2020 2020 2023 2049 6e73 7472 7563         # Instruc
-00004dc0: 7420 7468 6520 6368 6172 6d20 746f 2072  t the charm to r
-00004dd0: 6563 6f72 6420 7468 6520 7265 6c61 7469  ecord the relati
-00004de0: 6f6e 2064 6174 6120 6974 2073 6565 7320  on data it sees 
-00004df0: 696e 2074 6865 206c 6973 7420 6f66 2063  in the list of c
-00004e00: 6861 6e67 6573 0a20 2020 2020 2020 2068  hanges.        h
-00004e10: 6172 6e65 7373 2e63 6861 726d 2e72 6563  arness.charm.rec
-00004e20: 6f72 645f 7265 6c61 7469 6f6e 5f64 6174  ord_relation_dat
-00004e30: 615f 6f6e 5f65 7665 6e74 7320 3d20 5472  a_on_events = Tr
-00004e40: 7565 0a20 2020 2020 2020 2023 204e 6f77  ue.        # Now
-00004e50: 2072 656d 6f76 6520 756e 6974 0a20 2020   remove unit.   
-00004e60: 2020 2020 2068 6172 6e65 7373 2e72 656d       harness.rem
-00004e70: 6f76 655f 7265 6c61 7469 6f6e 5f75 6e69  ove_relation_uni
-00004e80: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
-00004e90: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
-00004ea0: 2020 2320 4368 6563 6b20 7265 6c61 7469    # Check relati
-00004eb0: 6f6e 2073 7469 6c6c 2065 7869 7374 730a  on still exists.
-00004ec0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00004ed0: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
-00004ee0: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
-00004ef0: 6227 292c 205b 7265 6c5f 6964 5d29 0a20  b'), [rel_id]). 
-00004f00: 2020 2020 2020 2023 2043 6865 636b 2072         # Check r
-00004f10: 656d 6f76 6564 2075 6e69 7420 646f 6573  emoved unit does
-00004f20: 206e 6f74 2065 7869 7374 0a20 2020 2020   not exist.     
-00004f30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00004f40: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
-00004f50: 7469 6f6e 5f6c 6973 7428 7265 6c5f 6964  tion_list(rel_id
-00004f60: 292c 205b 5d29 0a20 2020 2020 2020 2023  ), []).        #
-00004f70: 2043 6865 636b 2074 6865 2075 6e69 7420   Check the unit 
-00004f80: 6973 2061 6374 7561 6c6c 7920 7265 6d6f  is actually remo
-00004f90: 7665 6420 6672 6f6d 2074 6865 2072 656c  ved from the rel
-00004fa0: 6174 696f 6e73 2074 6865 206d 6f64 656c  ations the model
-00004fb0: 206b 6e6f 7773 2061 626f 7574 0a20 2020   knows about.   
-00004fc0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00004fd0: 4571 7561 6c28 6c65 6e28 6861 726e 6573  Equal(len(harnes
-00004fe0: 732e 6368 6172 6d2e 6d6f 6465 6c2e 6765  s.charm.model.ge
-00004ff0: 745f 7265 6c61 7469 6f6e 2827 6462 2729  t_relation('db')
-00005000: 2e75 6e69 7473 292c 2030 290a 2020 2020  .units), 0).    
-00005010: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
-00005020: 616c 7365 2872 656c 5f75 6e69 7420 696e  alse(rel_unit in
-00005030: 2068 6172 6e65 7373 2e63 6861 726d 2e6d   harness.charm.m
-00005040: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
-00005050: 6e28 2764 6227 292e 6461 7461 290a 2020  n('db').data).  
-00005060: 2020 2020 2020 2320 4368 6563 6b20 7265        # Check re
-00005070: 6c61 7469 6f6e 2064 6570 6172 7465 6420  lation departed 
-00005080: 7761 7320 7261 6973 6564 2077 6974 6820  was raised with 
-00005090: 636f 7272 6563 7420 6461 7461 0a20 2020  correct data.   
-000050a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000050b0: 4571 7561 6c28 7b27 6e61 6d65 273a 2027  Equal({'name': '
-000050c0: 7265 6c61 7469 6f6e 2d64 6570 6172 7465  relation-departe
-000050d0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-000050e0: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-000050f0: 656c 6174 696f 6e27 3a20 2764 6227 2c0a  elation': 'db',.
+00004460: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00004470: 5f69 6427 3a20 7265 6c5f 6964 5f32 7d7d  _id': rel_id_2}}
+00004480: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00004490: 7265 6d6f 7669 6e67 5f69 6e76 616c 6964  removing_invalid
+000044a0: 5f72 656c 6174 696f 6e5f 6964 5f72 6169  _relation_id_rai
+000044b0: 7365 735f 6578 6365 7074 696f 6e28 7365  ses_exception(se
+000044c0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+000044d0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+000044e0: 6e67 2e48 6172 6e65 7373 2852 656c 6174  ng.Harness(Relat
+000044f0: 696f 6e45 7665 6e74 4368 6172 6d2c 206d  ionEventCharm, m
+00004500: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
+00004510: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+00004520: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
+00004530: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
+00004540: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
+00004550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004560: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
+00004570: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
+00004580: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00004590: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+000045a0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+000045b0: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
+000045c0: 6e28 290a 2020 2020 2020 2020 6861 726e  n().        harn
+000045d0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+000045e0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
+000045f0: 7328 2764 6227 290a 2020 2020 2020 2020  s('db').        
+00004600: 2320 4669 7273 7420 6372 6561 7465 2061  # First create a
+00004610: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
+00004620: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
+00004630: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00004640: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
+00004650: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+00004660: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+00004670: 6528 7265 6c5f 6964 2c20 696e 7429 0a20  e(rel_id, int). 
+00004680: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
+00004690: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
+000046a0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+000046b0: 6573 716c 2f30 2729 0a20 2020 2020 2020  esql/0').       
+000046c0: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+000046d0: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
+000046e0: 2020 2020 2320 4368 6563 6b20 7265 6c61      # Check rela
+000046f0: 7469 6f6e 2077 6173 2063 7265 6174 6564  tion was created
+00004700: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00004710: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
+00004720: 642e 7265 6c61 7469 6f6e 5f69 6473 2827  d.relation_ids('
+00004730: 6462 2729 2c20 5b72 656c 5f69 645d 290a  db'), [rel_id]).
+00004740: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00004750: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
+00004760: 2e72 656c 6174 696f 6e5f 6c69 7374 2872  .relation_list(r
+00004770: 656c 5f69 6429 2c20 5b27 706f 7374 6772  el_id), ['postgr
+00004780: 6573 716c 2f30 275d 290a 2020 2020 2020  esql/0']).      
+00004790: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
+000047a0: 6765 745f 6368 616e 6765 7328 7265 7365  get_changes(rese
+000047b0: 743d 5472 7565 2920 2023 2063 7265 6174  t=True)  # creat
+000047c0: 6564 2065 7665 6e74 2069 676e 6f72 6564  ed event ignored
+000047d0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+000047e0: 2065 7863 6570 7469 6f6e 2069 7320 7261   exception is ra
+000047f0: 6973 6564 2069 6620 7265 6c61 7469 6f6e  ised if relation
+00004800: 2069 6420 6973 2069 6e76 616c 6964 0a20   id is invalid. 
+00004810: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00004820: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
+00004830: 732e 5265 6c61 7469 6f6e 4e6f 7446 6f75  s.RelationNotFou
+00004840: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
+00004850: 2020 2020 2020 6861 726e 6573 732e 7265        harness.re
+00004860: 6d6f 7665 5f72 656c 6174 696f 6e28 7265  move_relation(re
+00004870: 6c5f 6964 202b 2031 290a 0a20 2020 2064  l_id + 1)..    d
+00004880: 6566 2074 6573 745f 7265 6d6f 7665 5f72  ef test_remove_r
+00004890: 656c 6174 696f 6e5f 756e 6974 2873 656c  elation_unit(sel
+000048a0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+000048b0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+000048c0: 672e 4861 726e 6573 7328 5265 6c61 7469  g.Harness(Relati
+000048d0: 6f6e 4576 656e 7443 6861 726d 2c20 6d65  onEventCharm, me
+000048e0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+000048f0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+00004900: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+00004910: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+00004920: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
+00004930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004940: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00004950: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00004960: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00004970: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00004980: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00004990: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+000049a0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+000049b0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+000049c0: 5f72 656c 6174 696f 6e5f 6576 656e 7473  _relation_events
+000049d0: 2827 6462 2729 0a20 2020 2020 2020 2023  ('db').        #
+000049e0: 2046 6972 7374 2061 6464 2061 2072 656c   First add a rel
+000049f0: 6174 696f 6e20 616e 6420 756e 6974 0a20  ation and unit. 
+00004a00: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
+00004a10: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00004a20: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+00004a30: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+00004a40: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+00004a50: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
+00004a60: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
+00004a70: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00004a80: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
+00004a90: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
+00004aa0: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+00004ab0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00004ac0: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
+00004ad0: 6772 6573 716c 2f30 272c 207b 2766 6f6f  gresql/0', {'foo
+00004ae0: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
+00004af0: 2020 2023 2043 6865 636b 2072 656c 6174     # Check relat
+00004b00: 696f 6e20 616e 6420 756e 6974 2077 6572  ion and unit wer
+00004b10: 6520 6372 6561 7465 640a 2020 2020 2020  e created.      
+00004b20: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
+00004b30: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
+00004b40: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00004b50: 4571 7561 6c28 6261 636b 656e 642e 7265  Equal(backend.re
+00004b60: 6c61 7469 6f6e 5f69 6473 2827 6462 2729  lation_ids('db')
+00004b70: 2c20 5b72 656c 5f69 645d 290a 2020 2020  , [rel_id]).    
+00004b80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00004b90: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00004ba0: 6174 696f 6e5f 6c69 7374 2872 656c 5f69  ation_list(rel_i
+00004bb0: 6429 2c20 5b27 706f 7374 6772 6573 716c  d), ['postgresql
+00004bc0: 2f30 275d 290a 2020 2020 2020 2020 6861  /0']).        ha
+00004bd0: 726e 6573 732e 6368 6172 6d2e 6765 745f  rness.charm.get_
+00004be0: 6368 616e 6765 7328 7265 7365 743d 5472  changes(reset=Tr
+00004bf0: 7565 2920 2023 2069 676e 6f72 6520 7265  ue)  # ignore re
+00004c00: 6c61 7469 6f6e 2063 7265 6174 6564 2065  lation created e
+00004c10: 7665 6e74 730a 2020 2020 2020 2020 7265  vents.        re
+00004c20: 6c61 7469 6f6e 203d 2068 6172 6e65 7373  lation = harness
+00004c30: 2e63 6861 726d 2e6d 6f64 656c 2e67 6574  .charm.model.get
+00004c40: 5f72 656c 6174 696f 6e28 2764 6227 290a  _relation('db').
+00004c50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00004c60: 6572 7445 7175 616c 286c 656e 2872 656c  ertEqual(len(rel
+00004c70: 6174 696f 6e2e 756e 6974 7329 2c20 3129  ation.units), 1)
+00004c80: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00004c90: 2072 656c 6174 696f 6e20 6461 7461 2069   relation data i
+00004ca0: 7320 636f 7272 6563 740a 2020 2020 2020  s correct.      
+00004cb0: 2020 7265 6c5f 756e 6974 203d 2068 6172    rel_unit = har
+00004cc0: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
+00004cd0: 2e67 6574 5f75 6e69 7428 2770 6f73 7467  .get_unit('postg
+00004ce0: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
+00004cf0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00004d00: 616c 2872 656c 6174 696f 6e2e 6461 7461  al(relation.data
+00004d10: 5b72 656c 5f75 6e69 745d 5b27 666f 6f27  [rel_unit]['foo'
+00004d20: 5d2c 2027 6261 7227 290a 2020 2020 2020  ], 'bar').      
+00004d30: 2020 2320 496e 7374 7275 6374 2074 6865    # Instruct the
+00004d40: 2063 6861 726d 2074 6f20 7265 636f 7264   charm to record
+00004d50: 2074 6865 2072 656c 6174 696f 6e20 6461   the relation da
+00004d60: 7461 2069 7420 7365 6573 2069 6e20 7468  ta it sees in th
+00004d70: 6520 6c69 7374 206f 6620 6368 616e 6765  e list of change
+00004d80: 730a 2020 2020 2020 2020 6861 726e 6573  s.        harnes
+00004d90: 732e 6368 6172 6d2e 7265 636f 7264 5f72  s.charm.record_r
+00004da0: 656c 6174 696f 6e5f 6461 7461 5f6f 6e5f  elation_data_on_
+00004db0: 6576 656e 7473 203d 2054 7275 650a 2020  events = True.  
+00004dc0: 2020 2020 2020 2320 4e6f 7720 7265 6d6f        # Now remo
+00004dd0: 7665 2075 6e69 740a 2020 2020 2020 2020  ve unit.        
+00004de0: 6861 726e 6573 732e 7265 6d6f 7665 5f72  harness.remove_r
+00004df0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00004e00: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+00004e10: 2f30 2729 0a20 2020 2020 2020 2023 2043  /0').        # C
+00004e20: 6865 636b 2072 656c 6174 696f 6e20 7374  heck relation st
+00004e30: 696c 6c20 6578 6973 7473 0a20 2020 2020  ill exists.     
+00004e40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00004e50: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
+00004e60: 7469 6f6e 5f69 6473 2827 6462 2729 2c20  tion_ids('db'), 
+00004e70: 5b72 656c 5f69 645d 290a 2020 2020 2020  [rel_id]).      
+00004e80: 2020 2320 4368 6563 6b20 7265 6d6f 7665    # Check remove
+00004e90: 6420 756e 6974 2064 6f65 7320 6e6f 7420  d unit does not 
+00004ea0: 6578 6973 740a 2020 2020 2020 2020 7365  exist.        se
+00004eb0: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
+00004ec0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+00004ed0: 6c69 7374 2872 656c 5f69 6429 2c20 5b5d  list(rel_id), []
+00004ee0: 290a 2020 2020 2020 2020 2320 4368 6563  ).        # Chec
+00004ef0: 6b20 7468 6520 756e 6974 2069 7320 6163  k the unit is ac
+00004f00: 7475 616c 6c79 2072 656d 6f76 6564 2066  tually removed f
+00004f10: 726f 6d20 7468 6520 7265 6c61 7469 6f6e  rom the relation
+00004f20: 7320 7468 6520 6d6f 6465 6c20 6b6e 6f77  s the model know
+00004f30: 7320 6162 6f75 740a 2020 2020 2020 2020  s about.        
+00004f40: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00004f50: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
+00004f60: 726d 2e6d 6f64 656c 2e67 6574 5f72 656c  rm.model.get_rel
+00004f70: 6174 696f 6e28 2764 6227 292e 756e 6974  ation('db').unit
+00004f80: 7329 2c20 3029 0a20 2020 2020 2020 2073  s), 0).        s
+00004f90: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
+00004fa0: 7265 6c5f 756e 6974 2069 6e20 6861 726e  rel_unit in harn
+00004fb0: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+00004fc0: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+00004fd0: 2729 2e64 6174 6129 0a20 2020 2020 2020  ').data).       
+00004fe0: 2023 2043 6865 636b 2072 656c 6174 696f   # Check relatio
+00004ff0: 6e20 6465 7061 7274 6564 2077 6173 2072  n departed was r
+00005000: 6169 7365 6420 7769 7468 2063 6f72 7265  aised with corre
+00005010: 6374 2064 6174 610a 2020 2020 2020 2020  ct data.        
+00005020: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00005030: 287b 276e 616d 6527 3a20 2772 656c 6174  ({'name': 'relat
+00005040: 696f 6e2d 6465 7061 7274 6564 272c 0a20  ion-departed',. 
+00005050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005060: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+00005070: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
+00005080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005090: 2020 2020 2027 6461 7461 273a 207b 2761       'data': {'a
+000050a0: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
+000050b0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000050c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000050d0: 2020 2020 2020 2775 6e69 7427 3a20 2770        'unit': 'p
+000050e0: 6f73 7467 7265 7371 6c2f 3027 2c0a 2020  ostgresql/0',.  
+000050f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005110: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
-00005120: 3a20 7b27 6170 7027 3a20 2770 6f73 7467  : {'app': 'postg
-00005130: 7265 7371 6c27 2c0a 2020 2020 2020 2020  resql',.        
+00005110: 2027 6465 7061 7274 696e 675f 756e 6974   'departing_unit
+00005120: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
+00005130: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
 00005140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005150: 2020 2020 2020 2020 2020 2027 756e 6974             'unit
-00005160: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
-00005170: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00005180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005190: 2020 2020 2020 2764 6570 6172 7469 6e67        'departing
-000051a0: 5f75 6e69 7427 3a20 2770 6f73 7467 7265  _unit': 'postgre
-000051b0: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
+00005150: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
+00005160: 6964 273a 2030 2c0a 2020 2020 2020 2020  id': 0,.        
+00005170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005180: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
+00005190: 7469 6f6e 5f64 6174 6127 3a20 7b27 7465  tion_data': {'te
+000051a0: 7374 2d61 7070 2f30 273a 207b 7d2c 0a20  st-app/0': {},. 
+000051b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000051c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051d0: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-000051e0: 7469 6f6e 5f69 6427 3a20 302c 0a20 2020  tion_id': 0,.   
-000051f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051e0: 2020 2020 2774 6573 742d 6170 7027 3a20      'test-app': 
+000051f0: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
 00005200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005210: 2772 656c 6174 696f 6e5f 6461 7461 273a  'relation_data':
-00005220: 207b 2774 6573 742d 6170 702f 3027 3a20   {'test-app/0': 
-00005230: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
-00005240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005220: 2020 2020 2020 2020 2027 706f 7374 6772           'postgr
+00005230: 6573 716c 2f30 273a 207b 2766 6f6f 273a  esql/0': {'foo':
+00005240: 2027 6261 7227 7d2c 0a20 2020 2020 2020   'bar'},.       
 00005250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005260: 2020 2020 2020 2020 2027 7465 7374 2d61           'test-a
-00005270: 7070 273a 207b 7d2c 0a20 2020 2020 2020  pp': {},.       
-00005280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000052a0: 2020 2020 2020 2020 2020 2020 2020 2770                'p
-000052b0: 6f73 7467 7265 7371 6c2f 3027 3a20 7b27  ostgresql/0': {'
-000052c0: 666f 6f27 3a20 2762 6172 277d 2c0a 2020  foo': 'bar'},.  
-000052d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000052e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000052f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005300: 2020 2027 706f 7374 6772 6573 716c 273a     'postgresql':
-00005310: 207b 7d7d 7d7d 2c0a 2020 2020 2020 2020   {}}}},.        
-00005320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005330: 2068 6172 6e65 7373 2e63 6861 726d 2e67   harness.charm.g
-00005340: 6574 5f63 6861 6e67 6573 2829 5b30 5d29  et_changes()[0])
-00005350: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
-00005360: 656d 6f76 696e 675f 7265 6c61 7469 6f6e  emoving_relation
-00005370: 5f72 656d 6f76 6573 5f72 656d 6f74 655f  _removes_remote_
-00005380: 6170 705f 6461 7461 2873 656c 6629 3a0a  app_data(self):.
-00005390: 2020 2020 2020 2020 2320 6c61 6e67 7561          # langua
-000053a0: 6765 3d59 414d 4c0a 2020 2020 2020 2020  ge=YAML.        
-000053b0: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-000053c0: 7328 5265 6c61 7469 6f6e 4576 656e 7443  s(RelationEventC
-000053d0: 6861 726d 2c20 6d65 7461 3d27 2727 0a20  harm, meta='''. 
-000053e0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-000053f0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-00005400: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
-00005410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005420: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-00005430: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-00005440: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-00005450: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00005460: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00005470: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-00005480: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
-00005490: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
-000054a0: 2020 2068 6172 6e65 7373 2e63 6861 726d     harness.charm
-000054b0: 2e6f 6273 6572 7665 5f72 656c 6174 696f  .observe_relatio
-000054c0: 6e5f 6576 656e 7473 2827 6462 2729 0a20  n_events('db'). 
-000054d0: 2020 2020 2020 2023 2041 6464 2061 2072         # Add a r
-000054e0: 656c 6174 696f 6e20 616e 6420 7570 6461  elation and upda
-000054f0: 7465 2061 7070 2064 6174 610a 2020 2020  te app data.    
-00005500: 2020 2020 7265 6d6f 7465 5f61 7070 203d      remote_app =
-00005510: 2027 706f 7374 6772 6573 716c 270a 2020   'postgresql'.  
-00005520: 2020 2020 2020 7265 6c5f 6964 203d 2068        rel_id = h
-00005530: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00005540: 696f 6e28 2764 6227 2c20 7265 6d6f 7465  ion('db', remote
-00005550: 5f61 7070 290a 2020 2020 2020 2020 6861  _app).        ha
-00005560: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00005570: 6174 696f 6e5f 6461 7461 2872 656c 5f69  ation_data(rel_i
-00005580: 642c 2027 706f 7374 6772 6573 716c 272c  d, 'postgresql',
-00005590: 207b 2761 7070 273a 2027 6461 7461 277d   {'app': 'data'}
-000055a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000055b0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-000055c0: 7265 6c5f 6964 2c20 696e 7429 0a20 2020  rel_id, int).   
-000055d0: 2020 2020 2023 2043 6865 636b 2072 656c       # Check rel
-000055e0: 6174 696f 6e20 6170 7020 6461 7461 2065  ation app data e
-000055f0: 7869 7374 730a 2020 2020 2020 2020 6261  xists.        ba
-00005600: 636b 656e 6420 3d20 6861 726e 6573 732e  ckend = harness.
-00005610: 5f62 6163 6b65 6e64 0a20 2020 2020 2020  _backend.       
-00005620: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00005630: 6c28 6261 636b 656e 642e 7265 6c61 7469  l(backend.relati
-00005640: 6f6e 5f69 6473 2827 6462 2729 2c20 5b72  on_ids('db'), [r
-00005650: 656c 5f69 645d 290a 2020 2020 2020 2020  el_id]).        
-00005660: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00005670: 287b 2761 7070 273a 2027 6461 7461 277d  ({'app': 'data'}
-00005680: 2c20 6261 636b 656e 642e 7265 6c61 7469  , backend.relati
-00005690: 6f6e 5f67 6574 2872 656c 5f69 642c 2072  on_get(rel_id, r
-000056a0: 656d 6f74 655f 6170 702c 2069 735f 6170  emote_app, is_ap
-000056b0: 703d 5472 7565 2929 0a20 2020 2020 2020  p=True)).       
-000056c0: 2068 6172 6e65 7373 2e72 656d 6f76 655f   harness.remove_
-000056d0: 7265 6c61 7469 6f6e 2872 656c 5f69 6429  relation(rel_id)
-000056e0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-000056f0: 2072 656c 6174 696f 6e20 616e 6420 6170   relation and ap
-00005700: 7020 6461 7461 2061 7265 2072 656d 6f76  p data are remov
-00005710: 6564 0a20 2020 2020 2020 2073 656c 662e  ed.        self.
-00005720: 6173 7365 7274 4571 7561 6c28 6261 636b  assertEqual(back
-00005730: 656e 642e 7265 6c61 7469 6f6e 5f69 6473  end.relation_ids
-00005740: 2827 6462 2729 2c20 5b5d 290a 2020 2020  ('db'), []).    
-00005750: 2020 2020 7769 7468 2068 6172 6e65 7373      with harness
-00005760: 2e5f 6576 656e 745f 636f 6e74 6578 7428  ._event_context(
-00005770: 2766 6f6f 2729 3a0a 2020 2020 2020 2020  'foo'):.        
-00005780: 2020 2020 7365 6c66 2e61 7373 6572 7452      self.assertR
-00005790: 6169 7365 7328 5265 6c61 7469 6f6e 4e6f  aises(RelationNo
-000057a0: 7446 6f75 6e64 4572 726f 722c 2062 6163  tFoundError, bac
-000057b0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
-000057c0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000057d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000057e0: 2072 656c 5f69 642c 2072 656d 6f74 655f   rel_id, remote_
-000057f0: 6170 702c 2069 735f 6170 703d 5472 7565  app, is_app=True
-00005800: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00005810: 7265 6d6f 7669 6e67 5f72 656c 6174 696f  removing_relatio
-00005820: 6e5f 7265 6672 6573 6865 735f 6368 6172  n_refreshes_char
-00005830: 6d5f 6d6f 6465 6c28 7365 6c66 293a 0a20  m_model(self):. 
-00005840: 2020 2020 2020 2023 206c 616e 6775 6167         # languag
-00005850: 653d 5941 4d4c 0a20 2020 2020 2020 2068  e=YAML.        h
-00005860: 6172 6e65 7373 203d 2048 6172 6e65 7373  arness = Harness
-00005870: 2852 656c 6174 696f 6e45 7665 6e74 4368  (RelationEventCh
-00005880: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
-00005890: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-000058a0: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
-000058b0: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
-000058c0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000058d0: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
-000058e0: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
-000058f0: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
-00005900: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00005910: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-00005920: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-00005930: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00005940: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
-00005950: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
-00005960: 6f62 7365 7276 655f 7265 6c61 7469 6f6e  observe_relation
-00005970: 5f65 7665 6e74 7328 2764 6227 290a 2020  _events('db').  
-00005980: 2020 2020 2020 2320 4164 6420 6120 7265        # Add a re
-00005990: 6c61 7469 6f6e 2061 6e64 2075 7064 6174  lation and updat
-000059a0: 6520 6170 7020 6461 7461 0a20 2020 2020  e app data.     
-000059b0: 2020 2072 656d 6f74 655f 6170 7020 3d20     remote_app = 
-000059c0: 2770 6f73 7467 7265 7371 6c27 0a20 2020  'postgresql'.   
-000059d0: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
-000059e0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-000059f0: 6f6e 2827 6462 272c 2072 656d 6f74 655f  on('db', remote_
-00005a00: 6170 7029 0a20 2020 2020 2020 2068 6172  app).        har
-00005a10: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-00005a20: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-00005a30: 2c20 2770 6f73 7467 7265 7371 6c27 2c20  , 'postgresql', 
-00005a40: 7b27 6170 7027 3a20 2764 6174 6127 7d29  {'app': 'data'})
-00005a50: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00005a60: 7365 7274 4973 496e 7374 616e 6365 2872  sertIsInstance(r
-00005a70: 656c 5f69 642c 2069 6e74 290a 2020 2020  el_id, int).    
-00005a80: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-00005a90: 734e 6f74 4e6f 6e65 2873 656c 662e 5f66  sNotNone(self._f
-00005aa0: 696e 645f 7265 6c61 7469 6f6e 5f69 6e5f  ind_relation_in_
-00005ab0: 6d6f 6465 6c5f 6279 5f69 6428 6861 726e  model_by_id(harn
-00005ac0: 6573 732c 2072 656c 5f69 6429 290a 0a20  ess, rel_id)).. 
-00005ad0: 2020 2020 2020 2023 2043 6865 636b 2072         # Check r
-00005ae0: 656c 6174 696f 6e20 6170 7020 6461 7461  elation app data
-00005af0: 2065 7869 7374 730a 2020 2020 2020 2020   exists.        
-00005b00: 6261 636b 656e 6420 3d20 6861 726e 6573  backend = harnes
-00005b10: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
-00005b20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00005b30: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
-00005b40: 7469 6f6e 5f69 6473 2827 6462 2729 2c20  tion_ids('db'), 
-00005b50: 5b72 656c 5f69 645d 290a 2020 2020 2020  [rel_id]).      
-00005b60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00005b70: 616c 287b 2761 7070 273a 2027 6461 7461  al({'app': 'data
-00005b80: 277d 2c20 6261 636b 656e 642e 7265 6c61  '}, backend.rela
-00005b90: 7469 6f6e 5f67 6574 2872 656c 5f69 642c  tion_get(rel_id,
-00005ba0: 2072 656d 6f74 655f 6170 702c 2069 735f   remote_app, is_
-00005bb0: 6170 703d 5472 7565 2929 0a20 2020 2020  app=True)).     
-00005bc0: 2020 2068 6172 6e65 7373 2e72 656d 6f76     harness.remov
-00005bd0: 655f 7265 6c61 7469 6f6e 2872 656c 5f69  e_relation(rel_i
-00005be0: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
-00005bf0: 6173 7365 7274 4973 4e6f 6e65 2873 656c  assertIsNone(sel
-00005c00: 662e 5f66 696e 645f 7265 6c61 7469 6f6e  f._find_relation
-00005c10: 5f69 6e5f 6d6f 6465 6c5f 6279 5f69 6428  _in_model_by_id(
-00005c20: 6861 726e 6573 732c 2072 656c 5f69 6429  harness, rel_id)
-00005c30: 290a 0a20 2020 2064 6566 205f 6669 6e64  )..    def _find
-00005c40: 5f72 656c 6174 696f 6e5f 696e 5f6d 6f64  _relation_in_mod
-00005c50: 656c 5f62 795f 6964 2873 656c 662c 2068  el_by_id(self, h
-00005c60: 6172 6e65 7373 2c20 7265 6c5f 6964 293a  arness, rel_id):
-00005c70: 0a20 2020 2020 2020 2066 6f72 2072 656c  .        for rel
-00005c80: 6174 696f 6e73 2069 6e20 6861 726e 6573  ations in harnes
-00005c90: 732e 6368 6172 6d2e 6d6f 6465 6c2e 7265  s.charm.model.re
-00005ca0: 6c61 7469 6f6e 732e 7661 6c75 6573 2829  lations.values()
-00005cb0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00005cc0: 7220 7265 6c61 7469 6f6e 2069 6e20 7265  r relation in re
-00005cd0: 6c61 7469 6f6e 733a 0a20 2020 2020 2020  lations:.       
-00005ce0: 2020 2020 2020 2020 2069 6620 7265 6c5f           if rel_
-00005cf0: 6964 203d 3d20 7265 6c61 7469 6f6e 2e69  id == relation.i
-00005d00: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00005d10: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00005d20: 6c61 7469 6f6e 0a20 2020 2020 2020 2072  lation.        r
-00005d30: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-00005d40: 6465 6620 7465 7374 5f72 656d 6f76 696e  def test_removin
-00005d50: 675f 7265 6c61 7469 6f6e 5f75 6e69 745f  g_relation_unit_
-00005d60: 7265 6d6f 7665 735f 6461 7461 5f61 6c73  removes_data_als
-00005d70: 6f28 7365 6c66 293a 0a20 2020 2020 2020  o(self):.       
-00005d80: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-00005d90: 7373 2852 656c 6174 696f 6e45 7665 6e74  ss(RelationEvent
-00005da0: 4368 6172 6d2c 206d 6574 613d 2727 270a  Charm, meta='''.
-00005db0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00005dc0: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-00005dd0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00005de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005df0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-00005e00: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-00005e10: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-00005e20: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00005e30: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00005e40: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00005e50: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-00005e60: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-00005e70: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
-00005e80: 6d2e 6f62 7365 7276 655f 7265 6c61 7469  m.observe_relati
-00005e90: 6f6e 5f65 7665 6e74 7328 2764 6227 290a  on_events('db').
-00005ea0: 2020 2020 2020 2020 2320 4164 6420 6120          # Add a 
-00005eb0: 7265 6c61 7469 6f6e 2061 6e64 2075 6e69  relation and uni
-00005ec0: 7420 7769 7468 2064 6174 610a 2020 2020  t with data.    
-00005ed0: 2020 2020 7265 6c5f 6964 203d 2068 6172      rel_id = har
-00005ee0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00005ef0: 6e28 2764 6227 2c20 2770 6f73 7467 7265  n('db', 'postgre
-00005f00: 7371 6c27 290a 2020 2020 2020 2020 7365  sql').        se
-00005f10: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-00005f20: 6e63 6528 7265 6c5f 6964 2c20 696e 7429  nce(rel_id, int)
-00005f30: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00005f40: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-00005f50: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
-00005f60: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
-00005f70: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00005f80: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-00005f90: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
-00005fa0: 7371 6c2f 3027 2c20 7b27 666f 6f27 3a20  sql/0', {'foo': 
-00005fb0: 2762 6172 277d 290a 2020 2020 2020 2020  'bar'}).        
-00005fc0: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
-00005fd0: 2c20 756e 6974 2061 6e64 2064 6174 6120  , unit and data 
-00005fe0: 6578 6973 740a 2020 2020 2020 2020 6261  exist.        ba
-00005ff0: 636b 656e 6420 3d20 6861 726e 6573 732e  ckend = harness.
-00006000: 5f62 6163 6b65 6e64 0a20 2020 2020 2020  _backend.       
-00006010: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00006020: 6c28 6261 636b 656e 642e 7265 6c61 7469  l(backend.relati
-00006030: 6f6e 5f69 6473 2827 6462 2729 2c20 5b72  on_ids('db'), [r
-00006040: 656c 5f69 645d 290a 2020 2020 2020 2020  el_id]).        
-00006050: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006060: 2862 6163 6b65 6e64 2e72 656c 6174 696f  (backend.relatio
-00006070: 6e5f 6c69 7374 2872 656c 5f69 6429 2c20  n_list(rel_id), 
-00006080: 5b27 706f 7374 6772 6573 716c 2f30 275d  ['postgresql/0']
-00006090: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-000060a0: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-000060b0: 2020 2020 2020 2020 6261 636b 656e 642e          backend.
-000060c0: 7265 6c61 7469 6f6e 5f67 6574 2872 656c  relation_get(rel
-000060d0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-000060e0: 2f30 272c 2069 735f 6170 703d 4661 6c73  /0', is_app=Fals
-000060f0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00006100: 7b27 666f 6f27 3a20 2762 6172 277d 290a  {'foo': 'bar'}).
-00006110: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00006120: 6368 6172 6d2e 6765 745f 6368 616e 6765  charm.get_change
-00006130: 7328 7265 7365 743d 5472 7565 2920 2023  s(reset=True)  #
-00006140: 2069 676e 6f72 6520 7265 6c61 7469 6f6e   ignore relation
-00006150: 2063 7265 6174 6564 2065 7665 6e74 730a   created events.
-00006160: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-00006170: 2075 6e69 7420 6275 7420 6e6f 7420 7265   unit but not re
-00006180: 6c61 7469 6f6e 0a20 2020 2020 2020 2068  lation.        h
-00006190: 6172 6e65 7373 2e72 656d 6f76 655f 7265  arness.remove_re
-000061a0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-000061b0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-000061c0: 3027 290a 2020 2020 2020 2020 2320 4368  0').        # Ch
-000061d0: 6563 6b20 7265 6c61 7469 6f6e 2065 7869  eck relation exi
-000061e0: 7374 7320 6275 7420 756e 6974 2061 6e64  sts but unit and
-000061f0: 2064 6174 6120 6172 6520 7265 6d6f 7665   data are remove
-00006200: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
-00006210: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
-00006220: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
-00006230: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
-00006240: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00006250: 7365 7274 4571 7561 6c28 6261 636b 656e  sertEqual(backen
-00006260: 642e 7265 6c61 7469 6f6e 5f6c 6973 7428  d.relation_list(
-00006270: 7265 6c5f 6964 292c 205b 5d29 0a20 2020  rel_id), []).   
-00006280: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00006290: 5261 6973 6573 284b 6579 4572 726f 722c  Raises(KeyError,
-000062a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000062b0: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-000062c0: 6e64 2e72 656c 6174 696f 6e5f 6765 742c  nd.relation_get,
-000062d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000062e0: 2020 2020 2020 2020 2020 2072 656c 5f69             rel_i
-000062f0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00006300: 2020 2020 2020 2020 2020 2020 2027 706f               'po
-00006310: 7374 6772 6573 716c 2f30 272c 0a20 2020  stgresql/0',.   
-00006320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006330: 2020 2020 2020 2069 735f 6170 703d 4661         is_app=Fa
-00006340: 6c73 6529 0a20 2020 2020 2020 2023 2043  lse).        # C
-00006350: 6865 636b 2072 656c 6174 696f 6e20 6465  heck relation de
-00006360: 7061 7274 6564 2077 6173 2072 6169 7365  parted was raise
-00006370: 6420 7769 7468 2063 6f72 7265 6374 2064  d with correct d
-00006380: 6174 610a 2020 2020 2020 2020 7365 6c66  ata.        self
-00006390: 2e61 7373 6572 7445 7175 616c 2868 6172  .assertEqual(har
-000063a0: 6e65 7373 2e63 6861 726d 2e67 6574 5f63  ness.charm.get_c
-000063b0: 6861 6e67 6573 2829 5b30 5d2c 0a20 2020  hanges()[0],.   
-000063c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063d0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-000063e0: 7265 6c61 7469 6f6e 2d64 6570 6172 7465  relation-departe
-000063f0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00006400: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-00006410: 656c 6174 696f 6e27 3a20 2764 6227 2c0a  elation': 'db',.
-00006420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006430: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
-00006440: 3a20 7b27 6170 7027 3a20 2770 6f73 7467  : {'app': 'postg
-00006450: 7265 7371 6c27 2c0a 2020 2020 2020 2020  resql',.        
-00006460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006470: 2020 2020 2020 2020 2020 2027 756e 6974             'unit
-00006480: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
-00006490: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000064a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064b0: 2020 2020 2020 2764 6570 6172 7469 6e67        'departing
-000064c0: 5f75 6e69 7427 3a20 2770 6f73 7467 7265  _unit': 'postgre
-000064d0: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
-000064e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064f0: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-00006500: 7469 6f6e 5f69 6427 3a20 7265 6c5f 6964  tion_id': rel_id
-00006510: 7d7d 290a 0a20 2020 2064 6566 2074 6573  }})..    def tes
-00006520: 745f 7265 6d6f 7669 6e67 5f72 656c 6174  t_removing_relat
-00006530: 696f 6e5f 756e 6974 5f64 6f65 735f 6e6f  ion_unit_does_no
-00006540: 745f 7265 6d6f 7665 5f6f 7468 6572 5f75  t_remove_other_u
-00006550: 6e69 745f 616e 645f 6461 7461 2873 656c  nit_and_data(sel
-00006560: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00006570: 6573 7320 3d20 4861 726e 6573 7328 5265  ess = Harness(Re
-00006580: 6c61 7469 6f6e 4576 656e 7443 6861 726d  lationEventCharm
-00006590: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-000065a0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-000065b0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-000065c0: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
-000065d0: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-000065e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065f0: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-00006600: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-00006610: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00006620: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00006630: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00006640: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-00006650: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
-00006660: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
-00006670: 6572 7665 5f72 656c 6174 696f 6e5f 6576  erve_relation_ev
-00006680: 656e 7473 2827 6462 2729 0a20 2020 2020  ents('db').     
-00006690: 2020 2023 2041 6464 2061 2072 656c 6174     # Add a relat
-000066a0: 696f 6e20 7769 7468 2074 776f 2075 6e69  ion with two uni
-000066b0: 7473 2077 6974 6820 6461 7461 0a20 2020  ts with data.   
-000066c0: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
-000066d0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-000066e0: 6f6e 2827 6462 272c 2027 706f 7374 6772  on('db', 'postgr
-000066f0: 6573 716c 2729 0a20 2020 2020 2020 2073  esql').        s
-00006700: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-00006710: 616e 6365 2872 656c 5f69 642c 2069 6e74  ance(rel_id, int
-00006720: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00006730: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-00006740: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
-00006750: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
-00006760: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-00006770: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-00006780: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-00006790: 6c2f 3127 290a 2020 2020 2020 2020 6861  l/1').        ha
-000067a0: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-000067b0: 6174 696f 6e5f 6461 7461 2872 656c 5f69  ation_data(rel_i
-000067c0: 642c 2027 706f 7374 6772 6573 716c 2f30  d, 'postgresql/0
-000067d0: 272c 207b 2766 6f6f 3027 3a20 2762 6172  ', {'foo0': 'bar
-000067e0: 3027 7d29 0a20 2020 2020 2020 2068 6172  0'}).        har
-000067f0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-00006800: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-00006810: 2c20 2770 6f73 7467 7265 7371 6c2f 3127  , 'postgresql/1'
-00006820: 2c20 7b27 666f 6f31 273a 2027 6261 7231  , {'foo1': 'bar1
-00006830: 277d 290a 2020 2020 2020 2020 2320 4368  '}).        # Ch
-00006840: 6563 6b20 626f 7468 2075 6e69 7420 616e  eck both unit an
-00006850: 6420 6461 7461 2061 7265 2070 7265 7365  d data are prese
-00006860: 6e74 0a20 2020 2020 2020 2062 6163 6b65  nt.        backe
-00006870: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
-00006880: 636b 656e 640a 2020 2020 2020 2020 7365  ckend.        se
-00006890: 6c66 2e61 7373 6572 7445 7175 616c 2862  lf.assertEqual(b
-000068a0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-000068b0: 6964 7328 2764 6227 292c 205b 7265 6c5f  ids('db'), [rel_
-000068c0: 6964 5d29 0a20 2020 2020 2020 2073 656c  id]).        sel
-000068d0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-000068e0: 636b 656e 642e 7265 6c61 7469 6f6e 5f6c  ckend.relation_l
-000068f0: 6973 7428 7265 6c5f 6964 292c 0a20 2020  ist(rel_id),.   
-00006900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006910: 2020 2020 2020 5b27 706f 7374 6772 6573        ['postgres
-00006920: 716c 2f30 272c 2027 706f 7374 6772 6573  ql/0', 'postgres
-00006930: 716c 2f31 275d 290a 2020 2020 2020 2020  ql/1']).        
-00006940: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006950: 280a 2020 2020 2020 2020 2020 2020 6261  (.            ba
-00006960: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-00006970: 6574 2872 656c 5f69 642c 2027 706f 7374  et(rel_id, 'post
-00006980: 6772 6573 716c 2f30 272c 2069 735f 6170  gresql/0', is_ap
-00006990: 703d 4661 6c73 6529 2c0a 2020 2020 2020  p=False),.      
-000069a0: 2020 2020 2020 7b27 666f 6f30 273a 2027        {'foo0': '
-000069b0: 6261 7230 277d 290a 2020 2020 2020 2020  bar0'}).        
-000069c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000069d0: 280a 2020 2020 2020 2020 2020 2020 6261  (.            ba
-000069e0: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-000069f0: 6574 2872 656c 5f69 642c 2027 706f 7374  et(rel_id, 'post
-00006a00: 6772 6573 716c 2f31 272c 2069 735f 6170  gresql/1', is_ap
-00006a10: 703d 4661 6c73 6529 2c0a 2020 2020 2020  p=False),.      
-00006a20: 2020 2020 2020 7b27 666f 6f31 273a 2027        {'foo1': '
-00006a30: 6261 7231 277d 290a 2020 2020 2020 2020  bar1'}).        
-00006a40: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
-00006a50: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
-00006a60: 5472 7565 2920 2023 2069 676e 6f72 6520  True)  # ignore 
-00006a70: 7265 6c61 7469 6f6e 2063 7265 6174 6564  relation created
-00006a80: 2065 7665 6e74 730a 2020 2020 2020 2020   events.        
-00006a90: 2320 5265 6d6f 7665 206f 6e6c 7920 6f6e  # Remove only on
-00006aa0: 6520 756e 6974 0a20 2020 2020 2020 2068  e unit.        h
-00006ab0: 6172 6e65 7373 2e72 656d 6f76 655f 7265  arness.remove_re
-00006ac0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-00006ad0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-00006ae0: 3127 290a 2020 2020 2020 2020 2320 4368  1').        # Ch
-00006af0: 6563 6b20 6f74 6865 7220 756e 6974 2061  eck other unit a
-00006b00: 6e64 2064 6174 6120 7374 696c 6c20 6578  nd data still ex
-00006b10: 6973 7473 0a20 2020 2020 2020 2073 656c  ists.        sel
-00006b20: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-00006b30: 636b 656e 642e 7265 6c61 7469 6f6e 5f6c  ckend.relation_l
-00006b40: 6973 7428 7265 6c5f 6964 292c 0a20 2020  ist(rel_id),.   
-00006b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b60: 2020 2020 2020 5b27 706f 7374 6772 6573        ['postgres
-00006b70: 716c 2f30 275d 290a 2020 2020 2020 2020  ql/0']).        
-00006b80: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00006b90: 280a 2020 2020 2020 2020 2020 2020 6261  (.            ba
-00006ba0: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-00006bb0: 6574 2872 656c 5f69 642c 2027 706f 7374  et(rel_id, 'post
-00006bc0: 6772 6573 716c 2f30 272c 2069 735f 6170  gresql/0', is_ap
-00006bd0: 703d 4661 6c73 6529 2c0a 2020 2020 2020  p=False),.      
-00006be0: 2020 2020 2020 7b27 666f 6f30 273a 2027        {'foo0': '
-00006bf0: 6261 7230 277d 290a 2020 2020 2020 2020  bar0'}).        
-00006c00: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
-00006c10: 2064 6570 6172 7465 6420 7761 7320 7261   departed was ra
-00006c20: 6973 6564 2077 6974 6820 636f 7272 6563  ised with correc
-00006c30: 7420 6461 7461 0a20 2020 2020 2020 2073  t data.        s
-00006c40: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00006c50: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
-00006c60: 745f 6368 616e 6765 7328 295b 305d 2c0a  t_changes()[0],.
-00006c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c80: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
-00006c90: 3a20 2772 656c 6174 696f 6e2d 6465 7061  : 'relation-depa
-00006ca0: 7274 6564 272c 0a20 2020 2020 2020 2020  rted',.         
-00006cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006cc0: 2027 7265 6c61 7469 6f6e 273a 2027 6462   'relation': 'db
-00006cd0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00006ce0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
-00006cf0: 7461 273a 207b 2761 7070 273a 2027 706f  ta': {'app': 'po
-00006d00: 7374 6772 6573 716c 272c 0a20 2020 2020  stgresql',.     
-00006d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d20: 2020 2020 2020 2020 2020 2020 2020 2775                'u
-00006d30: 6e69 7427 3a20 2770 6f73 7467 7265 7371  nit': 'postgresq
-00006d40: 6c2f 3127 2c0a 2020 2020 2020 2020 2020  l/1',.          
-00006d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d60: 2020 2020 2020 2020 2027 6465 7061 7274           'depart
-00006d70: 696e 675f 756e 6974 273a 2027 706f 7374  ing_unit': 'post
-00006d80: 6772 6573 716c 2f31 272c 0a20 2020 2020  gresql/1',.     
-00006d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006da0: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-00006db0: 656c 6174 696f 6e5f 6964 273a 2072 656c  elation_id': rel
-00006dc0: 5f69 647d 7d29 0a0a 2020 2020 6465 6620  _id}})..    def 
-00006dd0: 7465 7374 5f72 656c 6174 696f 6e5f 6576  test_relation_ev
-00006de0: 656e 7473 2873 656c 6629 3a0a 2020 2020  ents(self):.    
-00006df0: 2020 2020 6861 726e 6573 7320 3d20 4861      harness = Ha
-00006e00: 726e 6573 7328 5265 6c61 7469 6f6e 4576  rness(RelationEv
-00006e10: 656e 7443 6861 726d 2c20 6d65 7461 3d27  entCharm, meta='
-00006e20: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-00006e30: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-00006e40: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-00006e50: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00006e60: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-00006e70: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00006e80: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
-00006e90: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00006ea0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00006eb0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-00006ec0: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
-00006ed0: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
-00006ee0: 2020 2068 6172 6e65 7373 2e63 6861 726d     harness.charm
-00006ef0: 2e6f 6273 6572 7665 5f72 656c 6174 696f  .observe_relatio
-00006f00: 6e5f 6576 656e 7473 2827 6462 2729 0a20  n_events('db'). 
-00006f10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00006f20: 7274 4571 7561 6c28 6861 726e 6573 732e  rtEqual(harness.
-00006f30: 6368 6172 6d2e 6765 745f 6368 616e 6765  charm.get_change
-00006f40: 7328 292c 205b 5d29 0a20 2020 2020 2020  s(), []).       
-00006f50: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
-00006f60: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-00006f70: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
-00006f80: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00006f90: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
-00006fa0: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-00006fb0: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
-00006fc0: 6573 2829 2c0a 2020 2020 2020 2020 2020  es(),.          
-00006fd0: 2020 5b7b 276e 616d 6527 3a20 2772 656c    [{'name': 'rel
-00006fe0: 6174 696f 6e2d 6372 6561 7465 6427 2c0a  ation-created',.
-00006ff0: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-00007000: 656c 6174 696f 6e27 3a20 2764 6227 2c0a  elation': 'db',.
-00007010: 2020 2020 2020 2020 2020 2020 2020 2764                'd
-00007020: 6174 6127 3a20 7b0a 2020 2020 2020 2020  ata': {.        
-00007030: 2020 2020 2020 2020 2020 2761 7070 273a            'app':
-00007040: 2027 706f 7374 6772 6573 716c 272c 0a20   'postgresql',. 
-00007050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007060: 2027 756e 6974 273a 204e 6f6e 652c 0a20   'unit': None,. 
-00007070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007080: 2027 7265 6c61 7469 6f6e 5f69 6427 3a20   'relation_id': 
-00007090: 7265 6c5f 6964 2c0a 2020 2020 2020 2020  rel_id,.        
-000070a0: 2020 2020 2020 7d7d 5d29 0a20 2020 2020        }}]).     
-000070b0: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-000070c0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-000070d0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-000070e0: 2f30 2729 0a20 2020 2020 2020 2073 656c  /0').        sel
-000070f0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-00007100: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-00007110: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
-00007120: 6e67 6573 2829 2c0a 2020 2020 2020 2020  nges(),.        
-00007130: 2020 2020 5b7b 276e 616d 6527 3a20 2772      [{'name': 'r
-00007140: 656c 6174 696f 6e2d 6a6f 696e 6564 272c  elation-joined',
-00007150: 0a20 2020 2020 2020 2020 2020 2020 2027  .              '
-00007160: 7265 6c61 7469 6f6e 273a 2027 6462 272c  relation': 'db',
-00007170: 0a20 2020 2020 2020 2020 2020 2020 2027  .              '
-00007180: 6461 7461 273a 207b 0a20 2020 2020 2020  data': {.       
-00007190: 2020 2020 2020 2020 2020 2027 6170 7027             'app'
-000071a0: 3a20 2770 6f73 7467 7265 7371 6c27 2c0a  : 'postgresql',.
-000071b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000071c0: 2020 2775 6e69 7427 3a20 2770 6f73 7467    'unit': 'postg
-000071d0: 7265 7371 6c2f 3027 2c0a 2020 2020 2020  resql/0',.      
-000071e0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-000071f0: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
-00007200: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00007210: 207d 7d5d 290a 2020 2020 2020 2020 6861   }}]).        ha
-00007220: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-00007230: 6174 696f 6e5f 6461 7461 2872 656c 5f69  ation_data(rel_i
-00007240: 642c 2027 706f 7374 6772 6573 716c 272c  d, 'postgresql',
-00007250: 207b 2766 6f6f 273a 2027 6261 7227 7d29   {'foo': 'bar'})
-00007260: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00007270: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
-00007280: 2020 2020 2020 2068 6172 6e65 7373 2e63         harness.c
-00007290: 6861 726d 2e67 6574 5f63 6861 6e67 6573  harm.get_changes
-000072a0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-000072b0: 5b7b 276e 616d 6527 3a20 2772 656c 6174  [{'name': 'relat
-000072c0: 696f 6e2d 6368 616e 6765 6427 2c0a 2020  ion-changed',.  
-000072d0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-000072e0: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
-000072f0: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
-00007300: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
-00007310: 2020 2020 2020 2020 2761 7070 273a 2027          'app': '
-00007320: 706f 7374 6772 6573 716c 272c 0a20 2020  postgresql',.   
-00007330: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00007340: 756e 6974 273a 204e 6f6e 652c 0a20 2020  unit': None,.   
-00007350: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00007360: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
-00007370: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
-00007380: 2020 2020 7d7d 5d29 0a20 2020 2020 2020      }}]).       
-00007390: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-000073a0: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-000073b0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-000073c0: 6c2f 3027 2c20 7b27 6261 7a27 3a20 2762  l/0', {'baz': 'b
-000073d0: 696e 6727 7d29 0a20 2020 2020 2020 2073  ing'}).        s
-000073e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000073f0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-00007400: 6e65 7373 2e63 6861 726d 2e67 6574 5f63  ness.charm.get_c
-00007410: 6861 6e67 6573 2829 2c0a 2020 2020 2020  hanges(),.      
-00007420: 2020 2020 2020 5b7b 276e 616d 6527 3a20        [{'name': 
-00007430: 2772 656c 6174 696f 6e2d 6368 616e 6765  'relation-change
-00007440: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00007450: 2020 2772 656c 6174 696f 6e27 3a20 2764    'relation': 'd
-00007460: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00007470: 2020 2764 6174 6127 3a20 7b0a 2020 2020    'data': {.    
-00007480: 2020 2020 2020 2020 2020 2020 2020 2761                'a
-00007490: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
-000074a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000074b0: 2020 2020 2027 756e 6974 273a 2027 706f       'unit': 'po
-000074c0: 7374 6772 6573 716c 2f30 272c 0a20 2020  stgresql/0',.   
-000074d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000074e0: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
-000074f0: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
-00007500: 2020 2020 7d7d 5d29 0a0a 2020 2020 6465      }}])..    de
-00007510: 6620 7465 7374 5f67 6574 5f72 656c 6174  f test_get_relat
-00007520: 696f 6e5f 6461 7461 2873 656c 6629 3a0a  ion_data(self):.
-00007530: 2020 2020 2020 2020 6368 6172 6d5f 6d65          charm_me
-00007540: 7461 203d 2027 2727 0a20 2020 2020 2020  ta = '''.       
-00007550: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
-00007560: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
-00007570: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
-00007580: 2020 2020 2020 2020 2020 6462 3a0a 2020            db:.  
-00007590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000075a0: 2020 696e 7465 7266 6163 653a 2070 6773    interface: pgs
-000075b0: 716c 0a20 2020 2020 2020 2027 2727 0a20  ql.        '''. 
-000075c0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-000075d0: 2048 6172 6e65 7373 2843 6861 726d 4261   Harness(CharmBa
-000075e0: 7365 2c20 6d65 7461 3d63 6861 726d 5f6d  se, meta=charm_m
-000075f0: 6574 6129 0a20 2020 2020 2020 2073 656c  eta).        sel
-00007600: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00007610: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00007620: 2020 2020 2020 7265 6c5f 6964 203d 2068        rel_id = h
-00007630: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
-00007640: 696f 6e28 2764 6227 2c20 2770 6f73 7467  ion('db', 'postg
-00007650: 7265 7371 6c27 290a 2020 2020 2020 2020  resql').        
-00007660: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
-00007670: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
-00007680: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-00007690: 272c 207b 2772 656d 6f74 6527 3a20 2764  ', {'remote': 'd
-000076a0: 6174 6127 7d29 0a20 2020 2020 2020 2073  ata'}).        s
-000076b0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000076c0: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
-000076d0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-000076e0: 2c20 2774 6573 742d 6170 7027 292c 207b  , 'test-app'), {
-000076f0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-00007700: 6173 7365 7274 4571 7561 6c28 6861 726e  assertEqual(harn
-00007710: 6573 732e 6765 745f 7265 6c61 7469 6f6e  ess.get_relation
-00007720: 5f64 6174 6128 7265 6c5f 6964 2c20 2774  _data(rel_id, 't
-00007730: 6573 742d 6170 702f 3027 292c 207b 7d29  est-app/0'), {})
-00007740: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00007750: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
-00007760: 732e 6765 745f 7265 6c61 7469 6f6e 5f64  s.get_relation_d
-00007770: 6174 6128 7265 6c5f 6964 2c20 2774 6573  ata(rel_id, 'tes
-00007780: 742d 6170 702f 3127 292c 204e 6f6e 6529  t-app/1'), None)
-00007790: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000077a0: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
-000077b0: 732e 6765 745f 7265 6c61 7469 6f6e 5f64  s.get_relation_d
-000077c0: 6174 6128 7265 6c5f 6964 2c20 2770 6f73  ata(rel_id, 'pos
-000077d0: 7467 7265 7371 6c27 292c 207b 2772 656d  tgresql'), {'rem
-000077e0: 6f74 6527 3a20 2764 6174 6127 7d29 0a20  ote': 'data'}). 
-000077f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00007800: 2e61 7373 6572 7452 6169 7365 7328 4b65  .assertRaises(Ke
-00007810: 7945 7272 6f72 293a 0a20 2020 2020 2020  yError):.       
-00007820: 2020 2020 2023 2075 6e6b 6e6f 776e 2072       # unknown r
-00007830: 656c 6174 696f 6e20 6964 0a20 2020 2020  elation id.     
-00007840: 2020 2020 2020 2068 6172 6e65 7373 2e67         harness.g
-00007850: 6574 5f72 656c 6174 696f 6e5f 6461 7461  et_relation_data
-00007860: 2839 392c 2027 706f 7374 6772 6573 716c  (99, 'postgresql
-00007870: 2729 0a0a 2020 2020 2020 2020 6d65 7461  ')..        meta
-00007880: 203d 2079 616d 6c2e 7361 6665 5f6c 6f61   = yaml.safe_loa
-00007890: 6428 6368 6172 6d5f 6d65 7461 290a 2020  d(charm_meta).  
-000078a0: 2020 2020 2020 745f 6170 7020 3d20 4170        t_app = Ap
-000078b0: 706c 6963 6174 696f 6e28 2774 6573 742d  plication('test-
-000078c0: 6170 7027 2c20 6d65 7461 2c20 6861 726e  app', meta, harn
-000078d0: 6573 732e 5f62 6163 6b65 6e64 2c20 4e6f  ess._backend, No
-000078e0: 6e65 290a 2020 2020 2020 2020 745f 756e  ne).        t_un
-000078f0: 6974 3020 3d20 556e 6974 2827 7465 7374  it0 = Unit('test
-00007900: 2d61 7070 2f30 272c 206d 6574 612c 2068  -app/0', meta, h
-00007910: 6172 6e65 7373 2e5f 6261 636b 656e 642c  arness._backend,
-00007920: 207b 4170 706c 6963 6174 696f 6e3a 2074   {Application: t
-00007930: 5f61 7070 7d29 0a20 2020 2020 2020 2074  _app}).        t
-00007940: 5f75 6e69 7431 203d 2055 6e69 7428 2774  _unit1 = Unit('t
-00007950: 6573 742d 6170 702f 3127 2c20 6d65 7461  est-app/1', meta
-00007960: 2c20 6861 726e 6573 732e 5f62 6163 6b65  , harness._backe
-00007970: 6e64 2c20 7b41 7070 6c69 6361 7469 6f6e  nd, {Application
-00007980: 3a20 745f 6170 707d 290a 2020 2020 2020  : t_app}).      
-00007990: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000079a0: 616c 2868 6172 6e65 7373 2e67 6574 5f72  al(harness.get_r
-000079b0: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
-000079c0: 5f69 642c 2074 5f61 7070 292c 207b 7d29  _id, t_app), {})
-000079d0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000079e0: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
-000079f0: 732e 6765 745f 7265 6c61 7469 6f6e 5f64  s.get_relation_d
-00007a00: 6174 6128 7265 6c5f 6964 2c20 745f 756e  ata(rel_id, t_un
-00007a10: 6974 3029 2c20 7b7d 290a 2020 2020 2020  it0), {}).      
-00007a20: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00007a30: 616c 2868 6172 6e65 7373 2e67 6574 5f72  al(harness.get_r
-00007a40: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
-00007a50: 5f69 642c 2074 5f75 6e69 7431 292c 204e  _id, t_unit1), N
-00007a60: 6f6e 6529 0a20 2020 2020 2020 2070 675f  one).        pg_
-00007a70: 6170 7020 3d20 4170 706c 6963 6174 696f  app = Applicatio
-00007a80: 6e28 2770 6f73 7467 7265 7371 6c27 2c20  n('postgresql', 
-00007a90: 6d65 7461 2c20 6861 726e 6573 732e 5f62  meta, harness._b
-00007aa0: 6163 6b65 6e64 2c20 4e6f 6e65 290a 2020  ackend, None).  
-00007ab0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00007ac0: 7445 7175 616c 2868 6172 6e65 7373 2e67  tEqual(harness.g
-00007ad0: 6574 5f72 656c 6174 696f 6e5f 6461 7461  et_relation_data
-00007ae0: 2872 656c 5f69 642c 2070 675f 6170 7029  (rel_id, pg_app)
-00007af0: 2c20 7b27 7265 6d6f 7465 273a 2027 6461  , {'remote': 'da
-00007b00: 7461 277d 290a 0a20 2020 2064 6566 2074  ta'})..    def t
-00007b10: 6573 745f 6372 6561 7465 5f68 6172 6e65  est_create_harne
-00007b20: 7373 5f74 7769 6365 2873 656c 6629 3a0a  ss_twice(self):.
-00007b30: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-00007b40: 203d 2027 2727 0a20 2020 2020 2020 2020   = '''.         
-00007b50: 2020 206e 616d 653a 206d 792d 6368 6172     name: my-char
-00007b60: 6d0a 2020 2020 2020 2020 2020 2020 7265  m.            re
-00007b70: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00007b80: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
-00007b90: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-00007ba0: 6163 653a 2070 6773 716c 0a20 2020 2020  ace: pgsql.     
-00007bb0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00007bc0: 2020 2068 6172 6e65 7373 3120 3d20 4861     harness1 = Ha
-00007bd0: 726e 6573 7328 4368 6172 6d42 6173 652c  rness(CharmBase,
-00007be0: 206d 6574 613d 6d65 7461 6461 7461 290a   meta=metadata).
-00007bf0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00007c00: 436c 6561 6e75 7028 6861 726e 6573 7331  Cleanup(harness1
-00007c10: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00007c20: 2020 6861 726e 6573 7332 203d 2048 6172    harness2 = Har
-00007c30: 6e65 7373 2843 6861 726d 4261 7365 2c20  ness(CharmBase, 
-00007c40: 6d65 7461 3d6d 6574 6164 6174 6129 0a20  meta=metadata). 
-00007c50: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-00007c60: 6c65 616e 7570 2868 6172 6e65 7373 322e  leanup(harness2.
-00007c70: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-00007c80: 2068 6172 6e65 7373 312e 6265 6769 6e28   harness1.begin(
-00007c90: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00007ca0: 7332 2e62 6567 696e 2829 0a20 2020 2020  s2.begin().     
-00007cb0: 2020 2068 656c 7065 7231 203d 2044 4252     helper1 = DBR
-00007cc0: 656c 6174 696f 6e43 6861 6e67 6564 4865  elationChangedHe
-00007cd0: 6c70 6572 2868 6172 6e65 7373 312e 6368  lper(harness1.ch
-00007ce0: 6172 6d2c 2022 6865 6c70 6572 3122 290a  arm, "helper1").
-00007cf0: 2020 2020 2020 2020 6865 6c70 6572 3220          helper2 
-00007d00: 3d20 4442 5265 6c61 7469 6f6e 4368 616e  = DBRelationChan
-00007d10: 6765 6448 656c 7065 7228 6861 726e 6573  gedHelper(harnes
-00007d20: 7332 2e63 6861 726d 2c20 2268 656c 7065  s2.charm, "helpe
-00007d30: 7232 2229 0a20 2020 2020 2020 2072 656c  r2").        rel
-00007d40: 5f69 6420 3d20 6861 726e 6573 7332 2e61  _id = harness2.a
-00007d50: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
-00007d60: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
-00007d70: 2020 2020 2020 2020 6861 726e 6573 7332          harness2
-00007d80: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
-00007d90: 5f64 6174 6128 7265 6c5f 6964 2c20 2770  _data(rel_id, 'p
-00007da0: 6f73 7467 7265 7371 6c27 2c20 7b27 6b65  ostgresql', {'ke
-00007db0: 7927 3a20 2776 616c 7565 277d 290a 2020  y': 'value'}).  
-00007dc0: 2020 2020 2020 2320 4865 6c70 6572 3220        # Helper2 
-00007dd0: 7368 6f75 6c64 2073 6565 2074 6865 2065  should see the e
-00007de0: 7665 6e74 2074 7269 6767 6572 6564 2062  vent triggered b
-00007df0: 7920 6861 726e 6573 7332 2c20 6275 7420  y harness2, but 
-00007e00: 6865 6c70 6572 3120 7368 6f75 6c64 2073  helper1 should s
-00007e10: 6565 206e 6f20 6576 656e 7473 2e0a 2020  ee no events..  
-00007e20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00007e30: 7445 7175 616c 2868 656c 7065 7231 2e63  tEqual(helper1.c
-00007e40: 6861 6e67 6573 2c20 5b5d 290a 2020 2020  hanges, []).    
-00007e50: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00007e60: 7175 616c 2868 656c 7065 7232 2e63 6861  qual(helper2.cha
-00007e70: 6e67 6573 2c20 5b28 7265 6c5f 6964 2c20  nges, [(rel_id, 
-00007e80: 2770 6f73 7467 7265 7371 6c27 295d 290a  'postgresql')]).
-00007e90: 0a20 2020 2064 6566 2074 6573 745f 6265  .    def test_be
-00007ea0: 6769 6e5f 7477 6963 6528 7365 6c66 293a  gin_twice(self):
-00007eb0: 0a20 2020 2020 2020 2023 206c 616e 6775  .        # langu
-00007ec0: 6167 653d 5941 4d4c 0a20 2020 2020 2020  age=YAML.       
-00007ed0: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-00007ee0: 7373 2843 6861 726d 4261 7365 2c20 6d65  ss(CharmBase, me
-00007ef0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00007f00: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00007f10: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00007f20: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00007f30: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-00007f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f50: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00007f60: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00007f70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00007f80: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00007f90: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00007fa0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-00007fb0: 2829 0a20 2020 2020 2020 2077 6974 6820  ().        with 
-00007fc0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00007fd0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
-00007fe0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-00007ff0: 6e65 7373 2e62 6567 696e 2829 0a0a 2020  ness.begin()..  
-00008000: 2020 6465 6620 7465 7374 5f75 7064 6174    def test_updat
-00008010: 655f 7265 6c61 7469 6f6e 5f65 7870 6f73  e_relation_expos
-00008020: 6573 5f6e 6577 5f64 6174 6128 7365 6c66  es_new_data(self
-00008030: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-00008040: 7373 203d 2048 6172 6e65 7373 2843 6861  ss = Harness(Cha
-00008050: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-00008060: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00008070: 653a 206d 792d 6368 6172 6d0a 2020 2020  e: my-charm.    
-00008080: 2020 2020 2020 2020 7265 7175 6972 6573          requires
-00008090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000080a0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-000080b0: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-000080c0: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-000080d0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-000080e0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-000080f0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00008100: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-00008110: 6567 696e 2829 0a20 2020 2020 2020 2076  egin().        v
-00008120: 6965 7765 7220 3d20 5265 6c61 7469 6f6e  iewer = Relation
-00008130: 4368 616e 6765 6456 6965 7765 7228 6861  ChangedViewer(ha
-00008140: 726e 6573 732e 6368 6172 6d2c 2027 6462  rness.charm, 'db
-00008150: 2729 0a20 2020 2020 2020 2072 656c 5f69  ').        rel_i
-00008160: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
-00008170: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
-00008180: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
-00008190: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
-000081a0: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-000081b0: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-000081c0: 716c 2f30 2729 0a20 2020 2020 2020 2068  ql/0').        h
-000081d0: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-000081e0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-000081f0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-00008200: 3027 2c20 7b27 696e 6974 6961 6c27 3a20  0', {'initial': 
-00008210: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
-00008220: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00008230: 6c28 7669 6577 6572 2e63 6861 6e67 6573  l(viewer.changes
-00008240: 2c20 5b7b 2769 6e69 7469 616c 273a 2027  , [{'initial': '
-00008250: 6461 7461 277d 5d29 0a20 2020 2020 2020  data'}]).       
-00008260: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-00008270: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-00008280: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-00008290: 6c2f 3027 2c20 7b27 6e65 7727 3a20 2776  l/0', {'new': 'v
-000082a0: 616c 7565 277d 290a 2020 2020 2020 2020  alue'}).        
-000082b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000082c0: 2876 6965 7765 722e 6368 616e 6765 732c  (viewer.changes,
-000082d0: 205b 7b27 696e 6974 6961 6c27 3a20 2764   [{'initial': 'd
-000082e0: 6174 6127 7d2c 0a20 2020 2020 2020 2020  ata'},.         
-000082f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008310: 207b 2769 6e69 7469 616c 273a 2027 6461   {'initial': 'da
-00008320: 7461 272c 2027 6e65 7727 3a20 2776 616c  ta', 'new': 'val
-00008330: 7565 277d 5d29 0a0a 2020 2020 6465 6620  ue'}])..    def 
-00008340: 7465 7374 5f75 7064 6174 655f 7265 6c61  test_update_rela
-00008350: 7469 6f6e 5f6e 6f5f 6c6f 6361 6c5f 756e  tion_no_local_un
-00008360: 6974 5f63 6861 6e67 655f 6576 656e 7428  it_change_event(
-00008370: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
-00008380: 206c 616e 6775 6167 653d 5941 4d4c 0a20   language=YAML. 
-00008390: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-000083a0: 2048 6172 6e65 7373 2843 6861 726d 4261   Harness(CharmBa
-000083b0: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
-000083c0: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
-000083d0: 792d 6368 6172 6d0a 2020 2020 2020 2020  y-charm.        
-000083e0: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
-000083f0: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-00008400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008410: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00008420: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00008430: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00008440: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00008450: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00008460: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-00008470: 2829 0a20 2020 2020 2020 2068 656c 7065  ().        helpe
-00008480: 7220 3d20 4442 5265 6c61 7469 6f6e 4368  r = DBRelationCh
-00008490: 616e 6765 6448 656c 7065 7228 6861 726e  angedHelper(harn
-000084a0: 6573 732e 6368 6172 6d2c 2022 6865 6c70  ess.charm, "help
-000084b0: 6572 2229 0a20 2020 2020 2020 2072 656c  er").        rel
-000084c0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-000084d0: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
-000084e0: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
-000084f0: 2020 2020 2020 2072 656c 203d 2068 6172         rel = har
-00008500: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
-00008510: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-00008520: 6227 290a 2020 2020 2020 2020 7265 6c2e  b').        rel.
-00008530: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
-00008540: 726d 2e6d 6f64 656c 2e75 6e69 745d 5b27  rm.model.unit]['
-00008550: 6b65 7927 5d20 3d20 2776 616c 7565 270a  key'] = 'value'.
-00008560: 2020 2020 2020 2020 2320 7468 6572 6520          # there 
-00008570: 7368 6f75 6c64 2062 6520 6e6f 2065 7665  should be no eve
-00008580: 6e74 2066 6f72 2075 7064 6174 696e 6720  nt for updating 
-00008590: 6f75 7220 6f77 6e20 6461 7461 0a20 2020  our own data.   
-000085a0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-000085b0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-000085c0: 6128 7265 6c5f 6964 2c20 276d 792d 6368  a(rel_id, 'my-ch
-000085d0: 6172 6d2f 3027 2c20 7b27 6e65 7727 3a20  arm/0', {'new': 
-000085e0: 276f 7468 6572 277d 290a 2020 2020 2020  'other'}).      
-000085f0: 2020 2320 6275 7420 7468 6520 6461 7461    # but the data
-00008600: 2077 696c 6c20 6265 2075 7064 6174 6564   will be updated
-00008610: 2e0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00008620: 7373 6572 7445 7175 616c 287b 276b 6579  ssertEqual({'key
-00008630: 273a 2027 7661 6c75 6527 2c20 276e 6577  ': 'value', 'new
-00008640: 273a 2027 6f74 6865 7227 7d2c 2072 656c  ': 'other'}, rel
-00008650: 2e64 6174 615b 6861 726e 6573 732e 6368  .data[harness.ch
-00008660: 6172 6d2e 6d6f 6465 6c2e 756e 6974 5d29  arm.model.unit])
-00008670: 0a0a 2020 2020 2020 2020 7265 6c2e 6461  ..        rel.da
-00008680: 7461 5b68 6172 6e65 7373 2e63 6861 726d  ta[harness.charm
-00008690: 2e6d 6f64 656c 2e75 6e69 745d 5b27 6e65  .model.unit]['ne
-000086a0: 7727 5d20 3d20 2776 616c 7565 270a 2020  w'] = 'value'.  
-000086b0: 2020 2020 2020 2320 4f75 7220 756e 6974        # Our unit
-000086c0: 2064 6174 6120 6261 6720 676f 7420 7570   data bag got up
-000086d0: 6461 7465 642e 0a20 2020 2020 2020 2073  dated..        s
-000086e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000086f0: 7265 6c2e 6461 7461 5b68 6172 6e65 7373  rel.data[harness
-00008700: 2e63 6861 726d 2e6d 6f64 656c 2e75 6e69  .charm.model.uni
-00008710: 745d 5b27 6e65 7727 5d2c 2027 7661 6c75  t]['new'], 'valu
-00008720: 6527 290a 2020 2020 2020 2020 2320 4275  e').        # Bu
-00008730: 7420 7468 6572 6520 7765 7265 206e 6f20  t there were no 
-00008740: 6368 616e 6765 6420 6576 656e 7473 2072  changed events r
-00008750: 6567 6973 7465 7265 6420 6279 206f 7572  egistered by our
-00008760: 2075 6e69 742e 0a20 2020 2020 2020 2073   unit..        s
-00008770: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00008780: 5b5d 2c20 6865 6c70 6572 2e63 6861 6e67  [], helper.chang
-00008790: 6573 290a 0a20 2020 2064 6566 2074 6573  es)..    def tes
-000087a0: 745f 7570 6461 7465 5f70 6565 725f 7265  t_update_peer_re
-000087b0: 6c61 7469 6f6e 5f6e 6f5f 6c6f 6361 6c5f  lation_no_local_
-000087c0: 756e 6974 5f63 6861 6e67 655f 6576 656e  unit_change_even
-000087d0: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-000087e0: 2023 206c 616e 6775 6167 653d 5941 4d4c   # language=YAML
-000087f0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00008800: 203d 2048 6172 6e65 7373 2843 6861 726d   = Harness(Charm
-00008810: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-00008820: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-00008830: 2070 6f73 7467 7265 7371 6c0a 2020 2020   postgresql.    
-00008840: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
-00008850: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-00008860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008870: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
-00008880: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
-00008890: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000088a0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-000088b0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-000088c0: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
-000088d0: 6e28 290a 2020 2020 2020 2020 6865 6c70  n().        help
-000088e0: 6572 203d 2044 4252 656c 6174 696f 6e43  er = DBRelationC
-000088f0: 6861 6e67 6564 4865 6c70 6572 2868 6172  hangedHelper(har
-00008900: 6e65 7373 2e63 6861 726d 2c20 2268 656c  ness.charm, "hel
-00008910: 7065 7222 290a 2020 2020 2020 2020 7265  per").        re
-00008920: 6c5f 6964 203d 2068 6172 6e65 7373 2e61  l_id = harness.a
-00008930: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
-00008940: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
-00008950: 0a20 2020 2020 2020 2072 656c 203d 2068  .        rel = h
-00008960: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
-00008970: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
-00008980: 2764 6227 290a 2020 2020 2020 2020 7265  'db').        re
-00008990: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
-000089a0: 6861 726d 2e6d 6f64 656c 2e75 6e69 745d  harm.model.unit]
-000089b0: 5b27 6b65 7927 5d20 3d20 2776 616c 7565  ['key'] = 'value
-000089c0: 270a 2020 2020 2020 2020 7265 6c20 3d20  '.        rel = 
-000089d0: 6861 726e 6573 732e 6368 6172 6d2e 6d6f  harness.charm.mo
-000089e0: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-000089f0: 2827 6462 2729 0a20 2020 2020 2020 2068  ('db').        h
-00008a00: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
-00008a10: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-00008a20: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-00008a30: 3027 2c20 7b27 6b65 7927 3a20 2776 3127  0', {'key': 'v1'
-00008a40: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-00008a50: 6173 7365 7274 4571 7561 6c28 7b27 6b65  assertEqual({'ke
-00008a60: 7927 3a20 2776 3127 7d2c 2072 656c 2e64  y': 'v1'}, rel.d
-00008a70: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
-00008a80: 6d2e 6d6f 6465 6c2e 756e 6974 5d29 0a20  m.model.unit]). 
-00008a90: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
-00008aa0: 7265 2074 6865 7265 2077 6173 206e 6f20  re there was no 
-00008ab0: 6576 656e 740a 2020 2020 2020 2020 7365  event.        se
-00008ac0: 6c66 2e61 7373 6572 7445 7175 616c 285b  lf.assertEqual([
-00008ad0: 5d2c 2068 656c 7065 722e 6368 616e 6765  ], helper.change
-00008ae0: 7329 0a0a 2020 2020 2020 2020 7265 6c2e  s)..        rel.
-00008af0: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
-00008b00: 726d 2e6d 6f64 656c 2e75 6e69 745d 5b27  rm.model.unit]['
-00008b10: 6b65 7927 5d20 3d20 2776 3227 0a20 2020  key'] = 'v2'.   
-00008b20: 2020 2020 2023 204f 7572 2075 6e69 7420       # Our unit 
-00008b30: 6461 7461 2062 6167 2067 6f74 2075 7064  data bag got upd
-00008b40: 6174 6564 2e0a 2020 2020 2020 2020 7365  ated..        se
-00008b50: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
-00008b60: 276b 6579 273a 2027 7632 277d 2c20 6469  'key': 'v2'}, di
-00008b70: 6374 2872 656c 2e64 6174 615b 6861 726e  ct(rel.data[harn
-00008b80: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
-00008b90: 756e 6974 5d29 290a 2020 2020 2020 2020  unit])).        
-00008ba0: 2320 4275 7420 7468 6572 6520 7765 7265  # But there were
-00008bb0: 206e 6f20 6368 616e 6765 6420 6576 656e   no changed even
-00008bc0: 7473 2072 6567 6973 7465 7265 6420 6279  ts registered by
-00008bd0: 206f 7572 2075 6e69 742e 0a20 2020 2020   our unit..     
-00008be0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00008bf0: 7561 6c28 5b5d 2c20 6865 6c70 6572 2e63  ual([], helper.c
-00008c00: 6861 6e67 6573 290a 0a20 2020 2020 2020  hanges)..       
-00008c10: 2023 2053 616d 6520 666f 7220 7768 656e   # Same for when
-00008c20: 206f 7572 2075 6e69 7420 6973 2061 206c   our unit is a l
-00008c30: 6561 6465 722e 0a20 2020 2020 2020 2068  eader..        h
-00008c40: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
-00008c50: 7228 6973 5f6c 6561 6465 723d 5472 7565  r(is_leader=True
-00008c60: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00008c70: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
-00008c80: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
-00008c90: 706f 7374 6772 6573 716c 2f30 272c 207b  postgresql/0', {
-00008ca0: 276b 6579 273a 2027 7633 277d 290a 2020  'key': 'v3'}).  
-00008cb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00008cc0: 7445 7175 616c 287b 276b 6579 273a 2027  tEqual({'key': '
-00008cd0: 7633 277d 2c20 6469 6374 2872 656c 2e64  v3'}, dict(rel.d
-00008ce0: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
-00008cf0: 6d2e 6d6f 6465 6c2e 756e 6974 5d29 290a  m.model.unit])).
-00008d00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00008d10: 6572 7445 7175 616c 285b 5d2c 2068 656c  ertEqual([], hel
-00008d20: 7065 722e 6368 616e 6765 7329 0a0a 2020  per.changes)..  
-00008d30: 2020 2020 2020 7265 6c2e 6461 7461 5b68        rel.data[h
-00008d40: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
-00008d50: 656c 2e75 6e69 745d 5b27 6b65 7927 5d20  el.unit]['key'] 
-00008d60: 3d20 2776 3427 0a20 2020 2020 2020 2073  = 'v4'.        s
-00008d70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00008d80: 7265 6c2e 6461 7461 5b68 6172 6e65 7373  rel.data[harness
-00008d90: 2e63 6861 726d 2e6d 6f64 656c 2e75 6e69  .charm.model.uni
-00008da0: 745d 5b27 6b65 7927 5d2c 2027 7634 2729  t]['key'], 'v4')
-00008db0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008dc0: 7365 7274 4571 7561 6c28 5b5d 2c20 6865  sertEqual([], he
-00008dd0: 6c70 6572 2e63 6861 6e67 6573 290a 0a20  lper.changes).. 
-00008de0: 2020 2064 6566 2074 6573 745f 6861 726e     def test_harn
-00008df0: 6573 735f 6c65 6164 6572 5f6d 6973 636f  ess_leader_misco
-00008e00: 6e66 6967 2873 656c 6629 3a0a 2020 2020  nfig(self):.    
-00008e10: 2020 2020 2320 6c61 6e67 7561 6765 3d59      # language=Y
-00008e20: 414d 4c0a 2020 2020 2020 2020 6861 726e  AML.        harn
-00008e30: 6573 7320 3d20 4861 726e 6573 7328 5365  ess = Harness(Se
-00008e40: 744c 6561 6465 7245 7272 6f72 5465 7374  tLeaderErrorTest
-00008e50: 6572 2c20 6d65 7461 3d27 2727 0a20 2020  er, meta='''.   
-00008e60: 2020 2020 2020 2020 206e 616d 653a 2070           name: p
-00008e70: 6f73 7467 7265 7371 6c0a 2020 2020 2020  ostgresql.      
-00008e80: 2020 2020 2020 7065 6572 733a 0a20 2020        peers:.   
-00008e90: 2020 2020 2020 2020 2020 2070 6565 723a             peer:
-00008ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008eb0: 2069 6e74 6572 6661 6365 3a20 666f 6f0a   interface: foo.
-00008ec0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00008ed0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00008ee0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00008ef0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00008f00: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-00008f10: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-00008f20: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00008f30: 7328 5275 6e74 696d 6545 7272 6f72 2920  s(RuntimeError) 
-00008f40: 6173 2063 6d3a 0a20 2020 2020 2020 2020  as cm:.         
-00008f50: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
-00008f60: 6561 6465 7228 6973 5f6c 6561 6465 723d  eader(is_leader=
-00008f70: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-00008f80: 6c66 2e61 7373 6572 7454 7275 6528 636d  lf.assertTrue(cm
-00008f90: 2e65 7863 6570 7469 6f6e 2e61 7267 735b  .exception.args[
-00008fa0: 305d 2e66 696e 6428 2775 7365 2048 6172  0].find('use Har
-00008fb0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00008fc0: 6e27 2920 213d 202d 3129 0a0a 2020 2020  n') != -1)..    
-00008fd0: 6465 6620 7465 7374 5f75 7064 6174 655f  def test_update_
-00008fe0: 7065 6572 5f72 656c 6174 696f 6e5f 6170  peer_relation_ap
-00008ff0: 705f 6461 7461 2873 656c 6629 3a0a 2020  p_data(self):.  
-00009000: 2020 2020 2020 2320 6c61 6e67 7561 6765        # language
-00009010: 3d59 414d 4c0a 2020 2020 2020 2020 6861  =YAML.        ha
-00009020: 726e 6573 7320 3d20 4861 726e 6573 7328  rness = Harness(
-00009030: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-00009040: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00009050: 6e61 6d65 3a20 706f 7374 6772 6573 716c  name: postgresql
-00009060: 0a20 2020 2020 2020 2020 2020 2070 6565  .            pee
-00009070: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00009080: 2020 6462 3a0a 2020 2020 2020 2020 2020    db:.          
-00009090: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
-000090a0: 2070 6773 716c 0a20 2020 2020 2020 2020   pgsql.         
-000090b0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-000090c0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-000090d0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-000090e0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-000090f0: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-00009100: 2068 6172 6e65 7373 2e73 6574 5f6c 6561   harness.set_lea
-00009110: 6465 7228 6973 5f6c 6561 6465 723d 5472  der(is_leader=Tr
-00009120: 7565 290a 2020 2020 2020 2020 6865 6c70  ue).        help
-00009130: 6572 203d 2044 4252 656c 6174 696f 6e43  er = DBRelationC
-00009140: 6861 6e67 6564 4865 6c70 6572 2868 6172  hangedHelper(har
-00009150: 6e65 7373 2e63 6861 726d 2c20 2268 656c  ness.charm, "hel
-00009160: 7065 7222 290a 2020 2020 2020 2020 7265  per").        re
-00009170: 6c5f 6964 203d 2068 6172 6e65 7373 2e61  l_id = harness.a
-00009180: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
-00009190: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
-000091a0: 2020 2020 2020 2020 7265 6c20 3d20 6861          rel = ha
-000091b0: 726e 6573 732e 6368 6172 6d2e 6d6f 6465  rness.charm.mode
-000091c0: 6c2e 6765 745f 7265 6c61 7469 6f6e 2827  l.get_relation('
-000091d0: 6462 2729 0a20 2020 2020 2020 2072 656c  db').        rel
-000091e0: 2e64 6174 615b 6861 726e 6573 732e 6368  .data[harness.ch
-000091f0: 6172 6d2e 6170 705d 5b27 6b65 7927 5d20  arm.app]['key'] 
-00009200: 3d20 2776 616c 7565 270a 2020 2020 2020  = 'value'.      
-00009210: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00009220: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00009230: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-00009240: 716c 272c 207b 276b 6579 273a 2027 7631  ql', {'key': 'v1
-00009250: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-00009260: 2e61 7373 6572 7445 7175 616c 287b 276b  .assertEqual({'k
-00009270: 6579 273a 2027 7631 277d 2c20 7265 6c2e  ey': 'v1'}, rel.
-00009280: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
-00009290: 726d 2e61 7070 5d29 0a20 2020 2020 2020  rm.app]).       
-000092a0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-000092b0: 6c28 5b5d 2c20 6865 6c70 6572 2e63 6861  l([], helper.cha
-000092c0: 6e67 6573 290a 0a20 2020 2020 2020 2072  nges)..        r
-000092d0: 656c 2e64 6174 615b 6861 726e 6573 732e  el.data[harness.
-000092e0: 6368 6172 6d2e 6170 705d 5b27 6b65 7927  charm.app]['key'
-000092f0: 5d20 3d20 2776 3227 0a20 2020 2020 2020  ] = 'v2'.       
-00009300: 2023 204f 7572 2075 6e69 7420 6461 7461   # Our unit data
-00009310: 2062 6167 2067 6f74 2075 7064 6174 6564   bag got updated
-00009320: 2e0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-00009330: 7373 6572 7445 7175 616c 2872 656c 2e64  ssertEqual(rel.d
-00009340: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
-00009350: 6d2e 6d6f 6465 6c2e 6170 705d 5b27 6b65  m.model.app]['ke
-00009360: 7927 5d2c 2027 7632 2729 0a20 2020 2020  y'], 'v2').     
-00009370: 2020 2023 2042 7574 2074 6865 7265 2077     # But there w
-00009380: 6572 6520 6e6f 2063 6861 6e67 6564 2065  ere no changed e
-00009390: 7665 6e74 7320 7265 6769 7374 6572 6564  vents registered
-000093a0: 2062 7920 6f75 7220 756e 6974 2e0a 2020   by our unit..  
-000093b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000093c0: 7445 7175 616c 285b 5d2c 2068 656c 7065  tEqual([], helpe
-000093d0: 722e 6368 616e 6765 7329 0a0a 2020 2020  r.changes)..    
-000093e0: 2020 2020 2320 4966 206f 7572 2075 6e69      # If our uni
-000093f0: 7420 6973 206e 6f74 2061 206c 6561 6465  t is not a leade
-00009400: 7220 756e 6974 2077 6520 6765 7420 616e  r unit we get an
-00009410: 2075 7064 6174 6520 6162 6f75 7420 7065   update about pe
-00009420: 6572 2061 7070 2072 656c 6174 696f 6e20  er app relation 
-00009430: 6461 7461 2063 6861 6e67 6573 2e0a 2020  data changes..  
-00009440: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-00009450: 745f 6c65 6164 6572 2869 735f 6c65 6164  t_leader(is_lead
-00009460: 6572 3d46 616c 7365 290a 2020 2020 2020  er=False).      
-00009470: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00009480: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00009490: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-000094a0: 716c 272c 207b 276b 3227 3a20 2776 3227  ql', {'k2': 'v2'
-000094b0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-000094c0: 6173 7365 7274 4571 7561 6c28 7265 6c2e  assertEqual(rel.
-000094d0: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
-000094e0: 726d 2e6d 6f64 656c 2e61 7070 5d5b 276b  rm.model.app]['k
-000094f0: 3227 5d2c 2027 7632 2729 0a20 2020 2020  2'], 'v2').     
-00009500: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00009510: 7561 6c28 6865 6c70 6572 2e63 6861 6e67  ual(helper.chang
-00009520: 6573 2c20 5b28 302c 2027 706f 7374 6772  es, [(0, 'postgr
-00009530: 6573 716c 2729 5d29 0a0a 2020 2020 6465  esql')])..    de
-00009540: 6620 7465 7374 5f75 7064 6174 655f 7265  f test_update_re
-00009550: 6c61 7469 6f6e 5f6e 6f5f 6c6f 6361 6c5f  lation_no_local_
-00009560: 6170 705f 6368 616e 6765 5f65 7665 6e74  app_change_event
-00009570: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00009580: 2320 6c61 6e67 7561 6765 3d59 414d 4c0a  # language=YAML.
-00009590: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-000095a0: 3d20 4861 726e 6573 7328 4368 6172 6d42  = Harness(CharmB
-000095b0: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
-000095c0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-000095d0: 6d79 2d63 6861 726d 0a20 2020 2020 2020  my-charm.       
-000095e0: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
-000095f0: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-00009600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009610: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
-00009620: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
-00009630: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00009640: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00009650: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-00009660: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
-00009670: 6e28 290a 2020 2020 2020 2020 6861 726e  n().        harn
-00009680: 6573 732e 7365 745f 6c65 6164 6572 2846  ess.set_leader(F
-00009690: 616c 7365 290a 2020 2020 2020 2020 6865  alse).        he
-000096a0: 6c70 6572 203d 2044 4252 656c 6174 696f  lper = DBRelatio
-000096b0: 6e43 6861 6e67 6564 4865 6c70 6572 2868  nChangedHelper(h
-000096c0: 6172 6e65 7373 2e63 6861 726d 2c20 2268  arness.charm, "h
-000096d0: 656c 7065 7222 290a 2020 2020 2020 2020  elper").        
-000096e0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-000096f0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-00009700: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
-00009710: 290a 2020 2020 2020 2020 2320 544f 444f  ).        # TODO
-00009720: 3a20 7265 6d6f 7665 2074 6869 7320 6173  : remove this as
-00009730: 2073 6f6f 6e20 6173 2068 7474 7073 3a2f   soon as https:/
-00009740: 2f67 6974 6875 622e 636f 6d2f 6361 6e6f  /github.com/cano
-00009750: 6e69 6361 6c2f 6f70 6572 6174 6f72 2f69  nical/operator/i
-00009760: 7373 7565 732f 3137 3520 6973 2066 6978  ssues/175 is fix
-00009770: 6564 2e0a 2020 2020 2020 2020 6861 726e  ed..        harn
-00009780: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00009790: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
-000097a0: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
-000097b0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000097c0: 7445 7175 616c 2868 656c 7065 722e 6368  tEqual(helper.ch
-000097d0: 616e 6765 732c 205b 5d29 0a0a 2020 2020  anges, [])..    
-000097e0: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-000097f0: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-00009800: 2872 656c 5f69 642c 2027 6d79 2d63 6861  (rel_id, 'my-cha
-00009810: 726d 272c 207b 276e 6577 273a 2027 7661  rm', {'new': 'va
-00009820: 6c75 6527 7d29 0a20 2020 2020 2020 2072  lue'}).        r
-00009830: 656c 203d 2068 6172 6e65 7373 2e63 6861  el = harness.cha
-00009840: 726d 2e6d 6f64 656c 2e67 6574 5f72 656c  rm.model.get_rel
-00009850: 6174 696f 6e28 2764 6227 290a 2020 2020  ation('db').    
-00009860: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00009870: 7175 616c 2872 656c 2e64 6174 615b 6861  qual(rel.data[ha
-00009880: 726e 6573 732e 6368 6172 6d2e 6170 705d  rness.charm.app]
-00009890: 5b27 6e65 7727 5d2c 2027 7661 6c75 6527  ['new'], 'value'
-000098a0: 290a 0a20 2020 2020 2020 2023 204f 7572  )..        # Our
-000098b0: 2061 7070 2064 6174 6120 6261 6720 676f   app data bag go
-000098c0: 7420 7570 6461 7465 642e 0a20 2020 2020  t updated..     
+00005260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005270: 2020 2020 2020 2020 2020 2020 2020 2770                'p
+00005280: 6f73 7467 7265 7371 6c27 3a20 7b7d 7d7d  ostgresql': {}}}
+00005290: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+000052a0: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+000052b0: 6573 732e 6368 6172 6d2e 6765 745f 6368  ess.charm.get_ch
+000052c0: 616e 6765 7328 295b 305d 290a 0a20 2020  anges()[0])..   
+000052d0: 2064 6566 2074 6573 745f 7265 6d6f 7669   def test_removi
+000052e0: 6e67 5f72 656c 6174 696f 6e5f 7265 6d6f  ng_relation_remo
+000052f0: 7665 735f 7265 6d6f 7465 5f61 7070 5f64  ves_remote_app_d
+00005300: 6174 6128 7365 6c66 293a 0a20 2020 2020  ata(self):.     
+00005310: 2020 2023 206c 616e 6775 6167 653d 5941     # language=YA
+00005320: 4d4c 0a20 2020 2020 2020 2068 6172 6e65  ML.        harne
+00005330: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+00005340: 2e48 6172 6e65 7373 2852 656c 6174 696f  .Harness(Relatio
+00005350: 6e45 7665 6e74 4368 6172 6d2c 206d 6574  nEventCharm, met
+00005360: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+00005370: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+00005380: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+00005390: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+000053a0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+000053b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000053c0: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+000053d0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+000053e0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+000053f0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+00005400: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+00005410: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+00005420: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00005430: 732e 6368 6172 6d2e 6f62 7365 7276 655f  s.charm.observe_
+00005440: 7265 6c61 7469 6f6e 5f65 7665 6e74 7328  relation_events(
+00005450: 2764 6227 290a 2020 2020 2020 2020 2320  'db').        # 
+00005460: 4164 6420 6120 7265 6c61 7469 6f6e 2061  Add a relation a
+00005470: 6e64 2075 7064 6174 6520 6170 7020 6461  nd update app da
+00005480: 7461 0a20 2020 2020 2020 2072 656d 6f74  ta.        remot
+00005490: 655f 6170 7020 3d20 2770 6f73 7467 7265  e_app = 'postgre
+000054a0: 7371 6c27 0a20 2020 2020 2020 2072 656c  sql'.        rel
+000054b0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
+000054c0: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
+000054d0: 2072 656d 6f74 655f 6170 7029 0a20 2020   remote_app).   
+000054e0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
+000054f0: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+00005500: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
+00005510: 7265 7371 6c27 2c20 7b27 6170 7027 3a20  resql', {'app': 
+00005520: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
+00005530: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+00005540: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
+00005550: 6e74 290a 2020 2020 2020 2020 2320 4368  nt).        # Ch
+00005560: 6563 6b20 7265 6c61 7469 6f6e 2061 7070  eck relation app
+00005570: 2064 6174 6120 6578 6973 7473 0a20 2020   data exists.   
+00005580: 2020 2020 2062 6163 6b65 6e64 203d 2068       backend = h
+00005590: 6172 6e65 7373 2e5f 6261 636b 656e 640a  arness._backend.
+000055a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000055b0: 6572 7445 7175 616c 2862 6163 6b65 6e64  ertEqual(backend
+000055c0: 2e72 656c 6174 696f 6e5f 6964 7328 2764  .relation_ids('d
+000055d0: 6227 292c 205b 7265 6c5f 6964 5d29 0a20  b'), [rel_id]). 
+000055e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000055f0: 7274 4571 7561 6c28 7b27 6170 7027 3a20  rtEqual({'app': 
+00005600: 2764 6174 6127 7d2c 2062 6163 6b65 6e64  'data'}, backend
+00005610: 2e72 656c 6174 696f 6e5f 6765 7428 7265  .relation_get(re
+00005620: 6c5f 6964 2c20 7265 6d6f 7465 5f61 7070  l_id, remote_app
+00005630: 2c20 6973 5f61 7070 3d54 7275 6529 290a  , is_app=True)).
+00005640: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00005650: 7265 6d6f 7665 5f72 656c 6174 696f 6e28  remove_relation(
+00005660: 7265 6c5f 6964 290a 2020 2020 2020 2020  rel_id).        
+00005670: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
+00005680: 2061 6e64 2061 7070 2064 6174 6120 6172   and app data ar
+00005690: 6520 7265 6d6f 7665 640a 2020 2020 2020  e removed.      
+000056a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000056b0: 616c 2862 6163 6b65 6e64 2e72 656c 6174  al(backend.relat
+000056c0: 696f 6e5f 6964 7328 2764 6227 292c 205b  ion_ids('db'), [
+000056d0: 5d29 0a20 2020 2020 2020 2077 6974 6820  ]).        with 
+000056e0: 6861 726e 6573 732e 5f65 7665 6e74 5f63  harness._event_c
+000056f0: 6f6e 7465 7874 2827 666f 6f27 293a 0a20  ontext('foo'):. 
+00005700: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00005710: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+00005720: 2e52 656c 6174 696f 6e4e 6f74 466f 756e  .RelationNotFoun
+00005730: 6445 7272 6f72 2c20 6261 636b 656e 642e  dError, backend.
+00005740: 7265 6c61 7469 6f6e 5f67 6574 2c0a 2020  relation_get,.  
+00005750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005760: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
+00005770: 6964 2c20 7265 6d6f 7465 5f61 7070 2c20  id, remote_app, 
+00005780: 6973 5f61 7070 3d54 7275 6529 0a0a 2020  is_app=True)..  
+00005790: 2020 6465 6620 7465 7374 5f72 656d 6f76    def test_remov
+000057a0: 696e 675f 7265 6c61 7469 6f6e 5f72 6566  ing_relation_ref
+000057b0: 7265 7368 6573 5f63 6861 726d 5f6d 6f64  reshes_charm_mod
+000057c0: 656c 2873 656c 6629 3a0a 2020 2020 2020  el(self):.      
+000057d0: 2020 2320 6c61 6e67 7561 6765 3d59 414d    # language=YAM
+000057e0: 4c0a 2020 2020 2020 2020 6861 726e 6573  L.        harnes
+000057f0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00005800: 4861 726e 6573 7328 5265 6c61 7469 6f6e  Harness(Relation
+00005810: 4576 656e 7443 6861 726d 2c20 6d65 7461  EventCharm, meta
+00005820: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+00005830: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
+00005840: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+00005850: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+00005860: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
+00005870: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00005880: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
+00005890: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+000058a0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+000058b0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+000058c0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+000058d0: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
+000058e0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000058f0: 2e63 6861 726d 2e6f 6273 6572 7665 5f72  .charm.observe_r
+00005900: 656c 6174 696f 6e5f 6576 656e 7473 2827  elation_events('
+00005910: 6462 2729 0a20 2020 2020 2020 2023 2041  db').        # A
+00005920: 6464 2061 2072 656c 6174 696f 6e20 616e  dd a relation an
+00005930: 6420 7570 6461 7465 2061 7070 2064 6174  d update app dat
+00005940: 610a 2020 2020 2020 2020 7265 6d6f 7465  a.        remote
+00005950: 5f61 7070 203d 2027 706f 7374 6772 6573  _app = 'postgres
+00005960: 716c 270a 2020 2020 2020 2020 7265 6c5f  ql'.        rel_
+00005970: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00005980: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+00005990: 7265 6d6f 7465 5f61 7070 290a 2020 2020  remote_app).    
+000059a0: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+000059b0: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+000059c0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+000059d0: 6573 716c 272c 207b 2761 7070 273a 2027  esql', {'app': '
+000059e0: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
+000059f0: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+00005a00: 7461 6e63 6528 7265 6c5f 6964 2c20 696e  tance(rel_id, in
+00005a10: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+00005a20: 6173 7365 7274 4973 4e6f 744e 6f6e 6528  assertIsNotNone(
+00005a30: 7365 6c66 2e5f 6669 6e64 5f72 656c 6174  self._find_relat
+00005a40: 696f 6e5f 696e 5f6d 6f64 656c 5f62 795f  ion_in_model_by_
+00005a50: 6964 2868 6172 6e65 7373 2c20 7265 6c5f  id(harness, rel_
+00005a60: 6964 2929 0a0a 2020 2020 2020 2020 2320  id))..        # 
+00005a70: 4368 6563 6b20 7265 6c61 7469 6f6e 2061  Check relation a
+00005a80: 7070 2064 6174 6120 6578 6973 7473 0a20  pp data exists. 
+00005a90: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
+00005aa0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
+00005ab0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
+00005ac0: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
+00005ad0: 6e64 2e72 656c 6174 696f 6e5f 6964 7328  nd.relation_ids(
+00005ae0: 2764 6227 292c 205b 7265 6c5f 6964 5d29  'db'), [rel_id])
+00005af0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00005b00: 7365 7274 4571 7561 6c28 7b27 6170 7027  sertEqual({'app'
+00005b10: 3a20 2764 6174 6127 7d2c 2062 6163 6b65  : 'data'}, backe
+00005b20: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
+00005b30: 7265 6c5f 6964 2c20 7265 6d6f 7465 5f61  rel_id, remote_a
+00005b40: 7070 2c20 6973 5f61 7070 3d54 7275 6529  pp, is_app=True)
+00005b50: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00005b60: 732e 7265 6d6f 7665 5f72 656c 6174 696f  s.remove_relatio
+00005b70: 6e28 7265 6c5f 6964 290a 2020 2020 2020  n(rel_id).      
+00005b80: 2020 7365 6c66 2e61 7373 6572 7449 734e    self.assertIsN
+00005b90: 6f6e 6528 7365 6c66 2e5f 6669 6e64 5f72  one(self._find_r
+00005ba0: 656c 6174 696f 6e5f 696e 5f6d 6f64 656c  elation_in_model
+00005bb0: 5f62 795f 6964 2868 6172 6e65 7373 2c20  _by_id(harness, 
+00005bc0: 7265 6c5f 6964 2929 0a0a 2020 2020 6465  rel_id))..    de
+00005bd0: 6620 5f66 696e 645f 7265 6c61 7469 6f6e  f _find_relation
+00005be0: 5f69 6e5f 6d6f 6465 6c5f 6279 5f69 6428  _in_model_by_id(
+00005bf0: 7365 6c66 2c20 6861 726e 6573 732c 2072  self, harness, r
+00005c00: 656c 5f69 6429 3a0a 2020 2020 2020 2020  el_id):.        
+00005c10: 666f 7220 7265 6c61 7469 6f6e 7320 696e  for relations in
+00005c20: 2068 6172 6e65 7373 2e63 6861 726d 2e6d   harness.charm.m
+00005c30: 6f64 656c 2e72 656c 6174 696f 6e73 2e76  odel.relations.v
+00005c40: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+00005c50: 2020 2020 2066 6f72 2072 656c 6174 696f       for relatio
+00005c60: 6e20 696e 2072 656c 6174 696f 6e73 3a0a  n in relations:.
+00005c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c80: 6966 2072 656c 5f69 6420 3d3d 2072 656c  if rel_id == rel
+00005c90: 6174 696f 6e2e 6964 3a0a 2020 2020 2020  ation.id:.      
+00005ca0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00005cb0: 7475 726e 2072 656c 6174 696f 6e0a 2020  turn relation.  
+00005cc0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00005cd0: 650a 0a20 2020 2064 6566 2074 6573 745f  e..    def test_
+00005ce0: 7265 6d6f 7669 6e67 5f72 656c 6174 696f  removing_relatio
+00005cf0: 6e5f 756e 6974 5f72 656d 6f76 6573 5f64  n_unit_removes_d
+00005d00: 6174 615f 616c 736f 2873 656c 6629 3a0a  ata_also(self):.
+00005d10: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+00005d20: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+00005d30: 726e 6573 7328 5265 6c61 7469 6f6e 4576  rness(RelationEv
+00005d40: 656e 7443 6861 726d 2c20 6d65 7461 3d27  entCharm, meta='
+00005d50: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+00005d60: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+00005d70: 2020 2020 2020 2020 2020 7265 7175 6972            requir
+00005d80: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00005d90: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
+00005da0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00005db0: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
+00005dc0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+00005dd0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+00005de0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+00005df0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
+00005e00: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
+00005e10: 2020 2020 2020 2068 6172 6e65 7373 2e63         harness.c
+00005e20: 6861 726d 2e6f 6273 6572 7665 5f72 656c  harm.observe_rel
+00005e30: 6174 696f 6e5f 6576 656e 7473 2827 6462  ation_events('db
+00005e40: 2729 0a20 2020 2020 2020 2023 2041 6464  ').        # Add
+00005e50: 2061 2072 656c 6174 696f 6e20 616e 6420   a relation and 
+00005e60: 756e 6974 2077 6974 6820 6461 7461 0a20  unit with data. 
+00005e70: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
+00005e80: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00005e90: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+00005ea0: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+00005eb0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
+00005ec0: 7374 616e 6365 2872 656c 5f69 642c 2069  stance(rel_id, i
+00005ed0: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
+00005ee0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00005ef0: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
+00005f00: 6f73 7467 7265 7371 6c2f 3027 290a 2020  ostgresql/0').  
+00005f10: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+00005f20: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+00005f30: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
+00005f40: 6772 6573 716c 2f30 272c 207b 2766 6f6f  gresql/0', {'foo
+00005f50: 273a 2027 6261 7227 7d29 0a20 2020 2020  ': 'bar'}).     
+00005f60: 2020 2023 2043 6865 636b 2072 656c 6174     # Check relat
+00005f70: 696f 6e2c 2075 6e69 7420 616e 6420 6461  ion, unit and da
+00005f80: 7461 2065 7869 7374 0a20 2020 2020 2020  ta exist.       
+00005f90: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+00005fa0: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
+00005fb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00005fc0: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+00005fd0: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
+00005fe0: 205b 7265 6c5f 6964 5d29 0a20 2020 2020   [rel_id]).     
+00005ff0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00006000: 7561 6c28 6261 636b 656e 642e 7265 6c61  ual(backend.rela
+00006010: 7469 6f6e 5f6c 6973 7428 7265 6c5f 6964  tion_list(rel_id
+00006020: 292c 205b 2770 6f73 7467 7265 7371 6c2f  ), ['postgresql/
+00006030: 3027 5d29 0a20 2020 2020 2020 2073 656c  0']).        sel
+00006040: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00006050: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
+00006060: 6e64 2e72 656c 6174 696f 6e5f 6765 7428  nd.relation_get(
+00006070: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
+00006080: 7371 6c2f 3027 2c20 6973 5f61 7070 3d46  sql/0', is_app=F
+00006090: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
+000060a0: 2020 207b 2766 6f6f 273a 2027 6261 7227     {'foo': 'bar'
+000060b0: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
+000060c0: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
+000060d0: 6e67 6573 2872 6573 6574 3d54 7275 6529  nges(reset=True)
+000060e0: 2020 2320 6967 6e6f 7265 2072 656c 6174    # ignore relat
+000060f0: 696f 6e20 6372 6561 7465 6420 6576 656e  ion created even
+00006100: 7473 0a20 2020 2020 2020 2023 2052 656d  ts.        # Rem
+00006110: 6f76 6520 756e 6974 2062 7574 206e 6f74  ove unit but not
+00006120: 2072 656c 6174 696f 6e0a 2020 2020 2020   relation.      
+00006130: 2020 6861 726e 6573 732e 7265 6d6f 7665    harness.remove
+00006140: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
+00006150: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00006160: 716c 2f30 2729 0a20 2020 2020 2020 2023  ql/0').        #
+00006170: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
+00006180: 6578 6973 7473 2062 7574 2075 6e69 7420  exists but unit 
+00006190: 616e 6420 6461 7461 2061 7265 2072 656d  and data are rem
+000061a0: 6f76 6564 0a20 2020 2020 2020 2073 656c  oved.        sel
+000061b0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+000061c0: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
+000061d0: 6473 2827 6462 2729 2c20 5b72 656c 5f69  ds('db'), [rel_i
+000061e0: 645d 290a 2020 2020 2020 2020 7365 6c66  d]).        self
+000061f0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+00006200: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
+00006210: 7374 2872 656c 5f69 6429 2c20 5b5d 290a  st(rel_id), []).
+00006220: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00006230: 6572 7452 6169 7365 7328 4b65 7945 7272  ertRaises(KeyErr
+00006240: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00006250: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+00006260: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
+00006270: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00006280: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00006290: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
+000062a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062b0: 2770 6f73 7467 7265 7371 6c2f 3027 2c0a  'postgresql/0',.
+000062c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062d0: 2020 2020 2020 2020 2020 6973 5f61 7070            is_app
+000062e0: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
+000062f0: 2320 4368 6563 6b20 7265 6c61 7469 6f6e  # Check relation
+00006300: 2064 6570 6172 7465 6420 7761 7320 7261   departed was ra
+00006310: 6973 6564 2077 6974 6820 636f 7272 6563  ised with correc
+00006320: 7420 6461 7461 0a20 2020 2020 2020 2073  t data.        s
+00006330: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006340: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
+00006350: 745f 6368 616e 6765 7328 295b 305d 2c0a  t_changes()[0],.
+00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006370: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+00006380: 3a20 2772 656c 6174 696f 6e2d 6465 7061  : 'relation-depa
+00006390: 7274 6564 272c 0a20 2020 2020 2020 2020  rted',.         
+000063a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063b0: 2027 7265 6c61 7469 6f6e 273a 2027 6462   'relation': 'db
+000063c0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000063d0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+000063e0: 7461 273a 207b 2761 7070 273a 2027 706f  ta': {'app': 'po
+000063f0: 7374 6772 6573 716c 272c 0a20 2020 2020  stgresql',.     
+00006400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006410: 2020 2020 2020 2020 2020 2020 2020 2775                'u
+00006420: 6e69 7427 3a20 2770 6f73 7467 7265 7371  nit': 'postgresq
+00006430: 6c2f 3027 2c0a 2020 2020 2020 2020 2020  l/0',.          
+00006440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006450: 2020 2020 2020 2020 2027 6465 7061 7274           'depart
+00006460: 696e 675f 756e 6974 273a 2027 706f 7374  ing_unit': 'post
+00006470: 6772 6573 716c 2f30 272c 0a20 2020 2020  gresql/0',.     
+00006480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006490: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+000064a0: 656c 6174 696f 6e5f 6964 273a 2072 656c  elation_id': rel
+000064b0: 5f69 647d 7d29 0a0a 2020 2020 6465 6620  _id}})..    def 
+000064c0: 7465 7374 5f72 656d 6f76 696e 675f 7265  test_removing_re
+000064d0: 6c61 7469 6f6e 5f75 6e69 745f 646f 6573  lation_unit_does
+000064e0: 5f6e 6f74 5f72 656d 6f76 655f 6f74 6865  _not_remove_othe
+000064f0: 725f 756e 6974 5f61 6e64 5f64 6174 6128  r_unit_and_data(
+00006500: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+00006510: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00006520: 7469 6e67 2e48 6172 6e65 7373 2852 656c  ting.Harness(Rel
+00006530: 6174 696f 6e45 7665 6e74 4368 6172 6d2c  ationEventCharm,
+00006540: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00006550: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00006560: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00006570: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+00006580: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+00006590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000065a0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+000065b0: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+000065c0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+000065d0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+000065e0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+000065f0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00006600: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
+00006610: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+00006620: 7276 655f 7265 6c61 7469 6f6e 5f65 7665  rve_relation_eve
+00006630: 6e74 7328 2764 6227 290a 2020 2020 2020  nts('db').      
+00006640: 2020 2320 4164 6420 6120 7265 6c61 7469    # Add a relati
+00006650: 6f6e 2077 6974 6820 7477 6f20 756e 6974  on with two unit
+00006660: 7320 7769 7468 2064 6174 610a 2020 2020  s with data.    
+00006670: 2020 2020 7265 6c5f 6964 203d 2068 6172      rel_id = har
+00006680: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00006690: 6e28 2764 6227 2c20 2770 6f73 7467 7265  n('db', 'postgre
+000066a0: 7371 6c27 290a 2020 2020 2020 2020 7365  sql').        se
+000066b0: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+000066c0: 6e63 6528 7265 6c5f 6964 2c20 696e 7429  nce(rel_id, int)
+000066d0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000066e0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+000066f0: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
+00006700: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
+00006710: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+00006720: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+00006730: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+00006740: 2f31 2729 0a20 2020 2020 2020 2068 6172  /1').        har
+00006750: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00006760: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00006770: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+00006780: 2c20 7b27 666f 6f30 273a 2027 6261 7230  , {'foo0': 'bar0
+00006790: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
+000067a0: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+000067b0: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+000067c0: 2027 706f 7374 6772 6573 716c 2f31 272c   'postgresql/1',
+000067d0: 207b 2766 6f6f 3127 3a20 2762 6172 3127   {'foo1': 'bar1'
+000067e0: 7d29 0a20 2020 2020 2020 2023 2043 6865  }).        # Che
+000067f0: 636b 2062 6f74 6820 756e 6974 2061 6e64  ck both unit and
+00006800: 2064 6174 6120 6172 6520 7072 6573 656e   data are presen
+00006810: 740a 2020 2020 2020 2020 6261 636b 656e  t.        backen
+00006820: 6420 3d20 6861 726e 6573 732e 5f62 6163  d = harness._bac
+00006830: 6b65 6e64 0a20 2020 2020 2020 2073 656c  kend.        sel
+00006840: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
+00006850: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
+00006860: 6473 2827 6462 2729 2c20 5b72 656c 5f69  ds('db'), [rel_i
+00006870: 645d 290a 2020 2020 2020 2020 7365 6c66  d]).        self
+00006880: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+00006890: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
+000068a0: 7374 2872 656c 5f69 6429 2c0a 2020 2020  st(rel_id),.    
+000068b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000068c0: 2020 2020 205b 2770 6f73 7467 7265 7371       ['postgresq
+000068d0: 6c2f 3027 2c20 2770 6f73 7467 7265 7371  l/0', 'postgresq
+000068e0: 6c2f 3127 5d29 0a20 2020 2020 2020 2073  l/1']).        s
+000068f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006900: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+00006910: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00006920: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+00006930: 7265 7371 6c2f 3027 2c20 6973 5f61 7070  resql/0', is_app
+00006940: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+00006950: 2020 2020 207b 2766 6f6f 3027 3a20 2762       {'foo0': 'b
+00006960: 6172 3027 7d29 0a20 2020 2020 2020 2073  ar0'}).        s
+00006970: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006980: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+00006990: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+000069a0: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+000069b0: 7265 7371 6c2f 3127 2c20 6973 5f61 7070  resql/1', is_app
+000069c0: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+000069d0: 2020 2020 207b 2766 6f6f 3127 3a20 2762       {'foo1': 'b
+000069e0: 6172 3127 7d29 0a20 2020 2020 2020 2068  ar1'}).        h
+000069f0: 6172 6e65 7373 2e63 6861 726d 2e67 6574  arness.charm.get
+00006a00: 5f63 6861 6e67 6573 2872 6573 6574 3d54  _changes(reset=T
+00006a10: 7275 6529 2020 2320 6967 6e6f 7265 2072  rue)  # ignore r
+00006a20: 656c 6174 696f 6e20 6372 6561 7465 6420  elation created 
+00006a30: 6576 656e 7473 0a20 2020 2020 2020 2023  events.        #
+00006a40: 2052 656d 6f76 6520 6f6e 6c79 206f 6e65   Remove only one
+00006a50: 2075 6e69 740a 2020 2020 2020 2020 6861   unit.        ha
+00006a60: 726e 6573 732e 7265 6d6f 7665 5f72 656c  rness.remove_rel
+00006a70: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
+00006a80: 642c 2027 706f 7374 6772 6573 716c 2f31  d, 'postgresql/1
+00006a90: 2729 0a20 2020 2020 2020 2023 2043 6865  ').        # Che
+00006aa0: 636b 206f 7468 6572 2075 6e69 7420 616e  ck other unit an
+00006ab0: 6420 6461 7461 2073 7469 6c6c 2065 7869  d data still exi
+00006ac0: 7374 730a 2020 2020 2020 2020 7365 6c66  sts.        self
+00006ad0: 2e61 7373 6572 7445 7175 616c 2862 6163  .assertEqual(bac
+00006ae0: 6b65 6e64 2e72 656c 6174 696f 6e5f 6c69  kend.relation_li
+00006af0: 7374 2872 656c 5f69 6429 2c0a 2020 2020  st(rel_id),.    
+00006b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b10: 2020 2020 205b 2770 6f73 7467 7265 7371       ['postgresq
+00006b20: 6c2f 3027 5d29 0a20 2020 2020 2020 2073  l/0']).        s
+00006b30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00006b40: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+00006b50: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+00006b60: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+00006b70: 7265 7371 6c2f 3027 2c20 6973 5f61 7070  resql/0', is_app
+00006b80: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+00006b90: 2020 2020 207b 2766 6f6f 3027 3a20 2762       {'foo0': 'b
+00006ba0: 6172 3027 7d29 0a20 2020 2020 2020 2023  ar0'}).        #
+00006bb0: 2043 6865 636b 2072 656c 6174 696f 6e20   Check relation 
+00006bc0: 6465 7061 7274 6564 2077 6173 2072 6169  departed was rai
+00006bd0: 7365 6420 7769 7468 2063 6f72 7265 6374  sed with correct
+00006be0: 2064 6174 610a 2020 2020 2020 2020 7365   data.        se
+00006bf0: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+00006c00: 6172 6e65 7373 2e63 6861 726d 2e67 6574  arness.charm.get
+00006c10: 5f63 6861 6e67 6573 2829 5b30 5d2c 0a20  _changes()[0],. 
+00006c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c30: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+00006c40: 2027 7265 6c61 7469 6f6e 2d64 6570 6172   'relation-depar
+00006c50: 7465 6427 2c0a 2020 2020 2020 2020 2020  ted',.          
+00006c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c70: 2772 656c 6174 696f 6e27 3a20 2764 6227  'relation': 'db'
+00006c80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006c90: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
+00006ca0: 6127 3a20 7b27 6170 7027 3a20 2770 6f73  a': {'app': 'pos
+00006cb0: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00006cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006cd0: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+00006ce0: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
+00006cf0: 2f31 272c 0a20 2020 2020 2020 2020 2020  /1',.           
+00006d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d10: 2020 2020 2020 2020 2764 6570 6172 7469          'departi
+00006d20: 6e67 5f75 6e69 7427 3a20 2770 6f73 7467  ng_unit': 'postg
+00006d30: 7265 7371 6c2f 3127 2c0a 2020 2020 2020  resql/1',.      
+00006d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d50: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00006d60: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
+00006d70: 6964 7d7d 290a 0a20 2020 2064 6566 2074  id}})..    def t
+00006d80: 6573 745f 7265 6c61 7469 6f6e 5f65 7665  est_relation_eve
+00006d90: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
+00006da0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+00006db0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+00006dc0: 2852 656c 6174 696f 6e45 7665 6e74 4368  (RelationEventCh
+00006dd0: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
+00006de0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+00006df0: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
+00006e00: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
+00006e10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00006e20: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
+00006e30: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
+00006e40: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
+00006e50: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00006e60: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00006e70: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00006e80: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00006e90: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
+00006ea0: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+00006eb0: 7276 655f 7265 6c61 7469 6f6e 5f65 7665  rve_relation_eve
+00006ec0: 6e74 7328 2764 6227 290a 2020 2020 2020  nts('db').      
+00006ed0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00006ee0: 616c 2868 6172 6e65 7373 2e63 6861 726d  al(harness.charm
+00006ef0: 2e67 6574 5f63 6861 6e67 6573 2829 2c20  .get_changes(), 
+00006f00: 5b5d 290a 2020 2020 2020 2020 7265 6c5f  []).        rel_
+00006f10: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00006f20: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+00006f30: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
+00006f40: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00006f50: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
+00006f60: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
+00006f70: 6d2e 6765 745f 6368 616e 6765 7328 292c  m.get_changes(),
+00006f80: 0a20 2020 2020 2020 2020 2020 205b 7b27  .            [{'
+00006f90: 6e61 6d65 273a 2027 7265 6c61 7469 6f6e  name': 'relation
+00006fa0: 2d63 7265 6174 6564 272c 0a20 2020 2020  -created',.     
+00006fb0: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+00006fc0: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
+00006fd0: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
+00006fe0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00006ff0: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
+00007000: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00007010: 2020 2020 2020 2020 2020 2020 2775 6e69              'uni
+00007020: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00007030: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+00007040: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
+00007050: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00007060: 207d 7d5d 290a 2020 2020 2020 2020 6861   }}]).        ha
+00007070: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+00007080: 6f6e 5f75 6e69 7428 7265 6c5f 6964 2c20  on_unit(rel_id, 
+00007090: 2770 6f73 7467 7265 7371 6c2f 3027 290a  'postgresql/0').
+000070a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000070b0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
+000070c0: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
+000070d0: 6172 6d2e 6765 745f 6368 616e 6765 7328  arm.get_changes(
+000070e0: 292c 0a20 2020 2020 2020 2020 2020 205b  ),.            [
+000070f0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
+00007100: 6f6e 2d6a 6f69 6e65 6427 2c0a 2020 2020  on-joined',.    
+00007110: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00007120: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
+00007130: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
+00007140: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00007150: 2020 2020 2020 2761 7070 273a 2027 706f        'app': 'po
+00007160: 7374 6772 6573 716c 272c 0a20 2020 2020  stgresql',.     
+00007170: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+00007180: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
+00007190: 2f30 272c 0a20 2020 2020 2020 2020 2020  /0',.           
+000071a0: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+000071b0: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
+000071c0: 2020 2020 2020 2020 2020 2020 7d7d 5d29              }}])
+000071d0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000071e0: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+000071f0: 5f64 6174 6128 7265 6c5f 6964 2c20 2770  _data(rel_id, 'p
+00007200: 6f73 7467 7265 7371 6c27 2c20 7b27 666f  ostgresql', {'fo
+00007210: 6f27 3a20 2762 6172 277d 290a 2020 2020  o': 'bar'}).    
+00007220: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007230: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+00007240: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
+00007250: 6765 745f 6368 616e 6765 7328 292c 0a20  get_changes(),. 
+00007260: 2020 2020 2020 2020 2020 205b 7b27 6e61             [{'na
+00007270: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
+00007280: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
+00007290: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+000072a0: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
+000072b0: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
+000072c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000072d0: 2020 2027 6170 7027 3a20 2770 6f73 7467     'app': 'postg
+000072e0: 7265 7371 6c27 2c0a 2020 2020 2020 2020  resql',.        
+000072f0: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
+00007300: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00007310: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00007320: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
+00007330: 0a20 2020 2020 2020 2020 2020 2020 207d  .              }
+00007340: 7d5d 290a 2020 2020 2020 2020 6861 726e  }]).        harn
+00007350: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00007360: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00007370: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
+00007380: 207b 2762 617a 273a 2027 6269 6e67 277d   {'baz': 'bing'}
+00007390: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000073a0: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
+000073b0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+000073c0: 6368 6172 6d2e 6765 745f 6368 616e 6765  charm.get_change
+000073d0: 7328 292c 0a20 2020 2020 2020 2020 2020  s(),.           
+000073e0: 205b 7b27 6e61 6d65 273a 2027 7265 6c61   [{'name': 'rela
+000073f0: 7469 6f6e 2d63 6861 6e67 6564 272c 0a20  tion-changed',. 
+00007400: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00007410: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
+00007420: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+00007430: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
+00007440: 2020 2020 2020 2020 2027 6170 7027 3a20           'app': 
+00007450: 2770 6f73 7467 7265 7371 6c27 2c0a 2020  'postgresql',.  
+00007460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007470: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
+00007480: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
+00007490: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+000074a0: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
+000074b0: 0a20 2020 2020 2020 2020 2020 2020 207d  .              }
+000074c0: 7d5d 290a 0a20 2020 2064 6566 2074 6573  }])..    def tes
+000074d0: 745f 6765 745f 7265 6c61 7469 6f6e 5f64  t_get_relation_d
+000074e0: 6174 6128 7365 6c66 293a 0a20 2020 2020  ata(self):.     
+000074f0: 2020 2063 6861 726d 5f6d 6574 6120 3d20     charm_meta = 
+00007500: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00007510: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
+00007520: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+00007530: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+00007540: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
+00007550: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+00007560: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
+00007570: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+00007580: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+00007590: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+000075a0: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
+000075b0: 6574 613d 6368 6172 6d5f 6d65 7461 290a  eta=charm_meta).
+000075c0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+000075d0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+000075e0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+000075f0: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
+00007600: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+00007610: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
+00007620: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00007630: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
+00007640: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
+00007650: 2770 6f73 7467 7265 7371 6c27 2c20 7b27  'postgresql', {'
+00007660: 7265 6d6f 7465 273a 2027 6461 7461 277d  remote': 'data'}
+00007670: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007680: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
+00007690: 7373 2e67 6574 5f72 656c 6174 696f 6e5f  ss.get_relation_
+000076a0: 6461 7461 2872 656c 5f69 642c 2027 7465  data(rel_id, 'te
+000076b0: 7374 2d61 7070 2729 2c20 7b7d 290a 2020  st-app'), {}).  
+000076c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000076d0: 7445 7175 616c 2868 6172 6e65 7373 2e67  tEqual(harness.g
+000076e0: 6574 5f72 656c 6174 696f 6e5f 6461 7461  et_relation_data
+000076f0: 2872 656c 5f69 642c 2027 7465 7374 2d61  (rel_id, 'test-a
+00007700: 7070 2f30 2729 2c20 7b7d 290a 2020 2020  pp/0'), {}).    
+00007710: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007720: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
+00007730: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00007740: 656c 5f69 642c 2027 7465 7374 2d61 7070  el_id, 'test-app
+00007750: 2f31 2729 2c20 4e6f 6e65 290a 2020 2020  /1'), None).    
+00007760: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00007770: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
+00007780: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00007790: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+000077a0: 716c 2729 2c20 7b27 7265 6d6f 7465 273a  ql'), {'remote':
+000077b0: 2027 6461 7461 277d 290a 2020 2020 2020   'data'}).      
+000077c0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+000077d0: 7274 5261 6973 6573 284b 6579 4572 726f  rtRaises(KeyErro
+000077e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000077f0: 2320 756e 6b6e 6f77 6e20 7265 6c61 7469  # unknown relati
+00007800: 6f6e 2069 640a 2020 2020 2020 2020 2020  on id.          
+00007810: 2020 6861 726e 6573 732e 6765 745f 7265    harness.get_re
+00007820: 6c61 7469 6f6e 5f64 6174 6128 3939 2c20  lation_data(99, 
+00007830: 2770 6f73 7467 7265 7371 6c27 290a 0a20  'postgresql').. 
+00007840: 2020 2020 2020 206d 6574 6120 3d20 7961         meta = ya
+00007850: 6d6c 2e73 6166 655f 6c6f 6164 2863 6861  ml.safe_load(cha
+00007860: 726d 5f6d 6574 6129 0a20 2020 2020 2020  rm_meta).       
+00007870: 2074 5f61 7070 203d 206f 7073 2e41 7070   t_app = ops.App
+00007880: 6c69 6361 7469 6f6e 2827 7465 7374 2d61  lication('test-a
+00007890: 7070 272c 206d 6574 612c 2068 6172 6e65  pp', meta, harne
+000078a0: 7373 2e5f 6261 636b 656e 642c 204e 6f6e  ss._backend, Non
+000078b0: 6529 0a20 2020 2020 2020 2074 5f75 6e69  e).        t_uni
+000078c0: 7430 203d 206f 7073 2e55 6e69 7428 2774  t0 = ops.Unit('t
+000078d0: 6573 742d 6170 702f 3027 2c20 6d65 7461  est-app/0', meta
+000078e0: 2c20 6861 726e 6573 732e 5f62 6163 6b65  , harness._backe
+000078f0: 6e64 2c20 7b6f 7073 2e41 7070 6c69 6361  nd, {ops.Applica
+00007900: 7469 6f6e 3a20 745f 6170 707d 290a 2020  tion: t_app}).  
+00007910: 2020 2020 2020 745f 756e 6974 3120 3d20        t_unit1 = 
+00007920: 6f70 732e 556e 6974 2827 7465 7374 2d61  ops.Unit('test-a
+00007930: 7070 2f31 272c 206d 6574 612c 2068 6172  pp/1', meta, har
+00007940: 6e65 7373 2e5f 6261 636b 656e 642c 207b  ness._backend, {
+00007950: 6f70 732e 4170 706c 6963 6174 696f 6e3a  ops.Application:
+00007960: 2074 5f61 7070 7d29 0a20 2020 2020 2020   t_app}).       
+00007970: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00007980: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
+00007990: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+000079a0: 6964 2c20 745f 6170 7029 2c20 7b7d 290a  id, t_app), {}).
+000079b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000079c0: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
+000079d0: 2e67 6574 5f72 656c 6174 696f 6e5f 6461  .get_relation_da
+000079e0: 7461 2872 656c 5f69 642c 2074 5f75 6e69  ta(rel_id, t_uni
+000079f0: 7430 292c 207b 7d29 0a20 2020 2020 2020  t0), {}).       
+00007a00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00007a10: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
+00007a20: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+00007a30: 6964 2c20 745f 756e 6974 3129 2c20 4e6f  id, t_unit1), No
+00007a40: 6e65 290a 2020 2020 2020 2020 7067 5f61  ne).        pg_a
+00007a50: 7070 203d 206f 7073 2e41 7070 6c69 6361  pp = ops.Applica
+00007a60: 7469 6f6e 2827 706f 7374 6772 6573 716c  tion('postgresql
+00007a70: 272c 206d 6574 612c 2068 6172 6e65 7373  ', meta, harness
+00007a80: 2e5f 6261 636b 656e 642c 204e 6f6e 6529  ._backend, None)
+00007a90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007aa0: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
+00007ab0: 732e 6765 745f 7265 6c61 7469 6f6e 5f64  s.get_relation_d
+00007ac0: 6174 6128 7265 6c5f 6964 2c20 7067 5f61  ata(rel_id, pg_a
+00007ad0: 7070 292c 207b 2772 656d 6f74 6527 3a20  pp), {'remote': 
+00007ae0: 2764 6174 6127 7d29 0a0a 2020 2020 6465  'data'})..    de
+00007af0: 6620 7465 7374 5f63 7265 6174 655f 6861  f test_create_ha
+00007b00: 726e 6573 735f 7477 6963 6528 7365 6c66  rness_twice(self
+00007b10: 293a 0a20 2020 2020 2020 206d 6574 6164  ):.        metad
+00007b20: 6174 6120 3d20 2727 270a 2020 2020 2020  ata = '''.      
+00007b30: 2020 2020 2020 6e61 6d65 3a20 6d79 2d63        name: my-c
+00007b40: 6861 726d 0a20 2020 2020 2020 2020 2020  harm.           
+00007b50: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+00007b60: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
+00007b70: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+00007b80: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
+00007b90: 2020 2020 2020 2020 2020 2727 270a 2020            '''.  
+00007ba0: 2020 2020 2020 6861 726e 6573 7331 203d        harness1 =
+00007bb0: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00007bc0: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+00007bd0: 7365 2c20 6d65 7461 3d6d 6574 6164 6174  se, meta=metadat
+00007be0: 6129 0a20 2020 2020 2020 2073 656c 662e  a).        self.
+00007bf0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00007c00: 7373 312e 636c 6561 6e75 7029 0a20 2020  ss1.cleanup).   
+00007c10: 2020 2020 2068 6172 6e65 7373 3220 3d20       harness2 = 
+00007c20: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+00007c30: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+00007c40: 652c 206d 6574 613d 6d65 7461 6461 7461  e, meta=metadata
+00007c50: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00007c60: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00007c70: 7332 2e63 6c65 616e 7570 290a 2020 2020  s2.cleanup).    
+00007c80: 2020 2020 6861 726e 6573 7331 2e62 6567      harness1.beg
+00007c90: 696e 2829 0a20 2020 2020 2020 2068 6172  in().        har
+00007ca0: 6e65 7373 322e 6265 6769 6e28 290a 2020  ness2.begin().  
+00007cb0: 2020 2020 2020 6865 6c70 6572 3120 3d20        helper1 = 
+00007cc0: 4442 5265 6c61 7469 6f6e 4368 616e 6765  DBRelationChange
+00007cd0: 6448 656c 7065 7228 6861 726e 6573 7331  dHelper(harness1
+00007ce0: 2e63 6861 726d 2c20 2268 656c 7065 7231  .charm, "helper1
+00007cf0: 2229 0a20 2020 2020 2020 2068 656c 7065  ").        helpe
+00007d00: 7232 203d 2044 4252 656c 6174 696f 6e43  r2 = DBRelationC
+00007d10: 6861 6e67 6564 4865 6c70 6572 2868 6172  hangedHelper(har
+00007d20: 6e65 7373 322e 6368 6172 6d2c 2022 6865  ness2.charm, "he
+00007d30: 6c70 6572 3222 290a 2020 2020 2020 2020  lper2").        
+00007d40: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+00007d50: 322e 6164 645f 7265 6c61 7469 6f6e 2827  2.add_relation('
+00007d60: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
+00007d70: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00007d80: 7373 322e 7570 6461 7465 5f72 656c 6174  ss2.update_relat
+00007d90: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00007da0: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
+00007db0: 276b 6579 273a 2027 7661 6c75 6527 7d29  'key': 'value'})
+00007dc0: 0a20 2020 2020 2020 2023 2048 656c 7065  .        # Helpe
+00007dd0: 7232 2073 686f 756c 6420 7365 6520 7468  r2 should see th
+00007de0: 6520 6576 656e 7420 7472 6967 6765 7265  e event triggere
+00007df0: 6420 6279 2068 6172 6e65 7373 322c 2062  d by harness2, b
+00007e00: 7574 2068 656c 7065 7231 2073 686f 756c  ut helper1 shoul
+00007e10: 6420 7365 6520 6e6f 2065 7665 6e74 732e  d see no events.
+00007e20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00007e30: 7365 7274 4571 7561 6c28 6865 6c70 6572  sertEqual(helper
+00007e40: 312e 6368 616e 6765 732c 205b 5d29 0a20  1.changes, []). 
+00007e50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00007e60: 7274 4571 7561 6c28 6865 6c70 6572 322e  rtEqual(helper2.
+00007e70: 6368 616e 6765 732c 205b 2872 656c 5f69  changes, [(rel_i
+00007e80: 642c 2027 706f 7374 6772 6573 716c 2729  d, 'postgresql')
+00007e90: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
+00007ea0: 5f62 6567 696e 5f74 7769 6365 2873 656c  _begin_twice(sel
+00007eb0: 6629 3a0a 2020 2020 2020 2020 2320 6c61  f):.        # la
+00007ec0: 6e67 7561 6765 3d59 414d 4c0a 2020 2020  nguage=YAML.    
+00007ed0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+00007ee0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+00007ef0: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+00007f00: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+00007f10: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00007f20: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00007f30: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+00007f40: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+00007f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f60: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+00007f70: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+00007f80: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00007f90: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00007fa0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00007fb0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00007fc0: 6769 6e28 290a 2020 2020 2020 2020 7769  gin().        wi
+00007fd0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00007fe0: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+00007ff0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00008000: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+00008010: 0a20 2020 2064 6566 2074 6573 745f 7570  .    def test_up
+00008020: 6461 7465 5f72 656c 6174 696f 6e5f 6578  date_relation_ex
+00008030: 706f 7365 735f 6e65 775f 6461 7461 2873  poses_new_data(s
+00008040: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+00008050: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00008060: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
+00008070: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
+00008080: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00008090: 6e61 6d65 3a20 6d79 2d63 6861 726d 0a20  name: my-charm. 
+000080a0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+000080b0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+000080c0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+000080d0: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
+000080e0: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
+000080f0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
+00008100: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
+00008110: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
+00008120: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00008130: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
+00008140: 2020 7669 6577 6572 203d 2052 656c 6174    viewer = Relat
+00008150: 696f 6e43 6861 6e67 6564 5669 6577 6572  ionChangedViewer
+00008160: 2868 6172 6e65 7373 2e63 6861 726d 2c20  (harness.charm, 
+00008170: 2764 6227 290a 2020 2020 2020 2020 7265  'db').        re
+00008180: 6c5f 6964 203d 2068 6172 6e65 7373 2e61  l_id = harness.a
+00008190: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
+000081a0: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
+000081b0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+000081c0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+000081d0: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+000081e0: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
+000081f0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00008200: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00008210: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00008220: 716c 2f30 272c 207b 2769 6e69 7469 616c  ql/0', {'initial
+00008230: 273a 2027 6461 7461 277d 290a 2020 2020  ': 'data'}).    
+00008240: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00008250: 7175 616c 2876 6965 7765 722e 6368 616e  qual(viewer.chan
+00008260: 6765 732c 205b 7b27 696e 6974 6961 6c27  ges, [{'initial'
+00008270: 3a20 2764 6174 6127 7d5d 290a 2020 2020  : 'data'}]).    
+00008280: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+00008290: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+000082a0: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+000082b0: 6573 716c 2f30 272c 207b 276e 6577 273a  esql/0', {'new':
+000082c0: 2027 7661 6c75 6527 7d29 0a20 2020 2020   'value'}).     
+000082d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000082e0: 7561 6c28 7669 6577 6572 2e63 6861 6e67  ual(viewer.chang
+000082f0: 6573 2c20 5b7b 2769 6e69 7469 616c 273a  es, [{'initial':
+00008300: 2027 6461 7461 277d 2c0a 2020 2020 2020   'data'},.      
+00008310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008330: 2020 2020 7b27 696e 6974 6961 6c27 3a20      {'initial': 
+00008340: 2764 6174 6127 2c20 276e 6577 273a 2027  'data', 'new': '
+00008350: 7661 6c75 6527 7d5d 290a 0a20 2020 2064  value'}])..    d
+00008360: 6566 2074 6573 745f 7570 6461 7465 5f72  ef test_update_r
+00008370: 656c 6174 696f 6e5f 6e6f 5f6c 6f63 616c  elation_no_local
+00008380: 5f75 6e69 745f 6368 616e 6765 5f65 7665  _unit_change_eve
+00008390: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
+000083a0: 2020 2320 6c61 6e67 7561 6765 3d59 414d    # language=YAM
+000083b0: 4c0a 2020 2020 2020 2020 6861 726e 6573  L.        harnes
+000083c0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+000083d0: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+000083e0: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+000083f0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00008400: 3a20 6d79 2d63 6861 726d 0a20 2020 2020  : my-charm.     
+00008410: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+00008420: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
+00008430: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
+00008440: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+00008450: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+00008460: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00008470: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00008480: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00008490: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+000084a0: 6769 6e28 290a 2020 2020 2020 2020 6865  gin().        he
+000084b0: 6c70 6572 203d 2044 4252 656c 6174 696f  lper = DBRelatio
+000084c0: 6e43 6861 6e67 6564 4865 6c70 6572 2868  nChangedHelper(h
+000084d0: 6172 6e65 7373 2e63 6861 726d 2c20 2268  arness.charm, "h
+000084e0: 656c 7065 7222 290a 2020 2020 2020 2020  elper").        
+000084f0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+00008500: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+00008510: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+00008520: 290a 2020 2020 2020 2020 7265 6c20 3d20  ).        rel = 
+00008530: 6861 726e 6573 732e 6368 6172 6d2e 6d6f  harness.charm.mo
+00008540: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
+00008550: 2827 6462 2729 0a20 2020 2020 2020 2072  ('db').        r
+00008560: 656c 2e64 6174 615b 6861 726e 6573 732e  el.data[harness.
+00008570: 6368 6172 6d2e 6d6f 6465 6c2e 756e 6974  charm.model.unit
+00008580: 5d5b 276b 6579 275d 203d 2027 7661 6c75  ]['key'] = 'valu
+00008590: 6527 0a20 2020 2020 2020 2023 2074 6865  e'.        # the
+000085a0: 7265 2073 686f 756c 6420 6265 206e 6f20  re should be no 
+000085b0: 6576 656e 7420 666f 7220 7570 6461 7469  event for updati
+000085c0: 6e67 206f 7572 206f 776e 2064 6174 610a  ng our own data.
+000085d0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+000085e0: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
+000085f0: 6461 7461 2872 656c 5f69 642c 2027 6d79  data(rel_id, 'my
+00008600: 2d63 6861 726d 2f30 272c 207b 276e 6577  -charm/0', {'new
+00008610: 273a 2027 6f74 6865 7227 7d29 0a20 2020  ': 'other'}).   
+00008620: 2020 2020 2023 2062 7574 2074 6865 2064       # but the d
+00008630: 6174 6120 7769 6c6c 2062 6520 7570 6461  ata will be upda
+00008640: 7465 642e 0a20 2020 2020 2020 2073 656c  ted..        sel
+00008650: 662e 6173 7365 7274 4571 7561 6c28 7b27  f.assertEqual({'
+00008660: 6b65 7927 3a20 2776 616c 7565 272c 2027  key': 'value', '
+00008670: 6e65 7727 3a20 276f 7468 6572 277d 2c20  new': 'other'}, 
+00008680: 7265 6c2e 6461 7461 5b68 6172 6e65 7373  rel.data[harness
+00008690: 2e63 6861 726d 2e6d 6f64 656c 2e75 6e69  .charm.model.uni
+000086a0: 745d 290a 0a20 2020 2020 2020 2072 656c  t])..        rel
+000086b0: 2e64 6174 615b 6861 726e 6573 732e 6368  .data[harness.ch
+000086c0: 6172 6d2e 6d6f 6465 6c2e 756e 6974 5d5b  arm.model.unit][
+000086d0: 276e 6577 275d 203d 2027 7661 6c75 6527  'new'] = 'value'
+000086e0: 0a20 2020 2020 2020 2023 204f 7572 2075  .        # Our u
+000086f0: 6e69 7420 6461 7461 2062 6167 2067 6f74  nit data bag got
+00008700: 2075 7064 6174 6564 2e0a 2020 2020 2020   updated..      
+00008710: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008720: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
+00008730: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+00008740: 756e 6974 5d5b 276e 6577 275d 2c20 2776  unit]['new'], 'v
+00008750: 616c 7565 2729 0a20 2020 2020 2020 2023  alue').        #
+00008760: 2042 7574 2074 6865 7265 2077 6572 6520   But there were 
+00008770: 6e6f 2063 6861 6e67 6564 2065 7665 6e74  no changed event
+00008780: 7320 7265 6769 7374 6572 6564 2062 7920  s registered by 
+00008790: 6f75 7220 756e 6974 2e0a 2020 2020 2020  our unit..      
+000087a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000087b0: 616c 285b 5d2c 2068 656c 7065 722e 6368  al([], helper.ch
+000087c0: 616e 6765 7329 0a0a 2020 2020 6465 6620  anges)..    def 
+000087d0: 7465 7374 5f75 7064 6174 655f 7065 6572  test_update_peer
+000087e0: 5f72 656c 6174 696f 6e5f 6e6f 5f6c 6f63  _relation_no_loc
+000087f0: 616c 5f75 6e69 745f 6368 616e 6765 5f65  al_unit_change_e
+00008800: 7665 6e74 2873 656c 6629 3a0a 2020 2020  vent(self):.    
+00008810: 2020 2020 2320 6c61 6e67 7561 6765 3d59      # language=Y
+00008820: 414d 4c0a 2020 2020 2020 2020 6861 726e  AML.        harn
+00008830: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00008840: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00008850: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+00008860: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00008870: 6d65 3a20 706f 7374 6772 6573 716c 0a20  me: postgresql. 
+00008880: 2020 2020 2020 2020 2020 2070 6565 7273             peers
+00008890: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000088a0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
+000088b0: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+000088c0: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+000088d0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+000088e0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+000088f0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00008900: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+00008910: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
+00008920: 656c 7065 7220 3d20 4442 5265 6c61 7469  elper = DBRelati
+00008930: 6f6e 4368 616e 6765 6448 656c 7065 7228  onChangedHelper(
+00008940: 6861 726e 6573 732e 6368 6172 6d2c 2022  harness.charm, "
+00008950: 6865 6c70 6572 2229 0a20 2020 2020 2020  helper").       
+00008960: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
+00008970: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
+00008980: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
+00008990: 2729 0a0a 2020 2020 2020 2020 7265 6c20  ')..        rel 
+000089a0: 3d20 6861 726e 6573 732e 6368 6172 6d2e  = harness.charm.
+000089b0: 6d6f 6465 6c2e 6765 745f 7265 6c61 7469  model.get_relati
+000089c0: 6f6e 2827 6462 2729 0a20 2020 2020 2020  on('db').       
+000089d0: 2072 656c 2e64 6174 615b 6861 726e 6573   rel.data[harnes
+000089e0: 732e 6368 6172 6d2e 6d6f 6465 6c2e 756e  s.charm.model.un
+000089f0: 6974 5d5b 276b 6579 275d 203d 2027 7661  it]['key'] = 'va
+00008a00: 6c75 6527 0a20 2020 2020 2020 2072 656c  lue'.        rel
+00008a10: 203d 2068 6172 6e65 7373 2e63 6861 726d   = harness.charm
+00008a20: 2e6d 6f64 656c 2e67 6574 5f72 656c 6174  .model.get_relat
+00008a30: 696f 6e28 2764 6227 290a 2020 2020 2020  ion('db').      
+00008a40: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00008a50: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00008a60: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00008a70: 716c 2f30 272c 207b 276b 6579 273a 2027  ql/0', {'key': '
+00008a80: 7631 277d 290a 2020 2020 2020 2020 7365  v1'}).        se
+00008a90: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
+00008aa0: 276b 6579 273a 2027 7631 277d 2c20 7265  'key': 'v1'}, re
+00008ab0: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+00008ac0: 6861 726d 2e6d 6f64 656c 2e75 6e69 745d  harm.model.unit]
+00008ad0: 290a 2020 2020 2020 2020 2320 4d61 6b65  ).        # Make
+00008ae0: 2073 7572 6520 7468 6572 6520 7761 7320   sure there was 
+00008af0: 6e6f 2065 7665 6e74 0a20 2020 2020 2020  no event.       
+00008b00: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008b10: 6c28 5b5d 2c20 6865 6c70 6572 2e63 6861  l([], helper.cha
+00008b20: 6e67 6573 290a 0a20 2020 2020 2020 2072  nges)..        r
+00008b30: 656c 2e64 6174 615b 6861 726e 6573 732e  el.data[harness.
+00008b40: 6368 6172 6d2e 6d6f 6465 6c2e 756e 6974  charm.model.unit
+00008b50: 5d5b 276b 6579 275d 203d 2027 7632 270a  ]['key'] = 'v2'.
+00008b60: 2020 2020 2020 2020 2320 4f75 7220 756e          # Our un
+00008b70: 6974 2064 6174 6120 6261 6720 676f 7420  it data bag got 
+00008b80: 7570 6461 7465 642e 0a20 2020 2020 2020  updated..       
+00008b90: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00008ba0: 6c28 7b27 6b65 7927 3a20 2776 3227 7d2c  l({'key': 'v2'},
+00008bb0: 2064 6963 7428 7265 6c2e 6461 7461 5b68   dict(rel.data[h
+00008bc0: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
+00008bd0: 656c 2e75 6e69 745d 2929 0a20 2020 2020  el.unit])).     
+00008be0: 2020 2023 2042 7574 2074 6865 7265 2077     # But there w
+00008bf0: 6572 6520 6e6f 2063 6861 6e67 6564 2065  ere no changed e
+00008c00: 7665 6e74 7320 7265 6769 7374 6572 6564  vents registered
+00008c10: 2062 7920 6f75 7220 756e 6974 2e0a 2020   by our unit..  
+00008c20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00008c30: 7445 7175 616c 285b 5d2c 2068 656c 7065  tEqual([], helpe
+00008c40: 722e 6368 616e 6765 7329 0a0a 2020 2020  r.changes)..    
+00008c50: 2020 2020 2320 5361 6d65 2066 6f72 2077      # Same for w
+00008c60: 6865 6e20 6f75 7220 756e 6974 2069 7320  hen our unit is 
+00008c70: 6120 6c65 6164 6572 2e0a 2020 2020 2020  a leader..      
+00008c80: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
+00008c90: 6164 6572 2869 735f 6c65 6164 6572 3d54  ader(is_leader=T
+00008ca0: 7275 6529 0a20 2020 2020 2020 2068 6172  rue).        har
+00008cb0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+00008cc0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+00008cd0: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+00008ce0: 2c20 7b27 6b65 7927 3a20 2776 3327 7d29  , {'key': 'v3'})
+00008cf0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00008d00: 7365 7274 4571 7561 6c28 7b27 6b65 7927  sertEqual({'key'
+00008d10: 3a20 2776 3327 7d2c 2064 6963 7428 7265  : 'v3'}, dict(re
+00008d20: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+00008d30: 6861 726d 2e6d 6f64 656c 2e75 6e69 745d  harm.model.unit]
+00008d40: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+00008d50: 6173 7365 7274 4571 7561 6c28 5b5d 2c20  assertEqual([], 
+00008d60: 6865 6c70 6572 2e63 6861 6e67 6573 290a  helper.changes).
+00008d70: 0a20 2020 2020 2020 2072 656c 2e64 6174  .        rel.dat
+00008d80: 615b 6861 726e 6573 732e 6368 6172 6d2e  a[harness.charm.
+00008d90: 6d6f 6465 6c2e 756e 6974 5d5b 276b 6579  model.unit]['key
+00008da0: 275d 203d 2027 7634 270a 2020 2020 2020  '] = 'v4'.      
+00008db0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00008dc0: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
+00008dd0: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+00008de0: 756e 6974 5d5b 276b 6579 275d 2c20 2776  unit]['key'], 'v
+00008df0: 3427 290a 2020 2020 2020 2020 7365 6c66  4').        self
+00008e00: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
+00008e10: 2068 656c 7065 722e 6368 616e 6765 7329   helper.changes)
+00008e20: 0a0a 2020 2020 6465 6620 7465 7374 5f68  ..    def test_h
+00008e30: 6172 6e65 7373 5f6c 6561 6465 725f 6d69  arness_leader_mi
+00008e40: 7363 6f6e 6669 6728 7365 6c66 293a 0a20  sconfig(self):. 
+00008e50: 2020 2020 2020 2023 206c 616e 6775 6167         # languag
+00008e60: 653d 5941 4d4c 0a20 2020 2020 2020 2068  e=YAML.        h
+00008e70: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00008e80: 7469 6e67 2e48 6172 6e65 7373 2853 6574  ting.Harness(Set
+00008e90: 4c65 6164 6572 4572 726f 7254 6573 7465  LeaderErrorTeste
+00008ea0: 722c 206d 6574 613d 2727 270a 2020 2020  r, meta='''.    
+00008eb0: 2020 2020 2020 2020 6e61 6d65 3a20 706f          name: po
+00008ec0: 7374 6772 6573 716c 0a20 2020 2020 2020  stgresql.       
+00008ed0: 2020 2020 2070 6565 7273 3a0a 2020 2020       peers:.    
+00008ee0: 2020 2020 2020 2020 2020 7065 6572 3a0a            peer:.
+00008ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f00: 696e 7465 7266 6163 653a 2066 6f6f 0a20  interface: foo. 
+00008f10: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00008f20: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00008f30: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00008f40: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00008f50: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
+00008f60: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+00008f70: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00008f80: 2852 756e 7469 6d65 4572 726f 7229 2061  (RuntimeError) a
+00008f90: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
+00008fa0: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
+00008fb0: 6164 6572 2869 735f 6c65 6164 6572 3d54  ader(is_leader=T
+00008fc0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00008fd0: 662e 6173 7365 7274 5472 7565 2863 6d2e  f.assertTrue(cm.
+00008fe0: 6578 6365 7074 696f 6e2e 6172 6773 5b30  exception.args[0
+00008ff0: 5d2e 6669 6e64 2827 7573 6520 4861 726e  ].find('use Harn
+00009000: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+00009010: 2729 2021 3d20 2d31 290a 0a20 2020 2064  ') != -1)..    d
+00009020: 6566 2074 6573 745f 7570 6461 7465 5f70  ef test_update_p
+00009030: 6565 725f 7265 6c61 7469 6f6e 5f61 7070  eer_relation_app
+00009040: 5f64 6174 6128 7365 6c66 293a 0a20 2020  _data(self):.   
+00009050: 2020 2020 2023 206c 616e 6775 6167 653d       # language=
+00009060: 5941 4d4c 0a20 2020 2020 2020 2068 6172  YAML.        har
+00009070: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00009080: 6e67 2e48 6172 6e65 7373 286f 7073 2e43  ng.Harness(ops.C
+00009090: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
+000090a0: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+000090b0: 616d 653a 2070 6f73 7467 7265 7371 6c0a  ame: postgresql.
+000090c0: 2020 2020 2020 2020 2020 2020 7065 6572              peer
+000090d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000090e0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+000090f0: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+00009100: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
+00009110: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
+00009120: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+00009130: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+00009140: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00009150: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+00009160: 6861 726e 6573 732e 7365 745f 6c65 6164  harness.set_lead
+00009170: 6572 2869 735f 6c65 6164 6572 3d54 7275  er(is_leader=Tru
+00009180: 6529 0a20 2020 2020 2020 2068 656c 7065  e).        helpe
+00009190: 7220 3d20 4442 5265 6c61 7469 6f6e 4368  r = DBRelationCh
+000091a0: 616e 6765 6448 656c 7065 7228 6861 726e  angedHelper(harn
+000091b0: 6573 732e 6368 6172 6d2c 2022 6865 6c70  ess.charm, "help
+000091c0: 6572 2229 0a20 2020 2020 2020 2072 656c  er").        rel
+000091d0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
+000091e0: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
+000091f0: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
+00009200: 2020 2020 2020 2072 656c 203d 2068 6172         rel = har
+00009210: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
+00009220: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
+00009230: 6227 290a 2020 2020 2020 2020 7265 6c2e  b').        rel.
+00009240: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
+00009250: 726d 2e61 7070 5d5b 276b 6579 275d 203d  rm.app]['key'] =
+00009260: 2027 7661 6c75 6527 0a20 2020 2020 2020   'value'.       
+00009270: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+00009280: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
+00009290: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
+000092a0: 6c27 2c20 7b27 6b65 7927 3a20 2776 3127  l', {'key': 'v1'
+000092b0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+000092c0: 6173 7365 7274 4571 7561 6c28 7b27 6b65  assertEqual({'ke
+000092d0: 7927 3a20 2776 3127 7d2c 2072 656c 2e64  y': 'v1'}, rel.d
+000092e0: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
+000092f0: 6d2e 6170 705d 290a 2020 2020 2020 2020  m.app]).        
+00009300: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00009310: 285b 5d2c 2068 656c 7065 722e 6368 616e  ([], helper.chan
+00009320: 6765 7329 0a0a 2020 2020 2020 2020 7265  ges)..        re
+00009330: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+00009340: 6861 726d 2e61 7070 5d5b 276b 6579 275d  harm.app]['key']
+00009350: 203d 2027 7632 270a 2020 2020 2020 2020   = 'v2'.        
+00009360: 2320 4f75 7220 756e 6974 2064 6174 6120  # Our unit data 
+00009370: 6261 6720 676f 7420 7570 6461 7465 642e  bag got updated.
+00009380: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00009390: 7365 7274 4571 7561 6c28 7265 6c2e 6461  sertEqual(rel.da
+000093a0: 7461 5b68 6172 6e65 7373 2e63 6861 726d  ta[harness.charm
+000093b0: 2e6d 6f64 656c 2e61 7070 5d5b 276b 6579  .model.app]['key
+000093c0: 275d 2c20 2776 3227 290a 2020 2020 2020  '], 'v2').      
+000093d0: 2020 2320 4275 7420 7468 6572 6520 7765    # But there we
+000093e0: 7265 206e 6f20 6368 616e 6765 6420 6576  re no changed ev
+000093f0: 656e 7473 2072 6567 6973 7465 7265 6420  ents registered 
+00009400: 6279 206f 7572 2075 6e69 742e 0a20 2020  by our unit..   
+00009410: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00009420: 4571 7561 6c28 5b5d 2c20 6865 6c70 6572  Equal([], helper
+00009430: 2e63 6861 6e67 6573 290a 0a20 2020 2020  .changes)..     
+00009440: 2020 2023 2049 6620 6f75 7220 756e 6974     # If our unit
+00009450: 2069 7320 6e6f 7420 6120 6c65 6164 6572   is not a leader
+00009460: 2075 6e69 7420 7765 2067 6574 2061 6e20   unit we get an 
+00009470: 7570 6461 7465 2061 626f 7574 2070 6565  update about pee
+00009480: 7220 6170 7020 7265 6c61 7469 6f6e 2064  r app relation d
+00009490: 6174 6120 6368 616e 6765 732e 0a20 2020  ata changes..   
+000094a0: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+000094b0: 5f6c 6561 6465 7228 6973 5f6c 6561 6465  _leader(is_leade
+000094c0: 723d 4661 6c73 6529 0a20 2020 2020 2020  r=False).       
+000094d0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+000094e0: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
+000094f0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
+00009500: 6c27 2c20 7b27 6b32 273a 2027 7632 277d  l', {'k2': 'v2'}
+00009510: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009520: 7373 6572 7445 7175 616c 2872 656c 2e64  ssertEqual(rel.d
+00009530: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
+00009540: 6d2e 6d6f 6465 6c2e 6170 705d 5b27 6b32  m.model.app]['k2
+00009550: 275d 2c20 2776 3227 290a 2020 2020 2020  '], 'v2').      
+00009560: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00009570: 616c 2868 656c 7065 722e 6368 616e 6765  al(helper.change
+00009580: 732c 205b 2830 2c20 2770 6f73 7467 7265  s, [(0, 'postgre
+00009590: 7371 6c27 295d 290a 0a20 2020 2064 6566  sql')])..    def
+000095a0: 2074 6573 745f 7570 6461 7465 5f72 656c   test_update_rel
+000095b0: 6174 696f 6e5f 6e6f 5f6c 6f63 616c 5f61  ation_no_local_a
+000095c0: 7070 5f63 6861 6e67 655f 6576 656e 7428  pp_change_event(
+000095d0: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+000095e0: 206c 616e 6775 6167 653d 5941 4d4c 0a20   language=YAML. 
+000095f0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+00009600: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00009610: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+00009620: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
+00009630: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
+00009640: 792d 6368 6172 6d0a 2020 2020 2020 2020  y-charm.        
+00009650: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+00009660: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00009670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009680: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00009690: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+000096a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000096b0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+000096c0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+000096d0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+000096e0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+000096f0: 7373 2e73 6574 5f6c 6561 6465 7228 4661  ss.set_leader(Fa
+00009700: 6c73 6529 0a20 2020 2020 2020 2068 656c  lse).        hel
+00009710: 7065 7220 3d20 4442 5265 6c61 7469 6f6e  per = DBRelation
+00009720: 4368 616e 6765 6448 656c 7065 7228 6861  ChangedHelper(ha
+00009730: 726e 6573 732e 6368 6172 6d2c 2022 6865  rness.charm, "he
+00009740: 6c70 6572 2229 0a20 2020 2020 2020 2072  lper").        r
+00009750: 656c 5f69 6420 3d20 6861 726e 6573 732e  el_id = harness.
+00009760: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+00009770: 272c 2027 706f 7374 6772 6573 716c 2729  ', 'postgresql')
+00009780: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
+00009790: 2072 656d 6f76 6520 7468 6973 2061 7320   remove this as 
+000097a0: 736f 6f6e 2061 7320 6874 7470 733a 2f2f  soon as https://
+000097b0: 6769 7468 7562 2e63 6f6d 2f63 616e 6f6e  github.com/canon
+000097c0: 6963 616c 2f6f 7065 7261 746f 722f 6973  ical/operator/is
+000097d0: 7375 6573 2f31 3735 2069 7320 6669 7865  sues/175 is fixe
+000097e0: 642e 0a20 2020 2020 2020 2068 6172 6e65  d..        harne
+000097f0: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
+00009800: 756e 6974 2872 656c 5f69 642c 2027 706f  unit(rel_id, 'po
+00009810: 7374 6772 6573 716c 2f30 2729 0a20 2020  stgresql/0').   
+00009820: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00009830: 4571 7561 6c28 6865 6c70 6572 2e63 6861  Equal(helper.cha
+00009840: 6e67 6573 2c20 5b5d 290a 0a20 2020 2020  nges, [])..     
+00009850: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
+00009860: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+00009870: 7265 6c5f 6964 2c20 276d 792d 6368 6172  rel_id, 'my-char
+00009880: 6d27 2c20 7b27 6e65 7727 3a20 2776 616c  m', {'new': 'val
+00009890: 7565 277d 290a 2020 2020 2020 2020 7265  ue'}).        re
+000098a0: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
+000098b0: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
+000098c0: 7469 6f6e 2827 6462 2729 0a20 2020 2020  tion('db').     
 000098d0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
 000098e0: 7561 6c28 7265 6c2e 6461 7461 5b68 6172  ual(rel.data[har
-000098f0: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
-00009900: 2e61 7070 5d5b 276e 6577 275d 2c20 2776  .app]['new'], 'v
-00009910: 616c 7565 2729 0a20 2020 2020 2020 2023  alue').        #
-00009920: 2042 7574 2074 6865 7265 2077 6572 6520   But there were 
-00009930: 6e6f 2063 6861 6e67 6564 2065 7665 6e74  no changed event
-00009940: 7320 7265 6769 7374 6572 6564 2062 7920  s registered by 
-00009950: 6f75 7220 756e 6974 2e0a 2020 2020 2020  our unit..      
-00009960: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00009970: 616c 2868 656c 7065 722e 6368 616e 6765  al(helper.change
-00009980: 732c 205b 5d29 0a0a 2020 2020 6465 6620  s, [])..    def 
-00009990: 7465 7374 5f75 7064 6174 655f 7265 6c61  test_update_rela
-000099a0: 7469 6f6e 5f72 656d 6f76 655f 6461 7461  tion_remove_data
-000099b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000099c0: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-000099d0: 7328 4368 6172 6d42 6173 652c 206d 6574  s(CharmBase, met
-000099e0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-000099f0: 2020 6e61 6d65 3a20 6d79 2d63 6861 726d    name: my-charm
-00009a00: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-00009a10: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-00009a20: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
-00009a30: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-00009a40: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-00009a50: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00009a60: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00009a70: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00009a80: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-00009a90: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-00009aa0: 2020 2020 7669 6577 6572 203d 2052 656c      viewer = Rel
-00009ab0: 6174 696f 6e43 6861 6e67 6564 5669 6577  ationChangedView
-00009ac0: 6572 2868 6172 6e65 7373 2e63 6861 726d  er(harness.charm
-00009ad0: 2c20 2764 6227 290a 2020 2020 2020 2020  , 'db').        
-00009ae0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-00009af0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-00009b00: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
-00009b10: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00009b20: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
-00009b30: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
-00009b40: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
-00009b50: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
-00009b60: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
-00009b70: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
-00009b80: 6573 716c 2f30 272c 207b 2769 6e69 7469  esql/0', {'initi
-00009b90: 616c 273a 2027 6461 7461 277d 290a 2020  al': 'data'}).  
-00009ba0: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
-00009bb0: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
-00009bc0: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
-00009bd0: 6772 6573 716c 2f30 272c 207b 2769 6e69  gresql/0', {'ini
-00009be0: 7469 616c 273a 2027 277d 290a 2020 2020  tial': ''}).    
-00009bf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00009c00: 7175 616c 2876 6965 7765 722e 6368 616e  qual(viewer.chan
-00009c10: 6765 732c 205b 7b27 696e 6974 6961 6c27  ges, [{'initial'
-00009c20: 3a20 2764 6174 6127 7d2c 207b 7d5d 290a  : 'data'}, {}]).
-00009c30: 0a20 2020 2064 6566 2074 6573 745f 6e6f  .    def test_no
-00009c40: 5f65 7665 6e74 5f6f 6e5f 656d 7074 795f  _event_on_empty_
-00009c50: 7570 6461 7465 5f72 656c 6174 696f 6e5f  update_relation_
-00009c60: 756e 6974 5f61 7070 2873 656c 6629 3a0a  unit_app(self):.
-00009c70: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00009c80: 3d20 4861 726e 6573 7328 4368 6172 6d42  = Harness(CharmB
-00009c90: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
-00009ca0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00009cb0: 6d79 2d63 6861 726d 0a20 2020 2020 2020  my-charm.       
-00009cc0: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
-00009cd0: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-00009ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009cf0: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
-00009d00: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
-00009d10: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00009d20: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00009d30: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-00009d40: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
-00009d50: 6e28 290a 2020 2020 2020 2020 7669 6577  n().        view
-00009d60: 6572 203d 2052 656c 6174 696f 6e43 6861  er = RelationCha
-00009d70: 6e67 6564 5669 6577 6572 2868 6172 6e65  ngedViewer(harne
-00009d80: 7373 2e63 6861 726d 2c20 2764 6227 290a  ss.charm, 'db').
-00009d90: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
-00009da0: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00009db0: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
-00009dc0: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
-00009dd0: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
-00009de0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-00009df0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-00009e00: 3027 290a 2020 2020 2020 2020 6861 726e  0').        harn
-00009e10: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00009e20: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00009e30: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
-00009e40: 2769 6e69 7469 616c 273a 2027 6461 7461  'initial': 'data
-00009e50: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
-00009e60: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00009e70: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00009e80: 2027 706f 7374 6772 6573 716c 272c 207b   'postgresql', {
-00009e90: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-00009ea0: 6173 7365 7274 4571 7561 6c28 7669 6577  assertEqual(view
-00009eb0: 6572 2e63 6861 6e67 6573 2c20 5b7b 2769  er.changes, [{'i
-00009ec0: 6e69 7469 616c 273a 2027 6461 7461 277d  nitial': 'data'}
-00009ed0: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-00009ee0: 5f6e 6f5f 6576 656e 745f 6f6e 5f6e 6f5f  _no_event_on_no_
-00009ef0: 6469 6666 5f75 7064 6174 655f 7265 6c61  diff_update_rela
-00009f00: 7469 6f6e 5f75 6e69 745f 6170 7028 7365  tion_unit_app(se
-00009f10: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-00009f20: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-00009f30: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-00009f40: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-00009f50: 616d 653a 206d 792d 6368 6172 6d0a 2020  ame: my-charm.  
-00009f60: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-00009f70: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00009f80: 2020 6462 3a0a 2020 2020 2020 2020 2020    db:.          
-00009f90: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
-00009fa0: 2070 6773 716c 0a20 2020 2020 2020 2020   pgsql.         
-00009fb0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00009fc0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-00009fd0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00009fe0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00009ff0: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0000a000: 2076 6965 7765 7220 3d20 5265 6c61 7469   viewer = Relati
-0000a010: 6f6e 4368 616e 6765 6456 6965 7765 7228  onChangedViewer(
-0000a020: 6861 726e 6573 732e 6368 6172 6d2c 2027  harness.charm, '
-0000a030: 6462 2729 0a20 2020 2020 2020 2072 656c  db').        rel
-0000a040: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-0000a050: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
-0000a060: 2027 706f 7374 6772 6573 716c 2729 0a20   'postgresql'). 
-0000a070: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
-0000a080: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
-0000a090: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
-0000a0a0: 6573 716c 2f30 2729 0a20 2020 2020 2020  esql/0').       
-0000a0b0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000a0c0: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-0000a0d0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-0000a0e0: 6c27 2c20 7b27 696e 6974 6961 6c27 3a20  l', {'initial': 
-0000a0f0: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
-0000a100: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000a110: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-0000a120: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-0000a130: 6c27 2c20 7b27 696e 6974 6961 6c27 3a20  l', {'initial': 
-0000a140: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
-0000a150: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000a160: 6c28 7669 6577 6572 2e63 6861 6e67 6573  l(viewer.changes
-0000a170: 2c20 5b7b 2769 6e69 7469 616c 273a 2027  , [{'initial': '
-0000a180: 6461 7461 277d 5d29 0a0a 2020 2020 6465  data'}])..    de
-0000a190: 6620 7465 7374 5f6e 6f5f 6576 656e 745f  f test_no_event_
-0000a1a0: 6f6e 5f65 6d70 7479 5f75 7064 6174 655f  on_empty_update_
-0000a1b0: 7265 6c61 7469 6f6e 5f75 6e69 745f 6261  relation_unit_ba
-0000a1c0: 6728 7365 6c66 293a 0a20 2020 2020 2020  g(self):.       
-0000a1d0: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-0000a1e0: 7373 2843 6861 726d 4261 7365 2c20 6d65  ss(CharmBase, me
-0000a1f0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-0000a200: 2020 206e 616d 653a 206d 792d 6368 6172     name: my-char
-0000a210: 6d0a 2020 2020 2020 2020 2020 2020 7265  m.            re
-0000a220: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-0000a230: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
-0000a240: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-0000a250: 6163 653a 2070 6773 716c 0a20 2020 2020  ace: pgsql.     
-0000a260: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-0000a270: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0000a280: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0000a290: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
-0000a2a0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
-0000a2b0: 2020 2020 2076 6965 7765 7220 3d20 5265       viewer = Re
-0000a2c0: 6c61 7469 6f6e 4368 616e 6765 6456 6965  lationChangedVie
-0000a2d0: 7765 7228 6861 726e 6573 732e 6368 6172  wer(harness.char
-0000a2e0: 6d2c 2027 6462 2729 0a20 2020 2020 2020  m, 'db').       
-0000a2f0: 2072 656c 5f69 6420 3d20 6861 726e 6573   rel_id = harnes
-0000a300: 732e 6164 645f 7265 6c61 7469 6f6e 2827  s.add_relation('
-0000a310: 6462 272c 2027 706f 7374 6772 6573 716c  db', 'postgresql
-0000a320: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-0000a330: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-0000a340: 756e 6974 2872 656c 5f69 642c 2027 706f  unit(rel_id, 'po
-0000a350: 7374 6772 6573 716c 2f30 2729 0a20 2020  stgresql/0').   
-0000a360: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-0000a370: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-0000a380: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
-0000a390: 7265 7371 6c2f 3027 2c20 7b27 696e 6974  resql/0', {'init
-0000a3a0: 6961 6c27 3a20 2764 6174 6127 7d29 0a20  ial': 'data'}). 
-0000a3b0: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
-0000a3c0: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
-0000a3d0: 6174 6128 7265 6c5f 6964 2c20 2770 6f73  ata(rel_id, 'pos
-0000a3e0: 7467 7265 7371 6c2f 3027 2c20 7b7d 290a  tgresql/0', {}).
-0000a3f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000a400: 6572 7445 7175 616c 2876 6965 7765 722e  ertEqual(viewer.
-0000a410: 6368 616e 6765 732c 205b 7b27 696e 6974  changes, [{'init
-0000a420: 6961 6c27 3a20 2764 6174 6127 7d5d 290a  ial': 'data'}]).
-0000a430: 0a20 2020 2064 6566 2074 6573 745f 6e6f  .    def test_no
-0000a440: 5f65 7665 6e74 5f6f 6e5f 6e6f 5f64 6966  _event_on_no_dif
-0000a450: 665f 7570 6461 7465 5f72 656c 6174 696f  f_update_relatio
-0000a460: 6e5f 756e 6974 5f62 6167 2873 656c 6629  n_unit_bag(self)
-0000a470: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-0000a480: 7320 3d20 4861 726e 6573 7328 4368 6172  s = Harness(Char
-0000a490: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-0000a4a0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000a4b0: 3a20 6d79 2d63 6861 726d 0a20 2020 2020  : my-charm.     
-0000a4c0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-0000a4d0: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
-0000a4e0: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
-0000a4f0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
-0000a500: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
-0000a510: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-0000a520: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0000a530: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-0000a540: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-0000a550: 6769 6e28 290a 2020 2020 2020 2020 7669  gin().        vi
-0000a560: 6577 6572 203d 2052 656c 6174 696f 6e43  ewer = RelationC
-0000a570: 6861 6e67 6564 5669 6577 6572 2868 6172  hangedViewer(har
-0000a580: 6e65 7373 2e63 6861 726d 2c20 2764 6227  ness.charm, 'db'
-0000a590: 290a 2020 2020 2020 2020 7265 6c5f 6964  ).        rel_id
-0000a5a0: 203d 2068 6172 6e65 7373 2e61 6464 5f72   = harness.add_r
-0000a5b0: 656c 6174 696f 6e28 2764 6227 2c20 2770  elation('db', 'p
-0000a5c0: 6f73 7467 7265 7371 6c27 290a 2020 2020  ostgresql').    
-0000a5d0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-0000a5e0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
-0000a5f0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-0000a600: 6c2f 3027 290a 2020 2020 2020 2020 6861  l/0').        ha
-0000a610: 726e 6573 732e 7570 6461 7465 5f72 656c  rness.update_rel
-0000a620: 6174 696f 6e5f 6461 7461 2872 656c 5f69  ation_data(rel_i
-0000a630: 642c 2027 706f 7374 6772 6573 716c 2f30  d, 'postgresql/0
-0000a640: 272c 207b 2769 6e69 7469 616c 273a 2027  ', {'initial': '
-0000a650: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
-0000a660: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
-0000a670: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
-0000a680: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-0000a690: 2f30 272c 207b 2769 6e69 7469 616c 273a  /0', {'initial':
-0000a6a0: 2027 6461 7461 277d 290a 2020 2020 2020   'data'}).      
-0000a6b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000a6c0: 616c 2876 6965 7765 722e 6368 616e 6765  al(viewer.change
-0000a6d0: 732c 205b 7b27 696e 6974 6961 6c27 3a20  s, [{'initial': 
-0000a6e0: 2764 6174 6127 7d5d 290a 0a20 2020 2064  'data'}])..    d
-0000a6f0: 6566 2074 6573 745f 656d 7074 795f 636f  ef test_empty_co
-0000a700: 6e66 6967 5f72 6169 7365 7328 7365 6c66  nfig_raises(self
-0000a710: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
-0000a720: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000a730: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
-0000a740: 2020 2020 2020 2020 2020 4861 726e 6573            Harnes
-0000a750: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
-0000a760: 2c20 636f 6e66 6967 3d27 2729 0a0a 2020  , config='')..  
-0000a770: 2020 6465 6620 7465 7374 5f75 7064 6174    def test_updat
-0000a780: 655f 636f 6e66 6967 2873 656c 6629 3a0a  e_config(self):.
-0000a790: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-0000a7a0: 3d20 4861 726e 6573 7328 5265 636f 7264  = Harness(Record
-0000a7b0: 696e 6743 6861 726d 2c20 636f 6e66 6967  ingCharm, config
-0000a7c0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-0000a7d0: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
-0000a7e0: 2020 2020 2020 2020 2020 613a 0a20 2020            a:.   
-0000a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a800: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
-0000a810: 636f 6e66 6967 206f 7074 696f 6e0a 2020  config option.  
-0000a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a830: 2020 7479 7065 3a20 7374 7269 6e67 0a20    type: string. 
-0000a840: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000a850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a860: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
-0000a870: 6e3a 2061 6e6f 7468 6572 2063 6f6e 6669  n: another confi
-0000a880: 6720 6f70 7469 6f6e 0a20 2020 2020 2020  g option.       
-0000a890: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-0000a8a0: 653a 2069 6e74 0a20 2020 2020 2020 2020  e: int.         
-0000a8b0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-0000a8c0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-0000a8d0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-0000a8e0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000a8f0: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0000a900: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000a910: 636f 6e66 6967 286b 6579 5f76 616c 7565  config(key_value
-0000a920: 733d 7b27 6127 3a20 2766 6f6f 272c 2027  s={'a': 'foo', '
-0000a930: 6227 3a20 327d 290a 2020 2020 2020 2020  b': 2}).        
-0000a940: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000a950: 280a 2020 2020 2020 2020 2020 2020 6861  (.            ha
-0000a960: 726e 6573 732e 6368 6172 6d2e 6368 616e  rness.charm.chan
-0000a970: 6765 732c 0a20 2020 2020 2020 2020 2020  ges,.           
-0000a980: 205b 7b27 6e61 6d65 273a 2027 636f 6e66   [{'name': 'conf
-0000a990: 6967 2d63 6861 6e67 6564 272c 2027 6461  ig-changed', 'da
-0000a9a0: 7461 273a 207b 2761 273a 2027 666f 6f27  ta': {'a': 'foo'
-0000a9b0: 2c20 2762 273a 2032 7d7d 5d29 0a20 2020  , 'b': 2}}]).   
-0000a9c0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-0000a9d0: 6174 655f 636f 6e66 6967 286b 6579 5f76  ate_config(key_v
-0000a9e0: 616c 7565 733d 7b27 6227 3a20 337d 290a  alues={'b': 3}).
-0000a9f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000aa00: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-0000aa10: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
-0000aa20: 6172 6d2e 6368 616e 6765 732c 0a20 2020  arm.changes,.   
-0000aa30: 2020 2020 2020 2020 205b 7b27 6e61 6d65           [{'name
-0000aa40: 273a 2027 636f 6e66 6967 2d63 6861 6e67  ': 'config-chang
-0000aa50: 6564 272c 2027 6461 7461 273a 207b 2761  ed', 'data': {'a
-0000aa60: 273a 2027 666f 6f27 2c20 2762 273a 2032  ': 'foo', 'b': 2
-0000aa70: 7d7d 2c0a 2020 2020 2020 2020 2020 2020  }},.            
-0000aa80: 207b 276e 616d 6527 3a20 2763 6f6e 6669   {'name': 'confi
-0000aa90: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
-0000aaa0: 6127 3a20 7b27 6127 3a20 2766 6f6f 272c  a': {'a': 'foo',
-0000aab0: 2027 6227 3a20 337d 7d5d 290a 2020 2020   'b': 3}}]).    
-0000aac0: 2020 2020 2320 796f 7520 6361 6e20 7365      # you can se
-0000aad0: 7420 636f 6e66 6967 2076 616c 7565 7320  t config values 
-0000aae0: 746f 2074 6865 2065 6d70 7479 2073 7472  to the empty str
-0000aaf0: 696e 672c 2079 6f75 2063 616e 2075 7365  ing, you can use
-0000ab00: 2075 6e73 6574 2074 6f20 6163 7475 616c   unset to actual
-0000ab10: 6c79 2072 656d 6f76 6520 6974 656d 730a  ly remove items.
-0000ab20: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000ab30: 7570 6461 7465 5f63 6f6e 6669 6728 6b65  update_config(ke
-0000ab40: 795f 7661 6c75 6573 3d7b 2761 273a 2027  y_values={'a': '
-0000ab50: 277d 2c20 756e 7365 743d 7365 7428 2762  '}, unset=set('b
-0000ab60: 2729 290a 2020 2020 2020 2020 7365 6c66  ')).        self
-0000ab70: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
-0000ab80: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
-0000ab90: 732e 6368 6172 6d2e 6368 616e 6765 732c  s.charm.changes,
-0000aba0: 0a20 2020 2020 2020 2020 2020 205b 7b27  .            [{'
-0000abb0: 6e61 6d65 273a 2027 636f 6e66 6967 2d63  name': 'config-c
-0000abc0: 6861 6e67 6564 272c 2027 6461 7461 273a  hanged', 'data':
-0000abd0: 207b 2761 273a 2027 666f 6f27 2c20 2762   {'a': 'foo', 'b
-0000abe0: 273a 2032 7d7d 2c0a 2020 2020 2020 2020  ': 2}},.        
-0000abf0: 2020 2020 207b 276e 616d 6527 3a20 2763       {'name': 'c
-0000ac00: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
-0000ac10: 2764 6174 6127 3a20 7b27 6127 3a20 2766  'data': {'a': 'f
-0000ac20: 6f6f 272c 2027 6227 3a20 337d 7d2c 0a20  oo', 'b': 3}},. 
-0000ac30: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-0000ac40: 6d65 273a 2027 636f 6e66 6967 2d63 6861  me': 'config-cha
-0000ac50: 6e67 6564 272c 2027 6461 7461 273a 207b  nged', 'data': {
-0000ac60: 2761 273a 2027 277d 7d2c 0a20 2020 2020  'a': ''}},.     
-0000ac70: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
-0000ac80: 6465 6620 7465 7374 5f75 7064 6174 655f  def test_update_
-0000ac90: 636f 6e66 6967 5f75 6e64 6566 696e 6564  config_undefined
-0000aca0: 5f6f 7074 696f 6e28 7365 6c66 293a 0a20  _option(self):. 
-0000acb0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-0000acc0: 2048 6172 6e65 7373 2852 6563 6f72 6469   Harness(Recordi
-0000acd0: 6e67 4368 6172 6d29 0a20 2020 2020 2020  ngCharm).       
-0000ace0: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0000acf0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-0000ad00: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-0000ad10: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
-0000ad20: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0000ad30: 7274 5261 6973 6573 2856 616c 7565 4572  rtRaises(ValueEr
-0000ad40: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000ad50: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-0000ad60: 5f63 6f6e 6669 6728 6b65 795f 7661 6c75  _config(key_valu
-0000ad70: 6573 3d7b 276e 6f6e 6578 6973 7465 6e74  es={'nonexistent
-0000ad80: 273a 2027 666f 6f27 7d29 0a0a 2020 2020  ': 'foo'})..    
-0000ad90: 6465 6620 7465 7374 5f75 7064 6174 655f  def test_update_
-0000ada0: 636f 6e66 6967 5f62 6164 5f74 7970 6528  config_bad_type(
-0000adb0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-0000adc0: 6172 6e65 7373 203d 2048 6172 6e65 7373  arness = Harness
-0000add0: 2852 6563 6f72 6469 6e67 4368 6172 6d2c  (RecordingCharm,
-0000ade0: 2063 6f6e 6669 673d 2727 270a 2020 2020   config='''.    
-0000adf0: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
-0000ae00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ae10: 2061 3a0a 2020 2020 2020 2020 2020 2020   a:.            
-0000ae20: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-0000ae30: 696f 6e3a 2061 2063 6f6e 6669 6720 6f70  ion: a config op
-0000ae40: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-0000ae50: 2020 2020 2020 2020 2074 7970 653a 2062           type: b
-0000ae60: 6f6f 6c65 616e 0a20 2020 2020 2020 2020  oolean.         
-0000ae70: 2020 2020 2020 2020 2020 2064 6566 6175             defau
-0000ae80: 6c74 3a20 6661 6c73 650a 2020 2020 2020  lt: false.      
-0000ae90: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0000aea0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0000aeb0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0000aec0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-0000aed0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-0000aee0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000aef0: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0000af00: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-0000af10: 2020 2020 2020 2320 6361 6e6e 6f74 2063        # cannot c
-0000af20: 6173 7420 746f 2062 6f6f 6c0a 2020 2020  ast to bool.    
-0000af30: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000af40: 7570 6461 7465 5f63 6f6e 6669 6728 6b65  update_config(ke
-0000af50: 795f 7661 6c75 6573 3d7b 2761 273a 2027  y_values={'a': '
-0000af60: 666f 6f27 7d29 0a0a 2020 2020 2020 2020  foo'})..        
-0000af70: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0000af80: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
-0000af90: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000afa0: 2020 2320 6361 6e6e 6f74 2063 6173 7420    # cannot cast 
-0000afb0: 746f 2066 6c6f 6174 0a20 2020 2020 2020  to float.       
-0000afc0: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-0000afd0: 6174 655f 636f 6e66 6967 286b 6579 5f76  ate_config(key_v
-0000afe0: 616c 7565 733d 7b27 6127 3a20 3432 2e34  alues={'a': 42.4
-0000aff0: 327d 290a 0a20 2020 2020 2020 2077 6974  2})..        wit
-0000b000: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000b010: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
-0000b020: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-0000b030: 2063 616e 6e6f 7420 6361 7374 2074 6f20   cannot cast to 
-0000b040: 696e 740a 2020 2020 2020 2020 2020 2020  int.            
-0000b050: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
-0000b060: 6f6e 6669 6728 6b65 795f 7661 6c75 6573  onfig(key_values
-0000b070: 3d7b 2761 273a 2034 327d 290a 0a20 2020  ={'a': 42})..   
-0000b080: 2020 2020 2023 2063 616e 2063 6173 7420       # can cast 
-0000b090: 746f 2062 6f6f 6c21 0a20 2020 2020 2020  to bool!.       
-0000b0a0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000b0b0: 636f 6e66 6967 286b 6579 5f76 616c 7565  config(key_value
-0000b0c0: 733d 7b27 6127 3a20 4661 6c73 657d 290a  s={'a': False}).
-0000b0d0: 0a20 2020 2064 6566 2074 6573 745f 6261  .    def test_ba
-0000b0e0: 645f 636f 6e66 6967 5f6f 7074 696f 6e5f  d_config_option_
-0000b0f0: 7479 7065 2873 656c 6629 3a0a 2020 2020  type(self):.    
-0000b100: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000b110: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0000b120: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-0000b130: 2020 2020 2020 4861 726e 6573 7328 5265        Harness(Re
-0000b140: 636f 7264 696e 6743 6861 726d 2c20 636f  cordingCharm, co
-0000b150: 6e66 6967 3d27 2727 0a20 2020 2020 2020  nfig='''.       
-0000b160: 2020 2020 2020 2020 206f 7074 696f 6e73           options
-0000b170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b180: 2020 2020 2020 613a 0a20 2020 2020 2020        a:.       
-0000b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1a0: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
-0000b1b0: 636f 6e66 6967 206f 7074 696f 6e0a 2020  config option.  
-0000b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1d0: 2020 2020 2020 7479 7065 3a20 6769 6262        type: gibb
-0000b1e0: 6572 6973 680a 2020 2020 2020 2020 2020  erish.          
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0000b200: 6661 756c 743a 2046 616c 7365 0a20 2020  fault: False.   
-0000b210: 2020 2020 2020 2020 2020 2020 2027 2727               '''
-0000b220: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0000b230: 6e6f 5f63 6f6e 6669 675f 6f70 7469 6f6e  no_config_option
-0000b240: 5f74 7970 6528 7365 6c66 293a 0a20 2020  _type(self):.   
-0000b250: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0000b260: 7373 6572 7452 6169 7365 7328 5275 6e74  ssertRaises(Runt
-0000b270: 696d 6545 7272 6f72 293a 0a20 2020 2020  imeError):.     
-0000b280: 2020 2020 2020 2048 6172 6e65 7373 2852         Harness(R
-0000b290: 6563 6f72 6469 6e67 4368 6172 6d2c 2063  ecordingCharm, c
-0000b2a0: 6f6e 6669 673d 2727 270a 2020 2020 2020  onfig='''.      
-0000b2b0: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
-0000b2c0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000b2d0: 2020 2020 2020 2061 3a0a 2020 2020 2020         a:.      
-0000b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2f0: 2020 6465 7363 7269 7074 696f 6e3a 2061    description: a
-0000b300: 2063 6f6e 6669 6720 6f70 7469 6f6e 0a20   config option. 
-0000b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b320: 2020 2020 2020 2064 6566 6175 6c74 3a20         default: 
-0000b330: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-0000b340: 2020 2020 2020 2727 2729 0a0a 2020 2020        ''')..    
-0000b350: 6465 6620 7465 7374 5f75 6e63 6173 7461  def test_uncasta
-0000b360: 626c 655f 636f 6e66 6967 5f6f 7074 696f  ble_config_optio
-0000b370: 6e5f 7479 7065 2873 656c 6629 3a0a 2020  n_type(self):.  
-0000b380: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000b390: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-0000b3a0: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-0000b3b0: 2020 2020 2020 2020 4861 726e 6573 7328          Harness(
-0000b3c0: 5265 636f 7264 696e 6743 6861 726d 2c20  RecordingCharm, 
-0000b3d0: 636f 6e66 6967 3d27 2727 0a20 2020 2020  config='''.     
-0000b3e0: 2020 2020 2020 2020 2020 206f 7074 696f             optio
-0000b3f0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0000b400: 2020 2020 2020 2020 613a 0a20 2020 2020          a:.     
-0000b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b420: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-0000b430: 6120 636f 6e66 6967 206f 7074 696f 6e0a  a config option.
-0000b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b450: 2020 2020 2020 2020 7479 7065 3a20 626f          type: bo
-0000b460: 6f6c 6561 6e0a 2020 2020 2020 2020 2020  olean.          
-0000b470: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0000b480: 6661 756c 743a 2070 6565 6b2d 612d 626f  fault: peek-a-bo
-0000b490: 6f6c 210a 2020 2020 2020 2020 2020 2020  ol!.            
-0000b4a0: 2020 2020 2727 2729 0a0a 2020 2020 6465      ''')..    de
-0000b4b0: 6620 7465 7374 5f75 7064 6174 655f 636f  f test_update_co
-0000b4c0: 6e66 6967 5f75 6e73 6574 5f62 6f6f 6c65  nfig_unset_boole
-0000b4d0: 616e 2873 656c 6629 3a0a 2020 2020 2020  an(self):.      
-0000b4e0: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-0000b4f0: 6573 7328 5265 636f 7264 696e 6743 6861  ess(RecordingCha
-0000b500: 726d 2c20 636f 6e66 6967 3d27 2727 0a20  rm, config='''. 
-0000b510: 2020 2020 2020 2020 2020 206f 7074 696f             optio
-0000b520: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0000b530: 2020 2020 613a 0a20 2020 2020 2020 2020      a:.         
-0000b540: 2020 2020 2020 2020 2020 2064 6573 6372             descr
-0000b550: 6970 7469 6f6e 3a20 6120 636f 6e66 6967  iption: a config
-0000b560: 206f 7074 696f 6e0a 2020 2020 2020 2020   option.        
-0000b570: 2020 2020 2020 2020 2020 2020 7479 7065              type
-0000b580: 3a20 626f 6f6c 6561 6e0a 2020 2020 2020  : boolean.      
-0000b590: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0000b5a0: 6661 756c 743a 2046 616c 7365 0a20 2020  fault: False.   
-0000b5b0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-0000b5c0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-0000b5d0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-0000b5e0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
-0000b5f0: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
-0000b600: 2020 2020 2020 2023 2043 6865 636b 2074         # Check t
-0000b610: 6865 2064 6566 6175 6c74 2077 6173 2073  he default was s
-0000b620: 6574 2063 6f72 7265 6374 6c79 0a20 2020  et correctly.   
-0000b630: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000b640: 4571 7561 6c28 6861 726e 6573 732e 6368  Equal(harness.ch
-0000b650: 6172 6d2e 636f 6e66 6967 2c20 7b27 6127  arm.config, {'a'
-0000b660: 3a20 4661 6c73 657d 290a 2020 2020 2020  : False}).      
-0000b670: 2020 2320 5365 7420 7468 6520 626f 6f6c    # Set the bool
-0000b680: 6561 6e20 7661 6c75 6520 746f 2054 7275  ean value to Tru
-0000b690: 650a 2020 2020 2020 2020 6861 726e 6573  e.        harnes
-0000b6a0: 732e 7570 6461 7465 5f63 6f6e 6669 6728  s.update_config(
-0000b6b0: 6b65 795f 7661 6c75 6573 3d7b 2761 273a  key_values={'a':
-0000b6c0: 2054 7275 657d 290a 2020 2020 2020 2020   True}).        
-0000b6d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000b6e0: 2868 6172 6e65 7373 2e63 6861 726d 2e63  (harness.charm.c
-0000b6f0: 6861 6e67 6573 2c20 5b7b 276e 616d 6527  hanges, [{'name'
-0000b700: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
-0000b710: 6427 2c20 2764 6174 6127 3a20 7b27 6127  d', 'data': {'a'
-0000b720: 3a20 5472 7565 7d7d 5d29 0a20 2020 2020  : True}}]).     
-0000b730: 2020 2023 2055 6e73 6574 2074 6865 2062     # Unset the b
-0000b740: 6f6f 6c65 616e 2076 616c 7565 0a20 2020  oolean value.   
-0000b750: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-0000b760: 6174 655f 636f 6e66 6967 2875 6e73 6574  ate_config(unset
-0000b770: 3d7b 2761 277d 290a 2020 2020 2020 2020  ={'a'}).        
-0000b780: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000b790: 280a 2020 2020 2020 2020 2020 2020 6861  (.            ha
-0000b7a0: 726e 6573 732e 6368 6172 6d2e 6368 616e  rness.charm.chan
-0000b7b0: 6765 732c 0a20 2020 2020 2020 2020 2020  ges,.           
-0000b7c0: 205b 7b27 6e61 6d65 273a 2027 636f 6e66   [{'name': 'conf
-0000b7d0: 6967 2d63 6861 6e67 6564 272c 2027 6461  ig-changed', 'da
-0000b7e0: 7461 273a 207b 2761 273a 2054 7275 657d  ta': {'a': True}
-0000b7f0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0000b800: 7b27 6e61 6d65 273a 2027 636f 6e66 6967  {'name': 'config
-0000b810: 2d63 6861 6e67 6564 272c 2027 6461 7461  -changed', 'data
-0000b820: 273a 207b 2761 273a 2046 616c 7365 7d7d  ': {'a': False}}
-0000b830: 5d29 0a0a 2020 2020 6465 6620 7465 7374  ])..    def test
-0000b840: 5f73 6574 5f6c 6561 6465 7228 7365 6c66  _set_leader(self
-0000b850: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0000b860: 7373 203d 2048 6172 6e65 7373 2852 6563  ss = Harness(Rec
-0000b870: 6f72 6469 6e67 4368 6172 6d29 0a20 2020  ordingCharm).   
-0000b880: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0000b890: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0000b8a0: 616e 7570 290a 2020 2020 2020 2020 2320  anup).        # 
-0000b8b0: 4e6f 2065 7665 6e74 2068 6170 7065 6e73  No event happens
-0000b8c0: 2068 6572 650a 2020 2020 2020 2020 6861   here.        ha
-0000b8d0: 726e 6573 732e 7365 745f 6c65 6164 6572  rness.set_leader
-0000b8e0: 2846 616c 7365 290a 2020 2020 2020 2020  (False).        
-0000b8f0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
-0000b900: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000b910: 6572 7446 616c 7365 2868 6172 6e65 7373  ertFalse(harness
-0000b920: 2e63 6861 726d 2e6d 6f64 656c 2e75 6e69  .charm.model.uni
-0000b930: 742e 6973 5f6c 6561 6465 7228 2929 0a20  t.is_leader()). 
-0000b940: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
-0000b950: 6574 5f6c 6561 6465 7228 5472 7565 290a  et_leader(True).
-0000b960: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000b970: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
-0000b980: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
-0000b990: 6573 2872 6573 6574 3d54 7275 6529 2c20  es(reset=True), 
-0000b9a0: 5b7b 276e 616d 6527 3a20 276c 6561 6465  [{'name': 'leade
-0000b9b0: 722d 656c 6563 7465 6427 7d5d 290a 2020  r-elected'}]).  
-0000b9c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000b9d0: 7454 7275 6528 6861 726e 6573 732e 6368  tTrue(harness.ch
-0000b9e0: 6172 6d2e 6d6f 6465 6c2e 756e 6974 2e69  arm.model.unit.i
-0000b9f0: 735f 6c65 6164 6572 2829 290a 2020 2020  s_leader()).    
-0000ba00: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-0000ba10: 6c65 6164 6572 2846 616c 7365 290a 2020  leader(False).  
-0000ba20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000ba30: 7446 616c 7365 2868 6172 6e65 7373 2e63  tFalse(harness.c
-0000ba40: 6861 726d 2e6d 6f64 656c 2e75 6e69 742e  harm.model.unit.
-0000ba50: 6973 5f6c 6561 6465 7228 2929 0a20 2020  is_leader()).   
-0000ba60: 2020 2020 2023 204e 6f20 686f 6f6b 2065       # No hook e
-0000ba70: 7665 6e74 2077 6865 6e20 796f 7520 6c6f  vent when you lo
-0000ba80: 7365 206c 6561 6465 7273 6869 702e 0a20  se leadership.. 
-0000ba90: 2020 2020 2020 2023 2054 4f44 4f3a 2076         # TODO: v
-0000baa0: 6572 6966 7920 6966 204a 756a 7520 616c  erify if Juju al
-0000bab0: 7761 7973 2074 7269 6767 6572 7320 606c  ways triggers `l
-0000bac0: 6561 6465 722d 7365 7474 696e 6773 2d63  eader-settings-c
-0000bad0: 6861 6e67 6564 6020 6966 2079 6f75 0a20  hanged` if you. 
-0000bae0: 2020 2020 2020 2023 2020 206c 6f73 6520         #   lose 
-0000baf0: 6c65 6164 6572 7368 6970 2e0a 2020 2020  leadership..    
-0000bb00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000bb10: 7175 616c 2868 6172 6e65 7373 2e63 6861  qual(harness.cha
-0000bb20: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
-0000bb30: 6573 6574 3d54 7275 6529 2c20 5b5d 290a  eset=True), []).
-0000bb40: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000bb50: 6469 7361 626c 655f 686f 6f6b 7328 290a  disable_hooks().
-0000bb60: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000bb70: 7365 745f 6c65 6164 6572 2854 7275 6529  set_leader(True)
-0000bb80: 0a20 2020 2020 2020 2023 204e 6f20 686f  .        # No ho
-0000bb90: 6f6b 2065 7665 6e74 2069 6620 796f 7520  ok event if you 
-0000bba0: 6861 7665 2064 6973 6162 6c65 6420 7468  have disabled th
-0000bbb0: 656d 0a20 2020 2020 2020 2073 656c 662e  em.        self.
-0000bbc0: 6173 7365 7274 4571 7561 6c28 6861 726e  assertEqual(harn
-0000bbd0: 6573 732e 6368 6172 6d2e 6765 745f 6368  ess.charm.get_ch
-0000bbe0: 616e 6765 7328 7265 7365 743d 5472 7565  anges(reset=True
-0000bbf0: 292c 205b 5d29 0a0a 2020 2020 6465 6620  ), [])..    def 
-0000bc00: 7465 7374 5f72 656c 6174 696f 6e5f 7365  test_relation_se
-0000bc10: 745f 6170 705f 6e6f 745f 6c65 6164 6572  t_app_not_leader
-0000bc20: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000bc30: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-0000bc40: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
-0000bc50: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0000bc60: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0000bc70: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
-0000bc80: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
-0000bc90: 2020 2020 2020 2020 2020 2020 2020 6462                db
-0000bca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bcb0: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
-0000bcc0: 2070 6773 716c 0a20 2020 2020 2020 2020   pgsql.         
-0000bcd0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-0000bce0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-0000bcf0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-0000bd00: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000bd10: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0000bd20: 2068 6172 6e65 7373 2e73 6574 5f6c 6561   harness.set_lea
-0000bd30: 6465 7228 4661 6c73 6529 0a20 2020 2020  der(False).     
-0000bd40: 2020 2072 656c 5f69 6420 3d20 6861 726e     rel_id = harn
-0000bd50: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0000bd60: 2827 6462 272c 2027 706f 7374 6772 6573  ('db', 'postgres
-0000bd70: 716c 2729 0a20 2020 2020 2020 2068 6172  ql').        har
-0000bd80: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-0000bd90: 6e5f 756e 6974 2872 656c 5f69 642c 2027  n_unit(rel_id, '
-0000bda0: 706f 7374 6772 6573 716c 2f30 2729 0a20  postgresql/0'). 
-0000bdb0: 2020 2020 2020 2072 656c 203d 2068 6172         rel = har
-0000bdc0: 6e65 7373 2e63 6861 726d 2e6d 6f64 656c  ness.charm.model
-0000bdd0: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
-0000bde0: 6227 290a 2020 2020 2020 2020 7769 7468  b').        with
-0000bdf0: 2068 6172 6e65 7373 2e5f 6576 656e 745f   harness._event_
-0000be00: 636f 6e74 6578 7428 2766 6f6f 2729 3a0a  context('foo'):.
-0000be10: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0000be20: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000be30: 6573 284d 6f64 656c 4572 726f 7229 3a0a  es(ModelError):.
-0000be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be50: 7265 6c2e 6461 7461 5b68 6172 6e65 7373  rel.data[harness
-0000be60: 2e63 6861 726d 2e61 7070 5d5b 2766 6f6f  .charm.app]['foo
-0000be70: 275d 203d 2027 6261 7227 0a20 2020 2020  '] = 'bar'.     
-0000be80: 2020 2023 2054 6865 2064 6174 6120 6861     # The data ha
-0000be90: 7320 6e6f 7420 6163 7475 616c 6c79 2062  s not actually b
-0000bea0: 6565 6e20 6368 616e 6765 640a 2020 2020  een changed.    
-0000beb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000bec0: 7175 616c 2868 6172 6e65 7373 2e67 6574  qual(harness.get
-0000bed0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-0000bee0: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
-0000bef0: 726d 2729 2c20 7b7d 290a 2020 2020 2020  rm'), {}).      
-0000bf00: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
-0000bf10: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
-0000bf20: 2020 2072 656c 2e64 6174 615b 6861 726e     rel.data[harn
-0000bf30: 6573 732e 6368 6172 6d2e 6170 705d 5b27  ess.charm.app]['
-0000bf40: 666f 6f27 5d20 3d20 2762 6172 270a 2020  foo'] = 'bar'.  
-0000bf50: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000bf60: 7445 7175 616c 2868 6172 6e65 7373 2e67  tEqual(harness.g
-0000bf70: 6574 5f72 656c 6174 696f 6e5f 6461 7461  et_relation_data
-0000bf80: 2872 656c 5f69 642c 2027 7465 7374 2d63  (rel_id, 'test-c
-0000bf90: 6861 726d 2729 2c20 7b27 666f 6f27 3a20  harm'), {'foo': 
-0000bfa0: 2762 6172 277d 290a 0a20 2020 2064 6566  'bar'})..    def
-0000bfb0: 2074 6573 745f 686f 6f6b 735f 656e 6162   test_hooks_enab
-0000bfc0: 6c65 645f 616e 645f 6469 7361 626c 6564  led_and_disabled
-0000bfd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000bfe0: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-0000bff0: 7328 0a20 2020 2020 2020 2020 2020 2052  s(.            R
-0000c000: 6563 6f72 6469 6e67 4368 6172 6d2c 0a20  ecordingCharm,. 
-0000c010: 2020 2020 2020 2020 2020 206d 6574 613d             meta=
-0000c020: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0000c030: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-0000c040: 7374 2d63 6861 726d 0a20 2020 2020 2020  st-charm.       
-0000c050: 2020 2020 2020 2020 2027 2727 2c0a 2020           ''',.  
-0000c060: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-0000c070: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-0000c080: 2020 2020 2020 2020 206f 7074 696f 6e73           options
-0000c090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c0a0: 2020 2020 2020 2020 2020 7661 6c75 653a            value:
-0000c0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c0c0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-0000c0d0: 653a 2073 7472 696e 670a 2020 2020 2020  e: string.      
-0000c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0f0: 2020 7468 6972 643a 0a20 2020 2020 2020    third:.       
-0000c100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c110: 2020 2020 2074 7970 653a 2073 7472 696e       type: strin
-0000c120: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0000c130: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0000c140: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0000c150: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0000c160: 7570 290a 2020 2020 2020 2020 2320 4265  up).        # Be
-0000c170: 666f 7265 2062 6567 696e 2829 2074 6865  fore begin() the
-0000c180: 7265 2061 7265 206e 6f20 6576 656e 7473  re are no events
-0000c190: 2e0a 2020 2020 2020 2020 6861 726e 6573  ..        harnes
-0000c1a0: 732e 7570 6461 7465 5f63 6f6e 6669 6728  s.update_config(
-0000c1b0: 7b27 7661 6c75 6527 3a20 2766 6972 7374  {'value': 'first
-0000c1c0: 277d 290a 2020 2020 2020 2020 2320 4279  '}).        # By
-0000c1d0: 2064 6566 6175 6c74 2c20 6166 7465 7220   default, after 
-0000c1e0: 6265 6769 6e20 7468 6520 6368 6172 6d20  begin the charm 
-0000c1f0: 6973 2073 6574 2075 7020 746f 2072 6563  is set up to rec
-0000c200: 6569 7665 2065 7665 6e74 732e 0a20 2020  eive events..   
-0000c210: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
-0000c220: 696e 2829 0a20 2020 2020 2020 2068 6172  in().        har
-0000c230: 6e65 7373 2e75 7064 6174 655f 636f 6e66  ness.update_conf
-0000c240: 6967 287b 2776 616c 7565 273a 2027 7365  ig({'value': 'se
-0000c250: 636f 6e64 277d 290a 2020 2020 2020 2020  cond'}).        
-0000c260: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000c270: 280a 2020 2020 2020 2020 2020 2020 6861  (.            ha
-0000c280: 726e 6573 732e 6368 6172 6d2e 6765 745f  rness.charm.get_
-0000c290: 6368 616e 6765 7328 7265 7365 743d 5472  changes(reset=Tr
-0000c2a0: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-0000c2b0: 205b 7b27 6e61 6d65 273a 2027 636f 6e66   [{'name': 'conf
-0000c2c0: 6967 2d63 6861 6e67 6564 272c 2027 6461  ig-changed', 'da
-0000c2d0: 7461 273a 207b 2776 616c 7565 273a 2027  ta': {'value': '
-0000c2e0: 7365 636f 6e64 277d 7d5d 290a 2020 2020  second'}}]).    
-0000c2f0: 2020 2020 2320 4f6e 6365 2064 6973 6162      # Once disab
-0000c300: 6c65 642c 2077 6520 776f 6e27 7420 7365  led, we won't se
-0000c310: 6520 636f 6e66 6967 2d63 6861 6e67 6564  e config-changed
-0000c320: 2077 6865 6e20 7765 206d 616b 6520 616e   when we make an
-0000c330: 2075 7064 6174 650a 2020 2020 2020 2020   update.        
-0000c340: 6861 726e 6573 732e 6469 7361 626c 655f  harness.disable_
-0000c350: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
-0000c360: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
-0000c370: 6f6e 6669 6728 7b27 7468 6972 6427 3a20  onfig({'third': 
-0000c380: 2733 277d 290a 2020 2020 2020 2020 7365  '3'}).        se
-0000c390: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
-0000c3a0: 6172 6e65 7373 2e63 6861 726d 2e67 6574  arness.charm.get
-0000c3b0: 5f63 6861 6e67 6573 2872 6573 6574 3d54  _changes(reset=T
-0000c3c0: 7275 6529 2c20 5b5d 290a 2020 2020 2020  rue), []).      
-0000c3d0: 2020 6861 726e 6573 732e 656e 6162 6c65    harness.enable
-0000c3e0: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
-0000c3f0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000c400: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
-0000c410: 2027 666f 7572 7468 277d 290a 2020 2020   'fourth'}).    
-0000c420: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000c430: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-0000c440: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
-0000c450: 6765 745f 6368 616e 6765 7328 7265 7365  get_changes(rese
-0000c460: 743d 5472 7565 292c 0a20 2020 2020 2020  t=True),.       
-0000c470: 2020 2020 205b 7b27 6e61 6d65 273a 2027       [{'name': '
-0000c480: 636f 6e66 6967 2d63 6861 6e67 6564 272c  config-changed',
-0000c490: 2027 6461 7461 273a 207b 2776 616c 7565   'data': {'value
-0000c4a0: 273a 2027 666f 7572 7468 272c 2027 7468  ': 'fourth', 'th
-0000c4b0: 6972 6427 3a20 2733 277d 7d5d 290a 0a20  ird': '3'}}]).. 
-0000c4c0: 2020 2064 6566 2074 6573 745f 686f 6f6b     def test_hook
-0000c4d0: 735f 6469 7361 626c 6564 5f63 6f6e 7465  s_disabled_conte
-0000c4e0: 7874 6d61 6e61 6765 7228 7365 6c66 293a  xtmanager(self):
-0000c4f0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000c500: 203d 2048 6172 6e65 7373 2852 6563 6f72   = Harness(Recor
-0000c510: 6469 6e67 4368 6172 6d2c 206d 6574 613d  dingCharm, meta=
-0000c520: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0000c530: 2020 2020 6e61 6d65 3a20 7465 7374 2d63      name: test-c
-0000c540: 6861 726d 0a20 2020 2020 2020 2020 2020  harm.           
-0000c550: 2020 2020 2027 2727 2c20 636f 6e66 6967       ''', config
-0000c560: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-0000c570: 2020 2020 206f 7074 696f 6e73 3a0a 2020       options:.  
-0000c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c590: 2020 7661 6c75 653a 0a20 2020 2020 2020    value:.       
-0000c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5b0: 2074 7970 653a 2073 7472 696e 670a 2020   type: string.  
-0000c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5d0: 2020 7468 6972 643a 0a20 2020 2020 2020    third:.       
-0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5f0: 2074 7970 653a 2073 7472 696e 670a 2020   type: string.  
-0000c600: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-0000c610: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0000c620: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0000c630: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-0000c640: 2320 4265 666f 7265 2062 6567 696e 2829  # Before begin()
-0000c650: 2074 6865 7265 2061 7265 206e 6f20 6576   there are no ev
-0000c660: 656e 7473 2e0a 2020 2020 2020 2020 6861  ents..        ha
-0000c670: 726e 6573 732e 7570 6461 7465 5f63 6f6e  rness.update_con
-0000c680: 6669 6728 7b27 7661 6c75 6527 3a20 2766  fig({'value': 'f
-0000c690: 6972 7374 277d 290a 2020 2020 2020 2020  irst'}).        
-0000c6a0: 2320 4279 2064 6566 6175 6c74 2c20 6166  # By default, af
-0000c6b0: 7465 7220 6265 6769 6e20 7468 6520 6368  ter begin the ch
-0000c6c0: 6172 6d20 6973 2073 6574 2075 7020 746f  arm is set up to
-0000c6d0: 2072 6563 6569 7665 2065 7665 6e74 732e   receive events.
-0000c6e0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000c6f0: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0000c700: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000c710: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
-0000c720: 2027 7365 636f 6e64 277d 290a 2020 2020   'second'}).    
-0000c730: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000c740: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-0000c750: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
-0000c760: 6765 745f 6368 616e 6765 7328 7265 7365  get_changes(rese
-0000c770: 743d 5472 7565 292c 0a20 2020 2020 2020  t=True),.       
-0000c780: 2020 2020 205b 7b27 6e61 6d65 273a 2027       [{'name': '
-0000c790: 636f 6e66 6967 2d63 6861 6e67 6564 272c  config-changed',
-0000c7a0: 2027 6461 7461 273a 207b 2776 616c 7565   'data': {'value
-0000c7b0: 273a 2027 7365 636f 6e64 277d 7d5d 290a  ': 'second'}}]).
-0000c7c0: 2020 2020 2020 2020 2320 4f6e 6365 2064          # Once d
-0000c7d0: 6973 6162 6c65 642c 2077 6520 776f 6e27  isabled, we won'
-0000c7e0: 7420 7365 6520 636f 6e66 6967 2d63 6861  t see config-cha
-0000c7f0: 6e67 6564 2077 6865 6e20 7765 206d 616b  nged when we mak
-0000c800: 6520 616e 2075 7064 6174 650a 2020 2020  e an update.    
-0000c810: 2020 2020 7769 7468 2068 6172 6e65 7373      with harness
-0000c820: 2e68 6f6f 6b73 5f64 6973 6162 6c65 6428  .hooks_disabled(
-0000c830: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-0000c840: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
-0000c850: 6e66 6967 287b 2774 6869 7264 273a 2027  nfig({'third': '
-0000c860: 3327 7d29 0a20 2020 2020 2020 2073 656c  3'}).        sel
-0000c870: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
-0000c880: 726e 6573 732e 6368 6172 6d2e 6765 745f  rness.charm.get_
-0000c890: 6368 616e 6765 7328 7265 7365 743d 5472  changes(reset=Tr
-0000c8a0: 7565 292c 205b 5d29 0a20 2020 2020 2020  ue), []).       
-0000c8b0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-0000c8c0: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
-0000c8d0: 2027 666f 7572 7468 277d 290a 2020 2020   'fourth'}).    
-0000c8e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000c8f0: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-0000c900: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
-0000c910: 6765 745f 6368 616e 6765 7328 7265 7365  get_changes(rese
-0000c920: 743d 5472 7565 292c 0a20 2020 2020 2020  t=True),.       
-0000c930: 2020 2020 205b 7b27 6e61 6d65 273a 2027       [{'name': '
-0000c940: 636f 6e66 6967 2d63 6861 6e67 6564 272c  config-changed',
-0000c950: 2027 6461 7461 273a 207b 2776 616c 7565   'data': {'value
-0000c960: 273a 2027 666f 7572 7468 272c 2027 7468  ': 'fourth', 'th
-0000c970: 6972 6427 3a20 2733 277d 7d5d 290a 0a20  ird': '3'}}]).. 
-0000c980: 2020 2064 6566 2074 6573 745f 686f 6f6b     def test_hook
-0000c990: 735f 6469 7361 626c 6564 5f6e 6573 7465  s_disabled_neste
-0000c9a0: 645f 636f 6e74 6578 746d 616e 6167 6572  d_contextmanager
-0000c9b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000c9c0: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-0000c9d0: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
-0000c9e0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0000c9f0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000ca00: 2074 6573 742d 6368 6172 6d0a 2020 2020   test-charm.    
-0000ca10: 2020 2020 2020 2020 2727 272c 2063 6f6e          ''', con
-0000ca20: 6669 673d 2727 270a 2020 2020 2020 2020  fig='''.        
-0000ca30: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
-0000ca40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ca50: 2020 2020 2066 6966 7468 3a0a 2020 2020       fifth:.    
-0000ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca70: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
-0000ca80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ca90: 2020 2020 2073 6978 7468 3a0a 2020 2020       sixth:.    
-0000caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cab0: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
-0000cac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cad0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-0000cae0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-0000caf0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-0000cb00: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
-0000cb10: 6567 696e 2829 0a20 2020 2020 2020 2023  egin().        #
-0000cb20: 2043 6f6e 7465 7874 206d 616e 6167 6572   Context manager
-0000cb30: 2063 616e 2062 6520 6e65 7374 6564 2c20   can be nested, 
-0000cb40: 736f 2061 2074 6573 7420 7573 696e 6720  so a test using 
-0000cb50: 6974 2063 616e 2069 6e76 6f6b 6520 6120  it can invoke a 
-0000cb60: 6865 6c70 6572 2075 7369 6e67 2069 742e  helper using it.
-0000cb70: 0a20 2020 2020 2020 2077 6974 6820 6861  .        with ha
-0000cb80: 726e 6573 732e 686f 6f6b 735f 6469 7361  rness.hooks_disa
-0000cb90: 626c 6564 2829 3a0a 2020 2020 2020 2020  bled():.        
-0000cba0: 2020 2020 7769 7468 2068 6172 6e65 7373      with harness
-0000cbb0: 2e68 6f6f 6b73 5f64 6973 6162 6c65 6428  .hooks_disabled(
-0000cbc0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000cbd0: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-0000cbe0: 655f 636f 6e66 6967 287b 2766 6966 7468  e_config({'fifth
-0000cbf0: 273a 2027 3527 7d29 0a20 2020 2020 2020  ': '5'}).       
-0000cc00: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-0000cc10: 6174 655f 636f 6e66 6967 287b 2773 6978  ate_config({'six
-0000cc20: 7468 273a 2027 3627 7d29 0a20 2020 2020  th': '6'}).     
-0000cc30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000cc40: 7561 6c28 6861 726e 6573 732e 6368 6172  ual(harness.char
-0000cc50: 6d2e 6765 745f 6368 616e 6765 7328 7265  m.get_changes(re
-0000cc60: 7365 743d 5472 7565 292c 205b 5d29 0a0a  set=True), [])..
-0000cc70: 2020 2020 6465 6620 7465 7374 5f68 6f6f      def test_hoo
-0000cc80: 6b73 5f64 6973 6162 6c65 645f 6e6f 6f70  ks_disabled_noop
-0000cc90: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000cca0: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-0000ccb0: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
-0000ccc0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0000ccd0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000cce0: 2074 6573 742d 6368 6172 6d0a 2020 2020   test-charm.    
-0000ccf0: 2020 2020 2020 2020 2727 272c 2063 6f6e          ''', con
-0000cd00: 6669 673d 2727 270a 2020 2020 2020 2020  fig='''.        
-0000cd10: 2020 2020 6f70 7469 6f6e 733a 0a20 2020      options:.   
-0000cd20: 2020 2020 2020 2020 2020 2020 2073 6576               sev
-0000cd30: 656e 7468 3a0a 2020 2020 2020 2020 2020  enth:.          
-0000cd40: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
-0000cd50: 7374 7269 6e67 0a20 2020 2020 2020 2020  string.         
-0000cd60: 2020 2020 2020 2065 6967 6874 683a 0a20         eighth:. 
-0000cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd80: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
-0000cd90: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-0000cda0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0000cdb0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-0000cdc0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-0000cdd0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-0000cde0: 290a 2020 2020 2020 2020 2320 4966 2068  ).        # If h
-0000cdf0: 6f6f 6b73 2061 7265 2061 6c72 6561 6479  ooks are already
-0000ce00: 2064 6973 6162 6c65 642c 2069 7420 6973   disabled, it is
-0000ce10: 2061 206e 6f20 6f70 2c20 616e 6420 6f6e   a no op, and on
-0000ce20: 2065 7869 7420 686f 6f6b 7320 7265 6d61   exit hooks rema
-0000ce30: 696e 2064 6973 6162 6c65 642e 0a20 2020  in disabled..   
-0000ce40: 2020 2020 2068 6172 6e65 7373 2e64 6973       harness.dis
-0000ce50: 6162 6c65 5f68 6f6f 6b73 2829 0a20 2020  able_hooks().   
-0000ce60: 2020 2020 2077 6974 6820 6861 726e 6573       with harnes
-0000ce70: 732e 686f 6f6b 735f 6469 7361 626c 6564  s.hooks_disabled
-0000ce80: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000ce90: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
-0000cea0: 6f6e 6669 6728 7b27 7365 7665 6e74 6827  onfig({'seventh'
-0000ceb0: 3a20 2737 277d 290a 2020 2020 2020 2020  : '7'}).        
-0000cec0: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
-0000ced0: 6f6e 6669 6728 7b27 6569 6768 7468 273a  onfig({'eighth':
-0000cee0: 2027 3827 7d29 0a20 2020 2020 2020 2073   '8'}).        s
-0000cef0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000cf00: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
-0000cf10: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
-0000cf20: 5472 7565 292c 205b 5d29 0a0a 2020 2020  True), [])..    
-0000cf30: 6465 6620 7465 7374 5f6d 6574 6164 6174  def test_metadat
-0000cf40: 615f 6672 6f6d 5f64 6972 6563 746f 7279  a_from_directory
-0000cf50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000cf60: 746d 7020 3d20 7061 7468 6c69 622e 5061  tmp = pathlib.Pa
-0000cf70: 7468 2874 656d 7066 696c 652e 6d6b 6474  th(tempfile.mkdt
-0000cf80: 656d 7028 2929 0a20 2020 2020 2020 2073  emp()).        s
-0000cf90: 656c 662e 6164 6443 6c65 616e 7570 2873  elf.addCleanup(s
-0000cfa0: 6875 7469 6c2e 726d 7472 6565 2c20 7374  hutil.rmtree, st
-0000cfb0: 7228 746d 7029 290a 2020 2020 2020 2020  r(tmp)).        
-0000cfc0: 6d65 7461 6461 7461 5f66 696c 656e 616d  metadata_filenam
-0000cfd0: 6520 3d20 746d 7020 2f20 276d 6574 6164  e = tmp / 'metad
-0000cfe0: 6174 612e 7961 6d6c 270a 2020 2020 2020  ata.yaml'.      
-0000cff0: 2020 7769 7468 206d 6574 6164 6174 615f    with metadata_
-0000d000: 6669 6c65 6e61 6d65 2e6f 7065 6e28 2777  filename.open('w
-0000d010: 7427 2920 6173 206d 6574 6164 6174 613a  t') as metadata:
-0000d020: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
-0000d030: 6164 6174 612e 7772 6974 6528 7465 7874  adata.write(text
-0000d040: 7772 6170 2e64 6564 656e 7428 2727 270a  wrap.dedent('''.
-0000d050: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000d060: 3a20 6d79 2d63 6861 726d 0a20 2020 2020  : my-charm.     
-0000d070: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-0000d080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d090: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-0000d0a0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-0000d0b0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-0000d0c0: 2020 2020 2020 2727 2729 290a 2020 2020        ''')).    
-0000d0d0: 2020 2020 6861 726e 6573 7320 3d20 7365      harness = se
-0000d0e0: 6c66 2e5f 6765 745f 6475 6d6d 795f 6368  lf._get_dummy_ch
-0000d0f0: 6172 6d5f 6861 726e 6573 7328 746d 7029  arm_harness(tmp)
-0000d100: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000d110: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-0000d120: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000d130: 6c28 6c69 7374 2868 6172 6e65 7373 2e6d  l(list(harness.m
-0000d140: 6f64 656c 2e72 656c 6174 696f 6e73 292c  odel.relations),
-0000d150: 205b 2764 6227 5d29 0a20 2020 2020 2020   ['db']).       
-0000d160: 2023 2054 6865 2063 6861 726d 5f64 6972   # The charm_dir
-0000d170: 2061 6c73 6f20 6765 7473 2073 6574 0a20   also gets set. 
-0000d180: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d190: 7274 4571 7561 6c28 6861 726e 6573 732e  rtEqual(harness.
-0000d1a0: 6672 616d 6577 6f72 6b2e 6368 6172 6d5f  framework.charm_
-0000d1b0: 6469 722c 2074 6d70 290a 0a20 2020 2064  dir, tmp)..    d
-0000d1c0: 6566 2074 6573 745f 636f 6e66 6967 5f66  ef test_config_f
-0000d1d0: 726f 6d5f 6469 7265 6374 6f72 7928 7365  rom_directory(se
-0000d1e0: 6c66 293a 0a20 2020 2020 2020 2074 6d70  lf):.        tmp
-0000d1f0: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-0000d200: 7465 6d70 6669 6c65 2e6d 6b64 7465 6d70  tempfile.mkdtemp
-0000d210: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
-0000d220: 2e61 6464 436c 6561 6e75 7028 7368 7574  .addCleanup(shut
-0000d230: 696c 2e72 6d74 7265 652c 2073 7472 2874  il.rmtree, str(t
-0000d240: 6d70 2929 0a20 2020 2020 2020 2063 6f6e  mp)).        con
-0000d250: 6669 675f 6669 6c65 6e61 6d65 203d 2074  fig_filename = t
-0000d260: 6d70 202f 2027 636f 6e66 6967 2e79 616d  mp / 'config.yam
-0000d270: 6c27 0a20 2020 2020 2020 2077 6974 6820  l'.        with 
-0000d280: 636f 6e66 6967 5f66 696c 656e 616d 652e  config_filename.
-0000d290: 6f70 656e 2827 7774 2729 2061 7320 636f  open('wt') as co
-0000d2a0: 6e66 6967 3a0a 2020 2020 2020 2020 2020  nfig:.          
-0000d2b0: 2020 636f 6e66 6967 2e77 7269 7465 2874    config.write(t
-0000d2c0: 6578 7477 7261 702e 6465 6465 6e74 2827  extwrap.dedent('
-0000d2d0: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
-0000d2e0: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-0000d2f0: 2020 2020 2020 2020 6f70 745f 7374 723a          opt_str:
-0000d300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d310: 2020 2020 2074 7970 653a 2073 7472 696e       type: strin
-0000d320: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0000d330: 2020 2020 2020 6465 6661 756c 743a 2022        default: "
-0000d340: 7661 6c22 0a20 2020 2020 2020 2020 2020  val".           
-0000d350: 2020 2020 206f 7074 5f73 7472 5f65 6d70       opt_str_emp
-0000d360: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-0000d370: 2020 2020 2020 2020 7479 7065 3a20 7374          type: st
-0000d380: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
-0000d390: 2020 2020 2020 2020 2064 6566 6175 6c74           default
-0000d3a0: 3a20 2222 0a20 2020 2020 2020 2020 2020  : "".           
-0000d3b0: 2020 2020 206f 7074 5f6e 756c 6c3a 0a20       opt_null:. 
-0000d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3d0: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
-0000d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3f0: 2020 2020 6465 6661 756c 743a 206e 756c      default: nul
-0000d400: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-0000d410: 2020 6f70 745f 626f 6f6c 3a0a 2020 2020    opt_bool:.    
-0000d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d430: 7479 7065 3a20 626f 6f6c 6561 6e0a 2020  type: boolean.  
-0000d440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d450: 2020 6465 6661 756c 743a 2074 7275 650a    default: true.
-0000d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d470: 6f70 745f 696e 743a 0a20 2020 2020 2020  opt_int:.       
-0000d480: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-0000d490: 653a 2069 6e74 0a20 2020 2020 2020 2020  e: int.         
-0000d4a0: 2020 2020 2020 2020 2020 2064 6566 6175             defau
-0000d4b0: 6c74 3a20 310a 2020 2020 2020 2020 2020  lt: 1.          
-0000d4c0: 2020 2020 2020 6f70 745f 666c 6f61 743a        opt_float:
-0000d4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d4e0: 2020 2020 2074 7970 653a 2066 6c6f 6174       type: float
-0000d4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d500: 2020 2020 2064 6566 6175 6c74 3a20 312e       default: 1.
-0000d510: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-0000d520: 2020 6f70 745f 6e6f 5f64 6566 6175 6c74    opt_no_default
-0000d530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d540: 2020 2020 2020 7479 7065 3a20 7374 7269        type: stri
-0000d550: 6e67 0a20 2020 2020 2020 2020 2020 2027  ng.            '
-0000d560: 2727 2929 0a20 2020 2020 2020 2068 6172  '')).        har
-0000d570: 6e65 7373 203d 2073 656c 662e 5f67 6574  ness = self._get
-0000d580: 5f64 756d 6d79 5f63 6861 726d 5f68 6172  _dummy_charm_har
-0000d590: 6e65 7373 2874 6d70 290a 2020 2020 2020  ness(tmp).      
-0000d5a0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000d5b0: 616c 2868 6172 6e65 7373 2e6d 6f64 656c  al(harness.model
-0000d5c0: 2e63 6f6e 6669 675b 276f 7074 5f73 7472  .config['opt_str
-0000d5d0: 275d 2c20 2776 616c 2729 0a20 2020 2020  '], 'val').     
-0000d5e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000d5f0: 7561 6c28 6861 726e 6573 732e 6d6f 6465  ual(harness.mode
-0000d600: 6c2e 636f 6e66 6967 5b27 6f70 745f 7374  l.config['opt_st
-0000d610: 725f 656d 7074 7927 5d2c 2027 2729 0a20  r_empty'], ''). 
-0000d620: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d630: 7274 4973 2868 6172 6e65 7373 2e6d 6f64  rtIs(harness.mod
-0000d640: 656c 2e63 6f6e 6669 675b 276f 7074 5f62  el.config['opt_b
-0000d650: 6f6f 6c27 5d2c 2054 7275 6529 0a20 2020  ool'], True).   
-0000d660: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0000d670: 4571 7561 6c28 6861 726e 6573 732e 6d6f  Equal(harness.mo
-0000d680: 6465 6c2e 636f 6e66 6967 5b27 6f70 745f  del.config['opt_
-0000d690: 696e 7427 5d2c 2031 290a 2020 2020 2020  int'], 1).      
-0000d6a0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0000d6b0: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
-0000d6c0: 6d6f 6465 6c2e 636f 6e66 6967 5b27 6f70  model.config['op
-0000d6d0: 745f 696e 7427 5d2c 2069 6e74 290a 2020  t_int'], int).  
-0000d6e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000d6f0: 7445 7175 616c 2868 6172 6e65 7373 2e6d  tEqual(harness.m
-0000d700: 6f64 656c 2e63 6f6e 6669 675b 276f 7074  odel.config['opt
-0000d710: 5f66 6c6f 6174 275d 2c20 312e 3029 0a20  _float'], 1.0). 
-0000d720: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000d730: 7274 4973 496e 7374 616e 6365 2868 6172  rtIsInstance(har
-0000d740: 6e65 7373 2e6d 6f64 656c 2e63 6f6e 6669  ness.model.confi
-0000d750: 675b 276f 7074 5f66 6c6f 6174 275d 2c20  g['opt_float'], 
-0000d760: 666c 6f61 7429 0a20 2020 2020 2020 2073  float).        s
-0000d770: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-0000d780: 276f 7074 5f6e 756c 6c27 2069 6e20 6861  'opt_null' in ha
-0000d790: 726e 6573 732e 6d6f 6465 6c2e 636f 6e66  rness.model.conf
-0000d7a0: 6967 290a 2020 2020 2020 2020 7365 6c66  ig).        self
-0000d7b0: 2e61 7373 6572 7449 734e 6f6e 6528 6861  .assertIsNone(ha
-0000d7c0: 726e 6573 732e 5f62 6163 6b65 6e64 2e5f  rness._backend._
-0000d7d0: 636f 6e66 6967 2e5f 6465 6661 756c 7473  config._defaults
-0000d7e0: 5b27 6f70 745f 6e75 6c6c 275d 290a 2020  ['opt_null']).  
-0000d7f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000d800: 7449 734e 6f6e 6528 6861 726e 6573 732e  tIsNone(harness.
-0000d810: 5f62 6163 6b65 6e64 2e5f 636f 6e66 6967  _backend._config
-0000d820: 2e5f 6465 6661 756c 7473 5b27 6f70 745f  ._defaults['opt_
-0000d830: 6e6f 5f64 6566 6175 6c74 275d 290a 0a20  no_default']).. 
-0000d840: 2020 2064 6566 2074 6573 745f 7365 745f     def test_set_
-0000d850: 6d6f 6465 6c5f 6e61 6d65 2873 656c 6629  model_name(self)
-0000d860: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-0000d870: 7320 3d20 4861 726e 6573 7328 4368 6172  s = Harness(Char
-0000d880: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-0000d890: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000d8a0: 3a20 7465 7374 2d63 6861 726d 0a20 2020  : test-charm.   
-0000d8b0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0000d8c0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0000d8d0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0000d8e0: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
-0000d8f0: 7373 2e73 6574 5f6d 6f64 656c 5f6e 616d  ss.set_model_nam
-0000d900: 6528 2766 6f6f 2729 0a20 2020 2020 2020  e('foo').       
-0000d910: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0000d920: 6c28 2766 6f6f 272c 2068 6172 6e65 7373  l('foo', harness
-0000d930: 2e6d 6f64 656c 2e6e 616d 6529 0a0a 2020  .model.name)..  
-0000d940: 2020 6465 6620 7465 7374 5f73 6574 5f6d    def test_set_m
-0000d950: 6f64 656c 5f6e 616d 655f 6166 7465 725f  odel_name_after_
-0000d960: 6265 6769 6e28 7365 6c66 293a 0a20 2020  begin(self):.   
-0000d970: 2020 2020 2068 6172 6e65 7373 203d 2048       harness = H
-0000d980: 6172 6e65 7373 2843 6861 726d 4261 7365  arness(CharmBase
-0000d990: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0000d9a0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0000d9b0: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
-0000d9c0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-0000d9d0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0000d9e0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-0000d9f0: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-0000da00: 745f 6d6f 6465 6c5f 6e61 6d65 2827 6261  t_model_name('ba
-0000da10: 7227 290a 2020 2020 2020 2020 6861 726e  r').        harn
-0000da20: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-0000da30: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0000da40: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0000da50: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+000098f0: 6e65 7373 2e63 6861 726d 2e61 7070 5d5b  ness.charm.app][
+00009900: 276e 6577 275d 2c20 2776 616c 7565 2729  'new'], 'value')
+00009910: 0a0a 2020 2020 2020 2020 2320 4f75 7220  ..        # Our 
+00009920: 6170 7020 6461 7461 2062 6167 2067 6f74  app data bag got
+00009930: 2075 7064 6174 6564 2e0a 2020 2020 2020   updated..      
+00009940: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00009950: 616c 2872 656c 2e64 6174 615b 6861 726e  al(rel.data[harn
+00009960: 6573 732e 6368 6172 6d2e 6d6f 6465 6c2e  ess.charm.model.
+00009970: 6170 705d 5b27 6e65 7727 5d2c 2027 7661  app]['new'], 'va
+00009980: 6c75 6527 290a 2020 2020 2020 2020 2320  lue').        # 
+00009990: 4275 7420 7468 6572 6520 7765 7265 206e  But there were n
+000099a0: 6f20 6368 616e 6765 6420 6576 656e 7473  o changed events
+000099b0: 2072 6567 6973 7465 7265 6420 6279 206f   registered by o
+000099c0: 7572 2075 6e69 742e 0a20 2020 2020 2020  ur unit..       
+000099d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000099e0: 6c28 6865 6c70 6572 2e63 6861 6e67 6573  l(helper.changes
+000099f0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+00009a00: 6573 745f 7570 6461 7465 5f72 656c 6174  est_update_relat
+00009a10: 696f 6e5f 7265 6d6f 7665 5f64 6174 6128  ion_remove_data(
+00009a20: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+00009a30: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00009a40: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+00009a50: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+00009a60: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+00009a70: 206e 616d 653a 206d 792d 6368 6172 6d0a   name: my-charm.
+00009a80: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+00009a90: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+00009aa0: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
+00009ab0: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+00009ac0: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
+00009ad0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+00009ae0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00009af0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+00009b00: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
+00009b10: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+00009b20: 2020 2076 6965 7765 7220 3d20 5265 6c61     viewer = Rela
+00009b30: 7469 6f6e 4368 616e 6765 6456 6965 7765  tionChangedViewe
+00009b40: 7228 6861 726e 6573 732e 6368 6172 6d2c  r(harness.charm,
+00009b50: 2027 6462 2729 0a20 2020 2020 2020 2072   'db').        r
+00009b60: 656c 5f69 6420 3d20 6861 726e 6573 732e  el_id = harness.
+00009b70: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+00009b80: 272c 2027 706f 7374 6772 6573 716c 2729  ', 'postgresql')
+00009b90: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00009ba0: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
+00009bb0: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
+00009bc0: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
+00009bd0: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
+00009be0: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
+00009bf0: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
+00009c00: 7371 6c2f 3027 2c20 7b27 696e 6974 6961  sql/0', {'initia
+00009c10: 6c27 3a20 2764 6174 6127 7d29 0a20 2020  l': 'data'}).   
+00009c20: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
+00009c30: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
+00009c40: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
+00009c50: 7265 7371 6c2f 3027 2c20 7b27 696e 6974  resql/0', {'init
+00009c60: 6961 6c27 3a20 2727 7d29 0a20 2020 2020  ial': ''}).     
+00009c70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00009c80: 7561 6c28 7669 6577 6572 2e63 6861 6e67  ual(viewer.chang
+00009c90: 6573 2c20 5b7b 2769 6e69 7469 616c 273a  es, [{'initial':
+00009ca0: 2027 6461 7461 277d 2c20 7b7d 5d29 0a0a   'data'}, {}])..
+00009cb0: 2020 2020 6465 6620 7465 7374 5f6e 6f5f      def test_no_
+00009cc0: 6576 656e 745f 6f6e 5f65 6d70 7479 5f75  event_on_empty_u
+00009cd0: 7064 6174 655f 7265 6c61 7469 6f6e 5f75  pdate_relation_u
+00009ce0: 6e69 745f 6170 7028 7365 6c66 293a 0a20  nit_app(self):. 
+00009cf0: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+00009d00: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00009d10: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+00009d20: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
+00009d30: 2020 2020 2020 2020 206e 616d 653a 206d           name: m
+00009d40: 792d 6368 6172 6d0a 2020 2020 2020 2020  y-charm.        
+00009d50: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+00009d60: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00009d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d80: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+00009d90: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00009da0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009db0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+00009dc0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+00009dd0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00009de0: 2829 0a20 2020 2020 2020 2076 6965 7765  ().        viewe
+00009df0: 7220 3d20 5265 6c61 7469 6f6e 4368 616e  r = RelationChan
+00009e00: 6765 6456 6965 7765 7228 6861 726e 6573  gedViewer(harnes
+00009e10: 732e 6368 6172 6d2c 2027 6462 2729 0a20  s.charm, 'db'). 
+00009e20: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
+00009e30: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+00009e40: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+00009e50: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+00009e60: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+00009e70: 6174 696f 6e5f 756e 6974 2872 656c 5f69  ation_unit(rel_i
+00009e80: 642c 2027 706f 7374 6772 6573 716c 2f30  d, 'postgresql/0
+00009e90: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00009ea0: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
+00009eb0: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
+00009ec0: 2770 6f73 7467 7265 7371 6c27 2c20 7b27  'postgresql', {'
+00009ed0: 696e 6974 6961 6c27 3a20 2764 6174 6127  initial': 'data'
+00009ee0: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
+00009ef0: 7373 2e75 7064 6174 655f 7265 6c61 7469  ss.update_relati
+00009f00: 6f6e 5f64 6174 6128 7265 6c5f 6964 2c20  on_data(rel_id, 
+00009f10: 2770 6f73 7467 7265 7371 6c27 2c20 7b7d  'postgresql', {}
+00009f20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00009f30: 7373 6572 7445 7175 616c 2876 6965 7765  ssertEqual(viewe
+00009f40: 722e 6368 616e 6765 732c 205b 7b27 696e  r.changes, [{'in
+00009f50: 6974 6961 6c27 3a20 2764 6174 6127 7d5d  itial': 'data'}]
+00009f60: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00009f70: 6e6f 5f65 7665 6e74 5f6f 6e5f 6e6f 5f64  no_event_on_no_d
+00009f80: 6966 665f 7570 6461 7465 5f72 656c 6174  iff_update_relat
+00009f90: 696f 6e5f 756e 6974 5f61 7070 2873 656c  ion_unit_app(sel
+00009fa0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00009fb0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00009fc0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00009fd0: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+00009fe0: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00009ff0: 6d65 3a20 6d79 2d63 6861 726d 0a20 2020  me: my-charm.   
+0000a000: 2020 2020 2020 2020 2072 6571 7569 7265           require
+0000a010: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000a020: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+0000a030: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
+0000a040: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
+0000a050: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
+0000a060: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+0000a070: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+0000a080: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000a090: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+0000a0a0: 7669 6577 6572 203d 2052 656c 6174 696f  viewer = Relatio
+0000a0b0: 6e43 6861 6e67 6564 5669 6577 6572 2868  nChangedViewer(h
+0000a0c0: 6172 6e65 7373 2e63 6861 726d 2c20 2764  arness.charm, 'd
+0000a0d0: 6227 290a 2020 2020 2020 2020 7265 6c5f  b').        rel_
+0000a0e0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+0000a0f0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+0000a100: 2770 6f73 7467 7265 7371 6c27 290a 2020  'postgresql').  
+0000a110: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
+0000a120: 645f 7265 6c61 7469 6f6e 5f75 6e69 7428  d_relation_unit(
+0000a130: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
+0000a140: 7371 6c2f 3027 290a 2020 2020 2020 2020  sql/0').        
+0000a150: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
+0000a160: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
+0000a170: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+0000a180: 272c 207b 2769 6e69 7469 616c 273a 2027  ', {'initial': '
+0000a190: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
+0000a1a0: 6861 726e 6573 732e 7570 6461 7465 5f72  harness.update_r
+0000a1b0: 656c 6174 696f 6e5f 6461 7461 2872 656c  elation_data(rel
+0000a1c0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+0000a1d0: 272c 207b 2769 6e69 7469 616c 273a 2027  ', {'initial': '
+0000a1e0: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
+0000a1f0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000a200: 2876 6965 7765 722e 6368 616e 6765 732c  (viewer.changes,
+0000a210: 205b 7b27 696e 6974 6961 6c27 3a20 2764   [{'initial': 'd
+0000a220: 6174 6127 7d5d 290a 0a20 2020 2064 6566  ata'}])..    def
+0000a230: 2074 6573 745f 6e6f 5f65 7665 6e74 5f6f   test_no_event_o
+0000a240: 6e5f 656d 7074 795f 7570 6461 7465 5f72  n_empty_update_r
+0000a250: 656c 6174 696f 6e5f 756e 6974 5f62 6167  elation_unit_bag
+0000a260: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000a270: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000a280: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0000a290: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0000a2a0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000a2b0: 2020 6e61 6d65 3a20 6d79 2d63 6861 726d    name: my-charm
+0000a2c0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+0000a2d0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+0000a2e0: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
+0000a2f0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+0000a300: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+0000a310: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+0000a320: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0000a330: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+0000a340: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+0000a350: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0000a360: 2020 2020 7669 6577 6572 203d 2052 656c      viewer = Rel
+0000a370: 6174 696f 6e43 6861 6e67 6564 5669 6577  ationChangedView
+0000a380: 6572 2868 6172 6e65 7373 2e63 6861 726d  er(harness.charm
+0000a390: 2c20 2764 6227 290a 2020 2020 2020 2020  , 'db').        
+0000a3a0: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+0000a3b0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+0000a3c0: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+0000a3d0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0000a3e0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+0000a3f0: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
+0000a400: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
+0000a410: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000a420: 7465 5f72 656c 6174 696f 6e5f 6461 7461  te_relation_data
+0000a430: 2872 656c 5f69 642c 2027 706f 7374 6772  (rel_id, 'postgr
+0000a440: 6573 716c 2f30 272c 207b 2769 6e69 7469  esql/0', {'initi
+0000a450: 616c 273a 2027 6461 7461 277d 290a 2020  al': 'data'}).  
+0000a460: 2020 2020 2020 6861 726e 6573 732e 7570        harness.up
+0000a470: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+0000a480: 7461 2872 656c 5f69 642c 2027 706f 7374  ta(rel_id, 'post
+0000a490: 6772 6573 716c 2f30 272c 207b 7d29 0a20  gresql/0', {}). 
+0000a4a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000a4b0: 7274 4571 7561 6c28 7669 6577 6572 2e63  rtEqual(viewer.c
+0000a4c0: 6861 6e67 6573 2c20 5b7b 2769 6e69 7469  hanges, [{'initi
+0000a4d0: 616c 273a 2027 6461 7461 277d 5d29 0a0a  al': 'data'}])..
+0000a4e0: 2020 2020 6465 6620 7465 7374 5f6e 6f5f      def test_no_
+0000a4f0: 6576 656e 745f 6f6e 5f6e 6f5f 6469 6666  event_on_no_diff
+0000a500: 5f75 7064 6174 655f 7265 6c61 7469 6f6e  _update_relation
+0000a510: 5f75 6e69 745f 6261 6728 7365 6c66 293a  _unit_bag(self):
+0000a520: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000a530: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+0000a540: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+0000a550: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+0000a560: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+0000a570: 206d 792d 6368 6172 6d0a 2020 2020 2020   my-charm.      
+0000a580: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
+0000a590: 2020 2020 2020 2020 2020 2020 2020 6462                db
+0000a5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a5b0: 2020 696e 7465 7266 6163 653a 2070 6773    interface: pgs
+0000a5c0: 716c 0a20 2020 2020 2020 2020 2020 2027  ql.            '
+0000a5d0: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0000a5e0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0000a5f0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+0000a600: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
+0000a610: 696e 2829 0a20 2020 2020 2020 2076 6965  in().        vie
+0000a620: 7765 7220 3d20 5265 6c61 7469 6f6e 4368  wer = RelationCh
+0000a630: 616e 6765 6456 6965 7765 7228 6861 726e  angedViewer(harn
+0000a640: 6573 732e 6368 6172 6d2c 2027 6462 2729  ess.charm, 'db')
+0000a650: 0a20 2020 2020 2020 2072 656c 5f69 6420  .        rel_id 
+0000a660: 3d20 6861 726e 6573 732e 6164 645f 7265  = harness.add_re
+0000a670: 6c61 7469 6f6e 2827 6462 272c 2027 706f  lation('db', 'po
+0000a680: 7374 6772 6573 716c 2729 0a20 2020 2020  stgresql').     
+0000a690: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+0000a6a0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+0000a6b0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
+0000a6c0: 2f30 2729 0a20 2020 2020 2020 2068 6172  /0').        har
+0000a6d0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
+0000a6e0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+0000a6f0: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
+0000a700: 2c20 7b27 696e 6974 6961 6c27 3a20 2764  , {'initial': 'd
+0000a710: 6174 6127 7d29 0a20 2020 2020 2020 2068  ata'}).        h
+0000a720: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+0000a730: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+0000a740: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
+0000a750: 3027 2c20 7b27 696e 6974 6961 6c27 3a20  0', {'initial': 
+0000a760: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
+0000a770: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000a780: 6c28 7669 6577 6572 2e63 6861 6e67 6573  l(viewer.changes
+0000a790: 2c20 5b7b 2769 6e69 7469 616c 273a 2027  , [{'initial': '
+0000a7a0: 6461 7461 277d 5d29 0a0a 2020 2020 6465  data'}])..    de
+0000a7b0: 6620 7465 7374 5f65 6d70 7479 5f63 6f6e  f test_empty_con
+0000a7c0: 6669 675f 7261 6973 6573 2873 656c 6629  fig_raises(self)
+0000a7d0: 3a0a 2020 2020 2020 2020 7769 7468 2073  :.        with s
+0000a7e0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0000a7f0: 2854 7970 6545 7272 6f72 293a 0a20 2020  (TypeError):.   
+0000a800: 2020 2020 2020 2020 206f 7073 2e74 6573           ops.tes
+0000a810: 7469 6e67 2e48 6172 6e65 7373 2852 6563  ting.Harness(Rec
+0000a820: 6f72 6469 6e67 4368 6172 6d2c 2063 6f6e  ordingCharm, con
+0000a830: 6669 673d 2727 290a 0a20 2020 2064 6566  fig='')..    def
+0000a840: 2074 6573 745f 7570 6461 7465 5f63 6f6e   test_update_con
+0000a850: 6669 6728 7365 6c66 293a 0a20 2020 2020  fig(self):.     
+0000a860: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0000a870: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0000a880: 2852 6563 6f72 6469 6e67 4368 6172 6d2c  (RecordingCharm,
+0000a890: 2063 6f6e 6669 673d 2727 270a 2020 2020   config='''.    
+0000a8a0: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
+0000a8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a8c0: 2061 3a0a 2020 2020 2020 2020 2020 2020   a:.            
+0000a8d0: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+0000a8e0: 696f 6e3a 2061 2063 6f6e 6669 6720 6f70  ion: a config op
+0000a8f0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+0000a900: 2020 2020 2020 2020 2074 7970 653a 2073           type: s
+0000a910: 7472 696e 670a 2020 2020 2020 2020 2020  tring.          
+0000a920: 2020 2020 2020 623a 0a20 2020 2020 2020        b:.       
+0000a930: 2020 2020 2020 2020 2020 2020 2064 6573               des
+0000a940: 6372 6970 7469 6f6e 3a20 616e 6f74 6865  cription: anothe
+0000a950: 7220 636f 6e66 6967 206f 7074 696f 6e0a  r config option.
+0000a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a970: 2020 2020 7479 7065 3a20 696e 740a 2020      type: int.  
+0000a980: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+0000a990: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000a9a0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0000a9b0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0000a9c0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+0000a9d0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000a9e0: 7570 6461 7465 5f63 6f6e 6669 6728 6b65  update_config(ke
+0000a9f0: 795f 7661 6c75 6573 3d7b 2761 273a 2027  y_values={'a': '
+0000aa00: 666f 6f27 2c20 2762 273a 2032 7d29 0a20  foo', 'b': 2}). 
+0000aa10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000aa20: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000aa30: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000aa40: 726d 2e63 6861 6e67 6573 2c0a 2020 2020  rm.changes,.    
+0000aa50: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000aa60: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000aa70: 6427 2c20 2764 6174 6127 3a20 7b27 6127  d', 'data': {'a'
+0000aa80: 3a20 2766 6f6f 272c 2027 6227 3a20 327d  : 'foo', 'b': 2}
+0000aa90: 7d5d 290a 2020 2020 2020 2020 6861 726e  }]).        harn
+0000aaa0: 6573 732e 7570 6461 7465 5f63 6f6e 6669  ess.update_confi
+0000aab0: 6728 6b65 795f 7661 6c75 6573 3d7b 2762  g(key_values={'b
+0000aac0: 273a 2033 7d29 0a20 2020 2020 2020 2073  ': 3}).        s
+0000aad0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000aae0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0000aaf0: 6e65 7373 2e63 6861 726d 2e63 6861 6e67  ness.charm.chang
+0000ab00: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000ab10: 5b7b 276e 616d 6527 3a20 2763 6f6e 6669  [{'name': 'confi
+0000ab20: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
+0000ab30: 6127 3a20 7b27 6127 3a20 2766 6f6f 272c  a': {'a': 'foo',
+0000ab40: 2027 6227 3a20 327d 7d2c 0a20 2020 2020   'b': 2}},.     
+0000ab50: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+0000ab60: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
+0000ab70: 272c 2027 6461 7461 273a 207b 2761 273a  ', 'data': {'a':
+0000ab80: 2027 666f 6f27 2c20 2762 273a 2033 7d7d   'foo', 'b': 3}}
+0000ab90: 5d29 0a20 2020 2020 2020 2023 2079 6f75  ]).        # you
+0000aba0: 2063 616e 2073 6574 2063 6f6e 6669 6720   can set config 
+0000abb0: 7661 6c75 6573 2074 6f20 7468 6520 656d  values to the em
+0000abc0: 7074 7920 7374 7269 6e67 2c20 796f 7520  pty string, you 
+0000abd0: 6361 6e20 7573 6520 756e 7365 7420 746f  can use unset to
+0000abe0: 2061 6374 7561 6c6c 7920 7265 6d6f 7665   actually remove
+0000abf0: 2069 7465 6d73 0a20 2020 2020 2020 2068   items.        h
+0000ac00: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
+0000ac10: 6e66 6967 286b 6579 5f76 616c 7565 733d  nfig(key_values=
+0000ac20: 7b27 6127 3a20 2727 7d2c 2075 6e73 6574  {'a': ''}, unset
+0000ac30: 3d73 6574 2827 6227 2929 0a20 2020 2020  =set('b')).     
+0000ac40: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ac50: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+0000ac60: 2068 6172 6e65 7373 2e63 6861 726d 2e63   harness.charm.c
+0000ac70: 6861 6e67 6573 2c0a 2020 2020 2020 2020  hanges,.        
+0000ac80: 2020 2020 5b7b 276e 616d 6527 3a20 2763      [{'name': 'c
+0000ac90: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
+0000aca0: 2764 6174 6127 3a20 7b27 6127 3a20 2766  'data': {'a': 'f
+0000acb0: 6f6f 272c 2027 6227 3a20 327d 7d2c 0a20  oo', 'b': 2}},. 
+0000acc0: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+0000acd0: 6d65 273a 2027 636f 6e66 6967 2d63 6861  me': 'config-cha
+0000ace0: 6e67 6564 272c 2027 6461 7461 273a 207b  nged', 'data': {
+0000acf0: 2761 273a 2027 666f 6f27 2c20 2762 273a  'a': 'foo', 'b':
+0000ad00: 2033 7d7d 2c0a 2020 2020 2020 2020 2020   3}},.          
+0000ad10: 2020 207b 276e 616d 6527 3a20 2763 6f6e     {'name': 'con
+0000ad20: 6669 672d 6368 616e 6765 6427 2c20 2764  fig-changed', 'd
+0000ad30: 6174 6127 3a20 7b27 6127 3a20 2727 7d7d  ata': {'a': ''}}
+0000ad40: 2c0a 2020 2020 2020 2020 2020 2020 205d  ,.             ]
+0000ad50: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000ad60: 7570 6461 7465 5f63 6f6e 6669 675f 756e  update_config_un
+0000ad70: 6465 6669 6e65 645f 6f70 7469 6f6e 2873  defined_option(s
+0000ad80: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+0000ad90: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+0000ada0: 696e 672e 4861 726e 6573 7328 5265 636f  ing.Harness(Reco
+0000adb0: 7264 696e 6743 6861 726d 290a 2020 2020  rdingCharm).    
+0000adc0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0000add0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0000ade0: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
+0000adf0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+0000ae00: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0000ae10: 7373 6572 7452 6169 7365 7328 5661 6c75  ssertRaises(Valu
+0000ae20: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000ae30: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
+0000ae40: 6174 655f 636f 6e66 6967 286b 6579 5f76  ate_config(key_v
+0000ae50: 616c 7565 733d 7b27 6e6f 6e65 7869 7374  alues={'nonexist
+0000ae60: 656e 7427 3a20 2766 6f6f 277d 290a 0a20  ent': 'foo'}).. 
+0000ae70: 2020 2064 6566 2074 6573 745f 7570 6461     def test_upda
+0000ae80: 7465 5f63 6f6e 6669 675f 6261 645f 7479  te_config_bad_ty
+0000ae90: 7065 2873 656c 6629 3a0a 2020 2020 2020  pe(self):.      
+0000aea0: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+0000aeb0: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+0000aec0: 5265 636f 7264 696e 6743 6861 726d 2c20  RecordingCharm, 
+0000aed0: 636f 6e66 6967 3d27 2727 0a20 2020 2020  config='''.     
+0000aee0: 2020 2020 2020 206f 7074 696f 6e73 3a0a         options:.
+0000aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af00: 613a 0a20 2020 2020 2020 2020 2020 2020  a:.             
+0000af10: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
+0000af20: 6f6e 3a20 6120 636f 6e66 6967 206f 7074  on: a config opt
+0000af30: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0000af40: 2020 2020 2020 2020 7479 7065 3a20 626f          type: bo
+0000af50: 6f6c 6561 6e0a 2020 2020 2020 2020 2020  olean.          
+0000af60: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
+0000af70: 743a 2066 616c 7365 0a20 2020 2020 2020  t: false.       
+0000af80: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+0000af90: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0000afa0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+0000afb0: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
+0000afc0: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+0000afd0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000afe0: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+0000aff0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000b000: 2020 2020 2023 2063 616e 6e6f 7420 6361       # cannot ca
+0000b010: 7374 2074 6f20 626f 6f6c 0a20 2020 2020  st to bool.     
+0000b020: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
+0000b030: 7064 6174 655f 636f 6e66 6967 286b 6579  pdate_config(key
+0000b040: 5f76 616c 7565 733d 7b27 6127 3a20 2766  _values={'a': 'f
+0000b050: 6f6f 277d 290a 0a20 2020 2020 2020 2077  oo'})..        w
+0000b060: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000b070: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
+0000b080: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0000b090: 2023 2063 616e 6e6f 7420 6361 7374 2074   # cannot cast t
+0000b0a0: 6f20 666c 6f61 740a 2020 2020 2020 2020  o float.        
+0000b0b0: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000b0c0: 7465 5f63 6f6e 6669 6728 6b65 795f 7661  te_config(key_va
+0000b0d0: 6c75 6573 3d7b 2761 273a 2034 322e 3432  lues={'a': 42.42
+0000b0e0: 7d29 0a0a 2020 2020 2020 2020 7769 7468  })..        with
+0000b0f0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000b100: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
+0000b110: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0000b120: 6361 6e6e 6f74 2063 6173 7420 746f 2069  cannot cast to i
+0000b130: 6e74 0a20 2020 2020 2020 2020 2020 2068  nt.            h
+0000b140: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
+0000b150: 6e66 6967 286b 6579 5f76 616c 7565 733d  nfig(key_values=
+0000b160: 7b27 6127 3a20 3432 7d29 0a0a 2020 2020  {'a': 42})..    
+0000b170: 2020 2020 2320 6361 6e20 6361 7374 2074      # can cast t
+0000b180: 6f20 626f 6f6c 210a 2020 2020 2020 2020  o bool!.        
+0000b190: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
+0000b1a0: 6f6e 6669 6728 6b65 795f 7661 6c75 6573  onfig(key_values
+0000b1b0: 3d7b 2761 273a 2046 616c 7365 7d29 0a0a  ={'a': False})..
+0000b1c0: 2020 2020 6465 6620 7465 7374 5f62 6164      def test_bad
+0000b1d0: 5f63 6f6e 6669 675f 6f70 7469 6f6e 5f74  _config_option_t
+0000b1e0: 7970 6528 7365 6c66 293a 0a20 2020 2020  ype(self):.     
+0000b1f0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000b200: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+0000b210: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000b220: 2020 2020 206f 7073 2e74 6573 7469 6e67       ops.testing
+0000b230: 2e48 6172 6e65 7373 2852 6563 6f72 6469  .Harness(Recordi
+0000b240: 6e67 4368 6172 6d2c 2063 6f6e 6669 673d  ngCharm, config=
+0000b250: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+0000b260: 2020 2020 6f70 7469 6f6e 733a 0a20 2020      options:.   
+0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b280: 2061 3a0a 2020 2020 2020 2020 2020 2020   a:.            
+0000b290: 2020 2020 2020 2020 2020 2020 6465 7363              desc
+0000b2a0: 7269 7074 696f 6e3a 2061 2063 6f6e 6669  ription: a confi
+0000b2b0: 6720 6f70 7469 6f6e 0a20 2020 2020 2020  g option.       
+0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2d0: 2074 7970 653a 2067 6962 6265 7269 7368   type: gibberish
+0000b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b2f0: 2020 2020 2020 2020 2064 6566 6175 6c74           default
+0000b300: 3a20 4661 6c73 650a 2020 2020 2020 2020  : False.        
+0000b310: 2020 2020 2020 2020 2727 2729 0a0a 2020          ''')..  
+0000b320: 2020 6465 6620 7465 7374 5f6e 6f5f 636f    def test_no_co
+0000b330: 6e66 6967 5f6f 7074 696f 6e5f 7479 7065  nfig_option_type
+0000b340: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000b350: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0000b360: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
+0000b370: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000b380: 2020 6f70 732e 7465 7374 696e 672e 4861    ops.testing.Ha
+0000b390: 726e 6573 7328 5265 636f 7264 696e 6743  rness(RecordingC
+0000b3a0: 6861 726d 2c20 636f 6e66 6967 3d27 2727  harm, config='''
+0000b3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b3c0: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
+0000b3d0: 2020 2020 2020 2020 2020 2020 2020 613a                a:
+0000b3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b3f0: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+0000b400: 7469 6f6e 3a20 6120 636f 6e66 6967 206f  tion: a config o
+0000b410: 7074 696f 6e0a 2020 2020 2020 2020 2020  ption.          
+0000b420: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0000b430: 6661 756c 743a 2046 616c 7365 0a20 2020  fault: False.   
+0000b440: 2020 2020 2020 2020 2020 2020 2027 2727               '''
+0000b450: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000b460: 756e 6361 7374 6162 6c65 5f63 6f6e 6669  uncastable_confi
+0000b470: 675f 6f70 7469 6f6e 5f74 7970 6528 7365  g_option_type(se
+0000b480: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
+0000b490: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0000b4a0: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
+0000b4b0: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
+0000b4c0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0000b4d0: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
+0000b4e0: 6d2c 2063 6f6e 6669 673d 2727 270a 2020  m, config='''.  
+0000b4f0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0000b500: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+0000b510: 2020 2020 2020 2020 2020 2061 3a0a 2020             a:.  
+0000b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b530: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
+0000b540: 6e3a 2061 2063 6f6e 6669 6720 6f70 7469  n: a config opti
+0000b550: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+0000b560: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+0000b570: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
+0000b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b590: 2064 6566 6175 6c74 3a20 7065 656b 2d61   default: peek-a
+0000b5a0: 2d62 6f6f 6c21 0a20 2020 2020 2020 2020  -bool!.         
+0000b5b0: 2020 2020 2020 2027 2727 290a 0a20 2020         ''')..   
+0000b5c0: 2064 6566 2074 6573 745f 7570 6461 7465   def test_update
+0000b5d0: 5f63 6f6e 6669 675f 756e 7365 745f 626f  _config_unset_bo
+0000b5e0: 6f6c 6561 6e28 7365 6c66 293a 0a20 2020  olean(self):.   
+0000b5f0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0000b600: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0000b610: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
+0000b620: 6d2c 2063 6f6e 6669 673d 2727 270a 2020  m, config='''.  
+0000b630: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
+0000b640: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000b650: 2020 2061 3a0a 2020 2020 2020 2020 2020     a:.          
+0000b660: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+0000b670: 7074 696f 6e3a 2061 2063 6f6e 6669 6720  ption: a config 
+0000b680: 6f70 7469 6f6e 0a20 2020 2020 2020 2020  option.         
+0000b690: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+0000b6a0: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
+0000b6b0: 2020 2020 2020 2020 2020 2020 2064 6566               def
+0000b6c0: 6175 6c74 3a20 4661 6c73 650a 2020 2020  ault: False.    
+0000b6d0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+0000b6e0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0000b6f0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+0000b700: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
+0000b710: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+0000b720: 2020 2020 2020 2320 4368 6563 6b20 7468        # Check th
+0000b730: 6520 6465 6661 756c 7420 7761 7320 7365  e default was se
+0000b740: 7420 636f 7272 6563 746c 790a 2020 2020  t correctly.    
+0000b750: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000b760: 7175 616c 2868 6172 6e65 7373 2e63 6861  qual(harness.cha
+0000b770: 726d 2e63 6f6e 6669 672c 207b 2761 273a  rm.config, {'a':
+0000b780: 2046 616c 7365 7d29 0a20 2020 2020 2020   False}).       
+0000b790: 2023 2053 6574 2074 6865 2062 6f6f 6c65   # Set the boole
+0000b7a0: 616e 2076 616c 7565 2074 6f20 5472 7565  an value to True
+0000b7b0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000b7c0: 2e75 7064 6174 655f 636f 6e66 6967 286b  .update_config(k
+0000b7d0: 6579 5f76 616c 7565 733d 7b27 6127 3a20  ey_values={'a': 
+0000b7e0: 5472 7565 7d29 0a20 2020 2020 2020 2073  True}).        s
+0000b7f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000b800: 6861 726e 6573 732e 6368 6172 6d2e 6368  harness.charm.ch
+0000b810: 616e 6765 732c 205b 7b27 6e61 6d65 273a  anges, [{'name':
+0000b820: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
+0000b830: 272c 2027 6461 7461 273a 207b 2761 273a  ', 'data': {'a':
+0000b840: 2054 7275 657d 7d5d 290a 2020 2020 2020   True}}]).      
+0000b850: 2020 2320 556e 7365 7420 7468 6520 626f    # Unset the bo
+0000b860: 6f6c 6561 6e20 7661 6c75 650a 2020 2020  olean value.    
+0000b870: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000b880: 7465 5f63 6f6e 6669 6728 756e 7365 743d  te_config(unset=
+0000b890: 7b27 6127 7d29 0a20 2020 2020 2020 2073  {'a'}).        s
+0000b8a0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000b8b0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0000b8c0: 6e65 7373 2e63 6861 726d 2e63 6861 6e67  ness.charm.chang
+0000b8d0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000b8e0: 5b7b 276e 616d 6527 3a20 2763 6f6e 6669  [{'name': 'confi
+0000b8f0: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
+0000b900: 6127 3a20 7b27 6127 3a20 5472 7565 7d7d  a': {'a': True}}
+0000b910: 2c0a 2020 2020 2020 2020 2020 2020 207b  ,.             {
+0000b920: 276e 616d 6527 3a20 2763 6f6e 6669 672d  'name': 'config-
+0000b930: 6368 616e 6765 6427 2c20 2764 6174 6127  changed', 'data'
+0000b940: 3a20 7b27 6127 3a20 4661 6c73 657d 7d5d  : {'a': False}}]
+0000b950: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000b960: 7365 745f 6c65 6164 6572 2873 656c 6629  set_leader(self)
+0000b970: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0000b980: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0000b990: 4861 726e 6573 7328 5265 636f 7264 696e  Harness(Recordin
+0000b9a0: 6743 6861 726d 290a 2020 2020 2020 2020  gCharm).        
+0000b9b0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0000b9c0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+0000b9d0: 0a20 2020 2020 2020 2023 204e 6f20 6576  .        # No ev
+0000b9e0: 656e 7420 6861 7070 656e 7320 6865 7265  ent happens here
+0000b9f0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000ba00: 2e73 6574 5f6c 6561 6465 7228 4661 6c73  .set_leader(Fals
+0000ba10: 6529 0a20 2020 2020 2020 2068 6172 6e65  e).        harne
+0000ba20: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+0000ba30: 2020 2073 656c 662e 6173 7365 7274 4661     self.assertFa
+0000ba40: 6c73 6528 6861 726e 6573 732e 6368 6172  lse(harness.char
+0000ba50: 6d2e 6d6f 6465 6c2e 756e 6974 2e69 735f  m.model.unit.is_
+0000ba60: 6c65 6164 6572 2829 290a 2020 2020 2020  leader()).      
+0000ba70: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
+0000ba80: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
+0000ba90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000baa0: 7561 6c28 6861 726e 6573 732e 6368 6172  ual(harness.char
+0000bab0: 6d2e 6765 745f 6368 616e 6765 7328 7265  m.get_changes(re
+0000bac0: 7365 743d 5472 7565 292c 205b 7b27 6e61  set=True), [{'na
+0000bad0: 6d65 273a 2027 6c65 6164 6572 2d65 6c65  me': 'leader-ele
+0000bae0: 6374 6564 277d 5d29 0a20 2020 2020 2020  cted'}]).       
+0000baf0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000bb00: 2868 6172 6e65 7373 2e63 6861 726d 2e6d  (harness.charm.m
+0000bb10: 6f64 656c 2e75 6e69 742e 6973 5f6c 6561  odel.unit.is_lea
+0000bb20: 6465 7228 2929 0a20 2020 2020 2020 2068  der()).        h
+0000bb30: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+0000bb40: 7228 4661 6c73 6529 0a20 2020 2020 2020  r(False).       
+0000bb50: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
+0000bb60: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
+0000bb70: 6d6f 6465 6c2e 756e 6974 2e69 735f 6c65  model.unit.is_le
+0000bb80: 6164 6572 2829 290a 2020 2020 2020 2020  ader()).        
+0000bb90: 2320 4e6f 2068 6f6f 6b20 6576 656e 7420  # No hook event 
+0000bba0: 7768 656e 2079 6f75 206c 6f73 6520 6c65  when you lose le
+0000bbb0: 6164 6572 7368 6970 2e0a 2020 2020 2020  adership..      
+0000bbc0: 2020 2320 544f 444f 3a20 7665 7269 6679    # TODO: verify
+0000bbd0: 2069 6620 4a75 6a75 2061 6c77 6179 7320   if Juju always 
+0000bbe0: 7472 6967 6765 7273 2060 6c65 6164 6572  triggers `leader
+0000bbf0: 2d73 6574 7469 6e67 732d 6368 616e 6765  -settings-change
+0000bc00: 6460 2069 6620 796f 750a 2020 2020 2020  d` if you.      
+0000bc10: 2020 2320 2020 6c6f 7365 206c 6561 6465    #   lose leade
+0000bc20: 7273 6869 702e 0a20 2020 2020 2020 2073  rship..        s
+0000bc30: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000bc40: 6861 726e 6573 732e 6368 6172 6d2e 6765  harness.charm.ge
+0000bc50: 745f 6368 616e 6765 7328 7265 7365 743d  t_changes(reset=
+0000bc60: 5472 7565 292c 205b 5d29 0a20 2020 2020  True), []).     
+0000bc70: 2020 2068 6172 6e65 7373 2e64 6973 6162     harness.disab
+0000bc80: 6c65 5f68 6f6f 6b73 2829 0a20 2020 2020  le_hooks().     
+0000bc90: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
+0000bca0: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
+0000bcb0: 2020 2020 2320 4e6f 2068 6f6f 6b20 6576      # No hook ev
+0000bcc0: 656e 7420 6966 2079 6f75 2068 6176 6520  ent if you have 
+0000bcd0: 6469 7361 626c 6564 2074 6865 6d0a 2020  disabled them.  
+0000bce0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000bcf0: 7445 7175 616c 2868 6172 6e65 7373 2e63  tEqual(harness.c
+0000bd00: 6861 726d 2e67 6574 5f63 6861 6e67 6573  harm.get_changes
+0000bd10: 2872 6573 6574 3d54 7275 6529 2c20 5b5d  (reset=True), []
+0000bd20: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0000bd30: 7265 6c61 7469 6f6e 5f73 6574 5f61 7070  relation_set_app
+0000bd40: 5f6e 6f74 5f6c 6561 6465 7228 7365 6c66  _not_leader(self
+0000bd50: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0000bd60: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000bd70: 2e48 6172 6e65 7373 2852 6563 6f72 6469  .Harness(Recordi
+0000bd80: 6e67 4368 6172 6d2c 206d 6574 613d 2727  ngCharm, meta=''
+0000bd90: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+0000bda0: 6d65 3a20 7465 7374 2d63 6861 726d 0a20  me: test-charm. 
+0000bdb0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+0000bdc0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+0000bdd0: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
+0000bde0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0000bdf0: 6572 6661 6365 3a20 7067 7371 6c0a 2020  erface: pgsql.  
+0000be00: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+0000be10: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000be20: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0000be30: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0000be40: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
+0000be50: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000be60: 7365 745f 6c65 6164 6572 2846 616c 7365  set_leader(False
+0000be70: 290a 2020 2020 2020 2020 7265 6c5f 6964  ).        rel_id
+0000be80: 203d 2068 6172 6e65 7373 2e61 6464 5f72   = harness.add_r
+0000be90: 656c 6174 696f 6e28 2764 6227 2c20 2770  elation('db', 'p
+0000bea0: 6f73 7467 7265 7371 6c27 290a 2020 2020  ostgresql').    
+0000beb0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+0000bec0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
+0000bed0: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
+0000bee0: 6c2f 3027 290a 2020 2020 2020 2020 7265  l/0').        re
+0000bef0: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
+0000bf00: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
+0000bf10: 7469 6f6e 2827 6462 2729 0a20 2020 2020  tion('db').     
+0000bf20: 2020 2077 6974 6820 6861 726e 6573 732e     with harness.
+0000bf30: 5f65 7665 6e74 5f63 6f6e 7465 7874 2827  _event_context('
+0000bf40: 666f 6f27 293a 0a20 2020 2020 2020 2020  foo'):.         
+0000bf50: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+0000bf60: 6572 7452 6169 7365 7328 6f70 732e 4d6f  ertRaises(ops.Mo
+0000bf70: 6465 6c45 7272 6f72 293a 0a20 2020 2020  delError):.     
+0000bf80: 2020 2020 2020 2020 2020 2072 656c 2e64             rel.d
+0000bf90: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
+0000bfa0: 6d2e 6170 705d 5b27 666f 6f27 5d20 3d20  m.app]['foo'] = 
+0000bfb0: 2762 6172 270a 2020 2020 2020 2020 2320  'bar'.        # 
+0000bfc0: 5468 6520 6461 7461 2068 6173 206e 6f74  The data has not
+0000bfd0: 2061 6374 7561 6c6c 7920 6265 656e 2063   actually been c
+0000bfe0: 6861 6e67 6564 0a20 2020 2020 2020 2073  hanged.        s
+0000bff0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0000c000: 6861 726e 6573 732e 6765 745f 7265 6c61  harness.get_rela
+0000c010: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
+0000c020: 2c20 2774 6573 742d 6368 6172 6d27 292c  , 'test-charm'),
+0000c030: 207b 7d29 0a20 2020 2020 2020 2068 6172   {}).        har
+0000c040: 6e65 7373 2e73 6574 5f6c 6561 6465 7228  ness.set_leader(
+0000c050: 5472 7565 290a 2020 2020 2020 2020 7265  True).        re
+0000c060: 6c2e 6461 7461 5b68 6172 6e65 7373 2e63  l.data[harness.c
+0000c070: 6861 726d 2e61 7070 5d5b 2766 6f6f 275d  harm.app]['foo']
+0000c080: 203d 2027 6261 7227 0a20 2020 2020 2020   = 'bar'.       
+0000c090: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000c0a0: 6c28 6861 726e 6573 732e 6765 745f 7265  l(harness.get_re
+0000c0b0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+0000c0c0: 6964 2c20 2774 6573 742d 6368 6172 6d27  id, 'test-charm'
+0000c0d0: 292c 207b 2766 6f6f 273a 2027 6261 7227  ), {'foo': 'bar'
+0000c0e0: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
+0000c0f0: 5f68 6f6f 6b73 5f65 6e61 626c 6564 5f61  _hooks_enabled_a
+0000c100: 6e64 5f64 6973 6162 6c65 6428 7365 6c66  nd_disabled(self
+0000c110: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0000c120: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000c130: 2e48 6172 6e65 7373 280a 2020 2020 2020  .Harness(.      
+0000c140: 2020 2020 2020 5265 636f 7264 696e 6743        RecordingC
+0000c150: 6861 726d 2c0a 2020 2020 2020 2020 2020  harm,.          
+0000c160: 2020 6d65 7461 3d27 2727 0a20 2020 2020    meta='''.     
+0000c170: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000c180: 616d 653a 2074 6573 742d 6368 6172 6d0a  ame: test-charm.
+0000c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1a0: 2727 272c 0a20 2020 2020 2020 2020 2020  ''',.           
+0000c1b0: 2063 6f6e 6669 673d 2727 270a 2020 2020   config='''.    
+0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1d0: 6f70 7469 6f6e 733a 0a20 2020 2020 2020  options:.       
+0000c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1f0: 2076 616c 7565 3a0a 2020 2020 2020 2020   value:.        
+0000c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c210: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
+0000c220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c230: 2020 2020 2020 2020 2074 6869 7264 3a0a           third:.
+0000c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c250: 2020 2020 2020 2020 2020 2020 7479 7065              type
+0000c260: 3a20 7374 7269 6e67 0a20 2020 2020 2020  : string.       
+0000c270: 2020 2020 2020 2020 2020 2020 2027 2727               '''
+0000c280: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c290: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0000c2a0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0000c2b0: 2020 2023 2042 6566 6f72 6520 6265 6769     # Before begi
+0000c2c0: 6e28 2920 7468 6572 6520 6172 6520 6e6f  n() there are no
+0000c2d0: 2065 7665 6e74 732e 0a20 2020 2020 2020   events..       
+0000c2e0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+0000c2f0: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
+0000c300: 2027 6669 7273 7427 7d29 0a20 2020 2020   'first'}).     
+0000c310: 2020 2023 2042 7920 6465 6661 756c 742c     # By default,
+0000c320: 2061 6674 6572 2062 6567 696e 2074 6865   after begin the
+0000c330: 2063 6861 726d 2069 7320 7365 7420 7570   charm is set up
+0000c340: 2074 6f20 7265 6365 6976 6520 6576 656e   to receive even
+0000c350: 7473 2e0a 2020 2020 2020 2020 6861 726e  ts..        harn
+0000c360: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0000c370: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000c380: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
+0000c390: 6527 3a20 2773 6563 6f6e 6427 7d29 0a20  e': 'second'}). 
+0000c3a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000c3b0: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000c3c0: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000c3d0: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+0000c3e0: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
+0000c3f0: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000c400: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000c410: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
+0000c420: 6c75 6527 3a20 2773 6563 6f6e 6427 7d7d  lue': 'second'}}
+0000c430: 5d29 0a20 2020 2020 2020 2023 204f 6e63  ]).        # Onc
+0000c440: 6520 6469 7361 626c 6564 2c20 7765 2077  e disabled, we w
+0000c450: 6f6e 2774 2073 6565 2063 6f6e 6669 672d  on't see config-
+0000c460: 6368 616e 6765 6420 7768 656e 2077 6520  changed when we 
+0000c470: 6d61 6b65 2061 6e20 7570 6461 7465 0a20  make an update. 
+0000c480: 2020 2020 2020 2068 6172 6e65 7373 2e64         harness.d
+0000c490: 6973 6162 6c65 5f68 6f6f 6b73 2829 0a20  isable_hooks(). 
+0000c4a0: 2020 2020 2020 2068 6172 6e65 7373 2e75         harness.u
+0000c4b0: 7064 6174 655f 636f 6e66 6967 287b 2774  pdate_config({'t
+0000c4c0: 6869 7264 273a 2027 3327 7d29 0a20 2020  hird': '3'}).   
+0000c4d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0000c4e0: 4571 7561 6c28 6861 726e 6573 732e 6368  Equal(harness.ch
+0000c4f0: 6172 6d2e 6765 745f 6368 616e 6765 7328  arm.get_changes(
+0000c500: 7265 7365 743d 5472 7565 292c 205b 5d29  reset=True), [])
+0000c510: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000c520: 2e65 6e61 626c 655f 686f 6f6b 7328 290a  .enable_hooks().
+0000c530: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000c540: 7570 6461 7465 5f63 6f6e 6669 6728 7b27  update_config({'
+0000c550: 7661 6c75 6527 3a20 2766 6f75 7274 6827  value': 'fourth'
+0000c560: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+0000c570: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+0000c580: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
+0000c590: 2e63 6861 726d 2e67 6574 5f63 6861 6e67  .charm.get_chang
+0000c5a0: 6573 2872 6573 6574 3d54 7275 6529 2c0a  es(reset=True),.
+0000c5b0: 2020 2020 2020 2020 2020 2020 5b7b 276e              [{'n
+0000c5c0: 616d 6527 3a20 2763 6f6e 6669 672d 6368  ame': 'config-ch
+0000c5d0: 616e 6765 6427 2c20 2764 6174 6127 3a20  anged', 'data': 
+0000c5e0: 7b27 7661 6c75 6527 3a20 2766 6f75 7274  {'value': 'fourt
+0000c5f0: 6827 2c20 2774 6869 7264 273a 2027 3327  h', 'third': '3'
+0000c600: 7d7d 5d29 0a0a 2020 2020 6465 6620 7465  }}])..    def te
+0000c610: 7374 5f68 6f6f 6b73 5f64 6973 6162 6c65  st_hooks_disable
+0000c620: 645f 636f 6e74 6578 746d 616e 6167 6572  d_contextmanager
+0000c630: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000c640: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000c650: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
+0000c660: 636f 7264 696e 6743 6861 726d 2c20 6d65  cordingCharm, me
+0000c670: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+0000c680: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+0000c690: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
+0000c6a0: 2020 2020 2020 2020 2727 272c 2063 6f6e          ''', con
+0000c6b0: 6669 673d 2727 270a 2020 2020 2020 2020  fig='''.        
+0000c6c0: 2020 2020 2020 2020 6f70 7469 6f6e 733a          options:
+0000c6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c6e0: 2020 2020 2076 616c 7565 3a0a 2020 2020       value:.    
+0000c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c700: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
+0000c710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c720: 2020 2020 2074 6869 7264 3a0a 2020 2020       third:.    
+0000c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c740: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
+0000c750: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+0000c760: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000c770: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0000c780: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0000c790: 2020 2023 2042 6566 6f72 6520 6265 6769     # Before begi
+0000c7a0: 6e28 2920 7468 6572 6520 6172 6520 6e6f  n() there are no
+0000c7b0: 2065 7665 6e74 732e 0a20 2020 2020 2020   events..       
+0000c7c0: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+0000c7d0: 636f 6e66 6967 287b 2776 616c 7565 273a  config({'value':
+0000c7e0: 2027 6669 7273 7427 7d29 0a20 2020 2020   'first'}).     
+0000c7f0: 2020 2023 2042 7920 6465 6661 756c 742c     # By default,
+0000c800: 2061 6674 6572 2062 6567 696e 2074 6865   after begin the
+0000c810: 2063 6861 726d 2069 7320 7365 7420 7570   charm is set up
+0000c820: 2074 6f20 7265 6365 6976 6520 6576 656e   to receive even
+0000c830: 7473 2e0a 2020 2020 2020 2020 6861 726e  ts..        harn
+0000c840: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+0000c850: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000c860: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
+0000c870: 6527 3a20 2773 6563 6f6e 6427 7d29 0a20  e': 'second'}). 
+0000c880: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000c890: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000c8a0: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000c8b0: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+0000c8c0: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
+0000c8d0: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000c8e0: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000c8f0: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
+0000c900: 6c75 6527 3a20 2773 6563 6f6e 6427 7d7d  lue': 'second'}}
+0000c910: 5d29 0a20 2020 2020 2020 2023 204f 6e63  ]).        # Onc
+0000c920: 6520 6469 7361 626c 6564 2c20 7765 2077  e disabled, we w
+0000c930: 6f6e 2774 2073 6565 2063 6f6e 6669 672d  on't see config-
+0000c940: 6368 616e 6765 6420 7768 656e 2077 6520  changed when we 
+0000c950: 6d61 6b65 2061 6e20 7570 6461 7465 0a20  make an update. 
+0000c960: 2020 2020 2020 2077 6974 6820 6861 726e         with harn
+0000c970: 6573 732e 686f 6f6b 735f 6469 7361 626c  ess.hooks_disabl
+0000c980: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
+0000c990: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+0000c9a0: 5f63 6f6e 6669 6728 7b27 7468 6972 6427  _config({'third'
+0000c9b0: 3a20 2733 277d 290a 2020 2020 2020 2020  : '3'}).        
+0000c9c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000c9d0: 2868 6172 6e65 7373 2e63 6861 726d 2e67  (harness.charm.g
+0000c9e0: 6574 5f63 6861 6e67 6573 2872 6573 6574  et_changes(reset
+0000c9f0: 3d54 7275 6529 2c20 5b5d 290a 2020 2020  =True), []).    
+0000ca00: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000ca10: 7465 5f63 6f6e 6669 6728 7b27 7661 6c75  te_config({'valu
+0000ca20: 6527 3a20 2766 6f75 7274 6827 7d29 0a20  e': 'fourth'}). 
+0000ca30: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000ca40: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
+0000ca50: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
+0000ca60: 726d 2e67 6574 5f63 6861 6e67 6573 2872  rm.get_changes(r
+0000ca70: 6573 6574 3d54 7275 6529 2c0a 2020 2020  eset=True),.    
+0000ca80: 2020 2020 2020 2020 5b7b 276e 616d 6527          [{'name'
+0000ca90: 3a20 2763 6f6e 6669 672d 6368 616e 6765  : 'config-change
+0000caa0: 6427 2c20 2764 6174 6127 3a20 7b27 7661  d', 'data': {'va
+0000cab0: 6c75 6527 3a20 2766 6f75 7274 6827 2c20  lue': 'fourth', 
+0000cac0: 2774 6869 7264 273a 2027 3327 7d7d 5d29  'third': '3'}}])
+0000cad0: 0a0a 2020 2020 6465 6620 7465 7374 5f68  ..    def test_h
+0000cae0: 6f6f 6b73 5f64 6973 6162 6c65 645f 6e65  ooks_disabled_ne
+0000caf0: 7374 6564 5f63 6f6e 7465 7874 6d61 6e61  sted_contextmana
+0000cb00: 6765 7228 7365 6c66 293a 0a20 2020 2020  ger(self):.     
+0000cb10: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0000cb20: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0000cb30: 2852 6563 6f72 6469 6e67 4368 6172 6d2c  (RecordingCharm,
+0000cb40: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0000cb50: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+0000cb60: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+0000cb70: 2020 2020 2020 2027 2727 2c20 636f 6e66         ''', conf
+0000cb80: 6967 3d27 2727 0a20 2020 2020 2020 2020  ig='''.         
+0000cb90: 2020 2020 2020 206f 7074 696f 6e73 3a0a         options:.
+0000cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbb0: 2020 2020 6669 6674 683a 0a20 2020 2020      fifth:.     
+0000cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbd0: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
+0000cbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbf0: 2020 2020 7369 7874 683a 0a20 2020 2020      sixth:.     
+0000cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc10: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
+0000cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc30: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0000cc40: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0000cc50: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0000cc60: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+0000cc70: 6769 6e28 290a 2020 2020 2020 2020 2320  gin().        # 
+0000cc80: 436f 6e74 6578 7420 6d61 6e61 6765 7220  Context manager 
+0000cc90: 6361 6e20 6265 206e 6573 7465 642c 2073  can be nested, s
+0000cca0: 6f20 6120 7465 7374 2075 7369 6e67 2069  o a test using i
+0000ccb0: 7420 6361 6e20 696e 766f 6b65 2061 2068  t can invoke a h
+0000ccc0: 656c 7065 7220 7573 696e 6720 6974 2e0a  elper using it..
+0000ccd0: 2020 2020 2020 2020 7769 7468 2068 6172          with har
+0000cce0: 6e65 7373 2e68 6f6f 6b73 5f64 6973 6162  ness.hooks_disab
+0000ccf0: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
+0000cd00: 2020 2077 6974 6820 6861 726e 6573 732e     with harness.
+0000cd10: 686f 6f6b 735f 6469 7361 626c 6564 2829  hooks_disabled()
+0000cd20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cd30: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+0000cd40: 5f63 6f6e 6669 6728 7b27 6669 6674 6827  _config({'fifth'
+0000cd50: 3a20 2735 277d 290a 2020 2020 2020 2020  : '5'}).        
+0000cd60: 2020 2020 6861 726e 6573 732e 7570 6461      harness.upda
+0000cd70: 7465 5f63 6f6e 6669 6728 7b27 7369 7874  te_config({'sixt
+0000cd80: 6827 3a20 2736 277d 290a 2020 2020 2020  h': '6'}).      
+0000cd90: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000cda0: 616c 2868 6172 6e65 7373 2e63 6861 726d  al(harness.charm
+0000cdb0: 2e67 6574 5f63 6861 6e67 6573 2872 6573  .get_changes(res
+0000cdc0: 6574 3d54 7275 6529 2c20 5b5d 290a 0a20  et=True), []).. 
+0000cdd0: 2020 2064 6566 2074 6573 745f 686f 6f6b     def test_hook
+0000cde0: 735f 6469 7361 626c 6564 5f6e 6f6f 7028  s_disabled_noop(
+0000cdf0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0000ce00: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0000ce10: 7469 6e67 2e48 6172 6e65 7373 2852 6563  ting.Harness(Rec
+0000ce20: 6f72 6469 6e67 4368 6172 6d2c 206d 6574  ordingCharm, met
+0000ce30: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000ce40: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+0000ce50: 2d63 6861 726d 0a20 2020 2020 2020 2020  -charm.         
+0000ce60: 2020 2027 2727 2c20 636f 6e66 6967 3d27     ''', config='
+0000ce70: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
+0000ce80: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
+0000ce90: 2020 2020 2020 2020 7365 7665 6e74 683a          seventh:
+0000cea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ceb0: 2020 2020 2074 7970 653a 2073 7472 696e       type: strin
+0000cec0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+0000ced0: 2020 6569 6768 7468 3a0a 2020 2020 2020    eighth:.      
+0000cee0: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+0000cef0: 7065 3a20 7374 7269 6e67 0a20 2020 2020  pe: string.     
+0000cf00: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+0000cf10: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0000cf20: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0000cf30: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
+0000cf40: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+0000cf50: 2020 2020 2023 2049 6620 686f 6f6b 7320       # If hooks 
+0000cf60: 6172 6520 616c 7265 6164 7920 6469 7361  are already disa
+0000cf70: 626c 6564 2c20 6974 2069 7320 6120 6e6f  bled, it is a no
+0000cf80: 206f 702c 2061 6e64 206f 6e20 6578 6974   op, and on exit
+0000cf90: 2068 6f6f 6b73 2072 656d 6169 6e20 6469   hooks remain di
+0000cfa0: 7361 626c 6564 2e0a 2020 2020 2020 2020  sabled..        
+0000cfb0: 6861 726e 6573 732e 6469 7361 626c 655f  harness.disable_
+0000cfc0: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
+0000cfd0: 7769 7468 2068 6172 6e65 7373 2e68 6f6f  with harness.hoo
+0000cfe0: 6b73 5f64 6973 6162 6c65 6428 293a 0a20  ks_disabled():. 
+0000cff0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+0000d000: 7373 2e75 7064 6174 655f 636f 6e66 6967  ss.update_config
+0000d010: 287b 2773 6576 656e 7468 273a 2027 3727  ({'seventh': '7'
+0000d020: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
+0000d030: 7373 2e75 7064 6174 655f 636f 6e66 6967  ss.update_config
+0000d040: 287b 2765 6967 6874 6827 3a20 2738 277d  ({'eighth': '8'}
+0000d050: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000d060: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
+0000d070: 7373 2e63 6861 726d 2e67 6574 5f63 6861  ss.charm.get_cha
+0000d080: 6e67 6573 2872 6573 6574 3d54 7275 6529  nges(reset=True)
+0000d090: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+0000d0a0: 6573 745f 6d65 7461 6461 7461 5f66 726f  est_metadata_fro
+0000d0b0: 6d5f 6469 7265 6374 6f72 7928 7365 6c66  m_directory(self
+0000d0c0: 293a 0a20 2020 2020 2020 2074 6d70 203d  ):.        tmp =
+0000d0d0: 2070 6174 686c 6962 2e50 6174 6828 7465   pathlib.Path(te
+0000d0e0: 6d70 6669 6c65 2e6d 6b64 7465 6d70 2829  mpfile.mkdtemp()
+0000d0f0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000d100: 6464 436c 6561 6e75 7028 7368 7574 696c  ddCleanup(shutil
+0000d110: 2e72 6d74 7265 652c 2073 7472 2874 6d70  .rmtree, str(tmp
+0000d120: 2929 0a20 2020 2020 2020 206d 6574 6164  )).        metad
+0000d130: 6174 615f 6669 6c65 6e61 6d65 203d 2074  ata_filename = t
+0000d140: 6d70 202f 2027 6d65 7461 6461 7461 2e79  mp / 'metadata.y
+0000d150: 616d 6c27 0a20 2020 2020 2020 2077 6974  aml'.        wit
+0000d160: 6820 6d65 7461 6461 7461 5f66 696c 656e  h metadata_filen
+0000d170: 616d 652e 6f70 656e 2827 7774 2729 2061  ame.open('wt') a
+0000d180: 7320 6d65 7461 6461 7461 3a0a 2020 2020  s metadata:.    
+0000d190: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
+0000d1a0: 2e77 7269 7465 2874 6578 7477 7261 702e  .write(textwrap.
+0000d1b0: 6465 6465 6e74 2827 2727 0a20 2020 2020  dedent('''.     
+0000d1c0: 2020 2020 2020 206e 616d 653a 206d 792d         name: my-
+0000d1d0: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+0000d1e0: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+0000d1f0: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d210: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+0000d220: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+0000d230: 2027 2727 2929 0a20 2020 2020 2020 2068   ''')).        h
+0000d240: 6172 6e65 7373 203d 2073 656c 662e 5f67  arness = self._g
+0000d250: 6574 5f64 756d 6d79 5f63 6861 726d 5f68  et_dummy_charm_h
+0000d260: 6172 6e65 7373 2874 6d70 290a 2020 2020  arness(tmp).    
+0000d270: 2020 2020 6861 726e 6573 732e 6265 6769      harness.begi
+0000d280: 6e28 290a 2020 2020 2020 2020 7365 6c66  n().        self
+0000d290: 2e61 7373 6572 7445 7175 616c 286c 6973  .assertEqual(lis
+0000d2a0: 7428 6861 726e 6573 732e 6d6f 6465 6c2e  t(harness.model.
+0000d2b0: 7265 6c61 7469 6f6e 7329 2c20 5b27 6462  relations), ['db
+0000d2c0: 275d 290a 2020 2020 2020 2020 2320 5468  ']).        # Th
+0000d2d0: 6520 6368 6172 6d5f 6469 7220 616c 736f  e charm_dir also
+0000d2e0: 2067 6574 7320 7365 740a 2020 2020 2020   gets set.      
+0000d2f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0000d300: 616c 2868 6172 6e65 7373 2e66 7261 6d65  al(harness.frame
+0000d310: 776f 726b 2e63 6861 726d 5f64 6972 2c20  work.charm_dir, 
+0000d320: 746d 7029 0a0a 2020 2020 6465 6620 7465  tmp)..    def te
+0000d330: 7374 5f63 6f6e 6669 675f 6672 6f6d 5f64  st_config_from_d
+0000d340: 6972 6563 746f 7279 2873 656c 6629 3a0a  irectory(self):.
+0000d350: 2020 2020 2020 2020 746d 7020 3d20 7061          tmp = pa
+0000d360: 7468 6c69 622e 5061 7468 2874 656d 7066  thlib.Path(tempf
+0000d370: 696c 652e 6d6b 6474 656d 7028 2929 0a20  ile.mkdtemp()). 
+0000d380: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000d390: 6c65 616e 7570 2873 6875 7469 6c2e 726d  leanup(shutil.rm
+0000d3a0: 7472 6565 2c20 7374 7228 746d 7029 290a  tree, str(tmp)).
+0000d3b0: 2020 2020 2020 2020 636f 6e66 6967 5f66          config_f
+0000d3c0: 696c 656e 616d 6520 3d20 746d 7020 2f20  ilename = tmp / 
+0000d3d0: 2763 6f6e 6669 672e 7961 6d6c 270a 2020  'config.yaml'.  
+0000d3e0: 2020 2020 2020 7769 7468 2063 6f6e 6669        with confi
+0000d3f0: 675f 6669 6c65 6e61 6d65 2e6f 7065 6e28  g_filename.open(
+0000d400: 2777 7427 2920 6173 2063 6f6e 6669 673a  'wt') as config:
+0000d410: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000d420: 6669 672e 7772 6974 6528 7465 7874 7772  fig.write(textwr
+0000d430: 6170 2e64 6564 656e 7428 2727 270a 2020  ap.dedent('''.  
+0000d440: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
+0000d450: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000d460: 2020 206f 7074 5f73 7472 3a0a 2020 2020     opt_str:.    
+0000d470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d480: 7479 7065 3a20 7374 7269 6e67 0a20 2020  type: string.   
+0000d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4a0: 2064 6566 6175 6c74 3a20 2276 616c 220a   default: "val".
+0000d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4c0: 6f70 745f 7374 725f 656d 7074 793a 0a20  opt_str_empty:. 
+0000d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4e0: 2020 2074 7970 653a 2073 7472 696e 670a     type: string.
+0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d500: 2020 2020 6465 6661 756c 743a 2022 220a      default: "".
+0000d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d520: 6f70 745f 6e75 6c6c 3a0a 2020 2020 2020  opt_null:.      
+0000d530: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+0000d540: 7065 3a20 7374 7269 6e67 0a20 2020 2020  pe: string.     
+0000d550: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000d560: 6566 6175 6c74 3a20 6e75 6c6c 0a20 2020  efault: null.   
+0000d570: 2020 2020 2020 2020 2020 2020 206f 7074               opt
+0000d580: 5f62 6f6f 6c3a 0a20 2020 2020 2020 2020  _bool:.         
+0000d590: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+0000d5a0: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
+0000d5b0: 2020 2020 2020 2020 2020 2020 2064 6566               def
+0000d5c0: 6175 6c74 3a20 7472 7565 0a20 2020 2020  ault: true.     
+0000d5d0: 2020 2020 2020 2020 2020 206f 7074 5f69             opt_i
+0000d5e0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+0000d5f0: 2020 2020 2020 2020 7479 7065 3a20 696e          type: in
+0000d600: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0000d610: 2020 2020 2020 6465 6661 756c 743a 2031        default: 1
+0000d620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d630: 206f 7074 5f66 6c6f 6174 3a0a 2020 2020   opt_float:.    
+0000d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d650: 7479 7065 3a20 666c 6f61 740a 2020 2020  type: float.    
+0000d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d670: 6465 6661 756c 743a 2031 2e30 0a20 2020  default: 1.0.   
+0000d680: 2020 2020 2020 2020 2020 2020 206f 7074               opt
+0000d690: 5f6e 6f5f 6465 6661 756c 743a 0a20 2020  _no_default:.   
+0000d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6b0: 2074 7970 653a 2073 7472 696e 670a 2020   type: string.  
+0000d6c0: 2020 2020 2020 2020 2020 2727 2729 290a            ''')).
+0000d6d0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+0000d6e0: 3d20 7365 6c66 2e5f 6765 745f 6475 6d6d  = self._get_dumm
+0000d6f0: 795f 6368 6172 6d5f 6861 726e 6573 7328  y_charm_harness(
+0000d700: 746d 7029 0a20 2020 2020 2020 2073 656c  tmp).        sel
+0000d710: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
+0000d720: 726e 6573 732e 6d6f 6465 6c2e 636f 6e66  rness.model.conf
+0000d730: 6967 5b27 6f70 745f 7374 7227 5d2c 2027  ig['opt_str'], '
+0000d740: 7661 6c27 290a 2020 2020 2020 2020 7365  val').        se
+0000d750: 6c66 2e61 7373 6572 7445 7175 616c 2868  lf.assertEqual(h
+0000d760: 6172 6e65 7373 2e6d 6f64 656c 2e63 6f6e  arness.model.con
+0000d770: 6669 675b 276f 7074 5f73 7472 5f65 6d70  fig['opt_str_emp
+0000d780: 7479 275d 2c20 2727 290a 2020 2020 2020  ty'], '').      
+0000d790: 2020 7365 6c66 2e61 7373 6572 7449 7328    self.assertIs(
+0000d7a0: 6861 726e 6573 732e 6d6f 6465 6c2e 636f  harness.model.co
+0000d7b0: 6e66 6967 5b27 6f70 745f 626f 6f6c 275d  nfig['opt_bool']
+0000d7c0: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
+0000d7d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0000d7e0: 2868 6172 6e65 7373 2e6d 6f64 656c 2e63  (harness.model.c
+0000d7f0: 6f6e 6669 675b 276f 7074 5f69 6e74 275d  onfig['opt_int']
+0000d800: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
+0000d810: 662e 6173 7365 7274 4973 496e 7374 616e  f.assertIsInstan
+0000d820: 6365 2868 6172 6e65 7373 2e6d 6f64 656c  ce(harness.model
+0000d830: 2e63 6f6e 6669 675b 276f 7074 5f69 6e74  .config['opt_int
+0000d840: 275d 2c20 696e 7429 0a20 2020 2020 2020  '], int).       
+0000d850: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000d860: 6c28 6861 726e 6573 732e 6d6f 6465 6c2e  l(harness.model.
+0000d870: 636f 6e66 6967 5b27 6f70 745f 666c 6f61  config['opt_floa
+0000d880: 7427 5d2c 2031 2e30 290a 2020 2020 2020  t'], 1.0).      
+0000d890: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+0000d8a0: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
+0000d8b0: 6d6f 6465 6c2e 636f 6e66 6967 5b27 6f70  model.config['op
+0000d8c0: 745f 666c 6f61 7427 5d2c 2066 6c6f 6174  t_float'], float
+0000d8d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000d8e0: 7373 6572 7446 616c 7365 2827 6f70 745f  ssertFalse('opt_
+0000d8f0: 6e75 6c6c 2720 696e 2068 6172 6e65 7373  null' in harness
+0000d900: 2e6d 6f64 656c 2e63 6f6e 6669 6729 0a20  .model.config). 
+0000d910: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000d920: 7274 4973 4e6f 6e65 2868 6172 6e65 7373  rtIsNone(harness
+0000d930: 2e5f 6261 636b 656e 642e 5f63 6f6e 6669  ._backend._confi
+0000d940: 672e 5f64 6566 6175 6c74 735b 276f 7074  g._defaults['opt
+0000d950: 5f6e 756c 6c27 5d29 0a20 2020 2020 2020  _null']).       
+0000d960: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+0000d970: 6e65 2868 6172 6e65 7373 2e5f 6261 636b  ne(harness._back
+0000d980: 656e 642e 5f63 6f6e 6669 672e 5f64 6566  end._config._def
+0000d990: 6175 6c74 735b 276f 7074 5f6e 6f5f 6465  aults['opt_no_de
+0000d9a0: 6661 756c 7427 5d29 0a0a 2020 2020 6465  fault'])..    de
+0000d9b0: 6620 7465 7374 5f73 6574 5f6d 6f64 656c  f test_set_model
+0000d9c0: 5f6e 616d 6528 7365 6c66 293a 0a20 2020  _name(self):.   
+0000d9d0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0000d9e0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0000d9f0: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+0000da00: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+0000da10: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+0000da20: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
+0000da30: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0000da40: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0000da50: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
 0000da60: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
 0000da70: 745f 6d6f 6465 6c5f 6e61 6d65 2827 666f  t_model_name('fo
 0000da80: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
-0000da90: 2e61 7373 6572 7445 7175 616c 2868 6172  .assertEqual(har
-0000daa0: 6e65 7373 2e6d 6f64 656c 2e6e 616d 652c  ness.model.name,
-0000dab0: 2027 6261 7227 290a 0a20 2020 2064 6566   'bar')..    def
+0000da90: 2e61 7373 6572 7445 7175 616c 2827 666f  .assertEqual('fo
+0000daa0: 6f27 2c20 6861 726e 6573 732e 6d6f 6465  o', harness.mode
+0000dab0: 6c2e 6e61 6d65 290a 0a20 2020 2064 6566  l.name)..    def
 0000dac0: 2074 6573 745f 7365 745f 6d6f 6465 6c5f   test_set_model_
-0000dad0: 7575 6964 5f61 6674 6572 5f62 6567 696e  uuid_after_begin
+0000dad0: 6e61 6d65 5f61 6674 6572 5f62 6567 696e  name_after_begin
 0000dae0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000daf0: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-0000db00: 7328 4368 6172 6d42 6173 652c 206d 6574  s(CharmBase, met
-0000db10: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0000db20: 2020 6e61 6d65 3a20 7465 7374 2d63 6861    name: test-cha
-0000db30: 726d 0a20 2020 2020 2020 2027 2727 290a  rm.        ''').
-0000db40: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-0000db50: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-0000db60: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-0000db70: 2068 6172 6e65 7373 2e73 6574 5f6d 6f64   harness.set_mod
-0000db80: 656c 5f6e 616d 6528 2762 6172 2729 0a20  el_name('bar'). 
-0000db90: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
-0000dba0: 6574 5f6d 6f64 656c 5f75 7569 6428 2739  et_model_uuid('9
-0000dbb0: 3639 3537 6539 302d 6530 3036 2d31 3165  6957e90-e006-11e
-0000dbc0: 622d 6261 3830 2d30 3234 3261 6331 3330  b-ba80-0242ac130
-0000dbd0: 3030 3427 290a 2020 2020 2020 2020 6861  004').        ha
-0000dbe0: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-0000dbf0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000dc00: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-0000dc10: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-0000dc20: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-0000dc30: 7365 745f 6d6f 6465 6c5f 7575 6964 2827  set_model_uuid('
-0000dc40: 6166 3034 3739 6561 2d65 3030 362d 3131  af0479ea-e006-11
-0000dc50: 6562 2d62 6138 302d 3032 3432 6163 3133  eb-ba80-0242ac13
-0000dc60: 3030 3034 2729 0a20 2020 2020 2020 2073  0004').        s
-0000dc70: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000dc80: 6861 726e 6573 732e 6d6f 6465 6c2e 7575  harness.model.uu
-0000dc90: 6964 2c20 2739 3639 3537 6539 302d 6530  id, '96957e90-e0
-0000dca0: 3036 2d31 3165 622d 6261 3830 2d30 3234  06-11eb-ba80-024
-0000dcb0: 3261 6331 3330 3030 3427 290a 0a20 2020  2ac130004')..   
-0000dcc0: 2064 6566 2074 6573 745f 7365 745f 6d6f   def test_set_mo
-0000dcd0: 6465 6c5f 696e 666f 5f61 6674 6572 5f62  del_info_after_b
-0000dce0: 6567 696e 2873 656c 6629 3a0a 2020 2020  egin(self):.    
-0000dcf0: 2020 2020 6861 726e 6573 7320 3d20 4861      harness = Ha
-0000dd00: 726e 6573 7328 4368 6172 6d42 6173 652c  rness(CharmBase,
-0000dd10: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-0000dd20: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-0000dd30: 2d63 6861 726d 0a20 2020 2020 2020 2027  -charm.        '
-0000dd40: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-0000dd50: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-0000dd60: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-0000dd70: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-0000dd80: 5f6d 6f64 656c 5f69 6e66 6f28 2766 6f6f  _model_info('foo
-0000dd90: 272c 2027 3936 3935 3765 3930 2d65 3030  ', '96957e90-e00
-0000dda0: 362d 3131 6562 2d62 6138 302d 3032 3432  6-11eb-ba80-0242
-0000ddb0: 6163 3133 3030 3034 2729 0a20 2020 2020  ac130004').     
-0000ddc0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-0000ddd0: 2829 0a20 2020 2020 2020 2077 6974 6820  ().        with 
-0000dde0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000ddf0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
-0000de00: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-0000de10: 6e65 7373 2e73 6574 5f6d 6f64 656c 5f69  ness.set_model_i
-0000de20: 6e66 6f28 2762 6172 272c 2027 6166 3034  nfo('bar', 'af04
-0000de30: 3739 6561 2d65 3030 362d 3131 6562 2d62  79ea-e006-11eb-b
-0000de40: 6138 302d 3032 3432 6163 3133 3030 3034  a80-0242ac130004
-0000de50: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
-0000de60: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-0000de70: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
-0000de80: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-0000de90: 6e65 7373 2e73 6574 5f6d 6f64 656c 5f69  ness.set_model_i
-0000dea0: 6e66 6f28 2762 6172 2729 0a20 2020 2020  nfo('bar').     
-0000deb0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000dec0: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
-0000ded0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-0000dee0: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-0000def0: 5f6d 6f64 656c 5f69 6e66 6f28 7575 6964  _model_info(uuid
-0000df00: 3d27 6166 3034 3739 6561 2d65 3030 362d  ='af0479ea-e006-
-0000df10: 3131 6562 2d62 6138 302d 3032 3432 6163  11eb-ba80-0242ac
-0000df20: 3133 3030 3034 2729 0a20 2020 2020 2020  130004').       
-0000df30: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0000df40: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-0000df50: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000df60: 2020 2068 6172 6e65 7373 2e73 6574 5f6d     harness.set_m
-0000df70: 6f64 656c 5f6e 616d 6528 2762 6172 2729  odel_name('bar')
-0000df80: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0000df90: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0000dfa0: 5275 6e74 696d 6545 7272 6f72 293a 0a20  RuntimeError):. 
-0000dfb0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
-0000dfc0: 7373 2e73 6574 5f6d 6f64 656c 5f75 7569  ss.set_model_uui
-0000dfd0: 6428 2761 6630 3437 3965 612d 6530 3036  d('af0479ea-e006
-0000dfe0: 2d31 3165 622d 6261 3830 2d30 3234 3261  -11eb-ba80-0242a
-0000dff0: 6331 3330 3030 3427 290a 2020 2020 2020  c130004').      
-0000e000: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0000e010: 616c 2868 6172 6e65 7373 2e6d 6f64 656c  al(harness.model
-0000e020: 2e6e 616d 652c 2027 666f 6f27 290a 2020  .name, 'foo').  
-0000e030: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000e040: 7445 7175 616c 2868 6172 6e65 7373 2e6d  tEqual(harness.m
-0000e050: 6f64 656c 2e75 7569 642c 2027 3936 3935  odel.uuid, '9695
-0000e060: 3765 3930 2d65 3030 362d 3131 6562 2d62  7e90-e006-11eb-b
-0000e070: 6138 302d 3032 3432 6163 3133 3030 3034  a80-0242ac130004
-0000e080: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-0000e090: 5f61 6464 5f73 746f 7261 6765 5f62 6566  _add_storage_bef
-0000e0a0: 6f72 655f 6861 726e 6573 735f 6265 6769  ore_harness_begi
-0000e0b0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-0000e0c0: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-0000e0d0: 7373 2853 746f 7261 6765 5465 7374 6572  ss(StorageTester
-0000e0e0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0000e0f0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0000e100: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-0000e110: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
-0000e120: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-0000e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e140: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-0000e150: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-0000e160: 2073 746f 7261 6765 3a0a 2020 2020 2020   storage:.      
-0000e170: 2020 2020 2020 2020 2020 7465 7374 3a0a            test:.
-0000e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e190: 2020 2020 7479 7065 3a20 6669 6c65 7379      type: filesy
-0000e1a0: 7374 656d 0a20 2020 2020 2020 2020 2020  stem.           
-0000e1b0: 2020 2020 2020 2020 206d 756c 7469 706c           multipl
-0000e1c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000e1d0: 2020 2020 2020 2020 2020 2072 616e 6765             range
-0000e1e0: 3a20 312d 330a 2020 2020 2020 2020 2020  : 1-3.          
-0000e1f0: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-0000e200: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-0000e210: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-0000e220: 0a20 2020 2020 2020 2073 746f 725f 6964  .        stor_id
-0000e230: 7320 3d20 6861 726e 6573 732e 6164 645f  s = harness.add_
-0000e240: 7374 6f72 6167 6528 2274 6573 7422 2c20  storage("test", 
-0000e250: 636f 756e 743d 3329 0a20 2020 2020 2020  count=3).       
-0000e260: 2066 6f72 2073 2069 6e20 7374 6f72 5f69   for s in stor_i
-0000e270: 6473 3a0a 2020 2020 2020 2020 2020 2020  ds:.            
-0000e280: 2320 6265 666f 7265 2062 6567 696e 2c20  # before begin, 
-0000e290: 6164 6469 6e67 2073 746f 7261 6765 2064  adding storage d
-0000e2a0: 6f65 7320 6e6f 7420 6174 7461 6368 2069  oes not attach i
-0000e2b0: 742e 0a20 2020 2020 2020 2020 2020 2073  t..            s
-0000e2c0: 656c 662e 6173 7365 7274 4e6f 7449 6e28  elf.assertNotIn(
-0000e2d0: 732c 2068 6172 6e65 7373 2e5f 6261 636b  s, harness._back
-0000e2e0: 656e 642e 7374 6f72 6167 655f 6c69 7374  end.storage_list
-0000e2f0: 2822 7465 7374 2229 290a 0a20 2020 2020  ("test"))..     
-0000e300: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0000e310: 6572 7452 6169 7365 7328 6f70 732e 6d6f  ertRaises(ops.mo
-0000e320: 6465 6c2e 4d6f 6465 6c45 7272 6f72 293a  del.ModelError):
-0000e330: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-0000e340: 6e65 7373 2e5f 6261 636b 656e 642e 7374  ness._backend.st
-0000e350: 6f72 6167 655f 6765 7428 2274 6573 742f  orage_get("test/
-0000e360: 3022 2c20 226c 6f63 6174 696f 6e22 295b  0", "location")[
-0000e370: 2d36 3a5d 0a0a 2020 2020 6465 6620 7465  -6:]..    def te
-0000e380: 7374 5f61 6464 5f73 746f 7261 6765 5f74  st_add_storage_t
-0000e390: 6865 6e5f 6861 726e 6573 735f 6265 6769  hen_harness_begi
-0000e3a0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-0000e3b0: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-0000e3c0: 7373 2853 746f 7261 6765 5465 7374 6572  ss(StorageTester
-0000e3d0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-0000e3e0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-0000e3f0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-0000e400: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
-0000e410: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
-0000e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e430: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
-0000e440: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
-0000e450: 2073 746f 7261 6765 3a0a 2020 2020 2020   storage:.      
-0000e460: 2020 2020 2020 2020 2020 7465 7374 3a0a            test:.
-0000e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e480: 2020 2020 7479 7065 3a20 6669 6c65 7379      type: filesy
-0000e490: 7374 656d 0a20 2020 2020 2020 2020 2020  stem.           
-0000e4a0: 2020 2020 2020 2020 206d 756c 7469 706c           multipl
-0000e4b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000e4c0: 2020 2020 2020 2020 2020 2072 616e 6765             range
-0000e4d0: 3a20 312d 330a 2020 2020 2020 2020 2020  : 1-3.          
-0000e4e0: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-0000e4f0: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-0000e500: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-0000e510: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000e520: 2e61 6464 5f73 746f 7261 6765 2822 7465  .add_storage("te
-0000e530: 7374 222c 2063 6f75 6e74 3d33 290a 0a20  st", count=3).. 
-0000e540: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0000e550: 2e61 7373 6572 7452 6169 7365 7328 6f70  .assertRaises(op
-0000e560: 732e 6d6f 6465 6c2e 4d6f 6465 6c45 7272  s.model.ModelErr
-0000e570: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000e580: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
-0000e590: 642e 7374 6f72 6167 655f 6765 7428 2274  d.storage_get("t
-0000e5a0: 6573 742f 3022 2c20 226c 6f63 6174 696f  est/0", "locatio
-0000e5b0: 6e22 295b 2d36 3a5d 0a0a 2020 2020 2020  n")[-6:]..      
-0000e5c0: 2020 6861 726e 6573 732e 6265 6769 6e5f    harness.begin_
-0000e5d0: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
-0000e5e0: 6b73 2829 0a20 2020 2020 2020 2073 656c  ks().        sel
-0000e5f0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-0000e600: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
-0000e610: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
-0000e620: 2c20 3329 0a20 2020 2020 2020 2066 6f72  , 3).        for
-0000e630: 2069 2069 6e20 7261 6e67 6528 3329 3a0a   i in range(3):.
-0000e640: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000e650: 2e61 7373 6572 7454 7275 6528 6973 696e  .assertTrue(isin
-0000e660: 7374 616e 6365 2868 6172 6e65 7373 2e63  stance(harness.c
-0000e670: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
-0000e680: 656e 7473 5b69 5d2c 2053 746f 7261 6765  ents[i], Storage
-0000e690: 4174 7461 6368 6564 4576 656e 7429 290a  AttachedEvent)).
-0000e6a0: 0a20 2020 2020 2020 2077 616e 7420 3d20  .        want = 
-0000e6b0: 7374 7228 7061 7468 6c69 622e 5075 7265  str(pathlib.Pure
-0000e6c0: 5061 7468 2827 7465 7374 272c 2027 3027  Path('test', '0'
-0000e6d0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000e6e0: 6173 7365 7274 4571 7561 6c28 7761 6e74  assertEqual(want
-0000e6f0: 2c20 6861 726e 6573 732e 5f62 6163 6b65  , harness._backe
-0000e700: 6e64 2e73 746f 7261 6765 5f67 6574 2822  nd.storage_get("
-0000e710: 7465 7374 2f30 222c 2022 6c6f 6361 7469  test/0", "locati
-0000e720: 6f6e 2229 5b2d 363a 5d29 0a0a 2020 2020  on")[-6:])..    
-0000e730: 6465 6620 7465 7374 5f61 6464 5f73 746f  def test_add_sto
-0000e740: 7261 6765 5f6e 6f74 5f61 7474 6163 6865  rage_not_attache
-0000e750: 645f 6465 6661 756c 7428 7365 6c66 293a  d_default(self):
-0000e760: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000e770: 203d 2048 6172 6e65 7373 2843 6861 726d   = Harness(Charm
-0000e780: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-0000e790: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000e7a0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-0000e7b0: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
-0000e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e7d0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-0000e7e0: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-0000e7f0: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-0000e800: 2020 2020 2073 746f 7261 6765 3a0a 2020       storage:.  
-0000e810: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0000e820: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0000e830: 2020 2020 2020 2020 7479 7065 3a20 6669          type: fi
-0000e840: 6c65 7379 7374 656d 0a20 2020 2020 2020  lesystem.       
-0000e850: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0000e860: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0000e870: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0000e880: 7029 0a0a 2020 2020 2020 2020 6861 726e  p)..        harn
-0000e890: 6573 732e 6164 645f 7374 6f72 6167 6528  ess.add_storage(
-0000e8a0: 2774 6573 7427 290a 2020 2020 2020 2020  'test').        
-0000e8b0: 6861 726e 6573 732e 6265 6769 6e28 290a  harness.begin().
-0000e8c0: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
-0000e8d0: 656e 2868 6172 6e65 7373 2e6d 6f64 656c  en(harness.model
-0000e8e0: 2e73 746f 7261 6765 735b 2774 6573 7427  .storages['test'
-0000e8f0: 5d29 203d 3d20 302c 205c 0a20 2020 2020  ]) == 0, \.     
-0000e900: 2020 2020 2020 2027 7374 6f72 6167 6520         'storage 
-0000e910: 7368 6f75 6c64 2073 7461 7274 2069 6e20  should start in 
-0000e920: 6465 7461 6368 6564 2073 7461 7465 2061  detached state a
-0000e930: 6e64 2062 6520 6578 636c 7564 6564 2066  nd be excluded f
-0000e940: 726f 6d20 7374 6f72 6167 6520 6c69 7374  rom storage list
-0000e950: 696e 6727 0a0a 2020 2020 6465 6620 7465  ing'..    def te
-0000e960: 7374 5f61 6464 5f73 746f 7261 6765 5f77  st_add_storage_w
-0000e970: 6974 686f 7574 5f6d 6574 6164 6174 615f  ithout_metadata_
-0000e980: 6b65 795f 6661 696c 7328 7365 6c66 293a  key_fails(self):
-0000e990: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0000e9a0: 203d 2048 6172 6e65 7373 2843 6861 726d   = Harness(Charm
-0000e9b0: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-0000e9c0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000e9d0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-0000e9e0: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
+0000daf0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000db00: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0000db10: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0000db20: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000db30: 2020 6e61 6d65 3a20 7465 7374 2d63 6861    name: test-cha
+0000db40: 726d 0a20 2020 2020 2020 2027 2727 290a  rm.        ''').
+0000db50: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+0000db60: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+0000db70: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+0000db80: 2068 6172 6e65 7373 2e73 6574 5f6d 6f64   harness.set_mod
+0000db90: 656c 5f6e 616d 6528 2762 6172 2729 0a20  el_name('bar'). 
+0000dba0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+0000dbb0: 6567 696e 2829 0a20 2020 2020 2020 2077  egin().        w
+0000dbc0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000dbd0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
+0000dbe0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0000dbf0: 2068 6172 6e65 7373 2e73 6574 5f6d 6f64   harness.set_mod
+0000dc00: 656c 5f6e 616d 6528 2766 6f6f 2729 0a20  el_name('foo'). 
+0000dc10: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000dc20: 7274 4571 7561 6c28 6861 726e 6573 732e  rtEqual(harness.
+0000dc30: 6d6f 6465 6c2e 6e61 6d65 2c20 2762 6172  model.name, 'bar
+0000dc40: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
+0000dc50: 5f73 6574 5f6d 6f64 656c 5f75 7569 645f  _set_model_uuid_
+0000dc60: 6166 7465 725f 6265 6769 6e28 7365 6c66  after_begin(self
+0000dc70: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0000dc80: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000dc90: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+0000dca0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+0000dcb0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0000dcc0: 653a 2074 6573 742d 6368 6172 6d0a 2020  e: test-charm.  
+0000dcd0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+0000dce0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0000dcf0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+0000dd00: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+0000dd10: 6573 732e 7365 745f 6d6f 6465 6c5f 6e61  ess.set_model_na
+0000dd20: 6d65 2827 6261 7227 290a 2020 2020 2020  me('bar').      
+0000dd30: 2020 6861 726e 6573 732e 7365 745f 6d6f    harness.set_mo
+0000dd40: 6465 6c5f 7575 6964 2827 3936 3935 3765  del_uuid('96957e
+0000dd50: 3930 2d65 3030 362d 3131 6562 2d62 6138  90-e006-11eb-ba8
+0000dd60: 302d 3032 3432 6163 3133 3030 3034 2729  0-0242ac130004')
+0000dd70: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000dd80: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
+0000dd90: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+0000dda0: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
+0000ddb0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0000ddc0: 2020 2068 6172 6e65 7373 2e73 6574 5f6d     harness.set_m
+0000ddd0: 6f64 656c 5f75 7569 6428 2761 6630 3437  odel_uuid('af047
+0000dde0: 3965 612d 6530 3036 2d31 3165 622d 6261  9ea-e006-11eb-ba
+0000ddf0: 3830 2d30 3234 3261 6331 3330 3030 3427  80-0242ac130004'
+0000de00: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000de10: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
+0000de20: 7373 2e6d 6f64 656c 2e75 7569 642c 2027  ss.model.uuid, '
+0000de30: 3936 3935 3765 3930 2d65 3030 362d 3131  96957e90-e006-11
+0000de40: 6562 2d62 6138 302d 3032 3432 6163 3133  eb-ba80-0242ac13
+0000de50: 3030 3034 2729 0a0a 2020 2020 6465 6620  0004')..    def 
+0000de60: 7465 7374 5f73 6574 5f6d 6f64 656c 5f69  test_set_model_i
+0000de70: 6e66 6f5f 6166 7465 725f 6265 6769 6e28  nfo_after_begin(
+0000de80: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0000de90: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0000dea0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+0000deb0: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+0000dec0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+0000ded0: 206e 616d 653a 2074 6573 742d 6368 6172   name: test-char
+0000dee0: 6d0a 2020 2020 2020 2020 2727 2729 0a20  m.        '''). 
+0000def0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+0000df00: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+0000df10: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+0000df20: 6861 726e 6573 732e 7365 745f 6d6f 6465  harness.set_mode
+0000df30: 6c5f 696e 666f 2827 666f 6f27 2c20 2739  l_info('foo', '9
+0000df40: 3639 3537 6539 302d 6530 3036 2d31 3165  6957e90-e006-11e
+0000df50: 622d 6261 3830 2d30 3234 3261 6331 3330  b-ba80-0242ac130
+0000df60: 3030 3427 290a 2020 2020 2020 2020 6861  004').        ha
+0000df70: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+0000df80: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000df90: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+0000dfa0: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+0000dfb0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000dfc0: 7365 745f 6d6f 6465 6c5f 696e 666f 2827  set_model_info('
+0000dfd0: 6261 7227 2c20 2761 6630 3437 3965 612d  bar', 'af0479ea-
+0000dfe0: 6530 3036 2d31 3165 622d 6261 3830 2d30  e006-11eb-ba80-0
+0000dff0: 3234 3261 6331 3330 3030 3427 290a 2020  242ac130004').  
+0000e000: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000e010: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+0000e020: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+0000e030: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000e040: 7365 745f 6d6f 6465 6c5f 696e 666f 2827  set_model_info('
+0000e050: 6261 7227 290a 2020 2020 2020 2020 7769  bar').        wi
+0000e060: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0000e070: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+0000e080: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000e090: 6861 726e 6573 732e 7365 745f 6d6f 6465  harness.set_mode
+0000e0a0: 6c5f 696e 666f 2875 7569 643d 2761 6630  l_info(uuid='af0
+0000e0b0: 3437 3965 612d 6530 3036 2d31 3165 622d  479ea-e006-11eb-
+0000e0c0: 6261 3830 2d30 3234 3261 6331 3330 3030  ba80-0242ac13000
+0000e0d0: 3427 290a 2020 2020 2020 2020 7769 7468  4').        with
+0000e0e0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0000e0f0: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
+0000e100: 3a0a 2020 2020 2020 2020 2020 2020 6861  :.            ha
+0000e110: 726e 6573 732e 7365 745f 6d6f 6465 6c5f  rness.set_model_
+0000e120: 6e61 6d65 2827 6261 7227 290a 2020 2020  name('bar').    
+0000e130: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0000e140: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
+0000e150: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+0000e160: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
+0000e170: 745f 6d6f 6465 6c5f 7575 6964 2827 6166  t_model_uuid('af
+0000e180: 3034 3739 6561 2d65 3030 362d 3131 6562  0479ea-e006-11eb
+0000e190: 2d62 6138 302d 3032 3432 6163 3133 3030  -ba80-0242ac1300
+0000e1a0: 3034 2729 0a20 2020 2020 2020 2073 656c  04').        sel
+0000e1b0: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
+0000e1c0: 726e 6573 732e 6d6f 6465 6c2e 6e61 6d65  rness.model.name
+0000e1d0: 2c20 2766 6f6f 2729 0a20 2020 2020 2020  , 'foo').       
+0000e1e0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000e1f0: 6c28 6861 726e 6573 732e 6d6f 6465 6c2e  l(harness.model.
+0000e200: 7575 6964 2c20 2739 3639 3537 6539 302d  uuid, '96957e90-
+0000e210: 6530 3036 2d31 3165 622d 6261 3830 2d30  e006-11eb-ba80-0
+0000e220: 3234 3261 6331 3330 3030 3427 290a 0a20  242ac130004').. 
+0000e230: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
+0000e240: 7374 6f72 6167 655f 6265 666f 7265 5f68  storage_before_h
+0000e250: 6172 6e65 7373 5f62 6567 696e 2873 656c  arness_begin(sel
+0000e260: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+0000e270: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+0000e280: 672e 4861 726e 6573 7328 5374 6f72 6167  g.Harness(Storag
+0000e290: 6554 6573 7465 722c 206d 6574 613d 2727  eTester, meta=''
+0000e2a0: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+0000e2b0: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+0000e2c0: 2020 2020 2020 2020 2072 6571 7569 7265           require
+0000e2d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000e2e0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+0000e2f0: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+0000e300: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
+0000e310: 2020 2020 2020 2020 7374 6f72 6167 653a          storage:
+0000e320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e330: 2074 6573 743a 0a20 2020 2020 2020 2020   test:.         
+0000e340: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+0000e350: 2066 696c 6573 7973 7465 6d0a 2020 2020   filesystem.    
+0000e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e370: 6d75 6c74 6970 6c65 3a0a 2020 2020 2020  multiple:.      
+0000e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e390: 2020 7261 6e67 653a 2031 2d33 0a20 2020    range: 1-3.   
+0000e3a0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+0000e3b0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+0000e3c0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+0000e3d0: 6561 6e75 7029 0a0a 2020 2020 2020 2020  eanup)..        
+0000e3e0: 7374 6f72 5f69 6473 203d 2068 6172 6e65  stor_ids = harne
+0000e3f0: 7373 2e61 6464 5f73 746f 7261 6765 2822  ss.add_storage("
+0000e400: 7465 7374 222c 2063 6f75 6e74 3d33 290a  test", count=3).
+0000e410: 2020 2020 2020 2020 666f 7220 7320 696e          for s in
+0000e420: 2073 746f 725f 6964 733a 0a20 2020 2020   stor_ids:.     
+0000e430: 2020 2020 2020 2023 2062 6566 6f72 6520         # before 
+0000e440: 6265 6769 6e2c 2061 6464 696e 6720 7374  begin, adding st
+0000e450: 6f72 6167 6520 646f 6573 206e 6f74 2061  orage does not a
+0000e460: 7474 6163 6820 6974 2e0a 2020 2020 2020  ttach it..      
+0000e470: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000e480: 744e 6f74 496e 2873 2c20 6861 726e 6573  tNotIn(s, harnes
+0000e490: 732e 5f62 6163 6b65 6e64 2e73 746f 7261  s._backend.stora
+0000e4a0: 6765 5f6c 6973 7428 2274 6573 7422 2929  ge_list("test"))
+0000e4b0: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+0000e4c0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0000e4d0: 286f 7073 2e4d 6f64 656c 4572 726f 7229  (ops.ModelError)
+0000e4e0: 3a0a 2020 2020 2020 2020 2020 2020 6861  :.            ha
+0000e4f0: 726e 6573 732e 5f62 6163 6b65 6e64 2e73  rness._backend.s
+0000e500: 746f 7261 6765 5f67 6574 2822 7465 7374  torage_get("test
+0000e510: 2f30 222c 2022 6c6f 6361 7469 6f6e 2229  /0", "location")
+0000e520: 5b2d 363a 5d0a 0a20 2020 2064 6566 2074  [-6:]..    def t
+0000e530: 6573 745f 6164 645f 7374 6f72 6167 655f  est_add_storage_
+0000e540: 7468 656e 5f68 6172 6e65 7373 5f62 6567  then_harness_beg
+0000e550: 696e 2873 656c 6629 3a0a 2020 2020 2020  in(self):.      
+0000e560: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+0000e570: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+0000e580: 5374 6f72 6167 6554 6573 7465 722c 206d  StorageTester, m
+0000e590: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
+0000e5a0: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+0000e5b0: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
+0000e5c0: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
+0000e5d0: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
+0000e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5f0: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
+0000e600: 6c0a 2020 2020 2020 2020 2020 2020 7374  l.            st
+0000e610: 6f72 6167 653a 0a20 2020 2020 2020 2020  orage:.         
+0000e620: 2020 2020 2020 2074 6573 743a 0a20 2020         test:.   
+0000e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e640: 2074 7970 653a 2066 696c 6573 7973 7465   type: filesyste
+0000e650: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+0000e660: 2020 2020 2020 6d75 6c74 6970 6c65 3a0a        multiple:.
+0000e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e680: 2020 2020 2020 2020 7261 6e67 653a 2031          range: 1
+0000e690: 2d33 0a20 2020 2020 2020 2020 2020 2027  -3.            '
+0000e6a0: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+0000e6b0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0000e6c0: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
+0000e6d0: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
+0000e6e0: 645f 7374 6f72 6167 6528 2274 6573 7422  d_storage("test"
+0000e6f0: 2c20 636f 756e 743d 3329 0a0a 2020 2020  , count=3)..    
+0000e700: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0000e710: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+0000e720: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+0000e730: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0000e740: 5f62 6163 6b65 6e64 2e73 746f 7261 6765  _backend.storage
+0000e750: 5f67 6574 2822 7465 7374 2f30 222c 2022  _get("test/0", "
+0000e760: 6c6f 6361 7469 6f6e 2229 5b2d 363a 5d0a  location")[-6:].
+0000e770: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000e780: 2e62 6567 696e 5f77 6974 685f 696e 6974  .begin_with_init
+0000e790: 6961 6c5f 686f 6f6b 7328 290a 2020 2020  ial_hooks().    
+0000e7a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0000e7b0: 7175 616c 286c 656e 2868 6172 6e65 7373  qual(len(harness
+0000e7c0: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
+0000e7d0: 6576 656e 7473 292c 2033 290a 2020 2020  events), 3).    
+0000e7e0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000e7f0: 6765 2833 293a 0a20 2020 2020 2020 2020  ge(3):.         
+0000e800: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+0000e810: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
+0000e820: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+0000e830: 7276 6564 5f65 7665 6e74 735b 695d 2c20  rved_events[i], 
+0000e840: 6f70 732e 5374 6f72 6167 6541 7474 6163  ops.StorageAttac
+0000e850: 6865 6445 7665 6e74 2929 0a0a 2020 2020  hedEvent))..    
+0000e860: 2020 2020 7761 6e74 203d 2073 7472 2870      want = str(p
+0000e870: 6174 686c 6962 2e50 7572 6550 6174 6828  athlib.PurePath(
+0000e880: 2774 6573 7427 2c20 2730 2729 290a 2020  'test', '0')).  
+0000e890: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000e8a0: 7445 7175 616c 2877 616e 742c 2068 6172  tEqual(want, har
+0000e8b0: 6e65 7373 2e5f 6261 636b 656e 642e 7374  ness._backend.st
+0000e8c0: 6f72 6167 655f 6765 7428 2274 6573 742f  orage_get("test/
+0000e8d0: 3022 2c20 226c 6f63 6174 696f 6e22 295b  0", "location")[
+0000e8e0: 2d36 3a5d 290a 0a20 2020 2064 6566 2074  -6:])..    def t
+0000e8f0: 6573 745f 6164 645f 7374 6f72 6167 655f  est_add_storage_
+0000e900: 6e6f 745f 6174 7461 6368 6564 5f64 6566  not_attached_def
+0000e910: 6175 6c74 2873 656c 6629 3a0a 2020 2020  ault(self):.    
+0000e920: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0000e930: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0000e940: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0000e950: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0000e960: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+0000e970: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+0000e980: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+0000e990: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9b0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+0000e9c0: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+0000e9d0: 7374 6f72 6167 653a 0a20 2020 2020 2020  storage:.       
+0000e9e0: 2020 2020 2020 2020 2074 6573 743a 0a20           test:. 
 0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea00: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-0000ea10: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-0000ea20: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-0000ea30: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0000ea40: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0000ea50: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0000ea60: 7029 0a0a 2020 2020 2020 2020 7769 7468  p)..        with
-0000ea70: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000ea80: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-0000ea90: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
-0000eaa0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-0000eab0: 7374 6f72 6167 6528 2274 6573 7422 290a  storage("test").
-0000eac0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0000ead0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-0000eae0: 2020 2020 2020 636d 2e65 7863 6570 7469        cm.excepti
-0000eaf0: 6f6e 2e61 7267 735b 305d 2c0a 2020 2020  on.args[0],.    
-0000eb00: 2020 2020 2020 2020 2274 6865 206b 6579          "the key
-0000eb10: 2027 7465 7374 2720 6973 206e 6f74 2073   'test' is not s
-0000eb20: 7065 6369 6669 6564 2061 7320 6120 7374  pecified as a st
-0000eb30: 6f72 6167 6520 6b65 7920 696e 206d 6574  orage key in met
-0000eb40: 6164 6174 6122 290a 0a20 2020 2064 6566  adata")..    def
-0000eb50: 2074 6573 745f 6164 645f 7374 6f72 6167   test_add_storag
-0000eb60: 655f 6166 7465 725f 6861 726e 6573 735f  e_after_harness_
-0000eb70: 6265 6769 6e28 7365 6c66 293a 0a20 2020  begin(self):.   
-0000eb80: 2020 2020 2068 6172 6e65 7373 203d 2048       harness = H
-0000eb90: 6172 6e65 7373 2853 746f 7261 6765 5465  arness(StorageTe
-0000eba0: 7374 6572 2c20 6d65 7461 3d27 2727 0a20  ster, meta='''. 
-0000ebb0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000ebc0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-0000ebd0: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
+0000ea00: 2020 2074 7970 653a 2066 696c 6573 7973     type: filesys
+0000ea10: 7465 6d0a 2020 2020 2020 2020 2020 2020  tem.            
+0000ea20: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0000ea30: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0000ea40: 6e65 7373 2e63 6c65 616e 7570 290a 0a20  ness.cleanup).. 
+0000ea50: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
+0000ea60: 6464 5f73 746f 7261 6765 2827 7465 7374  dd_storage('test
+0000ea70: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+0000ea80: 7373 2e62 6567 696e 2829 0a20 2020 2020  ss.begin().     
+0000ea90: 2020 2061 7373 6572 7420 6c65 6e28 6861     assert len(ha
+0000eaa0: 726e 6573 732e 6d6f 6465 6c2e 7374 6f72  rness.model.stor
+0000eab0: 6167 6573 5b27 7465 7374 275d 2920 3d3d  ages['test']) ==
+0000eac0: 2030 2c20 5c0a 2020 2020 2020 2020 2020   0, \.          
+0000ead0: 2020 2773 746f 7261 6765 2073 686f 756c    'storage shoul
+0000eae0: 6420 7374 6172 7420 696e 2064 6574 6163  d start in detac
+0000eaf0: 6865 6420 7374 6174 6520 616e 6420 6265  hed state and be
+0000eb00: 2065 7863 6c75 6465 6420 6672 6f6d 2073   excluded from s
+0000eb10: 746f 7261 6765 206c 6973 7469 6e67 270a  torage listing'.
+0000eb20: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+0000eb30: 645f 7374 6f72 6167 655f 7769 7468 6f75  d_storage_withou
+0000eb40: 745f 6d65 7461 6461 7461 5f6b 6579 5f66  t_metadata_key_f
+0000eb50: 6169 6c73 2873 656c 6629 3a0a 2020 2020  ails(self):.    
+0000eb60: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0000eb70: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0000eb80: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0000eb90: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0000eba0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+0000ebb0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+0000ebc0: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+0000ebd0: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
 0000ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebf0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-0000ec00: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-0000ec10: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-0000ec20: 2020 2020 2073 746f 7261 6765 3a0a 2020       storage:.  
-0000ec30: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0000ec40: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0000ec50: 2020 2020 2020 2020 7479 7065 3a20 6669          type: fi
-0000ec60: 6c65 7379 7374 656d 0a20 2020 2020 2020  lesystem.       
-0000ec70: 2020 2020 2020 2020 2020 2020 206d 756c               mul
-0000ec80: 7469 706c 653a 0a20 2020 2020 2020 2020  tiple:.         
-0000ec90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000eca0: 616e 6765 3a20 312d 330a 2020 2020 2020  ange: 1-3.      
-0000ecb0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0000ecc0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0000ecd0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0000ece0: 7570 290a 0a20 2020 2020 2020 2023 2053  up)..        # S
-0000ecf0: 6574 2075 7020 696e 6974 6961 6c20 7374  et up initial st
-0000ed00: 6f72 6167 650a 2020 2020 2020 2020 6861  orage.        ha
-0000ed10: 726e 6573 732e 6164 645f 7374 6f72 6167  rness.add_storag
-0000ed20: 6528 2274 6573 7422 295b 305d 0a20 2020  e("test")[0].   
-0000ed30: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
-0000ed40: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
-0000ed50: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
-0000ed60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000ed70: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
-0000ed80: 726d 2e6f 6273 6572 7665 645f 6576 656e  rm.observed_even
-0000ed90: 7473 292c 2031 290a 2020 2020 2020 2020  ts), 1).        
-0000eda0: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-0000edb0: 6973 696e 7374 616e 6365 2868 6172 6e65  isinstance(harne
-0000edc0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
-0000edd0: 645f 6576 656e 7473 5b30 5d2c 2053 746f  d_events[0], Sto
-0000ede0: 7261 6765 4174 7461 6368 6564 4576 656e  rageAttachedEven
-0000edf0: 7429 290a 0a20 2020 2020 2020 2023 2041  t))..        # A
-0000ee00: 6464 2061 6464 6974 696f 6e61 6c20 7374  dd additional st
-0000ee10: 6f72 6167 650a 2020 2020 2020 2020 7374  orage.        st
-0000ee20: 6f72 5f69 6473 203d 2068 6172 6e65 7373  or_ids = harness
-0000ee30: 2e61 6464 5f73 746f 7261 6765 2822 7465  .add_storage("te
-0000ee40: 7374 222c 2063 6f75 6e74 3d33 2c20 6174  st", count=3, at
-0000ee50: 7461 6368 3d54 7275 6529 0a20 2020 2020  tach=True).     
-0000ee60: 2020 2023 204e 4f54 453a 2073 746f 725f     # NOTE: stor_
-0000ee70: 6964 206e 6f77 2072 6566 6c65 6374 7320  id now reflects 
-0000ee80: 7468 6520 3474 6820 4944 2e20 2054 6865  the 4th ID.  The
-0000ee90: 2032 6e64 2061 6e64 2033 7264 2049 4473   2nd and 3rd IDs
-0000eea0: 2061 7265 2063 7265 6174 6564 2061 6e64   are created and
-0000eeb0: 0a20 2020 2020 2020 2023 2075 7365 642c  .        # used,
-0000eec0: 2062 7574 206e 6f74 2072 6574 7572 6e65   but not returne
-0000eed0: 6420 6279 2048 6172 6e65 7373 2e61 6464  d by Harness.add
-0000eee0: 5f73 746f 7261 6765 2e0a 2020 2020 2020  _storage..      
-0000eef0: 2020 2320 2853 686f 756c 6420 7765 2063    # (Should we c
-0000ef00: 6f6e 7369 6465 7220 6368 616e 6769 6e67  onsider changing
-0000ef10: 2069 7473 2072 6574 7572 6e20 7479 7065   its return type
-0000ef20: 3f29 0a0a 2020 2020 2020 2020 6164 6465  ?)..        adde
-0000ef30: 645f 696e 6469 6365 7320 3d20 7b73 656c  d_indices = {sel
-0000ef40: 662e 5f65 7874 7261 6374 5f73 746f 7261  f._extract_stora
-0000ef50: 6765 5f69 6e64 6578 2873 746f 725f 6964  ge_index(stor_id
-0000ef60: 2920 666f 7220 7374 6f72 5f69 6420 696e  ) for stor_id in
-0000ef70: 2073 746f 725f 6964 737d 0a20 2020 2020   stor_ids}.     
-0000ef80: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-0000ef90: 7565 2861 6464 6564 5f69 6e64 6963 6573  ue(added_indices
-0000efa0: 2e69 7373 7562 7365 7428 7365 7428 6861  .issubset(set(ha
-0000efb0: 726e 6573 732e 5f62 6163 6b65 6e64 2e73  rness._backend.s
-0000efc0: 746f 7261 6765 5f6c 6973 7428 2274 6573  torage_list("tes
-0000efd0: 7422 2929 2929 0a0a 2020 2020 2020 2020  t"))))..        
-0000efe0: 666f 7220 6920 696e 205b 2731 272c 2027  for i in ['1', '
-0000eff0: 3227 2c20 2733 275d 3a0a 2020 2020 2020  2', '3']:.      
-0000f000: 2020 2020 2020 7374 6f72 6167 655f 6e61        storage_na
-0000f010: 6d65 203d 2066 2274 6573 742f 7b69 7d22  me = f"test/{i}"
-0000f020: 0a20 2020 2020 2020 2020 2020 2077 616e  .            wan
-0000f030: 7420 3d20 7374 7228 7061 7468 6c69 622e  t = str(pathlib.
-0000f040: 5075 7265 5061 7468 2827 7465 7374 272c  PurePath('test',
-0000f050: 2069 2929 0a20 2020 2020 2020 2020 2020   i)).           
-0000f060: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-0000f070: 2868 6172 6e65 7373 2e5f 6261 636b 656e  (harness._backen
-0000f080: 642e 7374 6f72 6167 655f 6765 7428 7374  d.storage_get(st
-0000f090: 6f72 6167 655f 6e61 6d65 2c20 226c 6f63  orage_name, "loc
-0000f0a0: 6174 696f 6e22 292e 656e 6473 7769 7468  ation").endswith
-0000f0b0: 2877 616e 7429 290a 2020 2020 2020 2020  (want)).        
-0000f0c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0000f0d0: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
-0000f0e0: 726d 2e6f 6273 6572 7665 645f 6576 656e  rm.observed_even
-0000f0f0: 7473 292c 2034 290a 2020 2020 2020 2020  ts), 4).        
-0000f100: 666f 7220 6920 696e 2072 616e 6765 2831  for i in range(1
-0000f110: 2c20 3429 3a0a 2020 2020 2020 2020 2020  , 4):.          
-0000f120: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-0000f130: 6528 6973 696e 7374 616e 6365 2868 6172  e(isinstance(har
-0000f140: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
-0000f150: 7665 645f 6576 656e 7473 5b69 5d2c 2053  ved_events[i], S
-0000f160: 746f 7261 6765 4174 7461 6368 6564 4576  torageAttachedEv
-0000f170: 656e 7429 290a 0a20 2020 2064 6566 2074  ent))..    def t
-0000f180: 6573 745f 6465 7461 6368 5f73 746f 7261  est_detach_stora
-0000f190: 6765 2873 656c 6629 3a0a 2020 2020 2020  ge(self):.      
-0000f1a0: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-0000f1b0: 6573 7328 5374 6f72 6167 6554 6573 7465  ess(StorageTeste
-0000f1c0: 722c 206d 6574 613d 2727 270a 2020 2020  r, meta='''.    
-0000f1d0: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-0000f1e0: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
-0000f1f0: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
-0000f200: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-0000f210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f220: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-0000f230: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
-0000f240: 2020 7374 6f72 6167 653a 0a20 2020 2020    storage:.     
-0000f250: 2020 2020 2020 2020 2020 2074 6573 743a             test:
-0000f260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f270: 2020 2020 2074 7970 653a 2066 696c 6573       type: files
-0000f280: 7973 7465 6d0a 2020 2020 2020 2020 2020  ystem.          
-0000f290: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-0000f2a0: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-0000f2b0: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-0000f2c0: 0a20 2020 2020 2020 2023 2053 6574 2075  .        # Set u
-0000f2d0: 7020 696e 6974 6961 6c20 7374 6f72 6167  p initial storag
-0000f2e0: 650a 2020 2020 2020 2020 7374 6f72 5f69  e.        stor_i
-0000f2f0: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
-0000f300: 7374 6f72 6167 6528 2274 6573 7422 295b  storage("test")[
-0000f310: 305d 0a20 2020 2020 2020 2068 6172 6e65  0].        harne
-0000f320: 7373 2e62 6567 696e 5f77 6974 685f 696e  ss.begin_with_in
-0000f330: 6974 6961 6c5f 686f 6f6b 7328 290a 2020  itial_hooks().  
-0000f340: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f350: 7445 7175 616c 286c 656e 2868 6172 6e65  tEqual(len(harne
-0000f360: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
-0000f370: 645f 6576 656e 7473 292c 2031 290a 2020  d_events), 1).  
-0000f380: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0000f390: 7454 7275 6528 6973 696e 7374 616e 6365  tTrue(isinstance
-0000f3a0: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
-0000f3b0: 6273 6572 7665 645f 6576 656e 7473 5b30  bserved_events[0
-0000f3c0: 5d2c 2053 746f 7261 6765 4174 7461 6368  ], StorageAttach
-0000f3d0: 6564 4576 656e 7429 290a 0a20 2020 2020  edEvent))..     
-0000f3e0: 2020 2023 2044 6574 6163 6820 7374 6f72     # Detach stor
-0000f3f0: 6167 650a 2020 2020 2020 2020 6861 726e  age.        harn
-0000f400: 6573 732e 6465 7461 6368 5f73 746f 7261  ess.detach_stora
-0000f410: 6765 2873 746f 725f 6964 290a 2020 2020  ge(stor_id).    
-0000f420: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0000f430: 7175 616c 286c 656e 2868 6172 6e65 7373  qual(len(harness
-0000f440: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
-0000f450: 6576 656e 7473 292c 2032 290a 2020 2020  events), 2).    
-0000f460: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-0000f470: 7275 6528 6973 696e 7374 616e 6365 2868  rue(isinstance(h
-0000f480: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
-0000f490: 6572 7665 645f 6576 656e 7473 5b31 5d2c  erved_events[1],
-0000f4a0: 2053 746f 7261 6765 4465 7461 6368 696e   StorageDetachin
-0000f4b0: 6745 7665 6e74 2929 0a0a 2020 2020 2020  gEvent))..      
-0000f4c0: 2020 2320 5665 7269 6679 2062 6163 6b65    # Verify backe
-0000f4d0: 6e64 2066 756e 6374 696f 6e73 2072 6574  nd functions ret
-0000f4e0: 7572 6e20 6170 7072 6f70 7269 6174 6520  urn appropriate 
-0000f4f0: 7661 6c75 6573 2e0a 2020 2020 2020 2020  values..        
-0000f500: 2320 5265 616c 2062 6163 6b65 6e64 2077  # Real backend w
-0000f510: 6f75 6c64 2072 6574 7572 6e20 696e 666f  ould return info
-0000f520: 206f 6e6c 7920 666f 7220 6163 7469 7665   only for active
-0000f530: 6c79 2061 7474 6163 6865 6420 7374 6f72  ly attached stor
-0000f540: 6167 6520 756e 6974 732e 0a20 2020 2020  age units..     
-0000f550: 2020 2073 656c 662e 6173 7365 7274 4e6f     self.assertNo
-0000f560: 7449 6e28 7374 6f72 5f69 642c 2068 6172  tIn(stor_id, har
-0000f570: 6e65 7373 2e5f 6261 636b 656e 642e 7374  ness._backend.st
-0000f580: 6f72 6167 655f 6c69 7374 2822 7465 7374  orage_list("test
-0000f590: 2229 290a 2020 2020 2020 2020 7769 7468  ")).        with
-0000f5a0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0000f5b0: 6573 284d 6f64 656c 4572 726f 7229 2061  es(ModelError) a
-0000f5c0: 7320 636d 3a0a 2020 2020 2020 2020 2020  s cm:.          
-0000f5d0: 2020 6861 726e 6573 732e 5f62 6163 6b65    harness._backe
-0000f5e0: 6e64 2e73 746f 7261 6765 5f67 6574 2822  nd.storage_get("
-0000f5f0: 7465 7374 2f30 222c 2022 6c6f 6361 7469  test/0", "locati
-0000f600: 6f6e 2229 0a20 2020 2020 2020 2023 2045  on").        # E
-0000f610: 7272 6f72 206d 6573 7361 6765 206d 6f64  rror message mod
-0000f620: 656c 6564 2061 6674 6572 206f 7574 7075  eled after outpu
-0000f630: 7420 6f66 0a20 2020 2020 2020 2023 2022  t of.        # "
-0000f640: 7374 6f72 6167 652d 6765 7420 2d73 203c  storage-get -s <
-0000f650: 696e 7661 6c69 642f 696e 6163 7469 7665  invalid/inactive
-0000f660: 2069 643e 206c 6f63 6174 696f 6e22 206f   id> location" o
-0000f670: 6e20 7265 616c 2064 6570 6c6f 796d 656e  n real deploymen
-0000f680: 740a 2020 2020 2020 2020 7365 6c66 2e61  t.        self.a
-0000f690: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-0000f6a0: 2020 2020 2020 2020 636d 2e65 7863 6570          cm.excep
-0000f6b0: 7469 6f6e 2e61 7267 735b 305d 2c0a 2020  tion.args[0],.  
-0000f6c0: 2020 2020 2020 2020 2020 2745 5252 4f52            'ERROR
-0000f6d0: 2069 6e76 616c 6964 2076 616c 7565 2022   invalid value "
-0000f6e0: 7465 7374 2f30 2220 666f 7220 6f70 7469  test/0" for opti
-0000f6f0: 6f6e 202d 733a 2073 746f 7261 6765 206e  on -s: storage n
-0000f700: 6f74 2066 6f75 6e64 2729 0a0a 2020 2020  ot found')..    
-0000f710: 2020 2020 2320 5265 7472 7920 6465 7461      # Retry deta
-0000f720: 6368 0a20 2020 2020 2020 2023 2053 696e  ch.        # Sin
-0000f730: 6365 2061 6c72 6561 6479 2064 6574 6163  ce already detac
-0000f740: 6865 642c 206e 6f20 6d6f 7265 2068 6f6f  hed, no more hoo
-0000f750: 6b73 2073 686f 756c 6420 6669 7265 0a20  ks should fire. 
-0000f760: 2020 2020 2020 2068 6172 6e65 7373 2e64         harness.d
-0000f770: 6574 6163 685f 7374 6f72 6167 6528 7374  etach_storage(st
-0000f780: 6f72 5f69 6429 0a20 2020 2020 2020 2073  or_id).        s
-0000f790: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0000f7a0: 6c65 6e28 6861 726e 6573 732e 6368 6172  len(harness.char
-0000f7b0: 6d2e 6f62 7365 7276 6564 5f65 7665 6e74  m.observed_event
-0000f7c0: 7329 2c20 3229 0a20 2020 2020 2020 2073  s), 2).        s
-0000f7d0: 656c 662e 6173 7365 7274 5472 7565 2869  elf.assertTrue(i
-0000f7e0: 7369 6e73 7461 6e63 6528 6861 726e 6573  sinstance(harnes
-0000f7f0: 732e 6368 6172 6d2e 6f62 7365 7276 6564  s.charm.observed
-0000f800: 5f65 7665 6e74 735b 315d 2c20 5374 6f72  _events[1], Stor
-0000f810: 6167 6544 6574 6163 6869 6e67 4576 656e  ageDetachingEven
-0000f820: 7429 290a 0a20 2020 2064 6566 2074 6573  t))..    def tes
-0000f830: 745f 6465 7461 6368 5f73 746f 7261 6765  t_detach_storage
-0000f840: 5f62 6566 6f72 655f 6861 726e 6573 735f  _before_harness_
-0000f850: 6265 6769 6e28 7365 6c66 293a 0a20 2020  begin(self):.   
-0000f860: 2020 2020 2068 6172 6e65 7373 203d 2048       harness = H
-0000f870: 6172 6e65 7373 2853 746f 7261 6765 5465  arness(StorageTe
-0000f880: 7374 6572 2c20 6d65 7461 3d27 2727 0a20  ster, meta='''. 
-0000f890: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0000f8a0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-0000f8b0: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
-0000f8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8d0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-0000f8e0: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-0000f8f0: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-0000f900: 2020 2020 2073 746f 7261 6765 3a0a 2020       storage:.  
-0000f910: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0000f920: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0000f930: 2020 2020 2020 2020 7479 7065 3a20 6669          type: fi
-0000f940: 6c65 7379 7374 656d 0a20 2020 2020 2020  lesystem.       
-0000f950: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0000f960: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0000f970: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0000f980: 7029 0a0a 2020 2020 2020 2020 7374 6f72  p)..        stor
-0000f990: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-0000f9a0: 645f 7374 6f72 6167 6528 2274 6573 7422  d_storage("test"
-0000f9b0: 295b 305d 0a20 2020 2020 2020 2077 6974  )[0].        wit
-0000f9c0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0000f9d0: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
-0000f9e0: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
-0000f9f0: 2020 2020 2068 6172 6e65 7373 2e64 6574       harness.det
-0000fa00: 6163 685f 7374 6f72 6167 6528 6622 7465  ach_storage(f"te
-0000fa10: 7374 2f7b 7374 6f72 5f69 647d 2229 0a20  st/{stor_id}"). 
-0000fa20: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0000fa30: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
-0000fa40: 7469 6f6e 2e61 7267 735b 305d 2c0a 2020  tion.args[0],.  
-0000fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa60: 2020 2020 2020 2022 6361 6e6e 6f74 2064         "cannot d
-0000fa70: 6574 6163 6820 7374 6f72 6167 6520 6265  etach storage be
-0000fa80: 666f 7265 2048 6172 6e65 7373 2069 7320  fore Harness is 
-0000fa90: 696e 6974 6961 6c69 7365 6422 290a 0a20  initialised").. 
-0000faa0: 2020 2064 6566 2074 6573 745f 7374 6f72     def test_stor
-0000fab0: 6167 655f 7769 7468 5f68 7970 6865 6e73  age_with_hyphens
-0000fac0: 5f77 6f72 6b73 2873 656c 6629 3a0a 2020  _works(self):.  
-0000fad0: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
-0000fae0: 4861 726e 6573 7328 5374 6f72 6167 6554  Harness(StorageT
-0000faf0: 6573 7465 722c 206d 6574 613d 2727 270a  ester, meta='''.
-0000fb00: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000fb10: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-0000fb20: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-0000fb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fb40: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
-0000fb50: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-0000fb60: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
-0000fb70: 2020 2020 2020 7374 6f72 6167 653a 0a20        storage:. 
-0000fb80: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000fb90: 6573 743a 0a20 2020 2020 2020 2020 2020  est:.           
-0000fba0: 2020 2020 2020 2020 2074 7970 653a 2066           type: f
-0000fbb0: 696c 6573 7973 7465 6d0a 2020 2020 2020  ilesystem.      
-0000fbc0: 2020 2020 2020 2020 2020 7465 7374 2d77            test-w
-0000fbd0: 6974 682d 6879 7068 656e 733a 0a20 2020  ith-hyphens:.   
-0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbf0: 2074 7970 653a 2066 696c 6573 7973 7465   type: filesyste
-0000fc00: 6d0a 2020 2020 2020 2020 2020 2020 2727  m.            ''
-0000fc10: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0000fc20: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-0000fc30: 7373 2e63 6c65 616e 7570 290a 0a20 2020  ss.cleanup)..   
-0000fc40: 2020 2020 2023 2053 6574 2075 7020 696e       # Set up in
-0000fc50: 6974 6961 6c20 7374 6f72 6167 650a 2020  itial storage.  
-0000fc60: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-0000fc70: 6769 6e28 290a 2020 2020 2020 2020 6865  gin().        he
-0000fc80: 6c70 6572 203d 2053 746f 7261 6765 5769  lper = StorageWi
-0000fc90: 7468 4879 7068 656e 7348 656c 7065 7228  thHyphensHelper(
-0000fca0: 6861 726e 6573 732e 6368 6172 6d2c 2022  harness.charm, "
-0000fcb0: 6865 6c70 6572 2229 0a20 2020 2020 2020  helper").       
-0000fcc0: 2068 6172 6e65 7373 2e61 6464 5f73 746f   harness.add_sto
-0000fcd0: 7261 6765 2822 7465 7374 2d77 6974 682d  rage("test-with-
-0000fce0: 6879 7068 656e 7322 2c20 6174 7461 6368  hyphens", attach
-0000fcf0: 3d54 7275 6529 5b30 5d0a 0a20 2020 2020  =True)[0]..     
-0000fd00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0000fd10: 7561 6c28 6c65 6e28 6865 6c70 6572 2e63  ual(len(helper.c
-0000fd20: 6861 6e67 6573 292c 2031 290a 0a20 2020  hanges), 1)..   
-0000fd30: 2064 6566 2074 6573 745f 6174 7461 6368   def test_attach
-0000fd40: 5f73 746f 7261 6765 2873 656c 6629 3a0a  _storage(self):.
-0000fd50: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-0000fd60: 3d20 4861 726e 6573 7328 5374 6f72 6167  = Harness(Storag
-0000fd70: 6554 6573 7465 722c 206d 6574 613d 2727  eTester, meta=''
-0000fd80: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-0000fd90: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-0000fda0: 2020 2020 2020 2020 2072 6571 7569 7265           require
-0000fdb0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000fdc0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-0000fdd0: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-0000fde0: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
-0000fdf0: 2020 2020 2020 2020 7374 6f72 6167 653a          storage:
-0000fe00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fe10: 2074 6573 743a 0a20 2020 2020 2020 2020   test:.         
-0000fe20: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-0000fe30: 2066 696c 6573 7973 7465 6d0a 2020 2020   filesystem.    
-0000fe40: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-0000fe50: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0000fe60: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0000fe70: 616e 7570 290a 0a20 2020 2020 2020 2023  anup)..        #
-0000fe80: 2053 6574 2075 7020 696e 6974 6961 6c20   Set up initial 
-0000fe90: 7374 6f72 6167 650a 2020 2020 2020 2020  storage.        
-0000fea0: 7374 6f72 5f69 6420 3d20 6861 726e 6573  stor_id = harnes
-0000feb0: 732e 6164 645f 7374 6f72 6167 6528 2274  s.add_storage("t
-0000fec0: 6573 7422 295b 305d 0a20 2020 2020 2020  est")[0].       
-0000fed0: 2068 6172 6e65 7373 2e62 6567 696e 5f77   harness.begin_w
-0000fee0: 6974 685f 696e 6974 6961 6c5f 686f 6f6b  ith_initial_hook
-0000fef0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-0000ff00: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-0000ff10: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
-0000ff20: 6273 6572 7665 645f 6576 656e 7473 292c  bserved_events),
-0000ff30: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
-0000ff40: 2e61 7373 6572 7454 7275 6528 6973 696e  .assertTrue(isin
-0000ff50: 7374 616e 6365 2868 6172 6e65 7373 2e63  stance(harness.c
-0000ff60: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
-0000ff70: 656e 7473 5b30 5d2c 2053 746f 7261 6765  ents[0], Storage
-0000ff80: 4174 7461 6368 6564 4576 656e 7429 290a  AttachedEvent)).
-0000ff90: 0a20 2020 2020 2020 2023 2044 6574 6163  .        # Detac
-0000ffa0: 6820 7374 6f72 6167 650a 2020 2020 2020  h storage.      
-0000ffb0: 2020 6861 726e 6573 732e 6465 7461 6368    harness.detach
-0000ffc0: 5f73 746f 7261 6765 2873 746f 725f 6964  _storage(stor_id
-0000ffd0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0000ffe0: 7373 6572 7445 7175 616c 286c 656e 2868  ssertEqual(len(h
-0000fff0: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
-00010000: 6572 7665 645f 6576 656e 7473 292c 2032  erved_events), 2
-00010010: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00010020: 7373 6572 7454 7275 6528 6973 696e 7374  ssertTrue(isinst
-00010030: 616e 6365 2868 6172 6e65 7373 2e63 6861  ance(harness.cha
-00010040: 726d 2e6f 6273 6572 7665 645f 6576 656e  rm.observed_even
-00010050: 7473 5b31 5d2c 2053 746f 7261 6765 4465  ts[1], StorageDe
-00010060: 7461 6368 696e 6745 7665 6e74 2929 0a0a  tachingEvent))..
-00010070: 2020 2020 2020 2020 2320 5265 2d61 7474          # Re-att
-00010080: 6163 6820 7374 6f72 6167 650a 2020 2020  ach storage.    
-00010090: 2020 2020 6861 726e 6573 732e 6174 7461      harness.atta
-000100a0: 6368 5f73 746f 7261 6765 2873 746f 725f  ch_storage(stor_
-000100b0: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
-000100c0: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
-000100d0: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
-000100e0: 6273 6572 7665 645f 6576 656e 7473 292c  bserved_events),
-000100f0: 2033 290a 2020 2020 2020 2020 7365 6c66   3).        self
-00010100: 2e61 7373 6572 7454 7275 6528 6973 696e  .assertTrue(isin
-00010110: 7374 616e 6365 2868 6172 6e65 7373 2e63  stance(harness.c
-00010120: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
-00010130: 656e 7473 5b32 5d2c 2053 746f 7261 6765  ents[2], Storage
-00010140: 4174 7461 6368 6564 4576 656e 7429 290a  AttachedEvent)).
-00010150: 0a20 2020 2020 2020 2023 2056 6572 6966  .        # Verif
-00010160: 7920 6261 636b 656e 6420 6675 6e63 7469  y backend functi
-00010170: 6f6e 7320 7265 7475 726e 2061 7070 726f  ons return appro
-00010180: 7072 6961 7465 2076 616c 7565 732e 0a20  priate values.. 
-00010190: 2020 2020 2020 2023 2052 6561 6c20 6261         # Real ba
-000101a0: 636b 656e 6420 776f 756c 6420 7265 7475  ckend would retu
-000101b0: 726e 2069 6e66 6f20 6f6e 6c79 2066 6f72  rn info only for
-000101c0: 2061 6374 6976 656c 7920 6174 7461 6368   actively attach
-000101d0: 6564 2073 746f 7261 6765 2075 6e69 7473  ed storage units
-000101e0: 2e0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-000101f0: 7373 6572 7449 6e28 7365 6c66 2e5f 6578  ssertIn(self._ex
-00010200: 7472 6163 745f 7374 6f72 6167 655f 696e  tract_storage_in
-00010210: 6465 7828 7374 6f72 5f69 6429 2c20 6861  dex(stor_id), ha
-00010220: 726e 6573 732e 5f62 6163 6b65 6e64 2e73  rness._backend.s
-00010230: 746f 7261 6765 5f6c 6973 7428 2274 6573  torage_list("tes
-00010240: 7422 2929 0a20 2020 2020 2020 2077 616e  t")).        wan
-00010250: 7420 3d20 7374 7228 7061 7468 6c69 622e  t = str(pathlib.
-00010260: 5075 7265 5061 7468 2827 7465 7374 272c  PurePath('test',
-00010270: 2027 3027 2929 0a20 2020 2020 2020 2073   '0')).        s
-00010280: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00010290: 7761 6e74 2c20 6861 726e 6573 732e 5f62  want, harness._b
-000102a0: 6163 6b65 6e64 2e73 746f 7261 6765 5f67  ackend.storage_g
-000102b0: 6574 2822 7465 7374 2f30 222c 2022 6c6f  et("test/0", "lo
-000102c0: 6361 7469 6f6e 2229 5b2d 363a 5d29 0a0a  cation")[-6:])..
-000102d0: 2020 2020 2020 2020 2320 5265 7472 7920          # Retry 
-000102e0: 6174 7461 6368 0a20 2020 2020 2020 2023  attach.        #
-000102f0: 2053 696e 6365 2061 6c72 6561 6479 2064   Since already d
-00010300: 6574 6163 6865 642c 206e 6f20 6d6f 7265  etached, no more
-00010310: 2068 6f6f 6b73 2073 686f 756c 6420 6669   hooks should fi
-00010320: 7265 0a20 2020 2020 2020 2068 6172 6e65  re.        harne
-00010330: 7373 2e61 7474 6163 685f 7374 6f72 6167  ss.attach_storag
-00010340: 6528 7374 6f72 5f69 6429 0a20 2020 2020  e(stor_id).     
-00010350: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00010360: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
-00010370: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-00010380: 7665 6e74 7329 2c20 3329 0a20 2020 2020  vents), 3).     
-00010390: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-000103a0: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
-000103b0: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-000103c0: 7276 6564 5f65 7665 6e74 735b 325d 2c20  rved_events[2], 
-000103d0: 5374 6f72 6167 6541 7474 6163 6865 6445  StorageAttachedE
-000103e0: 7665 6e74 2929 0a0a 2020 2020 6465 6620  vent))..    def 
-000103f0: 7465 7374 5f61 7474 6163 685f 7374 6f72  test_attach_stor
-00010400: 6167 655f 6265 666f 7265 5f68 6172 6e65  age_before_harne
-00010410: 7373 5f62 6567 696e 2873 656c 6629 3a0a  ss_begin(self):.
-00010420: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00010430: 3d20 4861 726e 6573 7328 5374 6f72 6167  = Harness(Storag
-00010440: 6554 6573 7465 722c 206d 6574 613d 2727  eTester, meta=''
-00010450: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-00010460: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-00010470: 2020 2020 2020 2020 2072 6571 7569 7265           require
-00010480: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00010490: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-000104a0: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-000104b0: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
-000104c0: 2020 2020 2020 2020 7374 6f72 6167 653a          storage:
-000104d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000104e0: 2074 6573 743a 0a20 2020 2020 2020 2020   test:.         
-000104f0: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-00010500: 2066 696c 6573 7973 7465 6d0a 2020 2020   filesystem.    
-00010510: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00010520: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00010530: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00010540: 616e 7570 290a 0a20 2020 2020 2020 2023  anup)..        #
-00010550: 2057 6520 6465 6c69 6265 7261 7465 6c79   We deliberately
-00010560: 2064 6f6e 2774 2067 7561 7264 2061 6761   don't guard aga
-00010570: 696e 7374 2061 7474 6163 6869 6e67 2073  inst attaching s
-00010580: 746f 7261 6765 2062 6566 6f72 6520 7468  torage before th
-00010590: 6520 6861 726e 6573 7320 6265 6769 6e73  e harness begins
-000105a0: 2c0a 2020 2020 2020 2020 2320 6173 2074  ,.        # as t
-000105b0: 6865 7265 2061 7265 206c 6567 6974 696d  here are legitim
-000105c0: 6174 6520 7265 6173 6f6e 7320 746f 2064  ate reasons to d
-000105d0: 6f20 736f 2e0a 2020 2020 2020 2020 7374  o so..        st
-000105e0: 6f72 5f69 6420 3d20 6861 726e 6573 732e  or_id = harness.
-000105f0: 6164 645f 7374 6f72 6167 6528 2274 6573  add_storage("tes
-00010600: 7422 295b 305d 0a20 2020 2020 2020 2073  t")[0].        s
-00010610: 656c 662e 6173 7365 7274 5472 7565 2873  elf.assertTrue(s
-00010620: 746f 725f 6964 290a 0a20 2020 2064 6566  tor_id)..    def
-00010630: 2074 6573 745f 7265 6d6f 7665 5f73 746f   test_remove_sto
-00010640: 7261 6765 5f62 6566 6f72 655f 6861 726e  rage_before_harn
-00010650: 6573 735f 6265 6769 6e28 7365 6c66 293a  ess_begin(self):
-00010660: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00010670: 203d 2048 6172 6e65 7373 2853 746f 7261   = Harness(Stora
-00010680: 6765 5465 7374 6572 2c20 6d65 7461 3d27  geTester, meta='
-00010690: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-000106a0: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-000106b0: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-000106c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000106d0: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-000106e0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-000106f0: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
-00010700: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-00010710: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010720: 2020 7465 7374 3a0a 2020 2020 2020 2020    test:.        
-00010730: 2020 2020 2020 2020 2020 2020 7479 7065              type
-00010740: 3a20 6669 6c65 7379 7374 656d 0a20 2020  : filesystem.   
-00010750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010760: 206d 756c 7469 706c 653a 0a20 2020 2020   multiple:.     
-00010770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010780: 2020 2072 616e 6765 3a20 312d 330a 2020     range: 1-3.  
-00010790: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-000107a0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-000107b0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-000107c0: 6c65 616e 7570 290a 0a20 2020 2020 2020  leanup)..       
-000107d0: 2073 746f 725f 6964 7320 3d20 6861 726e   stor_ids = harn
-000107e0: 6573 732e 6164 645f 7374 6f72 6167 6528  ess.add_storage(
-000107f0: 2274 6573 7422 2c20 636f 756e 743d 3229  "test", count=2)
-00010800: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00010810: 2e72 656d 6f76 655f 7374 6f72 6167 6528  .remove_storage(
-00010820: 7374 6f72 5f69 6473 5b30 5d29 0a20 2020  stor_ids[0]).   
-00010830: 2020 2020 2023 204e 6f74 6520 7265 3a20       # Note re: 
-00010840: 6465 6c74 6120 6265 7477 6565 6e20 7265  delta between re
-00010850: 616c 2062 6568 6176 696f 7220 616e 6420  al behavior and 
-00010860: 4861 726e 6573 733a 204a 756a 7520 646f  Harness: Juju do
-00010870: 6573 6e27 7420 616c 6c6f 7720 7265 6d6f  esn't allow remo
-00010880: 7661 6c0a 2020 2020 2020 2020 2320 6f66  val.        # of
-00010890: 2074 6865 206c 6173 7420 6174 7461 6368   the last attach
-000108a0: 6564 2073 746f 7261 6765 2075 6e69 7420  ed storage unit 
-000108b0: 7768 696c 6520 6120 776f 726b 6c6f 6164  while a workload
-000108c0: 2069 7320 7374 696c 6c20 7275 6e6e 696e   is still runnin
-000108d0: 672e 2020 546f 206d 6f72 650a 2020 2020  g.  To more.    
-000108e0: 2020 2020 2320 6561 7369 6c79 2061 6c6c      # easily all
-000108f0: 6f77 2074 6573 7469 6e67 206f 6620 7374  ow testing of st
-00010900: 6f72 6167 6520 7265 6d6f 7661 6c2c 2049  orage removal, I
-00010910: 2061 6d20 7072 6573 656e 746c 7920 6967   am presently ig
-00010920: 6e6f 7269 6e67 2074 6869 7320 6465 7461  noring this deta
-00010930: 696c 2e0a 2020 2020 2020 2020 2320 284f  il..        # (O
-00010940: 7468 6572 7769 7365 2c20 7468 6520 7573  therwise, the us
-00010950: 6572 2077 6f75 6c64 206e 6565 6420 746f  er would need to
-00010960: 2066 6c61 6720 736f 6d65 686f 7720 7468   flag somehow th
-00010970: 6174 2074 6865 7920 6172 6520 696e 7465  at they are inte
-00010980: 6e74 696f 6e61 6c6c 790a 2020 2020 2020  ntionally.      
-00010990: 2020 2320 7265 6d6f 7669 6e67 2074 6865    # removing the
-000109a0: 2066 696e 616c 2075 6e69 7420 6173 2070   final unit as p
-000109b0: 6172 7420 6f66 2061 2073 6875 7464 6f77  art of a shutdow
-000109c0: 6e20 7072 6f63 6564 7572 652c 2065 6c73  n procedure, els
-000109d0: 6520 6974 2764 2062 6c6f 636b 2074 6865  e it'd block the
-000109e0: 0a20 2020 2020 2020 2023 2072 656d 6f76  .        # remov
-000109f0: 616c 2e20 2049 276d 206e 6f74 2073 7572  al.  I'm not sur
-00010a00: 6520 7375 6368 2062 6568 6176 696f 7220  e such behavior 
-00010a10: 6973 2070 726f 6475 6374 6976 652e 290a  is productive.).
-00010a20: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00010a30: 2e62 6567 696e 5f77 6974 685f 696e 6974  .begin_with_init
-00010a40: 6961 6c5f 686f 6f6b 7328 290a 2020 2020  ial_hooks().    
-00010a50: 2020 2020 2320 4f6e 6c79 206f 6e65 2068      # Only one h
-00010a60: 6f6f 6b20 7769 6c6c 2066 6972 653b 206f  ook will fire; o
-00010a70: 6e65 2077 6f6e 2774 2073 696e 6365 2069  ne won't since i
-00010a80: 7420 7761 7320 7265 6d6f 7665 640a 2020  t was removed.  
-00010a90: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010aa0: 7445 7175 616c 286c 656e 2868 6172 6e65  tEqual(len(harne
-00010ab0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
-00010ac0: 645f 6576 656e 7473 292c 2031 290a 2020  d_events), 1).  
-00010ad0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00010ae0: 7454 7275 6528 6973 696e 7374 616e 6365  tTrue(isinstance
-00010af0: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
-00010b00: 6273 6572 7665 645f 6576 656e 7473 5b30  bserved_events[0
-00010b10: 5d2c 2053 746f 7261 6765 4174 7461 6368  ], StorageAttach
-00010b20: 6564 4576 656e 7429 290a 0a20 2020 2064  edEvent))..    d
-00010b30: 6566 2074 6573 745f 7265 6d6f 7665 5f73  ef test_remove_s
-00010b40: 746f 7261 6765 5f77 6974 686f 7574 5f6d  torage_without_m
-00010b50: 6574 6164 6174 615f 6b65 795f 6661 696c  etadata_key_fail
-00010b60: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
-00010b70: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-00010b80: 7373 2843 6861 726d 4261 7365 2c20 6d65  ss(CharmBase, me
-00010b90: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00010ba0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00010bb0: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00010bc0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00010bd0: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
-00010be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010bf0: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
-00010c00: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00010c10: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00010c20: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00010c30: 732e 636c 6561 6e75 7029 0a0a 2020 2020  s.cleanup)..    
-00010c40: 2020 2020 2320 446f 6573 6e27 7420 7265      # Doesn't re
-00010c50: 616c 6c79 206d 616b 6520 7365 6e73 6520  ally make sense 
-00010c60: 7369 6e63 6520 7765 2061 6c72 6561 6479  since we already
-00010c70: 2063 616e 2774 2061 6464 2073 746f 7261   can't add stora
-00010c80: 6765 2077 6869 6368 2069 736e 2774 2069  ge which isn't i
-00010c90: 6e20 7468 6520 6d65 7461 6461 7461 2c0a  n the metadata,.
-00010ca0: 2020 2020 2020 2020 2320 6275 7420 696e          # but in
-00010cb0: 636c 7564 6564 2066 6f72 2063 6f6d 706c  cluded for compl
-00010cc0: 6574 656e 6573 732e 0a20 2020 2020 2020  eteness..       
-00010cd0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00010ce0: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-00010cf0: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-00010d00: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-00010d10: 2e72 656d 6f76 655f 7374 6f72 6167 6528  .remove_storage(
-00010d20: 2274 6573 742f 3022 290a 2020 2020 2020  "test/0").      
-00010d30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00010d40: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
-00010d50: 636d 2e65 7863 6570 7469 6f6e 2e61 7267  cm.exception.arg
-00010d60: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
-00010d70: 2020 2274 6865 206b 6579 2027 7465 7374    "the key 'test
-00010d80: 2720 6973 206e 6f74 2073 7065 6369 6669  ' is not specifi
-00010d90: 6564 2061 7320 6120 7374 6f72 6167 6520  ed as a storage 
-00010da0: 6b65 7920 696e 206d 6574 6164 6174 6122  key in metadata"
-00010db0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00010dc0: 7265 6d6f 7665 5f73 746f 7261 6765 5f61  remove_storage_a
-00010dd0: 6674 6572 5f68 6172 6e65 7373 5f62 6567  fter_harness_beg
-00010de0: 696e 2873 656c 6629 3a0a 2020 2020 2020  in(self):.      
-00010df0: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-00010e00: 6573 7328 5374 6f72 6167 6554 6573 7465  ess(StorageTeste
-00010e10: 722c 206d 6574 613d 2727 270a 2020 2020  r, meta='''.    
-00010e20: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-00010e30: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
-00010e40: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
-00010e50: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-00010e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e70: 2020 2020 2069 6e74 6572 6661 6365 3a20       interface: 
-00010e80: 7067 7371 6c0a 2020 2020 2020 2020 2020  pgsql.          
-00010e90: 2020 7374 6f72 6167 653a 0a20 2020 2020    storage:.     
-00010ea0: 2020 2020 2020 2020 2020 2074 6573 743a             test:
-00010eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ec0: 2020 2020 2074 7970 653a 2066 696c 6573       type: files
-00010ed0: 7973 7465 6d0a 2020 2020 2020 2020 2020  ystem.          
-00010ee0: 2020 2020 2020 2020 2020 6d75 6c74 6970            multip
-00010ef0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00010f00: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
-00010f10: 653a 2031 2d33 0a20 2020 2020 2020 2020  e: 1-3.         
-00010f20: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00010f30: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-00010f40: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00010f50: 0a0a 2020 2020 2020 2020 7374 6f72 5f69  ..        stor_i
-00010f60: 6473 203d 2068 6172 6e65 7373 2e61 6464  ds = harness.add
-00010f70: 5f73 746f 7261 6765 2822 7465 7374 222c  _storage("test",
-00010f80: 2063 6f75 6e74 3d32 290a 2020 2020 2020   count=2).      
-00010f90: 2020 6861 726e 6573 732e 6265 6769 6e5f    harness.begin_
-00010fa0: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
-00010fb0: 6b73 2829 0a20 2020 2020 2020 2073 656c  ks().        sel
-00010fc0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-00010fd0: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
-00010fe0: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
-00010ff0: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
-00011000: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
-00011010: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
-00011020: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
-00011030: 7665 6e74 735b 305d 2c20 5374 6f72 6167  vents[0], Storag
-00011040: 6541 7474 6163 6865 6445 7665 6e74 2929  eAttachedEvent))
-00011050: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00011060: 7365 7274 5472 7565 2869 7369 6e73 7461  sertTrue(isinsta
-00011070: 6e63 6528 6861 726e 6573 732e 6368 6172  nce(harness.char
-00011080: 6d2e 6f62 7365 7276 6564 5f65 7665 6e74  m.observed_event
-00011090: 735b 315d 2c20 5374 6f72 6167 6541 7474  s[1], StorageAtt
-000110a0: 6163 6865 6445 7665 6e74 2929 0a0a 2020  achedEvent))..  
-000110b0: 2020 2020 2020 6861 726e 6573 732e 7265        harness.re
-000110c0: 6d6f 7665 5f73 746f 7261 6765 2873 746f  move_storage(sto
-000110d0: 725f 6964 735b 315d 290a 2020 2020 2020  r_ids[1]).      
-000110e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000110f0: 616c 286c 656e 2868 6172 6e65 7373 2e63  al(len(harness.c
-00011100: 6861 726d 2e6f 6273 6572 7665 645f 6576  harm.observed_ev
-00011110: 656e 7473 292c 2033 290a 2020 2020 2020  ents), 3).      
-00011120: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-00011130: 6528 6973 696e 7374 616e 6365 2868 6172  e(isinstance(har
-00011140: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
-00011150: 7665 645f 6576 656e 7473 5b32 5d2c 2053  ved_events[2], S
-00011160: 746f 7261 6765 4465 7461 6368 696e 6745  torageDetachingE
-00011170: 7665 6e74 2929 0a0a 2020 2020 2020 2020  vent))..        
-00011180: 6174 7461 6368 6564 5f73 746f 7261 6765  attached_storage
-00011190: 5f69 6473 203d 2068 6172 6e65 7373 2e5f  _ids = harness._
-000111a0: 6261 636b 656e 642e 7374 6f72 6167 655f  backend.storage_
-000111b0: 6c69 7374 2822 7465 7374 2229 0a20 2020  list("test").   
-000111c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000111d0: 496e 2873 656c 662e 5f65 7874 7261 6374  In(self._extract
-000111e0: 5f73 746f 7261 6765 5f69 6e64 6578 2873  _storage_index(s
-000111f0: 746f 725f 6964 735b 305d 292c 2061 7474  tor_ids[0]), att
-00011200: 6163 6865 645f 7374 6f72 6167 655f 6964  ached_storage_id
-00011210: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-00011220: 6173 7365 7274 4e6f 7449 6e28 7365 6c66  assertNotIn(self
-00011230: 2e5f 6578 7472 6163 745f 7374 6f72 6167  ._extract_storag
-00011240: 655f 696e 6465 7828 7374 6f72 5f69 6473  e_index(stor_ids
-00011250: 5b31 5d29 2c20 6174 7461 6368 6564 5f73  [1]), attached_s
-00011260: 746f 7261 6765 5f69 6473 290a 0a20 2020  torage_ids)..   
-00011270: 2064 6566 205f 6578 7472 6163 745f 7374   def _extract_st
-00011280: 6f72 6167 655f 696e 6465 7828 7365 6c66  orage_index(self
-00011290: 2c20 7374 6f72 5f69 6429 3a0a 2020 2020  , stor_id):.    
-000112a0: 2020 2020 7265 7475 726e 2069 6e74 2873      return int(s
-000112b0: 746f 725f 6964 2e73 706c 6974 2827 2f27  tor_id.split('/'
-000112c0: 295b 2d31 5d29 0a0a 2020 2020 6465 6620  )[-1])..    def 
-000112d0: 7465 7374 5f72 656d 6f76 655f 6465 7461  test_remove_deta
-000112e0: 6368 6564 5f73 746f 7261 6765 2873 656c  ched_storage(sel
-000112f0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00011300: 6573 7320 3d20 4861 726e 6573 7328 5374  ess = Harness(St
-00011310: 6f72 6167 6554 6573 7465 722c 206d 6574  orageTester, met
-00011320: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-00011330: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-00011340: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-00011350: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
-00011360: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
-00011370: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00011380: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
-00011390: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-000113a0: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
-000113b0: 2020 2020 2074 6573 743a 0a20 2020 2020       test:.     
-000113c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000113d0: 7970 653a 2066 696c 6573 7973 7465 6d0a  ype: filesystem.
-000113e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113f0: 2020 2020 6d75 6c74 6970 6c65 3a0a 2020      multiple:.  
-00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011410: 2020 2020 2020 7261 6e67 653a 2031 2d33        range: 1-3
-00011420: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00011430: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011440: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00011450: 732e 636c 6561 6e75 7029 0a0a 2020 2020  s.cleanup)..    
-00011460: 2020 2020 7374 6f72 5f69 6473 203d 2068      stor_ids = h
-00011470: 6172 6e65 7373 2e61 6464 5f73 746f 7261  arness.add_stora
-00011480: 6765 2822 7465 7374 222c 2063 6f75 6e74  ge("test", count
-00011490: 3d32 290a 2020 2020 2020 2020 6861 726e  =2).        harn
-000114a0: 6573 732e 6265 6769 6e5f 7769 7468 5f69  ess.begin_with_i
-000114b0: 6e69 7469 616c 5f68 6f6f 6b73 2829 0a20  nitial_hooks(). 
-000114c0: 2020 2020 2020 2068 6172 6e65 7373 2e64         harness.d
-000114d0: 6574 6163 685f 7374 6f72 6167 6528 7374  etach_storage(st
-000114e0: 6f72 5f69 6473 5b30 5d29 0a20 2020 2020  or_ids[0]).     
-000114f0: 2020 2068 6172 6e65 7373 2e72 656d 6f76     harness.remov
-00011500: 655f 7374 6f72 6167 6528 7374 6f72 5f69  e_storage(stor_i
-00011510: 6473 5b30 5d29 2020 2320 416c 7265 6164  ds[0])  # Alread
-00011520: 7920 6465 7461 6368 6564 2c20 736f 2077  y detached, so w
-00011530: 6f6e 2774 2066 6972 6520 6120 686f 6f6b  on't fire a hook
-00011540: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00011550: 7365 7274 4571 7561 6c28 6c65 6e28 6861  sertEqual(len(ha
-00011560: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
-00011570: 7276 6564 5f65 7665 6e74 7329 2c20 3329  rved_events), 3)
-00011580: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00011590: 7365 7274 5472 7565 2869 7369 6e73 7461  sertTrue(isinsta
-000115a0: 6e63 6528 6861 726e 6573 732e 6368 6172  nce(harness.char
-000115b0: 6d2e 6f62 7365 7276 6564 5f65 7665 6e74  m.observed_event
-000115c0: 735b 305d 2c20 5374 6f72 6167 6541 7474  s[0], StorageAtt
-000115d0: 6163 6865 6445 7665 6e74 2929 0a20 2020  achedEvent)).   
-000115e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000115f0: 5472 7565 2869 7369 6e73 7461 6e63 6528  True(isinstance(
-00011600: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
-00011610: 7365 7276 6564 5f65 7665 6e74 735b 315d  served_events[1]
-00011620: 2c20 5374 6f72 6167 6541 7474 6163 6865  , StorageAttache
-00011630: 6445 7665 6e74 2929 0a20 2020 2020 2020  dEvent)).       
-00011640: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-00011650: 2869 7369 6e73 7461 6e63 6528 6861 726e  (isinstance(harn
-00011660: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
-00011670: 6564 5f65 7665 6e74 735b 325d 2c20 5374  ed_events[2], St
-00011680: 6f72 6167 6544 6574 6163 6869 6e67 4576  orageDetachingEv
-00011690: 656e 7429 290a 0a20 2020 2064 6566 2074  ent))..    def t
-000116a0: 6573 745f 6163 7469 6f6e 735f 6672 6f6d  est_actions_from
-000116b0: 5f64 6972 6563 746f 7279 2873 656c 6629  _directory(self)
-000116c0: 3a0a 2020 2020 2020 2020 746d 7020 3d20  :.        tmp = 
-000116d0: 7061 7468 6c69 622e 5061 7468 2874 656d  pathlib.Path(tem
-000116e0: 7066 696c 652e 6d6b 6474 656d 7028 2929  pfile.mkdtemp())
-000116f0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00011700: 6443 6c65 616e 7570 2873 6875 7469 6c2e  dCleanup(shutil.
-00011710: 726d 7472 6565 2c20 7374 7228 746d 7029  rmtree, str(tmp)
-00011720: 290a 2020 2020 2020 2020 6163 7469 6f6e  ).        action
-00011730: 735f 6669 6c65 6e61 6d65 203d 2074 6d70  s_filename = tmp
-00011740: 202f 2027 6163 7469 6f6e 732e 7961 6d6c   / 'actions.yaml
-00011750: 270a 2020 2020 2020 2020 7769 7468 2061  '.        with a
-00011760: 6374 696f 6e73 5f66 696c 656e 616d 652e  ctions_filename.
-00011770: 6f70 656e 2827 7774 2729 2061 7320 6163  open('wt') as ac
-00011780: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-00011790: 2020 2061 6374 696f 6e73 2e77 7269 7465     actions.write
-000117a0: 2874 6578 7477 7261 702e 6465 6465 6e74  (textwrap.dedent
-000117b0: 2827 2727 0a20 2020 2020 2020 2020 2020  ('''.           
-000117c0: 2074 6573 743a 0a20 2020 2020 2020 2020   test:.         
-000117d0: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-000117e0: 6f6e 3a20 6120 6475 6d6d 7920 6163 7469  on: a dummy acti
-000117f0: 6f6e 0a20 2020 2020 2020 2020 2020 2027  on.            '
-00011800: 2727 2929 0a20 2020 2020 2020 2068 6172  '')).        har
-00011810: 6e65 7373 203d 2073 656c 662e 5f67 6574  ness = self._get
-00011820: 5f64 756d 6d79 5f63 6861 726d 5f68 6172  _dummy_charm_har
-00011830: 6e65 7373 2874 6d70 290a 2020 2020 2020  ness(tmp).      
-00011840: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-00011850: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00011860: 7373 6572 7445 7175 616c 286c 6973 7428  ssertEqual(list(
-00011870: 6861 726e 6573 732e 6672 616d 6577 6f72  harness.framewor
-00011880: 6b2e 6d65 7461 2e61 6374 696f 6e73 292c  k.meta.actions),
-00011890: 205b 2774 6573 7427 5d29 0a20 2020 2020   ['test']).     
-000118a0: 2020 2023 2054 6865 2063 6861 726d 5f64     # The charm_d
-000118b0: 6972 2061 6c73 6f20 6765 7473 2073 6574  ir also gets set
-000118c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-000118d0: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
-000118e0: 732e 6672 616d 6577 6f72 6b2e 6368 6172  s.framework.char
-000118f0: 6d5f 6469 722c 2074 6d70 290a 0a20 2020  m_dir, tmp)..   
-00011900: 2064 6566 205f 6765 745f 6475 6d6d 795f   def _get_dummy_
-00011910: 6368 6172 6d5f 6861 726e 6573 7328 7365  charm_harness(se
-00011920: 6c66 2c20 746d 7029 3a0a 2020 2020 2020  lf, tmp):.      
-00011930: 2020 7365 6c66 2e5f 7772 6974 655f 6475    self._write_du
-00011940: 6d6d 795f 6368 6172 6d28 746d 7029 0a20  mmy_charm(tmp). 
-00011950: 2020 2020 2020 2063 6861 726d 5f6d 6f64         charm_mod
-00011960: 203d 2069 6d70 6f72 746c 6962 2e69 6d70   = importlib.imp
-00011970: 6f72 745f 6d6f 6475 6c65 2827 7465 7374  ort_module('test
-00011980: 6368 6172 6d27 290a 2020 2020 2020 2020  charm').        
-00011990: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-000119a0: 7328 6368 6172 6d5f 6d6f 642e 4d79 5465  s(charm_mod.MyTe
-000119b0: 7374 696e 6743 6861 726d 290a 2020 2020  stingCharm).    
-000119c0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-000119d0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-000119e0: 6e75 7029 0a20 2020 2020 2020 2072 6574  nup).        ret
-000119f0: 7572 6e20 6861 726e 6573 730a 0a20 2020  urn harness..   
-00011a00: 2064 6566 205f 7772 6974 655f 6475 6d6d   def _write_dumm
-00011a10: 795f 6368 6172 6d28 7365 6c66 2c20 746d  y_charm(self, tm
-00011a20: 7029 3a0a 2020 2020 2020 2020 7372 6364  p):.        srcd
-00011a30: 6972 203d 2074 6d70 202f 2027 7372 6327  ir = tmp / 'src'
-00011a40: 0a20 2020 2020 2020 2073 7263 6469 722e  .        srcdir.
-00011a50: 6d6b 6469 7228 306f 3735 3529 0a20 2020  mkdir(0o755).   
-00011a60: 2020 2020 2063 6861 726d 5f66 696c 656e       charm_filen
-00011a70: 616d 6520 3d20 7372 6364 6972 202f 2027  ame = srcdir / '
-00011a80: 7465 7374 6368 6172 6d2e 7079 270a 2020  testcharm.py'.  
-00011a90: 2020 2020 2020 7769 7468 2063 6861 726d        with charm
-00011aa0: 5f66 696c 656e 616d 652e 6f70 656e 2827  _filename.open('
-00011ab0: 7774 2729 2061 7320 6368 6172 6d70 793a  wt') as charmpy:
-00011ac0: 0a20 2020 2020 2020 2020 2020 2023 206c  .            # l
-00011ad0: 616e 6775 6167 653d 5079 7468 6f6e 0a20  anguage=Python. 
-00011ae0: 2020 2020 2020 2020 2020 2063 6861 726d             charm
-00011af0: 7079 2e77 7269 7465 2874 6578 7477 7261  py.write(textwra
-00011b00: 702e 6465 6465 6e74 2827 2727 0a20 2020  p.dedent('''.   
-00011b10: 2020 2020 2020 2020 2020 2020 2066 726f               fro
-00011b20: 6d20 6f70 732e 6368 6172 6d20 696d 706f  m ops.charm impo
-00011b30: 7274 2043 6861 726d 4261 7365 0a20 2020  rt CharmBase.   
-00011b40: 2020 2020 2020 2020 2020 2020 2063 6c61               cla
-00011b50: 7373 204d 7954 6573 7469 6e67 4368 6172  ss MyTestingChar
-00011b60: 6d28 4368 6172 6d42 6173 6529 3a0a 2020  m(CharmBase):.  
-00011b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b80: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
-00011b90: 2020 2020 2020 2027 2727 2929 0a20 2020         ''')).   
-00011ba0: 2020 2020 206f 7269 6720 3d20 7379 732e       orig = sys.
-00011bb0: 7061 7468 5b3a 5d0a 2020 2020 2020 2020  path[:].        
-00011bc0: 7379 732e 7061 7468 2e61 7070 656e 6428  sys.path.append(
-00011bd0: 7374 7228 7372 6364 6972 2929 0a0a 2020  str(srcdir))..  
-00011be0: 2020 2020 2020 6465 6620 636c 6561 6e75        def cleanu
-00011bf0: 7028 293a 0a20 2020 2020 2020 2020 2020  p():.           
-00011c00: 2073 7973 2e70 6174 6820 3d20 6f72 6967   sys.path = orig
-00011c10: 0a20 2020 2020 2020 2020 2020 2073 7973  .            sys
-00011c20: 2e6d 6f64 756c 6573 2e70 6f70 2827 7465  .modules.pop('te
-00011c30: 7374 6368 6172 6d27 290a 0a20 2020 2020  stcharm')..     
-00011c40: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00011c50: 7570 2863 6c65 616e 7570 290a 0a20 2020  up(cleanup)..   
-00011c60: 2064 6566 2074 6573 745f 6163 7469 6f6e   def test_action
-00011c70: 735f 7061 7373 6564 5f69 6e28 7365 6c66  s_passed_in(self
-00011c80: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-00011c90: 7373 203d 2048 6172 6e65 7373 280a 2020  ss = Harness(.  
-00011ca0: 2020 2020 2020 2020 2020 4368 6172 6d42            CharmB
-00011cb0: 6173 652c 0a20 2020 2020 2020 2020 2020  ase,.           
-00011cc0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-00011cd0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00011ce0: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
-00011cf0: 2020 2020 2027 2727 2c0a 2020 2020 2020       ''',.      
-00011d00: 2020 2020 2020 6163 7469 6f6e 733d 2727        actions=''
-00011d10: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00011d20: 2020 7465 7374 2d61 6374 696f 6e3a 0a20    test-action:. 
-00011d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d40: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-00011d50: 6120 6475 6d6d 7920 7465 7374 2061 6374  a dummy test act
-00011d60: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-00011d70: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-00011d80: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00011d90: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00011da0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00011db0: 7445 7175 616c 286c 6973 7428 6861 726e  tEqual(list(harn
-00011dc0: 6573 732e 6672 616d 6577 6f72 6b2e 6d65  ess.framework.me
-00011dd0: 7461 2e61 6374 696f 6e73 292c 205b 2774  ta.actions), ['t
-00011de0: 6573 742d 6163 7469 6f6e 275d 290a 0a20  est-action']).. 
-00011df0: 2020 2064 6566 2074 6573 745f 6576 656e     def test_even
-00011e00: 745f 636f 6e74 6578 7428 7365 6c66 293a  t_context(self):
-00011e10: 0a20 2020 2020 2020 2063 6c61 7373 204d  .        class M
-00011e20: 7943 6861 726d 2843 6861 726d 4261 7365  yCharm(CharmBase
-00011e30: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
-00011e40: 6566 2065 7665 6e74 5f68 616e 646c 6572  ef event_handler
-00011e50: 2873 656c 662c 2065 7674 293a 0a20 2020  (self, evt):.   
-00011e60: 2020 2020 2020 2020 2020 2020 2065 7674               evt
-00011e70: 2e72 656c 6174 696f 6e2e 6461 7461 5b65  .relation.data[e
-00011e80: 7674 2e72 656c 6174 696f 6e2e 6170 705d  vt.relation.app]
-00011e90: 5b27 666f 6f27 5d20 3d20 2762 6172 270a  ['foo'] = 'bar'.
-00011ea0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00011eb0: 203d 2048 6172 6e65 7373 284d 7943 6861   = Harness(MyCha
-00011ec0: 726d 2c20 6d65 7461 3d27 2727 0a20 2020  rm, meta='''.   
-00011ed0: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
-00011ee0: 6573 742d 6368 6172 6d0a 2020 2020 2020  est-charm.      
-00011ef0: 2020 2020 2020 7265 7175 6972 6573 3a0a        requires:.
-00011f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011f10: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
-00011f20: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-00011f30: 653a 2070 6773 716c 0a20 2020 2020 2020  e: pgsql.       
-00011f40: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00011f50: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
-00011f60: 290a 2020 2020 2020 2020 7265 6c5f 6964  ).        rel_id
-00011f70: 203d 2068 6172 6e65 7373 2e61 6464 5f72   = harness.add_r
-00011f80: 656c 6174 696f 6e28 2764 6227 2c20 2770  elation('db', 'p
-00011f90: 6f73 7467 7265 7371 6c27 290a 2020 2020  ostgresql').    
-00011fa0: 2020 2020 7265 6c20 3d20 6861 726e 6573      rel = harnes
-00011fb0: 732e 6368 6172 6d2e 6d6f 6465 6c2e 6765  s.charm.model.ge
-00011fc0: 745f 7265 6c61 7469 6f6e 2827 6462 272c  t_relation('db',
-00011fd0: 2072 656c 5f69 6429 0a0a 2020 2020 2020   rel_id)..      
-00011fe0: 2020 6576 656e 7420 3d20 4d61 6769 634d    event = MagicM
-00011ff0: 6f63 6b28 290a 2020 2020 2020 2020 6576  ock().        ev
-00012000: 656e 742e 7265 6c61 7469 6f6e 203d 2072  ent.relation = r
-00012010: 656c 0a0a 2020 2020 2020 2020 7769 7468  el..        with
-00012020: 2068 6172 6e65 7373 2e5f 6576 656e 745f   harness._event_
-00012030: 636f 6e74 6578 7428 276d 795f 7265 6c61  context('my_rela
-00012040: 7469 6f6e 5f6a 6f69 6e65 6427 293a 0a20  tion_joined'):. 
-00012050: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00012060: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00012070: 7328 6f70 732e 6d6f 6465 6c2e 5265 6c61  s(ops.model.Rela
-00012080: 7469 6f6e 4461 7461 4572 726f 7229 3a0a  tionDataError):.
-00012090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120a0: 6861 726e 6573 732e 6368 6172 6d2e 6576  harness.charm.ev
-000120b0: 656e 745f 6861 6e64 6c65 7228 6576 656e  ent_handler(even
-000120c0: 7429 0a0a 2020 2020 6465 6620 7465 7374  t)..    def test
-000120d0: 5f65 7665 6e74 5f63 6f6e 7465 7874 5f69  _event_context_i
-000120e0: 6e76 6572 7365 2873 656c 6629 3a0a 2020  nverse(self):.  
-000120f0: 2020 2020 2020 636c 6173 7320 4d79 4368        class MyCh
-00012100: 6172 6d28 4368 6172 6d42 6173 6529 3a0a  arm(CharmBase):.
-00012110: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-00012120: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
-00012130: 7261 6d65 776f 726b 3a20 4672 616d 6577  ramework: Framew
-00012140: 6f72 6b29 3a0a 2020 2020 2020 2020 2020  ork):.          
-00012150: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-00012160: 696e 6974 5f5f 2866 7261 6d65 776f 726b  init__(framework
-00012170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012180: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
-00012190: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
-000121a0: 2e64 625f 7265 6c61 7469 6f6e 5f6a 6f69  .db_relation_joi
-000121b0: 6e65 642c 0a20 2020 2020 2020 2020 2020  ned,.           
-000121c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000121e0: 2e5f 6a6f 696e 5f64 6229 0a0a 2020 2020  ._join_db)..    
-000121f0: 2020 2020 2020 2020 6465 6620 5f6a 6f69          def _joi
-00012200: 6e5f 6462 2873 656c 662c 2065 7665 6e74  n_db(self, event
-00012210: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012220: 2020 2023 2064 6f20 7468 696e 6773 2077     # do things w
-00012230: 6974 6820 4150 4973 2077 6520 6361 6e6e  ith APIs we cann
-00012240: 6f74 2065 6173 696c 7920 6d6f 636b 0a20  ot easily mock. 
-00012250: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00012260: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-00012270: 7465 6445 7272 6f72 0a0a 2020 2020 2020  tedError..      
-00012280: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-00012290: 6573 7328 4d79 4368 6172 6d2c 206d 6574  ess(MyCharm, met
-000122a0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-000122b0: 2020 6e61 6d65 3a20 7465 7374 2d63 6861    name: test-cha
-000122c0: 726d 0a20 2020 2020 2020 2020 2020 2072  rm.            r
-000122d0: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
-000122e0: 2020 2020 2020 2020 2064 623a 0a20 2020           db:.   
-000122f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012300: 2069 6e74 6572 6661 6365 3a20 7067 7371   interface: pgsq
-00012310: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
-00012320: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-00012330: 7373 2e62 6567 696e 2829 0a0a 2020 2020  ss.begin()..    
-00012340: 2020 2020 6465 6620 6d6f 636b 5f6a 6f69      def mock_joi
-00012350: 6e5f 6462 2865 7665 6e74 293a 0a20 2020  n_db(event):.   
-00012360: 2020 2020 2020 2020 2023 2074 6865 2068           # the h
-00012370: 6172 6e65 7373 2074 6869 6e6b 7320 7765  arness thinks we
-00012380: 2772 6520 696e 7369 6465 2061 2064 625f  're inside a db_
-00012390: 7265 6c61 7469 6f6e 5f6a 6f69 6e65 6420  relation_joined 
-000123a0: 686f 6f6b 0a20 2020 2020 2020 2020 2020  hook.           
-000123b0: 2023 2062 7574 2077 6520 7761 6e74 2074   # but we want t
-000123c0: 6f20 6d6f 636b 2074 6865 2072 656d 6f74  o mock the remot
-000123d0: 6520 6461 7461 2068 6572 653a 0a20 2020  e data here:.   
-000123e0: 2020 2020 2020 2020 2077 6974 6820 6861           with ha
-000123f0: 726e 6573 732e 5f65 7665 6e74 5f63 6f6e  rness._event_con
-00012400: 7465 7874 2827 2729 3a0a 2020 2020 2020  text(''):.      
-00012410: 2020 2020 2020 2020 2020 2320 7072 6574            # pret
-00012420: 656e 6420 666f 7220 6120 6d6f 6d65 6e74  end for a moment
-00012430: 2077 6527 7265 206e 6f74 2069 6e20 6120   we're not in a 
-00012440: 686f 6f6b 2063 6f6e 7465 7874 2c0a 2020  hook context,.  
-00012450: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00012460: 736f 2074 6865 2068 6172 6e65 7373 2077  so the harness w
-00012470: 696c 6c20 6c65 7420 7573 3a0a 2020 2020  ill let us:.    
-00012480: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00012490: 7428 6576 656e 742e 7265 6c61 7469 6f6e  t(event.relation
-000124a0: 2e61 7070 290a 2020 2020 2020 2020 2020  .app).          
-000124b0: 2020 2020 2020 6576 656e 742e 7265 6c61        event.rela
-000124c0: 7469 6f6e 2e64 6174 615b 6861 726e 6573  tion.data[harnes
-000124d0: 732e 6368 6172 6d2e 6170 705d 5b27 666f  s.charm.app]['fo
-000124e0: 6f27 5d20 3d20 2762 6172 270a 0a20 2020  o'] = 'bar'..   
-000124f0: 2020 2020 2068 6172 6e65 7373 2e63 6861       harness.cha
-00012500: 726d 2e5f 6a6f 696e 5f64 6220 3d20 6d6f  rm._join_db = mo
-00012510: 636b 5f6a 6f69 6e5f 6462 0a20 2020 2020  ck_join_db.     
-00012520: 2020 2072 656c 5f69 6420 3d20 6861 726e     rel_id = harn
-00012530: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00012540: 2827 6462 272c 2027 7265 6d6f 7465 2729  ('db', 'remote')
-00012550: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00012560: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-00012570: 6974 2872 656c 5f69 642c 2027 7265 6d6f  it(rel_id, 'remo
-00012580: 7465 2f30 2729 0a20 2020 2020 2020 2072  te/0').        r
-00012590: 656c 203d 2068 6172 6e65 7373 2e63 6861  el = harness.cha
-000125a0: 726d 2e6d 6f64 656c 2e67 6574 5f72 656c  rm.model.get_rel
-000125b0: 6174 696f 6e28 2764 6227 2c20 7265 6c5f  ation('db', rel_
-000125c0: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
-000125d0: 2e61 7373 6572 7445 7175 616c 287b 2766  .assertEqual({'f
-000125e0: 6f6f 273a 2027 6261 7227 7d2c 0a20 2020  oo': 'bar'},.   
-000125f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012600: 2020 2020 2020 6861 726e 6573 732e 6765        harness.ge
-00012610: 745f 7265 6c61 7469 6f6e 5f64 6174 6128  t_relation_data(
-00012620: 7265 6c5f 6964 2c20 2774 6573 742d 6368  rel_id, 'test-ch
-00012630: 6172 6d27 2929 0a0a 2020 2020 2020 2020  arm'))..        
-00012640: 2320 6e6f 7720 7765 2772 6520 6f75 7473  # now we're outs
-00012650: 6964 6520 6f66 2074 6865 2068 6f6f 6b20  ide of the hook 
-00012660: 636f 6e74 6578 743a 0a20 2020 2020 2020  context:.       
-00012670: 2061 7373 6572 7420 6e6f 7420 6861 726e   assert not harn
-00012680: 6573 732e 5f62 6163 6b65 6e64 2e5f 686f  ess._backend._ho
-00012690: 6f6b 5f69 735f 7275 6e6e 696e 670a 2020  ok_is_running.  
-000126a0: 2020 2020 2020 6173 7365 7274 2072 656c        assert rel
-000126b0: 2e64 6174 615b 6861 726e 6573 732e 6368  .data[harness.ch
-000126c0: 6172 6d2e 6170 705d 5b27 666f 6f27 5d20  arm.app]['foo'] 
-000126d0: 3d3d 2027 6261 7227 0a0a 2020 2020 6465  == 'bar'..    de
-000126e0: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
-000126f0: 7365 745f 6465 6c65 7465 7328 7365 6c66  set_deletes(self
-00012700: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-00012710: 7373 203d 2048 6172 6e65 7373 2843 6861  ss = Harness(Cha
-00012720: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-00012730: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00012740: 653a 2074 6573 742d 6368 6172 6d0a 2020  e: test-charm.  
-00012750: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-00012760: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00012770: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-00012780: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00012790: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
-000127a0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-000127b0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-000127c0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-000127d0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
-000127e0: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
-000127f0: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
-00012800: 6574 5f6c 6561 6465 7228 4661 6c73 6529  et_leader(False)
-00012810: 0a20 2020 2020 2020 2072 656c 5f69 6420  .        rel_id 
-00012820: 3d20 6861 726e 6573 732e 6164 645f 7265  = harness.add_re
-00012830: 6c61 7469 6f6e 2827 6462 272c 2027 706f  lation('db', 'po
-00012840: 7374 6772 6573 716c 2729 0a20 2020 2020  stgresql').     
-00012850: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00012860: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-00012870: 7265 6c5f 6964 2c20 2774 6573 742d 6368  rel_id, 'test-ch
-00012880: 6172 6d2f 3027 2c20 7b27 666f 6f27 3a20  arm/0', {'foo': 
-00012890: 2762 6172 277d 290a 2020 2020 2020 2020  'bar'}).        
-000128a0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-000128b0: 7469 6f6e 5f75 6e69 7428 7265 6c5f 6964  tion_unit(rel_id
-000128c0: 2c20 2770 6f73 7467 7265 7371 6c2f 3027  , 'postgresql/0'
-000128d0: 290a 2020 2020 2020 2020 7265 6c20 3d20  ).        rel = 
-000128e0: 6861 726e 6573 732e 6368 6172 6d2e 6d6f  harness.charm.mo
-000128f0: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-00012900: 2827 6462 272c 2072 656c 5f69 6429 0a20  ('db', rel_id). 
-00012910: 2020 2020 2020 2064 656c 2072 656c 2e64         del rel.d
-00012920: 6174 615b 6861 726e 6573 732e 6368 6172  ata[harness.char
-00012930: 6d2e 6d6f 6465 6c2e 756e 6974 5d5b 2766  m.model.unit]['f
-00012940: 6f6f 275d 0a20 2020 2020 2020 2073 656c  oo'].        sel
-00012950: 662e 6173 7365 7274 4571 7561 6c28 7b7d  f.assertEqual({}
-00012960: 2c20 6861 726e 6573 732e 6765 745f 7265  , harness.get_re
-00012970: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
-00012980: 6964 2c20 2774 6573 742d 6368 6172 6d2f  id, 'test-charm/
-00012990: 3027 2929 0a0a 2020 2020 6465 6620 7465  0'))..    def te
-000129a0: 7374 5f72 656c 6174 696f 6e5f 7365 745f  st_relation_set_
-000129b0: 6e6f 6e73 7472 696e 6728 7365 6c66 293a  nonstring(self):
-000129c0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-000129d0: 203d 2048 6172 6e65 7373 2843 6861 726d   = Harness(Charm
-000129e0: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-000129f0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-00012a00: 2074 6573 742d 6368 6172 6d0a 2020 2020   test-charm.    
-00012a10: 2020 2020 2020 2020 7265 7175 6972 6573          requires
-00012a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012a30: 2020 6462 3a0a 2020 2020 2020 2020 2020    db:.          
-00012a40: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-00012a50: 6163 653a 2070 6773 716c 0a20 2020 2020  ace: pgsql.     
-00012a60: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00012a70: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-00012a80: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-00012a90: 6e75 7029 0a20 2020 2020 2020 2068 6172  nup).        har
-00012aa0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
-00012ab0: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
-00012ac0: 5f6c 6561 6465 7228 4661 6c73 6529 0a20  _leader(False). 
-00012ad0: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
-00012ae0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00012af0: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
-00012b00: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
-00012b10: 2066 6f72 2069 6e76 616c 6964 5f76 616c   for invalid_val
-00012b20: 7565 2069 6e20 2831 2c20 312e 322c 207b  ue in (1, 1.2, {
-00012b30: 7d2c 205b 5d2c 2073 6574 2829 2c20 5472  }, [], set(), Tr
-00012b40: 7565 2c20 6f62 6a65 6374 2829 2c20 7479  ue, object(), ty
-00012b50: 7065 293a 0a20 2020 2020 2020 2020 2020  pe):.           
-00012b60: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00012b70: 7452 6169 7365 7328 6d6f 6465 6c2e 5265  tRaises(model.Re
-00012b80: 6c61 7469 6f6e 4461 7461 4572 726f 7229  lationDataError)
-00012b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012ba0: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
-00012bb0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
-00012bc0: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
-00012bd0: 726d 2f30 272c 0a20 2020 2020 2020 2020  rm/0',.         
-00012be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c00: 2020 2020 7b27 666f 6f27 3a20 696e 7661      {'foo': inva
-00012c10: 6c69 645f 7661 6c75 657d 290a 0a20 2020  lid_value})..   
-00012c20: 2064 6566 2074 6573 745f 7365 745f 776f   def test_set_wo
-00012c30: 726b 6c6f 6164 5f76 6572 7369 6f6e 2873  rkload_version(s
-00012c40: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-00012c50: 726e 6573 7320 3d20 4861 726e 6573 7328  rness = Harness(
-00012c60: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-00012c70: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00012c80: 6e61 6d65 3a20 6170 700a 2020 2020 2020  name: app.      
-00012c90: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00012ca0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00012cb0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00012cc0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-00012cd0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-00012ce0: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-00012cf0: 734e 6f6e 6528 6861 726e 6573 732e 6765  sNone(harness.ge
-00012d00: 745f 776f 726b 6c6f 6164 5f76 6572 7369  t_workload_versi
-00012d10: 6f6e 2829 290a 2020 2020 2020 2020 6861  on()).        ha
-00012d20: 726e 6573 732e 6368 6172 6d2e 6d6f 6465  rness.charm.mode
-00012d30: 6c2e 756e 6974 2e73 6574 5f77 6f72 6b6c  l.unit.set_workl
-00012d40: 6f61 645f 7665 7273 696f 6e28 2731 2e32  oad_version('1.2
-00012d50: 2e33 2729 0a20 2020 2020 2020 2073 656c  .3').        sel
-00012d60: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
-00012d70: 726e 6573 732e 6765 745f 776f 726b 6c6f  rness.get_worklo
-00012d80: 6164 5f76 6572 7369 6f6e 2829 2c20 2731  ad_version(), '1
-00012d90: 2e32 2e33 2729 0a0a 2020 2020 6465 6620  .2.3')..    def 
-00012da0: 7465 7374 5f67 6574 5f62 6163 6b65 6e64  test_get_backend
-00012db0: 5f63 616c 6c73 2873 656c 6629 3a0a 2020  _calls(self):.  
-00012dc0: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
-00012dd0: 4861 726e 6573 7328 4368 6172 6d42 6173  Harness(CharmBas
-00012de0: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
-00012df0: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-00012e00: 7374 2d63 6861 726d 0a20 2020 2020 2020  st-charm.       
-00012e10: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
-00012e20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00012e30: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
-00012e40: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
-00012e50: 3a20 7067 7371 6c0a 2020 2020 2020 2020  : pgsql.        
-00012e60: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00012e70: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-00012e80: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-00012e90: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00012ea0: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
-00012eb0: 2020 2320 4e6f 2063 616c 6c73 2074 6f20    # No calls to 
-00012ec0: 7468 6520 6261 636b 656e 6420 7965 740a  the backend yet.
-00012ed0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00012ee0: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
-00012ef0: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
-00012f00: 6c6c 7328 292c 205b 5d29 0a20 2020 2020  lls(), []).     
-00012f10: 2020 2072 656c 5f69 6420 3d20 6861 726e     rel_id = harn
-00012f20: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00012f30: 2827 6462 272c 2027 706f 7374 6772 6573  ('db', 'postgres
-00012f40: 716c 2729 0a0a 2020 2020 2020 2020 7365  ql')..        se
-00012f50: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
-00012f60: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
-00012f70: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-00012f80: 7265 6c61 7469 6f6e 5f69 6473 272c 2027  relation_ids', '
-00012f90: 6462 2729 2c0a 2020 2020 2020 2020 2020  db'),.          
-00012fa0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
-00012fb0: 5f6c 6973 7427 2c20 7265 6c5f 6964 292c  _list', rel_id),
-00012fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012fd0: 2028 2772 656c 6174 696f 6e5f 7265 6d6f   ('relation_remo
-00012fe0: 7465 5f61 7070 5f6e 616d 6527 2c20 3029  te_app_name', 0)
-00012ff0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-00013000: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
-00013010: 6e65 7373 2e5f 6765 745f 6261 636b 656e  ness._get_backen
-00013020: 645f 6361 6c6c 7328 2929 0a0a 2020 2020  d_calls())..    
-00013030: 2020 2020 2320 7570 6461 7465 5f72 656c      # update_rel
-00013040: 6174 696f 6e5f 6461 7461 2065 6e73 7572  ation_data ensur
-00013050: 6573 2074 6865 2063 6163 6865 6420 6461  es the cached da
-00013060: 7461 2066 6f72 2074 6865 2072 656c 6174  ta for the relat
-00013070: 696f 6e20 6973 2077 6970 6564 0a20 2020  ion is wiped.   
-00013080: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-00013090: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-000130a0: 6128 7265 6c5f 6964 2c20 2774 6573 742d  a(rel_id, 'test-
-000130b0: 6368 6172 6d2f 3027 2c20 7b27 666f 6f27  charm/0', {'foo'
-000130c0: 3a20 2762 6172 277d 290a 2020 2020 2020  : 'bar'}).      
-000130d0: 2020 7465 7374 5f63 6861 726d 5f75 6e69    test_charm_uni
-000130e0: 7420 3d20 6861 726e 6573 732e 6d6f 6465  t = harness.mode
-000130f0: 6c2e 6765 745f 756e 6974 2827 7465 7374  l.get_unit('test
-00013100: 2d63 6861 726d 2f30 2729 0a20 2020 2020  -charm/0').     
-00013110: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00013120: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
-00013130: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00013140: 2020 2028 2772 656c 6174 696f 6e5f 6765     ('relation_ge
-00013150: 7427 2c20 302c 2027 7465 7374 2d63 6861  t', 0, 'test-cha
-00013160: 726d 2f30 272c 2046 616c 7365 292c 0a20  rm/0', False),. 
-00013170: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00013180: 2775 7064 6174 655f 7265 6c61 7469 6f6e  'update_relation
-00013190: 5f64 6174 6127 2c20 302c 2074 6573 745f  _data', 0, test_
-000131a0: 6368 6172 6d5f 756e 6974 2c20 2766 6f6f  charm_unit, 'foo
-000131b0: 272c 2027 6261 7227 290a 2020 2020 2020  ', 'bar').      
-000131c0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000131d0: 2020 2020 2068 6172 6e65 7373 2e5f 6765       harness._ge
-000131e0: 745f 6261 636b 656e 645f 6361 6c6c 7328  t_backend_calls(
-000131f0: 7265 7365 743d 5472 7565 2929 0a20 2020  reset=True)).   
-00013200: 2020 2020 2023 2061 6464 5f72 656c 6174       # add_relat
-00013210: 696f 6e5f 756e 6974 2072 6573 6574 7320  ion_unit resets 
-00013220: 7468 6520 7265 6c61 7469 6f6e 5f6c 6973  the relation_lis
-00013230: 742c 2062 7574 2064 6f65 736e 2774 2074  t, but doesn't t
-00013240: 7269 6767 6572 2062 6163 6b65 6e64 2063  rigger backend c
-00013250: 616c 6c73 0a20 2020 2020 2020 2068 6172  alls.        har
-00013260: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00013270: 6e5f 756e 6974 2872 656c 5f69 642c 2027  n_unit(rel_id, '
-00013280: 706f 7374 6772 6573 716c 2f30 2729 0a20  postgresql/0'). 
-00013290: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000132a0: 7274 4571 7561 6c28 5b5d 2c20 6861 726e  rtEqual([], harn
-000132b0: 6573 732e 5f67 6574 5f62 6163 6b65 6e64  ess._get_backend
-000132c0: 5f63 616c 6c73 2872 6573 6574 3d46 616c  _calls(reset=Fal
-000132d0: 7365 2929 0a20 2020 2020 2020 2023 2068  se)).        # h
-000132e0: 6f77 6576 6572 2c20 7570 6461 7465 5f72  owever, update_r
-000132f0: 656c 6174 696f 6e5f 6461 7461 2064 6f65  elation_data doe
-00013300: 732c 2062 6563 6175 7365 2077 6520 6172  s, because we ar
-00013310: 6520 7072 6570 6172 696e 6720 7265 6c61  e preparing rela
-00013320: 7469 6f6e 2d63 6861 6e67 6564 0a20 2020  tion-changed.   
-00013330: 2020 2020 2068 6172 6e65 7373 2e75 7064       harness.upd
-00013340: 6174 655f 7265 6c61 7469 6f6e 5f64 6174  ate_relation_dat
-00013350: 6128 7265 6c5f 6964 2c20 2770 6f73 7467  a(rel_id, 'postg
-00013360: 7265 7371 6c2f 3027 2c20 7b27 666f 6f27  resql/0', {'foo'
-00013370: 3a20 2762 6172 277d 290a 2020 2020 2020  : 'bar'}).      
-00013380: 2020 7067 716c 5f75 6e69 7420 3d20 6861    pgql_unit = ha
-00013390: 726e 6573 732e 6d6f 6465 6c2e 6765 745f  rness.model.get_
-000133a0: 756e 6974 2827 706f 7374 6772 6573 716c  unit('postgresql
-000133b0: 2f30 2729 0a0a 2020 2020 2020 2020 7365  /0')..        se
-000133c0: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
-000133d0: 2020 2020 2020 2020 2020 2020 6861 726e              harn
-000133e0: 6573 732e 5f67 6574 5f62 6163 6b65 6e64  ess._get_backend
-000133f0: 5f63 616c 6c73 2872 6573 6574 3d46 616c  _calls(reset=Fal
-00013400: 7365 292c 205b 0a20 2020 2020 2020 2020  se), [.         
-00013410: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
-00013420: 6e5f 6964 7327 2c20 2764 6227 292c 0a20  n_ids', 'db'),. 
-00013430: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00013440: 2772 656c 6174 696f 6e5f 6c69 7374 272c  'relation_list',
-00013450: 2072 656c 5f69 6429 2c0a 2020 2020 2020   rel_id),.      
-00013460: 2020 2020 2020 2020 2020 2827 7265 6c61            ('rela
-00013470: 7469 6f6e 5f67 6574 272c 2030 2c20 2770  tion_get', 0, 'p
-00013480: 6f73 7467 7265 7371 6c2f 3027 2c20 4661  ostgresql/0', Fa
-00013490: 6c73 6529 2c0a 2020 2020 2020 2020 2020  lse),.          
-000134a0: 2020 2020 2020 2827 7570 6461 7465 5f72        ('update_r
-000134b0: 656c 6174 696f 6e5f 6461 7461 272c 2030  elation_data', 0
-000134c0: 2c20 7067 716c 5f75 6e69 742c 2027 666f  , pgql_unit, 'fo
-000134d0: 6f27 2c20 2762 6172 2729 0a20 2020 2020  o', 'bar').     
-000134e0: 2020 2020 2020 205d 290a 2020 2020 2020         ]).      
-000134f0: 2020 2320 4966 2077 6520 6368 6563 6b20    # If we check 
-00013500: 6167 6169 6e2c 2074 6865 7920 6172 6520  again, they are 
-00013510: 7374 696c 6c20 7468 6572 652c 2062 7574  still there, but
-00013520: 206e 6f77 2077 6520 7265 7365 7420 6974   now we reset it
-00013530: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00013540: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
-00013550: 2020 2020 2020 2068 6172 6e65 7373 2e5f         harness._
-00013560: 6765 745f 6261 636b 656e 645f 6361 6c6c  get_backend_call
-00013570: 7328 7265 7365 743d 5472 7565 292c 205b  s(reset=True), [
-00013580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013590: 2028 2772 656c 6174 696f 6e5f 6964 7327   ('relation_ids'
-000135a0: 2c20 2764 6227 292c 0a20 2020 2020 2020  , 'db'),.       
-000135b0: 2020 2020 2020 2020 2028 2772 656c 6174           ('relat
-000135c0: 696f 6e5f 6c69 7374 272c 2072 656c 5f69  ion_list', rel_i
-000135d0: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-000135e0: 2020 2020 2827 7265 6c61 7469 6f6e 5f67      ('relation_g
-000135f0: 6574 272c 2030 2c20 2770 6f73 7467 7265  et', 0, 'postgre
-00013600: 7371 6c2f 3027 2c20 4661 6c73 6529 2c0a  sql/0', False),.
-00013610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013620: 2827 7570 6461 7465 5f72 656c 6174 696f  ('update_relatio
-00013630: 6e5f 6461 7461 272c 2030 2c20 7067 716c  n_data', 0, pgql
-00013640: 5f75 6e69 742c 2027 666f 6f27 2c20 2762  _unit, 'foo', 'b
-00013650: 6172 2729 0a20 2020 2020 2020 2020 2020  ar').           
-00013660: 205d 290a 2020 2020 2020 2020 2320 416e   ]).        # An
-00013670: 6420 7468 6520 6361 6c6c 7320 6172 6520  d the calls are 
-00013680: 676f 6e65 0a20 2020 2020 2020 2073 656c  gone.        sel
-00013690: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
-000136a0: 726e 6573 732e 5f67 6574 5f62 6163 6b65  rness._get_backe
-000136b0: 6e64 5f63 616c 6c73 2829 2c20 5b5d 290a  nd_calls(), []).
-000136c0: 0a20 2020 2064 6566 2074 6573 745f 6765  .    def test_ge
-000136d0: 745f 6261 636b 656e 645f 6361 6c6c 735f  t_backend_calls_
-000136e0: 7769 7468 5f6b 7761 7267 7328 7365 6c66  with_kwargs(self
-000136f0: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-00013700: 7373 203d 2048 6172 6e65 7373 2843 6861  ss = Harness(Cha
-00013710: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-00013720: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00013730: 653a 2074 6573 742d 6368 6172 6d0a 2020  e: test-charm.  
-00013740: 2020 2020 2020 2020 2020 7265 7175 6972            requir
-00013750: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00013760: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-00013770: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00013780: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
-00013790: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-000137a0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-000137b0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-000137c0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
-000137d0: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
-000137e0: 2020 2020 2020 2075 6e69 7420 3d20 6861         unit = ha
-000137f0: 726e 6573 732e 6368 6172 6d2e 6d6f 6465  rness.charm.mode
-00013800: 6c2e 756e 6974 0a20 2020 2020 2020 2023  l.unit.        #
-00013810: 2052 6573 6574 2074 6865 206c 6973 742c   Reset the list,
-00013820: 2062 6563 6175 7365 2077 6520 646f 6e27   because we don'
-00013830: 7420 6361 7265 2077 6861 7420 6974 2074  t care what it t
-00013840: 6f6f 6b20 746f 2067 6574 2068 6572 650a  ook to get here.
-00013850: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00013860: 5f67 6574 5f62 6163 6b65 6e64 5f63 616c  _get_backend_cal
-00013870: 6c73 2872 6573 6574 3d54 7275 6529 0a20  ls(reset=True). 
-00013880: 2020 2020 2020 2075 6e69 742e 7374 6174         unit.stat
-00013890: 7573 203d 2041 6374 6976 6553 7461 7475  us = ActiveStatu
-000138a0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-000138b0: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
-000138c0: 2020 2020 2020 2020 2020 5b28 2773 7461            [('sta
-000138d0: 7475 735f 7365 7427 2c20 2761 6374 6976  tus_set', 'activ
-000138e0: 6527 2c20 2727 2c20 7b27 6973 5f61 7070  e', '', {'is_app
-000138f0: 273a 2046 616c 7365 7d29 5d2c 2068 6172  ': False})], har
-00013900: 6e65 7373 2e5f 6765 745f 6261 636b 656e  ness._get_backen
-00013910: 645f 6361 6c6c 7328 2929 0a20 2020 2020  d_calls()).     
-00013920: 2020 2068 6172 6e65 7373 2e73 6574 5f6c     harness.set_l
-00013930: 6561 6465 7228 5472 7565 290a 2020 2020  eader(True).    
-00013940: 2020 2020 6170 7020 3d20 6861 726e 6573      app = harnes
-00013950: 732e 6368 6172 6d2e 6d6f 6465 6c2e 6170  s.charm.model.ap
-00013960: 700a 2020 2020 2020 2020 6861 726e 6573  p.        harnes
-00013970: 732e 5f67 6574 5f62 6163 6b65 6e64 5f63  s._get_backend_c
-00013980: 616c 6c73 2872 6573 6574 3d54 7275 6529  alls(reset=True)
-00013990: 0a20 2020 2020 2020 2061 7070 2e73 7461  .        app.sta
-000139a0: 7475 7320 3d20 4163 7469 7665 5374 6174  tus = ActiveStat
-000139b0: 7573 2827 6d65 7373 6167 6527 290a 2020  us('message').  
-000139c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000139d0: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
-000139e0: 2020 2020 5b28 2769 735f 6c65 6164 6572      [('is_leader
-000139f0: 272c 292c 0a20 2020 2020 2020 2020 2020  ',),.           
-00013a00: 2020 2827 7374 6174 7573 5f73 6574 272c    ('status_set',
-00013a10: 2027 6163 7469 7665 272c 2027 6d65 7373   'active', 'mess
-00013a20: 6167 6527 2c20 7b27 6973 5f61 7070 273a  age', {'is_app':
-00013a30: 2054 7275 657d 295d 2c0a 2020 2020 2020   True})],.      
-00013a40: 2020 2020 2020 6861 726e 6573 732e 5f67        harness._g
-00013a50: 6574 5f62 6163 6b65 6e64 5f63 616c 6c73  et_backend_calls
-00013a60: 2829 290a 0a20 2020 2064 6566 2074 6573  ())..    def tes
-00013a70: 745f 756e 6974 5f73 7461 7475 7328 7365  t_unit_status(se
-00013a80: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-00013a90: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-00013aa0: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-00013ab0: 6e61 6d65 3a20 7465 7374 2d61 7070 2729  name: test-app')
-00013ac0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00013ad0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00013ae0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00013af0: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
-00013b00: 6164 6572 2854 7275 6529 0a20 2020 2020  ader(True).     
-00013b10: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-00013b20: 2829 0a20 2020 2020 2020 2023 2064 6566  ().        # def
-00013b30: 6175 6c74 2073 7461 7475 730a 2020 2020  ault status.    
-00013b40: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013b50: 7175 616c 2868 6172 6e65 7373 2e6d 6f64  qual(harness.mod
-00013b60: 656c 2e75 6e69 742e 7374 6174 7573 2c20  el.unit.status, 
-00013b70: 4d61 696e 7465 6e61 6e63 6553 7461 7475  MaintenanceStatu
-00013b80: 7328 2727 2929 0a20 2020 2020 2020 2073  s('')).        s
-00013b90: 7461 7475 7320 3d20 4163 7469 7665 5374  tatus = ActiveSt
-00013ba0: 6174 7573 2827 6d65 7373 6167 6527 290a  atus('message').
-00013bb0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00013bc0: 6d6f 6465 6c2e 756e 6974 2e73 7461 7475  model.unit.statu
-00013bd0: 7320 3d20 7374 6174 7573 0a20 2020 2020  s = status.     
-00013be0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00013bf0: 7561 6c28 6861 726e 6573 732e 6d6f 6465  ual(harness.mode
-00013c00: 6c2e 756e 6974 2e73 7461 7475 732c 2073  l.unit.status, s
-00013c10: 7461 7475 7329 0a0a 2020 2020 6465 6620  tatus)..    def 
-00013c20: 7465 7374 5f61 7070 5f73 7461 7475 7328  test_app_status(
-00013c30: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
-00013c40: 6172 6e65 7373 203d 2048 6172 6e65 7373  arness = Harness
-00013c50: 2843 6861 726d 4261 7365 2c20 6d65 7461  (CharmBase, meta
-00013c60: 3d27 6e61 6d65 3a20 7465 7374 2d61 7070  ='name: test-app
-00013c70: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00013c80: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-00013c90: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-00013ca0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-00013cb0: 6c65 6164 6572 2854 7275 6529 0a20 2020  leader(True).   
-00013cc0: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
-00013cd0: 696e 2829 0a20 2020 2020 2020 2023 2064  in().        # d
-00013ce0: 6566 6175 6c74 2073 7461 7475 730a 2020  efault status.  
-00013cf0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013d00: 7445 7175 616c 2868 6172 6e65 7373 2e6d  tEqual(harness.m
-00013d10: 6f64 656c 2e61 7070 2e73 7461 7475 732c  odel.app.status,
-00013d20: 2055 6e6b 6e6f 776e 5374 6174 7573 2829   UnknownStatus()
-00013d30: 290a 2020 2020 2020 2020 7374 6174 7573  ).        status
-00013d40: 203d 2041 6374 6976 6553 7461 7475 7328   = ActiveStatus(
-00013d50: 276d 6573 7361 6765 2729 0a20 2020 2020  'message').     
-00013d60: 2020 2068 6172 6e65 7373 2e6d 6f64 656c     harness.model
-00013d70: 2e61 7070 2e73 7461 7475 7320 3d20 7374  .app.status = st
-00013d80: 6174 7573 0a20 2020 2020 2020 2073 656c  atus.        sel
-00013d90: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
-00013da0: 726e 6573 732e 6d6f 6465 6c2e 6170 702e  rness.model.app.
-00013db0: 7374 6174 7573 2c20 7374 6174 7573 290a  status, status).
-00013dc0: 0a20 2020 2064 6566 2074 6573 745f 706f  .    def test_po
-00013dd0: 7075 6c61 7465 5f6f 6369 5f72 6573 6f75  pulate_oci_resou
-00013de0: 7263 6573 2873 656c 6629 3a0a 2020 2020  rces(self):.    
-00013df0: 2020 2020 6861 726e 6573 7320 3d20 4861      harness = Ha
-00013e00: 726e 6573 7328 4368 6172 6d42 6173 652c  rness(CharmBase,
-00013e10: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-00013e20: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-00013e30: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-00013e40: 2072 6573 6f75 7263 6573 3a0a 2020 2020   resources:.    
-00013e50: 2020 2020 2020 2020 2020 696d 6167 653a            image:
-00013e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013e70: 2074 7970 653a 206f 6369 2d69 6d61 6765   type: oci-image
-00013e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013e90: 2064 6573 6372 6970 7469 6f6e 3a20 2249   description: "I
-00013ea0: 6d61 6765 2074 6f20 6465 706c 6f79 2e22  mage to deploy."
-00013eb0: 0a20 2020 2020 2020 2020 2020 2020 2069  .              i
-00013ec0: 6d61 6765 323a 0a20 2020 2020 2020 2020  mage2:.         
-00013ed0: 2020 2020 2020 2074 7970 653a 206f 6369         type: oci
-00013ee0: 2d69 6d61 6765 0a20 2020 2020 2020 2020  -image.         
-00013ef0: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-00013f00: 6f6e 3a20 2241 6e6f 7468 6572 2069 6d61  on: "Another ima
-00013f10: 6765 2e22 0a20 2020 2020 2020 2020 2020  ge.".           
-00013f20: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-00013f30: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-00013f40: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-00013f50: 2020 2020 2020 2068 6172 6e65 7373 2e70         harness.p
-00013f60: 6f70 756c 6174 655f 6f63 695f 7265 736f  opulate_oci_reso
-00013f70: 7572 6365 7328 290a 2020 2020 2020 2020  urces().        
-00013f80: 7061 7468 203d 2068 6172 6e65 7373 2e6d  path = harness.m
-00013f90: 6f64 656c 2e72 6573 6f75 7263 6573 2e66  odel.resources.f
-00013fa0: 6574 6368 2827 696d 6167 6527 290a 2020  etch('image').  
-00013fb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00013fc0: 7445 7175 616c 2870 6174 682e 6e61 6d65  tEqual(path.name
-00013fd0: 2c20 2763 6f6e 7465 6e74 732e 7961 6d6c  , 'contents.yaml
-00013fe0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00013ff0: 6173 7365 7274 4571 7561 6c28 7061 7468  assertEqual(path
-00014000: 2e70 6172 656e 742e 6e61 6d65 2c20 2769  .parent.name, 'i
-00014010: 6d61 6765 2729 0a20 2020 2020 2020 2077  mage').        w
-00014020: 6974 6820 7061 7468 2e6f 7065 6e28 2772  ith path.open('r
-00014030: 2729 2061 7320 7265 736f 7572 6365 5f66  ') as resource_f
-00014040: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
-00014050: 2063 6f6e 7465 6e74 7320 3d20 7961 6d6c   contents = yaml
-00014060: 2e73 6166 655f 6c6f 6164 2872 6573 6f75  .safe_load(resou
-00014070: 7263 655f 6669 6c65 2e72 6561 6428 2929  rce_file.read())
-00014080: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00014090: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
-000140a0: 7473 5b27 7265 6769 7374 7279 7061 7468  ts['registrypath
-000140b0: 275d 2c20 2772 6567 6973 7472 7970 6174  '], 'registrypat
-000140c0: 6827 290a 2020 2020 2020 2020 7365 6c66  h').        self
-000140d0: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
-000140e0: 7465 6e74 735b 2775 7365 726e 616d 6527  tents['username'
-000140f0: 5d2c 2027 7573 6572 6e61 6d65 2729 0a20  ], 'username'). 
-00014100: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00014110: 7274 4571 7561 6c28 636f 6e74 656e 7473  rtEqual(contents
-00014120: 5b27 7061 7373 776f 7264 275d 2c20 2770  ['password'], 'p
-00014130: 6173 7377 6f72 6427 290a 2020 2020 2020  assword').      
-00014140: 2020 7061 7468 203d 2068 6172 6e65 7373    path = harness
-00014150: 2e6d 6f64 656c 2e72 6573 6f75 7263 6573  .model.resources
-00014160: 2e66 6574 6368 2827 696d 6167 6532 2729  .fetch('image2')
-00014170: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00014180: 7365 7274 4571 7561 6c28 7061 7468 2e6e  sertEqual(path.n
-00014190: 616d 652c 2027 636f 6e74 656e 7473 2e79  ame, 'contents.y
-000141a0: 616d 6c27 290a 2020 2020 2020 2020 7365  aml').        se
-000141b0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-000141c0: 6174 682e 7061 7265 6e74 2e6e 616d 652c  ath.parent.name,
-000141d0: 2027 696d 6167 6532 2729 0a0a 2020 2020   'image2')..    
-000141e0: 6465 6620 7465 7374 5f72 6573 6f75 7263  def test_resourc
-000141f0: 655f 666f 6c64 6572 5f63 6c65 616e 7570  e_folder_cleanup
-00014200: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00014210: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-00014220: 7328 4368 6172 6d42 6173 652c 206d 6574  s(CharmBase, met
-00014230: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-00014240: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-00014250: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00014260: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
-00014270: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
-00014280: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-00014290: 653a 206f 6369 2d69 6d61 6765 0a20 2020  e: oci-image.   
-000142a0: 2020 2020 2020 2020 2020 2020 2064 6573               des
-000142b0: 6372 6970 7469 6f6e 3a20 2249 6d61 6765  cription: "Image
-000142c0: 2074 6f20 6465 706c 6f79 2e22 0a20 2020   to deploy.".   
-000142d0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-000142e0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-000142f0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-00014300: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
-00014310: 6172 6e65 7373 2e70 6f70 756c 6174 655f  arness.populate_
-00014320: 6f63 695f 7265 736f 7572 6365 7328 290a  oci_resources().
-00014330: 2020 2020 2020 2020 7061 7468 203d 2068          path = h
-00014340: 6172 6e65 7373 2e6d 6f64 656c 2e72 6573  arness.model.res
-00014350: 6f75 7263 6573 2e66 6574 6368 2827 696d  ources.fetch('im
-00014360: 6167 6527 290a 2020 2020 2020 2020 7365  age').        se
-00014370: 6c66 2e61 7373 6572 7454 7275 6528 7061  lf.assertTrue(pa
-00014380: 7468 2e65 7869 7374 7328 2929 0a20 2020  th.exists()).   
-00014390: 2020 2020 2068 6172 6e65 7373 2e63 6c65       harness.cle
-000143a0: 616e 7570 2829 0a20 2020 2020 2020 2073  anup().        s
-000143b0: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-000143c0: 7061 7468 2e65 7869 7374 7328 2929 0a20  path.exists()). 
-000143d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000143e0: 7274 4661 6c73 6528 7061 7468 2e70 6172  rtFalse(path.par
-000143f0: 656e 742e 6578 6973 7473 2829 290a 2020  ent.exists()).  
-00014400: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00014410: 7446 616c 7365 2870 6174 682e 7061 7265  tFalse(path.pare
-00014420: 6e74 2e70 6172 656e 742e 6578 6973 7473  nt.parent.exists
-00014430: 2829 290a 0a20 2020 2064 6566 2074 6573  ())..    def tes
-00014440: 745f 636f 6e74 6169 6e65 725f 6973 6469  t_container_isdi
-00014450: 725f 616e 645f 6578 6973 7473 2873 656c  r_and_exists(sel
-00014460: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00014470: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-00014480: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-00014490: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-000144a0: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-000144b0: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
-000144c0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-000144d0: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
-000144e0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-000144f0: 3a20 666f 6f2d 696d 6167 650a 2020 2020  : foo-image.    
-00014500: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00014510: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00014520: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00014530: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
-00014540: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-00014550: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-00014560: 745f 6361 6e5f 636f 6e6e 6563 7428 2766  t_can_connect('f
-00014570: 6f6f 272c 2054 7275 6529 0a20 2020 2020  oo', True).     
-00014580: 2020 2063 203d 2068 6172 6e65 7373 2e6d     c = harness.m
-00014590: 6f64 656c 2e75 6e69 742e 636f 6e74 6169  odel.unit.contai
-000145a0: 6e65 7273 5b27 666f 6f27 5d0a 0a20 2020  ners['foo']..   
-000145b0: 2020 2020 2064 6972 5f70 6174 6820 3d20       dir_path = 
-000145c0: 272f 746d 702f 666f 6f2f 6469 7227 0a20  '/tmp/foo/dir'. 
-000145d0: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
-000145e0: 203d 2027 2f74 6d70 2f66 6f6f 2f66 696c   = '/tmp/foo/fil
-000145f0: 6527 0a0a 2020 2020 2020 2020 7365 6c66  e'..        self
-00014600: 2e61 7373 6572 7446 616c 7365 2863 2e69  .assertFalse(c.i
-00014610: 7364 6972 2864 6972 5f70 6174 6829 290a  sdir(dir_path)).
-00014620: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014630: 6572 7446 616c 7365 2863 2e65 7869 7374  ertFalse(c.exist
-00014640: 7328 6469 725f 7061 7468 2929 0a20 2020  s(dir_path)).   
-00014650: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00014660: 4661 6c73 6528 632e 6973 6469 7228 6669  False(c.isdir(fi
-00014670: 6c65 5f70 6174 6829 290a 2020 2020 2020  le_path)).      
-00014680: 2020 7365 6c66 2e61 7373 6572 7446 616c    self.assertFal
-00014690: 7365 2863 2e65 7869 7374 7328 6669 6c65  se(c.exists(file
-000146a0: 5f70 6174 6829 290a 0a20 2020 2020 2020  _path))..       
-000146b0: 2063 2e6d 616b 655f 6469 7228 6469 725f   c.make_dir(dir_
-000146c0: 7061 7468 2c20 6d61 6b65 5f70 6172 656e  path, make_paren
-000146d0: 7473 3d54 7275 6529 0a20 2020 2020 2020  ts=True).       
-000146e0: 2063 2e70 7573 6828 6669 6c65 5f70 6174   c.push(file_pat
-000146f0: 682c 2027 6461 7461 2729 0a0a 2020 2020  h, 'data')..    
-00014700: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00014710: 7275 6528 632e 6973 6469 7228 6469 725f  rue(c.isdir(dir_
-00014720: 7061 7468 2929 0a20 2020 2020 2020 2073  path)).        s
-00014730: 656c 662e 6173 7365 7274 5472 7565 2863  elf.assertTrue(c
-00014740: 2e65 7869 7374 7328 6469 725f 7061 7468  .exists(dir_path
-00014750: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-00014760: 6173 7365 7274 4661 6c73 6528 632e 6973  assertFalse(c.is
-00014770: 6469 7228 6669 6c65 5f70 6174 6829 290a  dir(file_path)).
-00014780: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014790: 6572 7454 7275 6528 632e 6578 6973 7473  ertTrue(c.exists
-000147a0: 2866 696c 655f 7061 7468 2929 0a0a 2020  (file_path))..  
-000147b0: 2020 6465 6620 7465 7374 5f61 6464 5f6f    def test_add_o
-000147c0: 6369 5f72 6573 6f75 7263 655f 6375 7374  ci_resource_cust
-000147d0: 6f6d 2873 656c 6629 3a0a 2020 2020 2020  om(self):.      
-000147e0: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-000147f0: 6573 7328 4368 6172 6d42 6173 652c 206d  ess(CharmBase, m
-00014800: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-00014810: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-00014820: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
-00014830: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
-00014840: 2020 2020 2020 2020 696d 6167 653a 0a20          image:. 
-00014850: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00014860: 7970 653a 206f 6369 2d69 6d61 6765 0a20  ype: oci-image. 
-00014870: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00014880: 6573 6372 6970 7469 6f6e 3a20 2249 6d61  escription: "Ima
-00014890: 6765 2074 6f20 6465 706c 6f79 2e22 0a20  ge to deploy.". 
-000148a0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
-000148b0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-000148c0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
-000148d0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
-000148e0: 2063 7573 746f 6d20 3d20 7b0a 2020 2020   custom = {.    
-000148f0: 2020 2020 2020 2020 2272 6567 6973 7472          "registr
-00014900: 7970 6174 6822 3a20 2263 7573 746f 6d70  ypath": "customp
-00014910: 6174 6822 2c0a 2020 2020 2020 2020 2020  ath",.          
-00014920: 2020 2275 7365 726e 616d 6522 3a20 2263    "username": "c
-00014930: 7573 746f 6d5f 7573 6572 6e61 6d65 222c  ustom_username",
-00014940: 0a20 2020 2020 2020 2020 2020 2022 7061  .            "pa
-00014950: 7373 776f 7264 223a 2022 6375 7374 6f6d  ssword": "custom
-00014960: 5f70 6173 7377 6f72 6422 2c0a 2020 2020  _password",.    
-00014970: 2020 2020 7d0a 2020 2020 2020 2020 6861      }.        ha
-00014980: 726e 6573 732e 6164 645f 6f63 695f 7265  rness.add_oci_re
-00014990: 736f 7572 6365 2827 696d 6167 6527 2c20  source('image', 
-000149a0: 6375 7374 6f6d 290a 2020 2020 2020 2020  custom).        
-000149b0: 7265 736f 7572 6365 203d 2068 6172 6e65  resource = harne
-000149c0: 7373 2e6d 6f64 656c 2e72 6573 6f75 7263  ss.model.resourc
-000149d0: 6573 2e66 6574 6368 2827 696d 6167 6527  es.fetch('image'
-000149e0: 290a 2020 2020 2020 2020 7769 7468 2072  ).        with r
-000149f0: 6573 6f75 7263 652e 6f70 656e 2827 7227  esource.open('r'
-00014a00: 2920 6173 2072 6573 6f75 7263 655f 6669  ) as resource_fi
-00014a10: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00014a20: 636f 6e74 656e 7473 203d 2079 616d 6c2e  contents = yaml.
-00014a30: 7361 6665 5f6c 6f61 6428 7265 736f 7572  safe_load(resour
-00014a40: 6365 5f66 696c 652e 7265 6164 2829 290a  ce_file.read()).
-00014a50: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00014a60: 6572 7445 7175 616c 2863 6f6e 7465 6e74  ertEqual(content
-00014a70: 735b 2772 6567 6973 7472 7970 6174 6827  s['registrypath'
-00014a80: 5d2c 2027 6375 7374 6f6d 7061 7468 2729  ], 'custompath')
-00014a90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00014aa0: 7365 7274 4571 7561 6c28 636f 6e74 656e  sertEqual(conten
-00014ab0: 7473 5b27 7573 6572 6e61 6d65 275d 2c20  ts['username'], 
-00014ac0: 2763 7573 746f 6d5f 7573 6572 6e61 6d65  'custom_username
-00014ad0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00014ae0: 6173 7365 7274 4571 7561 6c28 636f 6e74  assertEqual(cont
-00014af0: 656e 7473 5b27 7061 7373 776f 7264 275d  ents['password']
-00014b00: 2c20 2763 7573 746f 6d5f 7061 7373 776f  , 'custom_passwo
-00014b10: 7264 2729 0a0a 2020 2020 6465 6620 7465  rd')..    def te
-00014b20: 7374 5f61 6464 5f6f 6369 5f72 6573 6f75  st_add_oci_resou
-00014b30: 7263 655f 6e6f 5f69 6d61 6765 2873 656c  rce_no_image(sel
-00014b40: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00014b50: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-00014b60: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-00014b70: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-00014b80: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-00014b90: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-00014ba0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00014bb0: 2020 696d 6167 653a 0a20 2020 2020 2020    image:.       
-00014bc0: 2020 2020 2020 2020 2074 7970 653a 2066           type: f
-00014bd0: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
-00014be0: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
-00014bf0: 2022 496d 6167 6520 746f 2064 6570 6c6f   "Image to deplo
-00014c00: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
-00014c10: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-00014c20: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00014c30: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00014c40: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00014c50: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-00014c60: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-00014c70: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00014c80: 6164 645f 6f63 695f 7265 736f 7572 6365  add_oci_resource
-00014c90: 2822 696d 6167 6522 290a 2020 2020 2020  ("image").      
-00014ca0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00014cb0: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
-00014cc0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00014cd0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
-00014ce0: 6f63 695f 7265 736f 7572 6365 2822 6d69  oci_resource("mi
-00014cf0: 7373 696e 672d 7265 736f 7572 6365 2229  ssing-resource")
-00014d00: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00014d10: 7365 7274 4571 7561 6c28 6c65 6e28 6861  sertEqual(len(ha
-00014d20: 726e 6573 732e 5f62 6163 6b65 6e64 2e5f  rness._backend._
-00014d30: 7265 736f 7572 6365 735f 6d61 7029 2c20  resources_map), 
-00014d40: 3029 0a0a 2020 2020 6465 6620 7465 7374  0)..    def test
-00014d50: 5f61 6464 5f72 6573 6f75 7263 655f 756e  _add_resource_un
-00014d60: 6b6e 6f77 6e28 7365 6c66 293a 0a20 2020  known(self):.   
-00014d70: 2020 2020 2068 6172 6e65 7373 203d 2048       harness = H
-00014d80: 6172 6e65 7373 2843 6861 726d 4261 7365  arness(CharmBase
-00014d90: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-00014da0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-00014db0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-00014dc0: 2020 7265 736f 7572 6365 733a 0a20 2020    resources:.   
-00014dd0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00014de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014df0: 2020 7479 7065 3a20 6669 6c65 0a20 2020    type: file.   
-00014e00: 2020 2020 2020 2020 2020 2020 2064 6573               des
-00014e10: 6372 6970 7469 6f6e 3a20 2249 6d61 6765  cription: "Image
-00014e20: 2074 6f20 6465 706c 6f79 2e22 0a20 2020   to deploy.".   
-00014e30: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
-00014e40: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-00014e50: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-00014e60: 6561 6e75 7029 0a20 2020 2020 2020 2077  eanup).        w
-00014e70: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00014e80: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-00014e90: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00014ea0: 2068 6172 6e65 7373 2e61 6464 5f72 6573   harness.add_res
-00014eb0: 6f75 7263 6528 2775 6e6b 6e6f 776e 272c  ource('unknown',
-00014ec0: 2027 636f 6e74 656e 7427 290a 0a20 2020   'content')..   
-00014ed0: 2064 6566 2074 6573 745f 6164 645f 7265   def test_add_re
-00014ee0: 736f 7572 6365 5f62 7574 5f6f 6369 2873  source_but_oci(s
-00014ef0: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-00014f00: 726e 6573 7320 3d20 4861 726e 6573 7328  rness = Harness(
-00014f10: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-00014f20: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00014f30: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
-00014f40: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-00014f50: 7263 6573 3a0a 2020 2020 2020 2020 2020  rces:.          
-00014f60: 2020 2020 696d 6167 653a 0a20 2020 2020      image:.     
-00014f70: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-00014f80: 206f 6369 2d69 6d61 6765 0a20 2020 2020   oci-image.     
-00014f90: 2020 2020 2020 2020 2020 2064 6573 6372             descr
-00014fa0: 6970 7469 6f6e 3a20 2249 6d61 6765 2074  iption: "Image t
-00014fb0: 6f20 6465 706c 6f79 2e22 0a20 2020 2020  o deploy.".     
-00014fc0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00014fd0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-00014fe0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-00014ff0: 6e75 7029 0a20 2020 2020 2020 2077 6974  nup).        wit
-00015000: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00015010: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
-00015020: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-00015030: 6172 6e65 7373 2e61 6464 5f72 6573 6f75  arness.add_resou
-00015040: 7263 6528 2769 6d61 6765 272c 2027 636f  rce('image', 'co
-00015050: 6e74 656e 7427 290a 0a20 2020 2064 6566  ntent')..    def
-00015060: 2074 6573 745f 6164 645f 7265 736f 7572   test_add_resour
-00015070: 6365 5f73 7472 696e 6728 7365 6c66 293a  ce_string(self):
-00015080: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00015090: 203d 2048 6172 6e65 7373 2843 6861 726d   = Harness(Charm
-000150a0: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-000150b0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-000150c0: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
-000150d0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
-000150e0: 0a20 2020 2020 2020 2020 2020 2020 2069  .              i
-000150f0: 6d61 6765 3a0a 2020 2020 2020 2020 2020  mage:.          
-00015100: 2020 2020 2020 7479 7065 3a20 6669 6c65        type: file
-00015110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015120: 2066 696c 656e 616d 653a 2066 6f6f 2e74   filename: foo.t
-00015130: 7874 0a20 2020 2020 2020 2020 2020 2020  xt.             
-00015140: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-00015150: 2249 6d61 6765 2074 6f20 6465 706c 6f79  "Image to deploy
-00015160: 2e22 0a20 2020 2020 2020 2020 2020 2027  .".            '
-00015170: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-00015180: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-00015190: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-000151a0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
-000151b0: 5f72 6573 6f75 7263 6528 2769 6d61 6765  _resource('image
-000151c0: 272c 2027 666f 6f20 636f 6e74 656e 7473  ', 'foo contents
-000151d0: 5c6e 2729 0a20 2020 2020 2020 2070 6174  \n').        pat
-000151e0: 6820 3d20 6861 726e 6573 732e 6d6f 6465  h = harness.mode
-000151f0: 6c2e 7265 736f 7572 6365 732e 6665 7463  l.resources.fetc
-00015200: 6828 2769 6d61 6765 2729 0a20 2020 2020  h('image').     
-00015210: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00015220: 7561 6c28 7061 7468 2e6e 616d 652c 2027  ual(path.name, '
-00015230: 666f 6f2e 7478 7427 290a 2020 2020 2020  foo.txt').      
-00015240: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015250: 616c 2870 6174 682e 7061 7265 6e74 2e6e  al(path.parent.n
-00015260: 616d 652c 2027 696d 6167 6527 290a 2020  ame, 'image').  
-00015270: 2020 2020 2020 7769 7468 2070 6174 682e        with path.
-00015280: 6f70 656e 2827 7274 2729 2061 7320 663a  open('rt') as f:
-00015290: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000152a0: 662e 6173 7365 7274 4571 7561 6c28 2766  f.assertEqual('f
-000152b0: 6f6f 2063 6f6e 7465 6e74 735c 6e27 2c20  oo contents\n', 
-000152c0: 662e 7265 6164 2829 290a 0a20 2020 2064  f.read())..    d
-000152d0: 6566 2074 6573 745f 6164 645f 7265 736f  ef test_add_reso
-000152e0: 7572 6365 5f62 7974 6573 2873 656c 6629  urce_bytes(self)
-000152f0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-00015300: 7320 3d20 4861 726e 6573 7328 4368 6172  s = Harness(Char
-00015310: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-00015320: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00015330: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-00015340: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-00015350: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015360: 696d 6167 653a 0a20 2020 2020 2020 2020  image:.         
-00015370: 2020 2020 2020 2074 7970 653a 2066 696c         type: fil
-00015380: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00015390: 2020 6669 6c65 6e61 6d65 3a20 666f 6f2e    filename: foo.
-000153a0: 7a69 700a 2020 2020 2020 2020 2020 2020  zip.            
-000153b0: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
-000153c0: 2022 496d 6167 6520 746f 2064 6570 6c6f   "Image to deplo
-000153d0: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
-000153e0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-000153f0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-00015400: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-00015410: 2020 2020 2020 7261 775f 636f 6e74 656e        raw_conten
-00015420: 7473 203d 2062 275c 7866 665c 7866 665c  ts = b'\xff\xff\
-00015430: 7830 3062 6c61 685c 6e27 0a20 2020 2020  x00blah\n'.     
-00015440: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-00015450: 6573 6f75 7263 6528 2769 6d61 6765 272c  esource('image',
-00015460: 2072 6177 5f63 6f6e 7465 6e74 7329 0a20   raw_contents). 
-00015470: 2020 2020 2020 2070 6174 6820 3d20 6861         path = ha
-00015480: 726e 6573 732e 6d6f 6465 6c2e 7265 736f  rness.model.reso
-00015490: 7572 6365 732e 6665 7463 6828 2769 6d61  urces.fetch('ima
-000154a0: 6765 2729 0a20 2020 2020 2020 2073 656c  ge').        sel
-000154b0: 662e 6173 7365 7274 4571 7561 6c28 7061  f.assertEqual(pa
-000154c0: 7468 2e6e 616d 652c 2027 666f 6f2e 7a69  th.name, 'foo.zi
-000154d0: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
-000154e0: 2e61 7373 6572 7445 7175 616c 2870 6174  .assertEqual(pat
-000154f0: 682e 7061 7265 6e74 2e6e 616d 652c 2027  h.parent.name, '
-00015500: 696d 6167 6527 290a 2020 2020 2020 2020  image').        
-00015510: 7769 7468 2070 6174 682e 6f70 656e 2827  with path.open('
-00015520: 7262 2729 2061 7320 663a 0a20 2020 2020  rb') as f:.     
-00015530: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00015540: 7274 4571 7561 6c28 7261 775f 636f 6e74  rtEqual(raw_cont
-00015550: 656e 7473 2c20 662e 7265 6164 2829 290a  ents, f.read()).
-00015560: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
-00015570: 645f 7265 736f 7572 6365 5f75 6e6b 6e6f  d_resource_unkno
-00015580: 776e 5f66 696c 656e 616d 6528 7365 6c66  wn_filename(self
-00015590: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-000155a0: 7373 203d 2048 6172 6e65 7373 2843 6861  ss = Harness(Cha
-000155b0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-000155c0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-000155d0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
-000155e0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-000155f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00015600: 2069 6d61 6765 3a0a 2020 2020 2020 2020   image:.        
-00015610: 2020 2020 2020 2020 7479 7065 3a20 6669          type: fi
-00015620: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
-00015630: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-00015640: 2249 6d61 6765 2074 6f20 6465 706c 6f79  "Image to deploy
-00015650: 2e22 0a20 2020 2020 2020 2020 2020 2027  .".            '
-00015660: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
-00015670: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-00015680: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
-00015690: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
-000156a0: 5f72 6573 6f75 7263 6528 2769 6d61 6765  _resource('image
-000156b0: 272c 2027 666f 6f20 636f 6e74 656e 7473  ', 'foo contents
-000156c0: 5c6e 2729 0a20 2020 2020 2020 2070 6174  \n').        pat
-000156d0: 6820 3d20 6861 726e 6573 732e 6d6f 6465  h = harness.mode
-000156e0: 6c2e 7265 736f 7572 6365 732e 6665 7463  l.resources.fetc
-000156f0: 6828 2769 6d61 6765 2729 0a20 2020 2020  h('image').     
-00015700: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00015710: 7561 6c28 7061 7468 2e6e 616d 652c 2027  ual(path.name, '
-00015720: 696d 6167 6527 290a 2020 2020 2020 2020  image').        
-00015730: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00015740: 2870 6174 682e 7061 7265 6e74 2e6e 616d  (path.parent.nam
-00015750: 652c 2027 696d 6167 6527 290a 0a20 2020  e, 'image')..   
-00015760: 2064 6566 2074 6573 745f 6765 745f 706f   def test_get_po
-00015770: 645f 7370 6563 2873 656c 6629 3a0a 2020  d_spec(self):.  
-00015780: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
-00015790: 4861 726e 6573 7328 4368 6172 6d42 6173  Harness(CharmBas
-000157a0: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
-000157b0: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
-000157c0: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
-000157d0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-000157e0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-000157f0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00015800: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00015810: 2e73 6574 5f6c 6561 6465 7228 5472 7565  .set_leader(True
-00015820: 290a 2020 2020 2020 2020 636f 6e74 6169  ).        contai
-00015830: 6e65 725f 7370 6563 203d 207b 2763 6f6e  ner_spec = {'con
-00015840: 7461 696e 6572 273a 2027 7370 6563 277d  tainer': 'spec'}
-00015850: 0a20 2020 2020 2020 206b 3873 5f72 6573  .        k8s_res
-00015860: 6f75 7263 6573 203d 207b 276b 3873 273a  ources = {'k8s':
-00015870: 2027 7370 6563 277d 0a20 2020 2020 2020   'spec'}.       
-00015880: 2068 6172 6e65 7373 2e6d 6f64 656c 2e70   harness.model.p
-00015890: 6f64 2e73 6574 5f73 7065 6328 636f 6e74  od.set_spec(cont
-000158a0: 6169 6e65 725f 7370 6563 2c20 6b38 735f  ainer_spec, k8s_
-000158b0: 7265 736f 7572 6365 7329 0a20 2020 2020  resources).     
-000158c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000158d0: 7561 6c28 6861 726e 6573 732e 6765 745f  ual(harness.get_
-000158e0: 706f 645f 7370 6563 2829 2c20 2863 6f6e  pod_spec(), (con
-000158f0: 7461 696e 6572 5f73 7065 632c 206b 3873  tainer_spec, k8s
-00015900: 5f72 6573 6f75 7263 6573 2929 0a0a 2020  _resources))..  
-00015910: 2020 6465 6620 7465 7374 5f62 6567 696e    def test_begin
-00015920: 5f77 6974 685f 696e 6974 6961 6c5f 686f  _with_initial_ho
-00015930: 6f6b 735f 6e6f 5f72 656c 6174 696f 6e73  oks_no_relations
-00015940: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00015950: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-00015960: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
-00015970: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-00015980: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-00015990: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-000159a0: 2020 2727 272c 2063 6f6e 6669 673d 2727    ''', config=''
-000159b0: 270a 2020 2020 2020 2020 2020 2020 6f70  '.            op
-000159c0: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-000159d0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-000159e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159f0: 6465 7363 7269 7074 696f 6e3a 2061 2063  description: a c
-00015a00: 6f6e 6669 6720 6f70 7469 6f6e 0a20 2020  onfig option.   
-00015a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a20: 2074 7970 653a 2073 7472 696e 670a 2020   type: string.  
-00015a30: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-00015a40: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-00015a50: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-00015a60: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-00015a70: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
-00015a80: 6f6e 6669 6728 7b27 666f 6f27 3a20 2762  onfig({'foo': 'b
-00015a90: 6172 277d 290a 2020 2020 2020 2020 6861  ar'}).        ha
-00015aa0: 726e 6573 732e 7365 745f 6c65 6164 6572  rness.set_leader
-00015ab0: 2854 7275 6529 0a20 2020 2020 2020 2077  (True).        w
-00015ac0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00015ad0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-00015ae0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00015af0: 205f 203d 2068 6172 6e65 7373 2e63 6861   _ = harness.cha
-00015b00: 726d 0a20 2020 2020 2020 2068 6172 6e65  rm.        harne
-00015b10: 7373 2e62 6567 696e 5f77 6974 685f 696e  ss.begin_with_in
-00015b20: 6974 6961 6c5f 686f 6f6b 7328 290a 2020  itial_hooks().  
-00015b30: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00015b40: 7449 734e 6f74 4e6f 6e65 2868 6172 6e65  tIsNotNone(harne
-00015b50: 7373 2e63 6861 726d 290a 2020 2020 2020  ss.charm).      
-00015b60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00015b70: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
-00015b80: 6861 726e 6573 732e 6368 6172 6d2e 6368  harness.charm.ch
-00015b90: 616e 6765 732c 0a20 2020 2020 2020 2020  anges,.         
-00015ba0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00015bb0: 2020 2020 207b 276e 616d 6527 3a20 2769       {'name': 'i
-00015bc0: 6e73 7461 6c6c 277d 2c0a 2020 2020 2020  nstall'},.      
-00015bd0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-00015be0: 273a 2027 6c65 6164 6572 2d65 6c65 6374  ': 'leader-elect
-00015bf0: 6564 277d 2c0a 2020 2020 2020 2020 2020  ed'},.          
-00015c00: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-00015c10: 636f 6e66 6967 2d63 6861 6e67 6564 272c  config-changed',
-00015c20: 2027 6461 7461 273a 207b 2766 6f6f 273a   'data': {'foo':
-00015c30: 2027 6261 7227 7d7d 2c0a 2020 2020 2020   'bar'}},.      
-00015c40: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-00015c50: 273a 2027 7374 6172 7427 7d2c 0a20 2020  ': 'start'},.   
-00015c60: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00015c70: 2020 2029 0a0a 2020 2020 6465 6620 7465     )..    def te
-00015c80: 7374 5f62 6567 696e 5f77 6974 685f 696e  st_begin_with_in
-00015c90: 6974 6961 6c5f 686f 6f6b 735f 6e6f 5f72  itial_hooks_no_r
-00015ca0: 656c 6174 696f 6e73 5f6e 6f74 5f6c 6561  elations_not_lea
-00015cb0: 6465 7228 7365 6c66 293a 0a20 2020 2020  der(self):.     
-00015cc0: 2020 2068 6172 6e65 7373 203d 2048 6172     harness = Har
-00015cd0: 6e65 7373 2852 6563 6f72 6469 6e67 4368  ness(RecordingCh
-00015ce0: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
-00015cf0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00015d00: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
-00015d10: 2020 2020 2027 2727 2c20 636f 6e66 6967       ''', config
-00015d20: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00015d30: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
-00015d40: 2020 2020 2020 2020 2020 666f 6f3a 0a20            foo:. 
-00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d60: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-00015d70: 6120 636f 6e66 6967 206f 7074 696f 6e0a  a config option.
-00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d90: 2020 2020 7479 7065 3a20 7374 7269 6e67      type: string
-00015da0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-00015db0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00015dc0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
-00015dd0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
-00015de0: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-00015df0: 655f 636f 6e66 6967 287b 2766 6f6f 273a  e_config({'foo':
-00015e00: 2027 6261 7227 7d29 0a20 2020 2020 2020   'bar'}).       
-00015e10: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00015e20: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-00015e30: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00015e40: 2020 205f 203d 2068 6172 6e65 7373 2e63     _ = harness.c
-00015e50: 6861 726d 0a20 2020 2020 2020 2068 6172  harm.        har
-00015e60: 6e65 7373 2e62 6567 696e 5f77 6974 685f  ness.begin_with_
-00015e70: 696e 6974 6961 6c5f 686f 6f6b 7328 290a  initial_hooks().
-00015e80: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00015e90: 6572 7449 734e 6f74 4e6f 6e65 2868 6172  ertIsNotNone(har
-00015ea0: 6e65 7373 2e63 6861 726d 290a 2020 2020  ness.charm).    
-00015eb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00015ec0: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00015ed0: 2020 6861 726e 6573 732e 6368 6172 6d2e    harness.charm.
-00015ee0: 6368 616e 6765 732c 0a20 2020 2020 2020  changes,.       
-00015ef0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00015f00: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-00015f10: 2769 6e73 7461 6c6c 277d 2c0a 2020 2020  'install'},.    
-00015f20: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-00015f30: 6d65 273a 2027 6c65 6164 6572 2d73 6574  me': 'leader-set
-00015f40: 7469 6e67 732d 6368 616e 6765 6427 7d2c  tings-changed'},
-00015f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015f60: 207b 276e 616d 6527 3a20 2763 6f6e 6669   {'name': 'confi
-00015f70: 672d 6368 616e 6765 6427 2c20 2764 6174  g-changed', 'dat
-00015f80: 6127 3a20 7b27 666f 6f27 3a20 2762 6172  a': {'foo': 'bar
-00015f90: 277d 7d2c 0a20 2020 2020 2020 2020 2020  '}},.           
-00015fa0: 2020 2020 207b 276e 616d 6527 3a20 2773       {'name': 's
-00015fb0: 7461 7274 277d 2c0a 2020 2020 2020 2020  tart'},.        
-00015fc0: 2020 2020 5d0a 2020 2020 2020 2020 290a      ].        ).
-00015fd0: 0a20 2020 2064 6566 2074 6573 745f 6265  .    def test_be
-00015fe0: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
-00015ff0: 5f68 6f6f 6b73 5f77 6974 685f 7065 6572  _hooks_with_peer
-00016000: 5f72 656c 6174 696f 6e28 7365 6c66 293a  _relation(self):
-00016010: 0a20 2020 2020 2020 2063 6c61 7373 2050  .        class P
-00016020: 6565 7243 6861 726d 2852 656c 6174 696f  eerCharm(Relatio
-00016030: 6e45 7665 6e74 4368 6172 6d29 3a0a 2020  nEventCharm):.  
-00016040: 2020 2020 2020 2020 2020 6465 6620 5f5f            def __
-00016050: 696e 6974 5f5f 2873 656c 662c 2066 7261  init__(self, fra
-00016060: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
-00016070: 2020 2020 2020 2020 2073 7570 6572 2829           super()
-00016080: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
-00016090: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
-000160a0: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
-000160b0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
-000160c0: 7328 2770 6565 7227 290a 2020 2020 2020  s('peer').      
-000160d0: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-000160e0: 6573 7328 5065 6572 4368 6172 6d2c 206d  ess(PeerCharm, m
-000160f0: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-00016100: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-00016110: 7070 0a20 2020 2020 2020 2020 2020 2070  pp.            p
-00016120: 6565 7273 3a0a 2020 2020 2020 2020 2020  eers:.          
-00016130: 2020 2020 7065 6572 3a0a 2020 2020 2020      peer:.      
-00016140: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-00016150: 6163 653a 2061 7070 2d70 6565 720a 2020  ace: app-peer.  
-00016160: 2020 2020 2020 2020 2020 2727 272c 2063            ''', c
-00016170: 6f6e 6669 673d 2727 270a 2020 2020 2020  onfig='''.      
-00016180: 2020 2020 2020 6f70 7469 6f6e 733a 0a20        options:. 
-00016190: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000161a0: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
-000161b0: 2020 2020 2020 2020 6465 7363 7269 7074          descript
-000161c0: 696f 6e3a 2061 2063 6f6e 6669 6720 6f70  ion: a config op
-000161d0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-000161e0: 2020 2020 2020 2020 2074 7970 653a 2073           type: s
-000161f0: 7472 696e 670a 2020 2020 2020 2020 2020  tring.          
-00016200: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-00016210: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-00016220: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-00016230: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00016240: 7570 6461 7465 5f63 6f6e 6669 6728 7b27  update_config({'
-00016250: 666f 6f27 3a20 2762 6172 277d 290a 2020  foo': 'bar'}).  
-00016260: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00016270: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
-00016280: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
-00016290: 2020 2020 2020 2020 5f20 3d20 6861 726e          _ = harn
-000162a0: 6573 732e 6368 6172 6d0a 2020 2020 2020  ess.charm.      
-000162b0: 2020 6861 726e 6573 732e 6265 6769 6e5f    harness.begin_
-000162c0: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
-000162d0: 6b73 2829 0a20 2020 2020 2020 2073 656c  ks().        sel
-000162e0: 662e 6173 7365 7274 4973 4e6f 744e 6f6e  f.assertIsNotNon
-000162f0: 6528 6861 726e 6573 732e 6368 6172 6d29  e(harness.charm)
-00016300: 0a20 2020 2020 2020 2072 656c 5f69 6420  .        rel_id 
-00016310: 3d20 6861 726e 6573 732e 6d6f 6465 6c2e  = harness.model.
-00016320: 6765 745f 7265 6c61 7469 6f6e 2827 7065  get_relation('pe
-00016330: 6572 2729 2e69 640a 2020 2020 2020 2020  er').id.        
-00016340: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016350: 280a 2020 2020 2020 2020 2020 2020 6861  (.            ha
-00016360: 726e 6573 732e 6368 6172 6d2e 6368 616e  rness.charm.chan
-00016370: 6765 732c 0a20 2020 2020 2020 2020 2020  ges,.           
-00016380: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00016390: 2020 207b 276e 616d 6527 3a20 2769 6e73     {'name': 'ins
-000163a0: 7461 6c6c 277d 2c0a 2020 2020 2020 2020  tall'},.        
-000163b0: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-000163c0: 2027 7265 6c61 7469 6f6e 2d63 7265 6174   'relation-creat
-000163d0: 6564 272c 0a20 2020 2020 2020 2020 2020  ed',.           
-000163e0: 2020 2020 2020 2772 656c 6174 696f 6e27        'relation'
-000163f0: 3a20 2770 6565 7227 2c0a 2020 2020 2020  : 'peer',.      
-00016400: 2020 2020 2020 2020 2020 2027 6461 7461             'data
-00016410: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00016420: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00016430: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
-00016440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016450: 2020 2020 2020 2775 6e69 7427 3a20 4e6f        'unit': No
-00016460: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00016470: 2020 2020 2020 2020 2027 6170 7027 3a20           'app': 
-00016480: 2774 6573 742d 6170 7027 2c0a 2020 2020  'test-app',.    
-00016490: 2020 2020 2020 2020 2020 2020 207d 7d2c               }},
-000164a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000164b0: 207b 276e 616d 6527 3a20 276c 6561 6465   {'name': 'leade
-000164c0: 722d 7365 7474 696e 6773 2d63 6861 6e67  r-settings-chang
-000164d0: 6564 277d 2c0a 2020 2020 2020 2020 2020  ed'},.          
-000164e0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-000164f0: 636f 6e66 6967 2d63 6861 6e67 6564 272c  config-changed',
-00016500: 2027 6461 7461 273a 207b 2766 6f6f 273a   'data': {'foo':
-00016510: 2027 6261 7227 7d7d 2c0a 2020 2020 2020   'bar'}},.      
-00016520: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-00016530: 273a 2027 7374 6172 7427 7d2c 0a20 2020  ': 'start'},.   
-00016540: 2020 2020 2020 2020 205d 290a 2020 2020           ]).    
-00016550: 2020 2020 2320 5769 7468 2061 2073 696e      # With a sin
-00016560: 676c 6520 756e 6974 2c20 6e6f 2070 6565  gle unit, no pee
-00016570: 722d 7265 6c61 7469 6f6e 2d6a 6f69 6e65  r-relation-joine
-00016580: 6420 6973 2066 6972 6564 0a0a 2020 2020  d is fired..    
-00016590: 6465 6620 7465 7374 5f62 6567 696e 5f77  def test_begin_w
-000165a0: 6974 685f 696e 6974 6961 6c5f 686f 6f6b  ith_initial_hook
-000165b0: 735f 7065 6572 5f72 656c 6174 696f 6e5f  s_peer_relation_
-000165c0: 7072 655f 6465 6669 6e65 6428 7365 6c66  pre_defined(self
-000165d0: 293a 0a20 2020 2020 2020 2063 6c61 7373  ):.        class
-000165e0: 2050 6565 7243 6861 726d 2852 656c 6174   PeerCharm(Relat
-000165f0: 696f 6e45 7665 6e74 4368 6172 6d29 3a0a  ionEventCharm):.
-00016600: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-00016610: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
-00016620: 7261 6d65 776f 726b 293a 0a20 2020 2020  ramework):.     
-00016630: 2020 2020 2020 2020 2020 2073 7570 6572             super
-00016640: 2829 2e5f 5f69 6e69 745f 5f28 6672 616d  ().__init__(fram
-00016650: 6577 6f72 6b29 0a20 2020 2020 2020 2020  ework).         
-00016660: 2020 2020 2020 2073 656c 662e 6f62 7365         self.obse
-00016670: 7276 655f 7265 6c61 7469 6f6e 5f65 7665  rve_relation_eve
-00016680: 6e74 7328 2770 6565 7227 290a 2020 2020  nts('peer').    
-00016690: 2020 2020 6861 726e 6573 7320 3d20 4861      harness = Ha
-000166a0: 726e 6573 7328 5065 6572 4368 6172 6d2c  rness(PeerCharm,
-000166b0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
-000166c0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
-000166d0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
-000166e0: 2070 6565 7273 3a0a 2020 2020 2020 2020   peers:.        
-000166f0: 2020 2020 2020 7065 6572 3a0a 2020 2020        peer:.    
-00016700: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00016710: 7266 6163 653a 2061 7070 2d70 6565 720a  rface: app-peer.
-00016720: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00016730: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00016740: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00016750: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00016760: 2020 7065 6572 5f72 656c 5f69 6420 3d20    peer_rel_id = 
-00016770: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
-00016780: 7469 6f6e 2827 7065 6572 272c 2027 7465  tion('peer', 'te
-00016790: 7374 2d61 7070 2729 0a20 2020 2020 2020  st-app').       
-000167a0: 2068 6172 6e65 7373 2e62 6567 696e 5f77   harness.begin_w
-000167b0: 6974 685f 696e 6974 6961 6c5f 686f 6f6b  ith_initial_hook
-000167c0: 7328 290a 2020 2020 2020 2020 2320 4966  s().        # If
-000167d0: 2074 6865 2070 6565 7220 7265 6c61 7469   the peer relati
-000167e0: 6f6e 2069 7320 616c 7265 6164 7920 6465  on is already de
-000167f0: 6669 6e65 6420 6279 2074 6865 2075 7365  fined by the use
-00016800: 722c 2077 6520 646f 6e27 7420 6372 6561  r, we don't crea
-00016810: 7465 2074 6865 2072 656c 6174 696f 6e20  te the relation 
-00016820: 610a 2020 2020 2020 2020 2320 7365 636f  a.        # seco
-00016830: 6e64 2074 696d 652c 2062 7574 2077 6520  nd time, but we 
-00016840: 646f 2073 7469 6c6c 2066 6972 6520 7265  do still fire re
-00016850: 6c61 7469 6f6e 2d63 7265 6174 6564 2e0a  lation-created..
-00016860: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00016870: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-00016880: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
-00016890: 6172 6d2e 6368 616e 6765 732c 0a20 2020  arm.changes,.   
-000168a0: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-000168b0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-000168c0: 6527 3a20 2769 6e73 7461 6c6c 277d 2c0a  e': 'install'},.
-000168d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168e0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
-000168f0: 6f6e 2d63 7265 6174 6564 272c 0a20 2020  on-created',.   
-00016900: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-00016910: 656c 6174 696f 6e27 3a20 2770 6565 7227  elation': 'peer'
-00016920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016930: 2020 2027 6461 7461 273a 207b 0a20 2020     'data': {.   
-00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016950: 2020 2772 656c 6174 696f 6e5f 6964 273a    'relation_id':
-00016960: 2070 6565 725f 7265 6c5f 6964 2c0a 2020   peer_rel_id,.  
-00016970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016980: 2020 2027 756e 6974 273a 204e 6f6e 652c     'unit': None,
-00016990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000169a0: 2020 2020 2020 2761 7070 273a 2027 7465        'app': 'te
-000169b0: 7374 2d61 7070 272c 0a20 2020 2020 2020  st-app',.       
-000169c0: 2020 2020 2020 2020 2020 7d7d 2c0a 2020            }},.  
-000169d0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
-000169e0: 6e61 6d65 273a 2027 6c65 6164 6572 2d73  name': 'leader-s
-000169f0: 6574 7469 6e67 732d 6368 616e 6765 6427  ettings-changed'
-00016a00: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00016a10: 2020 207b 276e 616d 6527 3a20 2763 6f6e     {'name': 'con
-00016a20: 6669 672d 6368 616e 6765 6427 2c20 2764  fig-changed', 'd
-00016a30: 6174 6127 3a20 7b7d 7d2c 0a20 2020 2020  ata': {}},.     
-00016a40: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-00016a50: 6527 3a20 2773 7461 7274 277d 2c0a 2020  e': 'start'},.  
-00016a60: 2020 2020 2020 2020 2020 5d29 0a0a 2020            ])..  
-00016a70: 2020 6465 6620 7465 7374 5f62 6567 696e    def test_begin
-00016a80: 5f77 6974 685f 696e 6974 6961 6c5f 686f  _with_initial_ho
-00016a90: 6f6b 735f 7265 6c61 7469 6f6e 5f63 6861  oks_relation_cha
-00016aa0: 726d 5f77 6974 685f 6e6f 5f72 656c 6174  rm_with_no_relat
-00016ab0: 696f 6e28 7365 6c66 293a 0a20 2020 2020  ion(self):.     
-00016ac0: 2020 2063 6c61 7373 2043 6861 726d 5769     class CharmWi
-00016ad0: 7468 4442 2852 656c 6174 696f 6e45 7665  thDB(RelationEve
-00016ae0: 6e74 4368 6172 6d29 3a0a 2020 2020 2020  ntCharm):.      
-00016af0: 2020 2020 2020 6465 6620 5f5f 696e 6974        def __init
-00016b00: 5f5f 2873 656c 662c 2066 7261 6d65 776f  __(self, framewo
-00016b10: 726b 293a 0a20 2020 2020 2020 2020 2020  rk):.           
-00016b20: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
-00016b30: 6e69 745f 5f28 6672 616d 6577 6f72 6b29  nit__(framework)
-00016b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016b50: 2073 656c 662e 6f62 7365 7276 655f 7265   self.observe_re
-00016b60: 6c61 7469 6f6e 5f65 7665 6e74 7328 2764  lation_events('d
-00016b70: 6227 290a 2020 2020 2020 2020 6861 726e  b').        harn
-00016b80: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-00016b90: 6172 6d57 6974 6844 422c 206d 6574 613d  armWithDB, meta=
-00016ba0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00016bb0: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
-00016bc0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-00016bd0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-00016be0: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
-00016bf0: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
-00016c00: 3a20 7371 6c0a 2020 2020 2020 2020 2020  : sql.          
-00016c10: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
-00016c20: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-00016c30: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-00016c40: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
-00016c50: 7365 745f 6c65 6164 6572 2829 0a20 2020  set_leader().   
-00016c60: 2020 2020 2068 6172 6e65 7373 2e62 6567       harness.beg
-00016c70: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
-00016c80: 686f 6f6b 7328 290a 2020 2020 2020 2020  hooks().        
-00016c90: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00016ca0: 280a 2020 2020 2020 2020 2020 2020 6861  (.            ha
-00016cb0: 726e 6573 732e 6368 6172 6d2e 6368 616e  rness.charm.chan
-00016cc0: 6765 732c 0a20 2020 2020 2020 2020 2020  ges,.           
-00016cd0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00016ce0: 2020 207b 276e 616d 6527 3a20 2769 6e73     {'name': 'ins
-00016cf0: 7461 6c6c 277d 2c0a 2020 2020 2020 2020  tall'},.        
-00016d00: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-00016d10: 2027 6c65 6164 6572 2d65 6c65 6374 6564   'leader-elected
-00016d20: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-00016d30: 2020 2020 7b27 6e61 6d65 273a 2027 636f      {'name': 'co
-00016d40: 6e66 6967 2d63 6861 6e67 6564 272c 2027  nfig-changed', '
-00016d50: 6461 7461 273a 207b 7d7d 2c0a 2020 2020  data': {}},.    
-00016d60: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-00016d70: 6d65 273a 2027 7374 6172 7427 7d2c 0a20  me': 'start'},. 
-00016d80: 2020 2020 2020 2020 2020 205d 290a 0a20             ]).. 
-00016d90: 2020 2064 6566 2074 6573 745f 6265 6769     def test_begi
-00016da0: 6e5f 7769 7468 5f69 6e69 7469 616c 5f68  n_with_initial_h
-00016db0: 6f6f 6b73 5f77 6974 685f 6f6e 655f 7265  ooks_with_one_re
-00016dc0: 6c61 7469 6f6e 2873 656c 6629 3a0a 2020  lation(self):.  
-00016dd0: 2020 2020 2020 636c 6173 7320 4368 6172        class Char
-00016de0: 6d57 6974 6844 4228 5265 6c61 7469 6f6e  mWithDB(Relation
-00016df0: 4576 656e 7443 6861 726d 293a 0a20 2020  EventCharm):.   
-00016e00: 2020 2020 2020 2020 2064 6566 205f 5f69           def __i
-00016e10: 6e69 745f 5f28 7365 6c66 2c20 6672 616d  nit__(self, fram
-00016e20: 6577 6f72 6b29 3a0a 2020 2020 2020 2020  ework):.        
-00016e30: 2020 2020 2020 2020 7375 7065 7228 292e          super().
-00016e40: 5f5f 696e 6974 5f5f 2866 7261 6d65 776f  __init__(framewo
-00016e50: 726b 290a 2020 2020 2020 2020 2020 2020  rk).            
-00016e60: 2020 2020 7365 6c66 2e6f 6273 6572 7665      self.observe
-00016e70: 5f72 656c 6174 696f 6e5f 6576 656e 7473  _relation_events
-00016e80: 2827 6462 2729 0a20 2020 2020 2020 2068  ('db').        h
-00016e90: 6172 6e65 7373 203d 2048 6172 6e65 7373  arness = Harness
-00016ea0: 2843 6861 726d 5769 7468 4442 2c20 6d65  (CharmWithDB, me
-00016eb0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
-00016ec0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
-00016ed0: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
-00016ee0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
-00016ef0: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
-00016f00: 2020 2020 2020 2020 2020 696e 7465 7266            interf
-00016f10: 6163 653a 2073 716c 0a20 2020 2020 2020  ace: sql.       
-00016f20: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00016f30: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00016f40: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-00016f50: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
-00016f60: 7373 2e73 6574 5f6c 6561 6465 7228 290a  ss.set_leader().
-00016f70: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
-00016f80: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
-00016f90: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
-00016fa0: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
-00016fb0: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
-00016fc0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
-00016fd0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
-00016fe0: 3027 290a 2020 2020 2020 2020 6861 726e  0').        harn
-00016ff0: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
-00017000: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
-00017010: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
-00017020: 207b 276e 6577 273a 2027 6461 7461 277d   {'new': 'data'}
-00017030: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00017040: 732e 6265 6769 6e5f 7769 7468 5f69 6e69  s.begin_with_ini
-00017050: 7469 616c 5f68 6f6f 6b73 2829 0a20 2020  tial_hooks().   
-00017060: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00017070: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
-00017080: 2020 2068 6172 6e65 7373 2e63 6861 726d     harness.charm
-00017090: 2e63 6861 6e67 6573 2c0a 2020 2020 2020  .changes,.      
-000170a0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000170b0: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-000170c0: 2027 696e 7374 616c 6c27 7d2c 0a20 2020   'install'},.   
-000170d0: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
-000170e0: 616d 6527 3a20 2772 656c 6174 696f 6e2d  ame': 'relation-
-000170f0: 6372 6561 7465 6427 2c0a 2020 2020 2020  created',.      
-00017100: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-00017110: 7469 6f6e 273a 2027 6462 272c 0a20 2020  tion': 'db',.   
-00017120: 2020 2020 2020 2020 2020 2020 2020 2764                'd
-00017130: 6174 6127 3a20 7b0a 2020 2020 2020 2020  ata': {.        
-00017140: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00017150: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
-00017160: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00017170: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
-00017180: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00017190: 2020 2020 2020 2020 2020 2020 2761 7070              'app
-000171a0: 273a 2027 706f 7374 6772 6573 716c 272c  ': 'postgresql',
-000171b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000171c0: 2020 7d7d 2c0a 2020 2020 2020 2020 2020    }},.          
-000171d0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-000171e0: 6c65 6164 6572 2d65 6c65 6374 6564 277d  leader-elected'}
-000171f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017200: 2020 7b27 6e61 6d65 273a 2027 636f 6e66    {'name': 'conf
-00017210: 6967 2d63 6861 6e67 6564 272c 2027 6461  ig-changed', 'da
-00017220: 7461 273a 207b 7d7d 2c0a 2020 2020 2020  ta': {}},.      
-00017230: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-00017240: 273a 2027 7374 6172 7427 7d2c 0a20 2020  ': 'start'},.   
-00017250: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
-00017260: 616d 6527 3a20 2772 656c 6174 696f 6e2d  ame': 'relation-
-00017270: 6a6f 696e 6564 272c 0a20 2020 2020 2020  joined',.       
-00017280: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00017290: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
-000172a0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
-000172b0: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
-000172c0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-000172d0: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
-000172e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-000172f0: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
-00017300: 2770 6f73 7467 7265 7371 6c2f 3027 2c0a  'postgresql/0',.
-00017310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017320: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
-00017330: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
-00017340: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
-00017350: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00017360: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
-00017370: 6e2d 6368 616e 6765 6427 2c0a 2020 2020  n-changed',.    
-00017380: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00017390: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
-000173a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000173b0: 2764 6174 6127 3a20 7b0a 2020 2020 2020  'data': {.      
-000173c0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000173d0: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
-000173e0: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
-000173f0: 2020 2020 2020 2020 2020 2027 756e 6974             'unit
-00017400: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
-00017410: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00017420: 2020 2020 2020 2020 2761 7070 273a 2027          'app': '
-00017430: 706f 7374 6772 6573 716c 272c 0a20 2020  postgresql',.   
-00017440: 2020 2020 2020 2020 2020 2020 2020 7d7d                }}
-00017450: 2c0a 2020 2020 2020 2020 2020 2020 5d29  ,.            ])
-00017460: 0a0a 2020 2020 6465 6620 7465 7374 5f62  ..    def test_b
-00017470: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
-00017480: 6c5f 686f 6f6b 735f 7769 7468 5f61 7070  l_hooks_with_app
-00017490: 6c69 6361 7469 6f6e 5f64 6174 6128 7365  lication_data(se
-000174a0: 6c66 293a 0a20 2020 2020 2020 2063 6c61  lf):.        cla
-000174b0: 7373 2043 6861 726d 5769 7468 4442 2852  ss CharmWithDB(R
-000174c0: 656c 6174 696f 6e45 7665 6e74 4368 6172  elationEventChar
-000174d0: 6d29 3a0a 2020 2020 2020 2020 2020 2020  m):.            
-000174e0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-000174f0: 662c 2066 7261 6d65 776f 726b 293a 0a20  f, framework):. 
-00017500: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00017510: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
-00017520: 6672 616d 6577 6f72 6b29 0a20 2020 2020  framework).     
-00017530: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017540: 6f62 7365 7276 655f 7265 6c61 7469 6f6e  observe_relation
-00017550: 5f65 7665 6e74 7328 2764 6227 290a 2020  _events('db').  
-00017560: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
-00017570: 4861 726e 6573 7328 4368 6172 6d57 6974  Harness(CharmWit
-00017580: 6844 422c 206d 6574 613d 2727 270a 2020  hDB, meta='''.  
-00017590: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-000175a0: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
-000175b0: 2020 2020 2072 6571 7569 7265 733a 0a20       requires:. 
-000175c0: 2020 2020 2020 2020 2020 2020 2064 623a               db:
-000175d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000175e0: 2069 6e74 6572 6661 6365 3a20 7371 6c0a   interface: sql.
-000175f0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
-00017600: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-00017610: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-00017620: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
-00017630: 2020 6861 726e 6573 732e 7365 745f 6c65    harness.set_le
-00017640: 6164 6572 2829 0a20 2020 2020 2020 2072  ader().        r
-00017650: 656c 5f69 6420 3d20 6861 726e 6573 732e  el_id = harness.
-00017660: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00017670: 272c 2027 706f 7374 6772 6573 716c 2729  ', 'postgresql')
-00017680: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00017690: 2e61 6464 5f72 656c 6174 696f 6e5f 756e  .add_relation_un
-000176a0: 6974 2872 656c 5f69 642c 2027 706f 7374  it(rel_id, 'post
-000176b0: 6772 6573 716c 2f30 2729 0a20 2020 2020  gresql/0').     
-000176c0: 2020 2068 6172 6e65 7373 2e75 7064 6174     harness.updat
-000176d0: 655f 7265 6c61 7469 6f6e 5f64 6174 6128  e_relation_data(
-000176e0: 7265 6c5f 6964 2c20 2770 6f73 7467 7265  rel_id, 'postgre
-000176f0: 7371 6c2f 3027 2c20 7b27 6e65 7727 3a20  sql/0', {'new': 
-00017700: 2764 6174 6127 7d29 0a20 2020 2020 2020  'data'}).       
-00017710: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
-00017720: 7265 6c61 7469 6f6e 5f64 6174 6128 7265  relation_data(re
-00017730: 6c5f 6964 2c20 2770 6f73 7467 7265 7371  l_id, 'postgresq
-00017740: 6c27 2c20 7b27 6170 7027 3a20 2764 6174  l', {'app': 'dat
-00017750: 6127 7d29 0a20 2020 2020 2020 2068 6172  a'}).        har
-00017760: 6e65 7373 2e62 6567 696e 5f77 6974 685f  ness.begin_with_
-00017770: 696e 6974 6961 6c5f 686f 6f6b 7328 290a  initial_hooks().
-00017780: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00017790: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-000177a0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000177b0: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-000177c0: 2027 696e 7374 616c 6c27 7d2c 0a20 2020   'install'},.   
-000177d0: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
-000177e0: 616d 6527 3a20 2772 656c 6174 696f 6e2d  ame': 'relation-
-000177f0: 6372 6561 7465 6427 2c0a 2020 2020 2020  created',.      
-00017800: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-00017810: 7469 6f6e 273a 2027 6462 272c 0a20 2020  tion': 'db',.   
-00017820: 2020 2020 2020 2020 2020 2020 2020 2764                'd
-00017830: 6174 6127 3a20 7b0a 2020 2020 2020 2020  ata': {.        
-00017840: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00017850: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
-00017860: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00017870: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
-00017880: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00017890: 2020 2020 2020 2020 2020 2020 2761 7070              'app
-000178a0: 273a 2027 706f 7374 6772 6573 716c 272c  ': 'postgresql',
-000178b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000178c0: 2020 7d7d 2c0a 2020 2020 2020 2020 2020    }},.          
-000178d0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-000178e0: 6c65 6164 6572 2d65 6c65 6374 6564 277d  leader-elected'}
-000178f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017900: 2020 7b27 6e61 6d65 273a 2027 636f 6e66    {'name': 'conf
-00017910: 6967 2d63 6861 6e67 6564 272c 2027 6461  ig-changed', 'da
-00017920: 7461 273a 207b 7d7d 2c0a 2020 2020 2020  ta': {}},.      
-00017930: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
-00017940: 273a 2027 7374 6172 7427 7d2c 0a20 2020  ': 'start'},.   
-00017950: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
-00017960: 616d 6527 3a20 2772 656c 6174 696f 6e2d  ame': 'relation-
-00017970: 6368 616e 6765 6427 2c0a 2020 2020 2020  changed',.      
-00017980: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
-00017990: 7469 6f6e 273a 2027 6462 272c 0a20 2020  tion': 'db',.   
-000179a0: 2020 2020 2020 2020 2020 2020 2020 2764                'd
-000179b0: 6174 6127 3a20 7b0a 2020 2020 2020 2020  ata': {.        
-000179c0: 2020 2020 2020 2020 2020 2020 2027 7265               're
-000179d0: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
-000179e0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000179f0: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
-00017a00: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00017a10: 2020 2020 2020 2020 2020 2020 2761 7070              'app
-00017a20: 273a 2027 706f 7374 6772 6573 716c 272c  ': 'postgresql',
-00017a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017a40: 2020 7d7d 2c0a 2020 2020 2020 2020 2020    }},.          
-00017a50: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-00017a60: 7265 6c61 7469 6f6e 2d6a 6f69 6e65 6427  relation-joined'
-00017a70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017a80: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
-00017a90: 6462 272c 0a20 2020 2020 2020 2020 2020  db',.           
-00017aa0: 2020 2020 2020 2764 6174 6127 3a20 7b0a        'data': {.
-00017ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ac0: 2020 2020 2027 7265 6c61 7469 6f6e 5f69       'relation_i
-00017ad0: 6427 3a20 7265 6c5f 6964 2c0a 2020 2020  d': rel_id,.    
-00017ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017af0: 2027 756e 6974 273a 2027 706f 7374 6772   'unit': 'postgr
-00017b00: 6573 716c 2f30 272c 0a20 2020 2020 2020  esql/0',.       
-00017b10: 2020 2020 2020 2020 2020 2020 2020 2761                'a
-00017b20: 7070 273a 2027 706f 7374 6772 6573 716c  pp': 'postgresql
-00017b30: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00017b40: 2020 2020 7d7d 2c0a 2020 2020 2020 2020      }},.        
-00017b50: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-00017b60: 2027 7265 6c61 7469 6f6e 2d63 6861 6e67   'relation-chang
-00017b70: 6564 272c 0a20 2020 2020 2020 2020 2020  ed',.           
-00017b80: 2020 2020 2020 2772 656c 6174 696f 6e27        'relation'
-00017b90: 3a20 2764 6227 2c0a 2020 2020 2020 2020  : 'db',.        
-00017ba0: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
-00017bb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00017bc0: 2020 2020 2020 2020 2772 656c 6174 696f          'relatio
-00017bd0: 6e5f 6964 273a 2072 656c 5f69 642c 0a20  n_id': rel_id,. 
-00017be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017bf0: 2020 2020 2775 6e69 7427 3a20 2770 6f73      'unit': 'pos
-00017c00: 7467 7265 7371 6c2f 3027 2c0a 2020 2020  tgresql/0',.    
-00017c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c20: 2027 6170 7027 3a20 2770 6f73 7467 7265   'app': 'postgre
-00017c30: 7371 6c27 2c0a 2020 2020 2020 2020 2020  sql',.          
-00017c40: 2020 2020 2020 207d 7d2c 0a20 2020 2020         }},.     
-00017c50: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00017c60: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
-00017c70: 6172 6d2e 6368 616e 6765 7329 0a0a 2020  arm.changes)..  
-00017c80: 2020 6465 6620 7465 7374 5f62 6567 696e    def test_begin
-00017c90: 5f77 6974 685f 696e 6974 6961 6c5f 686f  _with_initial_ho
-00017ca0: 6f6b 735f 7769 7468 5f6d 756c 7469 706c  oks_with_multipl
-00017cb0: 655f 756e 6974 7328 7365 6c66 293a 0a20  e_units(self):. 
-00017cc0: 2020 2020 2020 2063 6c61 7373 2043 6861         class Cha
-00017cd0: 726d 5769 7468 4442 2852 656c 6174 696f  rmWithDB(Relatio
-00017ce0: 6e45 7665 6e74 4368 6172 6d29 3a0a 2020  nEventCharm):.  
-00017cf0: 2020 2020 2020 2020 2020 6465 6620 5f5f            def __
-00017d00: 696e 6974 5f5f 2873 656c 662c 2066 7261  init__(self, fra
-00017d10: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
-00017d20: 2020 2020 2020 2020 2073 7570 6572 2829           super()
-00017d30: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
-00017d40: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
-00017d50: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
-00017d60: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
-00017d70: 7328 2764 6227 290a 2020 2020 2020 2020  s('db').        
-00017d80: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-00017d90: 7328 4368 6172 6d57 6974 6844 422c 206d  s(CharmWithDB, m
-00017da0: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
-00017db0: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
-00017dc0: 7070 0a20 2020 2020 2020 2020 2020 2072  pp.            r
-00017dd0: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
-00017de0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
-00017df0: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-00017e00: 6661 6365 3a20 7371 6c0a 2020 2020 2020  face: sql.      
-00017e10: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00017e20: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00017e30: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00017e40: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-00017e50: 6573 732e 7365 745f 6c65 6164 6572 2829  ess.set_leader()
-00017e60: 0a20 2020 2020 2020 2072 656c 5f69 6420  .        rel_id 
-00017e70: 3d20 6861 726e 6573 732e 6164 645f 7265  = harness.add_re
-00017e80: 6c61 7469 6f6e 2827 6462 272c 2027 706f  lation('db', 'po
-00017e90: 7374 6772 6573 716c 2729 0a20 2020 2020  stgresql').     
-00017ea0: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-00017eb0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00017ec0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-00017ed0: 2f31 2729 0a20 2020 2020 2020 2068 6172  /1').        har
-00017ee0: 6e65 7373 2e75 7064 6174 655f 7265 6c61  ness.update_rela
-00017ef0: 7469 6f6e 5f64 6174 6128 7265 6c5f 6964  tion_data(rel_id
-00017f00: 2c20 2770 6f73 7467 7265 7371 6c2f 3127  , 'postgresql/1'
-00017f10: 2c20 7b27 6e65 7727 3a20 2764 6174 6127  , {'new': 'data'
-00017f20: 7d29 0a20 2020 2020 2020 2023 2057 6520  }).        # We 
-00017f30: 696e 7465 6e74 696f 6e61 6c6c 7920 6164  intentionally ad
-00017f40: 6420 3020 6166 7465 7220 3120 746f 2061  d 0 after 1 to a
-00017f50: 7373 6572 7420 7468 6174 2074 6865 2063  ssert that the c
-00017f60: 6f64 6520 7472 6967 6765 7273 2074 6865  ode triggers the
-00017f70: 6d20 696e 206f 7264 6572 0a20 2020 2020  m in order.     
-00017f80: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-00017f90: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-00017fa0: 5f69 642c 2027 706f 7374 6772 6573 716c  _id, 'postgresql
-00017fb0: 2f30 2729 0a20 2020 2020 2020 2068 6172  /0').        har
-00017fc0: 6e65 7373 2e62 6567 696e 5f77 6974 685f  ness.begin_with_
-00017fd0: 696e 6974 6961 6c5f 686f 6f6b 7328 290a  initial_hooks().
-00017fe0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00017ff0: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-00018000: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
-00018010: 6172 6d2e 6368 616e 6765 732c 0a20 2020  arm.changes,.   
-00018020: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-00018030: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-00018040: 6527 3a20 2769 6e73 7461 6c6c 277d 2c0a  e': 'install'},.
-00018050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018060: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
-00018070: 6f6e 2d63 7265 6174 6564 272c 0a20 2020  on-created',.   
-00018080: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-00018090: 656c 6174 696f 6e27 3a20 2764 6227 2c0a  elation': 'db',.
-000180a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180b0: 2027 6461 7461 273a 207b 0a20 2020 2020   'data': {.     
-000180c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180d0: 2772 656c 6174 696f 6e5f 6964 273a 2072  'relation_id': r
-000180e0: 656c 5f69 642c 0a20 2020 2020 2020 2020  el_id,.         
-000180f0: 2020 2020 2020 2020 2020 2020 2775 6e69              'uni
-00018100: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-00018110: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00018120: 6170 7027 3a20 2770 6f73 7467 7265 7371  app': 'postgresq
-00018130: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00018140: 2020 2020 207d 7d2c 0a20 2020 2020 2020       }},.       
-00018150: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
-00018160: 3a20 276c 6561 6465 722d 656c 6563 7465  : 'leader-electe
-00018170: 6427 7d2c 0a20 2020 2020 2020 2020 2020  d'},.           
-00018180: 2020 2020 207b 276e 616d 6527 3a20 2763       {'name': 'c
-00018190: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
-000181a0: 2764 6174 6127 3a20 7b7d 7d2c 0a20 2020  'data': {}},.   
-000181b0: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
-000181c0: 616d 6527 3a20 2773 7461 7274 277d 2c0a  ame': 'start'},.
-000181d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000181e0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
-000181f0: 6f6e 2d6a 6f69 6e65 6427 2c0a 2020 2020  on-joined',.    
-00018200: 2020 2020 2020 2020 2020 2020 2027 7265               're
-00018210: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
-00018220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018230: 2764 6174 6127 3a20 7b0a 2020 2020 2020  'data': {.      
-00018240: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00018250: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
-00018260: 6c5f 6964 2c0a 2020 2020 2020 2020 2020  l_id,.          
-00018270: 2020 2020 2020 2020 2020 2027 756e 6974             'unit
-00018280: 273a 2027 706f 7374 6772 6573 716c 2f30  ': 'postgresql/0
-00018290: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000182a0: 2020 2020 2020 2020 2761 7070 273a 2027          'app': '
-000182b0: 706f 7374 6772 6573 716c 272c 0a20 2020  postgresql',.   
-000182c0: 2020 2020 2020 2020 2020 2020 2020 7d7d                }}
-000182d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000182e0: 2020 7b27 6e61 6d65 273a 2027 7265 6c61    {'name': 'rela
-000182f0: 7469 6f6e 2d63 6861 6e67 6564 272c 0a20  tion-changed',. 
-00018300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018310: 2772 656c 6174 696f 6e27 3a20 2764 6227  'relation': 'db'
-00018320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018330: 2020 2027 6461 7461 273a 207b 0a20 2020     'data': {.   
-00018340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018350: 2020 2772 656c 6174 696f 6e5f 6964 273a    'relation_id':
-00018360: 2072 656c 5f69 642c 0a20 2020 2020 2020   rel_id,.       
-00018370: 2020 2020 2020 2020 2020 2020 2020 2775                'u
-00018380: 6e69 7427 3a20 2770 6f73 7467 7265 7371  nit': 'postgresq
-00018390: 6c2f 3027 2c0a 2020 2020 2020 2020 2020  l/0',.          
-000183a0: 2020 2020 2020 2020 2020 2027 6170 7027             'app'
-000183b0: 3a20 2770 6f73 7467 7265 7371 6c27 2c0a  : 'postgresql',.
-000183c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183d0: 207d 7d2c 0a20 2020 2020 2020 2020 2020   }},.           
-000183e0: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
-000183f0: 656c 6174 696f 6e2d 6a6f 696e 6564 272c  elation-joined',
-00018400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018410: 2020 2772 656c 6174 696f 6e27 3a20 2764    'relation': 'd
-00018420: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00018430: 2020 2020 2027 6461 7461 273a 207b 0a20       'data': {. 
-00018440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018450: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
-00018460: 273a 2072 656c 5f69 642c 0a20 2020 2020  ': rel_id,.     
-00018470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018480: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
-00018490: 7371 6c2f 3127 2c0a 2020 2020 2020 2020  sql/1',.        
-000184a0: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
-000184b0: 7027 3a20 2770 6f73 7467 7265 7371 6c27  p': 'postgresql'
-000184c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000184d0: 2020 207d 7d2c 0a20 2020 2020 2020 2020     }},.         
-000184e0: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-000184f0: 2772 656c 6174 696f 6e2d 6368 616e 6765  'relation-change
-00018500: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00018510: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
-00018520: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
-00018530: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
-00018540: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00018550: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
-00018560: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
+0000ebf0: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+0000ec00: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+0000ec10: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+0000ec20: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0000ec30: 6e65 7373 2e63 6c65 616e 7570 290a 0a20  ness.cleanup).. 
+0000ec40: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0000ec50: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
+0000ec60: 6e74 696d 6545 7272 6f72 2920 6173 2063  ntimeError) as c
+0000ec70: 6d3a 0a20 2020 2020 2020 2020 2020 2068  m:.            h
+0000ec80: 6172 6e65 7373 2e61 6464 5f73 746f 7261  arness.add_stora
+0000ec90: 6765 2822 7465 7374 2229 0a20 2020 2020  ge("test").     
+0000eca0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000ecb0: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+0000ecc0: 2063 6d2e 6578 6365 7074 696f 6e2e 6172   cm.exception.ar
+0000ecd0: 6773 5b30 5d2c 0a20 2020 2020 2020 2020  gs[0],.         
+0000ece0: 2020 2022 7468 6520 6b65 7920 2774 6573     "the key 'tes
+0000ecf0: 7427 2069 7320 6e6f 7420 7370 6563 6966  t' is not specif
+0000ed00: 6965 6420 6173 2061 2073 746f 7261 6765  ied as a storage
+0000ed10: 206b 6579 2069 6e20 6d65 7461 6461 7461   key in metadata
+0000ed20: 2229 0a0a 2020 2020 6465 6620 7465 7374  ")..    def test
+0000ed30: 5f61 6464 5f73 746f 7261 6765 5f61 6674  _add_storage_aft
+0000ed40: 6572 5f68 6172 6e65 7373 5f62 6567 696e  er_harness_begin
+0000ed50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000ed60: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000ed70: 7374 696e 672e 4861 726e 6573 7328 5374  sting.Harness(St
+0000ed80: 6f72 6167 6554 6573 7465 722c 206d 6574  orageTester, met
+0000ed90: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000eda0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0000edb0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+0000edc0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+0000edd0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+0000ede0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000edf0: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+0000ee00: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0000ee10: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
+0000ee20: 2020 2020 2074 6573 743a 0a20 2020 2020       test:.     
+0000ee30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000ee40: 7970 653a 2066 696c 6573 7973 7465 6d0a  ype: filesystem.
+0000ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee60: 2020 2020 6d75 6c74 6970 6c65 3a0a 2020      multiple:.  
+0000ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee80: 2020 2020 2020 7261 6e67 653a 2031 2d33        range: 1-3
+0000ee90: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+0000eea0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000eeb0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0000eec0: 732e 636c 6561 6e75 7029 0a0a 2020 2020  s.cleanup)..    
+0000eed0: 2020 2020 2320 5365 7420 7570 2069 6e69      # Set up ini
+0000eee0: 7469 616c 2073 746f 7261 6765 0a20 2020  tial storage.   
+0000eef0: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
+0000ef00: 5f73 746f 7261 6765 2822 7465 7374 2229  _storage("test")
+0000ef10: 5b30 5d0a 2020 2020 2020 2020 6861 726e  [0].        harn
+0000ef20: 6573 732e 6265 6769 6e5f 7769 7468 5f69  ess.begin_with_i
+0000ef30: 6e69 7469 616c 5f68 6f6f 6b73 2829 0a20  nitial_hooks(). 
+0000ef40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000ef50: 7274 4571 7561 6c28 6c65 6e28 6861 726e  rtEqual(len(harn
+0000ef60: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+0000ef70: 6564 5f65 7665 6e74 7329 2c20 3129 0a20  ed_events), 1). 
+0000ef80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0000ef90: 7274 5472 7565 2869 7369 6e73 7461 6e63  rtTrue(isinstanc
+0000efa0: 6528 6861 726e 6573 732e 6368 6172 6d2e  e(harness.charm.
+0000efb0: 6f62 7365 7276 6564 5f65 7665 6e74 735b  observed_events[
+0000efc0: 305d 2c20 6f70 732e 5374 6f72 6167 6541  0], ops.StorageA
+0000efd0: 7474 6163 6865 6445 7665 6e74 2929 0a0a  ttachedEvent))..
+0000efe0: 2020 2020 2020 2020 2320 4164 6420 6164          # Add ad
+0000eff0: 6469 7469 6f6e 616c 2073 746f 7261 6765  ditional storage
+0000f000: 0a20 2020 2020 2020 2073 746f 725f 6964  .        stor_id
+0000f010: 7320 3d20 6861 726e 6573 732e 6164 645f  s = harness.add_
+0000f020: 7374 6f72 6167 6528 2274 6573 7422 2c20  storage("test", 
+0000f030: 636f 756e 743d 332c 2061 7474 6163 683d  count=3, attach=
+0000f040: 5472 7565 290a 2020 2020 2020 2020 2320  True).        # 
+0000f050: 4e4f 5445 3a20 7374 6f72 5f69 6420 6e6f  NOTE: stor_id no
+0000f060: 7720 7265 666c 6563 7473 2074 6865 2034  w reflects the 4
+0000f070: 7468 2049 442e 2020 5468 6520 326e 6420  th ID.  The 2nd 
+0000f080: 616e 6420 3372 6420 4944 7320 6172 6520  and 3rd IDs are 
+0000f090: 6372 6561 7465 6420 616e 640a 2020 2020  created and.    
+0000f0a0: 2020 2020 2320 7573 6564 2c20 6275 7420      # used, but 
+0000f0b0: 6e6f 7420 7265 7475 726e 6564 2062 7920  not returned by 
+0000f0c0: 4861 726e 6573 732e 6164 645f 7374 6f72  Harness.add_stor
+0000f0d0: 6167 652e 0a20 2020 2020 2020 2023 2028  age..        # (
+0000f0e0: 5368 6f75 6c64 2077 6520 636f 6e73 6964  Should we consid
+0000f0f0: 6572 2063 6861 6e67 696e 6720 6974 7320  er changing its 
+0000f100: 7265 7475 726e 2074 7970 653f 290a 0a20  return type?).. 
+0000f110: 2020 2020 2020 2061 6464 6564 5f69 6e64         added_ind
+0000f120: 6963 6573 203d 207b 7365 6c66 2e5f 6578  ices = {self._ex
+0000f130: 7472 6163 745f 7374 6f72 6167 655f 696e  tract_storage_in
+0000f140: 6465 7828 7374 6f72 5f69 6429 2066 6f72  dex(stor_id) for
+0000f150: 2073 746f 725f 6964 2069 6e20 7374 6f72   stor_id in stor
+0000f160: 5f69 6473 7d0a 2020 2020 2020 2020 7365  _ids}.        se
+0000f170: 6c66 2e61 7373 6572 7454 7275 6528 6164  lf.assertTrue(ad
+0000f180: 6465 645f 696e 6469 6365 732e 6973 7375  ded_indices.issu
+0000f190: 6273 6574 2873 6574 2868 6172 6e65 7373  bset(set(harness
+0000f1a0: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
+0000f1b0: 655f 6c69 7374 2822 7465 7374 2229 2929  e_list("test")))
+0000f1c0: 290a 0a20 2020 2020 2020 2066 6f72 2069  )..        for i
+0000f1d0: 2069 6e20 5b27 3127 2c20 2732 272c 2027   in ['1', '2', '
+0000f1e0: 3327 5d3a 0a20 2020 2020 2020 2020 2020  3']:.           
+0000f1f0: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
+0000f200: 6622 7465 7374 2f7b 697d 220a 2020 2020  f"test/{i}".    
+0000f210: 2020 2020 2020 2020 7761 6e74 203d 2073          want = s
+0000f220: 7472 2870 6174 686c 6962 2e50 7572 6550  tr(pathlib.PureP
+0000f230: 6174 6828 2774 6573 7427 2c20 6929 290a  ath('test', i)).
+0000f240: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000f250: 2e61 7373 6572 7454 7275 6528 6861 726e  .assertTrue(harn
+0000f260: 6573 732e 5f62 6163 6b65 6e64 2e73 746f  ess._backend.sto
+0000f270: 7261 6765 5f67 6574 2873 746f 7261 6765  rage_get(storage
+0000f280: 5f6e 616d 652c 2022 6c6f 6361 7469 6f6e  _name, "location
+0000f290: 2229 2e65 6e64 7377 6974 6828 7761 6e74  ").endswith(want
+0000f2a0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000f2b0: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+0000f2c0: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
+0000f2d0: 7365 7276 6564 5f65 7665 6e74 7329 2c20  served_events), 
+0000f2e0: 3429 0a20 2020 2020 2020 2066 6f72 2069  4).        for i
+0000f2f0: 2069 6e20 7261 6e67 6528 312c 2034 293a   in range(1, 4):
+0000f300: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000f310: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
+0000f320: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
+0000f330: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+0000f340: 7665 6e74 735b 695d 2c20 6f70 732e 5374  vents[i], ops.St
+0000f350: 6f72 6167 6541 7474 6163 6865 6445 7665  orageAttachedEve
+0000f360: 6e74 2929 0a0a 2020 2020 6465 6620 7465  nt))..    def te
+0000f370: 7374 5f64 6574 6163 685f 7374 6f72 6167  st_detach_storag
+0000f380: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0000f390: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+0000f3a0: 6573 7469 6e67 2e48 6172 6e65 7373 2853  esting.Harness(S
+0000f3b0: 746f 7261 6765 5465 7374 6572 2c20 6d65  torageTester, me
+0000f3c0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+0000f3d0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+0000f3e0: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+0000f3f0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+0000f400: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
+0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f420: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+0000f430: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0000f440: 7261 6765 3a0a 2020 2020 2020 2020 2020  rage:.          
+0000f450: 2020 2020 2020 7465 7374 3a0a 2020 2020        test:.    
+0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f470: 7479 7065 3a20 6669 6c65 7379 7374 656d  type: filesystem
+0000f480: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+0000f490: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0000f4a0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0000f4b0: 732e 636c 6561 6e75 7029 0a0a 2020 2020  s.cleanup)..    
+0000f4c0: 2020 2020 2320 5365 7420 7570 2069 6e69      # Set up ini
+0000f4d0: 7469 616c 2073 746f 7261 6765 0a20 2020  tial storage.   
+0000f4e0: 2020 2020 2073 746f 725f 6964 203d 2068       stor_id = h
+0000f4f0: 6172 6e65 7373 2e61 6464 5f73 746f 7261  arness.add_stora
+0000f500: 6765 2822 7465 7374 2229 5b30 5d0a 2020  ge("test")[0].  
+0000f510: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+0000f520: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
+0000f530: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
+0000f540: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f550: 6c28 6c65 6e28 6861 726e 6573 732e 6368  l(len(harness.ch
+0000f560: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
+0000f570: 6e74 7329 2c20 3129 0a20 2020 2020 2020  nts), 1).       
+0000f580: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+0000f590: 2869 7369 6e73 7461 6e63 6528 6861 726e  (isinstance(harn
+0000f5a0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+0000f5b0: 6564 5f65 7665 6e74 735b 305d 2c20 6f70  ed_events[0], op
+0000f5c0: 732e 5374 6f72 6167 6541 7474 6163 6865  s.StorageAttache
+0000f5d0: 6445 7665 6e74 2929 0a0a 2020 2020 2020  dEvent))..      
+0000f5e0: 2020 2320 4465 7461 6368 2073 746f 7261    # Detach stora
+0000f5f0: 6765 0a20 2020 2020 2020 2068 6172 6e65  ge.        harne
+0000f600: 7373 2e64 6574 6163 685f 7374 6f72 6167  ss.detach_storag
+0000f610: 6528 7374 6f72 5f69 6429 0a20 2020 2020  e(stor_id).     
+0000f620: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0000f630: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
+0000f640: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+0000f650: 7665 6e74 7329 2c20 3229 0a20 2020 2020  vents), 2).     
+0000f660: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+0000f670: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
+0000f680: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+0000f690: 7276 6564 5f65 7665 6e74 735b 315d 2c20  rved_events[1], 
+0000f6a0: 6f70 732e 5374 6f72 6167 6544 6574 6163  ops.StorageDetac
+0000f6b0: 6869 6e67 4576 656e 7429 290a 0a20 2020  hingEvent))..   
+0000f6c0: 2020 2020 2023 2056 6572 6966 7920 6261       # Verify ba
+0000f6d0: 636b 656e 6420 6675 6e63 7469 6f6e 7320  ckend functions 
+0000f6e0: 7265 7475 726e 2061 7070 726f 7072 6961  return appropria
+0000f6f0: 7465 2076 616c 7565 732e 0a20 2020 2020  te values..     
+0000f700: 2020 2023 2052 6561 6c20 6261 636b 656e     # Real backen
+0000f710: 6420 776f 756c 6420 7265 7475 726e 2069  d would return i
+0000f720: 6e66 6f20 6f6e 6c79 2066 6f72 2061 6374  nfo only for act
+0000f730: 6976 656c 7920 6174 7461 6368 6564 2073  ively attached s
+0000f740: 746f 7261 6765 2075 6e69 7473 2e0a 2020  torage units..  
+0000f750: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f760: 744e 6f74 496e 2873 746f 725f 6964 2c20  tNotIn(stor_id, 
+0000f770: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
+0000f780: 2e73 746f 7261 6765 5f6c 6973 7428 2274  .storage_list("t
+0000f790: 6573 7422 2929 0a20 2020 2020 2020 2077  est")).        w
+0000f7a0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0000f7b0: 6169 7365 7328 6f70 732e 4d6f 6465 6c45  aises(ops.ModelE
+0000f7c0: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
+0000f7d0: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
+0000f7e0: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
+0000f7f0: 655f 6765 7428 2274 6573 742f 3022 2c20  e_get("test/0", 
+0000f800: 226c 6f63 6174 696f 6e22 290a 2020 2020  "location").    
+0000f810: 2020 2020 2320 4572 726f 7220 6d65 7373      # Error mess
+0000f820: 6167 6520 6d6f 6465 6c65 6420 6166 7465  age modeled afte
+0000f830: 7220 6f75 7470 7574 206f 660a 2020 2020  r output of.    
+0000f840: 2020 2020 2320 2273 746f 7261 6765 2d67      # "storage-g
+0000f850: 6574 202d 7320 3c69 6e76 616c 6964 2f69  et -s <invalid/i
+0000f860: 6e61 6374 6976 6520 6964 3e20 6c6f 6361  nactive id> loca
+0000f870: 7469 6f6e 2220 6f6e 2072 6561 6c20 6465  tion" on real de
+0000f880: 706c 6f79 6d65 6e74 0a20 2020 2020 2020  ployment.       
+0000f890: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0000f8a0: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
+0000f8b0: 6d2e 6578 6365 7074 696f 6e2e 6172 6773  m.exception.args
+0000f8c0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+0000f8d0: 2027 4552 524f 5220 696e 7661 6c69 6420   'ERROR invalid 
+0000f8e0: 7661 6c75 6520 2274 6573 742f 3022 2066  value "test/0" f
+0000f8f0: 6f72 206f 7074 696f 6e20 2d73 3a20 7374  or option -s: st
+0000f900: 6f72 6167 6520 6e6f 7420 666f 756e 6427  orage not found'
+0000f910: 290a 0a20 2020 2020 2020 2023 2052 6574  )..        # Ret
+0000f920: 7279 2064 6574 6163 680a 2020 2020 2020  ry detach.      
+0000f930: 2020 2320 5369 6e63 6520 616c 7265 6164    # Since alread
+0000f940: 7920 6465 7461 6368 6564 2c20 6e6f 206d  y detached, no m
+0000f950: 6f72 6520 686f 6f6b 7320 7368 6f75 6c64  ore hooks should
+0000f960: 2066 6972 650a 2020 2020 2020 2020 6861   fire.        ha
+0000f970: 726e 6573 732e 6465 7461 6368 5f73 746f  rness.detach_sto
+0000f980: 7261 6765 2873 746f 725f 6964 290a 2020  rage(stor_id).  
+0000f990: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f9a0: 7445 7175 616c 286c 656e 2868 6172 6e65  tEqual(len(harne
+0000f9b0: 7373 2e63 6861 726d 2e6f 6273 6572 7665  ss.charm.observe
+0000f9c0: 645f 6576 656e 7473 292c 2032 290a 2020  d_events), 2).  
+0000f9d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000f9e0: 7454 7275 6528 6973 696e 7374 616e 6365  tTrue(isinstance
+0000f9f0: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
+0000fa00: 6273 6572 7665 645f 6576 656e 7473 5b31  bserved_events[1
+0000fa10: 5d2c 206f 7073 2e53 746f 7261 6765 4465  ], ops.StorageDe
+0000fa20: 7461 6368 696e 6745 7665 6e74 2929 0a0a  tachingEvent))..
+0000fa30: 2020 2020 6465 6620 7465 7374 5f64 6574      def test_det
+0000fa40: 6163 685f 7374 6f72 6167 655f 6265 666f  ach_storage_befo
+0000fa50: 7265 5f68 6172 6e65 7373 5f62 6567 696e  re_harness_begin
+0000fa60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000fa70: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0000fa80: 7374 696e 672e 4861 726e 6573 7328 5374  sting.Harness(St
+0000fa90: 6f72 6167 6554 6573 7465 722c 206d 6574  orageTester, met
+0000faa0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0000fab0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0000fac0: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
+0000fad0: 7569 7265 733a 0a20 2020 2020 2020 2020  uires:.         
+0000fae0: 2020 2020 2020 2064 623a 0a20 2020 2020         db:.     
+0000faf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000fb00: 6e74 6572 6661 6365 3a20 7067 7371 6c0a  nterface: pgsql.
+0000fb10: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0000fb20: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
+0000fb30: 2020 2020 2074 6573 743a 0a20 2020 2020       test:.     
+0000fb40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000fb50: 7970 653a 2066 696c 6573 7973 7465 6d0a  ype: filesystem.
+0000fb60: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0000fb70: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0000fb80: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0000fb90: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
+0000fba0: 2020 2073 746f 725f 6964 203d 2068 6172     stor_id = har
+0000fbb0: 6e65 7373 2e61 6464 5f73 746f 7261 6765  ness.add_storage
+0000fbc0: 2822 7465 7374 2229 5b30 5d0a 2020 2020  ("test")[0].    
+0000fbd0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0000fbe0: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
+0000fbf0: 6d65 4572 726f 7229 2061 7320 636d 3a0a  meError) as cm:.
+0000fc00: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+0000fc10: 6573 732e 6465 7461 6368 5f73 746f 7261  ess.detach_stora
+0000fc20: 6765 2866 2274 6573 742f 7b73 746f 725f  ge(f"test/{stor_
+0000fc30: 6964 7d22 290a 2020 2020 2020 2020 7365  id}").        se
+0000fc40: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+0000fc50: 6d2e 6578 6365 7074 696f 6e2e 6172 6773  m.exception.args
+0000fc60: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+0000fc70: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+0000fc80: 616e 6e6f 7420 6465 7461 6368 2073 746f  annot detach sto
+0000fc90: 7261 6765 2062 6566 6f72 6520 4861 726e  rage before Harn
+0000fca0: 6573 7320 6973 2069 6e69 7469 616c 6973  ess is initialis
+0000fcb0: 6564 2229 0a0a 2020 2020 6465 6620 7465  ed")..    def te
+0000fcc0: 7374 5f73 746f 7261 6765 5f77 6974 685f  st_storage_with_
+0000fcd0: 6879 7068 656e 735f 776f 726b 7328 7365  hyphens_works(se
+0000fce0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+0000fcf0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+0000fd00: 6e67 2e48 6172 6e65 7373 2853 746f 7261  ng.Harness(Stora
+0000fd10: 6765 5465 7374 6572 2c20 6d65 7461 3d27  geTester, meta='
+0000fd20: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+0000fd30: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+0000fd40: 2020 2020 2020 2020 2020 7265 7175 6972            requir
+0000fd50: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0000fd60: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
+0000fd70: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+0000fd80: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
+0000fd90: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0000fda0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000fdb0: 2020 7465 7374 3a0a 2020 2020 2020 2020    test:.        
+0000fdc0: 2020 2020 2020 2020 2020 2020 7479 7065              type
+0000fdd0: 3a20 6669 6c65 7379 7374 656d 0a20 2020  : filesystem.   
+0000fde0: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+0000fdf0: 742d 7769 7468 2d68 7970 6865 6e73 3a0a  t-with-hyphens:.
+0000fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe10: 2020 2020 7479 7065 3a20 6669 6c65 7379      type: filesy
+0000fe20: 7374 656d 0a20 2020 2020 2020 2020 2020  stem.           
+0000fe30: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+0000fe40: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+0000fe50: 726e 6573 732e 636c 6561 6e75 7029 0a0a  rness.cleanup)..
+0000fe60: 2020 2020 2020 2020 2320 5365 7420 7570          # Set up
+0000fe70: 2069 6e69 7469 616c 2073 746f 7261 6765   initial storage
+0000fe80: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0000fe90: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
+0000fea0: 2068 656c 7065 7220 3d20 5374 6f72 6167   helper = Storag
+0000feb0: 6557 6974 6848 7970 6865 6e73 4865 6c70  eWithHyphensHelp
+0000fec0: 6572 2868 6172 6e65 7373 2e63 6861 726d  er(harness.charm
+0000fed0: 2c20 2268 656c 7065 7222 290a 2020 2020  , "helper").    
+0000fee0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+0000fef0: 7374 6f72 6167 6528 2274 6573 742d 7769  storage("test-wi
+0000ff00: 7468 2d68 7970 6865 6e73 222c 2061 7474  th-hyphens", att
+0000ff10: 6163 683d 5472 7565 295b 305d 0a0a 2020  ach=True)[0]..  
+0000ff20: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0000ff30: 7445 7175 616c 286c 656e 2868 656c 7065  tEqual(len(helpe
+0000ff40: 722e 6368 616e 6765 7329 2c20 3129 0a0a  r.changes), 1)..
+0000ff50: 2020 2020 6465 6620 7465 7374 5f61 7474      def test_att
+0000ff60: 6163 685f 7374 6f72 6167 6528 7365 6c66  ach_storage(self
+0000ff70: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+0000ff80: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+0000ff90: 2e48 6172 6e65 7373 2853 746f 7261 6765  .Harness(Storage
+0000ffa0: 5465 7374 6572 2c20 6d65 7461 3d27 2727  Tester, meta='''
+0000ffb0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0000ffc0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+0000ffd0: 2020 2020 2020 2020 7265 7175 6972 6573          requires
+0000ffe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000fff0: 2020 6462 3a0a 2020 2020 2020 2020 2020    db:.          
+00010000: 2020 2020 2020 2020 2020 696e 7465 7266            interf
+00010010: 6163 653a 2070 6773 716c 0a20 2020 2020  ace: pgsql.     
+00010020: 2020 2020 2020 2073 746f 7261 6765 3a0a         storage:.
+00010030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010040: 7465 7374 3a0a 2020 2020 2020 2020 2020  test:.          
+00010050: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
+00010060: 6669 6c65 7379 7374 656d 0a20 2020 2020  filesystem.     
+00010070: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+00010080: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+00010090: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+000100a0: 6e75 7029 0a0a 2020 2020 2020 2020 2320  nup)..        # 
+000100b0: 5365 7420 7570 2069 6e69 7469 616c 2073  Set up initial s
+000100c0: 746f 7261 6765 0a20 2020 2020 2020 2073  torage.        s
+000100d0: 746f 725f 6964 203d 2068 6172 6e65 7373  tor_id = harness
+000100e0: 2e61 6464 5f73 746f 7261 6765 2822 7465  .add_storage("te
+000100f0: 7374 2229 5b30 5d0a 2020 2020 2020 2020  st")[0].        
+00010100: 6861 726e 6573 732e 6265 6769 6e5f 7769  harness.begin_wi
+00010110: 7468 5f69 6e69 7469 616c 5f68 6f6f 6b73  th_initial_hooks
+00010120: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00010130: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+00010140: 6861 726e 6573 732e 6368 6172 6d2e 6f62  harness.charm.ob
+00010150: 7365 7276 6564 5f65 7665 6e74 7329 2c20  served_events), 
+00010160: 3129 0a20 2020 2020 2020 2073 656c 662e  1).        self.
+00010170: 6173 7365 7274 5472 7565 2869 7369 6e73  assertTrue(isins
+00010180: 7461 6e63 6528 6861 726e 6573 732e 6368  tance(harness.ch
+00010190: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
+000101a0: 6e74 735b 305d 2c20 6f70 732e 5374 6f72  nts[0], ops.Stor
+000101b0: 6167 6541 7474 6163 6865 6445 7665 6e74  ageAttachedEvent
+000101c0: 2929 0a0a 2020 2020 2020 2020 2320 4465  ))..        # De
+000101d0: 7461 6368 2073 746f 7261 6765 0a20 2020  tach storage.   
+000101e0: 2020 2020 2068 6172 6e65 7373 2e64 6574       harness.det
+000101f0: 6163 685f 7374 6f72 6167 6528 7374 6f72  ach_storage(stor
+00010200: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
+00010210: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+00010220: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
+00010230: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
+00010240: 2c20 3229 0a20 2020 2020 2020 2073 656c  , 2).        sel
+00010250: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
+00010260: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
+00010270: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+00010280: 7665 6e74 735b 315d 2c20 6f70 732e 5374  vents[1], ops.St
+00010290: 6f72 6167 6544 6574 6163 6869 6e67 4576  orageDetachingEv
+000102a0: 656e 7429 290a 0a20 2020 2020 2020 2023  ent))..        #
+000102b0: 2052 652d 6174 7461 6368 2073 746f 7261   Re-attach stora
+000102c0: 6765 0a20 2020 2020 2020 2068 6172 6e65  ge.        harne
+000102d0: 7373 2e61 7474 6163 685f 7374 6f72 6167  ss.attach_storag
+000102e0: 6528 7374 6f72 5f69 6429 0a20 2020 2020  e(stor_id).     
+000102f0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00010300: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
+00010310: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+00010320: 7665 6e74 7329 2c20 3329 0a20 2020 2020  vents), 3).     
+00010330: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+00010340: 7565 2869 7369 6e73 7461 6e63 6528 6861  ue(isinstance(ha
+00010350: 726e 6573 732e 6368 6172 6d2e 6f62 7365  rness.charm.obse
+00010360: 7276 6564 5f65 7665 6e74 735b 325d 2c20  rved_events[2], 
+00010370: 6f70 732e 5374 6f72 6167 6541 7474 6163  ops.StorageAttac
+00010380: 6865 6445 7665 6e74 2929 0a0a 2020 2020  hedEvent))..    
+00010390: 2020 2020 2320 5665 7269 6679 2062 6163      # Verify bac
+000103a0: 6b65 6e64 2066 756e 6374 696f 6e73 2072  kend functions r
+000103b0: 6574 7572 6e20 6170 7072 6f70 7269 6174  eturn appropriat
+000103c0: 6520 7661 6c75 6573 2e0a 2020 2020 2020  e values..      
+000103d0: 2020 2320 5265 616c 2062 6163 6b65 6e64    # Real backend
+000103e0: 2077 6f75 6c64 2072 6574 7572 6e20 696e   would return in
+000103f0: 666f 206f 6e6c 7920 666f 7220 6163 7469  fo only for acti
+00010400: 7665 6c79 2061 7474 6163 6865 6420 7374  vely attached st
+00010410: 6f72 6167 6520 756e 6974 732e 0a20 2020  orage units..   
+00010420: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00010430: 496e 2873 656c 662e 5f65 7874 7261 6374  In(self._extract
+00010440: 5f73 746f 7261 6765 5f69 6e64 6578 2873  _storage_index(s
+00010450: 746f 725f 6964 292c 2068 6172 6e65 7373  tor_id), harness
+00010460: 2e5f 6261 636b 656e 642e 7374 6f72 6167  ._backend.storag
+00010470: 655f 6c69 7374 2822 7465 7374 2229 290a  e_list("test")).
+00010480: 2020 2020 2020 2020 7761 6e74 203d 2073          want = s
+00010490: 7472 2870 6174 686c 6962 2e50 7572 6550  tr(pathlib.PureP
+000104a0: 6174 6828 2774 6573 7427 2c20 2730 2729  ath('test', '0')
+000104b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000104c0: 7373 6572 7445 7175 616c 2877 616e 742c  ssertEqual(want,
+000104d0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
+000104e0: 642e 7374 6f72 6167 655f 6765 7428 2274  d.storage_get("t
+000104f0: 6573 742f 3022 2c20 226c 6f63 6174 696f  est/0", "locatio
+00010500: 6e22 295b 2d36 3a5d 290a 0a20 2020 2020  n")[-6:])..     
+00010510: 2020 2023 2052 6574 7279 2061 7474 6163     # Retry attac
+00010520: 680a 2020 2020 2020 2020 2320 5369 6e63  h.        # Sinc
+00010530: 6520 616c 7265 6164 7920 6465 7461 6368  e already detach
+00010540: 6564 2c20 6e6f 206d 6f72 6520 686f 6f6b  ed, no more hook
+00010550: 7320 7368 6f75 6c64 2066 6972 650a 2020  s should fire.  
+00010560: 2020 2020 2020 6861 726e 6573 732e 6174        harness.at
+00010570: 7461 6368 5f73 746f 7261 6765 2873 746f  tach_storage(sto
+00010580: 725f 6964 290a 2020 2020 2020 2020 7365  r_id).        se
+00010590: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+000105a0: 656e 2868 6172 6e65 7373 2e63 6861 726d  en(harness.charm
+000105b0: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
+000105c0: 292c 2033 290a 2020 2020 2020 2020 7365  ), 3).        se
+000105d0: 6c66 2e61 7373 6572 7454 7275 6528 6973  lf.assertTrue(is
+000105e0: 696e 7374 616e 6365 2868 6172 6e65 7373  instance(harness
+000105f0: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
+00010600: 6576 656e 7473 5b32 5d2c 206f 7073 2e53  events[2], ops.S
+00010610: 746f 7261 6765 4174 7461 6368 6564 4576  torageAttachedEv
+00010620: 656e 7429 290a 0a20 2020 2064 6566 2074  ent))..    def t
+00010630: 6573 745f 6174 7461 6368 5f73 746f 7261  est_attach_stora
+00010640: 6765 5f62 6566 6f72 655f 6861 726e 6573  ge_before_harnes
+00010650: 735f 6265 6769 6e28 7365 6c66 293a 0a20  s_begin(self):. 
+00010660: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+00010670: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00010680: 6e65 7373 2853 746f 7261 6765 5465 7374  ness(StorageTest
+00010690: 6572 2c20 6d65 7461 3d27 2727 0a20 2020  er, meta='''.   
+000106a0: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
+000106b0: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
+000106c0: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+000106d0: 2020 2020 2020 2020 2020 2020 2020 6462                db
+000106e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000106f0: 2020 2020 2020 696e 7465 7266 6163 653a        interface:
+00010700: 2070 6773 716c 0a20 2020 2020 2020 2020   pgsql.         
+00010710: 2020 2073 746f 7261 6765 3a0a 2020 2020     storage:.    
+00010720: 2020 2020 2020 2020 2020 2020 7465 7374              test
+00010730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010740: 2020 2020 2020 7479 7065 3a20 6669 6c65        type: file
+00010750: 7379 7374 656d 0a20 2020 2020 2020 2020  system.         
+00010760: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00010770: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+00010780: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+00010790: 0a0a 2020 2020 2020 2020 2320 5765 2064  ..        # We d
+000107a0: 656c 6962 6572 6174 656c 7920 646f 6e27  eliberately don'
+000107b0: 7420 6775 6172 6420 6167 6169 6e73 7420  t guard against 
+000107c0: 6174 7461 6368 696e 6720 7374 6f72 6167  attaching storag
+000107d0: 6520 6265 666f 7265 2074 6865 2068 6172  e before the har
+000107e0: 6e65 7373 2062 6567 696e 732c 0a20 2020  ness begins,.   
+000107f0: 2020 2020 2023 2061 7320 7468 6572 6520       # as there 
+00010800: 6172 6520 6c65 6769 7469 6d61 7465 2072  are legitimate r
+00010810: 6561 736f 6e73 2074 6f20 646f 2073 6f2e  easons to do so.
+00010820: 0a20 2020 2020 2020 2073 746f 725f 6964  .        stor_id
+00010830: 203d 2068 6172 6e65 7373 2e61 6464 5f73   = harness.add_s
+00010840: 746f 7261 6765 2822 7465 7374 2229 5b30  torage("test")[0
+00010850: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+00010860: 7373 6572 7454 7275 6528 7374 6f72 5f69  ssertTrue(stor_i
+00010870: 6429 0a0a 2020 2020 6465 6620 7465 7374  d)..    def test
+00010880: 5f72 656d 6f76 655f 7374 6f72 6167 655f  _remove_storage_
+00010890: 6265 666f 7265 5f68 6172 6e65 7373 5f62  before_harness_b
+000108a0: 6567 696e 2873 656c 6629 3a0a 2020 2020  egin(self):.    
+000108b0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+000108c0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+000108d0: 7328 5374 6f72 6167 6554 6573 7465 722c  s(StorageTester,
+000108e0: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+000108f0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+00010900: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+00010910: 2072 6571 7569 7265 733a 0a20 2020 2020   requires:.     
+00010920: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+00010930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010940: 2020 2069 6e74 6572 6661 6365 3a20 7067     interface: pg
+00010950: 7371 6c0a 2020 2020 2020 2020 2020 2020  sql.            
+00010960: 7374 6f72 6167 653a 0a20 2020 2020 2020  storage:.       
+00010970: 2020 2020 2020 2020 2074 6573 743a 0a20           test:. 
+00010980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010990: 2020 2074 7970 653a 2066 696c 6573 7973     type: filesys
+000109a0: 7465 6d0a 2020 2020 2020 2020 2020 2020  tem.            
+000109b0: 2020 2020 2020 2020 6d75 6c74 6970 6c65          multiple
+000109c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000109d0: 2020 2020 2020 2020 2020 7261 6e67 653a            range:
+000109e0: 2031 2d33 0a20 2020 2020 2020 2020 2020   1-3.           
+000109f0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00010a00: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00010a10: 726e 6573 732e 636c 6561 6e75 7029 0a0a  rness.cleanup)..
+00010a20: 2020 2020 2020 2020 7374 6f72 5f69 6473          stor_ids
+00010a30: 203d 2068 6172 6e65 7373 2e61 6464 5f73   = harness.add_s
+00010a40: 746f 7261 6765 2822 7465 7374 222c 2063  torage("test", c
+00010a50: 6f75 6e74 3d32 290a 2020 2020 2020 2020  ount=2).        
+00010a60: 6861 726e 6573 732e 7265 6d6f 7665 5f73  harness.remove_s
+00010a70: 746f 7261 6765 2873 746f 725f 6964 735b  torage(stor_ids[
+00010a80: 305d 290a 2020 2020 2020 2020 2320 4e6f  0]).        # No
+00010a90: 7465 2072 653a 2064 656c 7461 2062 6574  te re: delta bet
+00010aa0: 7765 656e 2072 6561 6c20 6265 6861 7669  ween real behavi
+00010ab0: 6f72 2061 6e64 2048 6172 6e65 7373 3a20  or and Harness: 
+00010ac0: 4a75 6a75 2064 6f65 736e 2774 2061 6c6c  Juju doesn't all
+00010ad0: 6f77 2072 656d 6f76 616c 0a20 2020 2020  ow removal.     
+00010ae0: 2020 2023 206f 6620 7468 6520 6c61 7374     # of the last
+00010af0: 2061 7474 6163 6865 6420 7374 6f72 6167   attached storag
+00010b00: 6520 756e 6974 2077 6869 6c65 2061 2077  e unit while a w
+00010b10: 6f72 6b6c 6f61 6420 6973 2073 7469 6c6c  orkload is still
+00010b20: 2072 756e 6e69 6e67 2e20 2054 6f20 6d6f   running.  To mo
+00010b30: 7265 0a20 2020 2020 2020 2023 2065 6173  re.        # eas
+00010b40: 696c 7920 616c 6c6f 7720 7465 7374 696e  ily allow testin
+00010b50: 6720 6f66 2073 746f 7261 6765 2072 656d  g of storage rem
+00010b60: 6f76 616c 2c20 4920 616d 2070 7265 7365  oval, I am prese
+00010b70: 6e74 6c79 2069 676e 6f72 696e 6720 7468  ntly ignoring th
+00010b80: 6973 2064 6574 6169 6c2e 0a20 2020 2020  is detail..     
+00010b90: 2020 2023 2028 4f74 6865 7277 6973 652c     # (Otherwise,
+00010ba0: 2074 6865 2075 7365 7220 776f 756c 6420   the user would 
+00010bb0: 6e65 6564 2074 6f20 666c 6167 2073 6f6d  need to flag som
+00010bc0: 6568 6f77 2074 6861 7420 7468 6579 2061  ehow that they a
+00010bd0: 7265 2069 6e74 656e 7469 6f6e 616c 6c79  re intentionally
+00010be0: 0a20 2020 2020 2020 2023 2072 656d 6f76  .        # remov
+00010bf0: 696e 6720 7468 6520 6669 6e61 6c20 756e  ing the final un
+00010c00: 6974 2061 7320 7061 7274 206f 6620 6120  it as part of a 
+00010c10: 7368 7574 646f 776e 2070 726f 6365 6475  shutdown procedu
+00010c20: 7265 2c20 656c 7365 2069 7427 6420 626c  re, else it'd bl
+00010c30: 6f63 6b20 7468 650a 2020 2020 2020 2020  ock the.        
+00010c40: 2320 7265 6d6f 7661 6c2e 2020 4927 6d20  # removal.  I'm 
+00010c50: 6e6f 7420 7375 7265 2073 7563 6820 6265  not sure such be
+00010c60: 6861 7669 6f72 2069 7320 7072 6f64 7563  havior is produc
+00010c70: 7469 7665 2e29 0a0a 2020 2020 2020 2020  tive.)..        
+00010c80: 6861 726e 6573 732e 6265 6769 6e5f 7769  harness.begin_wi
+00010c90: 7468 5f69 6e69 7469 616c 5f68 6f6f 6b73  th_initial_hooks
+00010ca0: 2829 0a20 2020 2020 2020 2023 204f 6e6c  ().        # Onl
+00010cb0: 7920 6f6e 6520 686f 6f6b 2077 696c 6c20  y one hook will 
+00010cc0: 6669 7265 3b20 6f6e 6520 776f 6e27 7420  fire; one won't 
+00010cd0: 7369 6e63 6520 6974 2077 6173 2072 656d  since it was rem
+00010ce0: 6f76 6564 0a20 2020 2020 2020 2073 656c  oved.        sel
+00010cf0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+00010d00: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
+00010d10: 6f62 7365 7276 6564 5f65 7665 6e74 7329  observed_events)
+00010d20: 2c20 3129 0a20 2020 2020 2020 2073 656c  , 1).        sel
+00010d30: 662e 6173 7365 7274 5472 7565 2869 7369  f.assertTrue(isi
+00010d40: 6e73 7461 6e63 6528 6861 726e 6573 732e  nstance(harness.
+00010d50: 6368 6172 6d2e 6f62 7365 7276 6564 5f65  charm.observed_e
+00010d60: 7665 6e74 735b 305d 2c20 6f70 732e 5374  vents[0], ops.St
+00010d70: 6f72 6167 6541 7474 6163 6865 6445 7665  orageAttachedEve
+00010d80: 6e74 2929 0a0a 2020 2020 6465 6620 7465  nt))..    def te
+00010d90: 7374 5f72 656d 6f76 655f 7374 6f72 6167  st_remove_storag
+00010da0: 655f 7769 7468 6f75 745f 6d65 7461 6461  e_without_metada
+00010db0: 7461 5f6b 6579 5f66 6169 6c73 2873 656c  ta_key_fails(sel
+00010dc0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00010dd0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00010de0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00010df0: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
+00010e00: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
+00010e10: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
+00010e20: 2020 2020 2020 2020 2072 6571 7569 7265           require
+00010e30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00010e40: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+00010e50: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00010e60: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
+00010e70: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+00010e80: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+00010e90: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+00010ea0: 616e 7570 290a 0a20 2020 2020 2020 2023  anup)..        #
+00010eb0: 2044 6f65 736e 2774 2072 6561 6c6c 7920   Doesn't really 
+00010ec0: 6d61 6b65 2073 656e 7365 2073 696e 6365  make sense since
+00010ed0: 2077 6520 616c 7265 6164 7920 6361 6e27   we already can'
+00010ee0: 7420 6164 6420 7374 6f72 6167 6520 7768  t add storage wh
+00010ef0: 6963 6820 6973 6e27 7420 696e 2074 6865  ich isn't in the
+00010f00: 206d 6574 6164 6174 612c 0a20 2020 2020   metadata,.     
+00010f10: 2020 2023 2062 7574 2069 6e63 6c75 6465     # but include
+00010f20: 6420 666f 7220 636f 6d70 6c65 7465 6e65  d for completene
+00010f30: 7373 2e0a 2020 2020 2020 2020 7769 7468  ss..        with
+00010f40: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00010f50: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
+00010f60: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
+00010f70: 2020 2020 6861 726e 6573 732e 7265 6d6f      harness.remo
+00010f80: 7665 5f73 746f 7261 6765 2822 7465 7374  ve_storage("test
+00010f90: 2f30 2229 0a20 2020 2020 2020 2073 656c  /0").        sel
+00010fa0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00010fb0: 2020 2020 2020 2020 2020 2063 6d2e 6578             cm.ex
+00010fc0: 6365 7074 696f 6e2e 6172 6773 5b30 5d2c  ception.args[0],
+00010fd0: 0a20 2020 2020 2020 2020 2020 2022 7468  .            "th
+00010fe0: 6520 6b65 7920 2774 6573 7427 2069 7320  e key 'test' is 
+00010ff0: 6e6f 7420 7370 6563 6966 6965 6420 6173  not specified as
+00011000: 2061 2073 746f 7261 6765 206b 6579 2069   a storage key i
+00011010: 6e20 6d65 7461 6461 7461 2229 0a0a 2020  n metadata")..  
+00011020: 2020 6465 6620 7465 7374 5f72 656d 6f76    def test_remov
+00011030: 655f 7374 6f72 6167 655f 6166 7465 725f  e_storage_after_
+00011040: 6861 726e 6573 735f 6265 6769 6e28 7365  harness_begin(se
+00011050: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
+00011060: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00011070: 6e67 2e48 6172 6e65 7373 2853 746f 7261  ng.Harness(Stora
+00011080: 6765 5465 7374 6572 2c20 6d65 7461 3d27  geTester, meta='
+00011090: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
+000110a0: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
+000110b0: 2020 2020 2020 2020 2020 7265 7175 6972            requir
+000110c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000110d0: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
+000110e0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+000110f0: 7266 6163 653a 2070 6773 716c 0a20 2020  rface: pgsql.   
+00011100: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+00011110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011120: 2020 7465 7374 3a0a 2020 2020 2020 2020    test:.        
+00011130: 2020 2020 2020 2020 2020 2020 7479 7065              type
+00011140: 3a20 6669 6c65 7379 7374 656d 0a20 2020  : filesystem.   
+00011150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011160: 206d 756c 7469 706c 653a 0a20 2020 2020   multiple:.     
+00011170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011180: 2020 2072 616e 6765 3a20 312d 330a 2020     range: 1-3.  
+00011190: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+000111a0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+000111b0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+000111c0: 6c65 616e 7570 290a 0a20 2020 2020 2020  leanup)..       
+000111d0: 2073 746f 725f 6964 7320 3d20 6861 726e   stor_ids = harn
+000111e0: 6573 732e 6164 645f 7374 6f72 6167 6528  ess.add_storage(
+000111f0: 2274 6573 7422 2c20 636f 756e 743d 3229  "test", count=2)
+00011200: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00011210: 2e62 6567 696e 5f77 6974 685f 696e 6974  .begin_with_init
+00011220: 6961 6c5f 686f 6f6b 7328 290a 2020 2020  ial_hooks().    
+00011230: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00011240: 7175 616c 286c 656e 2868 6172 6e65 7373  qual(len(harness
+00011250: 2e63 6861 726d 2e6f 6273 6572 7665 645f  .charm.observed_
+00011260: 6576 656e 7473 292c 2032 290a 2020 2020  events), 2).    
+00011270: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+00011280: 7275 6528 6973 696e 7374 616e 6365 2868  rue(isinstance(h
+00011290: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
+000112a0: 6572 7665 645f 6576 656e 7473 5b30 5d2c  erved_events[0],
+000112b0: 206f 7073 2e53 746f 7261 6765 4174 7461   ops.StorageAtta
+000112c0: 6368 6564 4576 656e 7429 290a 2020 2020  chedEvent)).    
+000112d0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+000112e0: 7275 6528 6973 696e 7374 616e 6365 2868  rue(isinstance(h
+000112f0: 6172 6e65 7373 2e63 6861 726d 2e6f 6273  arness.charm.obs
+00011300: 6572 7665 645f 6576 656e 7473 5b31 5d2c  erved_events[1],
+00011310: 206f 7073 2e53 746f 7261 6765 4174 7461   ops.StorageAtta
+00011320: 6368 6564 4576 656e 7429 290a 0a20 2020  chedEvent))..   
+00011330: 2020 2020 2068 6172 6e65 7373 2e72 656d       harness.rem
+00011340: 6f76 655f 7374 6f72 6167 6528 7374 6f72  ove_storage(stor
+00011350: 5f69 6473 5b31 5d29 0a20 2020 2020 2020  _ids[1]).       
+00011360: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00011370: 6c28 6c65 6e28 6861 726e 6573 732e 6368  l(len(harness.ch
+00011380: 6172 6d2e 6f62 7365 7276 6564 5f65 7665  arm.observed_eve
+00011390: 6e74 7329 2c20 3329 0a20 2020 2020 2020  nts), 3).       
+000113a0: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
+000113b0: 2869 7369 6e73 7461 6e63 6528 6861 726e  (isinstance(harn
+000113c0: 6573 732e 6368 6172 6d2e 6f62 7365 7276  ess.charm.observ
+000113d0: 6564 5f65 7665 6e74 735b 325d 2c20 6f70  ed_events[2], op
+000113e0: 732e 5374 6f72 6167 6544 6574 6163 6869  s.StorageDetachi
+000113f0: 6e67 4576 656e 7429 290a 0a20 2020 2020  ngEvent))..     
+00011400: 2020 2061 7474 6163 6865 645f 7374 6f72     attached_stor
+00011410: 6167 655f 6964 7320 3d20 6861 726e 6573  age_ids = harnes
+00011420: 732e 5f62 6163 6b65 6e64 2e73 746f 7261  s._backend.stora
+00011430: 6765 5f6c 6973 7428 2274 6573 7422 290a  ge_list("test").
+00011440: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00011450: 6572 7449 6e28 7365 6c66 2e5f 6578 7472  ertIn(self._extr
+00011460: 6163 745f 7374 6f72 6167 655f 696e 6465  act_storage_inde
+00011470: 7828 7374 6f72 5f69 6473 5b30 5d29 2c20  x(stor_ids[0]), 
+00011480: 6174 7461 6368 6564 5f73 746f 7261 6765  attached_storage
+00011490: 5f69 6473 290a 2020 2020 2020 2020 7365  _ids).        se
+000114a0: 6c66 2e61 7373 6572 744e 6f74 496e 2873  lf.assertNotIn(s
+000114b0: 656c 662e 5f65 7874 7261 6374 5f73 746f  elf._extract_sto
+000114c0: 7261 6765 5f69 6e64 6578 2873 746f 725f  rage_index(stor_
+000114d0: 6964 735b 315d 292c 2061 7474 6163 6865  ids[1]), attache
+000114e0: 645f 7374 6f72 6167 655f 6964 7329 0a0a  d_storage_ids)..
+000114f0: 2020 2020 6465 6620 5f65 7874 7261 6374      def _extract
+00011500: 5f73 746f 7261 6765 5f69 6e64 6578 2873  _storage_index(s
+00011510: 656c 662c 2073 746f 725f 6964 293a 0a20  elf, stor_id):. 
+00011520: 2020 2020 2020 2072 6574 7572 6e20 696e         return in
+00011530: 7428 7374 6f72 5f69 642e 7370 6c69 7428  t(stor_id.split(
+00011540: 272f 2729 5b2d 315d 290a 0a20 2020 2064  '/')[-1])..    d
+00011550: 6566 2074 6573 745f 7265 6d6f 7665 5f64  ef test_remove_d
+00011560: 6574 6163 6865 645f 7374 6f72 6167 6528  etached_storage(
+00011570: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+00011580: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00011590: 7469 6e67 2e48 6172 6e65 7373 2853 746f  ting.Harness(Sto
+000115a0: 7261 6765 5465 7374 6572 2c20 6d65 7461  rageTester, meta
+000115b0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+000115c0: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
+000115d0: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+000115e0: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+000115f0: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
+00011600: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00011610: 7465 7266 6163 653a 2070 6773 716c 0a20  terface: pgsql. 
+00011620: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+00011630: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+00011640: 2020 2020 7465 7374 3a0a 2020 2020 2020      test:.      
+00011650: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+00011660: 7065 3a20 6669 6c65 7379 7374 656d 0a20  pe: filesystem. 
+00011670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011680: 2020 206d 756c 7469 706c 653a 0a20 2020     multiple:.   
+00011690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000116a0: 2020 2020 2072 616e 6765 3a20 312d 330a       range: 1-3.
+000116b0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+000116c0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+000116d0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+000116e0: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
+000116f0: 2020 2073 746f 725f 6964 7320 3d20 6861     stor_ids = ha
+00011700: 726e 6573 732e 6164 645f 7374 6f72 6167  rness.add_storag
+00011710: 6528 2274 6573 7422 2c20 636f 756e 743d  e("test", count=
+00011720: 3229 0a20 2020 2020 2020 2068 6172 6e65  2).        harne
+00011730: 7373 2e62 6567 696e 5f77 6974 685f 696e  ss.begin_with_in
+00011740: 6974 6961 6c5f 686f 6f6b 7328 290a 2020  itial_hooks().  
+00011750: 2020 2020 2020 6861 726e 6573 732e 6465        harness.de
+00011760: 7461 6368 5f73 746f 7261 6765 2873 746f  tach_storage(sto
+00011770: 725f 6964 735b 305d 290a 2020 2020 2020  r_ids[0]).      
+00011780: 2020 6861 726e 6573 732e 7265 6d6f 7665    harness.remove
+00011790: 5f73 746f 7261 6765 2873 746f 725f 6964  _storage(stor_id
+000117a0: 735b 305d 2920 2023 2041 6c72 6561 6479  s[0])  # Already
+000117b0: 2064 6574 6163 6865 642c 2073 6f20 776f   detached, so wo
+000117c0: 6e27 7420 6669 7265 2061 2068 6f6f 6b0a  n't fire a hook.
+000117d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000117e0: 6572 7445 7175 616c 286c 656e 2868 6172  ertEqual(len(har
+000117f0: 6e65 7373 2e63 6861 726d 2e6f 6273 6572  ness.charm.obser
+00011800: 7665 645f 6576 656e 7473 292c 2033 290a  ved_events), 3).
+00011810: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00011820: 6572 7454 7275 6528 6973 696e 7374 616e  ertTrue(isinstan
+00011830: 6365 2868 6172 6e65 7373 2e63 6861 726d  ce(harness.charm
+00011840: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
+00011850: 5b30 5d2c 206f 7073 2e53 746f 7261 6765  [0], ops.Storage
+00011860: 4174 7461 6368 6564 4576 656e 7429 290a  AttachedEvent)).
+00011870: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00011880: 6572 7454 7275 6528 6973 696e 7374 616e  ertTrue(isinstan
+00011890: 6365 2868 6172 6e65 7373 2e63 6861 726d  ce(harness.charm
+000118a0: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
+000118b0: 5b31 5d2c 206f 7073 2e53 746f 7261 6765  [1], ops.Storage
+000118c0: 4174 7461 6368 6564 4576 656e 7429 290a  AttachedEvent)).
+000118d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000118e0: 6572 7454 7275 6528 6973 696e 7374 616e  ertTrue(isinstan
+000118f0: 6365 2868 6172 6e65 7373 2e63 6861 726d  ce(harness.charm
+00011900: 2e6f 6273 6572 7665 645f 6576 656e 7473  .observed_events
+00011910: 5b32 5d2c 206f 7073 2e53 746f 7261 6765  [2], ops.Storage
+00011920: 4465 7461 6368 696e 6745 7665 6e74 2929  DetachingEvent))
+00011930: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+00011940: 6374 696f 6e73 5f66 726f 6d5f 6469 7265  ctions_from_dire
+00011950: 6374 6f72 7928 7365 6c66 293a 0a20 2020  ctory(self):.   
+00011960: 2020 2020 2074 6d70 203d 2070 6174 686c       tmp = pathl
+00011970: 6962 2e50 6174 6828 7465 6d70 6669 6c65  ib.Path(tempfile
+00011980: 2e6d 6b64 7465 6d70 2829 290a 2020 2020  .mkdtemp()).    
+00011990: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+000119a0: 6e75 7028 7368 7574 696c 2e72 6d74 7265  nup(shutil.rmtre
+000119b0: 652c 2073 7472 2874 6d70 2929 0a20 2020  e, str(tmp)).   
+000119c0: 2020 2020 2061 6374 696f 6e73 5f66 696c       actions_fil
+000119d0: 656e 616d 6520 3d20 746d 7020 2f20 2761  ename = tmp / 'a
+000119e0: 6374 696f 6e73 2e79 616d 6c27 0a20 2020  ctions.yaml'.   
+000119f0: 2020 2020 2077 6974 6820 6163 7469 6f6e       with action
+00011a00: 735f 6669 6c65 6e61 6d65 2e6f 7065 6e28  s_filename.open(
+00011a10: 2777 7427 2920 6173 2061 6374 696f 6e73  'wt') as actions
+00011a20: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
+00011a30: 7469 6f6e 732e 7772 6974 6528 7465 7874  tions.write(text
+00011a40: 7772 6170 2e64 6564 656e 7428 2727 270a  wrap.dedent('''.
+00011a50: 2020 2020 2020 2020 2020 2020 7465 7374              test
+00011a60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011a70: 2020 6465 7363 7269 7074 696f 6e3a 2061    description: a
+00011a80: 2064 756d 6d79 2061 6374 696f 6e0a 2020   dummy action.  
+00011a90: 2020 2020 2020 2020 2020 2727 2729 290a            ''')).
+00011aa0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+00011ab0: 3d20 7365 6c66 2e5f 6765 745f 6475 6d6d  = self._get_dumm
+00011ac0: 795f 6368 6172 6d5f 6861 726e 6573 7328  y_charm_harness(
+00011ad0: 746d 7029 0a20 2020 2020 2020 2068 6172  tmp).        har
+00011ae0: 6e65 7373 2e62 6567 696e 2829 0a20 2020  ness.begin().   
+00011af0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00011b00: 4571 7561 6c28 6c69 7374 2868 6172 6e65  Equal(list(harne
+00011b10: 7373 2e66 7261 6d65 776f 726b 2e6d 6574  ss.framework.met
+00011b20: 612e 6163 7469 6f6e 7329 2c20 5b27 7465  a.actions), ['te
+00011b30: 7374 275d 290a 2020 2020 2020 2020 2320  st']).        # 
+00011b40: 5468 6520 6368 6172 6d5f 6469 7220 616c  The charm_dir al
+00011b50: 736f 2067 6574 7320 7365 740a 2020 2020  so gets set.    
+00011b60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00011b70: 7175 616c 2868 6172 6e65 7373 2e66 7261  qual(harness.fra
+00011b80: 6d65 776f 726b 2e63 6861 726d 5f64 6972  mework.charm_dir
+00011b90: 2c20 746d 7029 0a0a 2020 2020 6465 6620  , tmp)..    def 
+00011ba0: 5f67 6574 5f64 756d 6d79 5f63 6861 726d  _get_dummy_charm
+00011bb0: 5f68 6172 6e65 7373 2873 656c 662c 2074  _harness(self, t
+00011bc0: 6d70 293a 0a20 2020 2020 2020 2073 656c  mp):.        sel
+00011bd0: 662e 5f77 7269 7465 5f64 756d 6d79 5f63  f._write_dummy_c
+00011be0: 6861 726d 2874 6d70 290a 2020 2020 2020  harm(tmp).      
+00011bf0: 2020 6368 6172 6d5f 6d6f 6420 3d20 696d    charm_mod = im
+00011c00: 706f 7274 6c69 622e 696d 706f 7274 5f6d  portlib.import_m
+00011c10: 6f64 756c 6528 2774 6573 7463 6861 726d  odule('testcharm
+00011c20: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
+00011c30: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+00011c40: 2e48 6172 6e65 7373 2863 6861 726d 5f6d  .Harness(charm_m
+00011c50: 6f64 2e4d 7954 6573 7469 6e67 4368 6172  od.MyTestingChar
+00011c60: 6d29 0a20 2020 2020 2020 2073 656c 662e  m).        self.
+00011c70: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00011c80: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+00011c90: 2020 2020 7265 7475 726e 2068 6172 6e65      return harne
+00011ca0: 7373 0a0a 2020 2020 6465 6620 5f77 7269  ss..    def _wri
+00011cb0: 7465 5f64 756d 6d79 5f63 6861 726d 2873  te_dummy_charm(s
+00011cc0: 656c 662c 2074 6d70 293a 0a20 2020 2020  elf, tmp):.     
+00011cd0: 2020 2073 7263 6469 7220 3d20 746d 7020     srcdir = tmp 
+00011ce0: 2f20 2773 7263 270a 2020 2020 2020 2020  / 'src'.        
+00011cf0: 7372 6364 6972 2e6d 6b64 6972 2830 6f37  srcdir.mkdir(0o7
+00011d00: 3535 290a 2020 2020 2020 2020 6368 6172  55).        char
+00011d10: 6d5f 6669 6c65 6e61 6d65 203d 2073 7263  m_filename = src
+00011d20: 6469 7220 2f20 2774 6573 7463 6861 726d  dir / 'testcharm
+00011d30: 2e70 7927 0a20 2020 2020 2020 2077 6974  .py'.        wit
+00011d40: 6820 6368 6172 6d5f 6669 6c65 6e61 6d65  h charm_filename
+00011d50: 2e6f 7065 6e28 2777 7427 2920 6173 2063  .open('wt') as c
+00011d60: 6861 726d 7079 3a0a 2020 2020 2020 2020  harmpy:.        
+00011d70: 2020 2020 2320 6c61 6e67 7561 6765 3d50      # language=P
+00011d80: 7974 686f 6e0a 2020 2020 2020 2020 2020  ython.          
+00011d90: 2020 6368 6172 6d70 792e 7772 6974 6528    charmpy.write(
+00011da0: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
+00011db0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00011dc0: 2020 2020 6672 6f6d 206f 7073 2069 6d70      from ops imp
+00011dd0: 6f72 7420 4368 6172 6d42 6173 650a 2020  ort CharmBase.  
+00011de0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+00011df0: 6173 7320 4d79 5465 7374 696e 6743 6861  ass MyTestingCha
+00011e00: 726d 2843 6861 726d 4261 7365 293a 0a20  rm(CharmBase):. 
+00011e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e20: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00011e30: 2020 2020 2020 2020 2727 2729 290a 2020          ''')).  
+00011e40: 2020 2020 2020 6f72 6967 203d 2073 7973        orig = sys
+00011e50: 2e70 6174 685b 3a5d 0a20 2020 2020 2020  .path[:].       
+00011e60: 2073 7973 2e70 6174 682e 6170 7065 6e64   sys.path.append
+00011e70: 2873 7472 2873 7263 6469 7229 290a 0a20  (str(srcdir)).. 
+00011e80: 2020 2020 2020 2064 6566 2063 6c65 616e         def clean
+00011e90: 7570 2829 3a0a 2020 2020 2020 2020 2020  up():.          
+00011ea0: 2020 7379 732e 7061 7468 203d 206f 7269    sys.path = ori
+00011eb0: 670a 2020 2020 2020 2020 2020 2020 7379  g.            sy
+00011ec0: 732e 6d6f 6475 6c65 732e 706f 7028 2774  s.modules.pop('t
+00011ed0: 6573 7463 6861 726d 2729 0a0a 2020 2020  estcharm')..    
+00011ee0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+00011ef0: 6e75 7028 636c 6561 6e75 7029 0a0a 2020  nup(cleanup)..  
+00011f00: 2020 6465 6620 7465 7374 5f61 6374 696f    def test_actio
+00011f10: 6e73 5f70 6173 7365 645f 696e 2873 656c  ns_passed_in(sel
+00011f20: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00011f30: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00011f40: 672e 4861 726e 6573 7328 0a20 2020 2020  g.Harness(.     
+00011f50: 2020 2020 2020 206f 7073 2e43 6861 726d         ops.Charm
+00011f60: 4261 7365 2c0a 2020 2020 2020 2020 2020  Base,.          
+00011f70: 2020 6d65 7461 3d27 2727 0a20 2020 2020    meta='''.     
+00011f80: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+00011f90: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+00011fa0: 2020 2020 2020 2727 272c 0a20 2020 2020        ''',.     
+00011fb0: 2020 2020 2020 2061 6374 696f 6e73 3d27         actions='
+00011fc0: 2727 0a20 2020 2020 2020 2020 2020 2020  ''.             
+00011fd0: 2020 2074 6573 742d 6163 7469 6f6e 3a0a     test-action:.
+00011fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ff0: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
+00012000: 2061 2064 756d 6d79 2074 6573 7420 6163   a dummy test ac
+00012010: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00012020: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00012030: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00012040: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00012050: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00012060: 7274 4571 7561 6c28 6c69 7374 2868 6172  rtEqual(list(har
+00012070: 6e65 7373 2e66 7261 6d65 776f 726b 2e6d  ness.framework.m
+00012080: 6574 612e 6163 7469 6f6e 7329 2c20 5b27  eta.actions), ['
+00012090: 7465 7374 2d61 6374 696f 6e27 5d29 0a0a  test-action'])..
+000120a0: 2020 2020 6465 6620 7465 7374 5f65 7665      def test_eve
+000120b0: 6e74 5f63 6f6e 7465 7874 2873 656c 6629  nt_context(self)
+000120c0: 3a0a 2020 2020 2020 2020 636c 6173 7320  :.        class 
+000120d0: 4d79 4368 6172 6d28 6f70 732e 4368 6172  MyCharm(ops.Char
+000120e0: 6d42 6173 6529 3a0a 2020 2020 2020 2020  mBase):.        
+000120f0: 2020 2020 6465 6620 6576 656e 745f 6861      def event_ha
+00012100: 6e64 6c65 7228 7365 6c66 2c20 6576 7429  ndler(self, evt)
+00012110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012120: 2020 6576 742e 7265 6c61 7469 6f6e 2e64    evt.relation.d
+00012130: 6174 615b 6576 742e 7265 6c61 7469 6f6e  ata[evt.relation
+00012140: 2e61 7070 5d5b 2766 6f6f 275d 203d 2027  .app]['foo'] = '
+00012150: 6261 7227 0a0a 2020 2020 2020 2020 6861  bar'..        ha
+00012160: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00012170: 696e 672e 4861 726e 6573 7328 4d79 4368  ing.Harness(MyCh
+00012180: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
+00012190: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+000121a0: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+000121b0: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+000121c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000121d0: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+000121e0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+000121f0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+00012200: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00012210: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+00012220: 2829 0a20 2020 2020 2020 2072 656c 5f69  ().        rel_i
+00012230: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+00012240: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+00012250: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
+00012260: 2020 2020 2072 656c 203d 2068 6172 6e65       rel = harne
+00012270: 7373 2e63 6861 726d 2e6d 6f64 656c 2e67  ss.charm.model.g
+00012280: 6574 5f72 656c 6174 696f 6e28 2764 6227  et_relation('db'
+00012290: 2c20 7265 6c5f 6964 290a 0a20 2020 2020  , rel_id)..     
+000122a0: 2020 2065 7665 6e74 203d 204d 6167 6963     event = Magic
+000122b0: 4d6f 636b 2829 0a20 2020 2020 2020 2065  Mock().        e
+000122c0: 7665 6e74 2e72 656c 6174 696f 6e20 3d20  vent.relation = 
+000122d0: 7265 6c0a 0a20 2020 2020 2020 2077 6974  rel..        wit
+000122e0: 6820 6861 726e 6573 732e 5f65 7665 6e74  h harness._event
+000122f0: 5f63 6f6e 7465 7874 2827 6d79 5f72 656c  _context('my_rel
+00012300: 6174 696f 6e5f 6a6f 696e 6564 2729 3a0a  ation_joined'):.
+00012310: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00012320: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00012330: 6573 286f 7073 2e52 656c 6174 696f 6e44  es(ops.RelationD
+00012340: 6174 6145 7272 6f72 293a 0a20 2020 2020  ataError):.     
+00012350: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+00012360: 7373 2e63 6861 726d 2e65 7665 6e74 5f68  ss.charm.event_h
+00012370: 616e 646c 6572 2865 7665 6e74 290a 0a20  andler(event).. 
+00012380: 2020 2064 6566 2074 6573 745f 6576 656e     def test_even
+00012390: 745f 636f 6e74 6578 745f 696e 7665 7273  t_context_invers
+000123a0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+000123b0: 2063 6c61 7373 204d 7943 6861 726d 286f   class MyCharm(o
+000123c0: 7073 2e43 6861 726d 4261 7365 293a 0a20  ps.CharmBase):. 
+000123d0: 2020 2020 2020 2020 2020 2064 6566 205f             def _
+000123e0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6672  _init__(self, fr
+000123f0: 616d 6577 6f72 6b3a 206f 7073 2e46 7261  amework: ops.Fra
+00012400: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
+00012410: 2020 2020 2020 2020 2073 7570 6572 2829           super()
+00012420: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
+00012430: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
+00012440: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
+00012450: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
+00012460: 2e6f 6e2e 6462 5f72 656c 6174 696f 6e5f  .on.db_relation_
+00012470: 6a6f 696e 6564 2c0a 2020 2020 2020 2020  joined,.        
+00012480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012490: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000124a0: 656c 662e 5f6a 6f69 6e5f 6462 290a 0a20  elf._join_db).. 
+000124b0: 2020 2020 2020 2020 2020 2064 6566 205f             def _
+000124c0: 6a6f 696e 5f64 6228 7365 6c66 2c20 6576  join_db(self, ev
+000124d0: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+000124e0: 2020 2020 2020 2320 646f 2074 6869 6e67        # do thing
+000124f0: 7320 7769 7468 2041 5049 7320 7765 2063  s with APIs we c
+00012500: 616e 6e6f 7420 6561 7369 6c79 206d 6f63  annot easily moc
+00012510: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+00012520: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+00012530: 6d65 6e74 6564 4572 726f 720a 0a20 2020  mentedError..   
+00012540: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+00012550: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+00012560: 7373 284d 7943 6861 726d 2c20 6d65 7461  ss(MyCharm, meta
+00012570: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+00012580: 206e 616d 653a 2074 6573 742d 6368 6172   name: test-char
+00012590: 6d0a 2020 2020 2020 2020 2020 2020 7265  m.            re
+000125a0: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+000125b0: 2020 2020 2020 2020 6462 3a0a 2020 2020          db:.    
+000125c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125d0: 696e 7465 7266 6163 653a 2070 6773 716c  interface: pgsql
+000125e0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+000125f0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00012600: 732e 6265 6769 6e28 290a 0a20 2020 2020  s.begin()..     
+00012610: 2020 2064 6566 206d 6f63 6b5f 6a6f 696e     def mock_join
+00012620: 5f64 6228 6576 656e 7429 3a0a 2020 2020  _db(event):.    
+00012630: 2020 2020 2020 2020 2320 7468 6520 6861          # the ha
+00012640: 726e 6573 7320 7468 696e 6b73 2077 6527  rness thinks we'
+00012650: 7265 2069 6e73 6964 6520 6120 6462 5f72  re inside a db_r
+00012660: 656c 6174 696f 6e5f 6a6f 696e 6564 2068  elation_joined h
+00012670: 6f6f 6b0a 2020 2020 2020 2020 2020 2020  ook.            
+00012680: 2320 6275 7420 7765 2077 616e 7420 746f  # but we want to
+00012690: 206d 6f63 6b20 7468 6520 7265 6d6f 7465   mock the remote
+000126a0: 2064 6174 6120 6865 7265 3a0a 2020 2020   data here:.    
+000126b0: 2020 2020 2020 2020 7769 7468 2068 6172          with har
+000126c0: 6e65 7373 2e5f 6576 656e 745f 636f 6e74  ness._event_cont
+000126d0: 6578 7428 2727 293a 0a20 2020 2020 2020  ext(''):.       
+000126e0: 2020 2020 2020 2020 2023 2070 7265 7465           # prete
+000126f0: 6e64 2066 6f72 2061 206d 6f6d 656e 7420  nd for a moment 
+00012700: 7765 2772 6520 6e6f 7420 696e 2061 2068  we're not in a h
+00012710: 6f6f 6b20 636f 6e74 6578 742c 0a20 2020  ook context,.   
+00012720: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+00012730: 6f20 7468 6520 6861 726e 6573 7320 7769  o the harness wi
+00012740: 6c6c 206c 6574 2075 733a 0a20 2020 2020  ll let us:.     
+00012750: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00012760: 2865 7665 6e74 2e72 656c 6174 696f 6e2e  (event.relation.
+00012770: 6170 7029 0a20 2020 2020 2020 2020 2020  app).           
+00012780: 2020 2020 2065 7665 6e74 2e72 656c 6174       event.relat
+00012790: 696f 6e2e 6461 7461 5b68 6172 6e65 7373  ion.data[harness
+000127a0: 2e63 6861 726d 2e61 7070 5d5b 2766 6f6f  .charm.app]['foo
+000127b0: 275d 203d 2027 6261 7227 0a0a 2020 2020  '] = 'bar'..    
+000127c0: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
+000127d0: 6d2e 5f6a 6f69 6e5f 6462 203d 206d 6f63  m._join_db = moc
+000127e0: 6b5f 6a6f 696e 5f64 620a 2020 2020 2020  k_join_db.      
+000127f0: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
+00012800: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+00012810: 2764 6227 2c20 2772 656d 6f74 6527 290a  'db', 'remote').
+00012820: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00012830: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00012840: 7428 7265 6c5f 6964 2c20 2772 656d 6f74  t(rel_id, 'remot
+00012850: 652f 3027 290a 2020 2020 2020 2020 7265  e/0').        re
+00012860: 6c20 3d20 6861 726e 6573 732e 6368 6172  l = harness.char
+00012870: 6d2e 6d6f 6465 6c2e 6765 745f 7265 6c61  m.model.get_rela
+00012880: 7469 6f6e 2827 6462 272c 2072 656c 5f69  tion('db', rel_i
+00012890: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+000128a0: 6173 7365 7274 4571 7561 6c28 7b27 666f  assertEqual({'fo
+000128b0: 6f27 3a20 2762 6172 277d 2c0a 2020 2020  o': 'bar'},.    
+000128c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128d0: 2020 2020 2068 6172 6e65 7373 2e67 6574       harness.get
+000128e0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+000128f0: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
+00012900: 726d 2729 290a 0a20 2020 2020 2020 2023  rm'))..        #
+00012910: 206e 6f77 2077 6527 7265 206f 7574 7369   now we're outsi
+00012920: 6465 206f 6620 7468 6520 686f 6f6b 2063  de of the hook c
+00012930: 6f6e 7465 7874 3a0a 2020 2020 2020 2020  ontext:.        
+00012940: 6173 7365 7274 206e 6f74 2068 6172 6e65  assert not harne
+00012950: 7373 2e5f 6261 636b 656e 642e 5f68 6f6f  ss._backend._hoo
+00012960: 6b5f 6973 5f72 756e 6e69 6e67 0a20 2020  k_is_running.   
+00012970: 2020 2020 2061 7373 6572 7420 7265 6c2e       assert rel.
+00012980: 6461 7461 5b68 6172 6e65 7373 2e63 6861  data[harness.cha
+00012990: 726d 2e61 7070 5d5b 2766 6f6f 275d 203d  rm.app]['foo'] =
+000129a0: 3d20 2762 6172 270a 0a20 2020 2064 6566  = 'bar'..    def
+000129b0: 2074 6573 745f 7265 6c61 7469 6f6e 5f73   test_relation_s
+000129c0: 6574 5f64 656c 6574 6573 2873 656c 6629  et_deletes(self)
+000129d0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+000129e0: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+000129f0: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+00012a00: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+00012a10: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00012a20: 3a20 7465 7374 2d63 6861 726d 0a20 2020  : test-charm.   
+00012a30: 2020 2020 2020 2020 2072 6571 7569 7265           require
+00012a40: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00012a50: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+00012a60: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00012a70: 6661 6365 3a20 7067 7371 6c0a 2020 2020  face: pgsql.    
+00012a80: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+00012a90: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+00012aa0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+00012ab0: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
+00012ac0: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
+00012ad0: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
+00012ae0: 745f 6c65 6164 6572 2846 616c 7365 290a  t_leader(False).
+00012af0: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
+00012b00: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+00012b10: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
+00012b20: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
+00012b30: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00012b40: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00012b50: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
+00012b60: 726d 2f30 272c 207b 2766 6f6f 273a 2027  rm/0', {'foo': '
+00012b70: 6261 7227 7d29 0a20 2020 2020 2020 2068  bar'}).        h
+00012b80: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00012b90: 696f 6e5f 756e 6974 2872 656c 5f69 642c  ion_unit(rel_id,
+00012ba0: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
+00012bb0: 0a20 2020 2020 2020 2072 656c 203d 2068  .        rel = h
+00012bc0: 6172 6e65 7373 2e63 6861 726d 2e6d 6f64  arness.charm.mod
+00012bd0: 656c 2e67 6574 5f72 656c 6174 696f 6e28  el.get_relation(
+00012be0: 2764 6227 2c20 7265 6c5f 6964 290a 2020  'db', rel_id).  
+00012bf0: 2020 2020 2020 6465 6c20 7265 6c2e 6461        del rel.da
+00012c00: 7461 5b68 6172 6e65 7373 2e63 6861 726d  ta[harness.charm
+00012c10: 2e6d 6f64 656c 2e75 6e69 745d 5b27 666f  .model.unit]['fo
+00012c20: 6f27 5d0a 2020 2020 2020 2020 7365 6c66  o'].        self
+00012c30: 2e61 7373 6572 7445 7175 616c 287b 7d2c  .assertEqual({},
+00012c40: 2068 6172 6e65 7373 2e67 6574 5f72 656c   harness.get_rel
+00012c50: 6174 696f 6e5f 6461 7461 2872 656c 5f69  ation_data(rel_i
+00012c60: 642c 2027 7465 7374 2d63 6861 726d 2f30  d, 'test-charm/0
+00012c70: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
+00012c80: 745f 7265 6c61 7469 6f6e 5f73 6574 5f6e  t_relation_set_n
+00012c90: 6f6e 7374 7269 6e67 2873 656c 6629 3a0a  onstring(self):.
+00012ca0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+00012cb0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+00012cc0: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+00012cd0: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
+00012ce0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+00012cf0: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+00012d00: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+00012d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012d20: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+00012d30: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+00012d40: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+00012d50: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00012d60: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00012d70: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00012d80: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+00012d90: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+00012da0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
+00012db0: 6c65 6164 6572 2846 616c 7365 290a 2020  leader(False).  
+00012dc0: 2020 2020 2020 7265 6c5f 6964 203d 2068        rel_id = h
+00012dd0: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00012de0: 696f 6e28 2764 6227 2c20 2770 6f73 7467  ion('db', 'postg
+00012df0: 7265 7371 6c27 290a 2020 2020 2020 2020  resql').        
+00012e00: 666f 7220 696e 7661 6c69 645f 7661 6c75  for invalid_valu
+00012e10: 6520 696e 2028 312c 2031 2e32 2c20 7b7d  e in (1, 1.2, {}
+00012e20: 2c20 5b5d 2c20 7365 7428 292c 2054 7275  , [], set(), Tru
+00012e30: 652c 206f 626a 6563 7428 292c 2074 7970  e, object(), typ
+00012e40: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00012e50: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00012e60: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+00012e70: 696f 6e44 6174 6145 7272 6f72 293a 0a20  ionDataError):. 
+00012e80: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00012e90: 6172 6e65 7373 2e75 7064 6174 655f 7265  arness.update_re
+00012ea0: 6c61 7469 6f6e 5f64 6174 6128 7265 6c5f  lation_data(rel_
+00012eb0: 6964 2c20 2774 6573 742d 6368 6172 6d2f  id, 'test-charm/
+00012ec0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00012ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ef0: 207b 2766 6f6f 273a 2069 6e76 616c 6964   {'foo': invalid
+00012f00: 5f76 616c 7565 7d29 0a0a 2020 2020 6465  _value})..    de
+00012f10: 6620 7465 7374 5f73 6574 5f77 6f72 6b6c  f test_set_workl
+00012f20: 6f61 645f 7665 7273 696f 6e28 7365 6c66  oad_version(self
+00012f30: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+00012f40: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+00012f50: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+00012f60: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+00012f70: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00012f80: 653a 2061 7070 0a20 2020 2020 2020 2020  e: app.         
+00012f90: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00012fa0: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+00012fb0: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+00012fc0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00012fd0: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
+00012fe0: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+00012ff0: 6e65 2868 6172 6e65 7373 2e67 6574 5f77  ne(harness.get_w
+00013000: 6f72 6b6c 6f61 645f 7665 7273 696f 6e28  orkload_version(
+00013010: 2929 0a20 2020 2020 2020 2068 6172 6e65  )).        harne
+00013020: 7373 2e63 6861 726d 2e6d 6f64 656c 2e75  ss.charm.model.u
+00013030: 6e69 742e 7365 745f 776f 726b 6c6f 6164  nit.set_workload
+00013040: 5f76 6572 7369 6f6e 2827 312e 322e 3327  _version('1.2.3'
+00013050: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00013060: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
+00013070: 7373 2e67 6574 5f77 6f72 6b6c 6f61 645f  ss.get_workload_
+00013080: 7665 7273 696f 6e28 292c 2027 312e 322e  version(), '1.2.
+00013090: 3327 290a 0a20 2020 2064 6566 2074 6573  3')..    def tes
+000130a0: 745f 6765 745f 6261 636b 656e 645f 6361  t_get_backend_ca
+000130b0: 6c6c 7328 7365 6c66 293a 0a20 2020 2020  lls(self):.     
+000130c0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+000130d0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+000130e0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+000130f0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+00013100: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+00013110: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+00013120: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+00013130: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013150: 2020 2020 696e 7465 7266 6163 653a 2070      interface: p
+00013160: 6773 716c 0a20 2020 2020 2020 2020 2020  gsql.           
+00013170: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00013180: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00013190: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+000131a0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+000131b0: 6567 696e 2829 0a20 2020 2020 2020 2023  egin().        #
+000131c0: 204e 6f20 6361 6c6c 7320 746f 2074 6865   No calls to the
+000131d0: 2062 6163 6b65 6e64 2079 6574 0a20 2020   backend yet.   
+000131e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000131f0: 4571 7561 6c28 6861 726e 6573 732e 5f67  Equal(harness._g
+00013200: 6574 5f62 6163 6b65 6e64 5f63 616c 6c73  et_backend_calls
+00013210: 2829 2c20 5b5d 290a 2020 2020 2020 2020  (), []).        
+00013220: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
+00013230: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+00013240: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+00013250: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00013260: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+00013270: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+00013280: 2020 2020 2020 2020 2020 2028 2772 656c             ('rel
+00013290: 6174 696f 6e5f 6964 7327 2c20 2764 6227  ation_ids', 'db'
+000132a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000132b0: 2020 2028 2772 656c 6174 696f 6e5f 6c69     ('relation_li
+000132c0: 7374 272c 2072 656c 5f69 6429 2c0a 2020  st', rel_id),.  
+000132d0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+000132e0: 7265 6c61 7469 6f6e 5f72 656d 6f74 655f  relation_remote_
+000132f0: 6170 705f 6e61 6d65 272c 2030 292c 0a20  app_name', 0),. 
+00013300: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00013310: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
+00013320: 732e 5f67 6574 5f62 6163 6b65 6e64 5f63  s._get_backend_c
+00013330: 616c 6c73 2829 290a 0a20 2020 2020 2020  alls())..       
+00013340: 2023 2075 7064 6174 655f 7265 6c61 7469   # update_relati
+00013350: 6f6e 5f64 6174 6120 656e 7375 7265 7320  on_data ensures 
+00013360: 7468 6520 6361 6368 6564 2064 6174 6120  the cached data 
+00013370: 666f 7220 7468 6520 7265 6c61 7469 6f6e  for the relation
+00013380: 2069 7320 7769 7065 640a 2020 2020 2020   is wiped.      
+00013390: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+000133a0: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+000133b0: 656c 5f69 642c 2027 7465 7374 2d63 6861  el_id, 'test-cha
+000133c0: 726d 2f30 272c 207b 2766 6f6f 273a 2027  rm/0', {'foo': '
+000133d0: 6261 7227 7d29 0a20 2020 2020 2020 2074  bar'}).        t
+000133e0: 6573 745f 6368 6172 6d5f 756e 6974 203d  est_charm_unit =
+000133f0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e67   harness.model.g
+00013400: 6574 5f75 6e69 7428 2774 6573 742d 6368  et_unit('test-ch
+00013410: 6172 6d2f 3027 290a 2020 2020 2020 2020  arm/0').        
+00013420: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013430: 280a 2020 2020 2020 2020 2020 2020 5b0a  (.            [.
+00013440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013450: 2827 7265 6c61 7469 6f6e 5f67 6574 272c  ('relation_get',
+00013460: 2030 2c20 2774 6573 742d 6368 6172 6d2f   0, 'test-charm/
+00013470: 3027 2c20 4661 6c73 6529 2c0a 2020 2020  0', False),.    
+00013480: 2020 2020 2020 2020 2020 2020 2827 7570              ('up
+00013490: 6461 7465 5f72 656c 6174 696f 6e5f 6461  date_relation_da
+000134a0: 7461 272c 2030 2c20 7465 7374 5f63 6861  ta', 0, test_cha
+000134b0: 726d 5f75 6e69 742c 2027 666f 6f27 2c20  rm_unit, 'foo', 
+000134c0: 2762 6172 2729 0a20 2020 2020 2020 2020  'bar').         
+000134d0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+000134e0: 2020 6861 726e 6573 732e 5f67 6574 5f62    harness._get_b
+000134f0: 6163 6b65 6e64 5f63 616c 6c73 2872 6573  ackend_calls(res
+00013500: 6574 3d54 7275 6529 290a 2020 2020 2020  et=True)).      
+00013510: 2020 2320 6164 645f 7265 6c61 7469 6f6e    # add_relation
+00013520: 5f75 6e69 7420 7265 7365 7473 2074 6865  _unit resets the
+00013530: 2072 656c 6174 696f 6e5f 6c69 7374 2c20   relation_list, 
+00013540: 6275 7420 646f 6573 6e27 7420 7472 6967  but doesn't trig
+00013550: 6765 7220 6261 636b 656e 6420 6361 6c6c  ger backend call
+00013560: 730a 2020 2020 2020 2020 6861 726e 6573  s.        harnes
+00013570: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+00013580: 6e69 7428 7265 6c5f 6964 2c20 2770 6f73  nit(rel_id, 'pos
+00013590: 7467 7265 7371 6c2f 3027 290a 2020 2020  tgresql/0').    
+000135a0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000135b0: 7175 616c 285b 5d2c 2068 6172 6e65 7373  qual([], harness
+000135c0: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
+000135d0: 6c6c 7328 7265 7365 743d 4661 6c73 6529  lls(reset=False)
+000135e0: 290a 2020 2020 2020 2020 2320 686f 7765  ).        # howe
+000135f0: 7665 722c 2075 7064 6174 655f 7265 6c61  ver, update_rela
+00013600: 7469 6f6e 5f64 6174 6120 646f 6573 2c20  tion_data does, 
+00013610: 6265 6361 7573 6520 7765 2061 7265 2070  because we are p
+00013620: 7265 7061 7269 6e67 2072 656c 6174 696f  reparing relatio
+00013630: 6e2d 6368 616e 6765 640a 2020 2020 2020  n-changed.      
+00013640: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00013650: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00013660: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00013670: 716c 2f30 272c 207b 2766 6f6f 273a 2027  ql/0', {'foo': '
+00013680: 6261 7227 7d29 0a20 2020 2020 2020 2070  bar'}).        p
+00013690: 6771 6c5f 756e 6974 203d 2068 6172 6e65  gql_unit = harne
+000136a0: 7373 2e6d 6f64 656c 2e67 6574 5f75 6e69  ss.model.get_uni
+000136b0: 7428 2770 6f73 7467 7265 7371 6c2f 3027  t('postgresql/0'
+000136c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000136d0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+000136e0: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
+000136f0: 2e5f 6765 745f 6261 636b 656e 645f 6361  ._get_backend_ca
+00013700: 6c6c 7328 7265 7365 743d 4661 6c73 6529  lls(reset=False)
+00013710: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+00013720: 2020 2020 2827 7265 6c61 7469 6f6e 5f69      ('relation_i
+00013730: 6473 272c 2027 6462 2729 2c0a 2020 2020  ds', 'db'),.    
+00013740: 2020 2020 2020 2020 2020 2020 2827 7265              ('re
+00013750: 6c61 7469 6f6e 5f6c 6973 7427 2c20 7265  lation_list', re
+00013760: 6c5f 6964 292c 0a20 2020 2020 2020 2020  l_id),.         
+00013770: 2020 2020 2020 2028 2772 656c 6174 696f         ('relatio
+00013780: 6e5f 6765 7427 2c20 302c 2027 706f 7374  n_get', 0, 'post
+00013790: 6772 6573 716c 2f30 272c 2046 616c 7365  gresql/0', False
+000137a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000137b0: 2020 2028 2775 7064 6174 655f 7265 6c61     ('update_rela
+000137c0: 7469 6f6e 5f64 6174 6127 2c20 302c 2070  tion_data', 0, p
+000137d0: 6771 6c5f 756e 6974 2c20 2766 6f6f 272c  gql_unit, 'foo',
+000137e0: 2027 6261 7227 290a 2020 2020 2020 2020   'bar').        
+000137f0: 2020 2020 5d29 0a20 2020 2020 2020 2023      ]).        #
+00013800: 2049 6620 7765 2063 6865 636b 2061 6761   If we check aga
+00013810: 696e 2c20 7468 6579 2061 7265 2073 7469  in, they are sti
+00013820: 6c6c 2074 6865 7265 2c20 6275 7420 6e6f  ll there, but no
+00013830: 7720 7765 2072 6573 6574 2069 740a 2020  w we reset it.  
+00013840: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00013850: 7445 7175 616c 280a 2020 2020 2020 2020  tEqual(.        
+00013860: 2020 2020 6861 726e 6573 732e 5f67 6574      harness._get
+00013870: 5f62 6163 6b65 6e64 5f63 616c 6c73 2872  _backend_calls(r
+00013880: 6573 6574 3d54 7275 6529 2c20 5b0a 2020  eset=True), [.  
+00013890: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+000138a0: 7265 6c61 7469 6f6e 5f69 6473 272c 2027  relation_ids', '
+000138b0: 6462 2729 2c0a 2020 2020 2020 2020 2020  db'),.          
+000138c0: 2020 2020 2020 2827 7265 6c61 7469 6f6e        ('relation
+000138d0: 5f6c 6973 7427 2c20 7265 6c5f 6964 292c  _list', rel_id),
+000138e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000138f0: 2028 2772 656c 6174 696f 6e5f 6765 7427   ('relation_get'
+00013900: 2c20 302c 2027 706f 7374 6772 6573 716c  , 0, 'postgresql
+00013910: 2f30 272c 2046 616c 7365 292c 0a20 2020  /0', False),.   
+00013920: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
+00013930: 7064 6174 655f 7265 6c61 7469 6f6e 5f64  pdate_relation_d
+00013940: 6174 6127 2c20 302c 2070 6771 6c5f 756e  ata', 0, pgql_un
+00013950: 6974 2c20 2766 6f6f 272c 2027 6261 7227  it, 'foo', 'bar'
+00013960: 290a 2020 2020 2020 2020 2020 2020 5d29  ).            ])
+00013970: 0a20 2020 2020 2020 2023 2041 6e64 2074  .        # And t
+00013980: 6865 2063 616c 6c73 2061 7265 2067 6f6e  he calls are gon
+00013990: 650a 2020 2020 2020 2020 7365 6c66 2e61  e.        self.a
+000139a0: 7373 6572 7445 7175 616c 2868 6172 6e65  ssertEqual(harne
+000139b0: 7373 2e5f 6765 745f 6261 636b 656e 645f  ss._get_backend_
+000139c0: 6361 6c6c 7328 292c 205b 5d29 0a0a 2020  calls(), [])..  
+000139d0: 2020 6465 6620 7465 7374 5f67 6574 5f62    def test_get_b
+000139e0: 6163 6b65 6e64 5f63 616c 6c73 5f77 6974  ackend_calls_wit
+000139f0: 685f 6b77 6172 6773 2873 656c 6629 3a0a  h_kwargs(self):.
+00013a00: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+00013a10: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+00013a20: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+00013a30: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
+00013a40: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+00013a50: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+00013a60: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+00013a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013a80: 2064 623a 0a20 2020 2020 2020 2020 2020   db:.           
+00013a90: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+00013aa0: 6365 3a20 7067 7371 6c0a 2020 2020 2020  ce: pgsql.      
+00013ab0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00013ac0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+00013ad0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+00013ae0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+00013af0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
+00013b00: 2020 2020 756e 6974 203d 2068 6172 6e65      unit = harne
+00013b10: 7373 2e63 6861 726d 2e6d 6f64 656c 2e75  ss.charm.model.u
+00013b20: 6e69 740a 2020 2020 2020 2020 2320 5265  nit.        # Re
+00013b30: 7365 7420 7468 6520 6c69 7374 2c20 6265  set the list, be
+00013b40: 6361 7573 6520 7765 2064 6f6e 2774 2063  cause we don't c
+00013b50: 6172 6520 7768 6174 2069 7420 746f 6f6b  are what it took
+00013b60: 2074 6f20 6765 7420 6865 7265 0a20 2020   to get here.   
+00013b70: 2020 2020 2068 6172 6e65 7373 2e5f 6765       harness._ge
+00013b80: 745f 6261 636b 656e 645f 6361 6c6c 7328  t_backend_calls(
+00013b90: 7265 7365 743d 5472 7565 290a 2020 2020  reset=True).    
+00013ba0: 2020 2020 756e 6974 2e73 7461 7475 7320      unit.status 
+00013bb0: 3d20 6f70 732e 4163 7469 7665 5374 6174  = ops.ActiveStat
+00013bc0: 7573 2829 0a20 2020 2020 2020 2073 656c  us().        sel
+00013bd0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00013be0: 2020 2020 2020 2020 2020 205b 2827 7374             [('st
+00013bf0: 6174 7573 5f73 6574 272c 2027 6163 7469  atus_set', 'acti
+00013c00: 7665 272c 2027 272c 207b 2769 735f 6170  ve', '', {'is_ap
+00013c10: 7027 3a20 4661 6c73 657d 295d 2c20 6861  p': False})], ha
+00013c20: 726e 6573 732e 5f67 6574 5f62 6163 6b65  rness._get_backe
+00013c30: 6e64 5f63 616c 6c73 2829 290a 2020 2020  nd_calls()).    
+00013c40: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
+00013c50: 6c65 6164 6572 2854 7275 6529 0a20 2020  leader(True).   
+00013c60: 2020 2020 2061 7070 203d 2068 6172 6e65       app = harne
+00013c70: 7373 2e63 6861 726d 2e6d 6f64 656c 2e61  ss.charm.model.a
+00013c80: 7070 0a20 2020 2020 2020 2068 6172 6e65  pp.        harne
+00013c90: 7373 2e5f 6765 745f 6261 636b 656e 645f  ss._get_backend_
+00013ca0: 6361 6c6c 7328 7265 7365 743d 5472 7565  calls(reset=True
+00013cb0: 290a 2020 2020 2020 2020 6170 702e 7374  ).        app.st
+00013cc0: 6174 7573 203d 206f 7073 2e41 6374 6976  atus = ops.Activ
+00013cd0: 6553 7461 7475 7328 276d 6573 7361 6765  eStatus('message
+00013ce0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00013cf0: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+00013d00: 2020 2020 2020 2020 205b 2827 6973 5f6c           [('is_l
+00013d10: 6561 6465 7227 2c29 2c0a 2020 2020 2020  eader',),.      
+00013d20: 2020 2020 2020 2028 2773 7461 7475 735f         ('status_
+00013d30: 7365 7427 2c20 2761 6374 6976 6527 2c20  set', 'active', 
+00013d40: 276d 6573 7361 6765 272c 207b 2769 735f  'message', {'is_
+00013d50: 6170 7027 3a20 5472 7565 7d29 5d2c 0a20  app': True})],. 
+00013d60: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+00013d70: 7373 2e5f 6765 745f 6261 636b 656e 645f  ss._get_backend_
+00013d80: 6361 6c6c 7328 2929 0a0a 2020 2020 6465  calls())..    de
+00013d90: 6620 7465 7374 5f75 6e69 745f 7374 6174  f test_unit_stat
+00013da0: 7573 2873 656c 6629 3a0a 2020 2020 2020  us(self):.      
+00013db0: 2020 6861 726e 6573 7320 3d20 6f70 732e    harness = ops.
+00013dc0: 7465 7374 696e 672e 4861 726e 6573 7328  testing.Harness(
+00013dd0: 6f70 732e 4368 6172 6d42 6173 652c 206d  ops.CharmBase, m
+00013de0: 6574 613d 276e 616d 653a 2074 6573 742d  eta='name: test-
+00013df0: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
+00013e00: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00013e10: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00013e20: 2020 2020 2020 2068 6172 6e65 7373 2e73         harness.s
+00013e30: 6574 5f6c 6561 6465 7228 5472 7565 290a  et_leader(True).
+00013e40: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00013e50: 6265 6769 6e28 290a 2020 2020 2020 2020  begin().        
+00013e60: 2320 6465 6661 756c 7420 7374 6174 7573  # default status
+00013e70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00013e80: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
+00013e90: 732e 6d6f 6465 6c2e 756e 6974 2e73 7461  s.model.unit.sta
+00013ea0: 7475 732c 206f 7073 2e4d 6169 6e74 656e  tus, ops.Mainten
+00013eb0: 616e 6365 5374 6174 7573 2827 2729 290a  anceStatus('')).
+00013ec0: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+00013ed0: 206f 7073 2e41 6374 6976 6553 7461 7475   ops.ActiveStatu
+00013ee0: 7328 276d 6573 7361 6765 2729 0a20 2020  s('message').   
+00013ef0: 2020 2020 2068 6172 6e65 7373 2e6d 6f64       harness.mod
+00013f00: 656c 2e75 6e69 742e 7374 6174 7573 203d  el.unit.status =
+00013f10: 2073 7461 7475 730a 2020 2020 2020 2020   status.        
+00013f20: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013f30: 2868 6172 6e65 7373 2e6d 6f64 656c 2e75  (harness.model.u
+00013f40: 6e69 742e 7374 6174 7573 2c20 7374 6174  nit.status, stat
+00013f50: 7573 290a 0a20 2020 2064 6566 2074 6573  us)..    def tes
+00013f60: 745f 6170 705f 7374 6174 7573 2873 656c  t_app_status(sel
+00013f70: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+00013f80: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+00013f90: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+00013fa0: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
+00013fb0: 616d 653a 2074 6573 742d 6170 7027 290a  ame: test-app').
+00013fc0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00013fd0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00013fe0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00013ff0: 2068 6172 6e65 7373 2e73 6574 5f6c 6561   harness.set_lea
+00014000: 6465 7228 5472 7565 290a 2020 2020 2020  der(True).      
+00014010: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+00014020: 290a 2020 2020 2020 2020 2320 6465 6661  ).        # defa
+00014030: 756c 7420 7374 6174 7573 0a20 2020 2020  ult status.     
+00014040: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00014050: 7561 6c28 6861 726e 6573 732e 6d6f 6465  ual(harness.mode
+00014060: 6c2e 6170 702e 7374 6174 7573 2c20 6f70  l.app.status, op
+00014070: 732e 556e 6b6e 6f77 6e53 7461 7475 7328  s.UnknownStatus(
+00014080: 2929 0a20 2020 2020 2020 2073 7461 7475  )).        statu
+00014090: 7320 3d20 6f70 732e 4163 7469 7665 5374  s = ops.ActiveSt
+000140a0: 6174 7573 2827 6d65 7373 6167 6527 290a  atus('message').
+000140b0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+000140c0: 6d6f 6465 6c2e 6170 702e 7374 6174 7573  model.app.status
+000140d0: 203d 2073 7461 7475 730a 2020 2020 2020   = status.      
+000140e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000140f0: 616c 2868 6172 6e65 7373 2e6d 6f64 656c  al(harness.model
+00014100: 2e61 7070 2e73 7461 7475 732c 2073 7461  .app.status, sta
+00014110: 7475 7329 0a0a 2020 2020 6465 6620 7465  tus)..    def te
+00014120: 7374 5f70 6f70 756c 6174 655f 6f63 695f  st_populate_oci_
+00014130: 7265 736f 7572 6365 7328 7365 6c66 293a  resources(self):
+00014140: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00014150: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+00014160: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+00014170: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
+00014180: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+00014190: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+000141a0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
+000141b0: 0a20 2020 2020 2020 2020 2020 2020 2069  .              i
+000141c0: 6d61 6765 3a0a 2020 2020 2020 2020 2020  mage:.          
+000141d0: 2020 2020 2020 7479 7065 3a20 6f63 692d        type: oci-
+000141e0: 696d 6167 650a 2020 2020 2020 2020 2020  image.          
+000141f0: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
+00014200: 6e3a 2022 496d 6167 6520 746f 2064 6570  n: "Image to dep
+00014210: 6c6f 792e 220a 2020 2020 2020 2020 2020  loy.".          
+00014220: 2020 2020 696d 6167 6532 3a0a 2020 2020      image2:.    
+00014230: 2020 2020 2020 2020 2020 2020 7479 7065              type
+00014240: 3a20 6f63 692d 696d 6167 650a 2020 2020  : oci-image.    
+00014250: 2020 2020 2020 2020 2020 2020 6465 7363              desc
+00014260: 7269 7074 696f 6e3a 2022 416e 6f74 6865  ription: "Anothe
+00014270: 7220 696d 6167 652e 220a 2020 2020 2020  r image.".      
+00014280: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00014290: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+000142a0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+000142b0: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
+000142c0: 6573 732e 706f 7075 6c61 7465 5f6f 6369  ess.populate_oci
+000142d0: 5f72 6573 6f75 7263 6573 2829 0a20 2020  _resources().   
+000142e0: 2020 2020 2070 6174 6820 3d20 6861 726e       path = harn
+000142f0: 6573 732e 6d6f 6465 6c2e 7265 736f 7572  ess.model.resour
+00014300: 6365 732e 6665 7463 6828 2769 6d61 6765  ces.fetch('image
+00014310: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00014320: 6173 7365 7274 4571 7561 6c28 7061 7468  assertEqual(path
+00014330: 2e6e 616d 652c 2027 636f 6e74 656e 7473  .name, 'contents
+00014340: 2e79 616d 6c27 290a 2020 2020 2020 2020  .yaml').        
+00014350: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00014360: 2870 6174 682e 7061 7265 6e74 2e6e 616d  (path.parent.nam
+00014370: 652c 2027 696d 6167 6527 290a 2020 2020  e, 'image').    
+00014380: 2020 2020 7769 7468 2070 6174 682e 6f70      with path.op
+00014390: 656e 2827 7227 2920 6173 2072 6573 6f75  en('r') as resou
+000143a0: 7263 655f 6669 6c65 3a0a 2020 2020 2020  rce_file:.      
+000143b0: 2020 2020 2020 636f 6e74 656e 7473 203d        contents =
+000143c0: 2079 616d 6c2e 7361 6665 5f6c 6f61 6428   yaml.safe_load(
+000143d0: 7265 736f 7572 6365 5f66 696c 652e 7265  resource_file.re
+000143e0: 6164 2829 290a 2020 2020 2020 2020 7365  ad()).        se
+000143f0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00014400: 6f6e 7465 6e74 735b 2772 6567 6973 7472  ontents['registr
+00014410: 7970 6174 6827 5d2c 2027 7265 6769 7374  ypath'], 'regist
+00014420: 7279 7061 7468 2729 0a20 2020 2020 2020  rypath').       
+00014430: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00014440: 6c28 636f 6e74 656e 7473 5b27 7573 6572  l(contents['user
+00014450: 6e61 6d65 275d 2c20 2775 7365 726e 616d  name'], 'usernam
+00014460: 6527 290a 2020 2020 2020 2020 7365 6c66  e').        self
+00014470: 2e61 7373 6572 7445 7175 616c 2863 6f6e  .assertEqual(con
+00014480: 7465 6e74 735b 2770 6173 7377 6f72 6427  tents['password'
+00014490: 5d2c 2027 7061 7373 776f 7264 2729 0a20  ], 'password'). 
+000144a0: 2020 2020 2020 2070 6174 6820 3d20 6861         path = ha
+000144b0: 726e 6573 732e 6d6f 6465 6c2e 7265 736f  rness.model.reso
+000144c0: 7572 6365 732e 6665 7463 6828 2769 6d61  urces.fetch('ima
+000144d0: 6765 3227 290a 2020 2020 2020 2020 7365  ge2').        se
+000144e0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+000144f0: 6174 682e 6e61 6d65 2c20 2763 6f6e 7465  ath.name, 'conte
+00014500: 6e74 732e 7961 6d6c 2729 0a20 2020 2020  nts.yaml').     
+00014510: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00014520: 7561 6c28 7061 7468 2e70 6172 656e 742e  ual(path.parent.
+00014530: 6e61 6d65 2c20 2769 6d61 6765 3227 290a  name, 'image2').
+00014540: 0a20 2020 2064 6566 2074 6573 745f 7265  .    def test_re
+00014550: 736f 7572 6365 5f66 6f6c 6465 725f 636c  source_folder_cl
+00014560: 6561 6e75 7028 7365 6c66 293a 0a20 2020  eanup(self):.   
+00014570: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+00014580: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+00014590: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+000145a0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+000145b0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+000145c0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+000145d0: 2020 7265 736f 7572 6365 733a 0a20 2020    resources:.   
+000145e0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+000145f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014600: 2020 7479 7065 3a20 6f63 692d 696d 6167    type: oci-imag
+00014610: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00014620: 2020 6465 7363 7269 7074 696f 6e3a 2022    description: "
+00014630: 496d 6167 6520 746f 2064 6570 6c6f 792e  Image to deploy.
+00014640: 220a 2020 2020 2020 2020 2020 2020 2727  ".            ''
+00014650: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00014660: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00014670: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+00014680: 2020 2020 6861 726e 6573 732e 706f 7075      harness.popu
+00014690: 6c61 7465 5f6f 6369 5f72 6573 6f75 7263  late_oci_resourc
+000146a0: 6573 2829 0a20 2020 2020 2020 2070 6174  es().        pat
+000146b0: 6820 3d20 6861 726e 6573 732e 6d6f 6465  h = harness.mode
+000146c0: 6c2e 7265 736f 7572 6365 732e 6665 7463  l.resources.fetc
+000146d0: 6828 2769 6d61 6765 2729 0a20 2020 2020  h('image').     
+000146e0: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
+000146f0: 7565 2870 6174 682e 6578 6973 7473 2829  ue(path.exists()
+00014700: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00014710: 732e 636c 6561 6e75 7028 290a 2020 2020  s.cleanup().    
+00014720: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
+00014730: 616c 7365 2870 6174 682e 6578 6973 7473  alse(path.exists
+00014740: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
+00014750: 2e61 7373 6572 7446 616c 7365 2870 6174  .assertFalse(pat
+00014760: 682e 7061 7265 6e74 2e65 7869 7374 7328  h.parent.exists(
+00014770: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+00014780: 6173 7365 7274 4661 6c73 6528 7061 7468  assertFalse(path
+00014790: 2e70 6172 656e 742e 7061 7265 6e74 2e65  .parent.parent.e
+000147a0: 7869 7374 7328 2929 0a0a 2020 2020 6465  xists())..    de
+000147b0: 6620 7465 7374 5f63 6f6e 7461 696e 6572  f test_container
+000147c0: 5f69 7364 6972 5f61 6e64 5f65 7869 7374  _isdir_and_exist
+000147d0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+000147e0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+000147f0: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+00014800: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+00014810: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+00014820: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+00014830: 700a 2020 2020 2020 2020 2020 2020 636f  p.            co
+00014840: 6e74 6169 6e65 7273 3a0a 2020 2020 2020  ntainers:.      
+00014850: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
+00014860: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00014870: 6f75 7263 653a 2066 6f6f 2d69 6d61 6765  ource: foo-image
+00014880: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00014890: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000148a0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+000148b0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+000148c0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
+000148d0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
+000148e0: 7373 2e73 6574 5f63 616e 5f63 6f6e 6e65  ss.set_can_conne
+000148f0: 6374 2827 666f 6f27 2c20 5472 7565 290a  ct('foo', True).
+00014900: 2020 2020 2020 2020 6320 3d20 6861 726e          c = harn
+00014910: 6573 732e 6d6f 6465 6c2e 756e 6974 2e63  ess.model.unit.c
+00014920: 6f6e 7461 696e 6572 735b 2766 6f6f 275d  ontainers['foo']
+00014930: 0a0a 2020 2020 2020 2020 6469 725f 7061  ..        dir_pa
+00014940: 7468 203d 2027 2f74 6d70 2f66 6f6f 2f64  th = '/tmp/foo/d
+00014950: 6972 270a 2020 2020 2020 2020 6669 6c65  ir'.        file
+00014960: 5f70 6174 6820 3d20 272f 746d 702f 666f  _path = '/tmp/fo
+00014970: 6f2f 6669 6c65 270a 0a20 2020 2020 2020  o/file'..       
+00014980: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
+00014990: 6528 632e 6973 6469 7228 6469 725f 7061  e(c.isdir(dir_pa
+000149a0: 7468 2929 0a20 2020 2020 2020 2073 656c  th)).        sel
+000149b0: 662e 6173 7365 7274 4661 6c73 6528 632e  f.assertFalse(c.
+000149c0: 6578 6973 7473 2864 6972 5f70 6174 6829  exists(dir_path)
+000149d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000149e0: 7373 6572 7446 616c 7365 2863 2e69 7364  ssertFalse(c.isd
+000149f0: 6972 2866 696c 655f 7061 7468 2929 0a20  ir(file_path)). 
+00014a00: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00014a10: 7274 4661 6c73 6528 632e 6578 6973 7473  rtFalse(c.exists
+00014a20: 2866 696c 655f 7061 7468 2929 0a0a 2020  (file_path))..  
+00014a30: 2020 2020 2020 632e 6d61 6b65 5f64 6972        c.make_dir
+00014a40: 2864 6972 5f70 6174 682c 206d 616b 655f  (dir_path, make_
+00014a50: 7061 7265 6e74 733d 5472 7565 290a 2020  parents=True).  
+00014a60: 2020 2020 2020 632e 7075 7368 2866 696c        c.push(fil
+00014a70: 655f 7061 7468 2c20 2764 6174 6127 290a  e_path, 'data').
+00014a80: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00014a90: 7365 7274 5472 7565 2863 2e69 7364 6972  sertTrue(c.isdir
+00014aa0: 2864 6972 5f70 6174 6829 290a 2020 2020  (dir_path)).    
+00014ab0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
+00014ac0: 7275 6528 632e 6578 6973 7473 2864 6972  rue(c.exists(dir
+00014ad0: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
+00014ae0: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
+00014af0: 2863 2e69 7364 6972 2866 696c 655f 7061  (c.isdir(file_pa
+00014b00: 7468 2929 0a20 2020 2020 2020 2073 656c  th)).        sel
+00014b10: 662e 6173 7365 7274 5472 7565 2863 2e65  f.assertTrue(c.e
+00014b20: 7869 7374 7328 6669 6c65 5f70 6174 6829  xists(file_path)
+00014b30: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00014b40: 6164 645f 6f63 695f 7265 736f 7572 6365  add_oci_resource
+00014b50: 5f63 7573 746f 6d28 7365 6c66 293a 0a20  _custom(self):. 
+00014b60: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+00014b70: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+00014b80: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+00014b90: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
+00014ba0: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
+00014bb0: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
+00014bc0: 2020 2020 7265 736f 7572 6365 733a 0a20      resources:. 
+00014bd0: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
+00014be0: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+00014bf0: 2020 2020 7479 7065 3a20 6f63 692d 696d      type: oci-im
+00014c00: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
+00014c10: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
+00014c20: 2022 496d 6167 6520 746f 2064 6570 6c6f   "Image to deplo
+00014c30: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
+00014c40: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
+00014c50: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+00014c60: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+00014c70: 2020 2020 2020 6375 7374 6f6d 203d 207b        custom = {
+00014c80: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00014c90: 6769 7374 7279 7061 7468 223a 2022 6375  gistrypath": "cu
+00014ca0: 7374 6f6d 7061 7468 222c 0a20 2020 2020  stompath",.     
+00014cb0: 2020 2020 2020 2022 7573 6572 6e61 6d65         "username
+00014cc0: 223a 2022 6375 7374 6f6d 5f75 7365 726e  ": "custom_usern
+00014cd0: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
+00014ce0: 2020 2270 6173 7377 6f72 6422 3a20 2263    "password": "c
+00014cf0: 7573 746f 6d5f 7061 7373 776f 7264 222c  ustom_password",
+00014d00: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00014d10: 2020 2068 6172 6e65 7373 2e61 6464 5f6f     harness.add_o
+00014d20: 6369 5f72 6573 6f75 7263 6528 2769 6d61  ci_resource('ima
+00014d30: 6765 272c 2063 7573 746f 6d29 0a20 2020  ge', custom).   
+00014d40: 2020 2020 2072 6573 6f75 7263 6520 3d20       resource = 
+00014d50: 6861 726e 6573 732e 6d6f 6465 6c2e 7265  harness.model.re
+00014d60: 736f 7572 6365 732e 6665 7463 6828 2769  sources.fetch('i
+00014d70: 6d61 6765 2729 0a20 2020 2020 2020 2077  mage').        w
+00014d80: 6974 6820 7265 736f 7572 6365 2e6f 7065  ith resource.ope
+00014d90: 6e28 2772 2729 2061 7320 7265 736f 7572  n('r') as resour
+00014da0: 6365 5f66 696c 653a 0a20 2020 2020 2020  ce_file:.       
+00014db0: 2020 2020 2063 6f6e 7465 6e74 7320 3d20       contents = 
+00014dc0: 7961 6d6c 2e73 6166 655f 6c6f 6164 2872  yaml.safe_load(r
+00014dd0: 6573 6f75 7263 655f 6669 6c65 2e72 6561  esource_file.rea
+00014de0: 6428 2929 0a20 2020 2020 2020 2073 656c  d()).        sel
+00014df0: 662e 6173 7365 7274 4571 7561 6c28 636f  f.assertEqual(co
+00014e00: 6e74 656e 7473 5b27 7265 6769 7374 7279  ntents['registry
+00014e10: 7061 7468 275d 2c20 2763 7573 746f 6d70  path'], 'customp
+00014e20: 6174 6827 290a 2020 2020 2020 2020 7365  ath').        se
+00014e30: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00014e40: 6f6e 7465 6e74 735b 2775 7365 726e 616d  ontents['usernam
+00014e50: 6527 5d2c 2027 6375 7374 6f6d 5f75 7365  e'], 'custom_use
+00014e60: 726e 616d 6527 290a 2020 2020 2020 2020  rname').        
+00014e70: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00014e80: 2863 6f6e 7465 6e74 735b 2770 6173 7377  (contents['passw
+00014e90: 6f72 6427 5d2c 2027 6375 7374 6f6d 5f70  ord'], 'custom_p
+00014ea0: 6173 7377 6f72 6427 290a 0a20 2020 2064  assword')..    d
+00014eb0: 6566 2074 6573 745f 6164 645f 6f63 695f  ef test_add_oci_
+00014ec0: 7265 736f 7572 6365 5f6e 6f5f 696d 6167  resource_no_imag
+00014ed0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00014ee0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+00014ef0: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+00014f00: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+00014f10: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+00014f20: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+00014f30: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+00014f40: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
+00014f50: 2020 2020 2020 2069 6d61 6765 3a0a 2020         image:.  
+00014f60: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+00014f70: 7065 3a20 6669 6c65 0a20 2020 2020 2020  pe: file.       
+00014f80: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+00014f90: 7469 6f6e 3a20 2249 6d61 6765 2074 6f20  tion: "Image to 
+00014fa0: 6465 706c 6f79 2e22 0a20 2020 2020 2020  deploy.".       
+00014fb0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+00014fc0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00014fd0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+00014fe0: 7029 0a20 2020 2020 2020 2077 6974 6820  p).        with 
+00014ff0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00015000: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+00015010: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+00015020: 6e65 7373 2e61 6464 5f6f 6369 5f72 6573  ness.add_oci_res
+00015030: 6f75 7263 6528 2269 6d61 6765 2229 0a20  ource("image"). 
+00015040: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00015050: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
+00015060: 6e74 696d 6545 7272 6f72 293a 0a20 2020  ntimeError):.   
+00015070: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
+00015080: 2e61 6464 5f6f 6369 5f72 6573 6f75 7263  .add_oci_resourc
+00015090: 6528 226d 6973 7369 6e67 2d72 6573 6f75  e("missing-resou
+000150a0: 7263 6522 290a 2020 2020 2020 2020 7365  rce").        se
+000150b0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+000150c0: 656e 2868 6172 6e65 7373 2e5f 6261 636b  en(harness._back
+000150d0: 656e 642e 5f72 6573 6f75 7263 6573 5f6d  end._resources_m
+000150e0: 6170 292c 2030 290a 0a20 2020 2064 6566  ap), 0)..    def
+000150f0: 2074 6573 745f 6164 645f 7265 736f 7572   test_add_resour
+00015100: 6365 5f75 6e6b 6e6f 776e 2873 656c 6629  ce_unknown(self)
+00015110: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+00015120: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+00015130: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+00015140: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+00015150: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00015160: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
+00015170: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+00015180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015190: 696d 6167 653a 0a20 2020 2020 2020 2020  image:.         
+000151a0: 2020 2020 2020 2074 7970 653a 2066 696c         type: fil
+000151b0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000151c0: 2020 6465 7363 7269 7074 696f 6e3a 2022    description: "
+000151d0: 496d 6167 6520 746f 2064 6570 6c6f 792e  Image to deploy.
+000151e0: 220a 2020 2020 2020 2020 2020 2020 2727  ".            ''
+000151f0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00015200: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+00015210: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+00015220: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00015230: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
+00015240: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+00015250: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
+00015260: 645f 7265 736f 7572 6365 2827 756e 6b6e  d_resource('unkn
+00015270: 6f77 6e27 2c20 2763 6f6e 7465 6e74 2729  own', 'content')
+00015280: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+00015290: 6464 5f72 6573 6f75 7263 655f 6275 745f  dd_resource_but_
+000152a0: 6f63 6928 7365 6c66 293a 0a20 2020 2020  oci(self):.     
+000152b0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+000152c0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+000152d0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+000152e0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+000152f0: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+00015300: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
+00015310: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
+00015320: 2020 2020 2020 2020 2069 6d61 6765 3a0a           image:.
+00015330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015340: 7479 7065 3a20 6f63 692d 696d 6167 650a  type: oci-image.
+00015350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015360: 6465 7363 7269 7074 696f 6e3a 2022 496d  description: "Im
+00015370: 6167 6520 746f 2064 6570 6c6f 792e 220a  age to deploy.".
+00015380: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00015390: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+000153a0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+000153b0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+000153c0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+000153d0: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
+000153e0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+000153f0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+00015400: 7265 736f 7572 6365 2827 696d 6167 6527  resource('image'
+00015410: 2c20 2763 6f6e 7465 6e74 2729 0a0a 2020  , 'content')..  
+00015420: 2020 6465 6620 7465 7374 5f61 6464 5f72    def test_add_r
+00015430: 6573 6f75 7263 655f 7374 7269 6e67 2873  esource_string(s
+00015440: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
+00015450: 726e 6573 7320 3d20 6f70 732e 7465 7374  rness = ops.test
+00015460: 696e 672e 4861 726e 6573 7328 6f70 732e  ing.Harness(ops.
+00015470: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
+00015480: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00015490: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
+000154a0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+000154b0: 7263 6573 3a0a 2020 2020 2020 2020 2020  rces:.          
+000154c0: 2020 2020 696d 6167 653a 0a20 2020 2020      image:.     
+000154d0: 2020 2020 2020 2020 2020 2074 7970 653a             type:
+000154e0: 2066 696c 650a 2020 2020 2020 2020 2020   file.          
+000154f0: 2020 2020 2020 6669 6c65 6e61 6d65 3a20        filename: 
+00015500: 666f 6f2e 7478 740a 2020 2020 2020 2020  foo.txt.        
+00015510: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+00015520: 696f 6e3a 2022 496d 6167 6520 746f 2064  ion: "Image to d
+00015530: 6570 6c6f 792e 220a 2020 2020 2020 2020  eploy.".        
+00015540: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
+00015550: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
+00015560: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
+00015570: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00015580: 732e 6164 645f 7265 736f 7572 6365 2827  s.add_resource('
+00015590: 696d 6167 6527 2c20 2766 6f6f 2063 6f6e  image', 'foo con
+000155a0: 7465 6e74 735c 6e27 290a 2020 2020 2020  tents\n').      
+000155b0: 2020 7061 7468 203d 2068 6172 6e65 7373    path = harness
+000155c0: 2e6d 6f64 656c 2e72 6573 6f75 7263 6573  .model.resources
+000155d0: 2e66 6574 6368 2827 696d 6167 6527 290a  .fetch('image').
+000155e0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000155f0: 6572 7445 7175 616c 2870 6174 682e 6e61  ertEqual(path.na
+00015600: 6d65 2c20 2766 6f6f 2e74 7874 2729 0a20  me, 'foo.txt'). 
+00015610: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015620: 7274 4571 7561 6c28 7061 7468 2e70 6172  rtEqual(path.par
+00015630: 656e 742e 6e61 6d65 2c20 2769 6d61 6765  ent.name, 'image
+00015640: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
+00015650: 7061 7468 2e6f 7065 6e28 2772 7427 2920  path.open('rt') 
+00015660: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
+00015670: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00015680: 616c 2827 666f 6f20 636f 6e74 656e 7473  al('foo contents
+00015690: 5c6e 272c 2066 2e72 6561 6428 2929 0a0a  \n', f.read())..
+000156a0: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+000156b0: 5f72 6573 6f75 7263 655f 6279 7465 7328  _resource_bytes(
+000156c0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+000156d0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+000156e0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+000156f0: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+00015700: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+00015710: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
+00015720: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+00015730: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
+00015740: 2020 2020 2069 6d61 6765 3a0a 2020 2020       image:.    
+00015750: 2020 2020 2020 2020 2020 2020 7479 7065              type
+00015760: 3a20 6669 6c65 0a20 2020 2020 2020 2020  : file.         
+00015770: 2020 2020 2020 2066 696c 656e 616d 653a         filename:
+00015780: 2066 6f6f 2e7a 6970 0a20 2020 2020 2020   foo.zip.       
+00015790: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+000157a0: 7469 6f6e 3a20 2249 6d61 6765 2074 6f20  tion: "Image to 
+000157b0: 6465 706c 6f79 2e22 0a20 2020 2020 2020  deploy.".       
+000157c0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+000157d0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+000157e0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+000157f0: 7029 0a20 2020 2020 2020 2072 6177 5f63  p).        raw_c
+00015800: 6f6e 7465 6e74 7320 3d20 6227 5c78 6666  ontents = b'\xff
+00015810: 5c78 6666 5c78 3030 626c 6168 5c6e 270a  \xff\x00blah\n'.
+00015820: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00015830: 6164 645f 7265 736f 7572 6365 2827 696d  add_resource('im
+00015840: 6167 6527 2c20 7261 775f 636f 6e74 656e  age', raw_conten
+00015850: 7473 290a 2020 2020 2020 2020 7061 7468  ts).        path
+00015860: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
+00015870: 2e72 6573 6f75 7263 6573 2e66 6574 6368  .resources.fetch
+00015880: 2827 696d 6167 6527 290a 2020 2020 2020  ('image').      
+00015890: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000158a0: 616c 2870 6174 682e 6e61 6d65 2c20 2766  al(path.name, 'f
+000158b0: 6f6f 2e7a 6970 2729 0a20 2020 2020 2020  oo.zip').       
+000158c0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000158d0: 6c28 7061 7468 2e70 6172 656e 742e 6e61  l(path.parent.na
+000158e0: 6d65 2c20 2769 6d61 6765 2729 0a20 2020  me, 'image').   
+000158f0: 2020 2020 2077 6974 6820 7061 7468 2e6f       with path.o
+00015900: 7065 6e28 2772 6227 2920 6173 2066 3a0a  pen('rb') as f:.
+00015910: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015920: 2e61 7373 6572 7445 7175 616c 2872 6177  .assertEqual(raw
+00015930: 5f63 6f6e 7465 6e74 732c 2066 2e72 6561  _contents, f.rea
+00015940: 6428 2929 0a0a 2020 2020 6465 6620 7465  d())..    def te
+00015950: 7374 5f61 6464 5f72 6573 6f75 7263 655f  st_add_resource_
+00015960: 756e 6b6e 6f77 6e5f 6669 6c65 6e61 6d65  unknown_filename
+00015970: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00015980: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+00015990: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+000159a0: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+000159b0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+000159c0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+000159d0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+000159e0: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
+000159f0: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
+00015a00: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00015a10: 653a 2066 696c 650a 2020 2020 2020 2020  e: file.        
+00015a20: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+00015a30: 696f 6e3a 2022 496d 6167 6520 746f 2064  ion: "Image to d
+00015a40: 6570 6c6f 792e 220a 2020 2020 2020 2020  eploy.".        
+00015a50: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
+00015a60: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
+00015a70: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
+00015a80: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00015a90: 732e 6164 645f 7265 736f 7572 6365 2827  s.add_resource('
+00015aa0: 696d 6167 6527 2c20 2766 6f6f 2063 6f6e  image', 'foo con
+00015ab0: 7465 6e74 735c 6e27 290a 2020 2020 2020  tents\n').      
+00015ac0: 2020 7061 7468 203d 2068 6172 6e65 7373    path = harness
+00015ad0: 2e6d 6f64 656c 2e72 6573 6f75 7263 6573  .model.resources
+00015ae0: 2e66 6574 6368 2827 696d 6167 6527 290a  .fetch('image').
+00015af0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015b00: 6572 7445 7175 616c 2870 6174 682e 6e61  ertEqual(path.na
+00015b10: 6d65 2c20 2769 6d61 6765 2729 0a20 2020  me, 'image').   
+00015b20: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00015b30: 4571 7561 6c28 7061 7468 2e70 6172 656e  Equal(path.paren
+00015b40: 742e 6e61 6d65 2c20 2769 6d61 6765 2729  t.name, 'image')
+00015b50: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+00015b60: 6574 5f70 6f64 5f73 7065 6328 7365 6c66  et_pod_spec(self
+00015b70: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
+00015b80: 7373 203d 206f 7073 2e74 6573 7469 6e67  ss = ops.testing
+00015b90: 2e48 6172 6e65 7373 286f 7073 2e43 6861  .Harness(ops.Cha
+00015ba0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
+00015bb0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00015bc0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+00015bd0: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+00015be0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+00015bf0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+00015c00: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
+00015c10: 726e 6573 732e 7365 745f 6c65 6164 6572  rness.set_leader
+00015c20: 2854 7275 6529 0a20 2020 2020 2020 2063  (True).        c
+00015c30: 6f6e 7461 696e 6572 5f73 7065 6320 3d20  ontainer_spec = 
+00015c40: 7b27 636f 6e74 6169 6e65 7227 3a20 2773  {'container': 's
+00015c50: 7065 6327 7d0a 2020 2020 2020 2020 6b38  pec'}.        k8
+00015c60: 735f 7265 736f 7572 6365 7320 3d20 7b27  s_resources = {'
+00015c70: 6b38 7327 3a20 2773 7065 6327 7d0a 2020  k8s': 'spec'}.  
+00015c80: 2020 2020 2020 6861 726e 6573 732e 6d6f        harness.mo
+00015c90: 6465 6c2e 706f 642e 7365 745f 7370 6563  del.pod.set_spec
+00015ca0: 2863 6f6e 7461 696e 6572 5f73 7065 632c  (container_spec,
+00015cb0: 206b 3873 5f72 6573 6f75 7263 6573 290a   k8s_resources).
+00015cc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00015cd0: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
+00015ce0: 2e67 6574 5f70 6f64 5f73 7065 6328 292c  .get_pod_spec(),
+00015cf0: 2028 636f 6e74 6169 6e65 725f 7370 6563   (container_spec
+00015d00: 2c20 6b38 735f 7265 736f 7572 6365 7329  , k8s_resources)
+00015d10: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00015d20: 6265 6769 6e5f 7769 7468 5f69 6e69 7469  begin_with_initi
+00015d30: 616c 5f68 6f6f 6b73 5f6e 6f5f 7265 6c61  al_hooks_no_rela
+00015d40: 7469 6f6e 7328 7365 6c66 293a 0a20 2020  tions(self):.   
+00015d50: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+00015d60: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+00015d70: 7373 2852 6563 6f72 6469 6e67 4368 6172  ss(RecordingChar
+00015d80: 6d2c 206d 6574 613d 2727 270a 2020 2020  m, meta='''.    
+00015d90: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+00015da0: 7374 2d61 7070 0a20 2020 2020 2020 2020  st-app.         
+00015db0: 2020 2027 2727 2c20 636f 6e66 6967 3d27     ''', config='
+00015dc0: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
+00015dd0: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
+00015de0: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
+00015df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e00: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
+00015e10: 636f 6e66 6967 206f 7074 696f 6e0a 2020  config option.  
+00015e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e30: 2020 7479 7065 3a20 7374 7269 6e67 0a20    type: string. 
+00015e40: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00015e50: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00015e60: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00015e70: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00015e80: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+00015e90: 636f 6e66 6967 287b 2766 6f6f 273a 2027  config({'foo': '
+00015ea0: 6261 7227 7d29 0a20 2020 2020 2020 2068  bar'}).        h
+00015eb0: 6172 6e65 7373 2e73 6574 5f6c 6561 6465  arness.set_leade
+00015ec0: 7228 5472 7565 290a 2020 2020 2020 2020  r(True).        
+00015ed0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+00015ee0: 5261 6973 6573 2852 756e 7469 6d65 4572  Raises(RuntimeEr
+00015ef0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00015f00: 2020 5f20 3d20 6861 726e 6573 732e 6368    _ = harness.ch
+00015f10: 6172 6d0a 2020 2020 2020 2020 6861 726e  arm.        harn
+00015f20: 6573 732e 6265 6769 6e5f 7769 7468 5f69  ess.begin_with_i
+00015f30: 6e69 7469 616c 5f68 6f6f 6b73 2829 0a20  nitial_hooks(). 
+00015f40: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00015f50: 7274 4973 4e6f 744e 6f6e 6528 6861 726e  rtIsNotNone(harn
+00015f60: 6573 732e 6368 6172 6d29 0a20 2020 2020  ess.charm).     
+00015f70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00015f80: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+00015f90: 2068 6172 6e65 7373 2e63 6861 726d 2e63   harness.charm.c
+00015fa0: 6861 6e67 6573 2c0a 2020 2020 2020 2020  hanges,.        
+00015fb0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00015fc0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+00015fd0: 696e 7374 616c 6c27 7d2c 0a20 2020 2020  install'},.     
+00015fe0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00015ff0: 6527 3a20 276c 6561 6465 722d 656c 6563  e': 'leader-elec
+00016000: 7465 6427 7d2c 0a20 2020 2020 2020 2020  ted'},.         
+00016010: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+00016020: 2763 6f6e 6669 672d 6368 616e 6765 6427  'config-changed'
+00016030: 2c20 2764 6174 6127 3a20 7b27 666f 6f27  , 'data': {'foo'
+00016040: 3a20 2762 6172 277d 7d2c 0a20 2020 2020  : 'bar'}},.     
+00016050: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00016060: 6527 3a20 2773 7461 7274 277d 2c0a 2020  e': 'start'},.  
+00016070: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+00016080: 2020 2020 290a 0a20 2020 2064 6566 2074      )..    def t
+00016090: 6573 745f 6265 6769 6e5f 7769 7468 5f69  est_begin_with_i
+000160a0: 6e69 7469 616c 5f68 6f6f 6b73 5f6e 6f5f  nitial_hooks_no_
+000160b0: 7265 6c61 7469 6f6e 735f 6e6f 745f 6c65  relations_not_le
+000160c0: 6164 6572 2873 656c 6629 3a0a 2020 2020  ader(self):.    
+000160d0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+000160e0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+000160f0: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
+00016100: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+00016110: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+00016120: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+00016130: 2020 2727 272c 2063 6f6e 6669 673d 2727    ''', config=''
+00016140: 270a 2020 2020 2020 2020 2020 2020 6f70  '.            op
+00016150: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00016160: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+00016170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016180: 6465 7363 7269 7074 696f 6e3a 2061 2063  description: a c
+00016190: 6f6e 6669 6720 6f70 7469 6f6e 0a20 2020  onfig option.   
+000161a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161b0: 2074 7970 653a 2073 7472 696e 670a 2020   type: string.  
+000161c0: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+000161d0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
+000161e0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
+000161f0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
+00016200: 6861 726e 6573 732e 7570 6461 7465 5f63  harness.update_c
+00016210: 6f6e 6669 6728 7b27 666f 6f27 3a20 2762  onfig({'foo': 'b
+00016220: 6172 277d 290a 2020 2020 2020 2020 7769  ar'}).        wi
+00016230: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00016240: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+00016250: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00016260: 5f20 3d20 6861 726e 6573 732e 6368 6172  _ = harness.char
+00016270: 6d0a 2020 2020 2020 2020 6861 726e 6573  m.        harnes
+00016280: 732e 6265 6769 6e5f 7769 7468 5f69 6e69  s.begin_with_ini
+00016290: 7469 616c 5f68 6f6f 6b73 2829 0a20 2020  tial_hooks().   
+000162a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000162b0: 4973 4e6f 744e 6f6e 6528 6861 726e 6573  IsNotNone(harnes
+000162c0: 732e 6368 6172 6d29 0a20 2020 2020 2020  s.charm).       
+000162d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000162e0: 6c28 0a20 2020 2020 2020 2020 2020 2068  l(.            h
+000162f0: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
+00016300: 6e67 6573 2c0a 2020 2020 2020 2020 2020  nges,.          
+00016310: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00016320: 2020 2020 7b27 6e61 6d65 273a 2027 696e      {'name': 'in
+00016330: 7374 616c 6c27 7d2c 0a20 2020 2020 2020  stall'},.       
+00016340: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+00016350: 3a20 276c 6561 6465 722d 7365 7474 696e  : 'leader-settin
+00016360: 6773 2d63 6861 6e67 6564 277d 2c0a 2020  gs-changed'},.  
+00016370: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+00016380: 6e61 6d65 273a 2027 636f 6e66 6967 2d63  name': 'config-c
+00016390: 6861 6e67 6564 272c 2027 6461 7461 273a  hanged', 'data':
+000163a0: 207b 2766 6f6f 273a 2027 6261 7227 7d7d   {'foo': 'bar'}}
+000163b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000163c0: 2020 7b27 6e61 6d65 273a 2027 7374 6172    {'name': 'star
+000163d0: 7427 7d2c 0a20 2020 2020 2020 2020 2020  t'},.           
+000163e0: 205d 0a20 2020 2020 2020 2029 0a0a 2020   ].        )..  
+000163f0: 2020 6465 6620 7465 7374 5f62 6567 696e    def test_begin
+00016400: 5f77 6974 685f 696e 6974 6961 6c5f 686f  _with_initial_ho
+00016410: 6f6b 735f 7769 7468 5f70 6565 725f 7265  oks_with_peer_re
+00016420: 6c61 7469 6f6e 2873 656c 6629 3a0a 2020  lation(self):.  
+00016430: 2020 2020 2020 636c 6173 7320 5065 6572        class Peer
+00016440: 4368 6172 6d28 5265 6c61 7469 6f6e 4576  Charm(RelationEv
+00016450: 656e 7443 6861 726d 293a 0a20 2020 2020  entCharm):.     
+00016460: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
+00016470: 745f 5f28 7365 6c66 2c20 6672 616d 6577  t__(self, framew
+00016480: 6f72 6b29 3a0a 2020 2020 2020 2020 2020  ork):.          
+00016490: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+000164a0: 696e 6974 5f5f 2866 7261 6d65 776f 726b  init__(framework
+000164b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000164c0: 2020 7365 6c66 2e6f 6273 6572 7665 5f72    self.observe_r
+000164d0: 656c 6174 696f 6e5f 6576 656e 7473 2827  elation_events('
+000164e0: 7065 6572 2729 0a20 2020 2020 2020 2068  peer').        h
+000164f0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+00016500: 7469 6e67 2e48 6172 6e65 7373 2850 6565  ting.Harness(Pee
+00016510: 7243 6861 726d 2c20 6d65 7461 3d27 2727  rCharm, meta='''
+00016520: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00016530: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+00016540: 2020 2020 2020 2020 7065 6572 733a 0a20          peers:. 
+00016550: 2020 2020 2020 2020 2020 2020 2070 6565               pee
+00016560: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00016570: 2020 2069 6e74 6572 6661 6365 3a20 6170     interface: ap
+00016580: 702d 7065 6572 0a20 2020 2020 2020 2020  p-peer.         
+00016590: 2020 2027 2727 2c20 636f 6e66 6967 3d27     ''', config='
+000165a0: 2727 0a20 2020 2020 2020 2020 2020 206f  ''.            o
+000165b0: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
+000165c0: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
+000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165e0: 2064 6573 6372 6970 7469 6f6e 3a20 6120   description: a 
+000165f0: 636f 6e66 6967 206f 7074 696f 6e0a 2020  config option.  
+00016600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016610: 2020 7479 7065 3a20 7374 7269 6e67 0a20    type: string. 
+00016620: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00016630: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00016640: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+00016650: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+00016660: 2068 6172 6e65 7373 2e75 7064 6174 655f   harness.update_
+00016670: 636f 6e66 6967 287b 2766 6f6f 273a 2027  config({'foo': '
+00016680: 6261 7227 7d29 0a20 2020 2020 2020 2077  bar'}).        w
+00016690: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+000166a0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
+000166b0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000166c0: 205f 203d 2068 6172 6e65 7373 2e63 6861   _ = harness.cha
+000166d0: 726d 0a20 2020 2020 2020 2068 6172 6e65  rm.        harne
+000166e0: 7373 2e62 6567 696e 5f77 6974 685f 696e  ss.begin_with_in
+000166f0: 6974 6961 6c5f 686f 6f6b 7328 290a 2020  itial_hooks().  
+00016700: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00016710: 7449 734e 6f74 4e6f 6e65 2868 6172 6e65  tIsNotNone(harne
+00016720: 7373 2e63 6861 726d 290a 2020 2020 2020  ss.charm).      
+00016730: 2020 7265 6c5f 6964 203d 2068 6172 6e65    rel_id = harne
+00016740: 7373 2e6d 6f64 656c 2e67 6574 5f72 656c  ss.model.get_rel
+00016750: 6174 696f 6e28 2770 6565 7227 292e 6964  ation('peer').id
+00016760: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00016770: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
+00016780: 2020 2020 2020 2068 6172 6e65 7373 2e63         harness.c
+00016790: 6861 726d 2e63 6861 6e67 6573 2c0a 2020  harm.changes,.  
+000167a0: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+000167b0: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+000167c0: 6d65 273a 2027 696e 7374 616c 6c27 7d2c  me': 'install'},
+000167d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000167e0: 207b 276e 616d 6527 3a20 2772 656c 6174   {'name': 'relat
+000167f0: 696f 6e2d 6372 6561 7465 6427 2c0a 2020  ion-created',.  
+00016800: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00016810: 7265 6c61 7469 6f6e 273a 2027 7065 6572  relation': 'peer
+00016820: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00016830: 2020 2020 2764 6174 6127 3a20 7b0a 2020      'data': {.  
+00016840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016850: 2020 2027 7265 6c61 7469 6f6e 5f69 6427     'relation_id'
+00016860: 3a20 7265 6c5f 6964 2c0a 2020 2020 2020  : rel_id,.      
+00016870: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00016880: 756e 6974 273a 204e 6f6e 652c 0a20 2020  unit': None,.   
+00016890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168a0: 2020 2761 7070 273a 2027 7465 7374 2d61    'app': 'test-a
+000168b0: 7070 272c 0a20 2020 2020 2020 2020 2020  pp',.           
+000168c0: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
+000168d0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+000168e0: 273a 2027 6c65 6164 6572 2d73 6574 7469  ': 'leader-setti
+000168f0: 6e67 732d 6368 616e 6765 6427 7d2c 0a20  ngs-changed'},. 
+00016900: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00016910: 276e 616d 6527 3a20 2763 6f6e 6669 672d  'name': 'config-
+00016920: 6368 616e 6765 6427 2c20 2764 6174 6127  changed', 'data'
+00016930: 3a20 7b27 666f 6f27 3a20 2762 6172 277d  : {'foo': 'bar'}
+00016940: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00016950: 2020 207b 276e 616d 6527 3a20 2773 7461     {'name': 'sta
+00016960: 7274 277d 2c0a 2020 2020 2020 2020 2020  rt'},.          
+00016970: 2020 5d29 0a20 2020 2020 2020 2023 2057    ]).        # W
+00016980: 6974 6820 6120 7369 6e67 6c65 2075 6e69  ith a single uni
+00016990: 742c 206e 6f20 7065 6572 2d72 656c 6174  t, no peer-relat
+000169a0: 696f 6e2d 6a6f 696e 6564 2069 7320 6669  ion-joined is fi
+000169b0: 7265 640a 0a20 2020 2064 6566 2074 6573  red..    def tes
+000169c0: 745f 6265 6769 6e5f 7769 7468 5f69 6e69  t_begin_with_ini
+000169d0: 7469 616c 5f68 6f6f 6b73 5f70 6565 725f  tial_hooks_peer_
+000169e0: 7265 6c61 7469 6f6e 5f70 7265 5f64 6566  relation_pre_def
+000169f0: 696e 6564 2873 656c 6629 3a0a 2020 2020  ined(self):.    
+00016a00: 2020 2020 636c 6173 7320 5065 6572 4368      class PeerCh
+00016a10: 6172 6d28 5265 6c61 7469 6f6e 4576 656e  arm(RelationEven
+00016a20: 7443 6861 726d 293a 0a20 2020 2020 2020  tCharm):.       
+00016a30: 2020 2020 2064 6566 205f 5f69 6e69 745f       def __init_
+00016a40: 5f28 7365 6c66 2c20 6672 616d 6577 6f72  _(self, framewor
+00016a50: 6b29 3a0a 2020 2020 2020 2020 2020 2020  k):.            
+00016a60: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+00016a70: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
+00016a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a90: 7365 6c66 2e6f 6273 6572 7665 5f72 656c  self.observe_rel
+00016aa0: 6174 696f 6e5f 6576 656e 7473 2827 7065  ation_events('pe
+00016ab0: 6572 2729 0a20 2020 2020 2020 2068 6172  er').        har
+00016ac0: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00016ad0: 6e67 2e48 6172 6e65 7373 2850 6565 7243  ng.Harness(PeerC
+00016ae0: 6861 726d 2c20 6d65 7461 3d27 2727 0a20  harm, meta='''. 
+00016af0: 2020 2020 2020 2020 2020 206e 616d 653a             name:
+00016b00: 2074 6573 742d 6170 700a 2020 2020 2020   test-app.      
+00016b10: 2020 2020 2020 7065 6572 733a 0a20 2020        peers:.   
+00016b20: 2020 2020 2020 2020 2020 2070 6565 723a             peer:
+00016b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016b40: 2069 6e74 6572 6661 6365 3a20 6170 702d   interface: app-
+00016b50: 7065 6572 0a20 2020 2020 2020 2020 2020  peer.           
+00016b60: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00016b70: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00016b80: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00016b90: 2020 2020 2020 2070 6565 725f 7265 6c5f         peer_rel_
+00016ba0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+00016bb0: 5f72 656c 6174 696f 6e28 2770 6565 7227  _relation('peer'
+00016bc0: 2c20 2774 6573 742d 6170 7027 290a 2020  , 'test-app').  
+00016bd0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00016be0: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
+00016bf0: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
+00016c00: 2023 2049 6620 7468 6520 7065 6572 2072   # If the peer r
+00016c10: 656c 6174 696f 6e20 6973 2061 6c72 6561  elation is alrea
+00016c20: 6479 2064 6566 696e 6564 2062 7920 7468  dy defined by th
+00016c30: 6520 7573 6572 2c20 7765 2064 6f6e 2774  e user, we don't
+00016c40: 2063 7265 6174 6520 7468 6520 7265 6c61   create the rela
+00016c50: 7469 6f6e 2061 0a20 2020 2020 2020 2023  tion a.        #
+00016c60: 2073 6563 6f6e 6420 7469 6d65 2c20 6275   second time, bu
+00016c70: 7420 7765 2064 6f20 7374 696c 6c20 6669  t we do still fi
+00016c80: 7265 2072 656c 6174 696f 6e2d 6372 6561  re relation-crea
+00016c90: 7465 642e 0a20 2020 2020 2020 2073 656c  ted..        sel
+00016ca0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00016cb0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+00016cc0: 7373 2e63 6861 726d 2e63 6861 6e67 6573  ss.charm.changes
+00016cd0: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
+00016ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016cf0: 7b27 6e61 6d65 273a 2027 696e 7374 616c  {'name': 'instal
+00016d00: 6c27 7d2c 0a20 2020 2020 2020 2020 2020  l'},.           
+00016d10: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+00016d20: 656c 6174 696f 6e2d 6372 6561 7465 6427  elation-created'
+00016d30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016d40: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
+00016d50: 7065 6572 272c 0a20 2020 2020 2020 2020  peer',.         
+00016d60: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
+00016d70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00016d80: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00016d90: 5f69 6427 3a20 7065 6572 5f72 656c 5f69  _id': peer_rel_i
+00016da0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00016db0: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
+00016dc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00016dd0: 2020 2020 2020 2020 2020 2027 6170 7027             'app'
+00016de0: 3a20 2774 6573 742d 6170 7027 2c0a 2020  : 'test-app',.  
+00016df0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00016e00: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00016e10: 2020 207b 276e 616d 6527 3a20 276c 6561     {'name': 'lea
+00016e20: 6465 722d 7365 7474 696e 6773 2d63 6861  der-settings-cha
+00016e30: 6e67 6564 277d 2c0a 2020 2020 2020 2020  nged'},.        
+00016e40: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+00016e50: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
+00016e60: 272c 2027 6461 7461 273a 207b 7d7d 2c0a  ', 'data': {}},.
+00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e80: 7b27 6e61 6d65 273a 2027 7374 6172 7427  {'name': 'start'
+00016e90: 7d2c 0a20 2020 2020 2020 2020 2020 205d  },.            ]
+00016ea0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00016eb0: 6265 6769 6e5f 7769 7468 5f69 6e69 7469  begin_with_initi
+00016ec0: 616c 5f68 6f6f 6b73 5f72 656c 6174 696f  al_hooks_relatio
+00016ed0: 6e5f 6368 6172 6d5f 7769 7468 5f6e 6f5f  n_charm_with_no_
+00016ee0: 7265 6c61 7469 6f6e 2873 656c 6629 3a0a  relation(self):.
+00016ef0: 2020 2020 2020 2020 636c 6173 7320 4368          class Ch
+00016f00: 6172 6d57 6974 6844 4228 5265 6c61 7469  armWithDB(Relati
+00016f10: 6f6e 4576 656e 7443 6861 726d 293a 0a20  onEventCharm):. 
+00016f20: 2020 2020 2020 2020 2020 2064 6566 205f             def _
+00016f30: 5f69 6e69 745f 5f28 7365 6c66 2c20 6672  _init__(self, fr
+00016f40: 616d 6577 6f72 6b29 3a0a 2020 2020 2020  amework):.      
+00016f50: 2020 2020 2020 2020 2020 7375 7065 7228            super(
+00016f60: 292e 5f5f 696e 6974 5f5f 2866 7261 6d65  ).__init__(frame
+00016f70: 776f 726b 290a 2020 2020 2020 2020 2020  work).          
+00016f80: 2020 2020 2020 7365 6c66 2e6f 6273 6572        self.obser
+00016f90: 7665 5f72 656c 6174 696f 6e5f 6576 656e  ve_relation_even
+00016fa0: 7473 2827 6462 2729 0a20 2020 2020 2020  ts('db').       
+00016fb0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+00016fc0: 6573 7469 6e67 2e48 6172 6e65 7373 2843  esting.Harness(C
+00016fd0: 6861 726d 5769 7468 4442 2c20 6d65 7461  harmWithDB, meta
+00016fe0: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
+00016ff0: 206e 616d 653a 2074 6573 742d 6170 700a   name: test-app.
+00017000: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+00017010: 6972 6573 3a0a 2020 2020 2020 2020 2020  ires:.          
+00017020: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
+00017030: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
+00017040: 653a 2073 716c 0a20 2020 2020 2020 2020  e: sql.         
+00017050: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
+00017060: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+00017070: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+00017080: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00017090: 2e73 6574 5f6c 6561 6465 7228 290a 2020  .set_leader().  
+000170a0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+000170b0: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
+000170c0: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
+000170d0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+000170e0: 6c28 0a20 2020 2020 2020 2020 2020 2068  l(.            h
+000170f0: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
+00017100: 6e67 6573 2c0a 2020 2020 2020 2020 2020  nges,.          
+00017110: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00017120: 2020 2020 7b27 6e61 6d65 273a 2027 696e      {'name': 'in
+00017130: 7374 616c 6c27 7d2c 0a20 2020 2020 2020  stall'},.       
+00017140: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+00017150: 3a20 276c 6561 6465 722d 656c 6563 7465  : 'leader-electe
+00017160: 6427 7d2c 0a20 2020 2020 2020 2020 2020  d'},.           
+00017170: 2020 2020 207b 276e 616d 6527 3a20 2763       {'name': 'c
+00017180: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
+00017190: 2764 6174 6127 3a20 7b7d 7d2c 0a20 2020  'data': {}},.   
+000171a0: 2020 2020 2020 2020 2020 2020 207b 276e               {'n
+000171b0: 616d 6527 3a20 2773 7461 7274 277d 2c0a  ame': 'start'},.
+000171c0: 2020 2020 2020 2020 2020 2020 5d29 0a0a              ])..
+000171d0: 2020 2020 6465 6620 7465 7374 5f62 6567      def test_beg
+000171e0: 696e 5f77 6974 685f 696e 6974 6961 6c5f  in_with_initial_
+000171f0: 686f 6f6b 735f 7769 7468 5f6f 6e65 5f72  hooks_with_one_r
+00017200: 656c 6174 696f 6e28 7365 6c66 293a 0a20  elation(self):. 
+00017210: 2020 2020 2020 2063 6c61 7373 2043 6861         class Cha
+00017220: 726d 5769 7468 4442 2852 656c 6174 696f  rmWithDB(Relatio
+00017230: 6e45 7665 6e74 4368 6172 6d29 3a0a 2020  nEventCharm):.  
+00017240: 2020 2020 2020 2020 2020 6465 6620 5f5f            def __
+00017250: 696e 6974 5f5f 2873 656c 662c 2066 7261  init__(self, fra
+00017260: 6d65 776f 726b 293a 0a20 2020 2020 2020  mework):.       
+00017270: 2020 2020 2020 2020 2073 7570 6572 2829           super()
+00017280: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
+00017290: 6f72 6b29 0a20 2020 2020 2020 2020 2020  ork).           
+000172a0: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
+000172b0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
+000172c0: 7328 2764 6227 290a 2020 2020 2020 2020  s('db').        
+000172d0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+000172e0: 7374 696e 672e 4861 726e 6573 7328 4368  sting.Harness(Ch
+000172f0: 6172 6d57 6974 6844 422c 206d 6574 613d  armWithDB, meta=
+00017300: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+00017310: 6e61 6d65 3a20 7465 7374 2d61 7070 0a20  name: test-app. 
+00017320: 2020 2020 2020 2020 2020 2072 6571 7569             requi
+00017330: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+00017340: 2020 2064 623a 0a20 2020 2020 2020 2020     db:.         
+00017350: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
+00017360: 3a20 7371 6c0a 2020 2020 2020 2020 2020  : sql.          
+00017370: 2020 2727 2729 0a20 2020 2020 2020 2073    ''').        s
+00017380: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
+00017390: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
+000173a0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+000173b0: 7365 745f 6c65 6164 6572 2829 0a20 2020  set_leader().   
+000173c0: 2020 2020 2072 656c 5f69 6420 3d20 6861       rel_id = ha
+000173d0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
+000173e0: 6f6e 2827 6462 272c 2027 706f 7374 6772  on('db', 'postgr
+000173f0: 6573 716c 2729 0a20 2020 2020 2020 2068  esql').        h
+00017400: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+00017410: 696f 6e5f 756e 6974 2872 656c 5f69 642c  ion_unit(rel_id,
+00017420: 2027 706f 7374 6772 6573 716c 2f30 2729   'postgresql/0')
+00017430: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+00017440: 2e75 7064 6174 655f 7265 6c61 7469 6f6e  .update_relation
+00017450: 5f64 6174 6128 7265 6c5f 6964 2c20 2770  _data(rel_id, 'p
+00017460: 6f73 7467 7265 7371 6c2f 3027 2c20 7b27  ostgresql/0', {'
+00017470: 6e65 7727 3a20 2764 6174 6127 7d29 0a20  new': 'data'}). 
+00017480: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+00017490: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
+000174a0: 6c5f 686f 6f6b 7328 290a 2020 2020 2020  l_hooks().      
+000174b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000174c0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
+000174d0: 6861 726e 6573 732e 6368 6172 6d2e 6368  harness.charm.ch
+000174e0: 616e 6765 732c 0a20 2020 2020 2020 2020  anges,.         
+000174f0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00017500: 2020 2020 207b 276e 616d 6527 3a20 2769       {'name': 'i
+00017510: 6e73 7461 6c6c 277d 2c0a 2020 2020 2020  nstall'},.      
+00017520: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+00017530: 273a 2027 7265 6c61 7469 6f6e 2d63 7265  ': 'relation-cre
+00017540: 6174 6564 272c 0a20 2020 2020 2020 2020  ated',.         
+00017550: 2020 2020 2020 2020 2772 656c 6174 696f          'relatio
+00017560: 6e27 3a20 2764 6227 2c0a 2020 2020 2020  n': 'db',.      
+00017570: 2020 2020 2020 2020 2020 2027 6461 7461             'data
+00017580: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00017590: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+000175a0: 696f 6e5f 6964 273a 2072 656c 5f69 642c  ion_id': rel_id,
+000175b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000175c0: 2020 2020 2020 2775 6e69 7427 3a20 4e6f        'unit': No
+000175d0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+000175e0: 2020 2020 2020 2020 2027 6170 7027 3a20           'app': 
+000175f0: 2770 6f73 7467 7265 7371 6c27 2c0a 2020  'postgresql',.  
+00017600: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00017610: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00017620: 2020 207b 276e 616d 6527 3a20 276c 6561     {'name': 'lea
+00017630: 6465 722d 656c 6563 7465 6427 7d2c 0a20  der-elected'},. 
+00017640: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00017650: 276e 616d 6527 3a20 2763 6f6e 6669 672d  'name': 'config-
+00017660: 6368 616e 6765 6427 2c20 2764 6174 6127  changed', 'data'
+00017670: 3a20 7b7d 7d2c 0a20 2020 2020 2020 2020  : {}},.         
+00017680: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+00017690: 2773 7461 7274 277d 2c0a 2020 2020 2020  'start'},.      
+000176a0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+000176b0: 273a 2027 7265 6c61 7469 6f6e 2d6a 6f69  ': 'relation-joi
+000176c0: 6e65 6427 2c0a 2020 2020 2020 2020 2020  ned',.          
+000176d0: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+000176e0: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
+000176f0: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
+00017700: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00017710: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+00017720: 6f6e 5f69 6427 3a20 7265 6c5f 6964 2c0a  on_id': rel_id,.
+00017730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017740: 2020 2020 2027 756e 6974 273a 2027 706f       'unit': 'po
+00017750: 7374 6772 6573 716c 2f30 272c 0a20 2020  stgresql/0',.   
+00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017770: 2020 2761 7070 273a 2027 706f 7374 6772    'app': 'postgr
+00017780: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
+00017790: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
+000177a0: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+000177b0: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
+000177c0: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
+000177d0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+000177e0: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
+000177f0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+00017800: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
+00017810: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+00017820: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
+00017830: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00017840: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
+00017850: 2770 6f73 7467 7265 7371 6c2f 3027 2c0a  'postgresql/0',.
+00017860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017870: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
+00017880: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00017890: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
+000178a0: 2020 2020 2020 2020 2020 205d 290a 0a20             ]).. 
+000178b0: 2020 2064 6566 2074 6573 745f 6265 6769     def test_begi
+000178c0: 6e5f 7769 7468 5f69 6e69 7469 616c 5f68  n_with_initial_h
+000178d0: 6f6f 6b73 5f77 6974 685f 6170 706c 6963  ooks_with_applic
+000178e0: 6174 696f 6e5f 6461 7461 2873 656c 6629  ation_data(self)
+000178f0: 3a0a 2020 2020 2020 2020 636c 6173 7320  :.        class 
+00017900: 4368 6172 6d57 6974 6844 4228 5265 6c61  CharmWithDB(Rela
+00017910: 7469 6f6e 4576 656e 7443 6861 726d 293a  tionEventCharm):
+00017920: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
+00017930: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00017940: 6672 616d 6577 6f72 6b29 3a0a 2020 2020  framework):.    
+00017950: 2020 2020 2020 2020 2020 2020 7375 7065              supe
+00017960: 7228 292e 5f5f 696e 6974 5f5f 2866 7261  r().__init__(fra
+00017970: 6d65 776f 726b 290a 2020 2020 2020 2020  mework).        
+00017980: 2020 2020 2020 2020 7365 6c66 2e6f 6273          self.obs
+00017990: 6572 7665 5f72 656c 6174 696f 6e5f 6576  erve_relation_ev
+000179a0: 656e 7473 2827 6462 2729 0a20 2020 2020  ents('db').     
+000179b0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+000179c0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+000179d0: 2843 6861 726d 5769 7468 4442 2c20 6d65  (CharmWithDB, me
+000179e0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+000179f0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+00017a00: 700a 2020 2020 2020 2020 2020 2020 7265  p.            re
+00017a10: 7175 6972 6573 3a0a 2020 2020 2020 2020  quires:.        
+00017a20: 2020 2020 2020 6462 3a0a 2020 2020 2020        db:.      
+00017a30: 2020 2020 2020 2020 2020 696e 7465 7266            interf
+00017a40: 6163 653a 2073 716c 0a20 2020 2020 2020  ace: sql.       
+00017a50: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+00017a60: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+00017a70: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+00017a80: 7029 0a20 2020 2020 2020 2068 6172 6e65  p).        harne
+00017a90: 7373 2e73 6574 5f6c 6561 6465 7228 290a  ss.set_leader().
+00017aa0: 2020 2020 2020 2020 7265 6c5f 6964 203d          rel_id =
+00017ab0: 2068 6172 6e65 7373 2e61 6464 5f72 656c   harness.add_rel
+00017ac0: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
+00017ad0: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
+00017ae0: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
+00017af0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
+00017b00: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
+00017b10: 3027 290a 2020 2020 2020 2020 6861 726e  0').        harn
+00017b20: 6573 732e 7570 6461 7465 5f72 656c 6174  ess.update_relat
+00017b30: 696f 6e5f 6461 7461 2872 656c 5f69 642c  ion_data(rel_id,
+00017b40: 2027 706f 7374 6772 6573 716c 2f30 272c   'postgresql/0',
+00017b50: 207b 276e 6577 273a 2027 6461 7461 277d   {'new': 'data'}
+00017b60: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00017b70: 732e 7570 6461 7465 5f72 656c 6174 696f  s.update_relatio
+00017b80: 6e5f 6461 7461 2872 656c 5f69 642c 2027  n_data(rel_id, '
+00017b90: 706f 7374 6772 6573 716c 272c 207b 2761  postgresql', {'a
+00017ba0: 7070 273a 2027 6461 7461 277d 290a 2020  pp': 'data'}).  
+00017bb0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+00017bc0: 6769 6e5f 7769 7468 5f69 6e69 7469 616c  gin_with_initial
+00017bd0: 5f68 6f6f 6b73 2829 0a20 2020 2020 2020  _hooks().       
+00017be0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00017bf0: 6c28 0a20 2020 2020 2020 2020 2020 205b  l(.            [
+00017c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017c10: 207b 276e 616d 6527 3a20 2769 6e73 7461   {'name': 'insta
+00017c20: 6c6c 277d 2c0a 2020 2020 2020 2020 2020  ll'},.          
+00017c30: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+00017c40: 7265 6c61 7469 6f6e 2d63 7265 6174 6564  relation-created
+00017c50: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00017c60: 2020 2020 2772 656c 6174 696f 6e27 3a20      'relation': 
+00017c70: 2764 6227 2c0a 2020 2020 2020 2020 2020  'db',.          
+00017c80: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
+00017c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017ca0: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
+00017cb0: 6964 273a 2072 656c 5f69 642c 0a20 2020  id': rel_id,.   
+00017cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017cd0: 2020 2775 6e69 7427 3a20 4e6f 6e65 2c0a    'unit': None,.
+00017ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017cf0: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
+00017d00: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00017d10: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
+00017d20: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00017d30: 276e 616d 6527 3a20 276c 6561 6465 722d  'name': 'leader-
+00017d40: 656c 6563 7465 6427 7d2c 0a20 2020 2020  elected'},.     
+00017d50: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
+00017d60: 6527 3a20 2763 6f6e 6669 672d 6368 616e  e': 'config-chan
+00017d70: 6765 6427 2c20 2764 6174 6127 3a20 7b7d  ged', 'data': {}
+00017d80: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00017d90: 2020 207b 276e 616d 6527 3a20 2773 7461     {'name': 'sta
+00017da0: 7274 277d 2c0a 2020 2020 2020 2020 2020  rt'},.          
+00017db0: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
+00017dc0: 7265 6c61 7469 6f6e 2d63 6861 6e67 6564  relation-changed
+00017dd0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00017de0: 2020 2020 2772 656c 6174 696f 6e27 3a20      'relation': 
+00017df0: 2764 6227 2c0a 2020 2020 2020 2020 2020  'db',.          
+00017e00: 2020 2020 2020 2027 6461 7461 273a 207b         'data': {
+00017e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017e20: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
+00017e30: 6964 273a 2072 656c 5f69 642c 0a20 2020  id': rel_id,.   
+00017e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e50: 2020 2775 6e69 7427 3a20 4e6f 6e65 2c0a    'unit': None,.
+00017e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e70: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
+00017e80: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00017e90: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
+00017ea0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00017eb0: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
+00017ec0: 6e2d 6a6f 696e 6564 272c 0a20 2020 2020  n-joined',.     
+00017ed0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+00017ee0: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
+00017ef0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00017f00: 6461 7461 273a 207b 0a20 2020 2020 2020  data': {.       
+00017f10: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00017f20: 656c 6174 696f 6e5f 6964 273a 2072 656c  elation_id': rel
+00017f30: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00017f40: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
+00017f50: 3a20 2770 6f73 7467 7265 7371 6c2f 3027  : 'postgresql/0'
+00017f60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017f70: 2020 2020 2020 2027 6170 7027 3a20 2770         'app': 'p
+00017f80: 6f73 7467 7265 7371 6c27 2c0a 2020 2020  ostgresql',.    
+00017f90: 2020 2020 2020 2020 2020 2020 207d 7d2c               }},
+00017fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017fb0: 207b 276e 616d 6527 3a20 2772 656c 6174   {'name': 'relat
+00017fc0: 696f 6e2d 6368 616e 6765 6427 2c0a 2020  ion-changed',.  
+00017fd0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00017fe0: 7265 6c61 7469 6f6e 273a 2027 6462 272c  relation': 'db',
+00017ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018000: 2020 2764 6174 6127 3a20 7b0a 2020 2020    'data': {.    
+00018010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018020: 2027 7265 6c61 7469 6f6e 5f69 6427 3a20   'relation_id': 
+00018030: 7265 6c5f 6964 2c0a 2020 2020 2020 2020  rel_id,.        
+00018040: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+00018050: 6974 273a 2027 706f 7374 6772 6573 716c  it': 'postgresql
+00018060: 2f30 272c 0a20 2020 2020 2020 2020 2020  /0',.           
+00018070: 2020 2020 2020 2020 2020 2761 7070 273a            'app':
+00018080: 2027 706f 7374 6772 6573 716c 272c 0a20   'postgresql',. 
+00018090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180a0: 7d7d 2c0a 2020 2020 2020 2020 2020 2020  }},.            
+000180b0: 5d2c 0a20 2020 2020 2020 2020 2020 2068  ],.            h
+000180c0: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
+000180d0: 6e67 6573 290a 0a20 2020 2064 6566 2074  nges)..    def t
+000180e0: 6573 745f 6265 6769 6e5f 7769 7468 5f69  est_begin_with_i
+000180f0: 6e69 7469 616c 5f68 6f6f 6b73 5f77 6974  nitial_hooks_wit
+00018100: 685f 6d75 6c74 6970 6c65 5f75 6e69 7473  h_multiple_units
+00018110: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00018120: 636c 6173 7320 4368 6172 6d57 6974 6844  class CharmWithD
+00018130: 4228 5265 6c61 7469 6f6e 4576 656e 7443  B(RelationEventC
+00018140: 6861 726d 293a 0a20 2020 2020 2020 2020  harm):.         
+00018150: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00018160: 7365 6c66 2c20 6672 616d 6577 6f72 6b29  self, framework)
+00018170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018180: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00018190: 5f5f 2866 7261 6d65 776f 726b 290a 2020  __(framework).  
+000181a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000181b0: 6c66 2e6f 6273 6572 7665 5f72 656c 6174  lf.observe_relat
+000181c0: 696f 6e5f 6576 656e 7473 2827 6462 2729  ion_events('db')
+000181d0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+000181e0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+000181f0: 6172 6e65 7373 2843 6861 726d 5769 7468  arness(CharmWith
+00018200: 4442 2c20 6d65 7461 3d27 2727 0a20 2020  DB, meta='''.   
+00018210: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
+00018220: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
+00018230: 2020 2020 7265 7175 6972 6573 3a0a 2020      requires:.  
+00018240: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+00018250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018260: 696e 7465 7266 6163 653a 2073 716c 0a20  interface: sql. 
+00018270: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00018280: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00018290: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+000182a0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+000182b0: 2068 6172 6e65 7373 2e73 6574 5f6c 6561   harness.set_lea
+000182c0: 6465 7228 290a 2020 2020 2020 2020 7265  der().        re
+000182d0: 6c5f 6964 203d 2068 6172 6e65 7373 2e61  l_id = harness.a
+000182e0: 6464 5f72 656c 6174 696f 6e28 2764 6227  dd_relation('db'
+000182f0: 2c20 2770 6f73 7467 7265 7371 6c27 290a  , 'postgresql').
+00018300: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00018310: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00018320: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+00018330: 7265 7371 6c2f 3127 290a 2020 2020 2020  resql/1').      
+00018340: 2020 6861 726e 6573 732e 7570 6461 7465    harness.update
+00018350: 5f72 656c 6174 696f 6e5f 6461 7461 2872  _relation_data(r
+00018360: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
+00018370: 716c 2f31 272c 207b 276e 6577 273a 2027  ql/1', {'new': '
+00018380: 6461 7461 277d 290a 2020 2020 2020 2020  data'}).        
+00018390: 2320 5765 2069 6e74 656e 7469 6f6e 616c  # We intentional
+000183a0: 6c79 2061 6464 2030 2061 6674 6572 2031  ly add 0 after 1
+000183b0: 2074 6f20 6173 7365 7274 2074 6861 7420   to assert that 
+000183c0: 7468 6520 636f 6465 2074 7269 6767 6572  the code trigger
+000183d0: 7320 7468 656d 2069 6e20 6f72 6465 720a  s them in order.
+000183e0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+000183f0: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00018400: 7428 7265 6c5f 6964 2c20 2770 6f73 7467  t(rel_id, 'postg
+00018410: 7265 7371 6c2f 3027 290a 2020 2020 2020  resql/0').      
+00018420: 2020 6861 726e 6573 732e 6265 6769 6e5f    harness.begin_
+00018430: 7769 7468 5f69 6e69 7469 616c 5f68 6f6f  with_initial_hoo
+00018440: 6b73 2829 0a20 2020 2020 2020 2073 656c  ks().        sel
+00018450: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+00018460: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+00018470: 7373 2e63 6861 726d 2e63 6861 6e67 6573  ss.charm.changes
+00018480: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
+00018490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184a0: 7b27 6e61 6d65 273a 2027 696e 7374 616c  {'name': 'instal
+000184b0: 6c27 7d2c 0a20 2020 2020 2020 2020 2020  l'},.           
+000184c0: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+000184d0: 656c 6174 696f 6e2d 6372 6561 7465 6427  elation-created'
+000184e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000184f0: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
+00018500: 6462 272c 0a20 2020 2020 2020 2020 2020  db',.           
+00018510: 2020 2020 2020 2764 6174 6127 3a20 7b0a        'data': {.
+00018520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018530: 2020 2020 2027 7265 6c61 7469 6f6e 5f69       'relation_i
+00018540: 6427 3a20 7265 6c5f 6964 2c0a 2020 2020  d': rel_id,.    
+00018550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018560: 2027 756e 6974 273a 204e 6f6e 652c 0a20   'unit': None,. 
 00018570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018580: 2020 2027 756e 6974 273a 2027 706f 7374     'unit': 'post
-00018590: 6772 6573 716c 2f31 272c 0a20 2020 2020  gresql/1',.     
-000185a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185b0: 2761 7070 273a 2027 706f 7374 6772 6573  'app': 'postgres
-000185c0: 716c 272c 0a20 2020 2020 2020 2020 2020  ql',.           
-000185d0: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
-000185e0: 2020 2020 2020 5d29 0a0a 2020 2020 6465        ])..    de
-000185f0: 6620 7465 7374 5f62 6567 696e 5f77 6974  f test_begin_wit
-00018600: 685f 696e 6974 6961 6c5f 686f 6f6b 735f  h_initial_hooks_
-00018610: 6d75 6c74 6970 6c65 5f72 656c 6174 696f  multiple_relatio
-00018620: 6e5f 7361 6d65 5f65 6e64 706f 696e 7428  n_same_endpoint(
-00018630: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
-00018640: 6c61 7373 2043 6861 726d 5769 7468 4442  lass CharmWithDB
-00018650: 2852 656c 6174 696f 6e45 7665 6e74 4368  (RelationEventCh
-00018660: 6172 6d29 3a0a 2020 2020 2020 2020 2020  arm):.          
-00018670: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00018680: 656c 662c 2066 7261 6d65 776f 726b 293a  elf, framework):
-00018690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000186a0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-000186b0: 5f28 6672 616d 6577 6f72 6b29 0a20 2020  _(framework).   
-000186c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000186d0: 662e 6f62 7365 7276 655f 7265 6c61 7469  f.observe_relati
-000186e0: 6f6e 5f65 7665 6e74 7328 2764 6227 290a  on_events('db').
-000186f0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00018700: 3d20 4861 726e 6573 7328 4368 6172 6d57  = Harness(CharmW
-00018710: 6974 6844 422c 206d 6574 613d 2727 270a  ithDB, meta='''.
-00018720: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00018730: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-00018740: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
-00018750: 0a20 2020 2020 2020 2020 2020 2020 2064  .              d
-00018760: 623a 0a20 2020 2020 2020 2020 2020 2020  b:.             
-00018770: 2020 2069 6e74 6572 6661 6365 3a20 7371     interface: sq
-00018780: 6c0a 2020 2020 2020 2020 2020 2020 2727  l.            ''
-00018790: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000187a0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-000187b0: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
-000187c0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
-000187d0: 6c65 6164 6572 2829 0a20 2020 2020 2020  leader().       
-000187e0: 2072 656c 5f69 645f 6120 3d20 6861 726e   rel_id_a = harn
-000187f0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00018800: 2827 6462 272c 2027 7067 2d61 2729 0a20  ('db', 'pg-a'). 
-00018810: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
-00018820: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
-00018830: 2872 656c 5f69 645f 612c 2027 7067 2d61  (rel_id_a, 'pg-a
-00018840: 2f30 2729 0a20 2020 2020 2020 2072 656c  /0').        rel
-00018850: 5f69 645f 6220 3d20 6861 726e 6573 732e  _id_b = harness.
-00018860: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
-00018870: 272c 2027 7067 2d62 2729 0a20 2020 2020  ', 'pg-b').     
-00018880: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-00018890: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-000188a0: 5f69 645f 622c 2027 7067 2d62 2f30 2729  _id_b, 'pg-b/0')
-000188b0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-000188c0: 2e62 6567 696e 5f77 6974 685f 696e 6974  .begin_with_init
-000188d0: 6961 6c5f 686f 6f6b 7328 290a 2020 2020  ial_hooks().    
-000188e0: 2020 2020 6368 616e 6765 7320 3d20 6861      changes = ha
-000188f0: 726e 6573 732e 6368 6172 6d2e 6368 616e  rness.charm.chan
-00018900: 6765 735b 3a5d 0a20 2020 2020 2020 2065  ges[:].        e
-00018910: 7870 6563 7465 645f 7072 6566 6978 203d  xpected_prefix =
-00018920: 205b 0a20 2020 2020 2020 2020 2020 207b   [.            {
-00018930: 276e 616d 6527 3a20 2769 6e73 7461 6c6c  'name': 'install
-00018940: 277d 2c0a 2020 2020 2020 2020 5d0a 2020  '},.        ].  
-00018950: 2020 2020 2020 2320 5468 6520 6669 7273        # The firs
-00018960: 7420 6576 656e 7473 2061 7265 2061 6c77  t events are alw
-00018970: 6179 7320 7468 6520 7361 6d65 0a20 2020  ays the same.   
-00018980: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00018990: 4571 7561 6c28 6368 616e 6765 735b 3a6c  Equal(changes[:l
-000189a0: 656e 2865 7870 6563 7465 645f 7072 6566  en(expected_pref
-000189b0: 6978 295d 2c20 6578 7065 6374 6564 5f70  ix)], expected_p
-000189c0: 7265 6669 7829 0a20 2020 2020 2020 2063  refix).        c
-000189d0: 6861 6e67 6573 203d 2063 6861 6e67 6573  hanges = changes
-000189e0: 5b6c 656e 2865 7870 6563 7465 645f 7072  [len(expected_pr
-000189f0: 6566 6978 293a 5d0a 2020 2020 2020 2020  efix):].        
-00018a00: 2320 486f 7765 7665 722c 2074 6865 206f  # However, the o
-00018a10: 7264 6572 206f 6620 7265 6c61 7469 6f6e  rder of relation
-00018a20: 2d63 7265 6174 6564 2065 7665 6e74 7320  -created events 
-00018a30: 6361 6e20 6265 2069 6e20 616e 7920 6f72  can be in any or
-00018a40: 6465 720a 2020 2020 2020 2020 6578 7065  der.        expe
-00018a50: 6374 6564 5f72 656c 6174 696f 6e5f 6372  cted_relation_cr
-00018a60: 6561 7465 6420 3d20 5b0a 2020 2020 2020  eated = [.      
-00018a70: 2020 2020 2020 7b27 6e61 6d65 273a 2027        {'name': '
-00018a80: 7265 6c61 7469 6f6e 2d63 7265 6174 6564  relation-created
-00018a90: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00018aa0: 2772 656c 6174 696f 6e27 3a20 2764 6227  'relation': 'db'
-00018ab0: 2c0a 2020 2020 2020 2020 2020 2020 2027  ,.             '
-00018ac0: 6461 7461 273a 207b 0a20 2020 2020 2020  data': {.       
-00018ad0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
-00018ae0: 696f 6e5f 6964 273a 2072 656c 5f69 645f  ion_id': rel_id_
-00018af0: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
-00018b00: 2020 2020 2775 6e69 7427 3a20 4e6f 6e65      'unit': None
-00018b10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018b20: 2020 2027 6170 7027 3a20 2770 672d 6127     'app': 'pg-a'
-00018b30: 2c0a 2020 2020 2020 2020 2020 2020 207d  ,.             }
-00018b40: 7d2c 0a20 2020 2020 2020 2020 2020 207b  },.            {
-00018b50: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
-00018b60: 6e2d 6372 6561 7465 6427 2c0a 2020 2020  n-created',.    
-00018b70: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
-00018b80: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
-00018b90: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
-00018ba0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00018bb0: 2020 2027 7265 6c61 7469 6f6e 5f69 6427     'relation_id'
-00018bc0: 3a20 7265 6c5f 6964 5f62 2c0a 2020 2020  : rel_id_b,.    
-00018bd0: 2020 2020 2020 2020 2020 2020 2027 756e               'un
-00018be0: 6974 273a 204e 6f6e 652c 0a20 2020 2020  it': None,.     
-00018bf0: 2020 2020 2020 2020 2020 2020 2761 7070              'app
-00018c00: 273a 2027 7067 2d62 272c 0a20 2020 2020  ': 'pg-b',.     
-00018c10: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
-00018c20: 2020 2020 5d0a 2020 2020 2020 2020 6966      ].        if
-00018c30: 2063 6861 6e67 6573 5b3a 325d 2021 3d20   changes[:2] != 
-00018c40: 6578 7065 6374 6564 5f72 656c 6174 696f  expected_relatio
-00018c50: 6e5f 6372 6561 7465 643a 0a20 2020 2020  n_created:.     
-00018c60: 2020 2020 2020 2023 2063 6861 6e67 6520         # change 
-00018c70: 7468 6520 6f72 6465 720a 2020 2020 2020  the order.      
-00018c80: 2020 2020 2020 6578 7065 6374 6564 5f72        expected_r
-00018c90: 656c 6174 696f 6e5f 6372 6561 7465 6420  elation_created 
-00018ca0: 3d20 5b65 7870 6563 7465 645f 7265 6c61  = [expected_rela
-00018cb0: 7469 6f6e 5f63 7265 6174 6564 5b31 5d2c  tion_created[1],
-00018cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ce0: 2020 2020 2020 2020 2020 6578 7065 6374            expect
-00018cf0: 6564 5f72 656c 6174 696f 6e5f 6372 6561  ed_relation_crea
-00018d00: 7465 645b 305d 5d0a 2020 2020 2020 2020  ted[0]].        
-00018d10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018d20: 2863 6861 6e67 6573 5b3a 325d 2c20 6578  (changes[:2], ex
-00018d30: 7065 6374 6564 5f72 656c 6174 696f 6e5f  pected_relation_
-00018d40: 6372 6561 7465 6429 0a20 2020 2020 2020  created).       
-00018d50: 2063 6861 6e67 6573 203d 2063 6861 6e67   changes = chang
-00018d60: 6573 5b32 3a5d 0a20 2020 2020 2020 2065  es[2:].        e
-00018d70: 7870 6563 7465 645f 6d69 6464 6c65 203d  xpected_middle =
-00018d80: 205b 0a20 2020 2020 2020 2020 2020 207b   [.            {
-00018d90: 276e 616d 6527 3a20 276c 6561 6465 722d  'name': 'leader-
-00018da0: 656c 6563 7465 6427 7d2c 0a20 2020 2020  elected'},.     
-00018db0: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
-00018dc0: 2763 6f6e 6669 672d 6368 616e 6765 6427  'config-changed'
-00018dd0: 2c20 2764 6174 6127 3a20 7b7d 7d2c 0a20  , 'data': {}},. 
-00018de0: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-00018df0: 6527 3a20 2773 7461 7274 277d 2c0a 2020  e': 'start'},.  
-00018e00: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00018e10: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00018e20: 2863 6861 6e67 6573 5b3a 6c65 6e28 6578  (changes[:len(ex
-00018e30: 7065 6374 6564 5f6d 6964 646c 6529 5d2c  pected_middle)],
-00018e40: 2065 7870 6563 7465 645f 6d69 6464 6c65   expected_middle
-00018e50: 290a 2020 2020 2020 2020 6368 616e 6765  ).        change
-00018e60: 7320 3d20 6368 616e 6765 735b 6c65 6e28  s = changes[len(
-00018e70: 6578 7065 6374 6564 5f6d 6964 646c 6529  expected_middle)
-00018e80: 3a5d 0a20 2020 2020 2020 2061 5f66 6972  :].        a_fir
-00018e90: 7374 203d 205b 0a20 2020 2020 2020 2020  st = [.         
-00018ea0: 2020 207b 276e 616d 6527 3a20 2772 656c     {'name': 'rel
-00018eb0: 6174 696f 6e2d 6a6f 696e 6564 272c 0a20  ation-joined',. 
-00018ec0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-00018ed0: 6174 696f 6e27 3a20 2764 6227 2c0a 2020  ation': 'db',.  
-00018ee0: 2020 2020 2020 2020 2020 2027 6461 7461             'data
-00018ef0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00018f00: 2020 2020 2020 2772 656c 6174 696f 6e5f        'relation_
-00018f10: 6964 273a 2072 656c 5f69 645f 612c 0a20  id': rel_id_a,. 
-00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f30: 2775 6e69 7427 3a20 2770 672d 612f 3027  'unit': 'pg-a/0'
-00018f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018f50: 2020 2027 6170 7027 3a20 2770 672d 6127     'app': 'pg-a'
-00018f60: 2c0a 2020 2020 2020 2020 2020 2020 207d  ,.             }
-00018f70: 7d2c 0a20 2020 2020 2020 2020 2020 207b  },.            {
-00018f80: 276e 616d 6527 3a20 2772 656c 6174 696f  'name': 'relatio
-00018f90: 6e2d 6368 616e 6765 6427 2c0a 2020 2020  n-changed',.    
-00018fa0: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
-00018fb0: 6f6e 273a 2027 6462 272c 0a20 2020 2020  on': 'db',.     
-00018fc0: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
-00018fd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00018fe0: 2020 2027 7265 6c61 7469 6f6e 5f69 6427     'relation_id'
-00018ff0: 3a20 7265 6c5f 6964 5f61 2c0a 2020 2020  : rel_id_a,.    
-00019000: 2020 2020 2020 2020 2020 2020 2027 756e               'un
-00019010: 6974 273a 2027 7067 2d61 2f30 272c 0a20  it': 'pg-a/0',. 
-00019020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019030: 2761 7070 273a 2027 7067 2d61 272c 0a20  'app': 'pg-a',. 
-00019040: 2020 2020 2020 2020 2020 2020 7d7d 2c0a              }},.
-00019050: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
-00019060: 6d65 273a 2027 7265 6c61 7469 6f6e 2d6a  me': 'relation-j
-00019070: 6f69 6e65 6427 2c0a 2020 2020 2020 2020  oined',.        
-00019080: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
-00019090: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
-000190a0: 2020 2020 2764 6174 6127 3a20 7b0a 2020      'data': {.  
-000190b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000190c0: 7265 6c61 7469 6f6e 5f69 6427 3a20 7265  relation_id': re
-000190d0: 6c5f 6964 5f62 2c0a 2020 2020 2020 2020  l_id_b,.        
-000190e0: 2020 2020 2020 2020 2027 756e 6974 273a           'unit':
-000190f0: 2027 7067 2d62 2f30 272c 0a20 2020 2020   'pg-b/0',.     
-00019100: 2020 2020 2020 2020 2020 2020 2761 7070              'app
-00019110: 273a 2027 7067 2d62 272c 0a20 2020 2020  ': 'pg-b',.     
-00019120: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
-00019130: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
-00019140: 2027 7265 6c61 7469 6f6e 2d63 6861 6e67   'relation-chang
-00019150: 6564 272c 0a20 2020 2020 2020 2020 2020  ed',.           
-00019160: 2020 2772 656c 6174 696f 6e27 3a20 2764    'relation': 'd
-00019170: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00019180: 2027 6461 7461 273a 207b 0a20 2020 2020   'data': {.     
-00019190: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
-000191a0: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
-000191b0: 645f 622c 0a20 2020 2020 2020 2020 2020  d_b,.           
-000191c0: 2020 2020 2020 2775 6e69 7427 3a20 2770        'unit': 'p
-000191d0: 672d 622f 3027 2c0a 2020 2020 2020 2020  g-b/0',.        
-000191e0: 2020 2020 2020 2020 2027 6170 7027 3a20           'app': 
-000191f0: 2770 672d 6227 2c0a 2020 2020 2020 2020  'pg-b',.        
-00019200: 2020 2020 207d 7d2c 0a20 2020 2020 2020       }},.       
-00019210: 205d 0a20 2020 2020 2020 2069 6620 6368   ].        if ch
-00019220: 616e 6765 7320 213d 2061 5f66 6972 7374  anges != a_first
-00019230: 3a0a 2020 2020 2020 2020 2020 2020 625f  :.            b_
-00019240: 6669 7273 7420 3d20 5b61 5f66 6972 7374  first = [a_first
-00019250: 5b32 5d2c 2061 5f66 6972 7374 5b33 5d2c  [2], a_first[3],
-00019260: 2061 5f66 6972 7374 5b30 5d2c 2061 5f66   a_first[0], a_f
-00019270: 6972 7374 5b31 5d5d 0a20 2020 2020 2020  irst[1]].       
-00019280: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00019290: 4571 7561 6c28 6368 616e 6765 732c 2062  Equal(changes, b
-000192a0: 5f66 6972 7374 290a 0a20 2020 2064 6566  _first)..    def
-000192b0: 2074 6573 745f 6265 6769 6e5f 7769 7468   test_begin_with
-000192c0: 5f69 6e69 7469 616c 5f68 6f6f 6b73 5f75  _initial_hooks_u
-000192d0: 6e6b 6e6f 776e 5f73 7461 7475 7328 7365  nknown_status(se
-000192e0: 6c66 293a 0a20 2020 2020 2020 2023 2056  lf):.        # V
-000192f0: 6572 6966 7920 7468 6174 2061 2063 6861  erify that a cha
-00019300: 726d 2074 6861 7420 646f 6573 206e 6f74  rm that does not
-00019310: 2073 6574 2061 2073 7461 7475 7320 696e   set a status in
-00019320: 2074 6865 2069 6e73 7461 6c6c 2068 6f6f   the install hoo
-00019330: 6b20 7769 6c6c 2068 6176 6520 616e 0a20  k will have an. 
-00019340: 2020 2020 2020 2023 2075 6e6b 6e6f 776e         # unknown
-00019350: 2073 7461 7475 7320 696e 2074 6865 2068   status in the h
-00019360: 6172 6e65 7373 2e0a 2020 2020 2020 2020  arness..        
-00019370: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-00019380: 7328 5265 636f 7264 696e 6743 6861 726d  s(RecordingCharm
-00019390: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
-000193a0: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
-000193b0: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
-000193c0: 2020 2727 272c 2063 6f6e 6669 673d 2727    ''', config=''
-000193d0: 270a 2020 2020 2020 2020 2020 6f70 7469  '.          opti
-000193e0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-000193f0: 2020 2020 2066 6f6f 3a0a 2020 2020 2020       foo:.      
-00019400: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00019410: 7363 7269 7074 696f 6e3a 2061 2063 6f6e  scription: a con
-00019420: 6669 6720 6f70 7469 6f6e 0a20 2020 2020  fig option.     
-00019430: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00019440: 7970 653a 2073 7472 696e 670a 2020 2020  ype: string.    
-00019450: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00019460: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00019470: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00019480: 616e 7570 290a 2020 2020 2020 2020 6261  anup).        ba
-00019490: 636b 656e 6420 3d20 6861 726e 6573 732e  ckend = harness.
-000194a0: 5f62 6163 6b65 6e64 0a20 2020 2020 2020  _backend.       
-000194b0: 2068 6172 6e65 7373 2e62 6567 696e 5f77   harness.begin_w
-000194c0: 6974 685f 696e 6974 6961 6c5f 686f 6f6b  ith_initial_hook
-000194d0: 7328 290a 0a20 2020 2020 2020 2073 656c  s()..        sel
-000194e0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-000194f0: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-00019500: 6e64 2e73 7461 7475 735f 6765 7428 6973  nd.status_get(is
-00019510: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
-00019520: 2020 2020 2020 2020 207b 2773 7461 7475           {'statu
-00019530: 7327 3a20 2775 6e6b 6e6f 776e 272c 2027  s': 'unknown', '
-00019540: 6d65 7373 6167 6527 3a20 2727 7d29 0a0a  message': ''})..
-00019550: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00019560: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-00019570: 2020 2020 2020 6261 636b 656e 642e 7374        backend.st
-00019580: 6174 7573 5f67 6574 2869 735f 6170 703d  atus_get(is_app=
-00019590: 5472 7565 292c 0a20 2020 2020 2020 2020  True),.         
-000195a0: 2020 207b 2773 7461 7475 7327 3a20 2775     {'status': 'u
-000195b0: 6e6b 6e6f 776e 272c 2027 6d65 7373 6167  nknown', 'messag
-000195c0: 6527 3a20 2727 7d29 0a0a 2020 2020 6465  e': ''})..    de
-000195d0: 6620 7465 7374 5f62 6567 696e 5f77 6974  f test_begin_wit
-000195e0: 685f 696e 6974 6961 6c5f 686f 6f6b 735f  h_initial_hooks_
-000195f0: 696e 7374 616c 6c5f 7365 7473 5f73 7461  install_sets_sta
-00019600: 7475 7328 7365 6c66 293a 0a20 2020 2020  tus(self):.     
-00019610: 2020 2068 6172 6e65 7373 203d 2048 6172     harness = Har
-00019620: 6e65 7373 2852 6563 6f72 6469 6e67 4368  ness(RecordingCh
-00019630: 6172 6d2c 206d 6574 613d 2727 270a 2020  arm, meta='''.  
-00019640: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00019650: 7465 7374 2d61 7070 0a20 2020 2020 2020  test-app.       
-00019660: 2020 2020 2027 2727 2c20 636f 6e66 6967       ''', config
-00019670: 3d27 2727 0a20 2020 2020 2020 2020 2020  ='''.           
-00019680: 206f 7074 696f 6e73 3a0a 2020 2020 2020   options:.      
-00019690: 2020 2020 2020 2020 2020 7365 745f 7374            set_st
-000196a0: 6174 7573 3a0a 2020 2020 2020 2020 2020  atus:.          
-000196b0: 2020 2020 2020 2020 2020 6465 7363 7269            descri
-000196c0: 7074 696f 6e3a 2061 2063 6f6e 6669 6720  ption: a config 
-000196d0: 6f70 7469 6f6e 0a20 2020 2020 2020 2020  option.         
-000196e0: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-000196f0: 2062 6f6f 6c65 616e 0a0a 2020 2020 2020   boolean..      
-00019700: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00019710: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-00019720: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-00019730: 7570 290a 2020 2020 2020 2020 6261 636b  up).        back
-00019740: 656e 6420 3d20 6861 726e 6573 732e 5f62  end = harness._b
-00019750: 6163 6b65 6e64 0a20 2020 2020 2020 2068  ackend.        h
-00019760: 6172 6e65 7373 2e75 7064 6174 655f 636f  arness.update_co
-00019770: 6e66 6967 286b 6579 5f76 616c 7565 733d  nfig(key_values=
-00019780: 7b22 7365 745f 7374 6174 7573 223a 2054  {"set_status": T
-00019790: 7275 657d 290a 2020 2020 2020 2020 6861  rue}).        ha
-000197a0: 726e 6573 732e 6265 6769 6e5f 7769 7468  rness.begin_with
-000197b0: 5f69 6e69 7469 616c 5f68 6f6f 6b73 2829  _initial_hooks()
-000197c0: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-000197d0: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-000197e0: 2020 2020 2020 2020 6261 636b 656e 642e          backend.
-000197f0: 7374 6174 7573 5f67 6574 2869 735f 6170  status_get(is_ap
-00019800: 703d 4661 6c73 6529 2c0a 2020 2020 2020  p=False),.      
-00019810: 2020 2020 2020 7b27 7374 6174 7573 273a        {'status':
-00019820: 2027 6d61 696e 7465 6e61 6e63 6527 2c20   'maintenance', 
-00019830: 276d 6573 7361 6765 273a 2027 5374 6174  'message': 'Stat
-00019840: 7573 2073 6574 206f 6e20 696e 7374 616c  us set on instal
-00019850: 6c27 7d29 0a0a 2020 2020 6465 6620 7465  l'})..    def te
-00019860: 7374 5f67 6574 5f70 6562 626c 655f 636f  st_get_pebble_co
-00019870: 6e74 6169 6e65 725f 706c 616e 2873 656c  ntainer_plan(sel
-00019880: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00019890: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-000198a0: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-000198b0: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-000198c0: 6d65 3a20 7465 7374 2d61 7070 0a20 2020  me: test-app.   
-000198d0: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
-000198e0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-000198f0: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
-00019900: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-00019910: 3a20 666f 6f2d 696d 6167 650a 2020 2020  : foo-image.    
-00019920: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-00019930: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-00019940: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-00019950: 616e 7570 290a 2020 2020 2020 2020 6861  anup).        ha
-00019960: 726e 6573 732e 6265 6769 6e28 290a 2020  rness.begin().  
-00019970: 2020 2020 2020 6861 726e 6573 732e 7365        harness.se
-00019980: 745f 6361 6e5f 636f 6e6e 6563 7428 2766  t_can_connect('f
-00019990: 6f6f 272c 2054 7275 6529 0a20 2020 2020  oo', True).     
-000199a0: 2020 2069 6e69 7469 616c 5f70 6c61 6e20     initial_plan 
-000199b0: 3d20 6861 726e 6573 732e 6765 745f 636f  = harness.get_co
-000199c0: 6e74 6169 6e65 725f 7065 6262 6c65 5f70  ntainer_pebble_p
-000199d0: 6c61 6e28 2766 6f6f 2729 0a20 2020 2020  lan('foo').     
-000199e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000199f0: 7561 6c28 696e 6974 6961 6c5f 706c 616e  ual(initial_plan
-00019a00: 2e74 6f5f 7961 6d6c 2829 2c20 277b 7d5c  .to_yaml(), '{}\
-00019a10: 6e27 290a 2020 2020 2020 2020 636f 6e74  n').        cont
-00019a20: 6169 6e65 7220 3d20 6861 726e 6573 732e  ainer = harness.
-00019a30: 6d6f 6465 6c2e 756e 6974 2e67 6574 5f63  model.unit.get_c
-00019a40: 6f6e 7461 696e 6572 2827 666f 6f27 290a  ontainer('foo').
-00019a50: 2020 2020 2020 2020 636f 6e74 6169 6e65          containe
-00019a60: 722e 7065 6262 6c65 2e61 6464 5f6c 6179  r.pebble.add_lay
-00019a70: 6572 2827 7465 7374 2d61 6227 2c20 2727  er('test-ab', ''
-00019a80: 275c 0a20 2020 2020 2020 2020 2020 2073  '\.            s
-00019a90: 756d 6d61 7279 3a20 7465 7374 2d6c 6179  ummary: test-lay
-00019aa0: 6572 0a20 2020 2020 2020 2020 2020 2064  er.            d
-00019ab0: 6573 6372 6970 7469 6f6e 3a20 6120 6c61  escription: a la
-00019ac0: 7965 7220 7468 6174 2077 6520 6361 6e20  yer that we can 
-00019ad0: 7573 6520 666f 7220 7465 7374 696e 670a  use for testing.
-00019ae0: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-00019af0: 6963 6573 3a0a 2020 2020 2020 2020 2020  ices:.          
-00019b00: 2020 2020 613a 0a20 2020 2020 2020 2020      a:.         
-00019b10: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
-00019b20: 2f62 696e 2f65 6368 6f20 6865 6c6c 6f20  /bin/echo hello 
-00019b30: 6672 6f6d 2061 0a20 2020 2020 2020 2020  from a.         
-00019b40: 2020 2020 2062 3a0a 2020 2020 2020 2020       b:.        
-00019b50: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-00019b60: 202f 6269 6e2f 6563 686f 2068 656c 6c6f   /bin/echo hello
-00019b70: 2066 726f 6d20 620a 2020 2020 2020 2020   from b.        
-00019b80: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00019b90: 2063 6f6e 7461 696e 6572 2e70 6562 626c   container.pebbl
-00019ba0: 652e 6164 645f 6c61 7965 7228 2774 6573  e.add_layer('tes
-00019bb0: 742d 6327 2c20 2727 275c 0a20 2020 2020  t-c', '''\.     
-00019bc0: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
-00019bd0: 7465 7374 2d66 6f72 2d63 0a20 2020 2020  test-for-c.     
-00019be0: 2020 2020 2020 2073 6572 7669 6365 733a         services:
-00019bf0: 0a20 2020 2020 2020 2020 2020 2020 2063  .              c
-00019c00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019c10: 2020 636f 6d6d 616e 643a 202f 6269 6e2f    command: /bin/
-00019c20: 6563 686f 2068 656c 6c6f 2066 726f 6d20  echo hello from 
-00019c30: 630a 2020 2020 2020 2020 2020 2020 2727  c.            ''
-00019c40: 2729 0a20 2020 2020 2020 2070 6c61 6e20  ').        plan 
-00019c50: 3d20 636f 6e74 6169 6e65 722e 7065 6262  = container.pebb
-00019c60: 6c65 2e67 6574 5f70 6c61 6e28 290a 2020  le.get_plan().  
-00019c70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00019c80: 7445 7175 616c 2870 6c61 6e2e 746f 5f79  tEqual(plan.to_y
-00019c90: 616d 6c28 292c 2074 6578 7477 7261 702e  aml(), textwrap.
-00019ca0: 6465 6465 6e74 2827 2727 5c0a 2020 2020  dedent('''\.    
-00019cb0: 2020 2020 2020 2020 7365 7276 6963 6573          services
-00019cc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019cd0: 613a 0a20 2020 2020 2020 2020 2020 2020  a:.             
-00019ce0: 2020 2063 6f6d 6d61 6e64 3a20 2f62 696e     command: /bin
-00019cf0: 2f65 6368 6f20 6865 6c6c 6f20 6672 6f6d  /echo hello from
-00019d00: 2061 0a20 2020 2020 2020 2020 2020 2020   a.             
-00019d10: 2062 3a0a 2020 2020 2020 2020 2020 2020   b:.            
-00019d20: 2020 2020 636f 6d6d 616e 643a 202f 6269      command: /bi
-00019d30: 6e2f 6563 686f 2068 656c 6c6f 2066 726f  n/echo hello fro
-00019d40: 6d20 620a 2020 2020 2020 2020 2020 2020  m b.            
-00019d50: 2020 633a 0a20 2020 2020 2020 2020 2020    c:.           
-00019d60: 2020 2020 2063 6f6d 6d61 6e64 3a20 2f62       command: /b
-00019d70: 696e 2f65 6368 6f20 6865 6c6c 6f20 6672  in/echo hello fr
-00019d80: 6f6d 2063 0a20 2020 2020 2020 2020 2020  om c.           
-00019d90: 2027 2727 2929 0a20 2020 2020 2020 2068   ''')).        h
-00019da0: 6172 6e65 7373 5f70 6c61 6e20 3d20 6861  arness_plan = ha
-00019db0: 726e 6573 732e 6765 745f 636f 6e74 6169  rness.get_contai
-00019dc0: 6e65 725f 7065 6262 6c65 5f70 6c61 6e28  ner_pebble_plan(
-00019dd0: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
-00019de0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00019df0: 6861 726e 6573 735f 706c 616e 2e74 6f5f  harness_plan.to_
-00019e00: 7961 6d6c 2829 2c20 706c 616e 2e74 6f5f  yaml(), plan.to_
-00019e10: 7961 6d6c 2829 290a 0a20 2020 2064 6566  yaml())..    def
-00019e20: 2074 6573 745f 6765 745f 7065 6262 6c65   test_get_pebble
-00019e30: 5f63 6f6e 7461 696e 6572 5f70 6c61 6e5f  _container_plan_
-00019e40: 756e 6b6e 6f77 6e28 7365 6c66 293a 0a20  unknown(self):. 
-00019e50: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
-00019e60: 2048 6172 6e65 7373 2843 6861 726d 4261   Harness(CharmBa
-00019e70: 7365 2c20 6d65 7461 3d27 2727 0a20 2020  se, meta='''.   
-00019e80: 2020 2020 2020 2020 206e 616d 653a 2074           name: t
-00019e90: 6573 742d 6170 700a 2020 2020 2020 2020  est-app.        
-00019ea0: 2020 2020 636f 6e74 6169 6e65 7273 3a0a      containers:.
-00019eb0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00019ec0: 6f3a 0a20 2020 2020 2020 2020 2020 2020  o:.             
-00019ed0: 2020 2072 6573 6f75 7263 653a 2066 6f6f     resource: foo
-00019ee0: 2d69 6d61 6765 0a20 2020 2020 2020 2020  -image.         
-00019ef0: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00019f00: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-00019f10: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-00019f20: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-00019f30: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
-00019f40: 2068 6172 6e65 7373 2e73 6574 5f63 616e   harness.set_can
-00019f50: 5f63 6f6e 6e65 6374 2827 666f 6f27 2c20  _connect('foo', 
-00019f60: 5472 7565 290a 2020 2020 2020 2020 7769  True).        wi
-00019f70: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00019f80: 6973 6573 284b 6579 4572 726f 7229 3a0a  ises(KeyError):.
-00019f90: 2020 2020 2020 2020 2020 2020 6861 726e              harn
-00019fa0: 6573 732e 6765 745f 636f 6e74 6169 6e65  ess.get_containe
-00019fb0: 725f 7065 6262 6c65 5f70 6c61 6e28 2775  r_pebble_plan('u
-00019fc0: 6e6b 6e6f 776e 2729 0a20 2020 2020 2020  nknown').       
-00019fd0: 2070 6c61 6e20 3d20 6861 726e 6573 732e   plan = harness.
-00019fe0: 6765 745f 636f 6e74 6169 6e65 725f 7065  get_container_pe
-00019ff0: 6262 6c65 5f70 6c61 6e28 2766 6f6f 2729  bble_plan('foo')
-0001a000: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0001a010: 7365 7274 4571 7561 6c28 706c 616e 2e74  sertEqual(plan.t
-0001a020: 6f5f 7961 6d6c 2829 2c20 227b 7d5c 6e22  o_yaml(), "{}\n"
-0001a030: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0001a040: 636f 6e74 6169 6e65 725f 7065 6262 6c65  container_pebble
-0001a050: 5f72 6561 6479 2873 656c 6629 3a0a 2020  _ready(self):.  
-0001a060: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
-0001a070: 4861 726e 6573 7328 436f 6e74 6169 6e65  Harness(Containe
-0001a080: 7245 7665 6e74 4368 6172 6d2c 206d 6574  rEventCharm, met
-0001a090: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
-0001a0a0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
-0001a0b0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0001a0c0: 7461 696e 6572 733a 0a20 2020 2020 2020  tainers:.       
-0001a0d0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-0001a0e0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-0001a0f0: 7572 6365 3a20 666f 6f2d 696d 6167 650a  urce: foo-image.
-0001a100: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-0001a110: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0001a120: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0001a130: 616e 7570 290a 2020 2020 2020 2020 2320  anup).        # 
-0001a140: 5468 6973 2069 7320 6120 6e6f 2d6f 7020  This is a no-op 
-0001a150: 6966 2069 7420 6973 2063 616c 6c65 6420  if it is called 
-0001a160: 6265 666f 7265 2062 6567 696e 2829 2c20  before begin(), 
-0001a170: 6275 7420 6974 2069 736e 2774 2061 6e20  but it isn't an 
-0001a180: 6572 726f 720a 2020 2020 2020 2020 6861  error.        ha
-0001a190: 726e 6573 732e 636f 6e74 6169 6e65 725f  rness.container_
-0001a1a0: 7065 6262 6c65 5f72 6561 6479 2827 666f  pebble_ready('fo
-0001a1b0: 6f27 290a 2020 2020 2020 2020 6861 726e  o').        harn
-0001a1c0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-0001a1d0: 2020 2020 6861 726e 6573 732e 6368 6172      harness.char
-0001a1e0: 6d2e 6f62 7365 7276 655f 636f 6e74 6169  m.observe_contai
-0001a1f0: 6e65 725f 6576 656e 7473 2827 666f 6f27  ner_events('foo'
-0001a200: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-0001a210: 732e 636f 6e74 6169 6e65 725f 7065 6262  s.container_pebb
-0001a220: 6c65 5f72 6561 6479 2827 666f 6f27 290a  le_ready('foo').
-0001a230: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001a240: 6572 7445 7175 616c 280a 2020 2020 2020  ertEqual(.      
-0001a250: 2020 2020 2020 6861 726e 6573 732e 6368        harness.ch
-0001a260: 6172 6d2e 6368 616e 6765 732c 0a20 2020  arm.changes,.   
-0001a270: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-0001a280: 2020 2020 2020 2020 2020 207b 276e 616d             {'nam
-0001a290: 6527 3a20 2770 6562 626c 652d 7265 6164  e': 'pebble-read
-0001a2a0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-0001a2b0: 2020 2020 2027 636f 6e74 6169 6e65 7227       'container'
-0001a2c0: 3a20 2766 6f6f 272c 0a20 2020 2020 2020  : 'foo',.       
-0001a2d0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-0001a2e0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-0001a2f0: 2020 2029 0a0a 0a63 6c61 7373 2044 4252     )...class DBR
-0001a300: 656c 6174 696f 6e43 6861 6e67 6564 4865  elationChangedHe
-0001a310: 6c70 6572 284f 626a 6563 7429 3a0a 2020  lper(Object):.  
-0001a320: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-0001a330: 656c 662c 2070 6172 656e 742c 206b 6579  elf, parent, key
-0001a340: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
-0001a350: 2829 2e5f 5f69 6e69 745f 5f28 7061 7265  ().__init__(pare
-0001a360: 6e74 2c20 6b65 7929 0a20 2020 2020 2020  nt, key).       
-0001a370: 2073 656c 662e 6368 616e 6765 7320 3d20   self.changes = 
-0001a380: 5b5d 0a20 2020 2020 2020 2070 6172 656e  [].        paren
-0001a390: 742e 6672 616d 6577 6f72 6b2e 6f62 7365  t.framework.obse
-0001a3a0: 7276 6528 7061 7265 6e74 2e6f 6e2e 6462  rve(parent.on.db
-0001a3b0: 5f72 656c 6174 696f 6e5f 6368 616e 6765  _relation_change
-0001a3c0: 642c 2073 656c 662e 6f6e 5f72 656c 6174  d, self.on_relat
-0001a3d0: 696f 6e5f 6368 616e 6765 6429 0a0a 2020  ion_changed)..  
-0001a3e0: 2020 6465 6620 6f6e 5f72 656c 6174 696f    def on_relatio
-0001a3f0: 6e5f 6368 616e 6765 6428 7365 6c66 2c20  n_changed(self, 
-0001a400: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
-0001a410: 6966 2065 7665 6e74 2e75 6e69 7420 6973  if event.unit is
-0001a420: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0001a430: 2020 2020 2020 2073 656c 662e 6368 616e         self.chan
-0001a440: 6765 732e 6170 7065 6e64 2828 6576 656e  ges.append((even
-0001a450: 742e 7265 6c61 7469 6f6e 2e69 642c 2065  t.relation.id, e
-0001a460: 7665 6e74 2e75 6e69 742e 6e61 6d65 2929  vent.unit.name))
-0001a470: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001a480: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001a490: 6368 616e 6765 732e 6170 7065 6e64 2828  changes.append((
-0001a4a0: 6576 656e 742e 7265 6c61 7469 6f6e 2e69  event.relation.i
-0001a4b0: 642c 2065 7665 6e74 2e61 7070 2e6e 616d  d, event.app.nam
-0001a4c0: 6529 290a 0a0a 636c 6173 7320 5265 6c61  e))...class Rela
-0001a4d0: 7469 6f6e 4368 616e 6765 6456 6965 7765  tionChangedViewe
-0001a4e0: 7228 4f62 6a65 6374 293a 0a20 2020 2022  r(Object):.    "
-0001a4f0: 2222 5472 6163 6b20 7265 6c61 7469 6f6e  ""Track relation
-0001a500: 5f63 6861 6e67 6564 2065 7665 6e74 7320  _changed events 
-0001a510: 616e 6420 7361 7665 7320 7468 6520 6461  and saves the da
-0001a520: 7461 2073 6565 6e20 696e 2074 6865 2072  ta seen in the r
-0001a530: 656c 6174 696f 6e20 6275 636b 6574 2e22  elation bucket."
-0001a540: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
-0001a550: 6974 5f5f 2873 656c 662c 2063 6861 726d  it__(self, charm
-0001a560: 2c20 7265 6c61 7469 6f6e 5f6e 616d 6529  , relation_name)
-0001a570: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
-0001a580: 292e 5f5f 696e 6974 5f5f 2863 6861 726d  ).__init__(charm
-0001a590: 2c20 7265 6c61 7469 6f6e 5f6e 616d 6529  , relation_name)
-0001a5a0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-0001a5b0: 616e 6765 7320 3d20 5b5d 0a20 2020 2020  anges = [].     
-0001a5c0: 2020 2063 6861 726d 2e66 7261 6d65 776f     charm.framewo
-0001a5d0: 726b 2e6f 6273 6572 7665 2863 6861 726d  rk.observe(charm
-0001a5e0: 2e6f 6e5b 7265 6c61 7469 6f6e 5f6e 616d  .on[relation_nam
-0001a5f0: 655d 2e72 656c 6174 696f 6e5f 6368 616e  e].relation_chan
-0001a600: 6765 642c 2073 656c 662e 6f6e 5f72 656c  ged, self.on_rel
-0001a610: 6174 696f 6e5f 6368 616e 6765 6429 0a0a  ation_changed)..
-0001a620: 2020 2020 6465 6620 6f6e 5f72 656c 6174      def on_relat
-0001a630: 696f 6e5f 6368 616e 6765 6428 7365 6c66  ion_changed(self
-0001a640: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
-0001a650: 2020 6966 2065 7665 6e74 2e75 6e69 7420    if event.unit 
-0001a660: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001a670: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-0001a680: 6576 656e 742e 7265 6c61 7469 6f6e 2e64  event.relation.d
-0001a690: 6174 615b 6576 656e 742e 756e 6974 5d0a  ata[event.unit].
-0001a6a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a6b0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-0001a6c0: 2065 7665 6e74 2e72 656c 6174 696f 6e2e   event.relation.
-0001a6d0: 6461 7461 5b65 7665 6e74 2e61 7070 5d0a  data[event.app].
-0001a6e0: 2020 2020 2020 2020 7365 6c66 2e63 6861          self.cha
-0001a6f0: 6e67 6573 2e61 7070 656e 6428 6469 6374  nges.append(dict
-0001a700: 2864 6174 6129 290a 0a0a 636c 6173 7320  (data))...class 
-0001a710: 5265 636f 7264 696e 6743 6861 726d 2843  RecordingCharm(C
-0001a720: 6861 726d 4261 7365 293a 0a20 2020 2022  harmBase):.    "
-0001a730: 2222 5265 636f 7264 2074 6865 2065 7665  ""Record the eve
-0001a740: 6e74 7320 7468 6174 2077 6520 7365 652c  nts that we see,
-0001a750: 2061 6e64 2061 6e79 2061 7373 6f63 6961   and any associa
-0001a760: 7465 6420 6461 7461 2e22 2222 0a0a 2020  ted data."""..  
-0001a770: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-0001a780: 656c 662c 2066 7261 6d65 776f 726b 293a  elf, framework):
-0001a790: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-0001a7a0: 2e5f 5f69 6e69 745f 5f28 6672 616d 6577  .__init__(framew
-0001a7b0: 6f72 6b29 0a20 2020 2020 2020 2073 656c  ork).        sel
-0001a7c0: 662e 6368 616e 6765 7320 3d20 5b5d 0a20  f.changes = []. 
-0001a7d0: 2020 2020 2020 2073 656c 662e 6672 616d         self.fram
-0001a7e0: 6577 6f72 6b2e 6f62 7365 7276 6528 7365  ework.observe(se
-0001a7f0: 6c66 2e6f 6e2e 636f 6e66 6967 5f63 6861  lf.on.config_cha
-0001a800: 6e67 6564 2c20 7365 6c66 2e5f 6f6e 5f63  nged, self._on_c
-0001a810: 6f6e 6669 675f 6368 616e 6765 6429 0a20  onfig_changed). 
-0001a820: 2020 2020 2020 2073 656c 662e 6672 616d         self.fram
-0001a830: 6577 6f72 6b2e 6f62 7365 7276 6528 7365  ework.observe(se
-0001a840: 6c66 2e6f 6e2e 6c65 6164 6572 5f65 6c65  lf.on.leader_ele
-0001a850: 6374 6564 2c20 7365 6c66 2e5f 6f6e 5f6c  cted, self._on_l
-0001a860: 6561 6465 725f 656c 6563 7465 6429 0a20  eader_elected). 
-0001a870: 2020 2020 2020 2073 656c 662e 6672 616d         self.fram
-0001a880: 6577 6f72 6b2e 6f62 7365 7276 6528 7365  ework.observe(se
-0001a890: 6c66 2e6f 6e2e 6c65 6164 6572 5f73 6574  lf.on.leader_set
-0001a8a0: 7469 6e67 735f 6368 616e 6765 642c 2073  tings_changed, s
-0001a8b0: 656c 662e 5f6f 6e5f 6c65 6164 6572 5f73  elf._on_leader_s
-0001a8c0: 6574 7469 6e67 735f 6368 616e 6765 6429  ettings_changed)
-0001a8d0: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
-0001a8e0: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
-0001a8f0: 7365 6c66 2e6f 6e2e 696e 7374 616c 6c2c  self.on.install,
-0001a900: 2073 656c 662e 5f6f 6e5f 696e 7374 616c   self._on_instal
-0001a910: 6c29 0a20 2020 2020 2020 2073 656c 662e  l).        self.
-0001a920: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
-0001a930: 6528 7365 6c66 2e6f 6e2e 7374 6172 742c  e(self.on.start,
-0001a940: 2073 656c 662e 5f6f 6e5f 7374 6172 7429   self._on_start)
-0001a950: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
-0001a960: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
-0001a970: 7365 6c66 2e6f 6e2e 7374 6f70 2c20 7365  self.on.stop, se
-0001a980: 6c66 2e5f 6f6e 5f73 746f 7029 0a20 2020  lf._on_stop).   
-0001a990: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
-0001a9a0: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
-0001a9b0: 2e6f 6e2e 7265 6d6f 7665 2c20 7365 6c66  .on.remove, self
-0001a9c0: 2e5f 6f6e 5f72 656d 6f76 6529 0a20 2020  ._on_remove).   
-0001a9d0: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
-0001a9e0: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
-0001a9f0: 2e6f 6e2e 7570 6772 6164 655f 6368 6172  .on.upgrade_char
-0001aa00: 6d2c 2073 656c 662e 5f6f 6e5f 7570 6772  m, self._on_upgr
-0001aa10: 6164 655f 6368 6172 6d29 0a20 2020 2020  ade_charm).     
-0001aa20: 2020 2073 656c 662e 6672 616d 6577 6f72     self.framewor
-0001aa30: 6b2e 6f62 7365 7276 6528 7365 6c66 2e6f  k.observe(self.o
-0001aa40: 6e2e 7570 6461 7465 5f73 7461 7475 732c  n.update_status,
-0001aa50: 2073 656c 662e 5f6f 6e5f 7570 6461 7465   self._on_update
-0001aa60: 5f73 7461 7475 7329 0a0a 2020 2020 6465  _status)..    de
-0001aa70: 6620 6765 745f 6368 616e 6765 7328 7365  f get_changes(se
-0001aa80: 6c66 2c20 7265 7365 743d 5472 7565 293a  lf, reset=True):
-0001aa90: 0a20 2020 2020 2020 2063 6861 6e67 6573  .        changes
-0001aaa0: 203d 2073 656c 662e 6368 616e 6765 730a   = self.changes.
-0001aab0: 2020 2020 2020 2020 6966 2072 6573 6574          if reset
-0001aac0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001aad0: 6c66 2e63 6861 6e67 6573 203d 205b 5d0a  lf.changes = [].
-0001aae0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-0001aaf0: 6861 6e67 6573 0a0a 2020 2020 6465 6620  hanges..    def 
-0001ab00: 5f6f 6e5f 696e 7374 616c 6c28 7365 6c66  _on_install(self
-0001ab10: 2c20 5f29 3a0a 2020 2020 2020 2020 6966  , _):.        if
-0001ab20: 2073 656c 662e 636f 6e66 6967 2e67 6574   self.config.get
-0001ab30: 2827 7365 745f 7374 6174 7573 2729 3a0a  ('set_status'):.
-0001ab40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001ab50: 2e75 6e69 742e 7374 6174 7573 203d 204d  .unit.status = M
-0001ab60: 6169 6e74 656e 616e 6365 5374 6174 7573  aintenanceStatus
-0001ab70: 2822 5374 6174 7573 2073 6574 206f 6e20  ("Status set on 
-0001ab80: 696e 7374 616c 6c22 290a 2020 2020 2020  install").      
-0001ab90: 2020 7365 6c66 2e63 6861 6e67 6573 2e61    self.changes.a
-0001aba0: 7070 656e 6428 6469 6374 286e 616d 653d  ppend(dict(name=
-0001abb0: 2769 6e73 7461 6c6c 2729 290a 0a20 2020  'install'))..   
-0001abc0: 2064 6566 205f 6f6e 5f73 7461 7274 2873   def _on_start(s
-0001abd0: 656c 662c 205f 293a 0a20 2020 2020 2020  elf, _):.       
-0001abe0: 2073 656c 662e 6368 616e 6765 732e 6170   self.changes.ap
-0001abf0: 7065 6e64 2864 6963 7428 6e61 6d65 3d27  pend(dict(name='
-0001ac00: 7374 6172 7427 2929 0a0a 2020 2020 6465  start'))..    de
-0001ac10: 6620 5f6f 6e5f 7374 6f70 2873 656c 662c  f _on_stop(self,
-0001ac20: 205f 293a 0a20 2020 2020 2020 2073 656c   _):.        sel
-0001ac30: 662e 6368 616e 6765 732e 6170 7065 6e64  f.changes.append
-0001ac40: 2864 6963 7428 6e61 6d65 3d27 7374 6f70  (dict(name='stop
-0001ac50: 2729 290a 0a20 2020 2064 6566 205f 6f6e  '))..    def _on
-0001ac60: 5f72 656d 6f76 6528 7365 6c66 2c20 5f29  _remove(self, _)
-0001ac70: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
-0001ac80: 6861 6e67 6573 2e61 7070 656e 6428 6469  hanges.append(di
-0001ac90: 6374 286e 616d 653d 2772 656d 6f76 6527  ct(name='remove'
-0001aca0: 2929 0a0a 2020 2020 6465 6620 5f6f 6e5f  ))..    def _on_
-0001acb0: 636f 6e66 6967 5f63 6861 6e67 6564 2873  config_changed(s
-0001acc0: 656c 662c 205f 293a 0a20 2020 2020 2020  elf, _):.       
-0001acd0: 2073 656c 662e 6368 616e 6765 732e 6170   self.changes.ap
-0001ace0: 7065 6e64 2864 6963 7428 6e61 6d65 3d27  pend(dict(name='
-0001acf0: 636f 6e66 6967 2d63 6861 6e67 6564 272c  config-changed',
-0001ad00: 2064 6174 613d 6469 6374 2873 656c 662e   data=dict(self.
-0001ad10: 6672 616d 6577 6f72 6b2e 6d6f 6465 6c2e  framework.model.
-0001ad20: 636f 6e66 6967 2929 290a 0a20 2020 2064  config)))..    d
-0001ad30: 6566 205f 6f6e 5f6c 6561 6465 725f 656c  ef _on_leader_el
-0001ad40: 6563 7465 6428 7365 6c66 2c20 5f29 3a0a  ected(self, _):.
-0001ad50: 2020 2020 2020 2020 7365 6c66 2e63 6861          self.cha
-0001ad60: 6e67 6573 2e61 7070 656e 6428 6469 6374  nges.append(dict
-0001ad70: 286e 616d 653d 276c 6561 6465 722d 656c  (name='leader-el
-0001ad80: 6563 7465 6427 2929 0a0a 2020 2020 6465  ected'))..    de
-0001ad90: 6620 5f6f 6e5f 6c65 6164 6572 5f73 6574  f _on_leader_set
-0001ada0: 7469 6e67 735f 6368 616e 6765 6428 7365  tings_changed(se
-0001adb0: 6c66 2c20 5f29 3a0a 2020 2020 2020 2020  lf, _):.        
-0001adc0: 7365 6c66 2e63 6861 6e67 6573 2e61 7070  self.changes.app
-0001add0: 656e 6428 6469 6374 286e 616d 653d 276c  end(dict(name='l
-0001ade0: 6561 6465 722d 7365 7474 696e 6773 2d63  eader-settings-c
-0001adf0: 6861 6e67 6564 2729 290a 0a20 2020 2064  hanged'))..    d
-0001ae00: 6566 205f 6f6e 5f75 7067 7261 6465 5f63  ef _on_upgrade_c
-0001ae10: 6861 726d 2873 656c 662c 205f 293a 0a20  harm(self, _):. 
-0001ae20: 2020 2020 2020 2073 656c 662e 6368 616e         self.chan
-0001ae30: 6765 732e 6170 7065 6e64 2864 6963 7428  ges.append(dict(
-0001ae40: 6e61 6d65 3d27 7570 6772 6164 652d 6368  name='upgrade-ch
-0001ae50: 6172 6d27 2929 0a0a 2020 2020 6465 6620  arm'))..    def 
-0001ae60: 5f6f 6e5f 7570 6461 7465 5f73 7461 7475  _on_update_statu
-0001ae70: 7328 7365 6c66 2c20 5f29 3a0a 2020 2020  s(self, _):.    
-0001ae80: 2020 2020 7365 6c66 2e63 6861 6e67 6573      self.changes
-0001ae90: 2e61 7070 656e 6428 6469 6374 286e 616d  .append(dict(nam
-0001aea0: 653d 2775 7064 6174 652d 7374 6174 7573  e='update-status
-0001aeb0: 2729 290a 0a0a 636c 6173 7320 5265 6c61  '))...class Rela
-0001aec0: 7469 6f6e 4576 656e 7443 6861 726d 2852  tionEventCharm(R
-0001aed0: 6563 6f72 6469 6e67 4368 6172 6d29 3a0a  ecordingCharm):.
-0001aee0: 2020 2020 2222 2252 6563 6f72 6420 6576      """Record ev
-0001aef0: 656e 7473 2072 656c 6174 6564 2074 6f20  ents related to 
-0001af00: 7265 6c61 7469 6f6e 206c 6966 6563 7963  relation lifecyc
-0001af10: 6c65 732e 2222 220a 0a20 2020 2064 6566  les."""..    def
-0001af20: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0001af30: 6672 616d 6577 6f72 6b29 3a0a 2020 2020  framework):.    
-0001af40: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-0001af50: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
-0001af60: 2020 2020 2020 2020 2320 5768 656e 2073          # When s
-0001af70: 6574 2c20 7468 6973 2069 6e73 7472 7563  et, this instruc
-0001af80: 7473 2074 6865 2063 6861 726d 2074 6f20  ts the charm to 
-0001af90: 696e 636c 7564 6520 6120 2772 656c 6174  include a 'relat
-0001afa0: 696f 6e5f 6461 7461 2720 6669 656c 6420  ion_data' field 
-0001afb0: 696e 2074 6865 2027 6461 7461 270a 2020  in the 'data'.  
-0001afc0: 2020 2020 2020 2320 7365 6374 696f 6e20        # section 
-0001afd0: 6f66 2065 6163 6820 6368 616e 6765 2069  of each change i
-0001afe0: 7420 6c6f 6773 2c20 7768 6963 6820 616c  t logs, which al
-0001aff0: 6c6f 7773 2075 7320 746f 2074 6573 7420  lows us to test 
-0001b000: 7768 6963 6820 7265 6c61 7469 6f6e 2064  which relation d
-0001b010: 6174 6120 7761 7320 6176 6169 6c61 626c  ata was availabl
-0001b020: 650a 2020 2020 2020 2020 2320 696e 2065  e.        # in e
-0001b030: 6163 6820 686f 6f6b 2069 6e76 6f63 6174  ach hook invocat
-0001b040: 696f 6e0a 2020 2020 2020 2020 7365 6c66  ion.        self
-0001b050: 2e72 6563 6f72 645f 7265 6c61 7469 6f6e  .record_relation
-0001b060: 5f64 6174 615f 6f6e 5f65 7665 6e74 7320  _data_on_events 
-0001b070: 3d20 4661 6c73 650a 0a20 2020 2064 6566  = False..    def
-0001b080: 206f 6273 6572 7665 5f72 656c 6174 696f   observe_relatio
-0001b090: 6e5f 6576 656e 7473 2873 656c 662c 2072  n_events(self, r
-0001b0a0: 656c 6174 696f 6e5f 6e61 6d65 293a 0a20  elation_name):. 
-0001b0b0: 2020 2020 2020 2073 656c 662e 7265 6c61         self.rela
-0001b0c0: 7469 6f6e 5f6e 616d 6520 3d20 7265 6c61  tion_name = rela
-0001b0d0: 7469 6f6e 5f6e 616d 650a 2020 2020 2020  tion_name.      
-0001b0e0: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
-0001b0f0: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
-0001b100: 5b72 656c 6174 696f 6e5f 6e61 6d65 5d2e  [relation_name].
-0001b110: 7265 6c61 7469 6f6e 5f63 7265 6174 6564  relation_created
-0001b120: 2c20 7365 6c66 2e5f 6f6e 5f72 656c 6174  , self._on_relat
-0001b130: 696f 6e5f 6372 6561 7465 6429 0a20 2020  ion_created).   
-0001b140: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
-0001b150: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
-0001b160: 2e6f 6e5b 7265 6c61 7469 6f6e 5f6e 616d  .on[relation_nam
-0001b170: 655d 2e72 656c 6174 696f 6e5f 6a6f 696e  e].relation_join
-0001b180: 6564 2c20 7365 6c66 2e5f 6f6e 5f72 656c  ed, self._on_rel
-0001b190: 6174 696f 6e5f 6a6f 696e 6564 290a 2020  ation_joined).  
-0001b1a0: 2020 2020 2020 7365 6c66 2e66 7261 6d65        self.frame
-0001b1b0: 776f 726b 2e6f 6273 6572 7665 2873 656c  work.observe(sel
-0001b1c0: 662e 6f6e 5b72 656c 6174 696f 6e5f 6e61  f.on[relation_na
-0001b1d0: 6d65 5d2e 7265 6c61 7469 6f6e 5f63 6861  me].relation_cha
-0001b1e0: 6e67 6564 2c20 7365 6c66 2e5f 6f6e 5f72  nged, self._on_r
-0001b1f0: 656c 6174 696f 6e5f 6368 616e 6765 6429  elation_changed)
-0001b200: 0a20 2020 2020 2020 2073 656c 662e 6672  .        self.fr
-0001b210: 616d 6577 6f72 6b2e 6f62 7365 7276 6528  amework.observe(
-0001b220: 7365 6c66 2e6f 6e5b 7265 6c61 7469 6f6e  self.on[relation
-0001b230: 5f6e 616d 655d 2e72 656c 6174 696f 6e5f  _name].relation_
-0001b240: 6465 7061 7274 6564 2c0a 2020 2020 2020  departed,.      
-0001b250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b260: 2020 2020 2020 2020 2073 656c 662e 5f6f           self._o
-0001b270: 6e5f 7265 6c61 7469 6f6e 5f64 6570 6172  n_relation_depar
-0001b280: 7465 6429 0a20 2020 2020 2020 2073 656c  ted).        sel
-0001b290: 662e 6672 616d 6577 6f72 6b2e 6f62 7365  f.framework.obse
-0001b2a0: 7276 6528 7365 6c66 2e6f 6e5b 7265 6c61  rve(self.on[rela
-0001b2b0: 7469 6f6e 5f6e 616d 655d 2e72 656c 6174  tion_name].relat
-0001b2c0: 696f 6e5f 6272 6f6b 656e 2c20 7365 6c66  ion_broken, self
-0001b2d0: 2e5f 6f6e 5f72 656c 6174 696f 6e5f 6272  ._on_relation_br
-0001b2e0: 6f6b 656e 290a 0a20 2020 2064 6566 205f  oken)..    def _
-0001b2f0: 6f6e 5f72 656c 6174 696f 6e5f 6372 6561  on_relation_crea
-0001b300: 7465 6428 7365 6c66 2c20 6576 656e 7429  ted(self, event)
-0001b310: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
-0001b320: 6f62 7365 7276 655f 7265 6c61 7469 6f6e  observe_relation
-0001b330: 5f65 7665 6e74 2827 7265 6c61 7469 6f6e  _event('relation
-0001b340: 2d63 7265 6174 6564 272c 2065 7665 6e74  -created', event
-0001b350: 290a 0a20 2020 2064 6566 205f 6f6e 5f72  )..    def _on_r
-0001b360: 656c 6174 696f 6e5f 6a6f 696e 6564 2873  elation_joined(s
-0001b370: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
-0001b380: 2020 2020 2073 656c 662e 5f6f 6273 6572       self._obser
-0001b390: 7665 5f72 656c 6174 696f 6e5f 6576 656e  ve_relation_even
-0001b3a0: 7428 2772 656c 6174 696f 6e2d 6a6f 696e  t('relation-join
-0001b3b0: 6564 272c 2065 7665 6e74 290a 0a20 2020  ed', event)..   
-0001b3c0: 2064 6566 205f 6f6e 5f72 656c 6174 696f   def _on_relatio
-0001b3d0: 6e5f 6368 616e 6765 6428 7365 6c66 2c20  n_changed(self, 
-0001b3e0: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
-0001b3f0: 7365 6c66 2e5f 6f62 7365 7276 655f 7265  self._observe_re
-0001b400: 6c61 7469 6f6e 5f65 7665 6e74 2827 7265  lation_event('re
-0001b410: 6c61 7469 6f6e 2d63 6861 6e67 6564 272c  lation-changed',
-0001b420: 2065 7665 6e74 290a 0a20 2020 2064 6566   event)..    def
-0001b430: 205f 6f6e 5f72 656c 6174 696f 6e5f 6465   _on_relation_de
-0001b440: 7061 7274 6564 2873 656c 662c 2065 7665  parted(self, eve
-0001b450: 6e74 293a 0a20 2020 2020 2020 2073 656c  nt):.        sel
-0001b460: 662e 5f6f 6273 6572 7665 5f72 656c 6174  f._observe_relat
-0001b470: 696f 6e5f 6576 656e 7428 2772 656c 6174  ion_event('relat
-0001b480: 696f 6e2d 6465 7061 7274 6564 272c 2065  ion-departed', e
-0001b490: 7665 6e74 290a 0a20 2020 2064 6566 205f  vent)..    def _
-0001b4a0: 6f6e 5f72 656c 6174 696f 6e5f 6272 6f6b  on_relation_brok
-0001b4b0: 656e 2873 656c 662c 2065 7665 6e74 293a  en(self, event):
-0001b4c0: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
-0001b4d0: 6273 6572 7665 5f72 656c 6174 696f 6e5f  bserve_relation_
-0001b4e0: 6576 656e 7428 2772 656c 6174 696f 6e2d  event('relation-
-0001b4f0: 6272 6f6b 656e 272c 2065 7665 6e74 290a  broken', event).
-0001b500: 0a20 2020 2064 6566 205f 6f62 7365 7276  .    def _observ
-0001b510: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
-0001b520: 2873 656c 662c 2065 7665 6e74 5f6e 616d  (self, event_nam
-0001b530: 652c 2065 7665 6e74 293a 0a20 2020 2020  e, event):.     
-0001b540: 2020 2075 6e69 745f 6e61 6d65 203d 204e     unit_name = N
-0001b550: 6f6e 650a 2020 2020 2020 2020 6966 2065  one.        if e
-0001b560: 7665 6e74 2e75 6e69 7420 6973 206e 6f74  vent.unit is not
-0001b570: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001b580: 2020 2075 6e69 745f 6e61 6d65 203d 2065     unit_name = e
-0001b590: 7665 6e74 2e75 6e69 742e 6e61 6d65 0a20  vent.unit.name. 
-0001b5a0: 2020 2020 2020 2061 7070 5f6e 616d 6520         app_name 
-0001b5b0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
-0001b5c0: 6620 6576 656e 742e 6170 7020 6973 206e  f event.app is n
-0001b5d0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001b5e0: 2020 2020 2061 7070 5f6e 616d 6520 3d20       app_name = 
-0001b5f0: 6576 656e 742e 6170 702e 6e61 6d65 0a0a  event.app.name..
-0001b600: 2020 2020 2020 2020 6461 7461 203d 2064          data = d
-0001b610: 6963 7428 6170 703d 6170 705f 6e61 6d65  ict(app=app_name
-0001b620: 2c20 756e 6974 3d75 6e69 745f 6e61 6d65  , unit=unit_name
-0001b630: 2c20 7265 6c61 7469 6f6e 5f69 643d 6576  , relation_id=ev
-0001b640: 656e 742e 7265 6c61 7469 6f6e 2e69 6429  ent.relation.id)
-0001b650: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0001b660: 7374 616e 6365 2865 7665 6e74 2c20 5265  stance(event, Re
-0001b670: 6c61 7469 6f6e 4465 7061 7274 6564 4576  lationDepartedEv
-0001b680: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
-0001b690: 2020 6461 7461 5b27 6465 7061 7274 696e    data['departin
-0001b6a0: 675f 756e 6974 275d 203d 2065 7665 6e74  g_unit'] = event
-0001b6b0: 2e64 6570 6172 7469 6e67 5f75 6e69 742e  .departing_unit.
-0001b6c0: 6e61 6d65 0a0a 2020 2020 2020 2020 7265  name..        re
-0001b6d0: 636f 7264 696e 6720 3d20 6469 6374 286e  cording = dict(n
-0001b6e0: 616d 653d 6576 656e 745f 6e61 6d65 2c20  ame=event_name, 
-0001b6f0: 7265 6c61 7469 6f6e 3d65 7665 6e74 2e72  relation=event.r
-0001b700: 656c 6174 696f 6e2e 6e61 6d65 2c20 6461  elation.name, da
-0001b710: 7461 3d64 6174 6129 0a0a 2020 2020 2020  ta=data)..      
-0001b720: 2020 6966 2073 656c 662e 7265 636f 7264    if self.record
-0001b730: 5f72 656c 6174 696f 6e5f 6461 7461 5f6f  _relation_data_o
-0001b740: 6e5f 6576 656e 7473 3a0a 2020 2020 2020  n_events:.      
-0001b750: 2020 2020 2020 7265 636f 7264 696e 675b        recording[
-0001b760: 2264 6174 6122 5d2e 7570 6461 7465 287b  "data"].update({
-0001b770: 2772 656c 6174 696f 6e5f 6461 7461 273a  'relation_data':
-0001b780: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0001b790: 2020 2073 7472 2878 2e6e 616d 6529 3a20     str(x.name): 
-0001b7a0: 6469 6374 2865 7665 6e74 2e72 656c 6174  dict(event.relat
-0001b7b0: 696f 6e2e 6461 7461 5b78 5d29 0a20 2020  ion.data[x]).   
-0001b7c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001b7d0: 2078 2069 6e20 6576 656e 742e 7265 6c61   x in event.rela
-0001b7e0: 7469 6f6e 2e64 6174 610a 2020 2020 2020  tion.data.      
-0001b7f0: 2020 2020 2020 7d7d 290a 0a20 2020 2020        }})..     
-0001b800: 2020 2073 656c 662e 6368 616e 6765 732e     self.changes.
-0001b810: 6170 7065 6e64 2872 6563 6f72 6469 6e67  append(recording
-0001b820: 290a 0a0a 636c 6173 7320 5265 6c61 7469  )...class Relati
-0001b830: 6f6e 4272 6f6b 656e 5465 7374 6572 2852  onBrokenTester(R
-0001b840: 656c 6174 696f 6e45 7665 6e74 4368 6172  elationEventChar
-0001b850: 6d29 3a0a 2020 2020 2222 2241 6363 6573  m):.    """Acces
-0001b860: 7320 696e 6163 6365 7373 6962 6c65 2072  s inaccessible r
-0001b870: 656c 6174 696f 6e20 6461 7461 2e22 2222  elation data."""
-0001b880: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-0001b890: 5f5f 2873 656c 662c 2066 7261 6d65 776f  __(self, framewo
-0001b8a0: 726b 293a 0a20 2020 2020 2020 2073 7570  rk):.        sup
-0001b8b0: 6572 2829 2e5f 5f69 6e69 745f 5f28 6672  er().__init__(fr
-0001b8c0: 616d 6577 6f72 6b29 0a0a 2020 2020 6465  amework)..    de
-0001b8d0: 6620 5f6f 6e5f 7265 6c61 7469 6f6e 5f62  f _on_relation_b
-0001b8e0: 726f 6b65 6e28 7365 6c66 2c20 6576 656e  roken(self, even
-0001b8f0: 7429 3a0a 2020 2020 2020 2020 7072 696e  t):.        prin
-0001b900: 7428 6576 656e 742e 7265 6c61 7469 6f6e  t(event.relation
-0001b910: 2e64 6174 615b 6576 656e 742e 7265 6c61  .data[event.rela
-0001b920: 7469 6f6e 2e61 7070 5d5b 2762 6172 275d  tion.app]['bar']
-0001b930: 290a 0a0a 636c 6173 7320 436f 6e74 6169  )...class Contai
-0001b940: 6e65 7245 7665 6e74 4368 6172 6d28 5265  nerEventCharm(Re
-0001b950: 636f 7264 696e 6743 6861 726d 293a 0a20  cordingCharm):. 
-0001b960: 2020 2022 2222 5265 636f 7264 2065 7665     """Record eve
-0001b970: 6e74 7320 7265 6c61 7465 6420 746f 2063  nts related to c
-0001b980: 6f6e 7461 696e 6572 206c 6966 6563 7963  ontainer lifecyc
-0001b990: 6c65 732e 2222 220a 0a20 2020 2064 6566  les."""..    def
-0001b9a0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0001b9b0: 6672 616d 6577 6f72 6b29 3a0a 2020 2020  framework):.    
-0001b9c0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-0001b9d0: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
-0001b9e0: 0a20 2020 2064 6566 206f 6273 6572 7665  .    def observe
-0001b9f0: 5f63 6f6e 7461 696e 6572 5f65 7665 6e74  _container_event
-0001ba00: 7328 7365 6c66 2c20 636f 6e74 6169 6e65  s(self, containe
-0001ba10: 725f 6e61 6d65 293a 0a20 2020 2020 2020  r_name):.       
-0001ba20: 2073 656c 662e 6672 616d 6577 6f72 6b2e   self.framework.
-0001ba30: 6f62 7365 7276 6528 7365 6c66 2e6f 6e5b  observe(self.on[
-0001ba40: 636f 6e74 6169 6e65 725f 6e61 6d65 5d2e  container_name].
-0001ba50: 7065 6262 6c65 5f72 6561 6479 2c20 7365  pebble_ready, se
-0001ba60: 6c66 2e5f 6f6e 5f70 6562 626c 655f 7265  lf._on_pebble_re
-0001ba70: 6164 7929 0a0a 2020 2020 6465 6620 5f6f  ady)..    def _o
-0001ba80: 6e5f 7065 6262 6c65 5f72 6561 6479 2873  n_pebble_ready(s
-0001ba90: 656c 662c 2065 7665 6e74 293a 0a20 2020  elf, event):.   
-0001baa0: 2020 2020 2073 656c 662e 5f6f 6273 6572       self._obser
-0001bab0: 7665 5f63 6f6e 7461 696e 6572 5f65 7665  ve_container_eve
-0001bac0: 6e74 2827 7065 6262 6c65 2d72 6561 6479  nt('pebble-ready
-0001bad0: 272c 2065 7665 6e74 290a 0a20 2020 2064  ', event)..    d
-0001bae0: 6566 205f 6f62 7365 7276 655f 636f 6e74  ef _observe_cont
-0001baf0: 6169 6e65 725f 6576 656e 7428 7365 6c66  ainer_event(self
-0001bb00: 2c20 6576 656e 745f 6e61 6d65 2c20 6576  , event_name, ev
-0001bb10: 656e 743a 2050 6562 626c 6552 6561 6479  ent: PebbleReady
-0001bb20: 4576 656e 7429 3a0a 2020 2020 2020 2020  Event):.        
-0001bb30: 636f 6e74 6169 6e65 725f 6e61 6d65 203d  container_name =
-0001bb40: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-0001bb50: 2065 7665 6e74 2e77 6f72 6b6c 6f61 6420   event.workload 
-0001bb60: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001bb70: 2020 2020 2020 2020 2063 6f6e 7461 696e           contain
-0001bb80: 6572 5f6e 616d 6520 3d20 6576 656e 742e  er_name = event.
-0001bb90: 776f 726b 6c6f 6164 2e6e 616d 650a 2020  workload.name.  
-0001bba0: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
-0001bbb0: 6573 2e61 7070 656e 6428 0a20 2020 2020  es.append(.     
-0001bbc0: 2020 2020 2020 2064 6963 7428 6e61 6d65         dict(name
-0001bbd0: 3d65 7665 6e74 5f6e 616d 652c 2063 6f6e  =event_name, con
-0001bbe0: 7461 696e 6572 3d63 6f6e 7461 696e 6572  tainer=container
-0001bbf0: 5f6e 616d 6529 290a 0a0a 6465 6620 6765  _name))...def ge
-0001bc00: 745f 7075 626c 6963 5f6d 6574 686f 6473  t_public_methods
-0001bc10: 286f 626a 293a 0a20 2020 2022 2222 4765  (obj):.    """Ge
-0001bc20: 7420 7468 6520 7075 626c 6963 2061 7474  t the public att
-0001bc30: 7269 6275 7465 7320 6f66 206f 626a 2074  ributes of obj t
-0001bc40: 6f20 636f 6d70 6172 6520 746f 2061 6e6f  o compare to ano
-0001bc50: 7468 6572 206f 626a 6563 742e 2222 220a  ther object.""".
-0001bc60: 2020 2020 7075 626c 6963 203d 2073 6574      public = set
-0001bc70: 2829 0a20 2020 206d 656d 6265 7273 203d  ().    members =
-0001bc80: 2069 6e73 7065 6374 2e67 6574 6d65 6d62   inspect.getmemb
-0001bc90: 6572 7328 6f62 6a29 0a20 2020 2066 6f72  ers(obj).    for
-0001bca0: 206e 616d 652c 206d 656d 6265 7220 696e   name, member in
-0001bcb0: 206d 656d 6265 7273 3a0a 2020 2020 2020   members:.      
-0001bcc0: 2020 6966 206e 616d 652e 7374 6172 7473    if name.starts
-0001bcd0: 7769 7468 2827 5f27 293a 0a20 2020 2020  with('_'):.     
-0001bce0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0001bcf0: 2020 2020 2020 2020 6966 2069 6e73 7065          if inspe
-0001bd00: 6374 2e69 7366 756e 6374 696f 6e28 6d65  ct.isfunction(me
-0001bd10: 6d62 6572 2920 6f72 2069 6e73 7065 6374  mber) or inspect
-0001bd20: 2e69 736d 6574 686f 6428 6d65 6d62 6572  .ismethod(member
-0001bd30: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-0001bd40: 7562 6c69 632e 6164 6428 6e61 6d65 290a  ublic.add(name).
-0001bd50: 2020 2020 7265 7475 726e 2070 7562 6c69      return publi
-0001bd60: 630a 0a0a 636c 6173 7320 5465 7374 5465  c...class TestTe
-0001bd70: 7374 696e 674d 6f64 656c 4261 636b 656e  stingModelBacken
-0001bd80: 6428 756e 6974 7465 7374 2e54 6573 7443  d(unittest.TestC
-0001bd90: 6173 6529 3a0a 0a20 2020 2064 6566 2074  ase):..    def t
-0001bda0: 6573 745f 636f 6e66 6f72 6d73 5f74 6f5f  est_conforms_to_
-0001bdb0: 6d6f 6465 6c5f 6261 636b 656e 6428 7365  model_backend(se
-0001bdc0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0001bdd0: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-0001bde0: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-0001bdf0: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-0001be00: 616d 653a 2061 7070 0a20 2020 2020 2020  ame: app.       
-0001be10: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0001be20: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0001be30: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0001be40: 7029 0a20 2020 2020 2020 2062 6163 6b65  p).        backe
-0001be50: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
-0001be60: 636b 656e 640a 2020 2020 2020 2020 6d62  ckend.        mb
-0001be70: 5f6d 6574 686f 6473 203d 2067 6574 5f70  _methods = get_p
-0001be80: 7562 6c69 635f 6d65 7468 6f64 7328 5f4d  ublic_methods(_M
-0001be90: 6f64 656c 4261 636b 656e 6429 0a20 2020  odelBackend).   
-0001bea0: 2020 2020 2062 6163 6b65 6e64 5f6d 6574       backend_met
-0001beb0: 686f 6473 203d 2067 6574 5f70 7562 6c69  hods = get_publi
-0001bec0: 635f 6d65 7468 6f64 7328 6261 636b 656e  c_methods(backen
-0001bed0: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
-0001bee0: 6173 7365 7274 4571 7561 6c28 6d62 5f6d  assertEqual(mb_m
-0001bef0: 6574 686f 6473 2c20 6261 636b 656e 645f  ethods, backend_
-0001bf00: 6d65 7468 6f64 7329 0a0a 2020 2020 6465  methods)..    de
-0001bf10: 6620 7465 7374 5f6d 6f64 656c 5f75 7569  f test_model_uui
-0001bf20: 645f 6973 5f75 7569 645f 7634 2873 656c  d_is_uuid_v4(sel
-0001bf30: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-0001bf40: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-0001bf50: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-0001bf60: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-0001bf70: 6d65 3a20 7465 7374 2d63 6861 726d 0a20  me: test-charm. 
-0001bf80: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-0001bf90: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0001bfa0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0001bfb0: 6e75 7029 0a20 2020 2020 2020 2062 6163  nup).        bac
-0001bfc0: 6b65 6e64 203d 2068 6172 6e65 7373 2e5f  kend = harness._
-0001bfd0: 6261 636b 656e 640a 2020 2020 2020 2020  backend.        
-0001bfe0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001bff0: 2875 7569 642e 5555 4944 2862 6163 6b65  (uuid.UUID(backe
-0001c000: 6e64 2e6d 6f64 656c 5f75 7569 6429 2e76  nd.model_uuid).v
-0001c010: 6572 7369 6f6e 2c20 3429 0a0a 2020 2020  ersion, 4)..    
-0001c020: 6465 6620 7465 7374 5f73 7461 7475 735f  def test_status_
-0001c030: 7365 745f 6765 745f 756e 6974 2873 656c  set_get_unit(sel
-0001c040: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-0001c050: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-0001c060: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-0001c070: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-0001c080: 6d65 3a20 6170 700a 2020 2020 2020 2020  me: app.        
-0001c090: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-0001c0a0: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0001c0b0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-0001c0c0: 290a 2020 2020 2020 2020 6261 636b 656e  ).        backen
-0001c0d0: 6420 3d20 6861 726e 6573 732e 5f62 6163  d = harness._bac
-0001c0e0: 6b65 6e64 0a20 2020 2020 2020 2062 6163  kend.        bac
-0001c0f0: 6b65 6e64 2e73 7461 7475 735f 7365 7428  kend.status_set(
-0001c100: 2762 6c6f 636b 6564 272c 2027 6d65 7373  'blocked', 'mess
-0001c110: 6167 6527 2c20 6973 5f61 7070 3d46 616c  age', is_app=Fal
-0001c120: 7365 290a 2020 2020 2020 2020 7365 6c66  se).        self
-0001c130: 2e61 7373 6572 7445 7175 616c 280a 2020  .assertEqual(.  
-0001c140: 2020 2020 2020 2020 2020 6261 636b 656e            backen
-0001c150: 642e 7374 6174 7573 5f67 6574 2869 735f  d.status_get(is_
-0001c160: 6170 703d 4661 6c73 6529 2c0a 2020 2020  app=False),.    
-0001c170: 2020 2020 2020 2020 7b27 7374 6174 7573          {'status
-0001c180: 273a 2027 626c 6f63 6b65 6427 2c20 276d  ': 'blocked', 'm
-0001c190: 6573 7361 6765 273a 2027 6d65 7373 6167  essage': 'messag
-0001c1a0: 6527 7d29 0a20 2020 2020 2020 2073 656c  e'}).        sel
-0001c1b0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-0001c1c0: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-0001c1d0: 6e64 2e73 7461 7475 735f 6765 7428 6973  nd.status_get(is
-0001c1e0: 5f61 7070 3d54 7275 6529 2c0a 2020 2020  _app=True),.    
-0001c1f0: 2020 2020 2020 2020 7b27 7374 6174 7573          {'status
-0001c200: 273a 2027 756e 6b6e 6f77 6e27 2c20 276d  ': 'unknown', 'm
-0001c210: 6573 7361 6765 273a 2027 277d 290a 0a20  essage': ''}).. 
-0001c220: 2020 2064 6566 2074 6573 745f 7374 6174     def test_stat
-0001c230: 7573 5f73 6574 5f67 6574 5f61 7070 2873  us_set_get_app(s
-0001c240: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-0001c250: 726e 6573 7320 3d20 4861 726e 6573 7328  rness = Harness(
-0001c260: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-0001c270: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0001c280: 6e61 6d65 3a20 6170 700a 2020 2020 2020  name: app.      
-0001c290: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0001c2a0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0001c2b0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0001c2c0: 7570 290a 2020 2020 2020 2020 6261 636b  up).        back
-0001c2d0: 656e 6420 3d20 6861 726e 6573 732e 5f62  end = harness._b
-0001c2e0: 6163 6b65 6e64 0a20 2020 2020 2020 2062  ackend.        b
-0001c2f0: 6163 6b65 6e64 2e73 7461 7475 735f 7365  ackend.status_se
-0001c300: 7428 2762 6c6f 636b 6564 272c 2027 6d65  t('blocked', 'me
-0001c310: 7373 6167 6527 2c20 6973 5f61 7070 3d54  ssage', is_app=T
-0001c320: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-0001c330: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-0001c340: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-0001c350: 6e64 2e73 7461 7475 735f 6765 7428 6973  nd.status_get(is
-0001c360: 5f61 7070 3d54 7275 6529 2c0a 2020 2020  _app=True),.    
-0001c370: 2020 2020 2020 2020 7b27 7374 6174 7573          {'status
-0001c380: 273a 2027 626c 6f63 6b65 6427 2c20 276d  ': 'blocked', 'm
-0001c390: 6573 7361 6765 273a 2027 6d65 7373 6167  essage': 'messag
-0001c3a0: 6527 7d29 0a20 2020 2020 2020 2073 656c  e'}).        sel
-0001c3b0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
-0001c3c0: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
-0001c3d0: 6e64 2e73 7461 7475 735f 6765 7428 6973  nd.status_get(is
-0001c3e0: 5f61 7070 3d46 616c 7365 292c 0a20 2020  _app=False),.   
-0001c3f0: 2020 2020 2020 2020 207b 2773 7461 7475           {'statu
-0001c400: 7327 3a20 276d 6169 6e74 656e 616e 6365  s': 'maintenance
-0001c410: 272c 2027 6d65 7373 6167 6527 3a20 2727  ', 'message': ''
-0001c420: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
-0001c430: 5f72 656c 6174 696f 6e5f 6964 735f 756e  _relation_ids_un
-0001c440: 6b6e 6f77 6e5f 7265 6c61 7469 6f6e 2873  known_relation(s
-0001c450: 656c 6629 3a0a 2020 2020 2020 2020 6861  elf):.        ha
-0001c460: 726e 6573 7320 3d20 4861 726e 6573 7328  rness = Harness(
-0001c470: 4368 6172 6d42 6173 652c 206d 6574 613d  CharmBase, meta=
-0001c480: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0001c490: 6e61 6d65 3a20 7465 7374 2d63 6861 726d  name: test-charm
-0001c4a0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-0001c4b0: 7669 6465 733a 0a20 2020 2020 2020 2020  vides:.         
-0001c4c0: 2020 2020 2064 623a 0a20 2020 2020 2020       db:.       
-0001c4d0: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-0001c4e0: 6365 3a20 6d79 6462 0a20 2020 2020 2020  ce: mydb.       
-0001c4f0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0001c500: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0001c510: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0001c520: 7029 0a20 2020 2020 2020 2062 6163 6b65  p).        backe
-0001c530: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
-0001c540: 636b 656e 640a 2020 2020 2020 2020 2320  ckend.        # 
-0001c550: 5769 7468 206e 6f20 7265 6c61 7469 6f6e  With no relation
-0001c560: 7320 6164 6465 642c 2077 6520 6a75 7374  s added, we just
-0001c570: 2067 6574 2061 6e20 656d 7074 7920 6c69   get an empty li
-0001c580: 7374 2066 6f72 2074 6865 2069 6e74 6572  st for the inter
-0001c590: 6661 6365 0a20 2020 2020 2020 2073 656c  face.        sel
-0001c5a0: 662e 6173 7365 7274 4571 7561 6c28 6261  f.assertEqual(ba
-0001c5b0: 636b 656e 642e 7265 6c61 7469 6f6e 5f69  ckend.relation_i
-0001c5c0: 6473 2827 6462 2729 2c20 5b5d 290a 2020  ds('db'), []).  
-0001c5d0: 2020 2020 2020 2320 4275 7420 616e 2075        # But an u
-0001c5e0: 6e6b 6e6f 776e 2069 6e74 6572 6661 6365  nknown interface
-0001c5f0: 2072 6169 7365 7320 6120 4d6f 6465 6c45   raises a ModelE
-0001c600: 7272 6f72 0a20 2020 2020 2020 2077 6974  rror.        wit
-0001c610: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0001c620: 7365 7328 4d6f 6465 6c45 7272 6f72 293a  ses(ModelError):
-0001c630: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
-0001c640: 6b65 6e64 2e72 656c 6174 696f 6e5f 6964  kend.relation_id
-0001c650: 7328 2775 6e6b 6e6f 776e 2729 0a0a 2020  s('unknown')..  
-0001c660: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
-0001c670: 696f 6e5f 6765 745f 756e 6b6e 6f77 6e5f  ion_get_unknown_
-0001c680: 7265 6c61 7469 6f6e 5f69 6428 7365 6c66  relation_id(self
-0001c690: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0001c6a0: 7373 203d 2048 6172 6e65 7373 2843 6861  ss = Harness(Cha
-0001c6b0: 726d 4261 7365 2c20 6d65 7461 3d27 2727  rmBase, meta='''
-0001c6c0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0001c6d0: 653a 2074 6573 742d 6368 6172 6d0a 2020  e: test-charm.  
-0001c6e0: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-0001c6f0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0001c700: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0001c710: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-0001c720: 6261 636b 656e 6420 3d20 6861 726e 6573  backend = harnes
-0001c730: 732e 5f62 6163 6b65 6e64 0a20 2020 2020  s._backend.     
-0001c740: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0001c750: 6572 7452 6169 7365 7328 5265 6c61 7469  ertRaises(Relati
-0001c760: 6f6e 4e6f 7446 6f75 6e64 4572 726f 7229  onNotFoundError)
-0001c770: 3a0a 2020 2020 2020 2020 2020 2020 6261  :.            ba
-0001c780: 636b 656e 642e 7265 6c61 7469 6f6e 5f67  ckend.relation_g
-0001c790: 6574 2831 3233 342c 2027 756e 6974 2f30  et(1234, 'unit/0
-0001c7a0: 272c 2046 616c 7365 290a 0a20 2020 2064  ', False)..    d
-0001c7b0: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
-0001c7c0: 5f6c 6973 745f 756e 6b6e 6f77 6e5f 7265  _list_unknown_re
-0001c7d0: 6c61 7469 6f6e 5f69 6428 7365 6c66 293a  lation_id(self):
-0001c7e0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0001c7f0: 203d 2048 6172 6e65 7373 2843 6861 726d   = Harness(Charm
-0001c800: 4261 7365 2c20 6d65 7461 3d27 2727 0a20  Base, meta='''. 
-0001c810: 2020 2020 2020 2020 2020 206e 616d 653a             name:
-0001c820: 2074 6573 742d 6368 6172 6d0a 2020 2020   test-charm.    
-0001c830: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
-0001c840: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0001c850: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0001c860: 616e 7570 290a 2020 2020 2020 2020 6261  anup).        ba
-0001c870: 636b 656e 6420 3d20 6861 726e 6573 732e  ckend = harness.
-0001c880: 5f62 6163 6b65 6e64 0a20 2020 2020 2020  _backend.       
-0001c890: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0001c8a0: 7452 6169 7365 7328 5265 6c61 7469 6f6e  tRaises(Relation
-0001c8b0: 4e6f 7446 6f75 6e64 4572 726f 7229 3a0a  NotFoundError):.
-0001c8c0: 2020 2020 2020 2020 2020 2020 6261 636b              back
-0001c8d0: 656e 642e 7265 6c61 7469 6f6e 5f6c 6973  end.relation_lis
-0001c8e0: 7428 3132 3334 290a 0a20 2020 2064 6566  t(1234)..    def
-0001c8f0: 2074 6573 745f 6c61 7a79 5f72 6573 6f75   test_lazy_resou
-0001c900: 7263 655f 6469 7265 6374 6f72 7928 7365  rce_directory(se
-0001c910: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0001c920: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-0001c930: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-0001c940: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-0001c950: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-0001c960: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-0001c970: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-0001c980: 2020 2069 6d61 6765 3a0a 2020 2020 2020     image:.      
-0001c990: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
-0001c9a0: 6f63 692d 696d 6167 650a 2020 2020 2020  oci-image.      
-0001c9b0: 2020 2020 2020 2020 2020 6465 7363 7269            descri
-0001c9c0: 7074 696f 6e3a 2022 496d 6167 6520 746f  ption: "Image to
-0001c9d0: 2064 6570 6c6f 792e 220a 2020 2020 2020   deploy.".      
-0001c9e0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0001c9f0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0001ca00: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0001ca10: 7570 290a 2020 2020 2020 2020 6861 726e  up).        harn
-0001ca20: 6573 732e 706f 7075 6c61 7465 5f6f 6369  ess.populate_oci
-0001ca30: 5f72 6573 6f75 7263 6573 2829 0a20 2020  _resources().   
-0001ca40: 2020 2020 2062 6163 6b65 6e64 203d 2068       backend = h
-0001ca50: 6172 6e65 7373 2e5f 6261 636b 656e 640a  arness._backend.
-0001ca60: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0001ca70: 6572 7449 734e 6f6e 6528 6261 636b 656e  ertIsNone(backen
-0001ca80: 642e 5f72 6573 6f75 7263 655f 6469 7229  d._resource_dir)
-0001ca90: 0a20 2020 2020 2020 2070 6174 6820 3d20  .        path = 
-0001caa0: 6261 636b 656e 642e 7265 736f 7572 6365  backend.resource
-0001cab0: 5f67 6574 2827 696d 6167 6527 290a 2020  _get('image').  
-0001cac0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0001cad0: 7449 734e 6f74 4e6f 6e65 2862 6163 6b65  tIsNotNone(backe
-0001cae0: 6e64 2e5f 7265 736f 7572 6365 5f64 6972  nd._resource_dir
-0001caf0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001cb00: 7373 6572 7454 7275 6528 0a20 2020 2020  ssertTrue(.     
-0001cb10: 2020 2020 2020 2073 7472 2870 6174 6829         str(path)
-0001cb20: 2e73 7461 7274 7377 6974 6828 7374 7228  .startswith(str(
-0001cb30: 6261 636b 656e 642e 5f72 6573 6f75 7263  backend._resourc
-0001cb40: 655f 6469 722e 6e61 6d65 2929 2c0a 2020  e_dir.name)),.  
-0001cb50: 2020 2020 2020 2020 2020 6d73 673d 6627            msg=f'
-0001cb60: 6578 7065 6374 6564 207b 7061 7468 7d20  expected {path} 
-0001cb70: 746f 2062 6520 6120 7375 6264 6972 6563  to be a subdirec
-0001cb80: 746f 7279 206f 6620 7b62 6163 6b65 6e64  tory of {backend
-0001cb90: 2e5f 7265 736f 7572 6365 5f64 6972 2e6e  ._resource_dir.n
-0001cba0: 616d 657d 2729 0a0a 2020 2020 6465 6620  ame}')..    def 
-0001cbb0: 7465 7374 5f72 6573 6f75 7263 655f 6765  test_resource_ge
-0001cbc0: 745f 6e6f 5f72 6573 6f75 7263 6528 7365  t_no_resource(se
-0001cbd0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0001cbe0: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-0001cbf0: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-0001cc00: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-0001cc10: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-0001cc20: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-0001cc30: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-0001cc40: 2020 2069 6d61 6765 3a0a 2020 2020 2020     image:.      
-0001cc50: 2020 2020 2020 2020 2020 7479 7065 3a20            type: 
-0001cc60: 6669 6c65 0a20 2020 2020 2020 2020 2020  file.           
-0001cc70: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
-0001cc80: 3a20 2249 6d61 6765 2074 6f20 6465 706c  : "Image to depl
-0001cc90: 6f79 2e22 0a20 2020 2020 2020 2020 2020  oy.".           
-0001cca0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
-0001ccb0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-0001ccc0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
-0001ccd0: 2020 2020 2020 2062 6163 6b65 6e64 203d         backend =
-0001cce0: 2068 6172 6e65 7373 2e5f 6261 636b 656e   harness._backen
-0001ccf0: 640a 2020 2020 2020 2020 7769 7468 2073  d.        with s
-0001cd00: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-0001cd10: 284d 6f64 656c 4572 726f 7229 2061 7320  (ModelError) as 
-0001cd20: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
-0001cd30: 6261 636b 656e 642e 7265 736f 7572 6365  backend.resource
-0001cd40: 5f67 6574 2827 666f 6f27 290a 2020 2020  _get('foo').    
-0001cd50: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
-0001cd60: 6e28 0a20 2020 2020 2020 2020 2020 2022  n(.            "
-0001cd70: 756e 6974 732f 756e 6974 2d74 6573 742d  units/unit-test-
-0001cd80: 6170 702d 302f 7265 736f 7572 6365 732f  app-0/resources/
-0001cd90: 666f 6f3a 2072 6573 6f75 7263 6523 7465  foo: resource#te
-0001cda0: 7374 2d61 7070 2f66 6f6f 206e 6f74 2066  st-app/foo not f
-0001cdb0: 6f75 6e64 222c 0a20 2020 2020 2020 2020  ound",.         
-0001cdc0: 2020 2073 7472 2863 6d2e 6578 6365 7074     str(cm.except
-0001cdd0: 696f 6e29 290a 0a20 2020 2064 6566 2074  ion))..    def t
-0001cde0: 6573 745f 7265 6c61 7469 6f6e 5f72 656d  est_relation_rem
-0001cdf0: 6f74 655f 6170 705f 6e61 6d65 2873 656c  ote_app_name(sel
-0001ce00: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-0001ce10: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-0001ce20: 6172 6d42 6173 652c 206d 6574 613d 2727  armBase, meta=''
-0001ce30: 270a 2020 2020 2020 2020 2020 2020 6e61  '.            na
-0001ce40: 6d65 3a20 7465 7374 2d63 6861 726d 0a20  me: test-charm. 
-0001ce50: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-0001ce60: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-0001ce70: 2020 2020 6462 3a0a 2020 2020 2020 2020      db:.        
-0001ce80: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-0001ce90: 6365 3a20 666f 6f0a 2020 2020 2020 2020  ce: foo.        
-0001cea0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-0001ceb0: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
-0001cec0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
-0001ced0: 290a 2020 2020 2020 2020 6261 636b 656e  ).        backen
-0001cee0: 6420 3d20 6861 726e 6573 732e 5f62 6163  d = harness._bac
-0001cef0: 6b65 6e64 0a0a 2020 2020 2020 2020 7365  kend..        se
-0001cf00: 6c66 2e61 7373 6572 7449 7328 6261 636b  lf.assertIs(back
-0001cf10: 656e 642e 7265 6c61 7469 6f6e 5f72 656d  end.relation_rem
-0001cf20: 6f74 655f 6170 705f 6e61 6d65 2831 292c  ote_app_name(1),
-0001cf30: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
-0001cf40: 7265 6c5f 6964 203d 2068 6172 6e65 7373  rel_id = harness
-0001cf50: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
-0001cf60: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
-0001cf70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0001cf80: 7373 6572 7445 7175 616c 2862 6163 6b65  ssertEqual(backe
-0001cf90: 6e64 2e72 656c 6174 696f 6e5f 7265 6d6f  nd.relation_remo
-0001cfa0: 7465 5f61 7070 5f6e 616d 6528 7265 6c5f  te_app_name(rel_
-0001cfb0: 6964 292c 2027 706f 7374 6772 6573 716c  id), 'postgresql
-0001cfc0: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-0001cfd0: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-0001cfe0: 756e 6974 2872 656c 5f69 642c 2027 706f  unit(rel_id, 'po
-0001cff0: 7374 6772 6573 716c 2f30 2729 0a20 2020  stgresql/0').   
-0001d000: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
-0001d010: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-0001d020: 656c 5f69 642c 2027 706f 7374 6772 6573  el_id, 'postgres
-0001d030: 716c 2f31 2729 0a20 2020 2020 2020 2073  ql/1').        s
-0001d040: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d050: 6261 636b 656e 642e 7265 6c61 7469 6f6e  backend.relation
-0001d060: 5f72 656d 6f74 655f 6170 705f 6e61 6d65  _remote_app_name
-0001d070: 2872 656c 5f69 6429 2c20 2770 6f73 7467  (rel_id), 'postg
-0001d080: 7265 7371 6c27 290a 0a20 2020 2020 2020  resql')..       
-0001d090: 2073 656c 662e 6173 7365 7274 4973 2862   self.assertIs(b
-0001d0a0: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
-0001d0b0: 7265 6d6f 7465 5f61 7070 5f6e 616d 6528  remote_app_name(
-0001d0c0: 3729 2c20 4e6f 6e65 290a 0a20 2020 2064  7), None)..    d
-0001d0d0: 6566 2074 6573 745f 6765 745f 7065 6262  ef test_get_pebb
-0001d0e0: 6c65 5f6d 6574 686f 6473 2873 656c 6629  le_methods(self)
-0001d0f0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
-0001d100: 7320 3d20 4861 726e 6573 7328 4368 6172  s = Harness(Char
-0001d110: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
-0001d120: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0001d130: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
-0001d140: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-0001d150: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
-0001d160: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
-0001d170: 6e75 7029 0a20 2020 2020 2020 2062 6163  nup).        bac
-0001d180: 6b65 6e64 203d 2068 6172 6e65 7373 2e5f  kend = harness._
-0001d190: 6261 636b 656e 640a 0a20 2020 2020 2020  backend..       
-0001d1a0: 2063 6c69 656e 7420 3d20 6261 636b 656e   client = backen
-0001d1b0: 642e 6765 745f 7065 6262 6c65 2827 2f63  d.get_pebble('/c
-0001d1c0: 7573 746f 6d2f 736f 636b 6574 2f70 6174  ustom/socket/pat
-0001d1d0: 6827 290a 2020 2020 2020 2020 7365 6c66  h').        self
-0001d1e0: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-0001d1f0: 6528 636c 6965 6e74 2c20 5f54 6573 7469  e(client, _Testi
-0001d200: 6e67 5065 6262 6c65 436c 6965 6e74 290a  ngPebbleClient).
-0001d210: 0a0a 636c 6173 7320 5f54 6573 7469 6e67  ..class _Testing
-0001d220: 5065 6262 6c65 436c 6965 6e74 4d69 7869  PebbleClientMixi
-0001d230: 6e3a 0a20 2020 2064 6566 2067 6574 5f74  n:.    def get_t
-0001d240: 6573 7469 6e67 5f63 6c69 656e 7428 7365  esting_client(se
-0001d250: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0001d260: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-0001d270: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-0001d280: 2727 0a20 2020 2020 2020 2020 2020 206e  ''.            n
-0001d290: 616d 653a 2074 6573 742d 6170 700a 2020  ame: test-app.  
-0001d2a0: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
-0001d2b0: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
-0001d2c0: 2020 2020 6d79 636f 6e74 6169 6e65 723a      mycontainer:
-0001d2d0: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-0001d2e0: 2727 2729 0a20 2020 2020 2020 2073 656c  ''').        sel
-0001d2f0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
-0001d300: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
-0001d310: 2020 2020 2020 6261 636b 656e 6420 3d20        backend = 
-0001d320: 6861 726e 6573 732e 5f62 6163 6b65 6e64  harness._backend
-0001d330: 0a0a 2020 2020 2020 2020 636c 6965 6e74  ..        client
-0001d340: 203d 2062 6163 6b65 6e64 2e67 6574 5f70   = backend.get_p
-0001d350: 6562 626c 6528 272f 6368 6172 6d2f 636f  ebble('/charm/co
-0001d360: 6e74 6169 6e65 7273 2f6d 7963 6f6e 7461  ntainers/myconta
-0001d370: 696e 6572 2f70 6562 626c 652e 736f 636b  iner/pebble.sock
-0001d380: 6574 2729 0a20 2020 2020 2020 2068 6172  et').        har
-0001d390: 6e65 7373 2e73 6574 5f63 616e 5f63 6f6e  ness.set_can_con
-0001d3a0: 6e65 6374 2827 6d79 636f 6e74 6169 6e65  nect('mycontaine
-0001d3b0: 7227 2c20 5472 7565 290a 2020 2020 2020  r', True).      
-0001d3c0: 2020 7265 7475 726e 2063 6c69 656e 740a    return client.
-0001d3d0: 0a0a 2320 466f 7220 7465 7374 696e 6720  ..# For testing 
-0001d3e0: 6e6f 6e20 6669 6c65 206f 7073 206f 6620  non file ops of 
-0001d3f0: 7468 6520 7065 6262 6c65 2074 6573 7469  the pebble testi
-0001d400: 6e67 2063 6c69 656e 742e 0a63 6c61 7373  ng client..class
-0001d410: 2054 6573 7454 6573 7469 6e67 5065 6262   TestTestingPebb
-0001d420: 6c65 436c 6965 6e74 2875 6e69 7474 6573  leClient(unittes
-0001d430: 742e 5465 7374 4361 7365 2c20 5f54 6573  t.TestCase, _Tes
-0001d440: 7469 6e67 5065 6262 6c65 436c 6965 6e74  tingPebbleClient
-0001d450: 4d69 7869 6e29 3a0a 0a20 2020 2064 6566  Mixin):..    def
-0001d460: 2074 6573 745f 6d65 7468 6f64 735f 6d61   test_methods_ma
-0001d470: 7463 685f 7065 6262 6c65 5f63 6c69 656e  tch_pebble_clien
-0001d480: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-0001d490: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
-0001d4a0: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
-0001d4b0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0001d4c0: 2e61 7373 6572 7449 734e 6f74 4e6f 6e65  .assertIsNotNone
-0001d4d0: 2863 6c69 656e 7429 0a20 2020 2020 2020  (client).       
-0001d4e0: 2070 6562 626c 655f 636c 6965 6e74 5f6d   pebble_client_m
-0001d4f0: 6574 686f 6473 203d 2067 6574 5f70 7562  ethods = get_pub
-0001d500: 6c69 635f 6d65 7468 6f64 7328 7065 6262  lic_methods(pebb
-0001d510: 6c65 2e43 6c69 656e 7429 0a20 2020 2020  le.Client).     
-0001d520: 2020 2074 6573 7469 6e67 5f63 6c69 656e     testing_clien
-0001d530: 745f 6d65 7468 6f64 7320 3d20 6765 745f  t_methods = get_
-0001d540: 7075 626c 6963 5f6d 6574 686f 6473 2863  public_methods(c
-0001d550: 6c69 656e 7429 0a20 2020 2020 2020 2073  lient).        s
-0001d560: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0001d570: 7065 6262 6c65 5f63 6c69 656e 745f 6d65  pebble_client_me
-0001d580: 7468 6f64 732c 2074 6573 7469 6e67 5f63  thods, testing_c
-0001d590: 6c69 656e 745f 6d65 7468 6f64 7329 0a0a  lient_methods)..
-0001d5a0: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
-0001d5b0: 5f6c 6179 6572 2873 656c 6629 3a0a 2020  _layer(self):.  
-0001d5c0: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
-0001d5d0: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
-0001d5e0: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
-0001d5f0: 2070 6c61 6e20 3d20 636c 6965 6e74 2e67   plan = client.g
-0001d600: 6574 5f70 6c61 6e28 290a 2020 2020 2020  et_plan().      
-0001d610: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0001d620: 6e73 7461 6e63 6528 706c 616e 2c20 7065  nstance(plan, pe
-0001d630: 6262 6c65 2e50 6c61 6e29 0a20 2020 2020  bble.Plan).     
-0001d640: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001d650: 7561 6c28 277b 7d5c 6e27 2c20 706c 616e  ual('{}\n', plan
-0001d660: 2e74 6f5f 7961 6d6c 2829 290a 2020 2020  .to_yaml()).    
-0001d670: 2020 2020 636c 6965 6e74 2e61 6464 5f6c      client.add_l
-0001d680: 6179 6572 2827 666f 6f27 2c20 7065 6262  ayer('foo', pebb
-0001d690: 6c65 2e4c 6179 6572 2827 2727 5c0a 2020  le.Layer('''\.  
-0001d6a0: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
-0001d6b0: 793a 2046 6f6f 0a20 2020 2020 2020 2020  y: Foo.         
-0001d6c0: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-0001d6d0: 7c0a 2020 2020 2020 2020 2020 2020 2020  |.              
-0001d6e0: 4120 6c6f 6e67 6572 2064 6573 6372 6970  A longer descrip
-0001d6f0: 7469 6f6e 2061 626f 7574 2046 6f6f 0a20  tion about Foo. 
-0001d700: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-0001d710: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-0001d720: 2020 2073 6572 763a 0a20 2020 2020 2020     serv:.       
-0001d730: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-0001d740: 3a20 5365 7276 0a20 2020 2020 2020 2020  : Serv.         
-0001d750: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-0001d760: 6f6e 3a20 7c0a 2020 2020 2020 2020 2020  on: |.          
-0001d770: 2020 2020 2020 2020 4120 6465 7363 7269          A descri
-0001d780: 7074 696f 6e20 6162 6f75 7420 5365 7276  ption about Serv
-0001d790: 2074 6865 2061 6d61 7a69 6e67 2073 6572   the amazing ser
-0001d7a0: 7669 6365 2e0a 2020 2020 2020 2020 2020  vice..          
-0001d7b0: 2020 2020 2020 7374 6172 7475 703a 2065        startup: e
-0001d7c0: 6e61 626c 6564 0a20 2020 2020 2020 2020  nabled.         
-0001d7d0: 2020 2020 2020 206f 7665 7272 6964 653a         override:
-0001d7e0: 2072 6570 6c61 6365 0a20 2020 2020 2020   replace.       
-0001d7f0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-0001d800: 3a20 272f 6269 6e2f 6563 686f 2068 656c  : '/bin/echo hel
-0001d810: 6c6f 270a 2020 2020 2020 2020 2020 2020  lo'.            
-0001d820: 2020 2020 656e 7669 726f 6e6d 656e 743a      environment:
-0001d830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d840: 2020 204b 4559 3a20 5641 4c55 450a 2020     KEY: VALUE.  
-0001d850: 2020 2020 2020 2020 2020 2727 2729 290a            ''')).
-0001d860: 2020 2020 2020 2020 706c 616e 203d 2063          plan = c
-0001d870: 6c69 656e 742e 6765 745f 706c 616e 2829  lient.get_plan()
-0001d880: 0a20 2020 2020 2020 2023 2054 6865 2059  .        # The Y
-0001d890: 414d 4c20 7368 6f75 6c64 2062 6520 6e6f  AML should be no
-0001d8a0: 726d 616c 697a 6564 0a20 2020 2020 2020  rmalized.       
-0001d8b0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001d8c0: 6c28 7465 7874 7772 6170 2e64 6564 656e  l(textwrap.deden
-0001d8d0: 7428 2727 275c 0a20 2020 2020 2020 2020  t('''\.         
-0001d8e0: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
-0001d8f0: 2020 2020 2020 2020 2020 2073 6572 763a             serv:
-0001d900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d910: 2063 6f6d 6d61 6e64 3a20 2f62 696e 2f65   command: /bin/e
-0001d920: 6368 6f20 6865 6c6c 6f0a 2020 2020 2020  cho hello.      
-0001d930: 2020 2020 2020 2020 2020 6465 7363 7269            descri
-0001d940: 7074 696f 6e3a 2027 4120 6465 7363 7269  ption: 'A descri
-0001d950: 7074 696f 6e20 6162 6f75 7420 5365 7276  ption about Serv
-0001d960: 2074 6865 2061 6d61 7a69 6e67 2073 6572   the amazing ser
-0001d970: 7669 6365 2e0a 0a20 2020 2020 2020 2020  vice...         
-0001d980: 2020 2020 2020 2020 2027 0a20 2020 2020           '.     
-0001d990: 2020 2020 2020 2020 2020 2065 6e76 6972             envir
-0001d9a0: 6f6e 6d65 6e74 3a0a 2020 2020 2020 2020  onment:.        
-0001d9b0: 2020 2020 2020 2020 2020 4b45 593a 2056            KEY: V
-0001d9c0: 414c 5545 0a20 2020 2020 2020 2020 2020  ALUE.           
-0001d9d0: 2020 2020 206f 7665 7272 6964 653a 2072       override: r
-0001d9e0: 6570 6c61 6365 0a20 2020 2020 2020 2020  eplace.         
-0001d9f0: 2020 2020 2020 2073 7461 7274 7570 3a20         startup: 
-0001da00: 656e 6162 6c65 640a 2020 2020 2020 2020  enabled.        
-0001da10: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-0001da20: 2053 6572 760a 2020 2020 2020 2020 2020   Serv.          
-0001da30: 2020 2727 2729 2c20 706c 616e 2e74 6f5f    '''), plan.to_
-0001da40: 7961 6d6c 2829 290a 0a20 2020 2064 6566  yaml())..    def
-0001da50: 2074 6573 745f 6164 645f 6c61 7965 725f   test_add_layer_
-0001da60: 6d65 7267 6528 7365 6c66 293a 0a20 2020  merge(self):.   
-0001da70: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
-0001da80: 6c66 2e67 6574 5f74 6573 7469 6e67 5f63  lf.get_testing_c
-0001da90: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
-0001daa0: 706c 616e 203d 2063 6c69 656e 742e 6765  plan = client.ge
-0001dab0: 745f 706c 616e 2829 0a20 2020 2020 2020  t_plan().       
-0001dac0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0001dad0: 7374 616e 6365 2870 6c61 6e2c 2070 6562  stance(plan, peb
-0001dae0: 626c 652e 506c 616e 290a 2020 2020 2020  ble.Plan).      
-0001daf0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0001db00: 616c 2827 7b7d 5c6e 272c 2070 6c61 6e2e  al('{}\n', plan.
-0001db10: 746f 5f79 616d 6c28 2929 0a20 2020 2020  to_yaml()).     
-0001db20: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
-0001db30: 7965 7228 2766 6f6f 272c 2070 6562 626c  yer('foo', pebbl
-0001db40: 652e 4c61 7965 7228 2727 275c 0a20 2020  e.Layer('''\.   
-0001db50: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-0001db60: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
-0001db70: 2020 6465 7363 7269 7074 696f 6e3a 207c    description: |
-0001db80: 0a20 2020 2020 2020 2020 2020 2020 2041  .              A
-0001db90: 206c 6f6e 6765 7220 6465 7363 7269 7074   longer descript
-0001dba0: 696f 6e20 6162 6f75 7420 466f 6f0a 2020  ion about Foo.  
-0001dbb0: 2020 2020 2020 2020 2020 7365 7276 6963            servic
-0001dbc0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0001dbd0: 2020 7365 7276 3a0a 2020 2020 2020 2020    serv:.        
-0001dbe0: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-0001dbf0: 2053 6572 760a 2020 2020 2020 2020 2020   Serv.          
-0001dc00: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
-0001dc10: 6e3a 207c 0a20 2020 2020 2020 2020 2020  n: |.           
-0001dc20: 2020 2020 2020 2041 2064 6573 6372 6970         A descrip
-0001dc30: 7469 6f6e 2061 626f 7574 2053 6572 7620  tion about Serv 
-0001dc40: 7468 6520 616d 617a 696e 6720 7365 7276  the amazing serv
-0001dc50: 6963 652e 0a20 2020 2020 2020 2020 2020  ice..           
-0001dc60: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
-0001dc70: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
-0001dc80: 2020 2020 2020 6f76 6572 7269 6465 3a20        override: 
-0001dc90: 7265 706c 6163 650a 2020 2020 2020 2020  replace.        
-0001dca0: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-0001dcb0: 2027 2f62 696e 2f65 6368 6f20 6865 6c6c   '/bin/echo hell
-0001dcc0: 6f27 0a20 2020 2020 2020 2020 2020 2020  o'.             
-0001dcd0: 2020 2065 6e76 6972 6f6e 6d65 6e74 3a0a     environment:.
-0001dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dcf0: 2020 4b45 5931 3a20 5641 4c55 4531 0a20    KEY1: VALUE1. 
-0001dd00: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001dd10: 6674 6572 3a0a 2020 2020 2020 2020 2020  fter:.          
-0001dd20: 2020 2020 2020 2d20 7468 696e 6731 0a20        - thing1. 
-0001dd30: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001dd40: 6566 6f72 653a 0a20 2020 2020 2020 2020  efore:.         
-0001dd50: 2020 2020 2020 202d 2074 6869 6e67 310a         - thing1.
-0001dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd70: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
-0001dd80: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
-0001dd90: 6731 0a20 2020 2020 2020 2020 2020 2020  g1.             
-0001dda0: 2020 2075 7365 723a 2075 7365 7231 0a20     user: user1. 
-0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0001ddc0: 7365 722d 6964 3a20 7573 6572 4944 310a  ser-id: userID1.
-0001ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dde0: 6772 6f75 703a 2067 726f 7570 310a 2020  group: group1.  
-0001ddf0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-0001de00: 6f75 702d 6964 3a20 6772 6f75 7049 4431  oup-id: groupID1
-0001de10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001de20: 206f 6e2d 6661 696c 7572 653a 2074 6869   on-failure: thi
-0001de30: 6e67 310a 2020 2020 2020 2020 2020 2020  ng1.            
-0001de40: 2020 2020 6f6e 2d73 7563 6365 7373 3a20      on-success: 
-0001de50: 7468 696e 6731 0a20 2020 2020 2020 2020  thing1.         
-0001de60: 2020 2020 2020 206f 6e2d 6368 6563 6b2d         on-check-
-0001de70: 6661 696c 7572 653a 0a20 2020 2020 2020  failure:.       
-0001de80: 2020 2020 2020 2020 2020 204b 4559 313a             KEY1:
-0001de90: 2056 414c 5545 310a 2020 2020 2020 2020   VALUE1.        
-0001dea0: 2020 2020 2020 2020 6261 636b 6f66 662d          backoff-
-0001deb0: 6465 6c61 793a 2031 0a20 2020 2020 2020  delay: 1.       
-0001dec0: 2020 2020 2020 2020 2062 6163 6b6f 6666           backoff
-0001ded0: 2d66 6163 746f 723a 2032 0a20 2020 2020  -factor: 2.     
-0001dee0: 2020 2020 2020 2020 2020 2062 6163 6b6f             backo
-0001def0: 6666 2d6c 696d 6974 3a20 310a 2020 2020  ff-limit: 1.    
-0001df00: 2020 2020 2020 2020 2727 2729 290a 2020          ''')).  
-0001df10: 2020 2020 2020 706c 616e 203d 2063 6c69        plan = cli
-0001df20: 656e 742e 6765 745f 706c 616e 2829 0a20  ent.get_plan(). 
-0001df30: 2020 2020 2020 2023 2054 6865 2059 414d         # The YAM
-0001df40: 4c20 7368 6f75 6c64 2062 6520 6e6f 726d  L should be norm
-0001df50: 616c 697a 6564 0a20 2020 2020 2020 2073  alized.        s
-0001df60: 656c 662e 6d61 7844 6966 6620 3d20 4e6f  elf.maxDiff = No
-0001df70: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-0001df80: 6173 7365 7274 4571 7561 6c28 7465 7874  assertEqual(text
-0001df90: 7772 6170 2e64 6564 656e 7428 2727 275c  wrap.dedent('''\
-0001dfa0: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
-0001dfb0: 7669 6365 733a 0a20 2020 2020 2020 2020  vices:.         
-0001dfc0: 2020 2020 2073 6572 763a 0a20 2020 2020       serv:.     
-0001dfd0: 2020 2020 2020 2020 2020 2061 6674 6572             after
-0001dfe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001dff0: 2020 2d20 7468 696e 6731 0a20 2020 2020    - thing1.     
-0001e000: 2020 2020 2020 2020 2020 2062 6163 6b6f             backo
-0001e010: 6666 2d64 656c 6179 3a20 310a 2020 2020  ff-delay: 1.    
-0001e020: 2020 2020 2020 2020 2020 2020 6261 636b              back
-0001e030: 6f66 662d 6661 6374 6f72 3a20 320a 2020  off-factor: 2.  
-0001e040: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-0001e050: 636b 6f66 662d 6c69 6d69 743a 2031 0a20  ckoff-limit: 1. 
-0001e060: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001e070: 6566 6f72 653a 0a20 2020 2020 2020 2020  efore:.         
-0001e080: 2020 2020 2020 202d 2074 6869 6e67 310a         - thing1.
-0001e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0a0: 636f 6d6d 616e 643a 202f 6269 6e2f 6563  command: /bin/ec
-0001e0b0: 686f 2068 656c 6c6f 0a20 2020 2020 2020  ho hello.       
-0001e0c0: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
-0001e0d0: 7469 6f6e 3a20 2741 2064 6573 6372 6970  tion: 'A descrip
-0001e0e0: 7469 6f6e 2061 626f 7574 2053 6572 7620  tion about Serv 
-0001e0f0: 7468 6520 616d 617a 696e 6720 7365 7276  the amazing serv
-0001e100: 6963 652e 0a0a 2020 2020 2020 2020 2020  ice...          
-0001e110: 2020 2020 2020 2020 270a 2020 2020 2020          '.      
-0001e120: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
-0001e130: 6e6d 656e 743a 0a20 2020 2020 2020 2020  nment:.         
-0001e140: 2020 2020 2020 2020 204b 4559 313a 2056           KEY1: V
-0001e150: 414c 5545 310a 2020 2020 2020 2020 2020  ALUE1.          
-0001e160: 2020 2020 2020 6772 6f75 703a 2067 726f        group: gro
-0001e170: 7570 310a 2020 2020 2020 2020 2020 2020  up1.            
-0001e180: 2020 2020 6772 6f75 702d 6964 3a20 6772      group-id: gr
-0001e190: 6f75 7049 4431 0a20 2020 2020 2020 2020  oupID1.         
-0001e1a0: 2020 2020 2020 206f 6e2d 6368 6563 6b2d         on-check-
-0001e1b0: 6661 696c 7572 653a 0a20 2020 2020 2020  failure:.       
-0001e1c0: 2020 2020 2020 2020 2020 204b 4559 313a             KEY1:
-0001e1d0: 2056 414c 5545 310a 2020 2020 2020 2020   VALUE1.        
-0001e1e0: 2020 2020 2020 2020 6f6e 2d66 6169 6c75          on-failu
-0001e1f0: 7265 3a20 7468 696e 6731 0a20 2020 2020  re: thing1.     
-0001e200: 2020 2020 2020 2020 2020 206f 6e2d 7375             on-su
-0001e210: 6363 6573 733a 2074 6869 6e67 310a 2020  ccess: thing1.  
-0001e220: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
-0001e230: 6572 7269 6465 3a20 7265 706c 6163 650a  erride: replace.
-0001e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e250: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
-0001e260: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
-0001e270: 6731 0a20 2020 2020 2020 2020 2020 2020  g1.             
-0001e280: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
-0001e290: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
-0001e2a0: 2020 2020 7375 6d6d 6172 793a 2053 6572      summary: Ser
-0001e2b0: 760a 2020 2020 2020 2020 2020 2020 2020  v.              
-0001e2c0: 2020 7573 6572 3a20 7573 6572 310a 2020    user: user1.  
-0001e2d0: 2020 2020 2020 2020 2020 2020 2020 7573                us
-0001e2e0: 6572 2d69 643a 2075 7365 7249 4431 0a20  er-id: userID1. 
-0001e2f0: 2020 2020 2020 2020 2020 2027 2727 292c             '''),
-0001e300: 2070 6c61 6e2e 746f 5f79 616d 6c28 2929   plan.to_yaml())
-0001e310: 0a0a 2020 2020 2020 2020 636c 6965 6e74  ..        client
-0001e320: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
-0001e330: 2c20 7065 6262 6c65 2e4c 6179 6572 2827  , pebble.Layer('
-0001e340: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
-0001e350: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
-0001e360: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
-0001e370: 7469 6f6e 3a20 7c0a 2020 2020 2020 2020  tion: |.        
-0001e380: 2020 2020 2020 4120 6c6f 6e67 6572 2064        A longer d
-0001e390: 6573 6372 6970 7469 6f6e 2061 626f 7574  escription about
-0001e3a0: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
-0001e3b0: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
-0001e3c0: 2020 2020 2020 2020 2073 6572 763a 0a20           serv:. 
-0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001e3e0: 756d 6d61 7279 3a20 5365 7276 0a20 2020  ummary: Serv.   
-0001e3f0: 2020 2020 2020 2020 2020 2020 2064 6573               des
-0001e400: 6372 6970 7469 6f6e 3a20 7c0a 2020 2020  cription: |.    
-0001e410: 2020 2020 2020 2020 2020 2020 2020 4120                A 
-0001e420: 6e65 7720 6465 7363 7269 7074 696f 6e20  new description 
-0001e430: 6f66 2074 6865 2074 6865 2061 6d61 7a69  of the the amazi
-0001e440: 6e67 2053 6572 7620 7365 7276 6963 652e  ng Serv service.
-0001e450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e460: 2073 7461 7274 7570 3a20 656e 6162 6c65   startup: enable
-0001e470: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0001e480: 2020 6f76 6572 7269 6465 3a20 6d65 7267    override: merg
-0001e490: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001e4a0: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
-0001e4b0: 2f65 6368 6f20 6865 6c6c 6f27 0a20 2020  /echo hello'.   
-0001e4c0: 2020 2020 2020 2020 2020 2020 2065 6e76               env
-0001e4d0: 6972 6f6e 6d65 6e74 3a0a 2020 2020 2020  ironment:.      
-0001e4e0: 2020 2020 2020 2020 2020 2020 4b45 5931              KEY1
-0001e4f0: 3a20 5641 4c55 4534 0a20 2020 2020 2020  : VALUE4.       
-0001e500: 2020 2020 2020 2020 2020 204b 4559 323a             KEY2:
-0001e510: 2056 414c 5545 320a 2020 2020 2020 2020   VALUE2.        
-0001e520: 2020 2020 2020 2020 2020 4b45 5933 3a20            KEY3: 
-0001e530: 5641 4c55 4533 0a20 2020 2020 2020 2020  VALUE3.         
-0001e540: 2020 2020 2020 2061 6674 6572 3a0a 2020         after:.  
-0001e550: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
-0001e560: 7468 696e 6732 0a20 2020 2020 2020 2020  thing2.         
-0001e570: 2020 2020 2020 2062 6566 6f72 653a 0a20         before:. 
-0001e580: 2020 2020 2020 2020 2020 2020 2020 202d                 -
-0001e590: 2074 6869 6e67 320a 2020 2020 2020 2020   thing2.        
-0001e5a0: 2020 2020 2020 2020 7265 7175 6972 6573          requires
-0001e5b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e5c0: 2020 2d20 7468 696e 6732 0a20 2020 2020    - thing2.     
-0001e5d0: 2020 2020 2020 2020 2020 2075 7365 723a             user:
-0001e5e0: 2075 7365 7232 0a20 2020 2020 2020 2020   user2.         
-0001e5f0: 2020 2020 2020 2075 7365 722d 6964 3a20         user-id: 
-0001e600: 7573 6572 4944 320a 2020 2020 2020 2020  userID2.        
-0001e610: 2020 2020 2020 2020 6772 6f75 703a 2067          group: g
-0001e620: 726f 7570 320a 2020 2020 2020 2020 2020  roup2.          
-0001e630: 2020 2020 2020 6772 6f75 702d 6964 3a20        group-id: 
-0001e640: 6772 6f75 7049 4432 0a20 2020 2020 2020  groupID2.       
-0001e650: 2020 2020 2020 2020 206f 6e2d 7375 6363           on-succ
-0001e660: 6573 733a 2074 6869 6e67 320a 2020 2020  ess: thing2.    
-0001e670: 2020 2020 2020 2020 2020 2020 6f6e 2d66              on-f
-0001e680: 6169 6c75 7265 3a20 7468 696e 6732 0a20  ailure: thing2. 
-0001e690: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0001e6a0: 6e2d 6368 6563 6b2d 6661 696c 7572 653a  n-check-failure:
-0001e6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e6c0: 2020 204b 4559 313a 2056 414c 5545 340a     KEY1: VALUE4.
-0001e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6e0: 2020 4b45 5932 3a20 5641 4c55 4532 0a20    KEY2: VALUE2. 
-0001e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e700: 204b 4559 333a 2056 414c 5545 330a 2020   KEY3: VALUE3.  
-0001e710: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-0001e720: 636b 6f66 662d 6465 6c61 793a 2032 0a20  ckoff-delay: 2. 
-0001e730: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001e740: 6163 6b6f 6666 2d66 6163 746f 723a 2033  ackoff-factor: 3
-0001e750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e760: 2062 6163 6b6f 6666 2d6c 696d 6974 3a20   backoff-limit: 
-0001e770: 320a 2020 2020 2020 2020 2020 2020 2727  2.            ''
-0001e780: 2729 2c20 636f 6d62 696e 653d 5472 7565  '), combine=True
-0001e790: 290a 2020 2020 2020 2020 706c 616e 203d  ).        plan =
-0001e7a0: 2063 6c69 656e 742e 6765 745f 706c 616e   client.get_plan
-0001e7b0: 2829 0a20 2020 2020 2020 2023 2054 6865  ().        # The
-0001e7c0: 2059 414d 4c20 7368 6f75 6c64 2062 6520   YAML should be 
-0001e7d0: 6e6f 726d 616c 697a 6564 0a20 2020 2020  normalized.     
-0001e7e0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0001e7f0: 7561 6c28 7465 7874 7772 6170 2e64 6564  ual(textwrap.ded
-0001e800: 656e 7428 2727 275c 0a20 2020 2020 2020  ent('''\.       
-0001e810: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
-0001e820: 2020 2020 2020 2020 2020 2020 2073 6572               ser
-0001e830: 763a 0a20 2020 2020 2020 2020 2020 2020  v:.             
-0001e840: 2020 2061 6674 6572 3a0a 2020 2020 2020     after:.      
-0001e850: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
-0001e860: 6731 0a20 2020 2020 2020 2020 2020 2020  g1.             
-0001e870: 2020 202d 2074 6869 6e67 320a 2020 2020     - thing2.    
-0001e880: 2020 2020 2020 2020 2020 2020 6261 636b              back
-0001e890: 6f66 662d 6465 6c61 793a 2032 0a20 2020  off-delay: 2.   
-0001e8a0: 2020 2020 2020 2020 2020 2020 2062 6163               bac
-0001e8b0: 6b6f 6666 2d66 6163 746f 723a 2033 0a20  koff-factor: 3. 
-0001e8c0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001e8d0: 6163 6b6f 6666 2d6c 696d 6974 3a20 320a  ackoff-limit: 2.
-0001e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8f0: 6265 666f 7265 3a0a 2020 2020 2020 2020  before:.        
-0001e900: 2020 2020 2020 2020 2d20 7468 696e 6731          - thing1
-0001e910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e920: 202d 2074 6869 6e67 320a 2020 2020 2020   - thing2.      
-0001e930: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-0001e940: 643a 202f 6269 6e2f 6563 686f 2068 656c  d: /bin/echo hel
-0001e950: 6c6f 0a20 2020 2020 2020 2020 2020 2020  lo.             
-0001e960: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
-0001e970: 2741 206e 6577 2064 6573 6372 6970 7469  'A new descripti
-0001e980: 6f6e 206f 6620 7468 6520 7468 6520 616d  on of the the am
-0001e990: 617a 696e 6720 5365 7276 2073 6572 7669  azing Serv servi
-0001e9a0: 6365 2e0a 0a20 2020 2020 2020 2020 2020  ce...           
-0001e9b0: 2020 2020 2020 2027 0a20 2020 2020 2020         '.       
-0001e9c0: 2020 2020 2020 2020 2065 6e76 6972 6f6e           environ
-0001e9d0: 6d65 6e74 3a0a 2020 2020 2020 2020 2020  ment:.          
-0001e9e0: 2020 2020 2020 2020 4b45 5931 3a20 5641          KEY1: VA
-0001e9f0: 4c55 4534 0a20 2020 2020 2020 2020 2020  LUE4.           
-0001ea00: 2020 2020 2020 204b 4559 323a 2056 414c         KEY2: VAL
-0001ea10: 5545 320a 2020 2020 2020 2020 2020 2020  UE2.            
-0001ea20: 2020 2020 2020 4b45 5933 3a20 5641 4c55        KEY3: VALU
-0001ea30: 4533 0a20 2020 2020 2020 2020 2020 2020  E3.             
-0001ea40: 2020 2067 726f 7570 3a20 6772 6f75 7032     group: group2
-0001ea50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ea60: 2067 726f 7570 2d69 643a 2067 726f 7570   group-id: group
-0001ea70: 4944 320a 2020 2020 2020 2020 2020 2020  ID2.            
-0001ea80: 2020 2020 6f6e 2d63 6865 636b 2d66 6169      on-check-fai
-0001ea90: 6c75 7265 3a0a 2020 2020 2020 2020 2020  lure:.          
-0001eaa0: 2020 2020 2020 2020 4b45 5931 3a20 5641          KEY1: VA
-0001eab0: 4c55 4534 0a20 2020 2020 2020 2020 2020  LUE4.           
-0001eac0: 2020 2020 2020 204b 4559 323a 2056 414c         KEY2: VAL
-0001ead0: 5545 320a 2020 2020 2020 2020 2020 2020  UE2.            
-0001eae0: 2020 2020 2020 4b45 5933 3a20 5641 4c55        KEY3: VALU
-0001eaf0: 4533 0a20 2020 2020 2020 2020 2020 2020  E3.             
-0001eb00: 2020 206f 6e2d 6661 696c 7572 653a 2074     on-failure: t
-0001eb10: 6869 6e67 320a 2020 2020 2020 2020 2020  hing2.          
-0001eb20: 2020 2020 2020 6f6e 2d73 7563 6365 7373        on-success
-0001eb30: 3a20 7468 696e 6732 0a20 2020 2020 2020  : thing2.       
-0001eb40: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
-0001eb50: 653a 206d 6572 6765 0a20 2020 2020 2020  e: merge.       
-0001eb60: 2020 2020 2020 2020 2072 6571 7569 7265           require
-0001eb70: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0001eb80: 2020 202d 2074 6869 6e67 310a 2020 2020     - thing1.    
-0001eb90: 2020 2020 2020 2020 2020 2020 2d20 7468              - th
-0001eba0: 696e 6732 0a20 2020 2020 2020 2020 2020  ing2.           
-0001ebb0: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
-0001ebc0: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
-0001ebd0: 2020 2020 2020 7375 6d6d 6172 793a 2053        summary: S
-0001ebe0: 6572 760a 2020 2020 2020 2020 2020 2020  erv.            
-0001ebf0: 2020 2020 7573 6572 3a20 7573 6572 320a      user: user2.
-0001ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec10: 7573 6572 2d69 643a 2075 7365 7249 4432  user-id: userID2
-0001ec20: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-0001ec30: 292c 2070 6c61 6e2e 746f 5f79 616d 6c28  ), plan.to_yaml(
-0001ec40: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-0001ec50: 5f61 6464 5f6c 6179 6572 5f6e 6f74 5f63  _add_layer_not_c
-0001ec60: 6f6d 6269 6e65 6428 7365 6c66 293a 0a20  ombined(self):. 
-0001ec70: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-0001ec80: 7365 6c66 2e67 6574 5f74 6573 7469 6e67  self.get_testing
-0001ec90: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
-0001eca0: 2020 706c 616e 203d 2063 6c69 656e 742e    plan = client.
-0001ecb0: 6765 745f 706c 616e 2829 0a20 2020 2020  get_plan().     
-0001ecc0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0001ecd0: 496e 7374 616e 6365 2870 6c61 6e2c 2070  Instance(plan, p
-0001ece0: 6562 626c 652e 506c 616e 290a 2020 2020  ebble.Plan).    
-0001ecf0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0001ed00: 7175 616c 2827 7b7d 5c6e 272c 2070 6c61  qual('{}\n', pla
-0001ed10: 6e2e 746f 5f79 616d 6c28 2929 0a20 2020  n.to_yaml()).   
-0001ed20: 2020 2020 2073 6572 7669 6365 203d 2074       service = t
-0001ed30: 6578 7477 7261 702e 6465 6465 6e74 2827  extwrap.dedent('
-0001ed40: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
-0001ed50: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
-0001ed60: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
-0001ed70: 7469 6f6e 3a20 7c0a 2020 2020 2020 2020  tion: |.        
-0001ed80: 2020 2020 2020 4120 6c6f 6e67 6572 2064        A longer d
-0001ed90: 6573 6372 6970 7469 6f6e 2061 626f 7574  escription about
-0001eda0: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
-0001edb0: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
-0001edc0: 2020 2020 2020 2020 2073 6572 763a 0a20           serv:. 
-0001edd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001ede0: 756d 6d61 7279 3a20 5365 7276 0a20 2020  ummary: Serv.   
-0001edf0: 2020 2020 2020 2020 2020 2020 2064 6573               des
-0001ee00: 6372 6970 7469 6f6e 3a20 7c0a 2020 2020  cription: |.    
-0001ee10: 2020 2020 2020 2020 2020 2020 2020 4120                A 
-0001ee20: 6465 7363 7269 7074 696f 6e20 6162 6f75  description abou
-0001ee30: 7420 5365 7276 2074 6865 2061 6d61 7a69  t Serv the amazi
-0001ee40: 6e67 2073 6572 7669 6365 2e0a 2020 2020  ng service..    
-0001ee50: 2020 2020 2020 2020 2020 2020 7374 6172              star
-0001ee60: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
-0001ee70: 2020 2020 2020 2020 2020 2020 206f 7665               ove
-0001ee80: 7272 6964 653a 2072 6570 6c61 6365 0a20  rride: replace. 
-0001ee90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001eea0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-0001eeb0: 686f 2068 656c 6c6f 270a 2020 2020 2020  ho hello'.      
-0001eec0: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
-0001eed0: 6e6d 656e 743a 0a20 2020 2020 2020 2020  nment:.         
-0001eee0: 2020 2020 2020 2020 204b 4559 3a20 5641           KEY: VA
-0001eef0: 4c55 450a 2020 2020 2020 2020 2020 2020  LUE.            
-0001ef00: 2727 2729 0a20 2020 2020 2020 2063 6c69  ''').        cli
-0001ef10: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
-0001ef20: 6f6f 272c 2070 6562 626c 652e 4c61 7965  oo', pebble.Laye
-0001ef30: 7228 7365 7276 6963 6529 290a 2020 2020  r(service)).    
-0001ef40: 2020 2020 2320 544f 444f 3a20 6a61 6d20      # TODO: jam 
-0001ef50: 3230 3231 2d30 342d 3139 2057 6520 7368  2021-04-19 We sh
-0001ef60: 6f75 6c64 2068 6176 6520 6120 636c 6561  ould have a clea
-0001ef70: 7265 7220 6572 726f 7220 7479 7065 2066  rer error type f
-0001ef80: 6f72 2074 6869 7320 6361 7365 2e20 5468  or this case. Th
-0001ef90: 6520 6163 7475 616c 0a20 2020 2020 2020  e actual.       
-0001efa0: 2023 2020 7065 6262 6c65 2072 6169 7365   #  pebble raise
-0001efb0: 7320 616e 2048 5454 5020 6578 6365 7074  s an HTTP except
-0001efc0: 696f 6e2e 2053 6565 2068 7474 7073 3a2f  ion. See https:/
-0001efd0: 2f67 6974 6875 622e 636f 6d2f 6361 6e6f  /github.com/cano
-0001efe0: 6e69 6361 6c2f 6f70 6572 6174 6f72 2f69  nical/operator/i
-0001eff0: 7373 7565 732f 3531 340a 2020 2020 2020  ssues/514.      
-0001f000: 2020 2320 2074 6861 7420 7468 6973 2073    #  that this s
-0001f010: 686f 756c 6420 6265 2063 6c65 616e 6564  hould be cleaned
-0001f020: 2075 7020 696e 746f 2061 2063 6c65 6172   up into a clear
-0001f030: 6572 2065 7272 6f72 2074 7970 652c 2068  er error type, h
-0001f040: 6f77 6576 6572 2c20 7468 6579 2073 686f  owever, they sho
-0001f050: 756c 6420 6765 7420 616e 0a20 2020 2020  uld get an.     
-0001f060: 2020 2023 2020 6572 726f 720a 2020 2020     #  error.    
-0001f070: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-0001f080: 7365 7274 5261 6973 6573 2852 756e 7469  sertRaises(Runti
-0001f090: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-0001f0a0: 2020 2020 2020 636c 6965 6e74 2e61 6464        client.add
-0001f0b0: 5f6c 6179 6572 2827 666f 6f27 2c20 7065  _layer('foo', pe
-0001f0c0: 6262 6c65 2e4c 6179 6572 2873 6572 7669  bble.Layer(servi
-0001f0d0: 6365 2929 0a0a 2020 2020 6465 6620 7465  ce))..    def te
-0001f0e0: 7374 5f61 6464 5f6c 6179 6572 5f74 6872  st_add_layer_thr
-0001f0f0: 6565 5f73 6572 7669 6365 7328 7365 6c66  ee_services(self
-0001f100: 293a 0a20 2020 2020 2020 2063 6c69 656e  ):.        clien
-0001f110: 7420 3d20 7365 6c66 2e67 6574 5f74 6573  t = self.get_tes
-0001f120: 7469 6e67 5f63 6c69 656e 7428 290a 2020  ting_client().  
-0001f130: 2020 2020 2020 636c 6965 6e74 2e61 6464        client.add
-0001f140: 5f6c 6179 6572 2827 666f 6f27 2c20 2727  _layer('foo', ''
-0001f150: 275c 0a20 2020 2020 2020 2020 2020 2073  '\.            s
-0001f160: 756d 6d61 7279 3a20 666f 6f0a 2020 2020  ummary: foo.    
-0001f170: 2020 2020 2020 2020 7365 7276 6963 6573          services
-0001f180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f190: 666f 6f3a 0a20 2020 2020 2020 2020 2020  foo:.           
-0001f1a0: 2020 2020 2073 756d 6d61 7279 3a20 466f       summary: Fo
-0001f1b0: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
-0001f1c0: 2020 7374 6172 7475 703a 2065 6e61 626c    startup: enabl
-0001f1d0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-0001f1e0: 2020 206f 7665 7272 6964 653a 2072 6570     override: rep
-0001f1f0: 6c61 6365 0a20 2020 2020 2020 2020 2020  lace.           
-0001f200: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
-0001f210: 6269 6e2f 6563 686f 2066 6f6f 270a 2020  bin/echo foo'.  
-0001f220: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
-0001f230: 2020 2020 2020 2063 6c69 656e 742e 6164         client.ad
-0001f240: 645f 6c61 7965 7228 2762 6172 272c 2027  d_layer('bar', '
-0001f250: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
-0001f260: 7375 6d6d 6172 793a 2062 6172 0a20 2020  summary: bar.   
-0001f270: 2020 2020 2020 2020 2073 6572 7669 6365           service
-0001f280: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0001f290: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
-0001f2a0: 2020 2020 2020 7375 6d6d 6172 793a 2054        summary: T
-0001f2b0: 6865 2047 7265 6174 2042 6172 0a20 2020  he Great Bar.   
-0001f2c0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0001f2d0: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
-0001f2e0: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
-0001f2f0: 6572 7269 6465 3a20 7265 706c 6163 650a  erride: replace.
-0001f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f310: 636f 6d6d 616e 643a 2027 2f62 696e 2f65  command: '/bin/e
-0001f320: 6368 6f20 6261 7227 0a20 2020 2020 2020  cho bar'.       
-0001f330: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-0001f340: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
-0001f350: 6572 2827 6261 7a27 2c20 2727 275c 0a20  er('baz', '''\. 
-0001f360: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-0001f370: 7279 3a20 6261 7a0a 2020 2020 2020 2020  ry: baz.        
-0001f380: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
-0001f390: 2020 2020 2020 2020 2020 2020 6261 7a3a              baz:
-0001f3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f3b0: 2073 756d 6d61 7279 3a20 4e6f 7420 4261   summary: Not Ba
-0001f3c0: 722c 2062 7574 2042 617a 0a20 2020 2020  r, but Baz.     
-0001f3d0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-0001f3e0: 7570 3a20 656e 6162 6c65 640a 2020 2020  up: enabled.    
-0001f3f0: 2020 2020 2020 2020 2020 2020 6f76 6572              over
-0001f400: 7269 6465 3a20 7265 706c 6163 650a 2020  ride: replace.  
-0001f410: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001f420: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
-0001f430: 6f20 6261 7a27 0a20 2020 2020 2020 2020  o baz'.         
-0001f440: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-0001f450: 706c 616e 203d 2063 6c69 656e 742e 6765  plan = client.ge
-0001f460: 745f 706c 616e 2829 0a20 2020 2020 2020  t_plan().       
-0001f470: 2073 656c 662e 6d61 7844 6966 6620 3d20   self.maxDiff = 
-0001f480: 3130 3030 0a20 2020 2020 2020 2023 2041  1000.        # A
-0001f490: 6c70 6861 6265 7469 6361 6c20 7365 7276  lphabetical serv
-0001f4a0: 6963 6573 2c20 616e 6420 7468 6520 5941  ices, and the YA
-0001f4b0: 4d4c 2073 686f 756c 6420 6265 206e 6f72  ML should be nor
-0001f4c0: 6d61 6c69 7a65 640a 2020 2020 2020 2020  malized.        
-0001f4d0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0001f4e0: 2874 6578 7477 7261 702e 6465 6465 6e74  (textwrap.dedent
-0001f4f0: 2827 2727 5c0a 2020 2020 2020 2020 2020  ('''\.          
-0001f500: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
-0001f510: 2020 2020 2020 2020 2020 6261 723a 0a20            bar:. 
-0001f520: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001f530: 6f6d 6d61 6e64 3a20 2f62 696e 2f65 6368  ommand: /bin/ech
-0001f540: 6f20 6261 720a 2020 2020 2020 2020 2020  o bar.          
-0001f550: 2020 2020 2020 6f76 6572 7269 6465 3a20        override: 
-0001f560: 7265 706c 6163 650a 2020 2020 2020 2020  replace.        
-0001f570: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
-0001f580: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
-0001f590: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-0001f5a0: 3a20 5468 6520 4772 6561 7420 4261 720a  : The Great Bar.
-0001f5b0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-0001f5c0: 7a3a 0a20 2020 2020 2020 2020 2020 2020  z:.             
-0001f5d0: 2020 2063 6f6d 6d61 6e64 3a20 2f62 696e     command: /bin
-0001f5e0: 2f65 6368 6f20 6261 7a0a 2020 2020 2020  /echo baz.      
-0001f5f0: 2020 2020 2020 2020 2020 6f76 6572 7269            overri
-0001f600: 6465 3a20 7265 706c 6163 650a 2020 2020  de: replace.    
-0001f610: 2020 2020 2020 2020 2020 2020 7374 6172              star
-0001f620: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
-0001f630: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-0001f640: 6d61 7279 3a20 4e6f 7420 4261 722c 2062  mary: Not Bar, b
-0001f650: 7574 2042 617a 0a20 2020 2020 2020 2020  ut Baz.         
-0001f660: 2020 2020 2066 6f6f 3a0a 2020 2020 2020       foo:.      
-0001f670: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-0001f680: 643a 202f 6269 6e2f 6563 686f 2066 6f6f  d: /bin/echo foo
-0001f690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f6a0: 206f 7665 7272 6964 653a 2072 6570 6c61   override: repla
-0001f6b0: 6365 0a20 2020 2020 2020 2020 2020 2020  ce.             
-0001f6c0: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
-0001f6d0: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
-0001f6e0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-0001f6f0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-0001f700: 292c 2070 6c61 6e2e 746f 5f79 616d 6c28  ), plan.to_yaml(
-0001f710: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-0001f720: 5f61 6464 5f6c 6179 6572 5f63 6f6d 6269  _add_layer_combi
-0001f730: 6e65 5f6e 6f5f 6f76 6572 7269 6465 2873  ne_no_override(s
-0001f740: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
-0001f750: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
-0001f760: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
-0001f770: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
-0001f780: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
-0001f790: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
-0001f7a0: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
-0001f7b0: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-0001f7c0: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-0001f7d0: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
-0001f7e0: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-0001f7f0: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
-0001f800: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-0001f810: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
-0001f820: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0001f830: 2020 2023 2054 4f44 4f3a 206a 616d 2032     # TODO: jam 2
-0001f840: 3032 312d 3034 2d31 3920 5065 6262 6c65  021-04-19 Pebble
-0001f850: 2063 7572 7265 6e74 6c79 2072 6169 7365   currently raise
-0001f860: 7320 6120 4854 5450 2045 7272 6f72 2035  s a HTTP Error 5
-0001f870: 3030 2049 6e74 6572 6e61 6c20 5365 7276  00 Internal Serv
-0001f880: 6963 6520 4572 726f 720a 2020 2020 2020  ice Error.      
-0001f890: 2020 2320 2069 6620 796f 7520 646f 6e27    #  if you don'
-0001f8a0: 7420 7375 7070 6c79 2061 6e20 6f76 6572  t supply an over
-0001f8b0: 7269 6465 2064 6972 6563 7469 7665 2e20  ride directive. 
-0001f8c0: 5468 6174 206e 6565 6473 2074 6f20 6265  That needs to be
-0001f8d0: 2066 6978 6564 2061 6e64 2074 6869 7320   fixed and this 
-0001f8e0: 7465 7374 0a20 2020 2020 2020 2023 2020  test.        #  
-0001f8f0: 7368 6f75 6c64 2062 6520 7570 6461 7465  should be update
-0001f900: 642e 2068 7474 7073 3a2f 2f67 6974 6875  d. https://githu
-0001f910: 622e 636f 6d2f 6361 6e6f 6e69 6361 6c2f  b.com/canonical/
-0001f920: 6f70 6572 6174 6f72 2f69 7373 7565 732f  operator/issues/
-0001f930: 3531 340a 2020 2020 2020 2020 7769 7468  514.        with
-0001f940: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-0001f950: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-0001f960: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-0001f970: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
-0001f980: 666f 6f27 2c20 2727 275c 0a20 2020 2020  foo', '''\.     
-0001f990: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-0001f9a0: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
-0001f9b0: 2020 2020 2020 2020 7365 7276 6963 6573          services
-0001f9c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f9d0: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
-0001f9e0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-0001f9f0: 6d61 7279 3a20 466f 6f0a 2020 2020 2020  mary: Foo.      
-0001fa00: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001fa10: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
-0001fa20: 6f20 666f 6f27 0a20 2020 2020 2020 2020  o foo'.         
-0001fa30: 2020 2020 2020 2027 2727 2c20 636f 6d62         ''', comb
-0001fa40: 696e 653d 5472 7565 290a 0a20 2020 2064  ine=True)..    d
-0001fa50: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
-0001fa60: 725f 636f 6d62 696e 655f 6f76 6572 7269  r_combine_overri
-0001fa70: 6465 5f72 6570 6c61 6365 2873 656c 6629  de_replace(self)
-0001fa80: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
-0001fa90: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
-0001faa0: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
-0001fab0: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
-0001fac0: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
-0001fad0: 5c0a 2020 2020 2020 2020 2020 2020 7375  \.            su
-0001fae0: 6d6d 6172 793a 2066 6f6f 0a20 2020 2020  mmary: foo.     
-0001faf0: 2020 2020 2020 2073 6572 7669 6365 733a         services:
-0001fb00: 0a20 2020 2020 2020 2020 2020 2020 2062  .              b
-0001fb10: 6172 3a0a 2020 2020 2020 2020 2020 2020  ar:.            
-0001fb20: 2020 2020 7375 6d6d 6172 793a 2042 6172      summary: Bar
-0001fb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fb40: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-0001fb50: 6563 686f 2062 6172 270a 2020 2020 2020  echo bar'.      
-0001fb60: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
-0001fb70: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-0001fb80: 6d61 7279 3a20 466f 6f0a 2020 2020 2020  mary: Foo.      
-0001fb90: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-0001fba0: 643a 2027 2f62 696e 2f65 6368 6f20 666f  d: '/bin/echo fo
-0001fbb0: 6f27 0a20 2020 2020 2020 2020 2020 2027  o'.            '
-0001fbc0: 2727 290a 2020 2020 2020 2020 636c 6965  '').        clie
-0001fbd0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
-0001fbe0: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
-0001fbf0: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
-0001fc00: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
-0001fc10: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
-0001fc20: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
-0001fc30: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
-0001fc40: 6e64 3a20 272f 6269 6e2f 6563 686f 2066  nd: '/bin/echo f
-0001fc50: 6f6f 206e 6577 270a 2020 2020 2020 2020  oo new'.        
-0001fc60: 2020 2020 2020 2020 6f76 6572 7269 6465          override
-0001fc70: 3a20 7265 706c 6163 650a 2020 2020 2020  : replace.      
-0001fc80: 2020 2020 2020 2727 272c 2063 6f6d 6269        ''', combi
-0001fc90: 6e65 3d54 7275 6529 0a20 2020 2020 2020  ne=True).       
-0001fca0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0001fcb0: 6c28 7465 7874 7772 6170 2e64 6564 656e  l(textwrap.deden
-0001fcc0: 7428 2727 275c 0a20 2020 2020 2020 2020  t('''\.         
-0001fcd0: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
-0001fce0: 2020 2020 2020 2020 2020 2062 6172 3a0a             bar:.
-0001fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd00: 636f 6d6d 616e 643a 202f 6269 6e2f 6563  command: /bin/ec
-0001fd10: 686f 2062 6172 0a20 2020 2020 2020 2020  ho bar.         
-0001fd20: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
-0001fd30: 4261 720a 2020 2020 2020 2020 2020 2020  Bar.            
-0001fd40: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
-0001fd50: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
-0001fd60: 2f62 696e 2f65 6368 6f20 666f 6f20 6e65  /bin/echo foo ne
-0001fd70: 770a 2020 2020 2020 2020 2020 2020 2020  w.              
-0001fd80: 2020 6f76 6572 7269 6465 3a20 7265 706c    override: repl
-0001fd90: 6163 650a 2020 2020 2020 2020 2020 2020  ace.            
-0001fda0: 2727 2729 2c20 636c 6965 6e74 2e67 6574  '''), client.get
-0001fdb0: 5f70 6c61 6e28 292e 746f 5f79 616d 6c28  _plan().to_yaml(
-0001fdc0: 2929 0a0a 2020 2020 6465 6620 7465 7374  ))..    def test
-0001fdd0: 5f61 6464 5f6c 6179 6572 5f63 6f6d 6269  _add_layer_combi
-0001fde0: 6e65 5f6f 7665 7272 6964 655f 6d65 7267  ne_override_merg
-0001fdf0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-0001fe00: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
-0001fe10: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
-0001fe20: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
-0001fe30: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
-0001fe40: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
-0001fe50: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
-0001fe60: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
-0001fe70: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
-0001fe80: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
-0001fe90: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-0001fea0: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
-0001feb0: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-0001fec0: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
-0001fed0: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
-0001fee0: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
-0001fef0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-0001ff00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ff10: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-0001ff20: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
-0001ff30: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-0001ff40: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
-0001ff50: 7965 7228 2766 6f6f 272c 2027 2727 5c0a  yer('foo', '''\.
-0001ff60: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-0001ff70: 6172 793a 2066 6f6f 0a20 2020 2020 2020  ary: foo.       
-0001ff80: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
-0001ff90: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
-0001ffa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ffb0: 2020 7375 6d6d 6172 793a 2046 6f6f 0a20    summary: Foo. 
-0001ffc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001ffd0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-0001ffe0: 686f 2066 6f6f 6227 0a20 2020 2020 2020  ho foob'.       
-0001fff0: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
-00020000: 653a 206d 6572 6765 0a20 2020 2020 2020  e: merge.       
-00020010: 2020 2020 2027 2727 2c20 636f 6d62 696e       ''', combin
-00020020: 653d 5472 7565 290a 2020 2020 2020 2020  e=True).        
-00020030: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00020040: 2874 6578 7477 7261 702e 6465 6465 6e74  (textwrap.dedent
-00020050: 2827 2727 5c0a 2020 2020 2020 2020 2020  ('''\.          
-00020060: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
-00020070: 2020 2020 2020 2020 2020 6261 723a 0a20            bar:. 
-00020080: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00020090: 6f6d 6d61 6e64 3a20 2f62 696e 2f65 6368  ommand: /bin/ech
-000200a0: 6f20 6261 720a 2020 2020 2020 2020 2020  o bar.          
-000200b0: 2020 2020 2020 7375 6d6d 6172 793a 2042        summary: B
-000200c0: 6172 0a20 2020 2020 2020 2020 2020 2020  ar.             
-000200d0: 2066 6f6f 3a0a 2020 2020 2020 2020 2020   foo:.          
-000200e0: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
-000200f0: 6269 6e2f 6563 686f 2066 6f6f 620a 2020  bin/echo foob.  
-00020100: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
-00020110: 6572 7269 6465 3a20 6d65 7267 650a 2020  erride: merge.  
-00020120: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00020130: 6d6d 6172 793a 2046 6f6f 0a20 2020 2020  mmary: Foo.     
-00020140: 2020 2020 2020 2027 2727 292c 2063 6c69         '''), cli
-00020150: 656e 742e 6765 745f 706c 616e 2829 2e74  ent.get_plan().t
-00020160: 6f5f 7961 6d6c 2829 290a 0a20 2020 2064  o_yaml())..    d
-00020170: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
-00020180: 725f 636f 6d62 696e 655f 6f76 6572 7269  r_combine_overri
-00020190: 6465 5f75 6e6b 6e6f 776e 2873 656c 6629  de_unknown(self)
-000201a0: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
-000201b0: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
-000201c0: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
-000201d0: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
-000201e0: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
-000201f0: 5c0a 2020 2020 2020 2020 2020 2020 7375  \.            su
-00020200: 6d6d 6172 793a 2066 6f6f 0a20 2020 2020  mmary: foo.     
-00020210: 2020 2020 2020 2073 6572 7669 6365 733a         services:
-00020220: 0a20 2020 2020 2020 2020 2020 2020 2062  .              b
-00020230: 6172 3a0a 2020 2020 2020 2020 2020 2020  ar:.            
-00020240: 2020 2020 7375 6d6d 6172 793a 2042 6172      summary: Bar
-00020250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020260: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-00020270: 6563 686f 2062 6172 270a 2020 2020 2020  echo bar'.      
-00020280: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
-00020290: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-000202a0: 6d61 7279 3a20 466f 6f0a 2020 2020 2020  mary: Foo.      
-000202b0: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-000202c0: 643a 2027 2f62 696e 2f65 6368 6f20 666f  d: '/bin/echo fo
-000202d0: 6f27 0a20 2020 2020 2020 2020 2020 2027  o'.            '
-000202e0: 2727 290a 2020 2020 2020 2020 7769 7468  '').        with
-000202f0: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00020300: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
-00020310: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00020320: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
-00020330: 666f 6f27 2c20 2727 275c 0a20 2020 2020  foo', '''\.     
-00020340: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00020350: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
-00020360: 2020 2020 2020 2020 7365 7276 6963 6573          services
-00020370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020380: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
-00020390: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-000203a0: 6d61 7279 3a20 466f 6f0a 2020 2020 2020  mary: Foo.      
-000203b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000203c0: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
-000203d0: 6f20 666f 6f62 270a 2020 2020 2020 2020  o foob'.        
-000203e0: 2020 2020 2020 2020 2020 2020 6f76 6572              over
-000203f0: 7269 6465 3a20 626c 6168 0a20 2020 2020  ride: blah.     
-00020400: 2020 2020 2020 2020 2020 2027 2727 2c20             ''', 
-00020410: 636f 6d62 696e 653d 5472 7565 290a 0a20  combine=True).. 
-00020420: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-00020430: 7365 7276 6963 6573 5f6e 6f6e 6528 7365  services_none(se
-00020440: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
-00020450: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
-00020460: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
-00020470: 2020 2020 2020 2020 7365 7276 6963 655f          service_
-00020480: 696e 666f 203d 2063 6c69 656e 742e 6765  info = client.ge
-00020490: 745f 7365 7276 6963 6573 2829 0a20 2020  t_services().   
-000204a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000204b0: 4571 7561 6c28 5b5d 2c20 7365 7276 6963  Equal([], servic
-000204c0: 655f 696e 666f 290a 0a20 2020 2064 6566  e_info)..    def
-000204d0: 2074 6573 745f 6765 745f 7365 7276 6963   test_get_servic
-000204e0: 6573 5f6e 6f74 5f73 7461 7274 6564 2873  es_not_started(s
-000204f0: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
-00020500: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
-00020510: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
-00020520: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
-00020530: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
-00020540: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
-00020550: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
-00020560: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-00020570: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-00020580: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
-00020590: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
-000205a0: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
-000205b0: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
-000205c0: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
-000205d0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
-000205e0: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
-000205f0: 2020 2020 2020 2020 2020 2020 2062 6172               bar
-00020600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020610: 2020 7375 6d6d 6172 793a 2042 6172 0a20    summary: Bar. 
-00020620: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00020630: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-00020640: 686f 2062 6172 270a 2020 2020 2020 2020  ho bar'.        
-00020650: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00020660: 2069 6e66 6f73 203d 2063 6c69 656e 742e   infos = client.
-00020670: 6765 745f 7365 7276 6963 6573 2829 0a20  get_services(). 
-00020680: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00020690: 7274 4571 7561 6c28 6c65 6e28 696e 666f  rtEqual(len(info
-000206a0: 7329 2c20 3229 0a20 2020 2020 2020 2062  s), 2).        b
-000206b0: 6172 5f69 6e66 6f20 3d20 696e 666f 735b  ar_info = infos[
-000206c0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-000206d0: 6173 7365 7274 4571 7561 6c28 2762 6172  assertEqual('bar
-000206e0: 272c 2062 6172 5f69 6e66 6f2e 6e61 6d65  ', bar_info.name
-000206f0: 290a 2020 2020 2020 2020 2320 4465 6661  ).        # Defa
-00020700: 756c 7420 7768 656e 206e 6f74 2073 7065  ult when not spe
-00020710: 6369 6669 6564 2069 7320 4449 5341 424c  cified is DISABL
-00020720: 4544 0a20 2020 2020 2020 2073 656c 662e  ED.        self.
-00020730: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
-00020740: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
-00020750: 702e 4449 5341 424c 4544 2c20 6261 725f  p.DISABLED, bar_
-00020760: 696e 666f 2e73 7461 7274 7570 290a 2020  info.startup).  
-00020770: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00020780: 7445 7175 616c 2870 6562 626c 652e 5365  tEqual(pebble.Se
-00020790: 7276 6963 6553 7461 7475 732e 494e 4143  rviceStatus.INAC
-000207a0: 5449 5645 2c20 6261 725f 696e 666f 2e63  TIVE, bar_info.c
-000207b0: 7572 7265 6e74 290a 2020 2020 2020 2020  urrent).        
-000207c0: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
-000207d0: 2862 6172 5f69 6e66 6f2e 6973 5f72 756e  (bar_info.is_run
-000207e0: 6e69 6e67 2829 290a 2020 2020 2020 2020  ning()).        
-000207f0: 666f 6f5f 696e 666f 203d 2069 6e66 6f73  foo_info = infos
-00020800: 5b31 5d0a 2020 2020 2020 2020 7365 6c66  [1].        self
-00020810: 2e61 7373 6572 7445 7175 616c 2827 666f  .assertEqual('fo
-00020820: 6f27 2c20 666f 6f5f 696e 666f 2e6e 616d  o', foo_info.nam
-00020830: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00020840: 6173 7365 7274 4571 7561 6c28 7065 6262  assertEqual(pebb
-00020850: 6c65 2e53 6572 7669 6365 5374 6172 7475  le.ServiceStartu
-00020860: 702e 454e 4142 4c45 442c 2066 6f6f 5f69  p.ENABLED, foo_i
-00020870: 6e66 6f2e 7374 6172 7475 7029 0a20 2020  nfo.startup).   
-00020880: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00020890: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
-000208a0: 7669 6365 5374 6174 7573 2e49 4e41 4354  viceStatus.INACT
-000208b0: 4956 452c 2066 6f6f 5f69 6e66 6f2e 6375  IVE, foo_info.cu
-000208c0: 7272 656e 7429 0a20 2020 2020 2020 2073  rrent).        s
-000208d0: 656c 662e 6173 7365 7274 4661 6c73 6528  elf.assertFalse(
-000208e0: 666f 6f5f 696e 666f 2e69 735f 7275 6e6e  foo_info.is_runn
-000208f0: 696e 6728 2929 0a0a 2020 2020 6465 6620  ing())..    def 
-00020900: 7465 7374 5f67 6574 5f73 6572 7669 6365  test_get_service
-00020910: 735f 6175 746f 7374 6172 7428 7365 6c66  s_autostart(self
-00020920: 293a 0a20 2020 2020 2020 2063 6c69 656e  ):.        clien
-00020930: 7420 3d20 7365 6c66 2e67 6574 5f74 6573  t = self.get_tes
-00020940: 7469 6e67 5f63 6c69 656e 7428 290a 2020  ting_client().  
-00020950: 2020 2020 2020 636c 6965 6e74 2e61 6464        client.add
-00020960: 5f6c 6179 6572 2827 666f 6f27 2c20 2727  _layer('foo', ''
-00020970: 275c 0a20 2020 2020 2020 2020 2020 2073  '\.            s
-00020980: 756d 6d61 7279 3a20 666f 6f0a 2020 2020  ummary: foo.    
-00020990: 2020 2020 2020 2020 7365 7276 6963 6573          services
-000209a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000209b0: 666f 6f3a 0a20 2020 2020 2020 2020 2020  foo:.           
-000209c0: 2020 2020 2073 756d 6d61 7279 3a20 466f       summary: Fo
-000209d0: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
-000209e0: 2020 7374 6172 7475 703a 2065 6e61 626c    startup: enabl
-000209f0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-00020a00: 2020 2063 6f6d 6d61 6e64 3a20 272f 6269     command: '/bi
-00020a10: 6e2f 6563 686f 2066 6f6f 270a 2020 2020  n/echo foo'.    
-00020a20: 2020 2020 2020 2020 2020 6261 723a 0a20            bar:. 
-00020a30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00020a40: 756d 6d61 7279 3a20 4261 720a 2020 2020  ummary: Bar.    
-00020a50: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-00020a60: 616e 643a 2027 2f62 696e 2f65 6368 6f20  and: '/bin/echo 
-00020a70: 6261 7227 0a20 2020 2020 2020 2020 2020  bar'.           
-00020a80: 2027 2727 290a 2020 2020 2020 2020 636c   ''').        cl
-00020a90: 6965 6e74 2e61 7574 6f73 7461 7274 5f73  ient.autostart_s
-00020aa0: 6572 7669 6365 7328 290a 2020 2020 2020  ervices().      
-00020ab0: 2020 696e 666f 7320 3d20 636c 6965 6e74    infos = client
-00020ac0: 2e67 6574 5f73 6572 7669 6365 7328 290a  .get_services().
-00020ad0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00020ae0: 6572 7445 7175 616c 286c 656e 2869 6e66  ertEqual(len(inf
-00020af0: 6f73 292c 2032 290a 2020 2020 2020 2020  os), 2).        
-00020b00: 6261 725f 696e 666f 203d 2069 6e66 6f73  bar_info = infos
-00020b10: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
-00020b20: 2e61 7373 6572 7445 7175 616c 2827 6261  .assertEqual('ba
-00020b30: 7227 2c20 6261 725f 696e 666f 2e6e 616d  r', bar_info.nam
-00020b40: 6529 0a20 2020 2020 2020 2023 2044 6566  e).        # Def
-00020b50: 6175 6c74 2077 6865 6e20 6e6f 7420 7370  ault when not sp
-00020b60: 6563 6966 6965 6420 6973 2044 4953 4142  ecified is DISAB
-00020b70: 4c45 440a 2020 2020 2020 2020 7365 6c66  LED.        self
-00020b80: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-00020b90: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
-00020ba0: 7570 2e44 4953 4142 4c45 442c 2062 6172  up.DISABLED, bar
-00020bb0: 5f69 6e66 6f2e 7374 6172 7475 7029 0a20  _info.startup). 
-00020bc0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00020bd0: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
-00020be0: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
-00020bf0: 4354 4956 452c 2062 6172 5f69 6e66 6f2e  CTIVE, bar_info.
-00020c00: 6375 7272 656e 7429 0a20 2020 2020 2020  current).       
-00020c10: 2073 656c 662e 6173 7365 7274 4661 6c73   self.assertFals
-00020c20: 6528 6261 725f 696e 666f 2e69 735f 7275  e(bar_info.is_ru
-00020c30: 6e6e 696e 6728 2929 0a20 2020 2020 2020  nning()).       
-00020c40: 2066 6f6f 5f69 6e66 6f20 3d20 696e 666f   foo_info = info
-00020c50: 735b 315d 0a20 2020 2020 2020 2073 656c  s[1].        sel
-00020c60: 662e 6173 7365 7274 4571 7561 6c28 2766  f.assertEqual('f
-00020c70: 6f6f 272c 2066 6f6f 5f69 6e66 6f2e 6e61  oo', foo_info.na
-00020c80: 6d65 290a 2020 2020 2020 2020 7365 6c66  me).        self
-00020c90: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-00020ca0: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
-00020cb0: 7570 2e45 4e41 424c 4544 2c20 666f 6f5f  up.ENABLED, foo_
-00020cc0: 696e 666f 2e73 7461 7274 7570 290a 2020  info.startup).  
-00020cd0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00020ce0: 7445 7175 616c 2870 6562 626c 652e 5365  tEqual(pebble.Se
-00020cf0: 7276 6963 6553 7461 7475 732e 4143 5449  rviceStatus.ACTI
-00020d00: 5645 2c20 666f 6f5f 696e 666f 2e63 7572  VE, foo_info.cur
-00020d10: 7265 6e74 290a 2020 2020 2020 2020 7365  rent).        se
-00020d20: 6c66 2e61 7373 6572 7454 7275 6528 666f  lf.assertTrue(fo
-00020d30: 6f5f 696e 666f 2e69 735f 7275 6e6e 696e  o_info.is_runnin
-00020d40: 6728 2929 0a0a 2020 2020 6465 6620 7465  g())..    def te
-00020d50: 7374 5f67 6574 5f73 6572 7669 6365 735f  st_get_services_
-00020d60: 7374 6172 745f 7374 6f70 2873 656c 6629  start_stop(self)
-00020d70: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
-00020d80: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
-00020d90: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
-00020da0: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
-00020db0: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
-00020dc0: 5c0a 2020 2020 2020 2020 2020 2020 7375  \.            su
-00020dd0: 6d6d 6172 793a 2066 6f6f 0a20 2020 2020  mmary: foo.     
-00020de0: 2020 2020 2020 2073 6572 7669 6365 733a         services:
-00020df0: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
-00020e00: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
-00020e10: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-00020e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020e30: 2073 7461 7274 7570 3a20 656e 6162 6c65   startup: enable
-00020e40: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00020e50: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
-00020e60: 2f65 6368 6f20 666f 6f27 0a20 2020 2020  /echo foo'.     
-00020e70: 2020 2020 2020 2020 2062 6172 3a0a 2020           bar:.  
-00020e80: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00020e90: 6d6d 6172 793a 2042 6172 0a20 2020 2020  mmary: Bar.     
-00020ea0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
-00020eb0: 6e64 3a20 272f 6269 6e2f 6563 686f 2062  nd: '/bin/echo b
-00020ec0: 6172 270a 2020 2020 2020 2020 2020 2020  ar'.            
-00020ed0: 2727 2729 0a20 2020 2020 2020 2063 6c69  ''').        cli
-00020ee0: 656e 742e 7374 6172 745f 7365 7276 6963  ent.start_servic
-00020ef0: 6573 285b 2762 6172 275d 290a 2020 2020  es(['bar']).    
-00020f00: 2020 2020 696e 666f 7320 3d20 636c 6965      infos = clie
-00020f10: 6e74 2e67 6574 5f73 6572 7669 6365 7328  nt.get_services(
-00020f20: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00020f30: 7373 6572 7445 7175 616c 286c 656e 2869  ssertEqual(len(i
-00020f40: 6e66 6f73 292c 2032 290a 2020 2020 2020  nfos), 2).      
-00020f50: 2020 6261 725f 696e 666f 203d 2069 6e66    bar_info = inf
-00020f60: 6f73 5b30 5d0a 2020 2020 2020 2020 7365  os[0].        se
-00020f70: 6c66 2e61 7373 6572 7445 7175 616c 2827  lf.assertEqual('
-00020f80: 6261 7227 2c20 6261 725f 696e 666f 2e6e  bar', bar_info.n
-00020f90: 616d 6529 0a20 2020 2020 2020 2023 2045  ame).        # E
-00020fa0: 7665 6e20 7468 6f75 6768 2062 6172 2064  ven though bar d
-00020fb0: 6566 6175 6c74 7320 746f 2044 4953 4142  efaults to DISAB
-00020fc0: 4c45 442c 2077 6520 6578 706c 6963 6974  LED, we explicit
-00020fd0: 6c79 2073 7461 7274 6564 2069 740a 2020  ly started it.  
-00020fe0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00020ff0: 7445 7175 616c 2870 6562 626c 652e 5365  tEqual(pebble.Se
-00021000: 7276 6963 6553 7461 7274 7570 2e44 4953  rviceStartup.DIS
-00021010: 4142 4c45 442c 2062 6172 5f69 6e66 6f2e  ABLED, bar_info.
-00021020: 7374 6172 7475 7029 0a20 2020 2020 2020  startup).       
-00021030: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00021040: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
-00021050: 5374 6174 7573 2e41 4354 4956 452c 2062  Status.ACTIVE, b
-00021060: 6172 5f69 6e66 6f2e 6375 7272 656e 7429  ar_info.current)
-00021070: 0a20 2020 2020 2020 2023 2066 6f6f 2077  .        # foo w
-00021080: 6f75 6c64 2062 6520 7374 6172 7465 6420  ould be started 
-00021090: 6279 2061 7574 6f73 7461 7274 2c20 6275  by autostart, bu
-000210a0: 7420 7765 206f 6e6c 7920 6361 6c6c 6564  t we only called
-000210b0: 2073 7461 7274 5f73 6572 7669 6365 730a   start_services.
-000210c0: 2020 2020 2020 2020 666f 6f5f 696e 666f          foo_info
-000210d0: 203d 2069 6e66 6f73 5b31 5d0a 2020 2020   = infos[1].    
-000210e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000210f0: 7175 616c 2827 666f 6f27 2c20 666f 6f5f  qual('foo', foo_
-00021100: 696e 666f 2e6e 616d 6529 0a20 2020 2020  info.name).     
-00021110: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00021120: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-00021130: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
-00021140: 442c 2066 6f6f 5f69 6e66 6f2e 7374 6172  D, foo_info.star
-00021150: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
-00021160: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00021170: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-00021180: 7573 2e49 4e41 4354 4956 452c 2066 6f6f  us.INACTIVE, foo
-00021190: 5f69 6e66 6f2e 6375 7272 656e 7429 0a20  _info.current). 
-000211a0: 2020 2020 2020 2063 6c69 656e 742e 7374         client.st
-000211b0: 6f70 5f73 6572 7669 6365 7328 5b27 6261  op_services(['ba
-000211c0: 7227 5d29 0a20 2020 2020 2020 2069 6e66  r']).        inf
-000211d0: 6f73 203d 2063 6c69 656e 742e 6765 745f  os = client.get_
-000211e0: 7365 7276 6963 6573 2829 0a20 2020 2020  services().     
-000211f0: 2020 2062 6172 5f69 6e66 6f20 3d20 696e     bar_info = in
-00021200: 666f 735b 305d 0a20 2020 2020 2020 2073  fos[0].        s
-00021210: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00021220: 2762 6172 272c 2062 6172 5f69 6e66 6f2e  'bar', bar_info.
-00021230: 6e61 6d65 290a 2020 2020 2020 2020 7365  name).        se
-00021240: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-00021250: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
-00021260: 7274 7570 2e44 4953 4142 4c45 442c 2062  rtup.DISABLED, b
-00021270: 6172 5f69 6e66 6f2e 7374 6172 7475 7029  ar_info.startup)
-00021280: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00021290: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
-000212a0: 2e53 6572 7669 6365 5374 6174 7573 2e49  .ServiceStatus.I
-000212b0: 4e41 4354 4956 452c 2062 6172 5f69 6e66  NACTIVE, bar_inf
-000212c0: 6f2e 6375 7272 656e 7429 0a0a 2020 2020  o.current)..    
-000212d0: 6465 6620 7465 7374 5f67 6574 5f73 6572  def test_get_ser
-000212e0: 7669 6365 735f 6261 645f 7265 7175 6573  vices_bad_reques
-000212f0: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00021300: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
-00021310: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
-00021320: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
-00021330: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
-00021340: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
-00021350: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
-00021360: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
-00021370: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
-00021380: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
-00021390: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-000213a0: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
-000213b0: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
-000213c0: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
-000213d0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-000213e0: 3a20 272f 6269 6e2f 6563 686f 2066 6f6f  : '/bin/echo foo
-000213f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00021400: 6261 723a 0a20 2020 2020 2020 2020 2020  bar:.           
-00021410: 2020 2020 2073 756d 6d61 7279 3a20 4261       summary: Ba
-00021420: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00021430: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
-00021440: 2f65 6368 6f20 6261 7227 0a20 2020 2020  /echo bar'.     
-00021450: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
-00021460: 2020 2020 2320 4974 2069 7320 6120 636f      # It is a co
-00021470: 6d6d 6f6e 206d 6973 7461 6b65 2074 6f20  mmon mistake to 
-00021480: 7061 7373 206a 7573 7420 6120 6e61 6d65  pass just a name
-00021490: 2076 7320 6120 6c69 7374 206f 6620 6e61   vs a list of na
-000214a0: 6d65 732c 2073 6f20 6361 7463 6820 6974  mes, so catch it
-000214b0: 2077 6974 6820 610a 2020 2020 2020 2020   with a.        
-000214c0: 2320 5479 7065 4572 726f 720a 2020 2020  # TypeError.    
-000214d0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-000214e0: 7365 7274 5261 6973 6573 2854 7970 6545  sertRaises(TypeE
-000214f0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00021500: 2020 2063 6c69 656e 742e 6765 745f 7365     client.get_se
-00021510: 7276 6963 6573 2827 666f 6f27 290a 0a20  rvices('foo').. 
-00021520: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-00021530: 7365 7276 6963 6573 5f73 7562 7365 7428  services_subset(
-00021540: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
-00021550: 6c69 656e 7420 3d20 7365 6c66 2e67 6574  lient = self.get
-00021560: 5f74 6573 7469 6e67 5f63 6c69 656e 7428  _testing_client(
-00021570: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-00021580: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
-00021590: 2c20 2727 275c 0a20 2020 2020 2020 2020  , '''\.         
-000215a0: 2020 2073 756d 6d61 7279 3a20 666f 6f0a     summary: foo.
-000215b0: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-000215c0: 6963 6573 3a0a 2020 2020 2020 2020 2020  ices:.          
-000215d0: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
-000215e0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
-000215f0: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
-00021600: 2020 2020 2020 7374 6172 7475 703a 2065        startup: e
-00021610: 6e61 626c 6564 0a20 2020 2020 2020 2020  nabled.         
-00021620: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
-00021630: 272f 6269 6e2f 6563 686f 2066 6f6f 270a  '/bin/echo foo'.
-00021640: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00021650: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00021660: 2020 2073 756d 6d61 7279 3a20 4261 720a     summary: Bar.
-00021670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021680: 636f 6d6d 616e 643a 2027 2f62 696e 2f65  command: '/bin/e
-00021690: 6368 6f20 6261 7227 0a20 2020 2020 2020  cho bar'.       
-000216a0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-000216b0: 2020 696e 666f 7320 3d20 636c 6965 6e74    infos = client
-000216c0: 2e67 6574 5f73 6572 7669 6365 7328 5b27  .get_services(['
-000216d0: 666f 6f27 5d29 0a20 2020 2020 2020 2073  foo']).        s
-000216e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-000216f0: 6c65 6e28 696e 666f 7329 2c20 3129 0a20  len(infos), 1). 
-00021700: 2020 2020 2020 2066 6f6f 5f69 6e66 6f20         foo_info 
-00021710: 3d20 696e 666f 735b 305d 0a20 2020 2020  = infos[0].     
-00021720: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00021730: 7561 6c28 2766 6f6f 272c 2066 6f6f 5f69  ual('foo', foo_i
-00021740: 6e66 6f2e 6e61 6d65 290a 2020 2020 2020  nfo.name).      
-00021750: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00021760: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
-00021770: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
-00021780: 2c20 666f 6f5f 696e 666f 2e73 7461 7274  , foo_info.start
-00021790: 7570 290a 2020 2020 2020 2020 7365 6c66  up).        self
-000217a0: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-000217b0: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
-000217c0: 732e 494e 4143 5449 5645 2c20 666f 6f5f  s.INACTIVE, foo_
-000217d0: 696e 666f 2e63 7572 7265 6e74 290a 0a20  info.current).. 
-000217e0: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
-000217f0: 7365 7276 6963 6573 5f75 6e6b 6e6f 776e  services_unknown
-00021800: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00021810: 636c 6965 6e74 203d 2073 656c 662e 6765  client = self.ge
-00021820: 745f 7465 7374 696e 675f 636c 6965 6e74  t_testing_client
-00021830: 2829 0a20 2020 2020 2020 2063 6c69 656e  ().        clien
-00021840: 742e 6164 645f 6c61 7965 7228 2766 6f6f  t.add_layer('foo
-00021850: 272c 2027 2727 5c0a 2020 2020 2020 2020  ', '''\.        
-00021860: 2020 2020 7375 6d6d 6172 793a 2066 6f6f      summary: foo
-00021870: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
-00021880: 7669 6365 733a 0a20 2020 2020 2020 2020  vices:.         
-00021890: 2020 2020 2066 6f6f 3a0a 2020 2020 2020       foo:.      
-000218a0: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
-000218b0: 793a 2046 6f6f 0a20 2020 2020 2020 2020  y: Foo.         
-000218c0: 2020 2020 2020 2073 7461 7274 7570 3a20         startup: 
-000218d0: 656e 6162 6c65 640a 2020 2020 2020 2020  enabled.        
-000218e0: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-000218f0: 2027 2f62 696e 2f65 6368 6f20 666f 6f27   '/bin/echo foo'
-00021900: 0a20 2020 2020 2020 2020 2020 2020 2062  .              b
-00021910: 6172 3a0a 2020 2020 2020 2020 2020 2020  ar:.            
-00021920: 2020 2020 7375 6d6d 6172 793a 2042 6172      summary: Bar
-00021930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021940: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
-00021950: 6563 686f 2062 6172 270a 2020 2020 2020  echo bar'.      
-00021960: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
-00021970: 2020 2023 2054 6869 7320 646f 6573 6e27     # This doesn'
-00021980: 7420 7365 656d 2074 6f20 6265 2061 6e20  t seem to be an 
-00021990: 6572 726f 7220 6174 2074 6865 206d 6f6d  error at the mom
-000219a0: 656e 742e 0a20 2020 2020 2020 2023 2070  ent..        # p
-000219b0: 6562 626c 655f 636c 692e 7079 2073 6572  ebble_cli.py ser
-000219c0: 7669 6365 206a 7573 7420 7265 7475 726e  vice just return
-000219d0: 7320 616e 2065 6d70 7479 206c 6973 740a  s an empty list.
-000219e0: 2020 2020 2020 2020 2320 7065 6262 6c65          # pebble
-000219f0: 2073 6572 7669 6365 2075 6e6b 6e6f 776e   service unknown
-00021a00: 2073 6179 7320 224e 6f20 6d61 7463 6869   says "No matchi
-00021a10: 6e67 2073 6572 7669 6365 7322 2028 6275  ng services" (bu
-00021a20: 7420 6578 6974 7320 3029 0a20 2020 2020  t exits 0).     
-00021a30: 2020 2069 6e66 6f73 203d 2063 6c69 656e     infos = clien
-00021a40: 742e 6765 745f 7365 7276 6963 6573 285b  t.get_services([
-00021a50: 2775 6e6b 6e6f 776e 275d 290a 2020 2020  'unknown']).    
-00021a60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00021a70: 7175 616c 2869 6e66 6f73 2c20 5b5d 290a  qual(infos, []).
-00021a80: 0a20 2020 2064 6566 2074 6573 745f 696e  .    def test_in
-00021a90: 7661 6c69 645f 7374 6172 745f 7365 7276  valid_start_serv
-00021aa0: 6963 6528 7365 6c66 293a 0a20 2020 2020  ice(self):.     
-00021ab0: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00021ac0: 2e67 6574 5f74 6573 7469 6e67 5f63 6c69  .get_testing_cli
-00021ad0: 656e 7428 290a 2020 2020 2020 2020 2320  ent().        # 
-00021ae0: 544f 444f 3a20 6a61 6d20 3230 3231 2d30  TODO: jam 2021-0
-00021af0: 342d 3230 2054 6869 7320 7368 6f75 6c64  4-20 This should
-00021b00: 2062 6563 6f6d 6520 6120 6265 7474 6572   become a better
-00021b10: 2065 7272 6f72 0a20 2020 2020 2020 2077   error.        w
-00021b20: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-00021b30: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-00021b40: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00021b50: 2063 6c69 656e 742e 7374 6172 745f 7365   client.start_se
-00021b60: 7276 6963 6573 285b 2775 6e6b 6e6f 776e  rvices(['unknown
-00021b70: 275d 290a 0a20 2020 2064 6566 2074 6573  '])..    def tes
-00021b80: 745f 7374 6172 745f 7365 7276 6963 655f  t_start_service_
-00021b90: 7374 7228 7365 6c66 293a 0a20 2020 2020  str(self):.     
-00021ba0: 2020 2023 2053 7461 7274 2073 6572 7669     # Start servi
-00021bb0: 6365 2074 616b 6573 2061 206c 6973 7420  ce takes a list 
-00021bc0: 6f66 206e 616d 6573 2c20 6275 7420 6974  of names, but it
-00021bd0: 2069 7320 7265 616c 6c79 2065 6173 7920   is really easy 
-00021be0: 746f 2061 6363 6964 656e 7461 6c6c 7920  to accidentally 
-00021bf0: 7061 7373 206a 7573 7420 610a 2020 2020  pass just a.    
-00021c00: 2020 2020 2320 6e61 6d65 0a20 2020 2020      # name.     
-00021c10: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00021c20: 2e67 6574 5f74 6573 7469 6e67 5f63 6c69  .get_testing_cli
-00021c30: 656e 7428 290a 2020 2020 2020 2020 7769  ent().        wi
-00021c40: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00021c50: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
-00021c60: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00021c70: 656e 742e 7374 6172 745f 7365 7276 6963  ent.start_servic
-00021c80: 6573 2827 756e 6b6e 6f77 6e27 290a 0a20  es('unknown').. 
-00021c90: 2020 2064 6566 2074 6573 745f 7374 6f70     def test_stop
-00021ca0: 5f73 6572 7669 6365 5f73 7472 2873 656c  _service_str(sel
-00021cb0: 6629 3a0a 2020 2020 2020 2020 2320 5374  f):.        # St
-00021cc0: 6172 7420 7365 7276 6963 6520 7461 6b65  art service take
-00021cd0: 7320 6120 6c69 7374 206f 6620 6e61 6d65  s a list of name
-00021ce0: 732c 2062 7574 2069 7420 6973 2072 6561  s, but it is rea
-00021cf0: 6c6c 7920 6561 7379 2074 6f20 6163 6369  lly easy to acci
-00021d00: 6465 6e74 616c 6c79 2070 6173 7320 6a75  dentally pass ju
-00021d10: 7374 2061 0a20 2020 2020 2020 2023 206e  st a.        # n
-00021d20: 616d 650a 2020 2020 2020 2020 636c 6965  ame.        clie
-00021d30: 6e74 203d 2073 656c 662e 6765 745f 7465  nt = self.get_te
-00021d40: 7374 696e 675f 636c 6965 6e74 2829 0a20  sting_client(). 
-00021d50: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00021d60: 2e61 7373 6572 7452 6169 7365 7328 5479  .assertRaises(Ty
-00021d70: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
-00021d80: 2020 2020 2020 636c 6965 6e74 2e73 746f        client.sto
-00021d90: 705f 7365 7276 6963 6573 2827 756e 6b6e  p_services('unkn
-00021da0: 6f77 6e27 290a 0a20 2020 2064 6566 2074  own')..    def t
-00021db0: 6573 745f 6d69 7865 645f 7374 6172 745f  est_mixed_start_
-00021dc0: 7365 7276 6963 6528 7365 6c66 293a 0a20  service(self):. 
-00021dd0: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-00021de0: 7365 6c66 2e67 6574 5f74 6573 7469 6e67  self.get_testing
-00021df0: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
-00021e00: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
-00021e10: 6572 2827 666f 6f27 2c20 2727 275c 0a20  er('foo', '''\. 
-00021e20: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-00021e30: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
-00021e40: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
-00021e50: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
-00021e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021e70: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
-00021e80: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00021e90: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
-00021ea0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00021eb0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-00021ec0: 686f 2066 6f6f 270a 2020 2020 2020 2020  ho foo'.        
-00021ed0: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
-00021ee0: 2023 2054 4f44 4f3a 206a 616d 2032 3032   # TODO: jam 202
-00021ef0: 312d 3034 2d32 3020 6265 7474 6572 2065  1-04-20 better e
-00021f00: 7272 6f72 2074 7970 650a 2020 2020 2020  rror type.      
-00021f10: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00021f20: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
-00021f30: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00021f40: 2020 2020 636c 6965 6e74 2e73 7461 7274      client.start
-00021f50: 5f73 6572 7669 6365 7328 5b27 666f 6f27  _services(['foo'
-00021f60: 2c20 2775 6e6b 6e6f 776e 275d 290a 2020  , 'unknown']).  
-00021f70: 2020 2020 2020 2320 666f 6f20 7368 6f75        # foo shou
-00021f80: 6c64 206e 6f74 2062 6520 7374 6172 7465  ld not be starte
-00021f90: 640a 2020 2020 2020 2020 696e 666f 7320  d.        infos 
-00021fa0: 3d20 636c 6965 6e74 2e67 6574 5f73 6572  = client.get_ser
-00021fb0: 7669 6365 7328 290a 2020 2020 2020 2020  vices().        
-00021fc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00021fd0: 286c 656e 2869 6e66 6f73 292c 2031 290a  (len(infos), 1).
-00021fe0: 2020 2020 2020 2020 666f 6f5f 696e 666f          foo_info
-00021ff0: 203d 2069 6e66 6f73 5b30 5d0a 2020 2020   = infos[0].    
-00022000: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00022010: 7175 616c 2827 666f 6f27 2c20 666f 6f5f  qual('foo', foo_
-00022020: 696e 666f 2e6e 616d 6529 0a20 2020 2020  info.name).     
-00022030: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00022040: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-00022050: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
-00022060: 442c 2066 6f6f 5f69 6e66 6f2e 7374 6172  D, foo_info.star
-00022070: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
-00022080: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-00022090: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-000220a0: 7573 2e49 4e41 4354 4956 452c 2066 6f6f  us.INACTIVE, foo
-000220b0: 5f69 6e66 6f2e 6375 7272 656e 7429 0a0a  _info.current)..
-000220c0: 2020 2020 6465 6620 7465 7374 5f73 746f      def test_sto
-000220d0: 705f 7365 7276 6963 6573 5f75 6e6b 6e6f  p_services_unkno
-000220e0: 776e 2873 656c 6629 3a0a 2020 2020 2020  wn(self):.      
-000220f0: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
-00022100: 6765 745f 7465 7374 696e 675f 636c 6965  get_testing_clie
-00022110: 6e74 2829 0a20 2020 2020 2020 2063 6c69  nt().        cli
-00022120: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
-00022130: 6f6f 272c 2027 2727 5c0a 2020 2020 2020  oo', '''\.      
-00022140: 2020 2020 2020 7375 6d6d 6172 793a 2066        summary: f
-00022150: 6f6f 0a20 2020 2020 2020 2020 2020 2073  oo.            s
-00022160: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
-00022170: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
-00022180: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-00022190: 6172 793a 2046 6f6f 0a20 2020 2020 2020  ary: Foo.       
-000221a0: 2020 2020 2020 2020 2073 7461 7274 7570           startup
-000221b0: 3a20 656e 6162 6c65 640a 2020 2020 2020  : enabled.      
-000221c0: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-000221d0: 643a 2027 2f62 696e 2f65 6368 6f20 666f  d: '/bin/echo fo
-000221e0: 6f27 0a20 2020 2020 2020 2020 2020 2027  o'.            '
-000221f0: 2727 290a 2020 2020 2020 2020 636c 6965  '').        clie
-00022200: 6e74 2e61 7574 6f73 7461 7274 5f73 6572  nt.autostart_ser
-00022210: 7669 6365 7328 290a 2020 2020 2020 2020  vices().        
-00022220: 2320 544f 444f 3a20 6a61 6d20 3230 3231  # TODO: jam 2021
-00022230: 2d30 342d 3230 2062 6574 7465 7220 6572  -04-20 better er
-00022240: 726f 7220 7479 7065 0a20 2020 2020 2020  ror type.       
-00022250: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00022260: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-00022270: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00022280: 2020 2063 6c69 656e 742e 7374 6f70 5f73     client.stop_s
-00022290: 6572 7669 6365 7328 5b27 666f 6f27 2c20  ervices(['foo', 
-000222a0: 2775 6e6b 6e6f 776e 275d 290a 2020 2020  'unknown']).    
-000222b0: 2020 2020 2320 666f 6f20 7368 6f75 6c64      # foo should
-000222c0: 2073 7469 6c6c 2062 6520 7275 6e6e 696e   still be runnin
-000222d0: 670a 2020 2020 2020 2020 696e 666f 7320  g.        infos 
-000222e0: 3d20 636c 6965 6e74 2e67 6574 5f73 6572  = client.get_ser
-000222f0: 7669 6365 7328 290a 2020 2020 2020 2020  vices().        
-00022300: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00022310: 286c 656e 2869 6e66 6f73 292c 2031 290a  (len(infos), 1).
-00022320: 2020 2020 2020 2020 666f 6f5f 696e 666f          foo_info
-00022330: 203d 2069 6e66 6f73 5b30 5d0a 2020 2020   = infos[0].    
-00022340: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00022350: 7175 616c 2827 666f 6f27 2c20 666f 6f5f  qual('foo', foo_
-00022360: 696e 666f 2e6e 616d 6529 0a20 2020 2020  info.name).     
-00022370: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00022380: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
-00022390: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
-000223a0: 442c 2066 6f6f 5f69 6e66 6f2e 7374 6172  D, foo_info.star
-000223b0: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
-000223c0: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
-000223d0: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
-000223e0: 7573 2e41 4354 4956 452c 2066 6f6f 5f69  us.ACTIVE, foo_i
-000223f0: 6e66 6f2e 6375 7272 656e 7429 0a0a 2020  nfo.current)..  
-00022400: 2020 6465 6620 7465 7374 5f73 7461 7274    def test_start
-00022410: 5f73 7461 7274 6564 5f73 6572 7669 6365  _started_service
-00022420: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00022430: 2320 5065 6262 6c65 206d 6169 6e74 6169  # Pebble maintai
-00022440: 6e73 2069 6465 6d70 6f74 656e 6379 2065  ns idempotency e
-00022450: 7665 6e20 6966 2079 6f75 2073 7461 7274  ven if you start
-00022460: 2061 2073 6572 7669 6365 0a20 2020 2020   a service.     
-00022470: 2020 2023 2077 6869 6368 2069 7320 616c     # which is al
-00022480: 7265 6164 7920 7374 6172 7465 642e 0a20  ready started.. 
-00022490: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-000224a0: 7365 6c66 2e67 6574 5f74 6573 7469 6e67  self.get_testing
-000224b0: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
-000224c0: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
-000224d0: 6572 2827 666f 6f27 2c20 2727 275c 0a20  er('foo', '''\. 
-000224e0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-000224f0: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
-00022500: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
-00022510: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
-00022520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022530: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
-00022540: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00022550: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
-00022560: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00022570: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
-00022580: 686f 2066 6f6f 270a 2020 2020 2020 2020  ho foo'.        
-00022590: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
-000225a0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
-000225b0: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
-000225c0: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
-000225d0: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
-000225e0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
-000225f0: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-00022600: 2e61 7574 6f73 7461 7274 5f73 6572 7669  .autostart_servi
-00022610: 6365 7328 290a 2020 2020 2020 2020 2320  ces().        # 
-00022620: 466f 6f20 6973 206e 6f77 2073 7461 7274  Foo is now start
-00022630: 6564 2c20 6275 7420 4261 7220 6973 206e  ed, but Bar is n
-00022640: 6f74 0a20 2020 2020 2020 2063 6c69 656e  ot.        clien
-00022650: 742e 7374 6172 745f 7365 7276 6963 6573  t.start_services
-00022660: 285b 2762 6172 272c 2027 666f 6f27 5d29  (['bar', 'foo'])
-00022670: 0a20 2020 2020 2020 2023 2066 6f6f 2061  .        # foo a
-00022680: 6e64 2062 6172 2061 7265 2062 6f74 6820  nd bar are both 
-00022690: 7374 6172 7465 640a 2020 2020 2020 2020  started.        
-000226a0: 696e 666f 7320 3d20 636c 6965 6e74 2e67  infos = client.g
-000226b0: 6574 5f73 6572 7669 6365 7328 290a 2020  et_services().  
-000226c0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000226d0: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
-000226e0: 292c 2032 290a 2020 2020 2020 2020 6261  ), 2).        ba
-000226f0: 725f 696e 666f 203d 2069 6e66 6f73 5b30  r_info = infos[0
-00022700: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-00022710: 7373 6572 7445 7175 616c 2827 6261 7227  ssertEqual('bar'
-00022720: 2c20 6261 725f 696e 666f 2e6e 616d 6529  , bar_info.name)
-00022730: 0a20 2020 2020 2020 2023 2044 6566 6175  .        # Defau
-00022740: 6c74 2077 6865 6e20 6e6f 7420 7370 6563  lt when not spec
-00022750: 6966 6965 6420 6973 2044 4953 4142 4c45  ified is DISABLE
-00022760: 440a 2020 2020 2020 2020 7365 6c66 2e61  D.        self.a
-00022770: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
-00022780: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
-00022790: 2e44 4953 4142 4c45 442c 2062 6172 5f69  .DISABLED, bar_i
-000227a0: 6e66 6f2e 7374 6172 7475 7029 0a20 2020  nfo.startup).   
-000227b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000227c0: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
-000227d0: 7669 6365 5374 6174 7573 2e41 4354 4956  viceStatus.ACTIV
-000227e0: 452c 2062 6172 5f69 6e66 6f2e 6375 7272  E, bar_info.curr
-000227f0: 656e 7429 0a20 2020 2020 2020 2066 6f6f  ent).        foo
-00022800: 5f69 6e66 6f20 3d20 696e 666f 735b 315d  _info = infos[1]
-00022810: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00022820: 7365 7274 4571 7561 6c28 2766 6f6f 272c  sertEqual('foo',
-00022830: 2066 6f6f 5f69 6e66 6f2e 6e61 6d65 290a   foo_info.name).
-00022840: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00022850: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
-00022860: 5365 7276 6963 6553 7461 7274 7570 2e45  ServiceStartup.E
-00022870: 4e41 424c 4544 2c20 666f 6f5f 696e 666f  NABLED, foo_info
-00022880: 2e73 7461 7274 7570 290a 2020 2020 2020  .startup).      
-00022890: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000228a0: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
-000228b0: 6553 7461 7475 732e 4143 5449 5645 2c20  eStatus.ACTIVE, 
-000228c0: 666f 6f5f 696e 666f 2e63 7572 7265 6e74  foo_info.current
-000228d0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000228e0: 7374 6f70 5f73 746f 7070 6564 5f73 6572  stop_stopped_ser
-000228f0: 7669 6365 2873 656c 6629 3a0a 2020 2020  vice(self):.    
-00022900: 2020 2020 2320 5065 6262 6c65 206d 6169      # Pebble mai
-00022910: 6e74 6169 6e73 2069 6465 6d70 6f74 656e  ntains idempoten
-00022920: 6379 2065 7665 6e20 6966 2079 6f75 2073  cy even if you s
-00022930: 746f 7020 6120 7365 7276 6963 650a 2020  top a service.  
-00022940: 2020 2020 2020 2320 7768 6963 6820 6973        # which is
-00022950: 2061 6c72 6561 6479 2073 746f 7070 6564   already stopped
-00022960: 2e0a 2020 2020 2020 2020 636c 6965 6e74  ..        client
-00022970: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
-00022980: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
-00022990: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
-000229a0: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
-000229b0: 5c0a 2020 2020 2020 2020 2020 2020 7375  \.            su
-000229c0: 6d6d 6172 793a 2066 6f6f 0a20 2020 2020  mmary: foo.     
-000229d0: 2020 2020 2020 2073 6572 7669 6365 733a         services:
-000229e0: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
-000229f0: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
-00022a00: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
-00022a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022a20: 2073 7461 7274 7570 3a20 656e 6162 6c65   startup: enable
-00022a30: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00022a40: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
-00022a50: 2f65 6368 6f20 666f 6f27 0a20 2020 2020  /echo foo'.     
-00022a60: 2020 2020 2020 2020 2062 6172 3a0a 2020           bar:.  
-00022a70: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00022a80: 6d6d 6172 793a 2042 6172 0a20 2020 2020  mmary: Bar.     
-00022a90: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
-00022aa0: 6e64 3a20 272f 6269 6e2f 6563 686f 2062  nd: '/bin/echo b
-00022ab0: 6172 270a 2020 2020 2020 2020 2020 2020  ar'.            
-00022ac0: 2727 2729 0a20 2020 2020 2020 2063 6c69  ''').        cli
-00022ad0: 656e 742e 6175 746f 7374 6172 745f 7365  ent.autostart_se
-00022ae0: 7276 6963 6573 2829 0a20 2020 2020 2020  rvices().       
-00022af0: 2023 2046 6f6f 2069 7320 6e6f 7720 7374   # Foo is now st
-00022b00: 6172 7465 642c 2062 7574 2042 6172 2069  arted, but Bar i
-00022b10: 7320 6e6f 740a 2020 2020 2020 2020 636c  s not.        cl
-00022b20: 6965 6e74 2e73 746f 705f 7365 7276 6963  ient.stop_servic
-00022b30: 6573 285b 2766 6f6f 272c 2027 6261 7227  es(['foo', 'bar'
-00022b40: 5d29 0a20 2020 2020 2020 2023 2066 6f6f  ]).        # foo
-00022b50: 2061 6e64 2062 6172 2061 7265 2062 6f74   and bar are bot
-00022b60: 6820 7374 6f70 7065 640a 2020 2020 2020  h stopped.      
-00022b70: 2020 696e 666f 7320 3d20 636c 6965 6e74    infos = client
-00022b80: 2e67 6574 5f73 6572 7669 6365 7328 290a  .get_services().
-00022b90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00022ba0: 6572 7445 7175 616c 286c 656e 2869 6e66  ertEqual(len(inf
-00022bb0: 6f73 292c 2032 290a 2020 2020 2020 2020  os), 2).        
-00022bc0: 6261 725f 696e 666f 203d 2069 6e66 6f73  bar_info = infos
-00022bd0: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
-00022be0: 2e61 7373 6572 7445 7175 616c 2827 6261  .assertEqual('ba
-00022bf0: 7227 2c20 6261 725f 696e 666f 2e6e 616d  r', bar_info.nam
-00022c00: 6529 0a20 2020 2020 2020 2023 2044 6566  e).        # Def
-00022c10: 6175 6c74 2077 6865 6e20 6e6f 7420 7370  ault when not sp
-00022c20: 6563 6966 6965 6420 6973 2044 4953 4142  ecified is DISAB
-00022c30: 4c45 440a 2020 2020 2020 2020 7365 6c66  LED.        self
-00022c40: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-00022c50: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
-00022c60: 7570 2e44 4953 4142 4c45 442c 2062 6172  up.DISABLED, bar
-00022c70: 5f69 6e66 6f2e 7374 6172 7475 7029 0a20  _info.startup). 
-00022c80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00022c90: 7274 4571 7561 6c28 7065 6262 6c65 2e53  rtEqual(pebble.S
-00022ca0: 6572 7669 6365 5374 6174 7573 2e49 4e41  erviceStatus.INA
-00022cb0: 4354 4956 452c 2062 6172 5f69 6e66 6f2e  CTIVE, bar_info.
-00022cc0: 6375 7272 656e 7429 0a20 2020 2020 2020  current).       
-00022cd0: 2066 6f6f 5f69 6e66 6f20 3d20 696e 666f   foo_info = info
-00022ce0: 735b 315d 0a20 2020 2020 2020 2073 656c  s[1].        sel
-00022cf0: 662e 6173 7365 7274 4571 7561 6c28 2766  f.assertEqual('f
-00022d00: 6f6f 272c 2066 6f6f 5f69 6e66 6f2e 6e61  oo', foo_info.na
-00022d10: 6d65 290a 2020 2020 2020 2020 7365 6c66  me).        self
-00022d20: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
-00022d30: 626c 652e 5365 7276 6963 6553 7461 7274  ble.ServiceStart
-00022d40: 7570 2e45 4e41 424c 4544 2c20 666f 6f5f  up.ENABLED, foo_
-00022d50: 696e 666f 2e73 7461 7274 7570 290a 2020  info.startup).  
-00022d60: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00022d70: 7445 7175 616c 2870 6562 626c 652e 5365  tEqual(pebble.Se
-00022d80: 7276 6963 6553 7461 7475 732e 494e 4143  rviceStatus.INAC
-00022d90: 5449 5645 2c20 666f 6f5f 696e 666f 2e63  TIVE, foo_info.c
-00022da0: 7572 7265 6e74 290a 0a20 2020 2040 2075  urrent)..    @ u
-00022db0: 6e69 7474 6573 742e 736b 6970 556e 6c65  nittest.skipUnle
-00022dc0: 7373 2869 735f 6c69 6e75 782c 2027 5065  ss(is_linux, 'Pe
-00022dd0: 6262 6c65 2072 756e 7320 6f6e 204c 696e  bble runs on Lin
-00022de0: 7578 2729 0a20 2020 2064 6566 2074 6573  ux').    def tes
-00022df0: 745f 7365 6e64 5f73 6967 6e61 6c28 7365  t_send_signal(se
-00022e00: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
-00022e10: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
-00022e20: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
-00022e30: 2020 2020 2020 2020 636c 6965 6e74 2e61          client.a
-00022e40: 6464 5f6c 6179 6572 2827 666f 6f27 2c20  dd_layer('foo', 
-00022e50: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
-00022e60: 2073 756d 6d61 7279 3a20 666f 6f0a 2020   summary: foo.  
-00022e70: 2020 2020 2020 2020 2020 7365 7276 6963            servic
-00022e80: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00022e90: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
-00022ea0: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
-00022eb0: 466f 6f0a 2020 2020 2020 2020 2020 2020  Foo.            
-00022ec0: 2020 2020 7374 6172 7475 703a 2065 6e61      startup: ena
-00022ed0: 626c 6564 0a20 2020 2020 2020 2020 2020  bled.           
-00022ee0: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
-00022ef0: 6269 6e2f 6563 686f 2066 6f6f 270a 2020  bin/echo foo'.  
-00022f00: 2020 2020 2020 2020 2020 2020 6261 723a              bar:
-00022f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022f20: 2073 756d 6d61 7279 3a20 4261 720a 2020   summary: Bar.  
-00022f30: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00022f40: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
-00022f50: 6f20 6261 7227 0a20 2020 2020 2020 2020  o bar'.         
-00022f60: 2020 2027 2727 290a 2020 2020 2020 2020     ''').        
-00022f70: 636c 6965 6e74 2e61 7574 6f73 7461 7274  client.autostart
-00022f80: 5f73 6572 7669 6365 7328 290a 2020 2020  _services().    
-00022f90: 2020 2020 2320 466f 6f20 6973 206e 6f77      # Foo is now
-00022fa0: 2073 7461 7274 6564 2c20 6275 7420 4261   started, but Ba
-00022fb0: 7220 6973 206e 6f74 0a0a 2020 2020 2020  r is not..      
-00022fc0: 2020 2320 5365 6e64 2061 2076 616c 6964    # Send a valid
-00022fd0: 2073 6967 6e61 6c20 746f 2061 2072 756e   signal to a run
-00022fe0: 6e69 6e67 2073 6572 7669 6365 0a20 2020  ning service.   
-00022ff0: 2020 2020 2063 6c69 656e 742e 7365 6e64       client.send
-00023000: 5f73 6967 6e61 6c28 2253 4947 494e 5422  _signal("SIGINT"
-00023010: 2c20 2266 6f6f 2229 0a0a 2020 2020 2020  , "foo")..      
-00023020: 2020 2320 5365 6e64 2061 2076 616c 6964    # Send a valid
-00023030: 2073 6967 6e61 6c20 6275 7420 6f6d 6974   signal but omit
-00023040: 2073 6572 7669 6365 206e 616d 650a 2020   service name.  
-00023050: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00023060: 6173 7365 7274 5261 6973 6573 2854 7970  assertRaises(Typ
-00023070: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00023080: 2020 2020 2063 6c69 656e 742e 7365 6e64       client.send
-00023090: 5f73 6967 6e61 6c28 2253 4947 494e 5422  _signal("SIGINT"
-000230a0: 290a 0a20 2020 2020 2020 2023 2053 656e  )..        # Sen
-000230b0: 6420 616e 2069 6e76 616c 6964 2073 6967  d an invalid sig
-000230c0: 6e61 6c20 746f 2061 2072 756e 6e69 6e67  nal to a running
-000230d0: 2073 6572 7669 6365 0a20 2020 2020 2020   service.       
-000230e0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-000230f0: 7452 6169 7365 7328 7065 6262 6c65 2e41  tRaises(pebble.A
-00023100: 5049 4572 726f 7229 3a0a 2020 2020 2020  PIError):.      
-00023110: 2020 2020 2020 636c 6965 6e74 2e73 656e        client.sen
-00023120: 645f 7369 676e 616c 2822 7369 6769 6e74  d_signal("sigint
-00023130: 222c 2022 666f 6f22 290a 0a20 2020 2020  ", "foo")..     
-00023140: 2020 2023 2053 656e 6420 6120 7661 6c69     # Send a vali
-00023150: 6420 7369 676e 616c 2074 6f20 6120 7374  d signal to a st
-00023160: 6f70 7065 6420 7365 7276 6963 650a 2020  opped service.  
-00023170: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00023180: 6173 7365 7274 5261 6973 6573 2870 6562  assertRaises(peb
-00023190: 626c 652e 4150 4945 7272 6f72 293a 0a20  ble.APIError):. 
-000231a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-000231b0: 742e 7365 6e64 5f73 6967 6e61 6c28 2253  t.send_signal("S
-000231c0: 4947 494e 5422 2c20 2262 6172 2229 0a0a  IGINT", "bar")..
-000231d0: 2020 2020 2020 2020 2320 5365 6e64 2061          # Send a
-000231e0: 2076 616c 6964 2073 6967 6e61 6c20 746f   valid signal to
-000231f0: 2061 206e 6f6e 2d65 7869 7374 696e 6720   a non-existing 
-00023200: 7365 7276 6963 650a 2020 2020 2020 2020  service.        
-00023210: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00023220: 5261 6973 6573 2870 6562 626c 652e 4150  Raises(pebble.AP
-00023230: 4945 7272 6f72 293a 0a20 2020 2020 2020  IError):.       
-00023240: 2020 2020 2063 6c69 656e 742e 7365 6e64       client.send
-00023250: 5f73 6967 6e61 6c28 2253 4947 494e 5422  _signal("SIGINT"
-00023260: 2c20 2262 617a 2229 0a0a 2020 2020 2020  , "baz")..      
-00023270: 2020 2320 5365 6e64 2061 2076 616c 6964    # Send a valid
-00023280: 2073 6967 6e61 6c20 746f 2061 206d 756c   signal to a mul
-00023290: 7469 706c 6520 7365 7276 6963 6573 2c20  tiple services, 
-000232a0: 6f6e 6520 6f66 2077 6869 6368 2069 7320  one of which is 
-000232b0: 6e6f 7420 7275 6e6e 696e 670a 2020 2020  not running.    
-000232c0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
-000232d0: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
-000232e0: 652e 4150 4945 7272 6f72 293a 0a20 2020  e.APIError):.   
-000232f0: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
-00023300: 7365 6e64 5f73 6967 6e61 6c28 2253 4947  send_signal("SIG
-00023310: 494e 5422 2c20 2266 6f6f 222c 2022 6261  INT", "foo", "ba
-00023320: 7222 290a 0a0a 2320 466f 7220 7465 7374  r")...# For test
-00023330: 696e 6720 6669 6c65 2d6f 7073 206f 6620  ing file-ops of 
-00023340: 7468 6520 7065 6262 6c65 2063 6c69 656e  the pebble clien
-00023350: 742e 2020 5468 6973 2069 7320 7265 6661  t.  This is refa
-00023360: 6374 6f72 6564 2069 6e74 6f20 610a 2320  ctored into a.# 
-00023370: 7365 7061 7261 7465 206d 6978 696e 2073  separate mixin s
-00023380: 6f20 7765 2063 616e 2072 756e 2074 6865  o we can run the
-00023390: 7365 2074 6573 7473 2061 6761 696e 7374  se tests against
-000233a0: 2062 6f74 6820 7468 6520 6d6f 636b 2063   both the mock c
-000233b0: 6c69 656e 7420 6173 0a23 2077 656c 6c20  lient as.# well 
-000233c0: 6173 2061 2072 6561 6c20 7065 6262 6c65  as a real pebble
-000233d0: 2073 6572 7665 7220 696e 7374 616e 6365   server instance
-000233e0: 2e0a 636c 6173 7320 5f50 6562 626c 6553  ..class _PebbleS
-000233f0: 746f 7261 6765 4150 4973 5465 7374 4d69  torageAPIsTestMi
-00023400: 7869 6e3a 0a20 2020 2023 204f 7665 7272  xin:.    # Overr
-00023410: 6964 6520 7468 6973 2069 6e20 636c 6173  ide this in clas
-00023420: 7365 7320 7573 696e 6720 7468 6973 206d  ses using this m
-00023430: 6978 696e 2e0a 2020 2020 2320 5468 6973  ixin..    # This
-00023440: 2073 686f 756c 6420 6265 2073 6574 2074   should be set t
-00023450: 6f20 616e 7920 6e6f 6e2d 656d 7074 7920  o any non-empty 
-00023460: 7061 7468 2c20 6275 7420 7769 7468 6f75  path, but withou
-00023470: 7420 6120 7472 6169 6c69 6e67 202f 2e0a  t a trailing /..
-00023480: 2020 2020 7072 6566 6978 203d 204e 6f6e      prefix = Non
-00023490: 650a 0a20 2020 2064 6566 2074 6573 745f  e..    def test_
-000234a0: 7075 7368 5f61 6e64 5f70 756c 6c5f 6279  push_and_pull_by
-000234b0: 7465 7328 7365 6c66 293a 0a20 2020 2020  tes(self):.     
-000234c0: 2020 2073 656c 662e 5f74 6573 745f 7075     self._test_pu
-000234d0: 7368 5f61 6e64 5f70 756c 6c5f 6461 7461  sh_and_pull_data
-000234e0: 280a 2020 2020 2020 2020 2020 2020 6f72  (.            or
-000234f0: 6967 696e 616c 5f64 6174 613d 6222 5c78  iginal_data=b"\x
-00023500: 3030 5c78 3031 5c78 3032 5c78 3033 5c78  00\x01\x02\x03\x
-00023510: 3034 222c 0a20 2020 2020 2020 2020 2020  04",.           
-00023520: 2065 6e63 6f64 696e 673d 4e6f 6e65 2c0a   encoding=None,.
-00023530: 2020 2020 2020 2020 2020 2020 7374 7265              stre
-00023540: 616d 5f63 6c61 7373 3d69 6f2e 4279 7465  am_class=io.Byte
-00023550: 7349 4f29 0a0a 2020 2020 6465 6620 7465  sIO)..    def te
-00023560: 7374 5f70 7573 685f 616e 645f 7075 6c6c  st_push_and_pull
-00023570: 5f6e 6f6e 5f75 7466 385f 6461 7461 2873  _non_utf8_data(s
-00023580: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00023590: 6c66 2e5f 7465 7374 5f70 7573 685f 616e  lf._test_push_an
-000235a0: 645f 7075 6c6c 5f64 6174 6128 0a20 2020  d_pull_data(.   
-000235b0: 2020 2020 2020 2020 206f 7269 6769 6e61           origina
-000235c0: 6c5f 6461 7461 3d27 e697 a5e6 9cac e8aa  l_data='........
-000235d0: 9e27 2c20 2023 2022 4a61 7061 6e65 7365  .',  # "Japanese
-000235e0: 2220 696e 204a 6170 616e 6573 650a 2020  " in Japanese.  
-000235f0: 2020 2020 2020 2020 2020 656e 636f 6469            encodi
-00023600: 6e67 3d27 736a 6973 272c 0a20 2020 2020  ng='sjis',.     
-00023610: 2020 2020 2020 2073 7472 6561 6d5f 636c         stream_cl
-00023620: 6173 733d 696f 2e53 7472 696e 6749 4f29  ass=io.StringIO)
-00023630: 0a0a 2020 2020 6465 6620 5f74 6573 745f  ..    def _test_
-00023640: 7075 7368 5f61 6e64 5f70 756c 6c5f 6461  push_and_pull_da
-00023650: 7461 2873 656c 662c 206f 7269 6769 6e61  ta(self, origina
-00023660: 6c5f 6461 7461 2c20 656e 636f 6469 6e67  l_data, encoding
-00023670: 2c20 7374 7265 616d 5f63 6c61 7373 293a  , stream_class):
-00023680: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
-00023690: 3d20 7365 6c66 2e63 6c69 656e 740a 2020  = self.client.  
-000236a0: 2020 2020 2020 636c 6965 6e74 2e70 7573        client.pus
-000236b0: 6828 6622 7b73 656c 662e 7072 6566 6978  h(f"{self.prefix
-000236c0: 7d2f 7465 7374 222c 206f 7269 6769 6e61  }/test", origina
-000236d0: 6c5f 6461 7461 2c20 656e 636f 6469 6e67  l_data, encoding
-000236e0: 3d65 6e63 6f64 696e 6729 0a20 2020 2020  =encoding).     
-000236f0: 2020 2077 6974 6820 636c 6965 6e74 2e70     with client.p
-00023700: 756c 6c28 6622 7b73 656c 662e 7072 6566  ull(f"{self.pref
-00023710: 6978 7d2f 7465 7374 222c 2065 6e63 6f64  ix}/test", encod
-00023720: 696e 673d 656e 636f 6469 6e67 2920 6173  ing=encoding) as
-00023730: 2069 6e66 696c 653a 0a20 2020 2020 2020   infile:.       
-00023740: 2020 2020 2072 6563 6569 7665 645f 6461       received_da
-00023750: 7461 203d 2069 6e66 696c 652e 7265 6164  ta = infile.read
-00023760: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00023770: 6173 7365 7274 4571 7561 6c28 6f72 6967  assertEqual(orig
-00023780: 696e 616c 5f64 6174 612c 2072 6563 6569  inal_data, recei
-00023790: 7665 645f 6461 7461 290a 0a20 2020 2020  ved_data)..     
-000237a0: 2020 2023 2057 6520 616c 736f 2073 7570     # We also sup
-000237b0: 706f 7274 2066 696c 652d 6c69 6b65 206f  port file-like o
-000237c0: 626a 6563 7473 2061 7320 696e 7075 742c  bjects as input,
-000237d0: 2073 6f20 6c65 7427 7320 7465 7374 2074   so let's test t
-000237e0: 6861 7420 6361 7365 2061 7320 7765 6c6c  hat case as well
-000237f0: 2e0a 2020 2020 2020 2020 736d 616c 6c5f  ..        small_
-00023800: 6669 6c65 203d 2073 7472 6561 6d5f 636c  file = stream_cl
-00023810: 6173 7328 6f72 6967 696e 616c 5f64 6174  ass(original_dat
-00023820: 6129 0a20 2020 2020 2020 2063 6c69 656e  a).        clien
-00023830: 742e 7075 7368 2866 227b 7365 6c66 2e70  t.push(f"{self.p
-00023840: 7265 6669 787d 2f74 6573 7422 2c20 736d  refix}/test", sm
-00023850: 616c 6c5f 6669 6c65 2c20 656e 636f 6469  all_file, encodi
-00023860: 6e67 3d65 6e63 6f64 696e 6729 0a20 2020  ng=encoding).   
-00023870: 2020 2020 2077 6974 6820 636c 6965 6e74       with client
-00023880: 2e70 756c 6c28 6622 7b73 656c 662e 7072  .pull(f"{self.pr
-00023890: 6566 6978 7d2f 7465 7374 222c 2065 6e63  efix}/test", enc
-000238a0: 6f64 696e 673d 656e 636f 6469 6e67 2920  oding=encoding) 
-000238b0: 6173 2069 6e66 696c 653a 0a20 2020 2020  as infile:.     
-000238c0: 2020 2020 2020 2072 6563 6569 7665 645f         received_
-000238d0: 6461 7461 203d 2069 6e66 696c 652e 7265  data = infile.re
-000238e0: 6164 2829 0a20 2020 2020 2020 2073 656c  ad().        sel
-000238f0: 662e 6173 7365 7274 4571 7561 6c28 6f72  f.assertEqual(or
-00023900: 6967 696e 616c 5f64 6174 612c 2072 6563  iginal_data, rec
-00023910: 6569 7665 645f 6461 7461 290a 0a20 2020  eived_data)..   
-00023920: 2064 6566 2074 6573 745f 7075 7368 5f61   def test_push_a
-00023930: 6e64 5f70 756c 6c5f 6c61 7267 6572 5f66  nd_pull_larger_f
-00023940: 696c 6528 7365 6c66 293a 0a20 2020 2020  ile(self):.     
-00023950: 2020 2023 2049 6e74 656e 743a 2074 6f20     # Intent: to 
-00023960: 656e 7375 7265 2074 6869 6e67 7320 776f  ensure things wo
-00023970: 726b 2061 7070 726f 7072 6961 7465 6c79  rk appropriately
-00023980: 2077 6974 6820 6c61 7267 6572 2066 696c   with larger fil
-00023990: 6573 2e0a 2020 2020 2020 2020 2320 4c61  es..        # La
-000239a0: 7267 6572 2066 696c 6573 206d 6179 2062  rger files may b
-000239b0: 6520 7365 6e74 2f72 6563 6569 7665 6420  e sent/received 
-000239c0: 696e 206d 756c 7469 706c 6520 6368 756e  in multiple chun
-000239d0: 6b73 3b20 7468 6973 2073 686f 756c 6420  ks; this should 
-000239e0: 6865 6c70 2066 6f72 0a20 2020 2020 2020  help for.       
-000239f0: 2023 2063 6865 636b 696e 6720 7468 6174   # checking that
-00023a00: 2073 7563 6820 6c6f 6769 6320 6973 2063   such logic is c
-00023a10: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
-00023a20: 6461 7461 5f73 697a 6520 3d20 3130 3234  data_size = 1024
-00023a30: 202a 2031 3032 340a 2020 2020 2020 2020   * 1024.        
-00023a40: 6f72 6967 696e 616c 5f64 6174 6120 3d20  original_data = 
-00023a50: 6f73 2e75 7261 6e64 6f6d 2864 6174 615f  os.urandom(data_
-00023a60: 7369 7a65 290a 0a20 2020 2020 2020 2063  size)..        c
-00023a70: 6c69 656e 7420 3d20 7365 6c66 2e63 6c69  lient = self.cli
-00023a80: 656e 740a 2020 2020 2020 2020 636c 6965  ent.        clie
-00023a90: 6e74 2e70 7573 6828 6622 7b73 656c 662e  nt.push(f"{self.
-00023aa0: 7072 6566 6978 7d2f 7465 7374 222c 206f  prefix}/test", o
-00023ab0: 7269 6769 6e61 6c5f 6461 7461 2c20 656e  riginal_data, en
-00023ac0: 636f 6469 6e67 3d4e 6f6e 6529 0a20 2020  coding=None).   
-00023ad0: 2020 2020 2077 6974 6820 636c 6965 6e74       with client
-00023ae0: 2e70 756c 6c28 6622 7b73 656c 662e 7072  .pull(f"{self.pr
-00023af0: 6566 6978 7d2f 7465 7374 222c 2065 6e63  efix}/test", enc
-00023b00: 6f64 696e 673d 4e6f 6e65 2920 6173 2069  oding=None) as i
-00023b10: 6e66 696c 653a 0a20 2020 2020 2020 2020  nfile:.         
-00023b20: 2020 2072 6563 6569 7665 645f 6461 7461     received_data
-00023b30: 203d 2069 6e66 696c 652e 7265 6164 2829   = infile.read()
-00023b40: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00023b50: 7365 7274 4571 7561 6c28 6f72 6967 696e  sertEqual(origin
-00023b60: 616c 5f64 6174 612c 2072 6563 6569 7665  al_data, receive
-00023b70: 645f 6461 7461 290a 0a20 2020 2064 6566  d_data)..    def
-00023b80: 2074 6573 745f 7075 7368 5f74 6f5f 6e6f   test_push_to_no
-00023b90: 6e5f 6578 6973 7465 6e74 5f73 7562 6469  n_existent_subdi
-00023ba0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-00023bb0: 2064 6174 6120 3d20 2764 6174 6127 0a20   data = 'data'. 
-00023bc0: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-00023bd0: 7365 6c66 2e63 6c69 656e 740a 0a20 2020  self.client..   
-00023be0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00023bf0: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
-00023c00: 6c65 2e50 6174 6845 7272 6f72 2920 6173  le.PathError) as
-00023c10: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-00023c20: 2063 6c69 656e 742e 7075 7368 2866 227b   client.push(f"{
-00023c30: 7365 6c66 2e70 7265 6669 787d 2f6e 6f6e  self.prefix}/non
-00023c40: 6578 6973 7465 6e74 5f64 6972 2f74 6573  existent_dir/tes
-00023c50: 7422 2c20 6461 7461 2c20 6d61 6b65 5f64  t", data, make_d
-00023c60: 6972 733d 4661 6c73 6529 0a20 2020 2020  irs=False).     
-00023c70: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00023c80: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
-00023c90: 2e6b 696e 642c 2027 6e6f 742d 666f 756e  .kind, 'not-foun
-00023ca0: 6427 290a 0a20 2020 2020 2020 2063 6c69  d')..        cli
-00023cb0: 656e 742e 7075 7368 2866 227b 7365 6c66  ent.push(f"{self
-00023cc0: 2e70 7265 6669 787d 2f6e 6f6e 6578 6973  .prefix}/nonexis
-00023cd0: 7465 6e74 5f64 6972 2f74 6573 7422 2c20  tent_dir/test", 
-00023ce0: 6461 7461 2c20 6d61 6b65 5f64 6972 733d  data, make_dirs=
-00023cf0: 5472 7565 290a 0a20 2020 2064 6566 2074  True)..    def t
-00023d00: 6573 745f 7075 7368 5f61 735f 6368 696c  est_push_as_chil
-00023d10: 645f 6f66 5f66 696c 655f 7261 6973 6573  d_of_file_raises
-00023d20: 5f65 7272 6f72 2873 656c 6629 3a0a 2020  _error(self):.  
-00023d30: 2020 2020 2020 6461 7461 203d 2027 6461        data = 'da
-00023d40: 7461 270a 2020 2020 2020 2020 636c 6965  ta'.        clie
-00023d50: 6e74 203d 2073 656c 662e 636c 6965 6e74  nt = self.client
-00023d60: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
-00023d70: 7075 7368 2866 227b 7365 6c66 2e70 7265  push(f"{self.pre
-00023d80: 6669 787d 2f66 696c 6522 2c20 6461 7461  fix}/file", data
-00023d90: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
-00023da0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
-00023db0: 2870 6562 626c 652e 5061 7468 4572 726f  (pebble.PathErro
-00023dc0: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
-00023dd0: 2020 2020 2020 636c 6965 6e74 2e70 7573        client.pus
-00023de0: 6828 6622 7b73 656c 662e 7072 6566 6978  h(f"{self.prefix
-00023df0: 7d2f 6669 6c65 2f66 696c 6522 2c20 6461  }/file/file", da
-00023e00: 7461 290a 2020 2020 2020 2020 7365 6c66  ta).        self
-00023e10: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
-00023e20: 6578 6365 7074 696f 6e2e 6b69 6e64 2c20  exception.kind, 
-00023e30: 2767 656e 6572 6963 2d66 696c 652d 6572  'generic-file-er
-00023e40: 726f 7227 290a 0a20 2020 2064 6566 2074  ror')..    def t
-00023e50: 6573 745f 7075 7368 5f77 6974 685f 7065  est_push_with_pe
-00023e60: 726d 6973 7369 6f6e 5f6d 6173 6b28 7365  rmission_mask(se
-00023e70: 6c66 293a 0a20 2020 2020 2020 2064 6174  lf):.        dat
-00023e80: 6120 3d20 2764 6174 6127 0a20 2020 2020  a = 'data'.     
-00023e90: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00023ea0: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
-00023eb0: 636c 6965 6e74 2e70 7573 6828 6622 7b73  client.push(f"{s
-00023ec0: 656c 662e 7072 6566 6978 7d2f 6669 6c65  elf.prefix}/file
-00023ed0: 222c 2064 6174 612c 2070 6572 6d69 7373  ", data, permiss
-00023ee0: 696f 6e73 3d30 6f36 3030 290a 2020 2020  ions=0o600).    
-00023ef0: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
-00023f00: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00023f10: 6669 6c65 222c 2064 6174 612c 2070 6572  file", data, per
-00023f20: 6d69 7373 696f 6e73 3d30 6f37 3737 290a  missions=0o777).
-00023f30: 2020 2020 2020 2020 2320 4966 2070 6572          # If per
-00023f40: 6d69 7373 696f 6e73 2061 7265 206f 7574  missions are out
-00023f50: 7369 6465 206f 6620 7468 6520 7261 6e67  side of the rang
-00023f60: 6520 306f 3030 3020 7468 726f 7567 6820  e 0o000 through 
-00023f70: 306f 3737 372c 2061 6e20 6578 6365 7074  0o777, an except
-00023f80: 696f 6e20 7368 6f75 6c64 2062 650a 2020  ion should be.  
-00023f90: 2020 2020 2020 2320 7261 6973 6564 2e0a        # raised..
-00023fa0: 2020 2020 2020 2020 666f 7220 6261 645f          for bad_
-00023fb0: 7065 726d 6973 7369 6f6e 2069 6e20 280a  permission in (.
-00023fc0: 2020 2020 2020 2020 2020 2020 306f 3130              0o10
-00023fd0: 3030 2c20 2023 2045 7863 6565 6473 2030  00,  # Exceeds 0
-00023fe0: 6f37 3737 0a20 2020 2020 2020 2020 2020  o777.           
-00023ff0: 202d 312c 2020 2020 2020 2320 4c65 7373   -1,      # Less
-00024000: 2074 6861 6e20 306f 3030 300a 2020 2020   than 0o000.    
-00024010: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00024020: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00024030: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
-00024040: 2e50 6174 6845 7272 6f72 2920 6173 2063  .PathError) as c
-00024050: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
-00024060: 2020 2063 6c69 656e 742e 7075 7368 2866     client.push(f
-00024070: 227b 7365 6c66 2e70 7265 6669 787d 2f66  "{self.prefix}/f
-00024080: 696c 6522 2c20 6461 7461 2c20 7065 726d  ile", data, perm
-00024090: 6973 7369 6f6e 733d 6261 645f 7065 726d  issions=bad_perm
-000240a0: 6973 7369 6f6e 290a 2020 2020 2020 2020  ission).        
-000240b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000240c0: 2863 6d2e 6578 6365 7074 696f 6e2e 6b69  (cm.exception.ki
-000240d0: 6e64 2c20 2767 656e 6572 6963 2d66 696c  nd, 'generic-fil
-000240e0: 652d 6572 726f 7227 290a 0a20 2020 2064  e-error')..    d
-000240f0: 6566 2074 6573 745f 7075 7368 5f66 696c  ef test_push_fil
-00024100: 6573 5f61 6e64 5f6c 6973 7428 7365 6c66  es_and_list(self
-00024110: 293a 0a20 2020 2020 2020 2064 6174 6120  ):.        data 
-00024120: 3d20 2764 6174 6127 0a20 2020 2020 2020  = 'data'.       
-00024130: 2063 6c69 656e 7420 3d20 7365 6c66 2e63   client = self.c
-00024140: 6c69 656e 740a 0a20 2020 2020 2020 2023  lient..        #
-00024150: 204c 6574 2773 2070 7573 6820 7468 6520   Let's push the 
-00024160: 6669 7273 7420 6669 6c65 2077 6974 6820  first file with 
-00024170: 6120 6275 6e63 6820 6f66 2064 6574 6169  a bunch of detai
-00024180: 6c73 2e20 2057 6527 6c6c 2063 6865 636b  ls.  We'll check
-00024190: 206f 6e20 7468 6973 206c 6174 6572 2e0a   on this later..
-000241a0: 2020 2020 2020 2020 636c 6965 6e74 2e70          client.p
-000241b0: 7573 6828 0a20 2020 2020 2020 2020 2020  ush(.           
-000241c0: 2066 227b 7365 6c66 2e70 7265 6669 787d   f"{self.prefix}
-000241d0: 2f66 696c 6531 222c 2064 6174 612c 0a20  /file1", data,. 
-000241e0: 2020 2020 2020 2020 2020 2070 6572 6d69             permi
-000241f0: 7373 696f 6e73 3d30 6f36 3230 290a 0a20  ssions=0o620).. 
-00024200: 2020 2020 2020 2023 2044 6f20 6120 7175         # Do a qu
-00024210: 6963 6b20 7075 7368 2077 6974 6820 6465  ick push with de
-00024220: 6661 756c 7473 2066 6f72 2074 6865 206f  faults for the o
-00024230: 7468 6572 2066 696c 6573 2e0a 2020 2020  ther files..    
-00024240: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
-00024250: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00024260: 6669 6c65 3222 2c20 6461 7461 290a 2020  file2", data).  
-00024270: 2020 2020 2020 636c 6965 6e74 2e70 7573        client.pus
-00024280: 6828 6622 7b73 656c 662e 7072 6566 6978  h(f"{self.prefix
-00024290: 7d2f 6669 6c65 3322 2c20 6461 7461 290a  }/file3", data).
-000242a0: 0a20 2020 2020 2020 2066 696c 6573 203d  .        files =
-000242b0: 2063 6c69 656e 742e 6c69 7374 5f66 696c   client.list_fil
-000242c0: 6573 2866 227b 7365 6c66 2e70 7265 6669  es(f"{self.prefi
-000242d0: 787d 2f22 290a 2020 2020 2020 2020 7365  x}/").        se
-000242e0: 6c66 2e61 7373 6572 7445 7175 616c 287b  lf.assertEqual({
-000242f0: 6669 6c65 2e70 6174 6820 666f 7220 6669  file.path for fi
-00024300: 6c65 2069 6e20 6669 6c65 737d 2c0a 2020  le in files},.  
-00024310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024320: 2020 2020 2020 207b 7365 6c66 2e70 7265         {self.pre
-00024330: 6669 7820 2b20 6669 6c65 2066 6f72 2066  fix + file for f
-00024340: 696c 6520 696e 2028 272f 6669 6c65 3127  ile in ('/file1'
-00024350: 2c20 272f 6669 6c65 3227 2c20 272f 6669  , '/file2', '/fi
-00024360: 6c65 3327 297d 290a 0a20 2020 2020 2020  le3')})..       
-00024370: 2023 204c 6574 2773 2070 756c 6c20 7468   # Let's pull th
-00024380: 6520 6669 7273 7420 6669 6c65 2061 6761  e first file aga
-00024390: 696e 2061 6e64 2063 6865 636b 2069 7473  in and check its
-000243a0: 2064 6574 6169 6c73 0a20 2020 2020 2020   details.       
-000243b0: 2066 696c 6520 3d20 5b66 2066 6f72 2066   file = [f for f
-000243c0: 2069 6e20 6669 6c65 7320 6966 2066 2e70   in files if f.p
-000243d0: 6174 6820 3d3d 2066 227b 7365 6c66 2e70  ath == f"{self.p
-000243e0: 7265 6669 787d 2f66 696c 6531 225d 5b30  refix}/file1"][0
-000243f0: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
-00024400: 7373 6572 7445 7175 616c 2866 696c 652e  ssertEqual(file.
-00024410: 6e61 6d65 2c20 2766 696c 6531 2729 0a20  name, 'file1'). 
-00024420: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00024430: 7274 4571 7561 6c28 6669 6c65 2e74 7970  rtEqual(file.typ
-00024440: 652c 2070 6562 626c 652e 4669 6c65 5479  e, pebble.FileTy
-00024450: 7065 2e46 494c 4529 0a20 2020 2020 2020  pe.FILE).       
-00024460: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00024470: 6c28 6669 6c65 2e73 697a 652c 2034 290a  l(file.size, 4).
-00024480: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00024490: 6572 7449 7349 6e73 7461 6e63 6528 6669  ertIsInstance(fi
-000244a0: 6c65 2e6c 6173 745f 6d6f 6469 6669 6564  le.last_modified
-000244b0: 2c20 6461 7465 7469 6d65 2e64 6174 6574  , datetime.datet
-000244c0: 696d 6529 0a20 2020 2020 2020 2073 656c  ime).        sel
-000244d0: 662e 6173 7365 7274 4571 7561 6c28 6669  f.assertEqual(fi
-000244e0: 6c65 2e70 6572 6d69 7373 696f 6e73 2c20  le.permissions, 
-000244f0: 306f 3632 3029 0a20 2020 2020 2020 2023  0o620).        #
-00024500: 2053 6b69 7070 696e 6720 6f77 6e65 7273   Skipping owners
-00024510: 6869 7020 6368 6563 6b73 2068 6572 653b  hip checks here;
-00024520: 206f 776e 6572 7368 6970 2077 696c 6c20   ownership will 
-00024530: 6265 2063 6865 636b 6564 2069 6e20 7075  be checked in pu
-00024540: 7265 6c79 2d6d 6f63 6b65 6420 7465 7374  rely-mocked test
-00024550: 730a 0a20 2020 2064 6566 2074 6573 745f  s..    def test_
-00024560: 7075 7368 5f61 6e64 5f6c 6973 745f 6669  push_and_list_fi
-00024570: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
-00024580: 2020 6461 7461 203d 2027 6461 7461 270a    data = 'data'.
-00024590: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-000245a0: 2073 656c 662e 636c 6965 6e74 0a20 2020   self.client.   
-000245b0: 2020 2020 2063 6c69 656e 742e 7075 7368       client.push
-000245c0: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-000245d0: 2f66 696c 6522 2c20 6461 7461 290a 2020  /file", data).  
-000245e0: 2020 2020 2020 6669 6c65 7320 3d20 636c        files = cl
-000245f0: 6965 6e74 2e6c 6973 745f 6669 6c65 7328  ient.list_files(
-00024600: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00024610: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00024620: 6173 7365 7274 4571 7561 6c28 7b66 696c  assertEqual({fil
-00024630: 652e 7061 7468 2066 6f72 2066 696c 6520  e.path for file 
-00024640: 696e 2066 696c 6573 7d2c 207b 6622 7b73  in files}, {f"{s
-00024650: 656c 662e 7072 6566 6978 7d2f 6669 6c65  elf.prefix}/file
-00024660: 227d 290a 0a20 2020 2064 6566 2074 6573  "})..    def tes
-00024670: 745f 7075 7368 5f66 696c 655f 7769 7468  t_push_file_with
-00024680: 5f72 656c 6174 6976 655f 7061 7468 5f66  _relative_path_f
-00024690: 6169 6c73 2873 656c 6629 3a0a 2020 2020  ails(self):.    
-000246a0: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
-000246b0: 662e 636c 6965 6e74 0a20 2020 2020 2020  f.client.       
-000246c0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-000246d0: 7452 6169 7365 7328 7065 6262 6c65 2e50  tRaises(pebble.P
-000246e0: 6174 6845 7272 6f72 2920 6173 2063 6d3a  athError) as cm:
-000246f0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00024700: 656e 742e 7075 7368 2827 6669 6c65 272c  ent.push('file',
-00024710: 2027 2729 0a20 2020 2020 2020 2073 656c   '').        sel
-00024720: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
-00024730: 2e65 7863 6570 7469 6f6e 2e6b 696e 642c  .exception.kind,
-00024740: 2027 6765 6e65 7269 632d 6669 6c65 2d65   'generic-file-e
-00024750: 7272 6f72 2729 0a0a 2020 2020 6465 6620  rror')..    def 
-00024760: 7465 7374 5f70 756c 6c5f 6e6f 745f 666f  test_pull_not_fo
-00024770: 756e 6428 7365 6c66 293a 0a20 2020 2020  und(self):.     
-00024780: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-00024790: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
-000247a0: 2e50 6174 6845 7272 6f72 2920 6173 2063  .PathError) as c
-000247b0: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-000247c0: 656c 662e 636c 6965 6e74 2e70 756c 6c28  elf.client.pull(
-000247d0: 222f 6e6f 742f 666f 756e 6422 290a 2020  "/not/found").  
-000247e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-000247f0: 7445 7175 616c 2863 6d2e 6578 6365 7074  tEqual(cm.except
-00024800: 696f 6e2e 6b69 6e64 2c20 226e 6f74 2d66  ion.kind, "not-f
-00024810: 6f75 6e64 2229 0a20 2020 2020 2020 2073  ound").        s
-00024820: 656c 662e 6173 7365 7274 496e 2822 2f6e  elf.assertIn("/n
-00024830: 6f74 2f66 6f75 6e64 222c 2063 6d2e 6578  ot/found", cm.ex
-00024840: 6365 7074 696f 6e2e 6d65 7373 6167 6529  ception.message)
-00024850: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
-00024860: 756c 6c5f 6469 7265 6374 6f72 7928 7365  ull_directory(se
-00024870: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00024880: 662e 636c 6965 6e74 2e6d 616b 655f 6469  f.client.make_di
-00024890: 7228 6622 7b73 656c 662e 7072 6566 6978  r(f"{self.prefix
-000248a0: 7d2f 7375 6264 6972 2229 0a20 2020 2020  }/subdir").     
-000248b0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-000248c0: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
-000248d0: 2e50 6174 6845 7272 6f72 2920 6173 2063  .PathError) as c
-000248e0: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-000248f0: 656c 662e 636c 6965 6e74 2e70 756c 6c28  elf.client.pull(
-00024900: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00024910: 7375 6264 6972 2229 0a20 2020 2020 2020  subdir").       
-00024920: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00024930: 6c28 636d 2e65 7863 6570 7469 6f6e 2e6b  l(cm.exception.k
-00024940: 696e 642c 2022 6765 6e65 7269 632d 6669  ind, "generic-fi
-00024950: 6c65 2d65 7272 6f72 2229 0a20 2020 2020  le-error").     
-00024960: 2020 2073 656c 662e 6173 7365 7274 496e     self.assertIn
-00024970: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-00024980: 2f73 7562 6469 7222 2c20 636d 2e65 7863  /subdir", cm.exc
-00024990: 6570 7469 6f6e 2e6d 6573 7361 6765 290a  eption.message).
-000249a0: 0a20 2020 2064 6566 2074 6573 745f 6c69  .    def test_li
-000249b0: 7374 5f66 696c 6573 5f6e 6f74 5f66 6f75  st_files_not_fou
-000249c0: 6e64 5f72 6169 7365 7328 7365 6c66 293a  nd_raises(self):
-000249d0: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
-000249e0: 3d20 7365 6c66 2e63 6c69 656e 740a 2020  = self.client.  
-000249f0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00024a00: 6173 7365 7274 5261 6973 6573 2870 6562  assertRaises(peb
-00024a10: 626c 652e 4150 4945 7272 6f72 2920 6173  ble.APIError) as
-00024a20: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-00024a30: 2063 6c69 656e 742e 6c69 7374 5f66 696c   client.list_fil
-00024a40: 6573 2822 2f6e 6f74 2f65 7869 7374 696e  es("/not/existin
-00024a50: 672f 6669 6c65 2f22 290a 2020 2020 2020  g/file/").      
-00024a60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00024a70: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-00024a80: 636f 6465 2c20 3430 3429 0a20 2020 2020  code, 404).     
-00024a90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00024aa0: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
-00024ab0: 2e73 7461 7475 732c 2027 4e6f 7420 466f  .status, 'Not Fo
-00024ac0: 756e 6427 290a 2020 2020 2020 2020 7365  und').        se
-00024ad0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
-00024ae0: 6d2e 6578 6365 7074 696f 6e2e 6d65 7373  m.exception.mess
-00024af0: 6167 652c 2027 7374 6174 202f 6e6f 742f  age, 'stat /not/
-00024b00: 6578 6973 7469 6e67 2f66 696c 652f 3a20  existing/file/: 
-00024b10: 6e6f 2027 0a20 2020 2020 2020 2020 2020  no '.           
-00024b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024b40: 2020 2020 2773 7563 6820 6669 6c65 206f      'such file o
-00024b50: 7220 6469 7265 6374 6f72 7927 290a 0a20  r directory').. 
-00024b60: 2020 2064 6566 2074 6573 745f 6c69 7374     def test_list
-00024b70: 5f64 6972 6563 746f 7279 5f6f 626a 6563  _directory_objec
-00024b80: 745f 6974 7365 6c66 2873 656c 6629 3a0a  t_itself(self):.
-00024b90: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-00024ba0: 2073 656c 662e 636c 6965 6e74 0a0a 2020   self.client..  
-00024bb0: 2020 2020 2020 2320 5465 7374 2077 6974        # Test wit
-00024bc0: 6820 726f 6f74 2064 6972 0a20 2020 2020  h root dir.     
-00024bd0: 2020 2023 2028 5370 6563 6961 6c20 6361     # (Special ca
-00024be0: 7365 3b20 7765 2077 6f6e 2774 2070 7265  se; we won't pre
-00024bf0: 6669 7820 7468 6973 2c20 6576 656e 2077  fix this, even w
-00024c00: 6865 6e20 7573 696e 6720 7468 6520 7265  hen using the re
-00024c10: 616c 2050 6562 626c 6520 7365 7276 6572  al Pebble server
-00024c20: 2e29 0a20 2020 2020 2020 2066 696c 6573  .).        files
-00024c30: 203d 2063 6c69 656e 742e 6c69 7374 5f66   = client.list_f
-00024c40: 696c 6573 2827 2f27 2c20 6974 7365 6c66  iles('/', itself
-00024c50: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
-00024c60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00024c70: 6c65 6e28 6669 6c65 7329 2c20 3129 0a20  len(files), 1). 
-00024c80: 2020 2020 2020 2064 6972 5f20 3d20 6669         dir_ = fi
-00024c90: 6c65 735b 305d 0a20 2020 2020 2020 2073  les[0].        s
-00024ca0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00024cb0: 6469 725f 2e70 6174 682c 2027 2f27 290a  dir_.path, '/').
-00024cc0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00024cd0: 6572 7445 7175 616c 2864 6972 5f2e 6e61  ertEqual(dir_.na
-00024ce0: 6d65 2c20 272f 2729 0a20 2020 2020 2020  me, '/').       
-00024cf0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00024d00: 6c28 6469 725f 2e74 7970 652c 2070 6562  l(dir_.type, peb
-00024d10: 626c 652e 4669 6c65 5479 7065 2e44 4952  ble.FileType.DIR
-00024d20: 4543 544f 5259 290a 0a20 2020 2020 2020  ECTORY)..       
-00024d30: 2023 2054 6573 7420 7769 7468 2073 7562   # Test with sub
-00024d40: 6469 7273 0a20 2020 2020 2020 2063 6c69  dirs.        cli
-00024d50: 656e 742e 6d61 6b65 5f64 6972 2866 227b  ent.make_dir(f"{
-00024d60: 7365 6c66 2e70 7265 6669 787d 2f73 7562  self.prefix}/sub
-00024d70: 6469 7222 290a 2020 2020 2020 2020 6669  dir").        fi
-00024d80: 6c65 7320 3d20 636c 6965 6e74 2e6c 6973  les = client.lis
-00024d90: 745f 6669 6c65 7328 6622 7b73 656c 662e  t_files(f"{self.
-00024da0: 7072 6566 6978 7d2f 7375 6264 6972 222c  prefix}/subdir",
-00024db0: 2069 7473 656c 663d 5472 7565 290a 2020   itself=True).  
-00024dc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00024dd0: 7445 7175 616c 286c 656e 2866 696c 6573  tEqual(len(files
-00024de0: 292c 2031 290a 2020 2020 2020 2020 6469  ), 1).        di
-00024df0: 725f 203d 2066 696c 6573 5b30 5d0a 2020  r_ = files[0].  
-00024e00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00024e10: 7445 7175 616c 2864 6972 5f2e 6e61 6d65  tEqual(dir_.name
-00024e20: 2c20 2773 7562 6469 7227 290a 2020 2020  , 'subdir').    
-00024e30: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00024e40: 7175 616c 2864 6972 5f2e 7479 7065 2c20  qual(dir_.type, 
-00024e50: 7065 6262 6c65 2e46 696c 6554 7970 652e  pebble.FileType.
-00024e60: 4449 5245 4354 4f52 5929 0a0a 2020 2020  DIRECTORY)..    
-00024e70: 6465 6620 7465 7374 5f70 7573 685f 6669  def test_push_fi
-00024e80: 6c65 735f 616e 645f 6c69 7374 5f62 795f  les_and_list_by_
-00024e90: 7061 7474 6572 6e28 7365 6c66 293a 0a20  pattern(self):. 
-00024ea0: 2020 2020 2020 2023 204e 6f74 653a 2067         # Note: g
-00024eb0: 6c6f 6220 7061 7474 6572 6e20 6465 6c74  lob pattern delt
-00024ec0: 6173 2064 6f20 6578 6973 7420 6265 7477  as do exist betw
-00024ed0: 6565 6e20 676f 6c61 6e67 2061 6e64 2050  een golang and P
-00024ee0: 7974 686f 6e2c 2062 7574 2068 6572 652c  ython, but here,
-00024ef0: 0a20 2020 2020 2020 2023 2077 6527 6c6c  .        # we'll
-00024f00: 206a 7573 7420 7573 6520 6120 7369 6d70   just use a simp
-00024f10: 6c65 202a 2070 6174 7465 726e 2e0a 2020  le * pattern..  
-00024f20: 2020 2020 2020 6461 7461 203d 2027 6461        data = 'da
-00024f30: 7461 270a 2020 2020 2020 2020 636c 6965  ta'.        clie
-00024f40: 6e74 203d 2073 656c 662e 636c 6965 6e74  nt = self.client
-00024f50: 0a20 2020 2020 2020 2066 6f72 2066 696c  .        for fil
-00024f60: 656e 616d 6520 696e 2028 0a20 2020 2020  ename in (.     
-00024f70: 2020 2020 2020 2027 2f66 696c 6531 2e67         '/file1.g
-00024f80: 7a27 2c0a 2020 2020 2020 2020 2020 2020  z',.            
-00024f90: 272f 6669 6c65 322e 7461 722e 677a 272c  '/file2.tar.gz',
-00024fa0: 0a20 2020 2020 2020 2020 2020 2027 2f66  .            '/f
-00024fb0: 696c 6533 2e74 6172 2e62 7a32 272c 0a20  ile3.tar.bz2',. 
-00024fc0: 2020 2020 2020 2020 2020 2027 2f62 6163             '/bac
-00024fd0: 6b75 705f 6669 6c65 2e67 7a27 2c0a 2020  kup_file.gz',.  
-00024fe0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00024ff0: 2020 2020 2063 6c69 656e 742e 7075 7368       client.push
-00025000: 2873 656c 662e 7072 6566 6978 202b 2066  (self.prefix + f
-00025010: 696c 656e 616d 652c 2064 6174 6129 0a20  ilename, data). 
-00025020: 2020 2020 2020 2066 696c 6573 203d 2063         files = c
-00025030: 6c69 656e 742e 6c69 7374 5f66 696c 6573  lient.list_files
-00025040: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-00025050: 2f22 2c20 7061 7474 6572 6e3d 2766 696c  /", pattern='fil
-00025060: 652a 2e67 7a27 290a 2020 2020 2020 2020  e*.gz').        
-00025070: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00025080: 287b 6669 6c65 2e70 6174 6820 666f 7220  ({file.path for 
-00025090: 6669 6c65 2069 6e20 6669 6c65 737d 2c0a  file in files},.
-000250a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000250b0: 2020 2020 2020 2020 207b 7365 6c66 2e70           {self.p
-000250c0: 7265 6669 7820 2b20 6669 6c65 2066 6f72  refix + file for
-000250d0: 2066 696c 6520 696e 2028 272f 6669 6c65   file in ('/file
-000250e0: 312e 677a 272c 2027 2f66 696c 6532 2e74  1.gz', '/file2.t
-000250f0: 6172 2e67 7a27 297d 290a 0a20 2020 2064  ar.gz')})..    d
-00025100: 6566 2074 6573 745f 6d61 6b65 5f64 6972  ef test_make_dir
-00025110: 6563 746f 7279 2873 656c 6629 3a0a 2020  ectory(self):.  
-00025120: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
-00025130: 656c 662e 636c 6965 6e74 0a20 2020 2020  elf.client.     
-00025140: 2020 2063 6c69 656e 742e 6d61 6b65 5f64     client.make_d
-00025150: 6972 2866 227b 7365 6c66 2e70 7265 6669  ir(f"{self.prefi
-00025160: 787d 2f73 7562 6469 7222 290a 2020 2020  x}/subdir").    
-00025170: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00025180: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00025190: 2020 636c 6965 6e74 2e6c 6973 745f 6669    client.list_fi
-000251a0: 6c65 7328 6622 7b73 656c 662e 7072 6566  les(f"{self.pref
-000251b0: 6978 7d2f 222c 2070 6174 7465 726e 3d27  ix}/", pattern='
-000251c0: 7375 6264 6972 2729 5b30 5d2e 7061 7468  subdir')[0].path
-000251d0: 2c0a 2020 2020 2020 2020 2020 2020 6622  ,.            f"
-000251e0: 7b73 656c 662e 7072 6566 6978 7d2f 7375  {self.prefix}/su
-000251f0: 6264 6972 2229 0a20 2020 2020 2020 2063  bdir").        c
-00025200: 6c69 656e 742e 6d61 6b65 5f64 6972 2866  lient.make_dir(f
-00025210: 227b 7365 6c66 2e70 7265 6669 787d 2f73  "{self.prefix}/s
-00025220: 7562 6469 722f 7375 6264 6972 2229 0a20  ubdir/subdir"). 
-00025230: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00025240: 7274 4571 7561 6c28 0a20 2020 2020 2020  rtEqual(.       
-00025250: 2020 2020 2063 6c69 656e 742e 6c69 7374       client.list
-00025260: 5f66 696c 6573 2866 227b 7365 6c66 2e70  _files(f"{self.p
-00025270: 7265 6669 787d 2f73 7562 6469 7222 2c20  refix}/subdir", 
-00025280: 7061 7474 6572 6e3d 2773 7562 6469 7227  pattern='subdir'
-00025290: 295b 305d 2e70 6174 682c 0a20 2020 2020  )[0].path,.     
-000252a0: 2020 2020 2020 2066 227b 7365 6c66 2e70         f"{self.p
-000252b0: 7265 6669 787d 2f73 7562 6469 722f 7375  refix}/subdir/su
-000252c0: 6264 6972 2229 0a0a 2020 2020 6465 6620  bdir")..    def 
-000252d0: 7465 7374 5f6d 616b 655f 6469 7265 6374  test_make_direct
-000252e0: 6f72 795f 7265 6375 7273 6976 656c 7928  ory_recursively(
-000252f0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
-00025300: 6c69 656e 7420 3d20 7365 6c66 2e63 6c69  lient = self.cli
-00025310: 656e 740a 0a20 2020 2020 2020 2077 6974  ent..        wit
-00025320: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00025330: 7365 7328 7065 6262 6c65 2e50 6174 6845  ses(pebble.PathE
-00025340: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-00025350: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
-00025360: 6d61 6b65 5f64 6972 2866 227b 7365 6c66  make_dir(f"{self
-00025370: 2e70 7265 6669 787d 2f73 7562 6469 722f  .prefix}/subdir/
-00025380: 7375 6264 6972 222c 206d 616b 655f 7061  subdir", make_pa
-00025390: 7265 6e74 733d 4661 6c73 6529 0a20 2020  rents=False).   
-000253a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000253b0: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
-000253c0: 6f6e 2e6b 696e 642c 2027 6e6f 742d 666f  on.kind, 'not-fo
-000253d0: 756e 6427 290a 0a20 2020 2020 2020 2063  und')..        c
-000253e0: 6c69 656e 742e 6d61 6b65 5f64 6972 2866  lient.make_dir(f
-000253f0: 227b 7365 6c66 2e70 7265 6669 787d 2f73  "{self.prefix}/s
-00025400: 7562 6469 722f 7375 6264 6972 222c 206d  ubdir/subdir", m
-00025410: 616b 655f 7061 7265 6e74 733d 5472 7565  ake_parents=True
-00025420: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00025430: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
-00025440: 2020 2020 2020 2020 636c 6965 6e74 2e6c          client.l
-00025450: 6973 745f 6669 6c65 7328 6622 7b73 656c  ist_files(f"{sel
-00025460: 662e 7072 6566 6978 7d2f 7375 6264 6972  f.prefix}/subdir
-00025470: 222c 2070 6174 7465 726e 3d27 7375 6264  ", pattern='subd
-00025480: 6972 2729 5b30 5d2e 7061 7468 2c0a 2020  ir')[0].path,.  
-00025490: 2020 2020 2020 2020 2020 6622 7b73 656c            f"{sel
-000254a0: 662e 7072 6566 6978 7d2f 7375 6264 6972  f.prefix}/subdir
-000254b0: 2f73 7562 6469 7222 290a 0a20 2020 2064  /subdir")..    d
-000254c0: 6566 2074 6573 745f 6d61 6b65 5f64 6972  ef test_make_dir
-000254d0: 6563 746f 7279 5f77 6974 685f 7265 6c61  ectory_with_rela
-000254e0: 7469 7665 5f70 6174 685f 6661 696c 7328  tive_path_fails(
-000254f0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
-00025500: 6c69 656e 7420 3d20 7365 6c66 2e63 6c69  lient = self.cli
-00025510: 656e 740a 2020 2020 2020 2020 7769 7468  ent.        with
-00025520: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-00025530: 6573 2870 6562 626c 652e 5061 7468 4572  es(pebble.PathEr
-00025540: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
-00025550: 2020 2020 2020 2020 636c 6965 6e74 2e6d          client.m
-00025560: 616b 655f 6469 7228 2764 6972 2729 0a20  ake_dir('dir'). 
-00025570: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00025580: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
-00025590: 7469 6f6e 2e6b 696e 642c 2027 6765 6e65  tion.kind, 'gene
-000255a0: 7269 632d 6669 6c65 2d65 7272 6f72 2729  ric-file-error')
-000255b0: 0a0a 2020 2020 6465 6620 7465 7374 5f6d  ..    def test_m
-000255c0: 616b 655f 7375 6264 6972 5f6f 665f 6669  ake_subdir_of_fi
-000255d0: 6c65 5f66 6169 6c73 2873 656c 6629 3a0a  le_fails(self):.
-000255e0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-000255f0: 2073 656c 662e 636c 6965 6e74 0a20 2020   self.client.   
-00025600: 2020 2020 2063 6c69 656e 742e 7075 7368       client.push
-00025610: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-00025620: 2f66 696c 6522 2c20 2764 6174 6127 290a  /file", 'data').
-00025630: 0a20 2020 2020 2020 2023 2044 6972 6563  .        # Direc
-00025640: 7420 6368 696c 6420 6361 7365 0a20 2020  t child case.   
-00025650: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00025660: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
-00025670: 6c65 2e50 6174 6845 7272 6f72 2920 6173  le.PathError) as
-00025680: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-00025690: 2063 6c69 656e 742e 6d61 6b65 5f64 6972   client.make_dir
-000256a0: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
-000256b0: 2f66 696c 652f 7375 6264 6972 2229 0a20  /file/subdir"). 
-000256c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000256d0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
-000256e0: 7469 6f6e 2e6b 696e 642c 2027 6765 6e65  tion.kind, 'gene
-000256f0: 7269 632d 6669 6c65 2d65 7272 6f72 2729  ric-file-error')
-00025700: 0a0a 2020 2020 2020 2020 2320 5265 6375  ..        # Recu
-00025710: 7273 6976 6520 6372 6561 7469 6f6e 2063  rsive creation c
-00025720: 6173 652c 2069 6e20 6361 7365 2069 7473  ase, in case its
-00025730: 2066 6c6f 7720 6973 2064 6966 6665 7265   flow is differe
-00025740: 6e74 0a20 2020 2020 2020 2077 6974 6820  nt.        with 
-00025750: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
-00025760: 7328 7065 6262 6c65 2e50 6174 6845 7272  s(pebble.PathErr
-00025770: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
-00025780: 2020 2020 2020 2063 6c69 656e 742e 6d61         client.ma
-00025790: 6b65 5f64 6972 2866 227b 7365 6c66 2e70  ke_dir(f"{self.p
-000257a0: 7265 6669 787d 2f66 696c 652f 7375 6264  refix}/file/subd
-000257b0: 6972 2f73 7562 6469 7222 2c20 6d61 6b65  ir/subdir", make
-000257c0: 5f70 6172 656e 7473 3d54 7275 6529 0a20  _parents=True). 
-000257d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000257e0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
-000257f0: 7469 6f6e 2e6b 696e 642c 2027 6765 6e65  tion.kind, 'gene
-00025800: 7269 632d 6669 6c65 2d65 7272 6f72 2729  ric-file-error')
-00025810: 0a0a 2020 2020 6465 6620 7465 7374 5f6d  ..    def test_m
-00025820: 616b 655f 6469 725f 7769 7468 5f70 6572  ake_dir_with_per
-00025830: 6d69 7373 696f 6e5f 6d61 736b 2873 656c  mission_mask(sel
-00025840: 6629 3a0a 2020 2020 2020 2020 636c 6965  f):.        clie
-00025850: 6e74 203d 2073 656c 662e 636c 6965 6e74  nt = self.client
-00025860: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
-00025870: 6d61 6b65 5f64 6972 2866 227b 7365 6c66  make_dir(f"{self
-00025880: 2e70 7265 6669 787d 2f64 6972 3122 2c20  .prefix}/dir1", 
-00025890: 7065 726d 6973 7369 6f6e 733d 306f 3730  permissions=0o70
-000258a0: 3029 0a20 2020 2020 2020 2063 6c69 656e  0).        clien
-000258b0: 742e 6d61 6b65 5f64 6972 2866 227b 7365  t.make_dir(f"{se
-000258c0: 6c66 2e70 7265 6669 787d 2f64 6972 3222  lf.prefix}/dir2"
-000258d0: 2c20 7065 726d 6973 7369 6f6e 733d 306f  , permissions=0o
-000258e0: 3737 3729 0a0a 2020 2020 2020 2020 6669  777)..        fi
-000258f0: 6c65 7320 3d20 636c 6965 6e74 2e6c 6973  les = client.lis
-00025900: 745f 6669 6c65 7328 6622 7b73 656c 662e  t_files(f"{self.
-00025910: 7072 6566 6978 7d2f 222c 2070 6174 7465  prefix}/", patte
-00025920: 726e 3d27 6469 722a 2729 0a20 2020 2020  rn='dir*').     
-00025930: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00025940: 7561 6c28 5b66 2066 6f72 2066 2069 6e20  ual([f for f in 
-00025950: 6669 6c65 7320 6966 2066 2e70 6174 6820  files if f.path 
-00025960: 3d3d 2066 227b 7365 6c66 2e70 7265 6669  == f"{self.prefi
-00025970: 787d 2f64 6972 3122 5d0a 2020 2020 2020  x}/dir1"].      
-00025980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025990: 2020 205b 305d 2e70 6572 6d69 7373 696f     [0].permissio
-000259a0: 6e73 2c20 306f 3730 3029 0a20 2020 2020  ns, 0o700).     
-000259b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000259c0: 7561 6c28 5b66 2066 6f72 2066 2069 6e20  ual([f for f in 
-000259d0: 6669 6c65 7320 6966 2066 2e70 6174 6820  files if f.path 
-000259e0: 3d3d 2066 227b 7365 6c66 2e70 7265 6669  == f"{self.prefi
-000259f0: 787d 2f64 6972 3222 5d0a 2020 2020 2020  x}/dir2"].      
-00025a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a10: 2020 205b 305d 2e70 6572 6d69 7373 696f     [0].permissio
-00025a20: 6e73 2c20 306f 3737 3729 0a0a 2020 2020  ns, 0o777)..    
-00025a30: 2020 2020 2320 4966 2070 6572 6d69 7373      # If permiss
-00025a40: 696f 6e73 2061 7265 206f 7574 7369 6465  ions are outside
-00025a50: 206f 6620 7468 6520 7261 6e67 6520 306f   of the range 0o
-00025a60: 3030 3020 7468 726f 7567 6820 306f 3737  000 through 0o77
-00025a70: 372c 2061 6e20 6578 6365 7074 696f 6e20  7, an exception 
-00025a80: 7368 6f75 6c64 2062 650a 2020 2020 2020  should be.      
-00025a90: 2020 2320 7261 6973 6564 2e0a 2020 2020    # raised..    
-00025aa0: 2020 2020 666f 7220 692c 2062 6164 5f70      for i, bad_p
-00025ab0: 6572 6d69 7373 696f 6e20 696e 2065 6e75  ermission in enu
-00025ac0: 6d65 7261 7465 2828 0a20 2020 2020 2020  merate((.       
-00025ad0: 2020 2020 2030 6f31 3030 302c 2020 2320       0o1000,  # 
-00025ae0: 4578 6365 6564 7320 306f 3737 370a 2020  Exceeds 0o777.  
-00025af0: 2020 2020 2020 2020 2020 2d31 2c20 2020            -1,   
-00025b00: 2020 2023 204c 6573 7320 7468 616e 2030     # Less than 0
-00025b10: 6f30 3030 0a20 2020 2020 2020 2029 293a  o000.        )):
-00025b20: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00025b30: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-00025b40: 7365 7328 7065 6262 6c65 2e50 6174 6845  ses(pebble.PathE
-00025b50: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-00025b60: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-00025b70: 656e 742e 6d61 6b65 5f64 6972 2866 227b  ent.make_dir(f"{
-00025b80: 7365 6c66 2e70 7265 6669 787d 2f64 6972  self.prefix}/dir
-00025b90: 335f 7b69 7d22 2c20 7065 726d 6973 7369  3_{i}", permissi
-00025ba0: 6f6e 733d 6261 645f 7065 726d 6973 7369  ons=bad_permissi
-00025bb0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-00025bc0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00025bd0: 2863 6d2e 6578 6365 7074 696f 6e2e 6b69  (cm.exception.ki
-00025be0: 6e64 2c20 2767 656e 6572 6963 2d66 696c  nd, 'generic-fil
-00025bf0: 652d 6572 726f 7227 290a 0a20 2020 2064  e-error')..    d
-00025c00: 6566 2074 6573 745f 7265 6d6f 7665 5f70  ef test_remove_p
-00025c10: 6174 6828 7365 6c66 293a 0a20 2020 2020  ath(self):.     
-00025c20: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00025c30: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
-00025c40: 636c 6965 6e74 2e70 7573 6828 6622 7b73  client.push(f"{s
-00025c50: 656c 662e 7072 6566 6978 7d2f 6669 6c65  elf.prefix}/file
-00025c60: 222c 2027 2729 0a20 2020 2020 2020 2063  ", '').        c
-00025c70: 6c69 656e 742e 6d61 6b65 5f64 6972 2866  lient.make_dir(f
-00025c80: 227b 7365 6c66 2e70 7265 6669 787d 2f64  "{self.prefix}/d
-00025c90: 6972 2f73 7562 6469 7222 2c20 6d61 6b65  ir/subdir", make
-00025ca0: 5f70 6172 656e 7473 3d54 7275 6529 0a20  _parents=True). 
-00025cb0: 2020 2020 2020 2063 6c69 656e 742e 7075         client.pu
-00025cc0: 7368 2866 227b 7365 6c66 2e70 7265 6669  sh(f"{self.prefi
-00025cd0: 787d 2f64 6972 2f73 7562 6469 722f 6669  x}/dir/subdir/fi
-00025ce0: 6c65 3122 2c20 2727 290a 2020 2020 2020  le1", '').      
-00025cf0: 2020 636c 6965 6e74 2e70 7573 6828 6622    client.push(f"
-00025d00: 7b73 656c 662e 7072 6566 6978 7d2f 6469  {self.prefix}/di
-00025d10: 722f 7375 6264 6972 2f66 696c 6532 222c  r/subdir/file2",
-00025d20: 2027 2729 0a20 2020 2020 2020 2063 6c69   '').        cli
-00025d30: 656e 742e 7075 7368 2866 227b 7365 6c66  ent.push(f"{self
-00025d40: 2e70 7265 6669 787d 2f64 6972 2f73 7562  .prefix}/dir/sub
-00025d50: 6469 722f 6669 6c65 3322 2c20 2727 290a  dir/file3", '').
-00025d60: 2020 2020 2020 2020 636c 6965 6e74 2e6d          client.m
-00025d70: 616b 655f 6469 7228 6622 7b73 656c 662e  ake_dir(f"{self.
-00025d80: 7072 6566 6978 7d2f 656d 7074 795f 6469  prefix}/empty_di
-00025d90: 7222 290a 0a20 2020 2020 2020 2063 6c69  r")..        cli
-00025da0: 656e 742e 7265 6d6f 7665 5f70 6174 6828  ent.remove_path(
-00025db0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00025dc0: 6669 6c65 2229 0a0a 2020 2020 2020 2020  file")..        
-00025dd0: 636c 6965 6e74 2e72 656d 6f76 655f 7061  client.remove_pa
-00025de0: 7468 2866 227b 7365 6c66 2e70 7265 6669  th(f"{self.prefi
-00025df0: 787d 2f65 6d70 7479 5f64 6972 2229 0a0a  x}/empty_dir")..
-00025e00: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-00025e10: 206e 6f6e 2d65 6d70 7479 2064 6972 6563   non-empty direc
-00025e20: 746f 7279 2c20 7265 6375 7273 6976 653d  tory, recursive=
-00025e30: 4661 6c73 653a 2065 7272 6f72 0a20 2020  False: error.   
-00025e40: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-00025e50: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
-00025e60: 6c65 2e50 6174 6845 7272 6f72 2920 6173  le.PathError) as
-00025e70: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-00025e80: 2063 6c69 656e 742e 7265 6d6f 7665 5f70   client.remove_p
-00025e90: 6174 6828 6622 7b73 656c 662e 7072 6566  ath(f"{self.pref
-00025ea0: 6978 7d2f 6469 7222 2c20 7265 6375 7273  ix}/dir", recurs
-00025eb0: 6976 653d 4661 6c73 6529 0a20 2020 2020  ive=False).     
-00025ec0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00025ed0: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
-00025ee0: 2e6b 696e 642c 2027 6765 6e65 7269 632d  .kind, 'generic-
-00025ef0: 6669 6c65 2d65 7272 6f72 2729 0a0a 2020  file-error')..  
-00025f00: 2020 2020 2020 2320 5265 6d6f 7665 206e        # Remove n
-00025f10: 6f6e 2d65 6d70 7479 2064 6972 6563 746f  on-empty directo
-00025f20: 7279 2c20 7265 6375 7273 6976 653d 5472  ry, recursive=Tr
-00025f30: 7565 3a20 7375 6363 6565 6473 2028 616e  ue: succeeds (an
-00025f40: 6420 7265 6d6f 7665 7320 6368 696c 6420  d removes child 
-00025f50: 6f62 6a65 6374 7329 0a20 2020 2020 2020  objects).       
-00025f60: 2063 6c69 656e 742e 7265 6d6f 7665 5f70   client.remove_p
-00025f70: 6174 6828 6622 7b73 656c 662e 7072 6566  ath(f"{self.pref
-00025f80: 6978 7d2f 6469 7222 2c20 7265 6375 7273  ix}/dir", recurs
-00025f90: 6976 653d 5472 7565 290a 0a20 2020 2020  ive=True)..     
-00025fa0: 2020 2023 2052 656d 6f76 6520 6e6f 6e2d     # Remove non-
-00025fb0: 6578 6973 7465 6e74 2070 6174 682c 2072  existent path, r
-00025fc0: 6563 7572 7369 7665 3d46 616c 7365 3a20  ecursive=False: 
-00025fd0: 6572 726f 720a 2020 2020 2020 2020 7769  error.        wi
-00025fe0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
-00025ff0: 6973 6573 2870 6562 626c 652e 5061 7468  ises(pebble.Path
-00026000: 4572 726f 7229 2061 7320 636d 3a0a 2020  Error) as cm:.  
-00026010: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00026020: 2e72 656d 6f76 655f 7061 7468 2866 227b  .remove_path(f"{
-00026030: 7365 6c66 2e70 7265 6669 787d 2f64 6972  self.prefix}/dir
-00026040: 2f64 6f65 732f 6e6f 742f 6578 6973 742f  /does/not/exist/
-00026050: 6173 6466 222c 2072 6563 7572 7369 7665  asdf", recursive
-00026060: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
-00026070: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00026080: 2863 6d2e 6578 6365 7074 696f 6e2e 6b69  (cm.exception.ki
-00026090: 6e64 2c20 276e 6f74 2d66 6f75 6e64 2729  nd, 'not-found')
-000260a0: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
-000260b0: 7665 206e 6f6e 2d65 7869 7374 656e 7420  ve non-existent 
-000260c0: 7061 7468 2c20 7265 6375 7273 6976 653d  path, recursive=
-000260d0: 5472 7565 3a20 7375 6363 6565 6473 0a20  True: succeeds. 
-000260e0: 2020 2020 2020 2063 6c69 656e 742e 7265         client.re
-000260f0: 6d6f 7665 5f70 6174 6828 6622 7b73 656c  move_path(f"{sel
-00026100: 662e 7072 6566 6978 7d2f 6469 722f 646f  f.prefix}/dir/do
-00026110: 6573 2f6e 6f74 2f65 7869 7374 2f61 7364  es/not/exist/asd
-00026120: 6622 2c20 7265 6375 7273 6976 653d 5472  f", recursive=Tr
-00026130: 7565 290a 0a20 2020 2023 204f 7468 6572  ue)..    # Other
-00026140: 206e 6f74 6573 3a0a 2020 2020 2320 2a20   notes:.    # * 
-00026150: 5061 7265 6e74 2064 6972 6563 746f 7269  Parent directori
-00026160: 6573 2063 7265 6174 6564 2076 6961 2070  es created via p
-00026170: 7573 6828 6d61 6b65 5f64 6972 733d 5472  ush(make_dirs=Tr
-00026180: 7565 2920 6465 6661 756c 7420 746f 2072  ue) default to r
-00026190: 6f6f 743a 726f 6f74 206f 776e 6572 7368  oot:root ownersh
-000261a0: 6970 0a20 2020 2023 2020 2061 6e64 2077  ip.    #   and w
-000261b0: 6861 7465 7665 7220 7065 726d 6973 7369  hatever permissi
-000261c0: 6f6e 7320 6172 6520 7370 6563 6966 6965  ons are specifie
-000261d0: 6420 7669 6120 7468 6520 7065 726d 6973  d via the permis
-000261e0: 7369 6f6e 7320 6172 6775 6d65 6e74 3b20  sions argument; 
-000261f0: 6173 2077 6520 6465 6661 756c 7420 746f  as we default to
-00026200: 204e 6f6e 650a 2020 2020 2320 2020 666f   None.    #   fo
-00026210: 7220 6f77 6e65 7273 6869 702f 7065 726d  r ownership/perm
-00026220: 6973 7369 6f6e 732c 2077 6520 646f 2069  issions, we do i
-00026230: 676e 6f72 6520 7468 6973 206e 7561 6e63  gnore this nuanc
-00026240: 652e 0a20 2020 2023 202a 2050 6172 656e  e..    # * Paren
-00026250: 7420 6469 7265 6374 6f72 6965 7320 6372  t directories cr
-00026260: 6561 7465 6420 7669 6120 6d61 6b65 5f64  eated via make_d
-00026270: 6972 286d 616b 655f 7061 7265 6e74 733d  ir(make_parents=
-00026280: 5472 7565 2920 6465 6661 756c 7420 746f  True) default to
-00026290: 2072 6f6f 743a 726f 6f74 206f 776e 6572   root:root owner
-000262a0: 7368 6970 0a20 2020 2023 2020 2061 6e64  ship.    #   and
-000262b0: 2030 6f37 3535 2070 6572 6d69 7373 696f   0o755 permissio
-000262c0: 6e73 3b20 6173 2077 6520 6465 6661 756c  ns; as we defaul
-000262d0: 7420 746f 204e 6f6e 6520 666f 7220 6f77  t to None for ow
-000262e0: 6e65 7273 6869 702f 7065 726d 6973 7369  nership/permissi
-000262f0: 6f6e 732c 2077 6520 646f 2069 676e 6f72  ons, we do ignor
-00026300: 6520 7468 6973 0a20 2020 2023 2020 206e  e this.    #   n
-00026310: 7561 6e63 652e 0a0a 0a63 6c61 7373 2047  uance....class G
-00026320: 656e 6572 6963 5465 7374 696e 6746 696c  enericTestingFil
-00026330: 6573 7973 7465 6d54 6573 7473 3a0a 2020  esystemTests:.  
-00026340: 2020 6465 6620 7465 7374 5f6c 6973 7464    def test_listd
-00026350: 6972 5f72 6f6f 745f 6f6e 5f65 6d70 7479  ir_root_on_empty
-00026360: 5f6f 7328 7365 6c66 293a 0a20 2020 2020  _os(self):.     
-00026370: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-00026380: 7561 6c28 7365 6c66 2e66 732e 6c69 7374  ual(self.fs.list
-00026390: 5f64 6972 2827 2f27 292c 205b 5d29 0a0a  _dir('/'), [])..
-000263a0: 2020 2020 6465 6620 7465 7374 5f6c 6973      def test_lis
-000263b0: 7464 6972 5f6f 6e5f 6e6f 6e65 7869 7374  tdir_on_nonexist
-000263c0: 656e 745f 6469 7228 7365 6c66 293a 0a20  ent_dir(self):. 
-000263d0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000263e0: 2e61 7373 6572 7452 6169 7365 7328 4669  .assertRaises(Fi
-000263f0: 6c65 4e6f 7446 6f75 6e64 4572 726f 7229  leNotFoundError)
-00026400: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
-00026410: 2020 2020 7365 6c66 2e66 732e 6c69 7374      self.fs.list
-00026420: 5f64 6972 2827 2f65 7463 2729 0a20 2020  _dir('/etc').   
-00026430: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00026440: 5472 7565 2827 2f65 7463 2720 696e 2063  True('/etc' in c
-00026450: 6d2e 6578 6365 7074 696f 6e2e 6172 6773  m.exception.args
-00026460: 5b30 5d29 0a0a 2020 2020 6465 6620 7465  [0])..    def te
-00026470: 7374 5f6c 6973 7464 6972 2873 656c 6629  st_listdir(self)
-00026480: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
-00026490: 732e 6372 6561 7465 5f64 6972 2827 2f6f  s.create_dir('/o
-000264a0: 7074 2729 0a20 2020 2020 2020 2073 656c  pt').        sel
-000264b0: 662e 6673 2e63 7265 6174 655f 6669 6c65  f.fs.create_file
-000264c0: 2827 2f6f 7074 2f66 696c 6531 272c 2027  ('/opt/file1', '
-000264d0: 6461 7461 2729 0a20 2020 2020 2020 2073  data').        s
-000264e0: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
-000264f0: 6c65 2827 2f6f 7074 2f66 696c 6532 272c  le('/opt/file2',
-00026500: 2027 6461 7461 2729 0a20 2020 2020 2020   'data').       
-00026510: 2065 7870 6563 7465 645f 7265 7375 6c74   expected_result
-00026520: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-00026530: 2020 7061 7468 6c69 622e 5075 7265 506f    pathlib.PurePo
-00026540: 7369 7850 6174 6828 272f 6f70 742f 6669  sixPath('/opt/fi
-00026550: 6c65 3127 292c 0a20 2020 2020 2020 2020  le1'),.         
-00026560: 2020 2070 6174 686c 6962 2e50 7572 6550     pathlib.PureP
-00026570: 6f73 6978 5061 7468 2827 2f6f 7074 2f66  osixPath('/opt/f
-00026580: 696c 6532 2729 7d0a 2020 2020 2020 2020  ile2')}.        
-00026590: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000265a0: 2865 7870 6563 7465 645f 7265 7375 6c74  (expected_result
-000265b0: 732c 207b 662e 7061 7468 2066 6f72 2066  s, {f.path for f
-000265c0: 2069 6e20 7365 6c66 2e66 732e 6c69 7374   in self.fs.list
-000265d0: 5f64 6972 2827 2f6f 7074 2729 7d29 0a20  _dir('/opt')}). 
-000265e0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-000265f0: 7468 6174 2050 6174 6873 2061 6c73 6f20  that Paths also 
-00026600: 776f 726b 2066 6f72 206c 6973 7464 6972  work for listdir
-00026610: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00026620: 7365 7274 4571 7561 6c28 0a20 2020 2020  sertEqual(.     
-00026630: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00026640: 7265 7375 6c74 732c 207b 662e 7061 7468  results, {f.path
-00026650: 2066 6f72 2066 2069 6e20 7365 6c66 2e66   for f in self.f
-00026660: 732e 6c69 7374 5f64 6972 2870 6174 686c  s.list_dir(pathl
-00026670: 6962 2e50 7572 6550 6f73 6978 5061 7468  ib.PurePosixPath
-00026680: 2827 2f6f 7074 2729 297d 290a 0a20 2020  ('/opt'))})..   
-00026690: 2064 6566 2074 6573 745f 6c69 7374 6469   def test_listdi
-000266a0: 725f 6f6e 5f66 696c 6528 7365 6c66 293a  r_on_file(self):
-000266b0: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-000266c0: 2e63 7265 6174 655f 6669 6c65 2827 2f66  .create_file('/f
-000266d0: 696c 6527 2c20 2764 6174 6127 290a 2020  ile', 'data').  
-000266e0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000266f0: 6173 7365 7274 5261 6973 6573 284e 6f74  assertRaises(Not
-00026700: 4144 6972 6563 746f 7279 4572 726f 7229  ADirectoryError)
-00026710: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
-00026720: 2020 2020 7365 6c66 2e66 732e 6c69 7374      self.fs.list
-00026730: 5f64 6972 2827 2f66 696c 6527 290a 2020  _dir('/file').  
-00026740: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00026750: 7454 7275 6528 272f 6669 6c65 2720 696e  tTrue('/file' in
-00026760: 2063 6d2e 6578 6365 7074 696f 6e2e 6172   cm.exception.ar
-00026770: 6773 5b30 5d29 0a0a 2020 2020 6465 6620  gs[0])..    def 
-00026780: 7465 7374 5f6d 616b 6564 6972 2873 656c  test_makedir(sel
-00026790: 6629 3a0a 2020 2020 2020 2020 6420 3d20  f):.        d = 
-000267a0: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-000267b0: 6972 2827 2f65 7463 2729 0a20 2020 2020  ir('/etc').     
-000267c0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-000267d0: 7561 6c28 642e 6e61 6d65 2c20 2765 7463  ual(d.name, 'etc
-000267e0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-000267f0: 6173 7365 7274 4571 7561 6c28 642e 7061  assertEqual(d.pa
-00026800: 7468 2c20 7061 7468 6c69 622e 5075 7265  th, pathlib.Pure
-00026810: 506f 7369 7850 6174 6828 272f 6574 6327  PosixPath('/etc'
-00026820: 2929 0a20 2020 2020 2020 2064 3220 3d20  )).        d2 = 
-00026830: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-00026840: 6972 2827 2f65 7463 2f69 6e69 742e 6427  ir('/etc/init.d'
-00026850: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00026860: 7373 6572 7445 7175 616c 2864 322e 6e61  ssertEqual(d2.na
-00026870: 6d65 2c20 2769 6e69 742e 6427 290a 2020  me, 'init.d').  
-00026880: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00026890: 7445 7175 616c 2864 322e 7061 7468 2c20  tEqual(d2.path, 
-000268a0: 7061 7468 6c69 622e 5075 7265 506f 7369  pathlib.PurePosi
-000268b0: 7850 6174 6828 272f 6574 632f 696e 6974  xPath('/etc/init
-000268c0: 2e64 2729 290a 0a20 2020 2064 6566 2074  .d'))..    def t
-000268d0: 6573 745f 6d61 6b65 6469 725f 6661 696c  est_makedir_fail
-000268e0: 735f 6966 5f61 6c72 6561 6479 5f65 7869  s_if_already_exi
-000268f0: 7374 7328 7365 6c66 293a 0a20 2020 2020  sts(self):.     
-00026900: 2020 2073 656c 662e 6673 2e63 7265 6174     self.fs.creat
-00026910: 655f 6469 7228 272f 6574 6327 290a 2020  e_dir('/etc').  
-00026920: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00026930: 6173 7365 7274 5261 6973 6573 2846 696c  assertRaises(Fil
-00026940: 6545 7869 7374 7345 7272 6f72 2920 6173  eExistsError) as
-00026950: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
-00026960: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
-00026970: 6469 7228 272f 6574 6327 290a 2020 2020  dir('/etc').    
-00026980: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00026990: 7275 6528 272f 6574 6327 2069 6e20 636d  rue('/etc' in cm
-000269a0: 2e65 7863 6570 7469 6f6e 2e61 7267 735b  .exception.args[
-000269b0: 305d 290a 0a20 2020 2064 6566 2074 6573  0])..    def tes
-000269c0: 745f 6d61 6b65 6469 725f 7375 6363 6565  t_makedir_succee
-000269d0: 6473 5f69 665f 616c 7265 6164 795f 6578  ds_if_already_ex
-000269e0: 6973 7473 5f77 6865 6e5f 6d61 6b65 5f70  ists_when_make_p
-000269f0: 6172 656e 7473 5f74 7275 6528 7365 6c66  arents_true(self
-00026a00: 293a 0a20 2020 2020 2020 2064 3120 3d20  ):.        d1 = 
-00026a10: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-00026a20: 6972 2827 2f65 7463 2729 0a20 2020 2020  ir('/etc').     
-00026a30: 2020 2064 3220 3d20 7365 6c66 2e66 732e     d2 = self.fs.
-00026a40: 6372 6561 7465 5f64 6972 2827 2f65 7463  create_dir('/etc
-00026a50: 272c 206d 616b 655f 7061 7265 6e74 733d  ', make_parents=
-00026a60: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
-00026a70: 6c66 2e61 7373 6572 7445 7175 616c 2864  lf.assertEqual(d
-00026a80: 312e 7061 7468 2c20 6432 2e70 6174 6829  1.path, d2.path)
-00026a90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00026aa0: 7365 7274 4571 7561 6c28 6431 2e6e 616d  sertEqual(d1.nam
-00026ab0: 652c 2064 322e 6e61 6d65 290a 0a20 2020  e, d2.name)..   
-00026ac0: 2064 6566 2074 6573 745f 6d61 6b65 6469   def test_makedi
-00026ad0: 725f 6661 696c 735f 6966 5f70 6172 656e  r_fails_if_paren
-00026ae0: 745f 6469 725f 646f 6573 6e74 5f65 7869  t_dir_doesnt_exi
-00026af0: 7374 2873 656c 6629 3a0a 2020 2020 2020  st(self):.      
-00026b00: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00026b10: 7274 5261 6973 6573 2846 696c 654e 6f74  rtRaises(FileNot
-00026b20: 466f 756e 6445 7272 6f72 2920 6173 2063  FoundError) as c
-00026b30: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-00026b40: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
-00026b50: 7228 272f 6574 632f 696e 6974 2e64 2729  r('/etc/init.d')
-00026b60: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00026b70: 7365 7274 5472 7565 2827 2f65 7463 2720  sertTrue('/etc' 
-00026b80: 696e 2063 6d2e 6578 6365 7074 696f 6e2e  in cm.exception.
-00026b90: 6172 6773 5b30 5d29 0a0a 2020 2020 6465  args[0])..    de
-00026ba0: 6620 7465 7374 5f6d 616b 655f 616e 645f  f test_make_and_
-00026bb0: 6c69 7374 5f64 6972 6563 746f 7279 2873  list_directory(s
-00026bc0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00026bd0: 6c66 2e66 732e 6372 6561 7465 5f64 6972  lf.fs.create_dir
-00026be0: 2827 2f65 7463 2729 0a20 2020 2020 2020  ('/etc').       
-00026bf0: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
-00026c00: 6469 7228 272f 7661 7227 290a 2020 2020  dir('/var').    
-00026c10: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00026c20: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
-00026c30: 2020 7b66 2e70 6174 6820 666f 7220 6620    {f.path for f 
-00026c40: 696e 2073 656c 662e 6673 2e6c 6973 745f  in self.fs.list_
-00026c50: 6469 7228 272f 2729 7d2c 0a20 2020 2020  dir('/')},.     
-00026c60: 2020 2020 2020 207b 7061 7468 6c69 622e         {pathlib.
-00026c70: 5075 7265 506f 7369 7850 6174 6828 272f  PurePosixPath('/
-00026c80: 6574 6327 292c 2070 6174 686c 6962 2e50  etc'), pathlib.P
-00026c90: 7572 6550 6f73 6978 5061 7468 2827 2f76  urePosixPath('/v
-00026ca0: 6172 2729 7d29 0a0a 2020 2020 6465 6620  ar')})..    def 
-00026cb0: 7465 7374 5f6d 616b 655f 6469 7265 6374  test_make_direct
-00026cc0: 6f72 795f 7265 6375 7273 6976 656c 7928  ory_recursively(
-00026cd0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00026ce0: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
-00026cf0: 7228 272f 6574 632f 696e 6974 2e64 272c  r('/etc/init.d',
-00026d00: 206d 616b 655f 7061 7265 6e74 733d 5472   make_parents=Tr
-00026d10: 7565 290a 2020 2020 2020 2020 7365 6c66  ue).        self
-00026d20: 2e61 7373 6572 7445 7175 616c 285b 7374  .assertEqual([st
-00026d30: 7228 6f2e 7061 7468 2920 666f 7220 6f20  r(o.path) for o 
-00026d40: 696e 2073 656c 662e 6673 2e6c 6973 745f  in self.fs.list_
-00026d50: 6469 7228 272f 2729 5d2c 205b 272f 6574  dir('/')], ['/et
-00026d60: 6327 5d29 0a20 2020 2020 2020 2073 656c  c']).        sel
-00026d70: 662e 6173 7365 7274 4571 7561 6c28 5b73  f.assertEqual([s
-00026d80: 7472 286f 2e70 6174 6829 2066 6f72 206f  tr(o.path) for o
-00026d90: 2069 6e20 7365 6c66 2e66 732e 6c69 7374   in self.fs.list
-00026da0: 5f64 6972 2827 2f65 7463 2729 5d2c 205b  _dir('/etc')], [
-00026db0: 272f 6574 632f 696e 6974 2e64 275d 290a  '/etc/init.d']).
-00026dc0: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
-00026dd0: 6b65 6469 725f 7061 7468 5f6d 7573 745f  kedir_path_must_
-00026de0: 7374 6172 745f 7769 7468 5f73 6c61 7368  start_with_slash
-00026df0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00026e00: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-00026e10: 5261 6973 6573 284e 6f6e 4162 736f 6c75  Raises(NonAbsolu
-00026e20: 7465 5061 7468 4572 726f 7229 3a0a 2020  tePathError):.  
-00026e30: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-00026e40: 732e 6372 6561 7465 5f64 6972 2822 6e6f  s.create_dir("no
-00026e50: 736c 6173 6822 290a 0a20 2020 2064 6566  slash")..    def
-00026e60: 2074 6573 745f 6372 6561 7465 5f66 696c   test_create_fil
-00026e70: 655f 6661 696c 735f 6966 5f70 6172 656e  e_fails_if_paren
-00026e80: 745f 6469 725f 646f 6573 6e74 5f65 7869  t_dir_doesnt_exi
-00026e90: 7374 2873 656c 6629 3a0a 2020 2020 2020  st(self):.      
-00026ea0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-00026eb0: 7274 5261 6973 6573 2846 696c 654e 6f74  rtRaises(FileNot
-00026ec0: 466f 756e 6445 7272 6f72 2920 6173 2063  FoundError) as c
-00026ed0: 6d3a 0a20 2020 2020 2020 2020 2020 2073  m:.            s
-00026ee0: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
-00026ef0: 6c65 2827 2f65 7463 2f70 6173 7377 6427  le('/etc/passwd'
-00026f00: 2c20 2266 6f6f 2229 0a20 2020 2020 2020  , "foo").       
-00026f10: 2073 656c 662e 6173 7365 7274 5472 7565   self.assertTrue
-00026f20: 2827 2f65 7463 2720 696e 2063 6d2e 6578  ('/etc' in cm.ex
-00026f30: 6365 7074 696f 6e2e 6172 6773 5b30 5d29  ception.args[0])
-00026f40: 0a0a 2020 2020 6465 6620 7465 7374 5f63  ..    def test_c
-00026f50: 7265 6174 655f 6669 6c65 5f73 7563 6365  reate_file_succe
-00026f60: 6564 735f 6966 5f70 6172 656e 745f 6469  eds_if_parent_di
-00026f70: 725f 646f 6573 6e74 5f65 7869 7374 5f77  r_doesnt_exist_w
-00026f80: 6865 6e5f 6d61 6b65 5f64 6972 735f 7472  hen_make_dirs_tr
-00026f90: 7565 2873 656c 6629 3a0a 2020 2020 2020  ue(self):.      
-00026fa0: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
-00026fb0: 5f66 696c 6528 272f 7465 7374 2f73 7562  _file('/test/sub
-00026fc0: 6469 722f 7465 7374 6669 6c65 272c 2022  dir/testfile', "
-00026fd0: 666f 6f22 2c20 6d61 6b65 5f64 6972 733d  foo", make_dirs=
-00026fe0: 5472 7565 290a 2020 2020 2020 2020 7769  True).        wi
-00026ff0: 7468 2073 656c 662e 6673 2e6f 7065 6e28  th self.fs.open(
-00027000: 272f 7465 7374 2f73 7562 6469 722f 7465  '/test/subdir/te
-00027010: 7374 6669 6c65 2729 2061 7320 696e 6669  stfile') as infi
-00027020: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00027030: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-00027040: 2869 6e66 696c 652e 7265 6164 2829 2c20  (infile.read(), 
-00027050: 2766 6f6f 2729 0a0a 2020 2020 6465 6620  'foo')..    def 
-00027060: 7465 7374 5f63 7265 6174 655f 6669 6c65  test_create_file
-00027070: 5f66 726f 6d5f 7374 7228 7365 6c66 293a  _from_str(self):
-00027080: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-00027090: 2e63 7265 6174 655f 6669 6c65 2827 2f74  .create_file('/t
-000270a0: 6573 7427 2c20 2266 6f6f 2229 0a20 2020  est', "foo").   
-000270b0: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
-000270c0: 732e 6f70 656e 2827 2f74 6573 7427 2920  s.open('/test') 
-000270d0: 6173 2069 6e66 696c 653a 0a20 2020 2020  as infile:.     
-000270e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-000270f0: 7274 4571 7561 6c28 696e 6669 6c65 2e72  rtEqual(infile.r
-00027100: 6561 6428 292c 2027 666f 6f27 290a 0a20  ead(), 'foo').. 
-00027110: 2020 2064 6566 2074 6573 745f 6372 6561     def test_crea
-00027120: 7465 5f66 696c 655f 6672 6f6d 5f62 7974  te_file_from_byt
-00027130: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
-00027140: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
-00027150: 5f66 696c 6528 272f 7465 7374 272c 2062  _file('/test', b
-00027160: 2266 6f6f 2229 0a20 2020 2020 2020 2077  "foo").        w
-00027170: 6974 6820 7365 6c66 2e66 732e 6f70 656e  ith self.fs.open
-00027180: 2827 2f74 6573 7427 2c20 656e 636f 6469  ('/test', encodi
-00027190: 6e67 3d4e 6f6e 6529 2061 7320 696e 6669  ng=None) as infi
-000271a0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-000271b0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000271c0: 2869 6e66 696c 652e 7265 6164 2829 2c20  (infile.read(), 
-000271d0: 6227 666f 6f27 290a 0a20 2020 2064 6566  b'foo')..    def
-000271e0: 2074 6573 745f 6372 6561 7465 5f66 696c   test_create_fil
-000271f0: 655f 6672 6f6d 5f66 696c 6573 2873 656c  e_from_files(sel
-00027200: 6629 3a0a 2020 2020 2020 2020 6461 7461  f):.        data
-00027210: 203d 2022 666f 6f22 0a0a 2020 2020 2020   = "foo"..      
-00027220: 2020 7369 6f20 3d20 5374 7269 6e67 494f    sio = StringIO
-00027230: 2864 6174 6129 0a20 2020 2020 2020 2073  (data).        s
-00027240: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
-00027250: 6c65 2827 2f74 6573 7427 2c20 7369 6f29  le('/test', sio)
-00027260: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00027270: 6c66 2e66 732e 6f70 656e 2827 2f74 6573  lf.fs.open('/tes
-00027280: 7427 2920 6173 2069 6e66 696c 653a 0a20  t') as infile:. 
-00027290: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000272a0: 6173 7365 7274 4571 7561 6c28 696e 6669  assertEqual(infi
-000272b0: 6c65 2e72 6561 6428 292c 2027 666f 6f27  le.read(), 'foo'
-000272c0: 290a 0a20 2020 2020 2020 2062 696f 203d  )..        bio =
-000272d0: 2042 7974 6573 494f 2864 6174 612e 656e   BytesIO(data.en
-000272e0: 636f 6465 2829 290a 2020 2020 2020 2020  code()).        
-000272f0: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
-00027300: 696c 6528 272f 7465 7374 3227 2c20 6269  ile('/test2', bi
-00027310: 6f29 0a20 2020 2020 2020 2077 6974 6820  o).        with 
-00027320: 7365 6c66 2e66 732e 6f70 656e 2827 2f74  self.fs.open('/t
-00027330: 6573 7432 2729 2061 7320 696e 6669 6c65  est2') as infile
-00027340: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00027350: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
-00027360: 6e66 696c 652e 7265 6164 2829 2c20 2766  nfile.read(), 'f
-00027370: 6f6f 2729 0a0a 2020 2020 6465 6620 7465  oo')..    def te
-00027380: 7374 5f63 7265 6174 655f 616e 645f 7265  st_create_and_re
-00027390: 6164 5f77 6974 685f 6469 6666 6572 656e  ad_with_differen
-000273a0: 745f 656e 636f 6469 6e67 7328 7365 6c66  t_encodings(self
-000273b0: 293a 0a20 2020 2020 2020 2023 2077 7269  ):.        # wri
-000273c0: 7465 2073 7472 2c20 7265 6164 2061 7320  te str, read as 
-000273d0: 7574 662d 3820 6279 7465 730a 2020 2020  utf-8 bytes.    
-000273e0: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
-000273f0: 7465 5f66 696c 6528 272f 7465 7374 272c  te_file('/test',
-00027400: 2022 666f 6f22 290a 2020 2020 2020 2020   "foo").        
-00027410: 7769 7468 2073 656c 662e 6673 2e6f 7065  with self.fs.ope
-00027420: 6e28 272f 7465 7374 272c 2065 6e63 6f64  n('/test', encod
-00027430: 696e 673d 4e6f 6e65 2920 6173 2069 6e66  ing=None) as inf
-00027440: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
-00027450: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00027460: 6c28 696e 6669 6c65 2e72 6561 6428 292c  l(infile.read(),
-00027470: 2062 2766 6f6f 2729 0a0a 2020 2020 2020   b'foo')..      
-00027480: 2020 2320 7772 6974 6520 6279 7465 732c    # write bytes,
-00027490: 2072 6561 6420 6173 2075 7466 2d38 2d64   read as utf-8-d
-000274a0: 6563 6f64 6564 2073 7472 0a20 2020 2020  ecoded str.     
-000274b0: 2020 2064 6174 6120 3d20 22e6 97a5 e69c     data = ".....
-000274c0: ace8 aa9e 2220 2023 204a 6170 616e 6573  ...."  # Japanes
-000274d0: 6520 666f 7220 224a 6170 616e 6573 6522  e for "Japanese"
-000274e0: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
-000274f0: 2e63 7265 6174 655f 6669 6c65 2827 2f74  .create_file('/t
-00027500: 6573 7432 272c 2064 6174 612e 656e 636f  est2', data.enco
-00027510: 6465 2827 7574 662d 3827 2929 0a20 2020  de('utf-8')).   
-00027520: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
-00027530: 732e 6f70 656e 2827 2f74 6573 7432 2729  s.open('/test2')
-00027540: 2061 7320 696e 6669 6c65 3a20 2020 2020   as infile:     
-00027550: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00027560: 2049 6d70 6c69 6369 7420 7574 662d 3820   Implicit utf-8 
-00027570: 7265 6164 0a20 2020 2020 2020 2020 2020  read.           
-00027580: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00027590: 6c28 696e 6669 6c65 2e72 6561 6428 292c  l(infile.read(),
-000275a0: 2064 6174 6129 0a20 2020 2020 2020 2077   data).        w
-000275b0: 6974 6820 7365 6c66 2e66 732e 6f70 656e  ith self.fs.open
-000275c0: 2827 2f74 6573 7432 272c 2065 6e63 6f64  ('/test2', encod
-000275d0: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
-000275e0: 696e 6669 6c65 3a20 2023 2045 7870 6c69  infile:  # Expli
-000275f0: 6369 7420 7574 662d 3820 7265 6164 0a20  cit utf-8 read. 
-00027600: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00027610: 6173 7365 7274 4571 7561 6c28 696e 6669  assertEqual(infi
-00027620: 6c65 2e72 6561 6428 292c 2064 6174 6129  le.read(), data)
-00027630: 0a0a 2020 2020 6465 6620 7465 7374 5f6f  ..    def test_o
-00027640: 7065 6e5f 6469 7265 6374 6f72 795f 6661  pen_directory_fa
-00027650: 696c 7328 7365 6c66 293a 0a20 2020 2020  ils(self):.     
-00027660: 2020 2073 656c 662e 6673 2e63 7265 6174     self.fs.creat
-00027670: 655f 6469 7228 272f 6469 7231 2729 0a20  e_dir('/dir1'). 
-00027680: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00027690: 2e61 7373 6572 7452 6169 7365 7328 4973  .assertRaises(Is
-000276a0: 4144 6972 6563 746f 7279 4572 726f 7229  ADirectoryError)
-000276b0: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
-000276c0: 2020 2020 7365 6c66 2e66 732e 6f70 656e      self.fs.open
-000276d0: 2827 2f64 6972 3127 290a 2020 2020 2020  ('/dir1').      
-000276e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-000276f0: 616c 2863 6d2e 6578 6365 7074 696f 6e2e  al(cm.exception.
-00027700: 6172 6773 5b30 5d2c 2027 2f64 6972 3127  args[0], '/dir1'
-00027710: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00027720: 6465 6c65 7465 5f66 696c 6528 7365 6c66  delete_file(self
-00027730: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00027740: 6673 2e63 7265 6174 655f 6669 6c65 2827  fs.create_file('
-00027750: 2f74 6573 7427 2c20 2266 6f6f 2229 0a20  /test', "foo"). 
-00027760: 2020 2020 2020 2073 656c 662e 6673 2e64         self.fs.d
-00027770: 656c 6574 655f 7061 7468 2827 2f74 6573  elete_path('/tes
-00027780: 7427 290a 2020 2020 2020 2020 7769 7468  t').        with
-00027790: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
-000277a0: 6573 2846 696c 654e 6f74 466f 756e 6445  es(FileNotFoundE
-000277b0: 7272 6f72 2920 6173 2063 6d3a 0a20 2020  rror) as cm:.   
-000277c0: 2020 2020 2020 2020 2073 656c 662e 6673           self.fs
-000277d0: 2e67 6574 5f70 6174 6828 272f 7465 7374  .get_path('/test
-000277e0: 2729 0a0a 2020 2020 2020 2020 2320 4465  ')..        # De
-000277f0: 6c65 7469 6e67 2064 656c 6574 6564 2066  leting deleted f
-00027800: 696c 6573 2073 686f 756c 6420 6661 696c  iles should fail
-00027810: 2061 7320 7765 6c6c 0a20 2020 2020 2020   as well.       
-00027820: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-00027830: 7452 6169 7365 7328 4669 6c65 4e6f 7446  tRaises(FileNotF
-00027840: 6f75 6e64 4572 726f 7229 2061 7320 636d  oundError) as cm
-00027850: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00027860: 6c66 2e66 732e 6465 6c65 7465 5f70 6174  lf.fs.delete_pat
-00027870: 6828 272f 7465 7374 2729 0a20 2020 2020  h('/test').     
-00027880: 2020 2073 656c 662e 6173 7365 7274 5472     self.assertTr
-00027890: 7565 2827 2f74 6573 7427 2069 6e20 636d  ue('/test' in cm
-000278a0: 2e65 7863 6570 7469 6f6e 2e61 7267 735b  .exception.args[
-000278b0: 305d 290a 0a20 2020 2064 6566 2074 6573  0])..    def tes
-000278c0: 745f 6372 6561 7465 5f64 6972 5f77 6974  t_create_dir_wit
-000278d0: 685f 6578 7472 615f 6172 6773 2873 656c  h_extra_args(sel
-000278e0: 6629 3a0a 2020 2020 2020 2020 6420 3d20  f):.        d = 
-000278f0: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-00027900: 6972 2827 2f64 6972 3127 290a 2020 2020  ir('/dir1').    
-00027910: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00027920: 7175 616c 2864 2e6b 7761 7267 732c 207b  qual(d.kwargs, {
-00027930: 7d29 0a0a 2020 2020 2020 2020 6420 3d20  })..        d = 
-00027940: 7365 6c66 2e66 732e 6372 6561 7465 5f64  self.fs.create_d
-00027950: 6972 280a 2020 2020 2020 2020 2020 2020  ir(.            
-00027960: 272f 6469 7232 272c 2070 6572 6d69 7373  '/dir2', permiss
-00027970: 696f 6e73 3d30 6f37 3030 2c20 7573 6572  ions=0o700, user
-00027980: 3d27 7562 756e 7475 272c 2075 7365 725f  ='ubuntu', user_
-00027990: 6964 3d31 3030 302c 2067 726f 7570 3d27  id=1000, group='
-000279a0: 7777 772d 6461 7461 272c 2067 726f 7570  www-data', group
-000279b0: 5f69 643d 3333 290a 2020 2020 2020 2020  _id=33).        
-000279c0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-000279d0: 2864 2e6b 7761 7267 732c 207b 0a20 2020  (d.kwargs, {.   
-000279e0: 2020 2020 2020 2020 2027 7065 726d 6973           'permis
-000279f0: 7369 6f6e 7327 3a20 306f 3730 302c 0a20  sions': 0o700,. 
-00027a00: 2020 2020 2020 2020 2020 2027 7573 6572             'user
-00027a10: 273a 2027 7562 756e 7475 272c 0a20 2020  ': 'ubuntu',.   
-00027a20: 2020 2020 2020 2020 2027 7573 6572 5f69           'user_i
-00027a30: 6427 3a20 3130 3030 2c0a 2020 2020 2020  d': 1000,.      
-00027a40: 2020 2020 2020 2767 726f 7570 273a 2027        'group': '
-00027a50: 7777 772d 6461 7461 272c 0a20 2020 2020  www-data',.     
-00027a60: 2020 2020 2020 2027 6772 6f75 705f 6964         'group_id
-00027a70: 273a 2033 332c 0a20 2020 2020 2020 207d  ': 33,.        }
-00027a80: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-00027a90: 6372 6561 7465 5f66 696c 655f 7769 7468  create_file_with
-00027aa0: 5f65 7874 7261 5f61 7267 7328 7365 6c66  _extra_args(self
-00027ab0: 293a 0a20 2020 2020 2020 2066 203d 2073  ):.        f = s
-00027ac0: 656c 662e 6673 2e63 7265 6174 655f 6669  elf.fs.create_fi
-00027ad0: 6c65 2827 2f66 696c 6531 272c 2027 6461  le('/file1', 'da
-00027ae0: 7461 2729 0a20 2020 2020 2020 2073 656c  ta').        sel
-00027af0: 662e 6173 7365 7274 4571 7561 6c28 662e  f.assertEqual(f.
-00027b00: 6b77 6172 6773 2c20 7b7d 290a 0a20 2020  kwargs, {})..   
-00027b10: 2020 2020 2066 203d 2073 656c 662e 6673       f = self.fs
-00027b20: 2e63 7265 6174 655f 6669 6c65 280a 2020  .create_file(.  
-00027b30: 2020 2020 2020 2020 2020 272f 6669 6c65            '/file
-00027b40: 3227 2c20 2764 6174 6127 2c0a 2020 2020  2', 'data',.    
-00027b50: 2020 2020 2020 2020 7065 726d 6973 7369          permissi
-00027b60: 6f6e 733d 306f 3735 342c 2075 7365 723d  ons=0o754, user=
-00027b70: 2775 6275 6e74 7527 2c20 7573 6572 5f69  'ubuntu', user_i
-00027b80: 643d 3130 3030 2c20 6772 6f75 703d 2777  d=1000, group='w
-00027b90: 7777 2d64 6174 6127 2c20 6772 6f75 705f  ww-data', group_
-00027ba0: 6964 3d33 3329 0a20 2020 2020 2020 2073  id=33).        s
-00027bb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00027bc0: 662e 6b77 6172 6773 2c20 7b0a 2020 2020  f.kwargs, {.    
-00027bd0: 2020 2020 2020 2020 2770 6572 6d69 7373          'permiss
-00027be0: 696f 6e73 273a 2030 6f37 3534 2c0a 2020  ions': 0o754,.  
-00027bf0: 2020 2020 2020 2020 2020 2775 7365 7227            'user'
-00027c00: 3a20 2775 6275 6e74 7527 2c0a 2020 2020  : 'ubuntu',.    
-00027c10: 2020 2020 2020 2020 2775 7365 725f 6964          'user_id
-00027c20: 273a 2031 3030 302c 0a20 2020 2020 2020  ': 1000,.       
-00027c30: 2020 2020 2027 6772 6f75 7027 3a20 2777       'group': 'w
-00027c40: 7777 2d64 6174 6127 2c0a 2020 2020 2020  ww-data',.      
-00027c50: 2020 2020 2020 2767 726f 7570 5f69 6427        'group_id'
-00027c60: 3a20 3333 2c0a 2020 2020 2020 2020 7d29  : 33,.        })
-00027c70: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-00027c80: 6574 6174 7472 2873 656c 6629 3a0a 2020  etattr(self):.  
-00027c90: 2020 2020 2020 7365 6c66 2e66 732e 6372        self.fs.cr
-00027ca0: 6561 7465 5f64 6972 2827 2f65 7463 2f69  eate_dir('/etc/i
-00027cb0: 6e69 742e 6427 2c20 6d61 6b65 5f70 6172  nit.d', make_par
-00027cc0: 656e 7473 3d54 7275 6529 0a0a 2020 2020  ents=True)..    
-00027cd0: 2020 2020 2320 4279 2070 6174 680a 2020      # By path.  
-00027ce0: 2020 2020 2020 6f20 3d20 7365 6c66 2e66        o = self.f
-00027cf0: 732e 6765 745f 7061 7468 2870 6174 686c  s.get_path(pathl
-00027d00: 6962 2e50 7572 6550 6f73 6978 5061 7468  ib.PurePosixPath
-00027d10: 2827 2f65 7463 2f69 6e69 742e 6427 2929  ('/etc/init.d'))
-00027d20: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00027d30: 7365 7274 4973 496e 7374 616e 6365 286f  sertIsInstance(o
-00027d40: 2c20 5f44 6972 6563 746f 7279 290a 2020  , _Directory).  
-00027d50: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00027d60: 7445 7175 616c 286f 2e70 6174 682c 2070  tEqual(o.path, p
-00027d70: 6174 686c 6962 2e50 7572 6550 6f73 6978  athlib.PurePosix
-00027d80: 5061 7468 2827 2f65 7463 2f69 6e69 742e  Path('/etc/init.
-00027d90: 6427 2929 0a0a 2020 2020 2020 2020 2320  d'))..        # 
-00027da0: 4279 2073 7472 0a20 2020 2020 2020 206f  By str.        o
-00027db0: 203d 2073 656c 662e 6673 2e67 6574 5f70   = self.fs.get_p
-00027dc0: 6174 6828 272f 6574 632f 696e 6974 2e64  ath('/etc/init.d
-00027dd0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-00027de0: 6173 7365 7274 4973 496e 7374 616e 6365  assertIsInstance
-00027df0: 286f 2c20 5f44 6972 6563 746f 7279 290a  (o, _Directory).
-00027e00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00027e10: 6572 7445 7175 616c 286f 2e70 6174 682c  ertEqual(o.path,
-00027e20: 2070 6174 686c 6962 2e50 7572 6550 6f73   pathlib.PurePos
-00027e30: 6978 5061 7468 2827 2f65 7463 2f69 6e69  ixPath('/etc/ini
-00027e40: 742e 6427 2929 0a0a 2020 2020 6465 6620  t.d'))..    def 
-00027e50: 7465 7374 5f67 6574 6174 7472 5f66 696c  test_getattr_fil
-00027e60: 655f 6e6f 745f 666f 756e 6428 7365 6c66  e_not_found(self
-00027e70: 293a 0a20 2020 2020 2020 2023 2041 7267  ):.        # Arg
-00027e80: 7561 626c 7920 7468 6973 2063 6f75 6c64  uably this could
-00027e90: 2062 6520 6120 4b65 7945 7272 6f72 2067   be a KeyError g
-00027ea0: 6976 656e 2074 6865 2064 6963 7469 6f6e  iven the diction
-00027eb0: 6172 792d 7374 796c 6520 6163 6365 7373  ary-style access
-00027ec0: 2e0a 2020 2020 2020 2020 2320 486f 7765  ..        # Howe
-00027ed0: 7665 722c 2046 696c 654e 6f74 466f 756e  ver, FileNotFoun
-00027ee0: 6445 7272 6f72 2073 6565 6d73 206d 6f72  dError seems mor
-00027ef0: 6520 6170 7072 6f70 7269 6174 6520 666f  e appropriate fo
-00027f00: 7220 6120 6669 6c65 7379 7374 656d 2c20  r a filesystem, 
-00027f10: 616e 6420 6974 0a20 2020 2020 2020 2023  and it.        #
-00027f20: 2067 6976 6573 2061 2063 6c6f 7365 7220   gives a closer 
-00027f30: 7365 6d61 6e74 6963 2066 6565 6c69 6e67  semantic feeling
-00027f40: 2c20 696e 206d 7920 6f70 696e 696f 6e2e  , in my opinion.
-00027f50: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00027f60: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-00027f70: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-00027f80: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
-00027f90: 2020 2020 2020 7365 6c66 2e66 732e 6765        self.fs.ge
-00027fa0: 745f 7061 7468 2827 2f6e 6f6e 6578 6973  t_path('/nonexis
-00027fb0: 7465 6e74 5f66 696c 6527 290a 2020 2020  tent_file').    
-00027fc0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-00027fd0: 7275 6528 272f 6e6f 6e65 7869 7374 656e  rue('/nonexisten
-00027fe0: 745f 6669 6c65 2720 696e 2063 6d2e 6578  t_file' in cm.ex
-00027ff0: 6365 7074 696f 6e2e 6172 6773 5b30 5d29  ception.args[0])
-00028000: 0a0a 0a63 6c61 7373 2054 6573 7454 6573  ...class TestTes
-00028010: 7469 6e67 4669 6c65 7379 7374 656d 2847  tingFilesystem(G
-00028020: 656e 6572 6963 5465 7374 696e 6746 696c  enericTestingFil
-00028030: 6573 7973 7465 6d54 6573 7473 2c20 756e  esystemTests, un
-00028040: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
-00028050: 3a0a 2020 2020 6465 6620 7365 7455 7028  :.    def setUp(
-00028060: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-00028070: 656c 662e 6673 203d 205f 5465 7374 696e  elf.fs = _Testin
-00028080: 6746 696c 6573 7973 7465 6d28 290a 0a20  gFilesystem().. 
-00028090: 2020 2064 6566 2074 6573 745f 7374 6f72     def test_stor
-000280a0: 6167 655f 6d6f 756e 7428 7365 6c66 293a  age_mount(self):
-000280b0: 0a20 2020 2020 2020 2074 6d70 6469 7220  .        tmpdir 
-000280c0: 3d20 7465 6d70 6669 6c65 2e54 656d 706f  = tempfile.Tempo
-000280d0: 7261 7279 4469 7265 6374 6f72 7928 290a  raryDirectory().
-000280e0: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
-000280f0: 6164 645f 6d6f 756e 7428 2766 6f6f 272c  add_mount('foo',
-00028100: 2027 2f66 6f6f 272c 2074 6d70 6469 722e   '/foo', tmpdir.
-00028110: 6e61 6d65 290a 2020 2020 2020 2020 7365  name).        se
-00028120: 6c66 2e66 732e 6372 6561 7465 5f66 696c  lf.fs.create_fil
-00028130: 6528 272f 666f 6f2f 6261 722f 6261 7a2e  e('/foo/bar/baz.
-00028140: 7478 7427 2c20 2771 7575 7827 2c20 6d61  txt', 'quux', ma
-00028150: 6b65 5f64 6972 733d 5472 7565 290a 0a20  ke_dirs=True).. 
-00028160: 2020 2020 2020 2074 6d70 7061 7468 203d         tmppath =
-00028170: 206f 732e 7061 7468 2e6a 6f69 6e28 746d   os.path.join(tm
-00028180: 7064 6972 2e6e 616d 652c 2027 6261 722f  pdir.name, 'bar/
-00028190: 6261 7a2e 7478 7427 290a 2020 2020 2020  baz.txt').      
-000281a0: 2020 7365 6c66 2e61 7373 6572 7454 7275    self.assertTru
-000281b0: 6528 6f73 2e70 6174 682e 6578 6973 7473  e(os.path.exists
-000281c0: 2874 6d70 7061 7468 2929 0a20 2020 2020  (tmppath)).     
-000281d0: 2020 2077 6974 6820 6f70 656e 2874 6d70     with open(tmp
-000281e0: 7061 7468 2920 6173 2066 3a0a 2020 2020  path) as f:.    
-000281f0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-00028200: 6572 7445 7175 616c 2866 2e72 6561 6428  ertEqual(f.read(
-00028210: 292c 2027 7175 7578 2729 0a0a 0a63 6c61  ), 'quux')...cla
-00028220: 7373 2054 6573 7454 6573 7469 6e67 5374  ss TestTestingSt
-00028230: 6f72 6167 654d 6f75 6e74 2847 656e 6572  orageMount(Gener
-00028240: 6963 5465 7374 696e 6746 696c 6573 7973  icTestingFilesys
-00028250: 7465 6d54 6573 7473 2c20 756e 6974 7465  temTests, unitte
-00028260: 7374 2e54 6573 7443 6173 6529 3a0a 2020  st.TestCase):.  
-00028270: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
-00028280: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00028290: 746d 7020 3d20 7465 6d70 6669 6c65 2e54  tmp = tempfile.T
-000282a0: 656d 706f 7261 7279 4469 7265 6374 6f72  emporaryDirector
-000282b0: 7928 290a 2020 2020 2020 2020 7365 6c66  y().        self
-000282c0: 2e61 6464 436c 6561 6e75 7028 7365 6c66  .addCleanup(self
-000282d0: 2e74 6d70 2e63 6c65 616e 7570 290a 2020  .tmp.cleanup).  
-000282e0: 2020 2020 2020 7365 6c66 2e66 7320 3d20        self.fs = 
-000282f0: 5f54 6573 7469 6e67 5374 6f72 6167 654d  _TestingStorageM
-00028300: 6f75 6e74 2827 2f27 2c20 7061 7468 6c69  ount('/', pathli
-00028310: 622e 5061 7468 2873 656c 662e 746d 702e  b.Path(self.tmp.
-00028320: 6e61 6d65 2929 0a0a 0a63 6c61 7373 2054  name))...class T
-00028330: 6573 7450 6562 626c 6553 746f 7261 6765  estPebbleStorage
-00028340: 4150 4973 5573 696e 674d 6f63 6b73 280a  APIsUsingMocks(.
-00028350: 2020 2020 2020 2020 756e 6974 7465 7374          unittest
-00028360: 2e54 6573 7443 6173 652c 0a20 2020 2020  .TestCase,.     
-00028370: 2020 205f 5465 7374 696e 6750 6562 626c     _TestingPebbl
-00028380: 6543 6c69 656e 744d 6978 696e 2c0a 2020  eClientMixin,.  
-00028390: 2020 2020 2020 5f50 6562 626c 6553 746f        _PebbleSto
-000283a0: 7261 6765 4150 4973 5465 7374 4d69 7869  rageAPIsTestMixi
-000283b0: 6e29 3a0a 2020 2020 6465 6620 7365 7455  n):.    def setU
-000283c0: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
-000283d0: 2073 656c 662e 7072 6566 6978 203d 2027   self.prefix = '
-000283e0: 2f70 7265 6669 7827 0a20 2020 2020 2020  /prefix'.       
-000283f0: 2073 656c 662e 636c 6965 6e74 203d 2073   self.client = s
-00028400: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
-00028410: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
-00028420: 2069 6620 7365 6c66 2e70 7265 6669 783a   if self.prefix:
-00028430: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00028440: 662e 636c 6965 6e74 2e6d 616b 655f 6469  f.client.make_di
-00028450: 7228 7365 6c66 2e70 7265 6669 782c 206d  r(self.prefix, m
-00028460: 616b 655f 7061 7265 6e74 733d 5472 7565  ake_parents=True
-00028470: 290a 0a20 2020 2040 756e 6974 7465 7374  )..    @unittest
-00028480: 2e73 6b69 7055 6e6c 6573 7328 6973 5f6c  .skipUnless(is_l
-00028490: 696e 7578 2c20 2750 6562 626c 6520 7275  inux, 'Pebble ru
-000284a0: 6e73 206f 6e20 4c69 6e75 7827 290a 2020  ns on Linux').  
-000284b0: 2020 6465 6620 7465 7374 5f63 6f6e 7461    def test_conta
-000284c0: 696e 6572 5f73 746f 7261 6765 5f6d 6f75  iner_storage_mou
-000284d0: 6e74 7328 7365 6c66 293a 0a20 2020 2020  nts(self):.     
-000284e0: 2020 2068 6172 6e65 7373 203d 2048 6172     harness = Har
-000284f0: 6e65 7373 2843 6861 726d 4261 7365 2c20  ness(CharmBase, 
-00028500: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
-00028510: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
-00028520: 6170 700a 2020 2020 2020 2020 2020 2020  app.            
-00028530: 636f 6e74 6169 6e65 7273 3a0a 2020 2020  containers:.    
-00028540: 2020 2020 2020 2020 2020 2020 6331 3a0a              c1:.
-00028550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028560: 2020 2020 6d6f 756e 7473 3a0a 2020 2020      mounts:.    
-00028570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028580: 2020 2020 2d20 7374 6f72 6167 653a 2073      - storage: s
-00028590: 746f 7265 310a 2020 2020 2020 2020 2020  tore1.          
-000285a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285b0: 6c6f 6361 7469 6f6e 3a20 2f6d 6f75 6e74  location: /mount
-000285c0: 732f 666f 6f0a 2020 2020 2020 2020 2020  s/foo.          
-000285d0: 2020 2020 2020 6332 3a0a 2020 2020 2020        c2:.      
-000285e0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-000285f0: 756e 7473 3a0a 2020 2020 2020 2020 2020  unts:.          
-00028600: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
-00028610: 7374 6f72 6167 653a 2073 746f 7265 320a  storage: store2.
-00028620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028630: 2020 2020 2020 2020 2020 6c6f 6361 7469            locati
-00028640: 6f6e 3a20 2f6d 6f75 6e74 732f 666f 6f0a  on: /mounts/foo.
-00028650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028660: 6333 3a0a 2020 2020 2020 2020 2020 2020  c3:.            
-00028670: 2020 2020 2020 2020 6d6f 756e 7473 3a0a          mounts:.
-00028680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028690: 2020 2020 2020 2020 2d20 7374 6f72 6167          - storag
-000286a0: 653a 2073 746f 7265 310a 2020 2020 2020  e: store1.      
-000286b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000286c0: 2020 2020 6c6f 6361 7469 6f6e 3a20 2f6d      location: /m
-000286d0: 6f75 6e74 732f 6261 720a 2020 2020 2020  ounts/bar.      
-000286e0: 2020 2020 2020 7374 6f72 6167 653a 0a20        storage:. 
-000286f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00028700: 746f 7265 313a 0a20 2020 2020 2020 2020  tore1:.         
-00028710: 2020 2020 2020 2020 2020 2074 7970 653a             type:
-00028720: 2066 696c 6573 7973 7465 6d0a 2020 2020   filesystem.    
-00028730: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00028740: 6532 3a0a 2020 2020 2020 2020 2020 2020  e2:.            
-00028750: 2020 2020 2020 2020 7479 7065 3a20 6669          type: fi
-00028760: 6c65 7379 7374 656d 0a20 2020 2020 2020  lesystem.       
-00028770: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
-00028780: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-00028790: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-000287a0: 7029 0a0a 2020 2020 2020 2020 7374 6f72  p)..        stor
-000287b0: 655f 6964 203d 2068 6172 6e65 7373 2e61  e_id = harness.a
-000287c0: 6464 5f73 746f 7261 6765 2827 7374 6f72  dd_storage('stor
-000287d0: 6531 2729 5b30 5d0a 2020 2020 2020 2020  e1')[0].        
-000287e0: 6861 726e 6573 732e 6174 7461 6368 5f73  harness.attach_s
-000287f0: 746f 7261 6765 2873 746f 7265 5f69 6429  torage(store_id)
-00028800: 0a0a 2020 2020 2020 2020 6861 726e 6573  ..        harnes
-00028810: 732e 6265 6769 6e28 290a 2020 2020 2020  s.begin().      
-00028820: 2020 6861 726e 6573 732e 7365 745f 6361    harness.set_ca
-00028830: 6e5f 636f 6e6e 6563 7428 2763 3127 2c20  n_connect('c1', 
-00028840: 5472 7565 290a 2020 2020 2020 2020 6861  True).        ha
-00028850: 726e 6573 732e 7365 745f 6361 6e5f 636f  rness.set_can_co
-00028860: 6e6e 6563 7428 2763 3227 2c20 5472 7565  nnect('c2', True
-00028870: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-00028880: 732e 7365 745f 6361 6e5f 636f 6e6e 6563  s.set_can_connec
-00028890: 7428 2763 3327 2c20 5472 7565 290a 0a20  t('c3', True).. 
-000288a0: 2020 2020 2020 2023 2070 7573 6820 6669         # push fi
-000288b0: 6c65 2074 6f20 6331 2073 746f 7261 6765  le to c1 storage
-000288c0: 206d 6f75 6e74 2c20 6368 6563 6b20 7468   mount, check th
-000288d0: 6174 2077 6520 6361 6e20 7365 6520 6974  at we can see it
-000288e0: 2069 6e20 6368 6172 6d20 636f 6e74 6169   in charm contai
-000288f0: 6e65 7220 7374 6f72 6167 6520 7061 7468  ner storage path
-00028900: 2e0a 2020 2020 2020 2020 6331 203d 2068  ..        c1 = h
-00028910: 6172 6e65 7373 2e6d 6f64 656c 2e75 6e69  arness.model.uni
-00028920: 742e 6765 745f 636f 6e74 6169 6e65 7228  t.get_container(
-00028930: 2763 3127 290a 2020 2020 2020 2020 6331  'c1').        c1
-00028940: 5f66 6e61 6d65 203d 2027 666f 6f2e 7478  _fname = 'foo.tx
-00028950: 7427 0a20 2020 2020 2020 2063 315f 6670  t'.        c1_fp
-00028960: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
-00028970: 696e 2827 2f6d 6f75 6e74 732f 666f 6f27  in('/mounts/foo'
-00028980: 2c20 6331 5f66 6e61 6d65 290a 2020 2020  , c1_fname).    
-00028990: 2020 2020 6331 2e70 7573 6828 6331 5f66      c1.push(c1_f
-000289a0: 7061 7468 2c20 2734 3227 290a 2020 2020  path, '42').    
-000289b0: 2020 2020 7365 6c66 2e61 7373 6572 7454      self.assertT
-000289c0: 7275 6528 6331 2e65 7869 7374 7328 6331  rue(c1.exists(c1
-000289d0: 5f66 7061 7468 2929 0a20 2020 2020 2020  _fpath)).       
-000289e0: 2066 7061 7468 203d 206f 732e 7061 7468   fpath = os.path
-000289f0: 2e6a 6f69 6e28 7374 7228 6861 726e 6573  .join(str(harnes
-00028a00: 732e 6d6f 6465 6c2e 7374 6f72 6167 6573  s.model.storages
-00028a10: 5b27 7374 6f72 6531 275d 5b30 5d2e 6c6f  ['store1'][0].lo
-00028a20: 6361 7469 6f6e 292c 2027 666f 6f2e 7478  cation), 'foo.tx
-00028a30: 7427 290a 2020 2020 2020 2020 7769 7468  t').        with
-00028a40: 206f 7065 6e28 6670 6174 6829 2061 7320   open(fpath) as 
-00028a50: 663a 0a20 2020 2020 2020 2020 2020 2073  f:.            s
-00028a60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00028a70: 2734 3227 2c20 662e 7265 6164 2829 290a  '42', f.read()).
-00028a80: 0a20 2020 2020 2020 2023 2063 6865 636b  .        # check
-00028a90: 2074 6861 7420 7468 6520 6669 6c65 2069   that the file i
-00028aa0: 7320 6e6f 7420 7669 7369 626c 6520 696e  s not visible in
-00028ab0: 2063 3220 7768 6963 6820 6861 7320 6120   c2 which has a 
-00028ac0: 6469 6666 6572 656e 7420 7374 6f72 6167  different storag
-00028ad0: 6520 6d6f 756e 740a 2020 2020 2020 2020  e mount.        
-00028ae0: 6332 203d 2068 6172 6e65 7373 2e6d 6f64  c2 = harness.mod
-00028af0: 656c 2e75 6e69 742e 6765 745f 636f 6e74  el.unit.get_cont
-00028b00: 6169 6e65 7228 2763 3227 290a 2020 2020  ainer('c2').    
-00028b10: 2020 2020 6332 5f66 7061 7468 203d 206f      c2_fpath = o
-00028b20: 732e 7061 7468 2e6a 6f69 6e28 272f 6d6f  s.path.join('/mo
-00028b30: 756e 7473 2f66 6f6f 272c 2063 315f 666e  unts/foo', c1_fn
-00028b40: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
-00028b50: 662e 6173 7365 7274 4661 6c73 6528 6332  f.assertFalse(c2
-00028b60: 2e65 7869 7374 7328 6332 5f66 7061 7468  .exists(c2_fpath
-00028b70: 2929 0a0a 2020 2020 2020 2020 2320 6368  ))..        # ch
-00028b80: 6563 6b20 7468 6174 2074 6865 2066 696c  eck that the fil
-00028b90: 6520 6973 2076 6973 6962 6c65 2069 6e20  e is visible in 
-00028ba0: 6333 2077 6869 6368 2068 6173 2074 6865  c3 which has the
-00028bb0: 2073 616d 6520 7374 6f72 6167 6520 6d6f   same storage mo
-00028bc0: 756e 740a 2020 2020 2020 2020 6333 203d  unt.        c3 =
-00028bd0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e75   harness.model.u
-00028be0: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
-00028bf0: 7228 2763 3327 290a 2020 2020 2020 2020  r('c3').        
-00028c00: 6333 5f66 7061 7468 203d 206f 732e 7061  c3_fpath = os.pa
-00028c10: 7468 2e6a 6f69 6e28 272f 6d6f 756e 7473  th.join('/mounts
-00028c20: 2f62 6172 272c 2063 315f 666e 616d 6529  /bar', c1_fname)
-00028c30: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00028c40: 7365 7274 5472 7565 2863 332e 6578 6973  sertTrue(c3.exis
-00028c50: 7473 2863 335f 6670 6174 6829 290a 2020  ts(c3_fpath)).  
-00028c60: 2020 2020 2020 7769 7468 2063 332e 7075        with c3.pu
-00028c70: 6c6c 2863 335f 6670 6174 6829 2061 7320  ll(c3_fpath) as 
-00028c80: 663a 0a20 2020 2020 2020 2020 2020 2073  f:.            s
-00028c90: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00028ca0: 2734 3227 2c20 662e 7265 6164 2829 290a  '42', f.read()).
-00028cb0: 0a20 2020 2020 2020 2023 2074 6573 7420  .        # test 
-00028cc0: 616c 6c20 6f74 6865 7220 636f 6e74 6169  all other contai
-00028cd0: 6e65 7220 6669 6c65 206f 7073 0a20 2020  ner file ops.   
-00028ce0: 2020 2020 2077 6974 6820 6331 2e70 756c       with c1.pul
-00028cf0: 6c28 6331 5f66 7061 7468 2920 6173 2066  l(c1_fpath) as f
-00028d00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00028d10: 6c66 2e61 7373 6572 7445 7175 616c 2827  lf.assertEqual('
-00028d20: 3432 272c 2066 2e72 6561 6428 2929 0a20  42', f.read()). 
-00028d30: 2020 2020 2020 2066 696c 6573 203d 2063         files = c
-00028d40: 312e 6c69 7374 5f66 696c 6573 2863 315f  1.list_files(c1_
-00028d50: 6670 6174 6829 0a20 2020 2020 2020 2073  fpath).        s
-00028d60: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00028d70: 5b63 315f 6670 6174 685d 2c20 5b66 692e  [c1_fpath], [fi.
-00028d80: 7061 7468 2066 6f72 2066 6920 696e 2066  path for fi in f
-00028d90: 696c 6573 5d29 0a20 2020 2020 2020 2063  iles]).        c
-00028da0: 312e 7265 6d6f 7665 5f70 6174 6828 6331  1.remove_path(c1
-00028db0: 5f66 7061 7468 290a 2020 2020 2020 2020  _fpath).        
-00028dc0: 7365 6c66 2e61 7373 6572 7446 616c 7365  self.assertFalse
-00028dd0: 2863 312e 6578 6973 7473 2863 315f 6670  (c1.exists(c1_fp
-00028de0: 6174 6829 290a 0a20 2020 2020 2020 2023  ath))..        #
-00028df0: 2074 6573 7420 6465 7461 6368 696e 6720   test detaching 
-00028e00: 7374 6f72 6167 650a 2020 2020 2020 2020  storage.        
-00028e10: 6331 2e70 7573 6828 6331 5f66 7061 7468  c1.push(c1_fpath
-00028e20: 2c20 2734 3227 290a 2020 2020 2020 2020  , '42').        
-00028e30: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
-00028e40: 6331 2e65 7869 7374 7328 6331 5f66 7061  c1.exists(c1_fpa
-00028e50: 7468 2929 0a20 2020 2020 2020 2073 746f  th)).        sto
-00028e60: 7265 315f 6964 203d 2068 6172 6e65 7373  re1_id = harness
-00028e70: 2e6d 6f64 656c 2e73 746f 7261 6765 735b  .model.storages[
-00028e80: 2773 746f 7265 3127 5d5b 305d 2e66 756c  'store1'][0].ful
-00028e90: 6c5f 6964 0a20 2020 2020 2020 2068 6172  l_id.        har
-00028ea0: 6e65 7373 2e72 656d 6f76 655f 7374 6f72  ness.remove_stor
-00028eb0: 6167 6528 7374 6f72 6531 5f69 6429 0a20  age(store1_id). 
-00028ec0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00028ed0: 7274 4661 6c73 6528 6331 2e65 7869 7374  rtFalse(c1.exist
-00028ee0: 7328 6331 5f66 7061 7468 2929 0a0a 2020  s(c1_fpath))..  
-00028ef0: 2020 6465 6620 7465 7374 5f70 7573 685f    def test_push_
-00028f00: 7769 7468 5f6f 776e 6572 7368 6970 2873  with_ownership(s
-00028f10: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
-00028f20: 4e6f 7465 3a20 546f 2073 696d 706c 6966  Note: To simplif
-00028f30: 7920 696d 706c 656d 656e 7461 7469 6f6e  y implementation
-00028f40: 2c20 6f77 6e65 7273 6869 7020 6973 2073  , ownership is s
-00028f50: 696d 706c 7920 7374 6f72 6564 2061 732d  imply stored as-
-00028f60: 6973 2077 6974 6820 6e6f 2076 6572 6966  is with no verif
-00028f70: 6963 6174 696f 6e2e 0a20 2020 2020 2020  ication..       
-00028f80: 2064 6174 6120 3d20 2764 6174 6127 0a20   data = 'data'. 
-00028f90: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-00028fa0: 7365 6c66 2e63 6c69 656e 740a 2020 2020  self.client.    
-00028fb0: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
-00028fc0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
-00028fd0: 6669 6c65 222c 2064 6174 612c 2075 7365  file", data, use
-00028fe0: 725f 6964 3d31 2c20 7573 6572 3d27 666f  r_id=1, user='fo
-00028ff0: 6f27 2c20 6772 6f75 705f 6964 3d33 2c20  o', group_id=3, 
-00029000: 6772 6f75 703d 2762 6172 2729 0a20 2020  group='bar').   
-00029010: 2020 2020 2066 696c 655f 203d 2063 6c69       file_ = cli
-00029020: 656e 742e 6c69 7374 5f66 696c 6573 2866  ent.list_files(f
-00029030: 227b 7365 6c66 2e70 7265 6669 787d 2f66  "{self.prefix}/f
-00029040: 696c 6522 295b 305d 0a20 2020 2020 2020  ile")[0].       
-00029050: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-00029060: 6c28 6669 6c65 5f2e 7573 6572 5f69 642c  l(file_.user_id,
-00029070: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
-00029080: 2e61 7373 6572 7445 7175 616c 2866 696c  .assertEqual(fil
-00029090: 655f 2e75 7365 722c 2027 666f 6f27 290a  e_.user, 'foo').
-000290a0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-000290b0: 6572 7445 7175 616c 2866 696c 655f 2e67  ertEqual(file_.g
-000290c0: 726f 7570 5f69 642c 2033 290a 2020 2020  roup_id, 3).    
-000290d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-000290e0: 7175 616c 2866 696c 655f 2e67 726f 7570  qual(file_.group
-000290f0: 2c20 2762 6172 2729 0a0a 2020 2020 6465  , 'bar')..    de
-00029100: 6620 7465 7374 5f6d 616b 655f 6469 725f  f test_make_dir_
-00029110: 7769 7468 5f6f 776e 6572 7368 6970 2873  with_ownership(s
-00029120: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
-00029130: 6965 6e74 203d 2073 656c 662e 636c 6965  ient = self.clie
-00029140: 6e74 0a20 2020 2020 2020 2063 6c69 656e  nt.        clien
-00029150: 742e 6d61 6b65 5f64 6972 2866 227b 7365  t.make_dir(f"{se
-00029160: 6c66 2e70 7265 6669 787d 2f64 6972 3122  lf.prefix}/dir1"
-00029170: 2c20 7573 6572 5f69 643d 312c 2075 7365  , user_id=1, use
-00029180: 723d 2266 6f6f 222c 2067 726f 7570 5f69  r="foo", group_i
-00029190: 643d 332c 2067 726f 7570 3d22 6261 7222  d=3, group="bar"
-000291a0: 290a 2020 2020 2020 2020 6469 725f 203d  ).        dir_ =
-000291b0: 2063 6c69 656e 742e 6c69 7374 5f66 696c   client.list_fil
-000291c0: 6573 2866 227b 7365 6c66 2e70 7265 6669  es(f"{self.prefi
-000291d0: 787d 2f64 6972 3122 2c20 6974 7365 6c66  x}/dir1", itself
-000291e0: 3d54 7275 6529 5b30 5d0a 2020 2020 2020  =True)[0].      
-000291f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00029200: 616c 2864 6972 5f2e 7573 6572 5f69 642c  al(dir_.user_id,
-00029210: 2031 290a 2020 2020 2020 2020 7365 6c66   1).        self
-00029220: 2e61 7373 6572 7445 7175 616c 2864 6972  .assertEqual(dir
-00029230: 5f2e 7573 6572 2c20 2266 6f6f 2229 0a20  _.user, "foo"). 
-00029240: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-00029250: 7274 4571 7561 6c28 6469 725f 2e67 726f  rtEqual(dir_.gro
-00029260: 7570 5f69 642c 2033 290a 2020 2020 2020  up_id, 3).      
-00029270: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-00029280: 616c 2864 6972 5f2e 6772 6f75 702c 2022  al(dir_.group, "
-00029290: 6261 7222 290a 0a0a 4075 6e69 7474 6573  bar")...@unittes
-000292a0: 742e 736b 6970 556e 6c65 7373 286f 732e  t.skipUnless(os.
-000292b0: 6765 7465 6e76 2827 5255 4e5f 5245 414c  getenv('RUN_REAL
-000292c0: 5f50 4542 424c 455f 5445 5354 5327 292c  _PEBBLE_TESTS'),
-000292d0: 2027 5255 4e5f 5245 414c 5f50 4542 424c   'RUN_REAL_PEBBL
-000292e0: 455f 5445 5354 5320 6e6f 7420 7365 7427  E_TESTS not set'
-000292f0: 290a 636c 6173 7320 5465 7374 5065 6262  ).class TestPebb
-00029300: 6c65 5374 6f72 6167 6541 5049 7355 7369  leStorageAPIsUsi
-00029310: 6e67 5265 616c 5065 6262 6c65 2875 6e69  ngRealPebble(uni
-00029320: 7474 6573 742e 5465 7374 4361 7365 2c20  ttest.TestCase, 
-00029330: 5f50 6562 626c 6553 746f 7261 6765 4150  _PebbleStorageAP
-00029340: 4973 5465 7374 4d69 7869 6e29 3a0a 2020  IsTestMixin):.  
-00029350: 2020 6465 6620 7365 7455 7028 7365 6c66    def setUp(self
-00029360: 293a 0a20 2020 2020 2020 2073 6f63 6b65  ):.        socke
-00029370: 745f 7061 7468 203d 206f 732e 6765 7465  t_path = os.gete
-00029380: 6e76 2827 5045 4242 4c45 5f53 4f43 4b45  nv('PEBBLE_SOCKE
-00029390: 5427 290a 2020 2020 2020 2020 7065 6262  T').        pebb
-000293a0: 6c65 5f64 6972 203d 206f 732e 6765 7465  le_dir = os.gete
-000293b0: 6e76 2827 5045 4242 4c45 2729 0a20 2020  nv('PEBBLE').   
-000293c0: 2020 2020 2069 6620 6e6f 7420 736f 636b       if not sock
-000293d0: 6574 5f70 6174 6820 616e 6420 7065 6262  et_path and pebb
-000293e0: 6c65 5f64 6972 3a0a 2020 2020 2020 2020  le_dir:.        
-000293f0: 2020 2020 736f 636b 6574 5f70 6174 6820      socket_path 
-00029400: 3d20 6f73 2e70 6174 682e 6a6f 696e 2870  = os.path.join(p
-00029410: 6562 626c 655f 6469 722c 2027 2e70 6562  ebble_dir, '.peb
-00029420: 626c 652e 736f 636b 6574 2729 0a20 2020  ble.socket').   
-00029430: 2020 2020 2061 7373 6572 7420 736f 636b       assert sock
-00029440: 6574 5f70 6174 6820 616e 6420 7065 6262  et_path and pebb
-00029450: 6c65 5f64 6972 2c20 2750 4542 424c 4520  le_dir, 'PEBBLE 
-00029460: 6d75 7374 2062 6520 7365 7420 6966 2052  must be set if R
-00029470: 554e 5f52 4541 4c5f 5045 4242 4c45 5f54  UN_REAL_PEBBLE_T
-00029480: 4553 5453 2073 6574 270a 0a20 2020 2020  ESTS set'..     
-00029490: 2020 2073 656c 662e 7072 6566 6978 203d     self.prefix =
-000294a0: 2074 656d 7066 696c 652e 6d6b 6474 656d   tempfile.mkdtem
-000294b0: 7028 6469 723d 7065 6262 6c65 5f64 6972  p(dir=pebble_dir
-000294c0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-000294d0: 6c69 656e 7420 3d20 7065 6262 6c65 2e43  lient = pebble.C
-000294e0: 6c69 656e 7428 736f 636b 6574 5f70 6174  lient(socket_pat
-000294f0: 683d 736f 636b 6574 5f70 6174 6829 0a0a  h=socket_path)..
-00029500: 2020 2020 6465 6620 7465 6172 446f 776e      def tearDown
-00029510: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00029520: 7368 7574 696c 2e72 6d74 7265 6528 7365  shutil.rmtree(se
-00029530: 6c66 2e70 7265 6669 7829 0a0a 2020 2020  lf.prefix)..    
-00029540: 2320 5265 6d6f 7665 2074 6869 7320 656e  # Remove this en
-00029550: 7469 7265 6c79 206f 6e63 6520 7468 6520  tirely once the 
-00029560: 6173 736f 6369 6174 6564 2062 7567 2069  associated bug i
-00029570: 7320 6669 7865 643b 2069 7420 6f76 6572  s fixed; it over
-00029580: 7269 6465 7320 7468 6520 6f72 6967 696e  rides the origin
-00029590: 616c 2074 6573 7420 696e 2074 6865 0a20  al test in the. 
-000295a0: 2020 2023 2074 6573 7420 6d69 7869 6e20     # test mixin 
-000295b0: 636c 6173 732e 0a20 2020 2040 756e 6974  class..    @unit
-000295c0: 7465 7374 2e73 6b69 7028 2770 656e 6469  test.skip('pendi
-000295d0: 6e67 2072 6573 6f6c 7574 696f 6e20 6f66  ng resolution of
-000295e0: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
-000295f0: 636f 6d2f 6361 6e6f 6e69 6361 6c2f 7065  com/canonical/pe
-00029600: 6262 6c65 2f69 7373 7565 732f 3830 2729  bble/issues/80')
-00029610: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
-00029620: 6b65 5f64 6972 5f77 6974 685f 7065 726d  ke_dir_with_perm
-00029630: 6973 7369 6f6e 5f6d 6173 6b28 7365 6c66  ission_mask(self
-00029640: 293a 0a20 2020 2020 2020 2070 6173 730a  ):.        pass.
-00029650: 0a0a 636c 6173 7320 5465 7374 5365 6372  ..class TestSecr
-00029660: 6574 7328 756e 6974 7465 7374 2e54 6573  ets(unittest.Tes
-00029670: 7443 6173 6529 3a0a 2020 2020 6465 6620  tCase):.    def 
-00029680: 7465 7374 5f61 6464 5f6d 6f64 656c 5f73  test_add_model_s
-00029690: 6563 7265 745f 6279 5f61 7070 5f6e 616d  ecret_by_app_nam
-000296a0: 655f 7374 7228 7365 6c66 293a 0a20 2020  e_str(self):.   
-000296b0: 2020 2020 2068 6172 6e65 7373 203d 2048       harness = H
-000296c0: 6172 6e65 7373 2843 6861 726d 4261 7365  arness(CharmBase
-000296d0: 2c20 6d65 7461 3d27 6e61 6d65 3a20 7765  , meta='name: we
-000296e0: 6261 7070 2729 0a20 2020 2020 2020 2073  bapp').        s
-000296f0: 656c 662e 6164 6443 6c65 616e 7570 2868  elf.addCleanup(h
-00029700: 6172 6e65 7373 2e63 6c65 616e 7570 290a  arness.cleanup).
-00029710: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
-00029720: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-00029730: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
-00029740: 2027 6461 7461 6261 7365 2729 0a20 2020   'database').   
-00029750: 2020 2020 2068 6172 6e65 7373 2e61 6464       harness.add
-00029760: 5f72 656c 6174 696f 6e5f 756e 6974 2872  _relation_unit(r
-00029770: 656c 6174 696f 6e5f 6964 2c20 2764 6174  elation_id, 'dat
-00029780: 6162 6173 652f 3027 290a 0a20 2020 2020  abase/0')..     
-00029790: 2020 2073 6563 7265 745f 6964 203d 2068     secret_id = h
-000297a0: 6172 6e65 7373 2e61 6464 5f6d 6f64 656c  arness.add_model
-000297b0: 5f73 6563 7265 7428 2764 6174 6162 6173  _secret('databas
-000297c0: 6527 2c20 7b27 7061 7373 776f 7264 273a  e', {'password':
-000297d0: 2027 6875 6e74 6572 3227 7d29 0a20 2020   'hunter2'}).   
-000297e0: 2020 2020 2068 6172 6e65 7373 2e67 7261       harness.gra
-000297f0: 6e74 5f73 6563 7265 7428 7365 6372 6574  nt_secret(secret
-00029800: 5f69 642c 2027 7765 6261 7070 2729 0a20  _id, 'webapp'). 
-00029810: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-00029820: 6861 726e 6573 732e 6d6f 6465 6c2e 6765  harness.model.ge
-00029830: 745f 7365 6372 6574 2869 643d 7365 6372  t_secret(id=secr
-00029840: 6574 5f69 6429 0a20 2020 2020 2020 2073  et_id).        s
-00029850: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00029860: 7365 6372 6574 2e69 642c 2073 6563 7265  secret.id, secre
-00029870: 745f 6964 290a 2020 2020 2020 2020 7365  t_id).        se
-00029880: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00029890: 6563 7265 742e 6765 745f 636f 6e74 656e  ecret.get_conten
-000298a0: 7428 292c 207b 2770 6173 7377 6f72 6427  t(), {'password'
-000298b0: 3a20 2768 756e 7465 7232 277d 290a 0a20  : 'hunter2'}).. 
-000298c0: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
-000298d0: 6d6f 6465 6c5f 7365 6372 6574 5f62 795f  model_secret_by_
-000298e0: 6170 705f 696e 7374 616e 6365 2873 656c  app_instance(sel
-000298f0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-00029900: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-00029910: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
-00029920: 616d 653a 2077 6562 6170 7027 290a 2020  ame: webapp').  
-00029930: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-00029940: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-00029950: 6561 6e75 7029 0a20 2020 2020 2020 2072  eanup).        r
-00029960: 656c 6174 696f 6e5f 6964 203d 2068 6172  elation_id = har
-00029970: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00029980: 6e28 2764 6227 2c20 2764 6174 6162 6173  n('db', 'databas
-00029990: 6527 290a 2020 2020 2020 2020 6861 726e  e').        harn
-000299a0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-000299b0: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
-000299c0: 642c 2027 6461 7461 6261 7365 2f30 2729  d, 'database/0')
-000299d0: 0a0a 2020 2020 2020 2020 6170 7020 3d20  ..        app = 
-000299e0: 6861 726e 6573 732e 6d6f 6465 6c2e 6765  harness.model.ge
-000299f0: 745f 6170 7028 2764 6174 6162 6173 6527  t_app('database'
-00029a00: 290a 2020 2020 2020 2020 7365 6372 6574  ).        secret
-00029a10: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-00029a20: 645f 6d6f 6465 6c5f 7365 6372 6574 2861  d_model_secret(a
-00029a30: 7070 2c20 7b27 7061 7373 776f 7264 273a  pp, {'password':
-00029a40: 2027 6875 6e74 6572 3327 7d29 0a20 2020   'hunter3'}).   
-00029a50: 2020 2020 2068 6172 6e65 7373 2e67 7261       harness.gra
-00029a60: 6e74 5f73 6563 7265 7428 7365 6372 6574  nt_secret(secret
-00029a70: 5f69 642c 2027 7765 6261 7070 2729 0a20  _id, 'webapp'). 
-00029a80: 2020 2020 2020 2073 6563 7265 7420 3d20         secret = 
-00029a90: 6861 726e 6573 732e 6d6f 6465 6c2e 6765  harness.model.ge
-00029aa0: 745f 7365 6372 6574 2869 643d 7365 6372  t_secret(id=secr
-00029ab0: 6574 5f69 6429 0a20 2020 2020 2020 2073  et_id).        s
-00029ac0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00029ad0: 7365 6372 6574 2e69 642c 2073 6563 7265  secret.id, secre
-00029ae0: 745f 6964 290a 2020 2020 2020 2020 7365  t_id).        se
-00029af0: 6c66 2e61 7373 6572 7445 7175 616c 2873  lf.assertEqual(s
-00029b00: 6563 7265 742e 6765 745f 636f 6e74 656e  ecret.get_conten
-00029b10: 7428 292c 207b 2770 6173 7377 6f72 6427  t(), {'password'
-00029b20: 3a20 2768 756e 7465 7233 277d 290a 0a20  : 'hunter3'}).. 
-00029b30: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
-00029b40: 6d6f 6465 6c5f 7365 6372 6574 5f62 795f  model_secret_by_
-00029b50: 756e 6974 5f69 6e73 7461 6e63 6528 7365  unit_instance(se
-00029b60: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-00029b70: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-00029b80: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-00029b90: 6e61 6d65 3a20 7765 6261 7070 2729 0a20  name: webapp'). 
-00029ba0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-00029bb0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-00029bc0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-00029bd0: 7265 6c61 7469 6f6e 5f69 6420 3d20 6861  relation_id = ha
-00029be0: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-00029bf0: 6f6e 2827 6462 272c 2027 6461 7461 6261  on('db', 'databa
-00029c00: 7365 2729 0a20 2020 2020 2020 2068 6172  se').        har
-00029c10: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00029c20: 6e5f 756e 6974 2872 656c 6174 696f 6e5f  n_unit(relation_
-00029c30: 6964 2c20 2764 6174 6162 6173 652f 3027  id, 'database/0'
-00029c40: 290a 0a20 2020 2020 2020 2075 6e69 7420  )..        unit 
-00029c50: 3d20 6861 726e 6573 732e 6d6f 6465 6c2e  = harness.model.
-00029c60: 6765 745f 756e 6974 2827 6461 7461 6261  get_unit('databa
-00029c70: 7365 2f30 2729 0a20 2020 2020 2020 2073  se/0').        s
-00029c80: 6563 7265 745f 6964 203d 2068 6172 6e65  ecret_id = harne
-00029c90: 7373 2e61 6464 5f6d 6f64 656c 5f73 6563  ss.add_model_sec
-00029ca0: 7265 7428 756e 6974 2c20 7b27 7061 7373  ret(unit, {'pass
-00029cb0: 776f 7264 273a 2027 6875 6e74 6572 3427  word': 'hunter4'
-00029cc0: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
-00029cd0: 7373 2e67 7261 6e74 5f73 6563 7265 7428  ss.grant_secret(
-00029ce0: 7365 6372 6574 5f69 642c 2027 7765 6261  secret_id, 'weba
-00029cf0: 7070 2729 0a20 2020 2020 2020 2073 6563  pp').        sec
-00029d00: 7265 7420 3d20 6861 726e 6573 732e 6d6f  ret = harness.mo
-00029d10: 6465 6c2e 6765 745f 7365 6372 6574 2869  del.get_secret(i
-00029d20: 643d 7365 6372 6574 5f69 6429 0a20 2020  d=secret_id).   
-00029d30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00029d40: 4571 7561 6c28 7365 6372 6574 2e69 642c  Equal(secret.id,
-00029d50: 2073 6563 7265 745f 6964 290a 2020 2020   secret_id).    
-00029d60: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00029d70: 7175 616c 2873 6563 7265 742e 6765 745f  qual(secret.get_
-00029d80: 636f 6e74 656e 7428 292c 207b 2770 6173  content(), {'pas
-00029d90: 7377 6f72 6427 3a20 2768 756e 7465 7234  sword': 'hunter4
-00029da0: 277d 290a 0a20 2020 2064 6566 2074 6573  '})..    def tes
-00029db0: 745f 6164 645f 6d6f 6465 6c5f 7365 6372  t_add_model_secr
-00029dc0: 6574 5f69 6e76 616c 6964 5f63 6f6e 7465  et_invalid_conte
-00029dd0: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
-00029de0: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-00029df0: 6573 7328 4368 6172 6d42 6173 652c 206d  ess(CharmBase, m
-00029e00: 6574 613d 276e 616d 653a 2077 6562 6170  eta='name: webap
-00029e10: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
-00029e20: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-00029e30: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
-00029e40: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00029e50: 6173 7365 7274 5261 6973 6573 2856 616c  assertRaises(Val
-00029e60: 7565 4572 726f 7229 3a0a 2020 2020 2020  ueError):.      
-00029e70: 2020 2020 2020 6861 726e 6573 732e 6164        harness.ad
-00029e80: 645f 6d6f 6465 6c5f 7365 6372 6574 2827  d_model_secret('
-00029e90: 6461 7461 6261 7365 272c 207b 2778 273a  database', {'x':
-00029ea0: 2027 7927 7d29 2020 2320 6b65 7920 746f   'y'})  # key to
-00029eb0: 6f20 7368 6f72 740a 0a20 2020 2064 6566  o short..    def
-00029ec0: 2074 6573 745f 7365 745f 7365 6372 6574   test_set_secret
-00029ed0: 5f63 6f6e 7465 6e74 2873 656c 6629 3a0a  _content(self):.
-00029ee0: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-00029ef0: 3d20 4861 726e 6573 7328 4576 656e 7452  = Harness(EventR
-00029f00: 6563 6f72 6465 722c 206d 6574 613d 276e  ecorder, meta='n
-00029f10: 616d 653a 2077 6562 6170 7027 290a 2020  ame: webapp').  
-00029f20: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-00029f30: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-00029f40: 6561 6e75 7029 0a20 2020 2020 2020 2072  eanup).        r
-00029f50: 656c 6174 696f 6e5f 6964 203d 2068 6172  elation_id = har
-00029f60: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-00029f70: 6e28 2764 6227 2c20 2764 6174 6162 6173  n('db', 'databas
-00029f80: 6527 290a 2020 2020 2020 2020 6861 726e  e').        harn
-00029f90: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-00029fa0: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
-00029fb0: 642c 2027 6461 7461 6261 7365 2f30 2729  d, 'database/0')
-00029fc0: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-00029fd0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-00029fe0: 645f 6d6f 6465 6c5f 7365 6372 6574 2827  d_model_secret('
-00029ff0: 6461 7461 6261 7365 272c 207b 2766 6f6f  database', {'foo
-0002a000: 273a 2027 3127 7d29 0a20 2020 2020 2020  ': '1'}).       
-0002a010: 2068 6172 6e65 7373 2e67 7261 6e74 5f73   harness.grant_s
-0002a020: 6563 7265 7428 7365 6372 6574 5f69 642c  ecret(secret_id,
-0002a030: 2027 7765 6261 7070 2729 0a20 2020 2020   'webapp').     
-0002a040: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-0002a050: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
-0002a060: 7373 2e66 7261 6d65 776f 726b 2e6f 6273  ss.framework.obs
-0002a070: 6572 7665 2868 6172 6e65 7373 2e63 6861  erve(harness.cha
-0002a080: 726d 2e6f 6e2e 7365 6372 6574 5f63 6861  rm.on.secret_cha
-0002a090: 6e67 6564 2c20 6861 726e 6573 732e 6368  nged, harness.ch
-0002a0a0: 6172 6d2e 7265 636f 7264 5f65 7665 6e74  arm.record_event
-0002a0b0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
-0002a0c0: 732e 7365 745f 7365 6372 6574 5f63 6f6e  s.set_secret_con
-0002a0d0: 7465 6e74 2873 6563 7265 745f 6964 2c20  tent(secret_id, 
-0002a0e0: 7b27 666f 6f27 3a20 2732 277d 290a 0a20  {'foo': '2'}).. 
-0002a0f0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002a100: 7274 4571 7561 6c28 6c65 6e28 6861 726e  rtEqual(len(harn
-0002a110: 6573 732e 6368 6172 6d2e 6576 656e 7473  ess.charm.events
-0002a120: 292c 2031 290a 2020 2020 2020 2020 6576  ), 1).        ev
-0002a130: 656e 7420 3d20 6861 726e 6573 732e 6368  ent = harness.ch
-0002a140: 6172 6d2e 6576 656e 7473 5b30 5d0a 2020  arm.events[0].  
-0002a150: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002a160: 7449 7349 6e73 7461 6e63 6528 6576 656e  tIsInstance(even
-0002a170: 742c 206f 7073 2e63 6861 726d 2e53 6563  t, ops.charm.Sec
-0002a180: 7265 7443 6861 6e67 6564 4576 656e 7429  retChangedEvent)
-0002a190: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0002a1a0: 7365 7274 4571 7561 6c28 6576 656e 742e  sertEqual(event.
-0002a1b0: 7365 6372 6574 2e67 6574 5f63 6f6e 7465  secret.get_conte
-0002a1c0: 6e74 2829 2c20 7b27 666f 6f27 3a20 2731  nt(), {'foo': '1
-0002a1d0: 277d 290a 2020 2020 2020 2020 7365 6c66  '}).        self
-0002a1e0: 2e61 7373 6572 7445 7175 616c 2865 7665  .assertEqual(eve
-0002a1f0: 6e74 2e73 6563 7265 742e 6765 745f 636f  nt.secret.get_co
-0002a200: 6e74 656e 7428 7265 6672 6573 683d 5472  ntent(refresh=Tr
-0002a210: 7565 292c 207b 2766 6f6f 273a 2027 3227  ue), {'foo': '2'
-0002a220: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-0002a230: 6173 7365 7274 4571 7561 6c28 6576 656e  assertEqual(even
-0002a240: 742e 7365 6372 6574 2e67 6574 5f63 6f6e  t.secret.get_con
-0002a250: 7465 6e74 2829 2c20 7b27 666f 6f27 3a20  tent(), {'foo': 
-0002a260: 2732 277d 290a 0a20 2020 2020 2020 2073  '2'})..        s
-0002a270: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0002a280: 6861 726e 6573 732e 6765 745f 7365 6372  harness.get_secr
-0002a290: 6574 5f72 6576 6973 696f 6e73 2873 6563  et_revisions(sec
-0002a2a0: 7265 745f 6964 292c 205b 312c 2032 5d29  ret_id), [1, 2])
-0002a2b0: 0a0a 2020 2020 6465 6620 7465 7374 5f73  ..    def test_s
-0002a2c0: 6574 5f73 6563 7265 745f 636f 6e74 656e  et_secret_conten
-0002a2d0: 745f 7772 6f6e 675f 6f77 6e65 7228 7365  t_wrong_owner(se
-0002a2e0: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0002a2f0: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-0002a300: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-0002a310: 6e61 6d65 3a20 7765 6261 7070 2729 0a20  name: webapp'). 
-0002a320: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0002a330: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0002a340: 6c65 616e 7570 290a 0a20 2020 2020 2020  leanup)..       
-0002a350: 2073 6563 7265 7420 3d20 6861 726e 6573   secret = harnes
-0002a360: 732e 6d6f 6465 6c2e 6170 702e 6164 645f  s.model.app.add_
-0002a370: 7365 6372 6574 287b 2766 6f6f 273a 2027  secret({'foo': '
-0002a380: 6261 7227 7d29 0a20 2020 2020 2020 2077  bar'}).        w
-0002a390: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0002a3a0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
-0002a3b0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0002a3c0: 2068 6172 6e65 7373 2e73 6574 5f73 6563   harness.set_sec
-0002a3d0: 7265 745f 636f 6e74 656e 7428 7365 6372  ret_content(secr
-0002a3e0: 6574 2e69 642c 207b 2762 6172 273a 2027  et.id, {'bar': '
-0002a3f0: 666f 6f27 7d29 0a0a 2020 2020 6465 6620  foo'})..    def 
-0002a400: 7465 7374 5f73 6574 5f73 6563 7265 745f  test_set_secret_
-0002a410: 636f 6e74 656e 745f 696e 7661 6c69 645f  content_invalid_
-0002a420: 7365 6372 6574 5f69 6428 7365 6c66 293a  secret_id(self):
-0002a430: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0002a440: 203d 2048 6172 6e65 7373 2843 6861 726d   = Harness(Charm
-0002a450: 4261 7365 2c20 6d65 7461 3d27 6e61 6d65  Base, meta='name
-0002a460: 3a20 7765 6261 7070 2729 0a20 2020 2020  : webapp').     
-0002a470: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0002a480: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0002a490: 7570 290a 0a20 2020 2020 2020 2077 6974  up)..        wit
-0002a4a0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
-0002a4b0: 7365 7328 5275 6e74 696d 6545 7272 6f72  ses(RuntimeError
-0002a4c0: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-0002a4d0: 6172 6e65 7373 2e73 6574 5f73 6563 7265  arness.set_secre
-0002a4e0: 745f 636f 6e74 656e 7428 2761 7364 6627  t_content('asdf'
-0002a4f0: 2c20 7b27 666f 6f27 3a20 2762 6172 277d  , {'foo': 'bar'}
-0002a500: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0002a510: 7365 745f 7365 6372 6574 5f63 6f6e 7465  set_secret_conte
-0002a520: 6e74 5f69 6e76 616c 6964 5f63 6f6e 7465  nt_invalid_conte
-0002a530: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
-0002a540: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-0002a550: 6573 7328 4368 6172 6d42 6173 652c 206d  ess(CharmBase, m
-0002a560: 6574 613d 276e 616d 653a 2077 6562 6170  eta='name: webap
-0002a570: 7027 290a 2020 2020 2020 2020 7365 6c66  p').        self
-0002a580: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
-0002a590: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
-0002a5a0: 2020 2020 2020 7365 6372 6574 5f69 6420        secret_id 
-0002a5b0: 3d20 6861 726e 6573 732e 6164 645f 6d6f  = harness.add_mo
-0002a5c0: 6465 6c5f 7365 6372 6574 2827 6461 7461  del_secret('data
-0002a5d0: 6261 7365 272c 207b 2766 6f6f 273a 2027  base', {'foo': '
-0002a5e0: 6261 7227 7d29 0a20 2020 2020 2020 2077  bar'}).        w
-0002a5f0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0002a600: 6169 7365 7328 5661 6c75 6545 7272 6f72  aises(ValueError
-0002a610: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-0002a620: 6172 6e65 7373 2e73 6574 5f73 6563 7265  arness.set_secre
-0002a630: 745f 636f 6e74 656e 7428 7365 6372 6574  t_content(secret
-0002a640: 5f69 642c 207b 2778 273a 2027 7927 7d29  _id, {'x': 'y'})
-0002a650: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
-0002a660: 7261 6e74 5f73 6563 7265 745f 616e 645f  rant_secret_and_
-0002a670: 7265 766f 6b65 5f73 6563 7265 7428 7365  revoke_secret(se
-0002a680: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0002a690: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-0002a6a0: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-0002a6b0: 6e61 6d65 3a20 7765 6261 7070 2729 0a20  name: webapp'). 
-0002a6c0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0002a6d0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0002a6e0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-0002a6f0: 7265 6c61 7469 6f6e 5f69 6420 3d20 6861  relation_id = ha
-0002a700: 726e 6573 732e 6164 645f 7265 6c61 7469  rness.add_relati
-0002a710: 6f6e 2827 6462 272c 2027 6461 7461 6261  on('db', 'databa
-0002a720: 7365 2729 0a20 2020 2020 2020 2068 6172  se').        har
-0002a730: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-0002a740: 6e5f 756e 6974 2872 656c 6174 696f 6e5f  n_unit(relation_
-0002a750: 6964 2c20 2764 6174 6162 6173 652f 3027  id, 'database/0'
-0002a760: 290a 0a20 2020 2020 2020 2073 6563 7265  )..        secre
-0002a770: 745f 6964 203d 2068 6172 6e65 7373 2e61  t_id = harness.a
-0002a780: 6464 5f6d 6f64 656c 5f73 6563 7265 7428  dd_model_secret(
-0002a790: 2764 6174 6162 6173 6527 2c20 7b27 7061  'database', {'pa
-0002a7a0: 7373 776f 7264 273a 2027 6875 6e74 6572  ssword': 'hunter
-0002a7b0: 3227 7d29 0a20 2020 2020 2020 2068 6172  2'}).        har
-0002a7c0: 6e65 7373 2e67 7261 6e74 5f73 6563 7265  ness.grant_secre
-0002a7d0: 7428 7365 6372 6574 5f69 642c 2027 7765  t(secret_id, 'we
-0002a7e0: 6261 7070 2729 0a20 2020 2020 2020 2073  bapp').        s
-0002a7f0: 6563 7265 7420 3d20 6861 726e 6573 732e  ecret = harness.
-0002a800: 6d6f 6465 6c2e 6765 745f 7365 6372 6574  model.get_secret
-0002a810: 2869 643d 7365 6372 6574 5f69 6429 0a20  (id=secret_id). 
-0002a820: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002a830: 7274 4571 7561 6c28 7365 6372 6574 2e69  rtEqual(secret.i
-0002a840: 642c 2073 6563 7265 745f 6964 290a 2020  d, secret_id).  
-0002a850: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002a860: 7445 7175 616c 2873 6563 7265 742e 6765  tEqual(secret.ge
-0002a870: 745f 636f 6e74 656e 7428 292c 207b 2770  t_content(), {'p
-0002a880: 6173 7377 6f72 6427 3a20 2768 756e 7465  assword': 'hunte
-0002a890: 7232 277d 290a 0a20 2020 2020 2020 2068  r2'})..        h
-0002a8a0: 6172 6e65 7373 2e72 6576 6f6b 655f 7365  arness.revoke_se
-0002a8b0: 6372 6574 2873 6563 7265 745f 6964 2c20  cret(secret_id, 
-0002a8c0: 2777 6562 6170 7027 290a 2020 2020 2020  'webapp').      
-0002a8d0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0002a8e0: 7274 5261 6973 6573 286d 6f64 656c 2e53  rtRaises(model.S
-0002a8f0: 6563 7265 744e 6f74 466f 756e 6445 7272  ecretNotFoundErr
-0002a900: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0002a910: 2068 6172 6e65 7373 2e6d 6f64 656c 2e67   harness.model.g
-0002a920: 6574 5f73 6563 7265 7428 6964 3d73 6563  et_secret(id=sec
-0002a930: 7265 745f 6964 290a 0a20 2020 2064 6566  ret_id)..    def
-0002a940: 2074 6573 745f 6772 616e 745f 7365 6372   test_grant_secr
-0002a950: 6574 5f77 726f 6e67 5f61 7070 2873 656c  et_wrong_app(sel
-0002a960: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
-0002a970: 6573 7320 3d20 4861 726e 6573 7328 4368  ess = Harness(Ch
-0002a980: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
-0002a990: 616d 653a 2077 6562 6170 7027 290a 2020  ame: webapp').  
-0002a9a0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
-0002a9b0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
-0002a9c0: 6561 6e75 7029 0a20 2020 2020 2020 2072  eanup).        r
-0002a9d0: 656c 6174 696f 6e5f 6964 203d 2068 6172  elation_id = har
-0002a9e0: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
-0002a9f0: 6e28 2764 6227 2c20 2764 6174 6162 6173  n('db', 'databas
-0002aa00: 6527 290a 2020 2020 2020 2020 6861 726e  e').        harn
-0002aa10: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0002aa20: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
-0002aa30: 642c 2027 6461 7461 6261 7365 2f30 2729  d, 'database/0')
-0002aa40: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-0002aa50: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-0002aa60: 645f 6d6f 6465 6c5f 7365 6372 6574 2827  d_model_secret('
-0002aa70: 6461 7461 6261 7365 272c 207b 2770 6173  database', {'pas
-0002aa80: 7377 6f72 6427 3a20 2768 756e 7465 7232  sword': 'hunter2
-0002aa90: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
-0002aaa0: 6573 732e 6772 616e 745f 7365 6372 6574  ess.grant_secret
-0002aab0: 2873 6563 7265 745f 6964 2c20 276f 7468  (secret_id, 'oth
-0002aac0: 6572 6170 7027 290a 2020 2020 2020 2020  erapp').        
-0002aad0: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
-0002aae0: 5261 6973 6573 286d 6f64 656c 2e53 6563  Raises(model.Sec
-0002aaf0: 7265 744e 6f74 466f 756e 6445 7272 6f72  retNotFoundError
-0002ab00: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-0002ab10: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
-0002ab20: 5f73 6563 7265 7428 6964 3d73 6563 7265  _secret(id=secre
-0002ab30: 745f 6964 290a 0a20 2020 2064 6566 2074  t_id)..    def t
-0002ab40: 6573 745f 6772 616e 745f 7365 6372 6574  est_grant_secret
-0002ab50: 5f77 726f 6e67 5f75 6e69 7428 7365 6c66  _wrong_unit(self
-0002ab60: 293a 0a20 2020 2020 2020 2068 6172 6e65  ):.        harne
-0002ab70: 7373 203d 2048 6172 6e65 7373 2843 6861  ss = Harness(Cha
-0002ab80: 726d 4261 7365 2c20 6d65 7461 3d27 6e61  rmBase, meta='na
-0002ab90: 6d65 3a20 7765 6261 7070 2729 0a20 2020  me: webapp').   
-0002aba0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
-0002abb0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
-0002abc0: 616e 7570 290a 2020 2020 2020 2020 7265  anup).        re
-0002abd0: 6c61 7469 6f6e 5f69 6420 3d20 6861 726e  lation_id = harn
-0002abe0: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
-0002abf0: 2827 6462 272c 2027 6461 7461 6261 7365  ('db', 'database
-0002ac00: 2729 0a20 2020 2020 2020 2068 6172 6e65  ').        harne
-0002ac10: 7373 2e61 6464 5f72 656c 6174 696f 6e5f  ss.add_relation_
-0002ac20: 756e 6974 2872 656c 6174 696f 6e5f 6964  unit(relation_id
-0002ac30: 2c20 2764 6174 6162 6173 652f 3027 290a  , 'database/0').
-0002ac40: 0a20 2020 2020 2020 2073 6563 7265 745f  .        secret_
-0002ac50: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
-0002ac60: 5f6d 6f64 656c 5f73 6563 7265 7428 2764  _model_secret('d
-0002ac70: 6174 6162 6173 6527 2c20 7b27 7061 7373  atabase', {'pass
-0002ac80: 776f 7264 273a 2027 6875 6e74 6572 3227  word': 'hunter2'
-0002ac90: 7d29 0a20 2020 2020 2020 2068 6172 6e65  }).        harne
-0002aca0: 7373 2e67 7261 6e74 5f73 6563 7265 7428  ss.grant_secret(
-0002acb0: 7365 6372 6574 5f69 642c 2027 7765 6261  secret_id, 'weba
-0002acc0: 7070 2f31 2729 2020 2320 7368 6f75 6c64  pp/1')  # should
-0002acd0: 2062 6520 7765 6261 7070 2f30 0a20 2020   be webapp/0.   
-0002ace0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0002acf0: 7373 6572 7452 6169 7365 7328 6d6f 6465  ssertRaises(mode
-0002ad00: 6c2e 5365 6372 6574 4e6f 7446 6f75 6e64  l.SecretNotFound
-0002ad10: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002ad20: 2020 2020 6861 726e 6573 732e 6d6f 6465      harness.mode
-0002ad30: 6c2e 6765 745f 7365 6372 6574 2869 643d  l.get_secret(id=
-0002ad40: 7365 6372 6574 5f69 6429 0a0a 2020 2020  secret_id)..    
-0002ad50: 6465 6620 7465 7374 5f67 7261 6e74 5f73  def test_grant_s
-0002ad60: 6563 7265 745f 6e6f 5f72 656c 6174 696f  ecret_no_relatio
-0002ad70: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-0002ad80: 2068 6172 6e65 7373 203d 2048 6172 6e65   harness = Harne
-0002ad90: 7373 2843 6861 726d 4261 7365 2c20 6d65  ss(CharmBase, me
-0002ada0: 7461 3d27 6e61 6d65 3a20 7765 6261 7070  ta='name: webapp
-0002adb0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
-0002adc0: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
-0002add0: 7373 2e63 6c65 616e 7570 290a 0a20 2020  ss.cleanup)..   
-0002ade0: 2020 2020 2073 6563 7265 745f 6964 203d       secret_id =
-0002adf0: 2068 6172 6e65 7373 2e61 6464 5f6d 6f64   harness.add_mod
-0002ae00: 656c 5f73 6563 7265 7428 2764 6174 6162  el_secret('datab
-0002ae10: 6173 6527 2c20 7b27 7061 7373 776f 7264  ase', {'password
-0002ae20: 273a 2027 6875 6e74 6572 3227 7d29 0a20  ': 'hunter2'}). 
-0002ae30: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0002ae40: 2e61 7373 6572 7452 6169 7365 7328 5275  .assertRaises(Ru
-0002ae50: 6e74 696d 6545 7272 6f72 293a 0a20 2020  ntimeError):.   
-0002ae60: 2020 2020 2020 2020 2068 6172 6e65 7373           harness
-0002ae70: 2e67 7261 6e74 5f73 6563 7265 7428 7365  .grant_secret(se
-0002ae80: 6372 6574 5f69 642c 2027 7765 6261 7070  cret_id, 'webapp
-0002ae90: 2729 0a0a 2020 2020 6465 6620 7465 7374  ')..    def test
-0002aea0: 5f67 6574 5f73 6563 7265 745f 6772 616e  _get_secret_gran
-0002aeb0: 7473 2873 656c 6629 3a0a 2020 2020 2020  ts(self):.      
-0002aec0: 2020 6861 726e 6573 7320 3d20 4861 726e    harness = Harn
-0002aed0: 6573 7328 4368 6172 6d42 6173 652c 206d  ess(CharmBase, m
-0002aee0: 6574 613d 276e 616d 653a 2064 6174 6162  eta='name: datab
-0002aef0: 6173 6527 290a 2020 2020 2020 2020 7365  ase').        se
-0002af00: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
-0002af10: 726e 6573 732e 636c 6561 6e75 7029 0a0a  rness.cleanup)..
-0002af20: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
-0002af30: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
-0002af40: 645f 7265 6c61 7469 6f6e 2827 6462 272c  d_relation('db',
-0002af50: 2027 7765 6261 7070 2729 0a20 2020 2020   'webapp').     
-0002af60: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
-0002af70: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
-0002af80: 6174 696f 6e5f 6964 2c20 2777 6562 6170  ation_id, 'webap
-0002af90: 702f 3027 290a 0a20 2020 2020 2020 2073  p/0')..        s
-0002afa0: 6563 7265 7420 3d20 6861 726e 6573 732e  ecret = harness.
-0002afb0: 6d6f 6465 6c2e 6170 702e 6164 645f 7365  model.app.add_se
-0002afc0: 6372 6574 287b 2766 6f6f 273a 2027 7827  cret({'foo': 'x'
-0002afd0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-0002afe0: 6173 7365 7274 4571 7561 6c28 6861 726e  assertEqual(harn
-0002aff0: 6573 732e 6765 745f 7365 6372 6574 5f67  ess.get_secret_g
-0002b000: 7261 6e74 7328 7365 6372 6574 2e69 642c  rants(secret.id,
-0002b010: 2072 656c 6174 696f 6e5f 6964 292c 2073   relation_id), s
-0002b020: 6574 2829 290a 2020 2020 2020 2020 7365  et()).        se
-0002b030: 6372 6574 2e67 7261 6e74 2868 6172 6e65  cret.grant(harne
-0002b040: 7373 2e6d 6f64 656c 2e67 6574 5f72 656c  ss.model.get_rel
-0002b050: 6174 696f 6e28 2764 6227 2929 0a20 2020  ation('db')).   
-0002b060: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0002b070: 4571 7561 6c28 6861 726e 6573 732e 6765  Equal(harness.ge
-0002b080: 745f 7365 6372 6574 5f67 7261 6e74 7328  t_secret_grants(
-0002b090: 7365 6372 6574 2e69 642c 2072 656c 6174  secret.id, relat
-0002b0a0: 696f 6e5f 6964 292c 207b 2777 6562 6170  ion_id), {'webap
-0002b0b0: 7027 7d29 0a0a 2020 2020 2020 2020 7365  p'})..        se
-0002b0c0: 6372 6574 2e72 6576 6f6b 6528 6861 726e  cret.revoke(harn
-0002b0d0: 6573 732e 6d6f 6465 6c2e 6765 745f 7265  ess.model.get_re
-0002b0e0: 6c61 7469 6f6e 2827 6462 2729 290a 2020  lation('db')).  
-0002b0f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002b100: 7445 7175 616c 2868 6172 6e65 7373 2e67  tEqual(harness.g
-0002b110: 6574 5f73 6563 7265 745f 6772 616e 7473  et_secret_grants
-0002b120: 2873 6563 7265 742e 6964 2c20 7265 6c61  (secret.id, rela
-0002b130: 7469 6f6e 5f69 6429 2c20 7365 7428 2929  tion_id), set())
-0002b140: 0a20 2020 2020 2020 2073 6563 7265 742e  .        secret.
-0002b150: 6772 616e 7428 6861 726e 6573 732e 6d6f  grant(harness.mo
-0002b160: 6465 6c2e 6765 745f 7265 6c61 7469 6f6e  del.get_relation
-0002b170: 2827 6462 2729 2c20 756e 6974 3d68 6172  ('db'), unit=har
-0002b180: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f75  ness.model.get_u
-0002b190: 6e69 7428 2777 6562 6170 702f 3027 2929  nit('webapp/0'))
-0002b1a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0002b1b0: 7365 7274 4571 7561 6c28 6861 726e 6573  sertEqual(harnes
-0002b1c0: 732e 6765 745f 7365 6372 6574 5f67 7261  s.get_secret_gra
-0002b1d0: 6e74 7328 7365 6372 6574 2e69 642c 2072  nts(secret.id, r
-0002b1e0: 656c 6174 696f 6e5f 6964 292c 207b 2777  elation_id), {'w
-0002b1f0: 6562 6170 702f 3027 7d29 0a0a 2020 2020  ebapp/0'})..    
-0002b200: 6465 6620 7465 7374 5f74 7269 6767 6572  def test_trigger
-0002b210: 5f73 6563 7265 745f 726f 7461 7469 6f6e  _secret_rotation
-0002b220: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0002b230: 6861 726e 6573 7320 3d20 4861 726e 6573  harness = Harnes
-0002b240: 7328 4576 656e 7452 6563 6f72 6465 722c  s(EventRecorder,
-0002b250: 206d 6574 613d 276e 616d 653a 2064 6174   meta='name: dat
-0002b260: 6162 6173 6527 290a 2020 2020 2020 2020  abase').        
-0002b270: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
-0002b280: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
-0002b290: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
-0002b2a0: 203d 2068 6172 6e65 7373 2e6d 6f64 656c   = harness.model
-0002b2b0: 2e61 7070 2e61 6464 5f73 6563 7265 7428  .app.add_secret(
-0002b2c0: 7b27 666f 6f27 3a20 2778 277d 2c20 6c61  {'foo': 'x'}, la
-0002b2d0: 6265 6c3d 276c 626c 2729 0a20 2020 2020  bel='lbl').     
-0002b2e0: 2020 2068 6172 6e65 7373 2e62 6567 696e     harness.begin
-0002b2f0: 2829 0a20 2020 2020 2020 2068 6172 6e65  ().        harne
-0002b300: 7373 2e66 7261 6d65 776f 726b 2e6f 6273  ss.framework.obs
-0002b310: 6572 7665 2868 6172 6e65 7373 2e63 6861  erve(harness.cha
-0002b320: 726d 2e6f 6e2e 7365 6372 6574 5f72 6f74  rm.on.secret_rot
-0002b330: 6174 652c 2068 6172 6e65 7373 2e63 6861  ate, harness.cha
-0002b340: 726d 2e72 6563 6f72 645f 6576 656e 7429  rm.record_event)
-0002b350: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0002b360: 2e74 7269 6767 6572 5f73 6563 7265 745f  .trigger_secret_
-0002b370: 726f 7461 7469 6f6e 2873 6563 7265 742e  rotation(secret.
-0002b380: 6964 290a 2020 2020 2020 2020 6861 726e  id).        harn
-0002b390: 6573 732e 7472 6967 6765 725f 7365 6372  ess.trigger_secr
-0002b3a0: 6574 5f72 6f74 6174 696f 6e28 7365 6372  et_rotation(secr
-0002b3b0: 6574 2e69 642c 206c 6162 656c 3d27 6f76  et.id, label='ov
-0002b3c0: 6572 7269 6465 2729 0a0a 2020 2020 2020  erride')..      
-0002b3d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0002b3e0: 616c 286c 656e 2868 6172 6e65 7373 2e63  al(len(harness.c
-0002b3f0: 6861 726d 2e65 7665 6e74 7329 2c20 3229  harm.events), 2)
-0002b400: 0a20 2020 2020 2020 2065 7665 6e74 203d  .        event =
-0002b410: 2068 6172 6e65 7373 2e63 6861 726d 2e65   harness.charm.e
-0002b420: 7665 6e74 735b 305d 0a20 2020 2020 2020  vents[0].       
-0002b430: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0002b440: 7374 616e 6365 2865 7665 6e74 2c20 6f70  stance(event, op
-0002b450: 732e 6368 6172 6d2e 5365 6372 6574 526f  s.charm.SecretRo
-0002b460: 7461 7465 4576 656e 7429 0a20 2020 2020  tateEvent).     
-0002b470: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
-0002b480: 7561 6c28 6576 656e 742e 7365 6372 6574  ual(event.secret
-0002b490: 2e6c 6162 656c 2c20 276c 626c 2729 0a20  .label, 'lbl'). 
-0002b4a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002b4b0: 7274 4571 7561 6c28 6576 656e 742e 7365  rtEqual(event.se
-0002b4c0: 6372 6574 2e67 6574 5f63 6f6e 7465 6e74  cret.get_content
-0002b4d0: 2829 2c20 7b27 666f 6f27 3a20 2778 277d  (), {'foo': 'x'}
-0002b4e0: 290a 2020 2020 2020 2020 6576 656e 7420  ).        event 
-0002b4f0: 3d20 6861 726e 6573 732e 6368 6172 6d2e  = harness.charm.
-0002b500: 6576 656e 7473 5b31 5d0a 2020 2020 2020  events[1].      
-0002b510: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
-0002b520: 6e73 7461 6e63 6528 6576 656e 742c 206f  nstance(event, o
-0002b530: 7073 2e63 6861 726d 2e53 6563 7265 7452  ps.charm.SecretR
-0002b540: 6f74 6174 6545 7665 6e74 290a 2020 2020  otateEvent).    
-0002b550: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0002b560: 7175 616c 2865 7665 6e74 2e73 6563 7265  qual(event.secre
-0002b570: 742e 6c61 6265 6c2c 2027 6f76 6572 7269  t.label, 'overri
-0002b580: 6465 2729 0a20 2020 2020 2020 2073 656c  de').        sel
-0002b590: 662e 6173 7365 7274 4571 7561 6c28 6576  f.assertEqual(ev
-0002b5a0: 656e 742e 7365 6372 6574 2e67 6574 5f63  ent.secret.get_c
-0002b5b0: 6f6e 7465 6e74 2829 2c20 7b27 666f 6f27  ontent(), {'foo'
-0002b5c0: 3a20 2778 277d 290a 0a20 2020 2020 2020  : 'x'})..       
-0002b5d0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
-0002b5e0: 7452 6169 7365 7328 5275 6e74 696d 6545  tRaises(RuntimeE
-0002b5f0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0002b600: 2020 2068 6172 6e65 7373 2e74 7269 6767     harness.trigg
-0002b610: 6572 5f73 6563 7265 745f 726f 7461 7469  er_secret_rotati
-0002b620: 6f6e 2827 6e6f 7365 6372 6574 2729 0a0a  on('nosecret')..
-0002b630: 2020 2020 6465 6620 7465 7374 5f74 7269      def test_tri
-0002b640: 6767 6572 5f73 6563 7265 745f 7265 6d6f  gger_secret_remo
-0002b650: 7661 6c28 7365 6c66 293a 0a20 2020 2020  val(self):.     
-0002b660: 2020 2068 6172 6e65 7373 203d 2048 6172     harness = Har
-0002b670: 6e65 7373 2845 7665 6e74 5265 636f 7264  ness(EventRecord
-0002b680: 6572 2c20 6d65 7461 3d27 6e61 6d65 3a20  er, meta='name: 
-0002b690: 6461 7461 6261 7365 2729 0a20 2020 2020  database').     
-0002b6a0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
-0002b6b0: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
-0002b6c0: 7570 290a 0a20 2020 2020 2020 2073 6563  up)..        sec
-0002b6d0: 7265 7420 3d20 6861 726e 6573 732e 6d6f  ret = harness.mo
-0002b6e0: 6465 6c2e 6170 702e 6164 645f 7365 6372  del.app.add_secr
-0002b6f0: 6574 287b 2766 6f6f 273a 2027 7827 7d2c  et({'foo': 'x'},
-0002b700: 206c 6162 656c 3d27 6c62 6c27 290a 2020   label='lbl').  
-0002b710: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
-0002b720: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
-0002b730: 726e 6573 732e 6672 616d 6577 6f72 6b2e  rness.framework.
-0002b740: 6f62 7365 7276 6528 6861 726e 6573 732e  observe(harness.
-0002b750: 6368 6172 6d2e 6f6e 2e73 6563 7265 745f  charm.on.secret_
-0002b760: 7265 6d6f 7665 2c20 6861 726e 6573 732e  remove, harness.
-0002b770: 6368 6172 6d2e 7265 636f 7264 5f65 7665  charm.record_eve
-0002b780: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
-0002b790: 6573 732e 7472 6967 6765 725f 7365 6372  ess.trigger_secr
-0002b7a0: 6574 5f72 656d 6f76 616c 2873 6563 7265  et_removal(secre
-0002b7b0: 742e 6964 2c20 3129 0a20 2020 2020 2020  t.id, 1).       
-0002b7c0: 2068 6172 6e65 7373 2e74 7269 6767 6572   harness.trigger
-0002b7d0: 5f73 6563 7265 745f 7265 6d6f 7661 6c28  _secret_removal(
-0002b7e0: 7365 6372 6574 2e69 642c 2034 322c 206c  secret.id, 42, l
-0002b7f0: 6162 656c 3d27 6f76 6572 7269 6465 2729  abel='override')
-0002b800: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0002b810: 7373 6572 7445 7175 616c 286c 656e 2868  ssertEqual(len(h
-0002b820: 6172 6e65 7373 2e63 6861 726d 2e65 7665  arness.charm.eve
-0002b830: 6e74 7329 2c20 3229 0a20 2020 2020 2020  nts), 2).       
-0002b840: 2065 7665 6e74 203d 2068 6172 6e65 7373   event = harness
-0002b850: 2e63 6861 726d 2e65 7665 6e74 735b 305d  .charm.events[0]
-0002b860: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0002b870: 7365 7274 4973 496e 7374 616e 6365 2865  sertIsInstance(e
-0002b880: 7665 6e74 2c20 6f70 732e 6368 6172 6d2e  vent, ops.charm.
-0002b890: 5365 6372 6574 5265 6d6f 7665 4576 656e  SecretRemoveEven
-0002b8a0: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-0002b8b0: 6173 7365 7274 4571 7561 6c28 6576 656e  assertEqual(even
-0002b8c0: 742e 7365 6372 6574 2e6c 6162 656c 2c20  t.secret.label, 
-0002b8d0: 276c 626c 2729 0a20 2020 2020 2020 2073  'lbl').        s
-0002b8e0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0002b8f0: 6576 656e 742e 7265 7669 7369 6f6e 2c20  event.revision, 
-0002b900: 3129 0a20 2020 2020 2020 2073 656c 662e  1).        self.
-0002b910: 6173 7365 7274 4571 7561 6c28 6576 656e  assertEqual(even
-0002b920: 742e 7365 6372 6574 2e67 6574 5f63 6f6e  t.secret.get_con
-0002b930: 7465 6e74 2829 2c20 7b27 666f 6f27 3a20  tent(), {'foo': 
-0002b940: 2778 277d 290a 2020 2020 2020 2020 6576  'x'}).        ev
-0002b950: 656e 7420 3d20 6861 726e 6573 732e 6368  ent = harness.ch
-0002b960: 6172 6d2e 6576 656e 7473 5b31 5d0a 2020  arm.events[1].  
-0002b970: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002b980: 7449 7349 6e73 7461 6e63 6528 6576 656e  tIsInstance(even
-0002b990: 742c 206f 7073 2e63 6861 726d 2e53 6563  t, ops.charm.Sec
-0002b9a0: 7265 7452 656d 6f76 6545 7665 6e74 290a  retRemoveEvent).
-0002b9b0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0002b9c0: 6572 7445 7175 616c 2865 7665 6e74 2e73  ertEqual(event.s
-0002b9d0: 6563 7265 742e 6c61 6265 6c2c 2027 6f76  ecret.label, 'ov
-0002b9e0: 6572 7269 6465 2729 0a20 2020 2020 2020  erride').       
-0002b9f0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0002ba00: 6c28 6576 656e 742e 7265 7669 7369 6f6e  l(event.revision
-0002ba10: 2c20 3432 290a 2020 2020 2020 2020 7365  , 42).        se
-0002ba20: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-0002ba30: 7665 6e74 2e73 6563 7265 742e 6765 745f  vent.secret.get_
-0002ba40: 636f 6e74 656e 7428 292c 207b 2766 6f6f  content(), {'foo
-0002ba50: 273a 2027 7827 7d29 0a0a 2020 2020 2020  ': 'x'})..      
-0002ba60: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
-0002ba70: 7274 5261 6973 6573 2852 756e 7469 6d65  rtRaises(Runtime
-0002ba80: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002ba90: 2020 2020 6861 726e 6573 732e 7472 6967      harness.trig
-0002baa0: 6765 725f 7365 6372 6574 5f72 656d 6f76  ger_secret_remov
-0002bab0: 616c 2827 6e6f 7365 6372 6574 272c 2031  al('nosecret', 1
-0002bac0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-0002bad0: 7472 6967 6765 725f 7365 6372 6574 5f65  trigger_secret_e
-0002bae0: 7870 6972 6174 696f 6e28 7365 6c66 293a  xpiration(self):
-0002baf0: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
-0002bb00: 203d 2048 6172 6e65 7373 2845 7665 6e74   = Harness(Event
-0002bb10: 5265 636f 7264 6572 2c20 6d65 7461 3d27  Recorder, meta='
-0002bb20: 6e61 6d65 3a20 6461 7461 6261 7365 2729  name: database')
-0002bb30: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0002bb40: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
-0002bb50: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
-0002bb60: 2020 2073 6563 7265 7420 3d20 6861 726e     secret = harn
-0002bb70: 6573 732e 6d6f 6465 6c2e 6170 702e 6164  ess.model.app.ad
-0002bb80: 645f 7365 6372 6574 287b 2766 6f6f 273a  d_secret({'foo':
-0002bb90: 2027 7827 7d2c 206c 6162 656c 3d27 6c62   'x'}, label='lb
-0002bba0: 6c27 290a 2020 2020 2020 2020 6861 726e  l').        harn
-0002bbb0: 6573 732e 6265 6769 6e28 290a 2020 2020  ess.begin().    
-0002bbc0: 2020 2020 6861 726e 6573 732e 6672 616d      harness.fram
-0002bbd0: 6577 6f72 6b2e 6f62 7365 7276 6528 6861  ework.observe(ha
-0002bbe0: 726e 6573 732e 6368 6172 6d2e 6f6e 2e73  rness.charm.on.s
-0002bbf0: 6563 7265 745f 7265 6d6f 7665 2c20 6861  ecret_remove, ha
-0002bc00: 726e 6573 732e 6368 6172 6d2e 7265 636f  rness.charm.reco
-0002bc10: 7264 5f65 7665 6e74 290a 2020 2020 2020  rd_event).      
-0002bc20: 2020 6861 726e 6573 732e 7472 6967 6765    harness.trigge
-0002bc30: 725f 7365 6372 6574 5f72 656d 6f76 616c  r_secret_removal
-0002bc40: 2873 6563 7265 742e 6964 2c20 3129 0a20  (secret.id, 1). 
-0002bc50: 2020 2020 2020 2068 6172 6e65 7373 2e74         harness.t
-0002bc60: 7269 6767 6572 5f73 6563 7265 745f 7265  rigger_secret_re
-0002bc70: 6d6f 7661 6c28 7365 6372 6574 2e69 642c  moval(secret.id,
-0002bc80: 2034 322c 206c 6162 656c 3d27 6f76 6572   42, label='over
-0002bc90: 7269 6465 2729 0a0a 2020 2020 2020 2020  ride')..        
-0002bca0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
-0002bcb0: 286c 656e 2868 6172 6e65 7373 2e63 6861  (len(harness.cha
-0002bcc0: 726d 2e65 7665 6e74 7329 2c20 3229 0a20  rm.events), 2). 
-0002bcd0: 2020 2020 2020 2065 7665 6e74 203d 2068         event = h
-0002bce0: 6172 6e65 7373 2e63 6861 726d 2e65 7665  arness.charm.eve
-0002bcf0: 6e74 735b 305d 0a20 2020 2020 2020 2073  nts[0].        s
-0002bd00: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
-0002bd10: 616e 6365 2865 7665 6e74 2c20 6f70 732e  ance(event, ops.
-0002bd20: 6368 6172 6d2e 5365 6372 6574 5265 6d6f  charm.SecretRemo
-0002bd30: 7665 4576 656e 7429 0a20 2020 2020 2020  veEvent).       
-0002bd40: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0002bd50: 6c28 6576 656e 742e 7365 6372 6574 2e6c  l(event.secret.l
-0002bd60: 6162 656c 2c20 276c 626c 2729 0a20 2020  abel, 'lbl').   
-0002bd70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0002bd80: 4571 7561 6c28 6576 656e 742e 7265 7669  Equal(event.revi
-0002bd90: 7369 6f6e 2c20 3129 0a20 2020 2020 2020  sion, 1).       
-0002bda0: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
-0002bdb0: 6c28 6576 656e 742e 7365 6372 6574 2e67  l(event.secret.g
-0002bdc0: 6574 5f63 6f6e 7465 6e74 2829 2c20 7b27  et_content(), {'
-0002bdd0: 666f 6f27 3a20 2778 277d 290a 2020 2020  foo': 'x'}).    
-0002bde0: 2020 2020 6576 656e 7420 3d20 6861 726e      event = harn
-0002bdf0: 6573 732e 6368 6172 6d2e 6576 656e 7473  ess.charm.events
-0002be00: 5b31 5d0a 2020 2020 2020 2020 7365 6c66  [1].        self
-0002be10: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-0002be20: 6528 6576 656e 742c 206f 7073 2e63 6861  e(event, ops.cha
-0002be30: 726d 2e53 6563 7265 7452 656d 6f76 6545  rm.SecretRemoveE
-0002be40: 7665 6e74 290a 2020 2020 2020 2020 7365  vent).        se
-0002be50: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
-0002be60: 7665 6e74 2e73 6563 7265 742e 6c61 6265  vent.secret.labe
-0002be70: 6c2c 2027 6f76 6572 7269 6465 2729 0a20  l, 'override'). 
-0002be80: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
-0002be90: 7274 4571 7561 6c28 6576 656e 742e 7265  rtEqual(event.re
-0002bea0: 7669 7369 6f6e 2c20 3432 290a 2020 2020  vision, 42).    
-0002beb0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0002bec0: 7175 616c 2865 7665 6e74 2e73 6563 7265  qual(event.secre
-0002bed0: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
-0002bee0: 207b 2766 6f6f 273a 2027 7827 7d29 0a0a   {'foo': 'x'})..
-0002bef0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0002bf00: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
-0002bf10: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
-0002bf20: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
-0002bf30: 732e 7472 6967 6765 725f 7365 6372 6574  s.trigger_secret
-0002bf40: 5f72 656d 6f76 616c 2827 6e6f 7365 6372  _removal('nosecr
-0002bf50: 6574 272c 2031 290a 0a0a 636c 6173 7320  et', 1)...class 
-0002bf60: 4576 656e 7452 6563 6f72 6465 7228 4368  EventRecorder(Ch
-0002bf70: 6172 6d42 6173 6529 3a0a 2020 2020 6465  armBase):.    de
-0002bf80: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-0002bf90: 2066 7261 6d65 776f 726b 293a 0a20 2020   framework):.   
-0002bfa0: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
-0002bfb0: 6e69 745f 5f28 6672 616d 6577 6f72 6b29  nit__(framework)
-0002bfc0: 0a20 2020 2020 2020 2073 656c 662e 6576  .        self.ev
-0002bfd0: 656e 7473 203d 205b 5d0a 0a20 2020 2064  ents = []..    d
-0002bfe0: 6566 2072 6563 6f72 645f 6576 656e 7428  ef record_event(
-0002bff0: 7365 6c66 2c20 6576 656e 7429 3a0a 2020  self, event):.  
-0002c000: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-0002c010: 732e 6170 7065 6e64 2865 7665 6e74 290a  s.append(event).
-0002c020: 0a0a 636c 6173 7320 5465 7374 506f 7274  ..class TestPort
-0002c030: 7328 756e 6974 7465 7374 2e54 6573 7443  s(unittest.TestC
-0002c040: 6173 6529 3a0a 2020 2020 6465 6620 7465  ase):.    def te
-0002c050: 7374 5f70 6f72 7473 2873 656c 6629 3a0a  st_ports(self):.
-0002c060: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
-0002c070: 3d20 4861 726e 6573 7328 4368 6172 6d42  = Harness(CharmB
-0002c080: 6173 652c 206d 6574 613d 276e 616d 653a  ase, meta='name:
-0002c090: 2077 6562 6170 7027 290a 2020 2020 2020   webapp').      
-0002c0a0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
-0002c0b0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
-0002c0c0: 7029 0a20 2020 2020 2020 2075 6e69 7420  p).        unit 
-0002c0d0: 3d20 6861 726e 6573 732e 6d6f 6465 6c2e  = harness.model.
-0002c0e0: 756e 6974 0a0a 2020 2020 2020 2020 756e  unit..        un
-0002c0f0: 6974 2e6f 7065 6e5f 706f 7274 2827 7463  it.open_port('tc
-0002c100: 7027 2c20 3830 3830 290a 2020 2020 2020  p', 8080).      
-0002c110: 2020 756e 6974 2e6f 7065 6e5f 706f 7274    unit.open_port
-0002c120: 2827 7564 7027 2c20 3430 3030 290a 2020  ('udp', 4000).  
-0002c130: 2020 2020 2020 756e 6974 2e6f 7065 6e5f        unit.open_
-0002c140: 706f 7274 2827 6963 6d70 2729 0a0a 2020  port('icmp')..  
-0002c150: 2020 2020 2020 706f 7274 735f 7365 7420        ports_set 
-0002c160: 3d20 756e 6974 2e6f 7065 6e65 645f 706f  = unit.opened_po
-0002c170: 7274 7328 290a 2020 2020 2020 2020 7365  rts().        se
-0002c180: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
-0002c190: 6e63 6528 706f 7274 735f 7365 742c 2073  nce(ports_set, s
-0002c1a0: 6574 290a 2020 2020 2020 2020 706f 7274  et).        port
-0002c1b0: 7320 3d20 736f 7274 6564 2870 6f72 7473  s = sorted(ports
-0002c1c0: 5f73 6574 2c20 6b65 793d 6c61 6d62 6461  _set, key=lambda
-0002c1d0: 2070 3a20 2870 2e70 726f 746f 636f 6c2c   p: (p.protocol,
-0002c1e0: 2070 2e70 6f72 7429 290a 2020 2020 2020   p.port)).      
-0002c1f0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
-0002c200: 616c 286c 656e 2870 6f72 7473 292c 2033  al(len(ports), 3
-0002c210: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-0002c220: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
-0002c230: 706f 7274 735b 305d 2c20 6d6f 6465 6c2e  ports[0], model.
-0002c240: 4f70 656e 6564 506f 7274 290a 2020 2020  OpenedPort).    
-0002c250: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-0002c260: 7175 616c 2870 6f72 7473 5b30 5d2e 7072  qual(ports[0].pr
-0002c270: 6f74 6f63 6f6c 2c20 2769 636d 7027 290a  otocol, 'icmp').
-0002c280: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
-0002c290: 6572 7449 734e 6f6e 6528 706f 7274 735b  ertIsNone(ports[
-0002c2a0: 305d 2e70 6f72 7429 0a20 2020 2020 2020  0].port).       
-0002c2b0: 2073 656c 662e 6173 7365 7274 4973 496e   self.assertIsIn
-0002c2c0: 7374 616e 6365 2870 6f72 7473 5b31 5d2c  stance(ports[1],
-0002c2d0: 206d 6f64 656c 2e4f 7065 6e65 6450 6f72   model.OpenedPor
-0002c2e0: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-0002c2f0: 6173 7365 7274 4571 7561 6c28 706f 7274  assertEqual(port
-0002c300: 735b 315d 2e70 726f 746f 636f 6c2c 2027  s[1].protocol, '
-0002c310: 7463 7027 290a 2020 2020 2020 2020 7365  tcp').        se
-0002c320: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
-0002c330: 6f72 7473 5b31 5d2e 706f 7274 2c20 3830  orts[1].port, 80
-0002c340: 3830 290a 2020 2020 2020 2020 7365 6c66  80).        self
-0002c350: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
-0002c360: 6528 706f 7274 735b 325d 2c20 6d6f 6465  e(ports[2], mode
-0002c370: 6c2e 4f70 656e 6564 506f 7274 290a 2020  l.OpenedPort).  
-0002c380: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002c390: 7445 7175 616c 2870 6f72 7473 5b32 5d2e  tEqual(ports[2].
-0002c3a0: 7072 6f74 6f63 6f6c 2c20 2775 6470 2729  protocol, 'udp')
-0002c3b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0002c3c0: 7365 7274 4571 7561 6c28 706f 7274 735b  sertEqual(ports[
-0002c3d0: 325d 2e70 6f72 742c 2034 3030 3029 0a0a  2].port, 4000)..
-0002c3e0: 2020 2020 2020 2020 756e 6974 2e63 6c6f          unit.clo
-0002c3f0: 7365 5f70 6f72 7428 2774 6370 272c 2038  se_port('tcp', 8
-0002c400: 3038 3029 0a20 2020 2020 2020 2075 6e69  080).        uni
-0002c410: 742e 636c 6f73 655f 706f 7274 2827 7463  t.close_port('tc
-0002c420: 7027 2c20 3830 3830 2920 2023 2063 6c6f  p', 8080)  # clo
-0002c430: 7369 6e67 2073 616d 6520 706f 7274 2061  sing same port a
-0002c440: 6761 696e 2068 6173 206e 6f20 6566 6665  gain has no effe
-0002c450: 6374 0a20 2020 2020 2020 2075 6e69 742e  ct.        unit.
-0002c460: 636c 6f73 655f 706f 7274 2827 7564 7027  close_port('udp'
-0002c470: 2c20 3430 3030 290a 0a20 2020 2020 2020  , 4000)..       
-0002c480: 2070 6f72 7473 5f73 6574 203d 2075 6e69   ports_set = uni
-0002c490: 742e 6f70 656e 6564 5f70 6f72 7473 2829  t.opened_ports()
-0002c4a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-0002c4b0: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
-0002c4c0: 6f72 7473 5f73 6574 2c20 7365 7429 0a20  orts_set, set). 
-0002c4d0: 2020 2020 2020 2070 6f72 7473 203d 2073         ports = s
-0002c4e0: 6f72 7465 6428 706f 7274 735f 7365 742c  orted(ports_set,
-0002c4f0: 206b 6579 3d6c 616d 6264 6120 703a 2028   key=lambda p: (
-0002c500: 702e 7072 6f74 6f63 6f6c 2c20 702e 706f  p.protocol, p.po
-0002c510: 7274 2929 0a20 2020 2020 2020 2073 656c  rt)).        sel
-0002c520: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
-0002c530: 6e28 706f 7274 7329 2c20 3129 0a20 2020  n(ports), 1).   
-0002c540: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-0002c550: 4973 496e 7374 616e 6365 2870 6f72 7473  IsInstance(ports
-0002c560: 5b30 5d2c 206d 6f64 656c 2e4f 7065 6e65  [0], model.Opene
-0002c570: 6450 6f72 7429 0a20 2020 2020 2020 2073  dPort).        s
-0002c580: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-0002c590: 706f 7274 735b 305d 2e70 726f 746f 636f  ports[0].protoco
-0002c5a0: 6c2c 2027 6963 6d70 2729 0a20 2020 2020  l, 'icmp').     
-0002c5b0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
-0002c5c0: 4e6f 6e65 2870 6f72 7473 5b30 5d2e 706f  None(ports[0].po
-0002c5d0: 7274 290a 0a20 2020 2020 2020 2075 6e69  rt)..        uni
-0002c5e0: 742e 636c 6f73 655f 706f 7274 2827 6963  t.close_port('ic
-0002c5f0: 6d70 2729 0a0a 2020 2020 2020 2020 706f  mp')..        po
-0002c600: 7274 735f 7365 7420 3d20 756e 6974 2e6f  rts_set = unit.o
-0002c610: 7065 6e65 645f 706f 7274 7328 290a 2020  pened_ports().  
-0002c620: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-0002c630: 7445 7175 616c 2870 6f72 7473 5f73 6574  tEqual(ports_set
-0002c640: 2c20 7365 7428 2929 0a0a 2020 2020 6465  , set())..    de
-0002c650: 6620 7465 7374 5f65 7272 6f72 7328 7365  f test_errors(se
-0002c660: 6c66 293a 0a20 2020 2020 2020 2068 6172  lf):.        har
-0002c670: 6e65 7373 203d 2048 6172 6e65 7373 2843  ness = Harness(C
-0002c680: 6861 726d 4261 7365 2c20 6d65 7461 3d27  harmBase, meta='
-0002c690: 6e61 6d65 3a20 7765 6261 7070 2729 0a20  name: webapp'). 
-0002c6a0: 2020 2020 2020 2073 656c 662e 6164 6443         self.addC
-0002c6b0: 6c65 616e 7570 2868 6172 6e65 7373 2e63  leanup(harness.c
-0002c6c0: 6c65 616e 7570 290a 2020 2020 2020 2020  leanup).        
-0002c6d0: 756e 6974 203d 2068 6172 6e65 7373 2e6d  unit = harness.m
-0002c6e0: 6f64 656c 2e75 6e69 740a 0a20 2020 2020  odel.unit..     
-0002c6f0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
-0002c700: 6572 7452 6169 7365 7328 6d6f 6465 6c2e  ertRaises(model.
-0002c710: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
-0002c720: 2020 2020 2020 2020 2075 6e69 742e 6f70           unit.op
-0002c730: 656e 5f70 6f72 7428 2769 636d 7027 2c20  en_port('icmp', 
-0002c740: 3830 3830 2920 2023 2069 636d 7020 6361  8080)  # icmp ca
-0002c750: 6e6e 6f74 2068 6176 6520 706f 7274 0a20  nnot have port. 
-0002c760: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0002c770: 2e61 7373 6572 7452 6169 7365 7328 6d6f  .assertRaises(mo
-0002c780: 6465 6c2e 4d6f 6465 6c45 7272 6f72 293a  del.ModelError):
-0002c790: 0a20 2020 2020 2020 2020 2020 2075 6e69  .            uni
-0002c7a0: 742e 6f70 656e 5f70 6f72 7428 2766 7470  t.open_port('ftp
-0002c7b0: 272c 2038 3038 3029 2020 2320 696e 7661  ', 8080)  # inva
-0002c7c0: 6c69 6420 7072 6f74 6f63 6f6c 0a20 2020  lid protocol.   
-0002c7d0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0002c7e0: 7373 6572 7452 6169 7365 7328 6d6f 6465  ssertRaises(mode
-0002c7f0: 6c2e 4d6f 6465 6c45 7272 6f72 293a 0a20  l.ModelError):. 
-0002c800: 2020 2020 2020 2020 2020 2075 6e69 742e             unit.
-0002c810: 6f70 656e 5f70 6f72 7428 2774 6370 2729  open_port('tcp')
-0002c820: 2020 2320 7463 7020 6d75 7374 2068 6176    # tcp must hav
-0002c830: 6520 706f 7274 0a20 2020 2020 2020 2077  e port.        w
-0002c840: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
-0002c850: 6169 7365 7328 6d6f 6465 6c2e 4d6f 6465  aises(model.Mode
-0002c860: 6c45 7272 6f72 293a 0a20 2020 2020 2020  lError):.       
-0002c870: 2020 2020 2075 6e69 742e 6f70 656e 5f70       unit.open_p
-0002c880: 6f72 7428 2775 6470 2729 2020 2320 7564  ort('udp')  # ud
-0002c890: 7020 6d75 7374 2068 6176 6520 706f 7274  p must have port
-0002c8a0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-0002c8b0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
-0002c8c0: 6d6f 6465 6c2e 4d6f 6465 6c45 7272 6f72  model.ModelError
-0002c8d0: 293a 0a20 2020 2020 2020 2020 2020 2075  ):.            u
-0002c8e0: 6e69 742e 6f70 656e 5f70 6f72 7428 2774  nit.open_port('t
-0002c8f0: 6370 272c 2030 2920 2023 2070 6f72 7420  cp', 0)  # port 
-0002c900: 6f75 7420 6f66 2072 616e 6765 0a20 2020  out of range.   
-0002c910: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
-0002c920: 7373 6572 7452 6169 7365 7328 6d6f 6465  ssertRaises(mode
-0002c930: 6c2e 4d6f 6465 6c45 7272 6f72 293a 0a20  l.ModelError):. 
-0002c940: 2020 2020 2020 2020 2020 2075 6e69 742e             unit.
-0002c950: 6f70 656e 5f70 6f72 7428 2774 6370 272c  open_port('tcp',
-0002c960: 2036 3535 3336 2920 2023 2070 6f72 7420   65536)  # port 
-0002c970: 6f75 7420 6f66 2072 616e 6765 0a         out of range.
+00018580: 2020 2020 2761 7070 273a 2027 706f 7374      'app': 'post
+00018590: 6772 6573 716c 272c 0a20 2020 2020 2020  gresql',.       
+000185a0: 2020 2020 2020 2020 2020 7d7d 2c0a 2020            }},.  
+000185b0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+000185c0: 6e61 6d65 273a 2027 6c65 6164 6572 2d65  name': 'leader-e
+000185d0: 6c65 6374 6564 277d 2c0a 2020 2020 2020  lected'},.      
+000185e0: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+000185f0: 273a 2027 636f 6e66 6967 2d63 6861 6e67  ': 'config-chang
+00018600: 6564 272c 2027 6461 7461 273a 207b 7d7d  ed', 'data': {}}
+00018610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018620: 2020 7b27 6e61 6d65 273a 2027 7374 6172    {'name': 'star
+00018630: 7427 7d2c 0a20 2020 2020 2020 2020 2020  t'},.           
+00018640: 2020 2020 207b 276e 616d 6527 3a20 2772       {'name': 'r
+00018650: 656c 6174 696f 6e2d 6a6f 696e 6564 272c  elation-joined',
+00018660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018670: 2020 2772 656c 6174 696f 6e27 3a20 2764    'relation': 'd
+00018680: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+00018690: 2020 2020 2027 6461 7461 273a 207b 0a20       'data': {. 
+000186a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186b0: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
+000186c0: 273a 2072 656c 5f69 642c 0a20 2020 2020  ': rel_id,.     
+000186d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186e0: 2775 6e69 7427 3a20 2770 6f73 7467 7265  'unit': 'postgre
+000186f0: 7371 6c2f 3027 2c0a 2020 2020 2020 2020  sql/0',.        
+00018700: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
+00018710: 7027 3a20 2770 6f73 7467 7265 7371 6c27  p': 'postgresql'
+00018720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018730: 2020 207d 7d2c 0a20 2020 2020 2020 2020     }},.         
+00018740: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+00018750: 2772 656c 6174 696f 6e2d 6368 616e 6765  'relation-change
+00018760: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00018770: 2020 2020 2027 7265 6c61 7469 6f6e 273a       'relation':
+00018780: 2027 6462 272c 0a20 2020 2020 2020 2020   'db',.         
+00018790: 2020 2020 2020 2020 2764 6174 6127 3a20          'data': 
+000187a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000187b0: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+000187c0: 5f69 6427 3a20 7265 6c5f 6964 2c0a 2020  _id': rel_id,.  
+000187d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187e0: 2020 2027 756e 6974 273a 2027 706f 7374     'unit': 'post
+000187f0: 6772 6573 716c 2f30 272c 0a20 2020 2020  gresql/0',.     
+00018800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018810: 2761 7070 273a 2027 706f 7374 6772 6573  'app': 'postgres
+00018820: 716c 272c 0a20 2020 2020 2020 2020 2020  ql',.           
+00018830: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
+00018840: 2020 2020 2020 2020 2020 7b27 6e61 6d65            {'name
+00018850: 273a 2027 7265 6c61 7469 6f6e 2d6a 6f69  ': 'relation-joi
+00018860: 6e65 6427 2c0a 2020 2020 2020 2020 2020  ned',.          
+00018870: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00018880: 273a 2027 6462 272c 0a20 2020 2020 2020  ': 'db',.       
+00018890: 2020 2020 2020 2020 2020 2764 6174 6127            'data'
+000188a0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+000188b0: 2020 2020 2020 2020 2027 7265 6c61 7469           'relati
+000188c0: 6f6e 5f69 6427 3a20 7265 6c5f 6964 2c0a  on_id': rel_id,.
+000188d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188e0: 2020 2020 2027 756e 6974 273a 2027 706f       'unit': 'po
+000188f0: 7374 6772 6573 716c 2f31 272c 0a20 2020  stgresql/1',.   
+00018900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018910: 2020 2761 7070 273a 2027 706f 7374 6772    'app': 'postgr
+00018920: 6573 716c 272c 0a20 2020 2020 2020 2020  esql',.         
+00018930: 2020 2020 2020 2020 7d7d 2c0a 2020 2020          }},.    
+00018940: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+00018950: 6d65 273a 2027 7265 6c61 7469 6f6e 2d63  me': 'relation-c
+00018960: 6861 6e67 6564 272c 0a20 2020 2020 2020  hanged',.       
+00018970: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00018980: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
+00018990: 2020 2020 2020 2020 2020 2020 2027 6461               'da
+000189a0: 7461 273a 207b 0a20 2020 2020 2020 2020  ta': {.         
+000189b0: 2020 2020 2020 2020 2020 2020 2772 656c              'rel
+000189c0: 6174 696f 6e5f 6964 273a 2072 656c 5f69  ation_id': rel_i
+000189d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000189e0: 2020 2020 2020 2020 2775 6e69 7427 3a20          'unit': 
+000189f0: 2770 6f73 7467 7265 7371 6c2f 3127 2c0a  'postgresql/1',.
+00018a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a10: 2020 2020 2027 6170 7027 3a20 2770 6f73       'app': 'pos
+00018a20: 7467 7265 7371 6c27 2c0a 2020 2020 2020  tgresql',.      
+00018a30: 2020 2020 2020 2020 2020 207d 7d2c 0a20             }},. 
+00018a40: 2020 2020 2020 2020 2020 205d 290a 0a20             ]).. 
+00018a50: 2020 2064 6566 2074 6573 745f 6265 6769     def test_begi
+00018a60: 6e5f 7769 7468 5f69 6e69 7469 616c 5f68  n_with_initial_h
+00018a70: 6f6f 6b73 5f6d 756c 7469 706c 655f 7265  ooks_multiple_re
+00018a80: 6c61 7469 6f6e 5f73 616d 655f 656e 6470  lation_same_endp
+00018a90: 6f69 6e74 2873 656c 6629 3a0a 2020 2020  oint(self):.    
+00018aa0: 2020 2020 636c 6173 7320 4368 6172 6d57      class CharmW
+00018ab0: 6974 6844 4228 5265 6c61 7469 6f6e 4576  ithDB(RelationEv
+00018ac0: 656e 7443 6861 726d 293a 0a20 2020 2020  entCharm):.     
+00018ad0: 2020 2020 2020 2064 6566 205f 5f69 6e69         def __ini
+00018ae0: 745f 5f28 7365 6c66 2c20 6672 616d 6577  t__(self, framew
+00018af0: 6f72 6b29 3a0a 2020 2020 2020 2020 2020  ork):.          
+00018b00: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+00018b10: 696e 6974 5f5f 2866 7261 6d65 776f 726b  init__(framework
+00018b20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00018b30: 2020 7365 6c66 2e6f 6273 6572 7665 5f72    self.observe_r
+00018b40: 656c 6174 696f 6e5f 6576 656e 7473 2827  elation_events('
+00018b50: 6462 2729 0a20 2020 2020 2020 2068 6172  db').        har
+00018b60: 6e65 7373 203d 206f 7073 2e74 6573 7469  ness = ops.testi
+00018b70: 6e67 2e48 6172 6e65 7373 2843 6861 726d  ng.Harness(Charm
+00018b80: 5769 7468 4442 2c20 6d65 7461 3d27 2727  WithDB, meta='''
+00018b90: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00018ba0: 653a 2074 6573 742d 6170 700a 2020 2020  e: test-app.    
+00018bb0: 2020 2020 2020 2020 7265 7175 6972 6573          requires
+00018bc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018bd0: 6462 3a0a 2020 2020 2020 2020 2020 2020  db:.            
+00018be0: 2020 2020 696e 7465 7266 6163 653a 2073      interface: s
+00018bf0: 716c 0a20 2020 2020 2020 2020 2020 2027  ql.            '
+00018c00: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+00018c10: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+00018c20: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+00018c30: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+00018c40: 5f6c 6561 6465 7228 290a 2020 2020 2020  _leader().      
+00018c50: 2020 7265 6c5f 6964 5f61 203d 2068 6172    rel_id_a = har
+00018c60: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+00018c70: 6e28 2764 6227 2c20 2770 672d 6127 290a  n('db', 'pg-a').
+00018c80: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00018c90: 6164 645f 7265 6c61 7469 6f6e 5f75 6e69  add_relation_uni
+00018ca0: 7428 7265 6c5f 6964 5f61 2c20 2770 672d  t(rel_id_a, 'pg-
+00018cb0: 612f 3027 290a 2020 2020 2020 2020 7265  a/0').        re
+00018cc0: 6c5f 6964 5f62 203d 2068 6172 6e65 7373  l_id_b = harness
+00018cd0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+00018ce0: 6227 2c20 2770 672d 6227 290a 2020 2020  b', 'pg-b').    
+00018cf0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+00018d00: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
+00018d10: 6c5f 6964 5f62 2c20 2770 672d 622f 3027  l_id_b, 'pg-b/0'
+00018d20: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+00018d30: 732e 6265 6769 6e5f 7769 7468 5f69 6e69  s.begin_with_ini
+00018d40: 7469 616c 5f68 6f6f 6b73 2829 0a20 2020  tial_hooks().   
+00018d50: 2020 2020 2063 6861 6e67 6573 203d 2068       changes = h
+00018d60: 6172 6e65 7373 2e63 6861 726d 2e63 6861  arness.charm.cha
+00018d70: 6e67 6573 5b3a 5d0a 2020 2020 2020 2020  nges[:].        
+00018d80: 6578 7065 6374 6564 5f70 7265 6669 7820  expected_prefix 
+00018d90: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00018da0: 7b27 6e61 6d65 273a 2027 696e 7374 616c  {'name': 'instal
+00018db0: 6c27 7d2c 0a20 2020 2020 2020 205d 0a20  l'},.        ]. 
+00018dc0: 2020 2020 2020 2023 2054 6865 2066 6972         # The fir
+00018dd0: 7374 2065 7665 6e74 7320 6172 6520 616c  st events are al
+00018de0: 7761 7973 2074 6865 2073 616d 650a 2020  ways the same.  
+00018df0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00018e00: 7445 7175 616c 2863 6861 6e67 6573 5b3a  tEqual(changes[:
+00018e10: 6c65 6e28 6578 7065 6374 6564 5f70 7265  len(expected_pre
+00018e20: 6669 7829 5d2c 2065 7870 6563 7465 645f  fix)], expected_
+00018e30: 7072 6566 6978 290a 2020 2020 2020 2020  prefix).        
+00018e40: 6368 616e 6765 7320 3d20 6368 616e 6765  changes = change
+00018e50: 735b 6c65 6e28 6578 7065 6374 6564 5f70  s[len(expected_p
+00018e60: 7265 6669 7829 3a5d 0a20 2020 2020 2020  refix):].       
+00018e70: 2023 2048 6f77 6576 6572 2c20 7468 6520   # However, the 
+00018e80: 6f72 6465 7220 6f66 2072 656c 6174 696f  order of relatio
+00018e90: 6e2d 6372 6561 7465 6420 6576 656e 7473  n-created events
+00018ea0: 2063 616e 2062 6520 696e 2061 6e79 206f   can be in any o
+00018eb0: 7264 6572 0a20 2020 2020 2020 2065 7870  rder.        exp
+00018ec0: 6563 7465 645f 7265 6c61 7469 6f6e 5f63  ected_relation_c
+00018ed0: 7265 6174 6564 203d 205b 0a20 2020 2020  reated = [.     
+00018ee0: 2020 2020 2020 207b 276e 616d 6527 3a20         {'name': 
+00018ef0: 2772 656c 6174 696f 6e2d 6372 6561 7465  'relation-create
+00018f00: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00018f10: 2027 7265 6c61 7469 6f6e 273a 2027 6462   'relation': 'db
+00018f20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00018f30: 2764 6174 6127 3a20 7b0a 2020 2020 2020  'data': {.      
+00018f40: 2020 2020 2020 2020 2020 2027 7265 6c61             'rela
+00018f50: 7469 6f6e 5f69 6427 3a20 7265 6c5f 6964  tion_id': rel_id
+00018f60: 5f61 2c0a 2020 2020 2020 2020 2020 2020  _a,.            
+00018f70: 2020 2020 2027 756e 6974 273a 204e 6f6e       'unit': Non
+00018f80: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00018f90: 2020 2020 2761 7070 273a 2027 7067 2d61      'app': 'pg-a
+00018fa0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00018fb0: 7d7d 2c0a 2020 2020 2020 2020 2020 2020  }},.            
+00018fc0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
+00018fd0: 6f6e 2d63 7265 6174 6564 272c 0a20 2020  on-created',.   
+00018fe0: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00018ff0: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
+00019000: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
+00019010: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00019020: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
+00019030: 273a 2072 656c 5f69 645f 622c 0a20 2020  ': rel_id_b,.   
+00019040: 2020 2020 2020 2020 2020 2020 2020 2775                'u
+00019050: 6e69 7427 3a20 4e6f 6e65 2c0a 2020 2020  nit': None,.    
+00019060: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
+00019070: 7027 3a20 2770 672d 6227 2c0a 2020 2020  p': 'pg-b',.    
+00019080: 2020 2020 2020 2020 207d 7d2c 0a20 2020           }},.   
+00019090: 2020 2020 205d 0a20 2020 2020 2020 2069       ].        i
+000190a0: 6620 6368 616e 6765 735b 3a32 5d20 213d  f changes[:2] !=
+000190b0: 2065 7870 6563 7465 645f 7265 6c61 7469   expected_relati
+000190c0: 6f6e 5f63 7265 6174 6564 3a0a 2020 2020  on_created:.    
+000190d0: 2020 2020 2020 2020 2320 6368 616e 6765          # change
+000190e0: 2074 6865 206f 7264 6572 0a20 2020 2020   the order.     
+000190f0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+00019100: 7265 6c61 7469 6f6e 5f63 7265 6174 6564  relation_created
+00019110: 203d 205b 6578 7065 6374 6564 5f72 656c   = [expected_rel
+00019120: 6174 696f 6e5f 6372 6561 7465 645b 315d  ation_created[1]
+00019130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019150: 2020 2020 2020 2020 2020 2065 7870 6563             expec
+00019160: 7465 645f 7265 6c61 7469 6f6e 5f63 7265  ted_relation_cre
+00019170: 6174 6564 5b30 5d5d 0a20 2020 2020 2020  ated[0]].       
+00019180: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00019190: 6c28 6368 616e 6765 735b 3a32 5d2c 2065  l(changes[:2], e
+000191a0: 7870 6563 7465 645f 7265 6c61 7469 6f6e  xpected_relation
+000191b0: 5f63 7265 6174 6564 290a 2020 2020 2020  _created).      
+000191c0: 2020 6368 616e 6765 7320 3d20 6368 616e    changes = chan
+000191d0: 6765 735b 323a 5d0a 2020 2020 2020 2020  ges[2:].        
+000191e0: 6578 7065 6374 6564 5f6d 6964 646c 6520  expected_middle 
+000191f0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00019200: 7b27 6e61 6d65 273a 2027 6c65 6164 6572  {'name': 'leader
+00019210: 2d65 6c65 6374 6564 277d 2c0a 2020 2020  -elected'},.    
+00019220: 2020 2020 2020 2020 7b27 6e61 6d65 273a          {'name':
+00019230: 2027 636f 6e66 6967 2d63 6861 6e67 6564   'config-changed
+00019240: 272c 2027 6461 7461 273a 207b 7d7d 2c0a  ', 'data': {}},.
+00019250: 2020 2020 2020 2020 2020 2020 7b27 6e61              {'na
+00019260: 6d65 273a 2027 7374 6172 7427 7d2c 0a20  me': 'start'},. 
+00019270: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00019280: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00019290: 6c28 6368 616e 6765 735b 3a6c 656e 2865  l(changes[:len(e
+000192a0: 7870 6563 7465 645f 6d69 6464 6c65 295d  xpected_middle)]
+000192b0: 2c20 6578 7065 6374 6564 5f6d 6964 646c  , expected_middl
+000192c0: 6529 0a20 2020 2020 2020 2063 6861 6e67  e).        chang
+000192d0: 6573 203d 2063 6861 6e67 6573 5b6c 656e  es = changes[len
+000192e0: 2865 7870 6563 7465 645f 6d69 6464 6c65  (expected_middle
+000192f0: 293a 5d0a 2020 2020 2020 2020 615f 6669  ):].        a_fi
+00019300: 7273 7420 3d20 5b0a 2020 2020 2020 2020  rst = [.        
+00019310: 2020 2020 7b27 6e61 6d65 273a 2027 7265      {'name': 're
+00019320: 6c61 7469 6f6e 2d6a 6f69 6e65 6427 2c0a  lation-joined',.
+00019330: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00019340: 6c61 7469 6f6e 273a 2027 6462 272c 0a20  lation': 'db',. 
+00019350: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
+00019360: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
+00019370: 2020 2020 2020 2027 7265 6c61 7469 6f6e         'relation
+00019380: 5f69 6427 3a20 7265 6c5f 6964 5f61 2c0a  _id': rel_id_a,.
+00019390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193a0: 2027 756e 6974 273a 2027 7067 2d61 2f30   'unit': 'pg-a/0
+000193b0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000193c0: 2020 2020 2761 7070 273a 2027 7067 2d61      'app': 'pg-a
+000193d0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000193e0: 7d7d 2c0a 2020 2020 2020 2020 2020 2020  }},.            
+000193f0: 7b27 6e61 6d65 273a 2027 7265 6c61 7469  {'name': 'relati
+00019400: 6f6e 2d63 6861 6e67 6564 272c 0a20 2020  on-changed',.   
+00019410: 2020 2020 2020 2020 2020 2772 656c 6174            'relat
+00019420: 696f 6e27 3a20 2764 6227 2c0a 2020 2020  ion': 'db',.    
+00019430: 2020 2020 2020 2020 2027 6461 7461 273a           'data':
+00019440: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00019450: 2020 2020 2772 656c 6174 696f 6e5f 6964      'relation_id
+00019460: 273a 2072 656c 5f69 645f 612c 0a20 2020  ': rel_id_a,.   
+00019470: 2020 2020 2020 2020 2020 2020 2020 2775                'u
+00019480: 6e69 7427 3a20 2770 672d 612f 3027 2c0a  nit': 'pg-a/0',.
+00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194a0: 2027 6170 7027 3a20 2770 672d 6127 2c0a   'app': 'pg-a',.
+000194b0: 2020 2020 2020 2020 2020 2020 207d 7d2c               }},
+000194c0: 0a20 2020 2020 2020 2020 2020 207b 276e  .            {'n
+000194d0: 616d 6527 3a20 2772 656c 6174 696f 6e2d  ame': 'relation-
+000194e0: 6a6f 696e 6564 272c 0a20 2020 2020 2020  joined',.       
+000194f0: 2020 2020 2020 2772 656c 6174 696f 6e27        'relation'
+00019500: 3a20 2764 6227 2c0a 2020 2020 2020 2020  : 'db',.        
+00019510: 2020 2020 2027 6461 7461 273a 207b 0a20       'data': {. 
+00019520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019530: 2772 656c 6174 696f 6e5f 6964 273a 2072  'relation_id': r
+00019540: 656c 5f69 645f 622c 0a20 2020 2020 2020  el_id_b,.       
+00019550: 2020 2020 2020 2020 2020 2775 6e69 7427            'unit'
+00019560: 3a20 2770 672d 622f 3027 2c0a 2020 2020  : 'pg-b/0',.    
+00019570: 2020 2020 2020 2020 2020 2020 2027 6170               'ap
+00019580: 7027 3a20 2770 672d 6227 2c0a 2020 2020  p': 'pg-b',.    
+00019590: 2020 2020 2020 2020 207d 7d2c 0a20 2020           }},.   
+000195a0: 2020 2020 2020 2020 207b 276e 616d 6527           {'name'
+000195b0: 3a20 2772 656c 6174 696f 6e2d 6368 616e  : 'relation-chan
+000195c0: 6765 6427 2c0a 2020 2020 2020 2020 2020  ged',.          
+000195d0: 2020 2027 7265 6c61 7469 6f6e 273a 2027     'relation': '
+000195e0: 6462 272c 0a20 2020 2020 2020 2020 2020  db',.           
+000195f0: 2020 2764 6174 6127 3a20 7b0a 2020 2020    'data': {.    
+00019600: 2020 2020 2020 2020 2020 2020 2027 7265               're
+00019610: 6c61 7469 6f6e 5f69 6427 3a20 7265 6c5f  lation_id': rel_
+00019620: 6964 5f62 2c0a 2020 2020 2020 2020 2020  id_b,.          
+00019630: 2020 2020 2020 2027 756e 6974 273a 2027         'unit': '
+00019640: 7067 2d62 2f30 272c 0a20 2020 2020 2020  pg-b/0',.       
+00019650: 2020 2020 2020 2020 2020 2761 7070 273a            'app':
+00019660: 2027 7067 2d62 272c 0a20 2020 2020 2020   'pg-b',.       
+00019670: 2020 2020 2020 7d7d 2c0a 2020 2020 2020        }},.      
+00019680: 2020 5d0a 2020 2020 2020 2020 6966 2063    ].        if c
+00019690: 6861 6e67 6573 2021 3d20 615f 6669 7273  hanges != a_firs
+000196a0: 743a 0a20 2020 2020 2020 2020 2020 2062  t:.            b
+000196b0: 5f66 6972 7374 203d 205b 615f 6669 7273  _first = [a_firs
+000196c0: 745b 325d 2c20 615f 6669 7273 745b 335d  t[2], a_first[3]
+000196d0: 2c20 615f 6669 7273 745b 305d 2c20 615f  , a_first[0], a_
+000196e0: 6669 7273 745b 315d 5d0a 2020 2020 2020  first[1]].      
+000196f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00019700: 7445 7175 616c 2863 6861 6e67 6573 2c20  tEqual(changes, 
+00019710: 625f 6669 7273 7429 0a0a 2020 2020 6465  b_first)..    de
+00019720: 6620 7465 7374 5f62 6567 696e 5f77 6974  f test_begin_wit
+00019730: 685f 696e 6974 6961 6c5f 686f 6f6b 735f  h_initial_hooks_
+00019740: 756e 6b6e 6f77 6e5f 7374 6174 7573 2873  unknown_status(s
+00019750: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
+00019760: 5665 7269 6679 2074 6861 7420 6120 6368  Verify that a ch
+00019770: 6172 6d20 7468 6174 2064 6f65 7320 6e6f  arm that does no
+00019780: 7420 7365 7420 6120 7374 6174 7573 2069  t set a status i
+00019790: 6e20 7468 6520 696e 7374 616c 6c20 686f  n the install ho
+000197a0: 6f6b 2077 696c 6c20 6861 7665 2061 6e0a  ok will have an.
+000197b0: 2020 2020 2020 2020 2320 756e 6b6e 6f77          # unknow
+000197c0: 6e20 7374 6174 7573 2069 6e20 7468 6520  n status in the 
+000197d0: 6861 726e 6573 732e 0a20 2020 2020 2020  harness..       
+000197e0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+000197f0: 6573 7469 6e67 2e48 6172 6e65 7373 2852  esting.Harness(R
+00019800: 6563 6f72 6469 6e67 4368 6172 6d2c 206d  ecordingCharm, m
+00019810: 6574 613d 2727 270a 2020 2020 2020 2020  eta='''.        
+00019820: 2020 2020 6e61 6d65 3a20 7465 7374 2d61      name: test-a
+00019830: 7070 0a20 2020 2020 2020 2020 2020 2027  pp.            '
+00019840: 2727 2c20 636f 6e66 6967 3d27 2727 0a20  '', config='''. 
+00019850: 2020 2020 2020 2020 206f 7074 696f 6e73           options
+00019860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019870: 2020 666f 6f3a 0a20 2020 2020 2020 2020    foo:.         
+00019880: 2020 2020 2020 2020 2020 2064 6573 6372             descr
+00019890: 6970 7469 6f6e 3a20 6120 636f 6e66 6967  iption: a config
+000198a0: 206f 7074 696f 6e0a 2020 2020 2020 2020   option.        
+000198b0: 2020 2020 2020 2020 2020 2020 7479 7065              type
+000198c0: 3a20 7374 7269 6e67 0a20 2020 2020 2020  : string.       
+000198d0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+000198e0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+000198f0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+00019900: 7029 0a20 2020 2020 2020 2062 6163 6b65  p).        backe
+00019910: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
+00019920: 636b 656e 640a 2020 2020 2020 2020 6861  ckend.        ha
+00019930: 726e 6573 732e 6265 6769 6e5f 7769 7468  rness.begin_with
+00019940: 5f69 6e69 7469 616c 5f68 6f6f 6b73 2829  _initial_hooks()
+00019950: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00019960: 7373 6572 7445 7175 616c 280a 2020 2020  ssertEqual(.    
+00019970: 2020 2020 2020 2020 6261 636b 656e 642e          backend.
+00019980: 7374 6174 7573 5f67 6574 2869 735f 6170  status_get(is_ap
+00019990: 703d 4661 6c73 6529 2c0a 2020 2020 2020  p=False),.      
+000199a0: 2020 2020 2020 7b27 7374 6174 7573 273a        {'status':
+000199b0: 2027 756e 6b6e 6f77 6e27 2c20 276d 6573   'unknown', 'mes
+000199c0: 7361 6765 273a 2027 277d 290a 0a20 2020  sage': ''})..   
+000199d0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+000199e0: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
+000199f0: 2020 2062 6163 6b65 6e64 2e73 7461 7475     backend.statu
+00019a00: 735f 6765 7428 6973 5f61 7070 3d54 7275  s_get(is_app=Tru
+00019a10: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00019a20: 7b27 7374 6174 7573 273a 2027 756e 6b6e  {'status': 'unkn
+00019a30: 6f77 6e27 2c20 276d 6573 7361 6765 273a  own', 'message':
+00019a40: 2027 277d 290a 0a20 2020 2064 6566 2074   ''})..    def t
+00019a50: 6573 745f 6265 6769 6e5f 7769 7468 5f69  est_begin_with_i
+00019a60: 6e69 7469 616c 5f68 6f6f 6b73 5f69 6e73  nitial_hooks_ins
+00019a70: 7461 6c6c 5f73 6574 735f 7374 6174 7573  tall_sets_status
+00019a80: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00019a90: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+00019aa0: 7374 696e 672e 4861 726e 6573 7328 5265  sting.Harness(Re
+00019ab0: 636f 7264 696e 6743 6861 726d 2c20 6d65  cordingCharm, me
+00019ac0: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+00019ad0: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+00019ae0: 700a 2020 2020 2020 2020 2020 2020 2727  p.            ''
+00019af0: 272c 2063 6f6e 6669 673d 2727 270a 2020  ', config='''.  
+00019b00: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
+00019b10: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00019b20: 2020 2073 6574 5f73 7461 7475 733a 0a20     set_status:. 
+00019b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b40: 2020 2064 6573 6372 6970 7469 6f6e 3a20     description: 
+00019b50: 6120 636f 6e66 6967 206f 7074 696f 6e0a  a config option.
+00019b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b70: 2020 2020 7479 7065 3a20 626f 6f6c 6561      type: boolea
+00019b80: 6e0a 0a20 2020 2020 2020 2020 2020 2027  n..            '
+00019b90: 2727 290a 2020 2020 2020 2020 7365 6c66  '').        self
+00019ba0: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+00019bb0: 6573 732e 636c 6561 6e75 7029 0a20 2020  ess.cleanup).   
+00019bc0: 2020 2020 2062 6163 6b65 6e64 203d 2068       backend = h
+00019bd0: 6172 6e65 7373 2e5f 6261 636b 656e 640a  arness._backend.
+00019be0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+00019bf0: 7570 6461 7465 5f63 6f6e 6669 6728 6b65  update_config(ke
+00019c00: 795f 7661 6c75 6573 3d7b 2273 6574 5f73  y_values={"set_s
+00019c10: 7461 7475 7322 3a20 5472 7565 7d29 0a20  tatus": True}). 
+00019c20: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+00019c30: 6567 696e 5f77 6974 685f 696e 6974 6961  egin_with_initia
+00019c40: 6c5f 686f 6f6b 7328 290a 0a20 2020 2020  l_hooks()..     
+00019c50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00019c60: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+00019c70: 2062 6163 6b65 6e64 2e73 7461 7475 735f   backend.status_
+00019c80: 6765 7428 6973 5f61 7070 3d46 616c 7365  get(is_app=False
+00019c90: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
+00019ca0: 2773 7461 7475 7327 3a20 276d 6169 6e74  'status': 'maint
+00019cb0: 656e 616e 6365 272c 2027 6d65 7373 6167  enance', 'messag
+00019cc0: 6527 3a20 2753 7461 7475 7320 7365 7420  e': 'Status set 
+00019cd0: 6f6e 2069 6e73 7461 6c6c 277d 290a 0a20  on install'}).. 
+00019ce0: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
+00019cf0: 7065 6262 6c65 5f63 6f6e 7461 696e 6572  pebble_container
+00019d00: 5f70 6c61 6e28 7365 6c66 293a 0a20 2020  _plan(self):.   
+00019d10: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+00019d20: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+00019d30: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+00019d40: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+00019d50: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+00019d60: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+00019d70: 2020 636f 6e74 6169 6e65 7273 3a0a 2020    containers:.  
+00019d80: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
+00019d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019da0: 2072 6573 6f75 7263 653a 2066 6f6f 2d69   resource: foo-i
+00019db0: 6d61 6765 0a20 2020 2020 2020 2020 2020  mage.           
+00019dc0: 2027 2727 290a 2020 2020 2020 2020 7365   ''').        se
+00019dd0: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+00019de0: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+00019df0: 2020 2020 2020 2068 6172 6e65 7373 2e62         harness.b
+00019e00: 6567 696e 2829 0a20 2020 2020 2020 2068  egin().        h
+00019e10: 6172 6e65 7373 2e73 6574 5f63 616e 5f63  arness.set_can_c
+00019e20: 6f6e 6e65 6374 2827 666f 6f27 2c20 5472  onnect('foo', Tr
+00019e30: 7565 290a 2020 2020 2020 2020 696e 6974  ue).        init
+00019e40: 6961 6c5f 706c 616e 203d 2068 6172 6e65  ial_plan = harne
+00019e50: 7373 2e67 6574 5f63 6f6e 7461 696e 6572  ss.get_container
+00019e60: 5f70 6562 626c 655f 706c 616e 2827 666f  _pebble_plan('fo
+00019e70: 6f27 290a 2020 2020 2020 2020 7365 6c66  o').        self
+00019e80: 2e61 7373 6572 7445 7175 616c 2869 6e69  .assertEqual(ini
+00019e90: 7469 616c 5f70 6c61 6e2e 746f 5f79 616d  tial_plan.to_yam
+00019ea0: 6c28 292c 2027 7b7d 5c6e 2729 0a20 2020  l(), '{}\n').   
+00019eb0: 2020 2020 2063 6f6e 7461 696e 6572 203d       container =
+00019ec0: 2068 6172 6e65 7373 2e6d 6f64 656c 2e75   harness.model.u
+00019ed0: 6e69 742e 6765 745f 636f 6e74 6169 6e65  nit.get_containe
+00019ee0: 7228 2766 6f6f 2729 0a20 2020 2020 2020  r('foo').       
+00019ef0: 2063 6f6e 7461 696e 6572 2e70 6562 626c   container.pebbl
+00019f00: 652e 6164 645f 6c61 7965 7228 2774 6573  e.add_layer('tes
+00019f10: 742d 6162 272c 2027 2727 5c0a 2020 2020  t-ab', '''\.    
+00019f20: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+00019f30: 2074 6573 742d 6c61 7965 720a 2020 2020   test-layer.    
+00019f40: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+00019f50: 696f 6e3a 2061 206c 6179 6572 2074 6861  ion: a layer tha
+00019f60: 7420 7765 2063 616e 2075 7365 2066 6f72  t we can use for
+00019f70: 2074 6573 7469 6e67 0a20 2020 2020 2020   testing.       
+00019f80: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
+00019f90: 2020 2020 2020 2020 2020 2020 2061 3a0a               a:.
+00019fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fb0: 636f 6d6d 616e 643a 202f 6269 6e2f 6563  command: /bin/ec
+00019fc0: 686f 2068 656c 6c6f 2066 726f 6d20 610a  ho hello from a.
+00019fd0: 2020 2020 2020 2020 2020 2020 2020 623a                b:
+00019fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019ff0: 2063 6f6d 6d61 6e64 3a20 2f62 696e 2f65   command: /bin/e
+0001a000: 6368 6f20 6865 6c6c 6f20 6672 6f6d 2062  cho hello from b
+0001a010: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+0001a020: 290a 2020 2020 2020 2020 636f 6e74 6169  ).        contai
+0001a030: 6e65 722e 7065 6262 6c65 2e61 6464 5f6c  ner.pebble.add_l
+0001a040: 6179 6572 2827 7465 7374 2d63 272c 2027  ayer('test-c', '
+0001a050: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
+0001a060: 7375 6d6d 6172 793a 2074 6573 742d 666f  summary: test-fo
+0001a070: 722d 630a 2020 2020 2020 2020 2020 2020  r-c.            
+0001a080: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
+0001a090: 2020 2020 2020 2020 633a 0a20 2020 2020          c:.     
+0001a0a0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+0001a0b0: 6e64 3a20 2f62 696e 2f65 6368 6f20 6865  nd: /bin/echo he
+0001a0c0: 6c6c 6f20 6672 6f6d 2063 0a20 2020 2020  llo from c.     
+0001a0d0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+0001a0e0: 2020 2020 706c 616e 203d 2063 6f6e 7461      plan = conta
+0001a0f0: 696e 6572 2e70 6562 626c 652e 6765 745f  iner.pebble.get_
+0001a100: 706c 616e 2829 0a20 2020 2020 2020 2073  plan().        s
+0001a110: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001a120: 706c 616e 2e74 6f5f 7961 6d6c 2829 2c20  plan.to_yaml(), 
+0001a130: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
+0001a140: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
+0001a150: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
+0001a160: 2020 2020 2020 2020 2061 3a0a 2020 2020           a:.    
+0001a170: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+0001a180: 616e 643a 202f 6269 6e2f 6563 686f 2068  and: /bin/echo h
+0001a190: 656c 6c6f 2066 726f 6d20 610a 2020 2020  ello from a.    
+0001a1a0: 2020 2020 2020 2020 2020 623a 0a20 2020            b:.   
+0001a1b0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+0001a1c0: 6d61 6e64 3a20 2f62 696e 2f65 6368 6f20  mand: /bin/echo 
+0001a1d0: 6865 6c6c 6f20 6672 6f6d 2062 0a20 2020  hello from b.   
+0001a1e0: 2020 2020 2020 2020 2020 2063 3a0a 2020             c:.  
+0001a1f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0001a200: 6d6d 616e 643a 202f 6269 6e2f 6563 686f  mmand: /bin/echo
+0001a210: 2068 656c 6c6f 2066 726f 6d20 630a 2020   hello from c.  
+0001a220: 2020 2020 2020 2020 2020 2727 2729 290a            ''')).
+0001a230: 2020 2020 2020 2020 6861 726e 6573 735f          harness_
+0001a240: 706c 616e 203d 2068 6172 6e65 7373 2e67  plan = harness.g
+0001a250: 6574 5f63 6f6e 7461 696e 6572 5f70 6562  et_container_peb
+0001a260: 626c 655f 706c 616e 2827 666f 6f27 290a  ble_plan('foo').
+0001a270: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001a280: 6572 7445 7175 616c 2868 6172 6e65 7373  ertEqual(harness
+0001a290: 5f70 6c61 6e2e 746f 5f79 616d 6c28 292c  _plan.to_yaml(),
+0001a2a0: 2070 6c61 6e2e 746f 5f79 616d 6c28 2929   plan.to_yaml())
+0001a2b0: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+0001a2c0: 6574 5f70 6562 626c 655f 636f 6e74 6169  et_pebble_contai
+0001a2d0: 6e65 725f 706c 616e 5f75 6e6b 6e6f 776e  ner_plan_unknown
+0001a2e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001a2f0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0001a300: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0001a310: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0001a320: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0001a330: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0001a340: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001a350: 7461 696e 6572 733a 0a20 2020 2020 2020  tainers:.       
+0001a360: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+0001a370: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+0001a380: 7572 6365 3a20 666f 6f2d 696d 6167 650a  urce: foo-image.
+0001a390: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0001a3a0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001a3b0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0001a3c0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0001a3d0: 2020 6861 726e 6573 732e 6265 6769 6e28    harness.begin(
+0001a3e0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0001a3f0: 732e 7365 745f 6361 6e5f 636f 6e6e 6563  s.set_can_connec
+0001a400: 7428 2766 6f6f 272c 2054 7275 6529 0a20  t('foo', True). 
+0001a410: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0001a420: 2e61 7373 6572 7452 6169 7365 7328 4b65  .assertRaises(Ke
+0001a430: 7945 7272 6f72 293a 0a20 2020 2020 2020  yError):.       
+0001a440: 2020 2020 2068 6172 6e65 7373 2e67 6574       harness.get
+0001a450: 5f63 6f6e 7461 696e 6572 5f70 6562 626c  _container_pebbl
+0001a460: 655f 706c 616e 2827 756e 6b6e 6f77 6e27  e_plan('unknown'
+0001a470: 290a 2020 2020 2020 2020 706c 616e 203d  ).        plan =
+0001a480: 2068 6172 6e65 7373 2e67 6574 5f63 6f6e   harness.get_con
+0001a490: 7461 696e 6572 5f70 6562 626c 655f 706c  tainer_pebble_pl
+0001a4a0: 616e 2827 666f 6f27 290a 2020 2020 2020  an('foo').      
+0001a4b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001a4c0: 616c 2870 6c61 6e2e 746f 5f79 616d 6c28  al(plan.to_yaml(
+0001a4d0: 292c 2022 7b7d 5c6e 2229 0a0a 2020 2020  ), "{}\n")..    
+0001a4e0: 6465 6620 7465 7374 5f63 6f6e 7461 696e  def test_contain
+0001a4f0: 6572 5f70 6562 626c 655f 7265 6164 7928  er_pebble_ready(
+0001a500: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0001a510: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0001a520: 7469 6e67 2e48 6172 6e65 7373 2843 6f6e  ting.Harness(Con
+0001a530: 7461 696e 6572 4576 656e 7443 6861 726d  tainerEventCharm
+0001a540: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+0001a550: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+0001a560: 742d 6170 700a 2020 2020 2020 2020 2020  t-app.          
+0001a570: 2020 636f 6e74 6169 6e65 7273 3a0a 2020    containers:.  
+0001a580: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
+0001a590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a5a0: 2072 6573 6f75 7263 653a 2066 6f6f 2d69   resource: foo-i
+0001a5b0: 6d61 6765 0a20 2020 2020 2020 2027 2727  mage.        '''
+0001a5c0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001a5d0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0001a5e0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0001a5f0: 2020 2023 2054 6869 7320 6973 2061 206e     # This is a n
+0001a600: 6f2d 6f70 2069 6620 6974 2069 7320 6361  o-op if it is ca
+0001a610: 6c6c 6564 2062 6566 6f72 6520 6265 6769  lled before begi
+0001a620: 6e28 292c 2062 7574 2069 7420 6973 6e27  n(), but it isn'
+0001a630: 7420 616e 2065 7272 6f72 0a20 2020 2020  t an error.     
+0001a640: 2020 2068 6172 6e65 7373 2e63 6f6e 7461     harness.conta
+0001a650: 696e 6572 5f70 6562 626c 655f 7265 6164  iner_pebble_read
+0001a660: 7928 2766 6f6f 2729 0a20 2020 2020 2020  y('foo').       
+0001a670: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
+0001a680: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0001a690: 2e63 6861 726d 2e6f 6273 6572 7665 5f63  .charm.observe_c
+0001a6a0: 6f6e 7461 696e 6572 5f65 7665 6e74 7328  ontainer_events(
+0001a6b0: 2766 6f6f 2729 0a20 2020 2020 2020 2068  'foo').        h
+0001a6c0: 6172 6e65 7373 2e63 6f6e 7461 696e 6572  arness.container
+0001a6d0: 5f70 6562 626c 655f 7265 6164 7928 2766  _pebble_ready('f
+0001a6e0: 6f6f 2729 0a20 2020 2020 2020 2073 656c  oo').        sel
+0001a6f0: 662e 6173 7365 7274 4571 7561 6c28 0a20  f.assertEqual(. 
+0001a700: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+0001a710: 7373 2e63 6861 726d 2e63 6861 6e67 6573  ss.charm.changes
+0001a720: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
+0001a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a740: 7b27 6e61 6d65 273a 2027 7065 6262 6c65  {'name': 'pebble
+0001a750: 2d72 6561 6479 272c 0a20 2020 2020 2020  -ready',.       
+0001a760: 2020 2020 2020 2020 2020 2763 6f6e 7461            'conta
+0001a770: 696e 6572 273a 2027 666f 6f27 2c0a 2020  iner': 'foo',.  
+0001a780: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0001a790: 2c0a 2020 2020 2020 2020 2020 2020 5d0a  ,.            ].
+0001a7a0: 2020 2020 2020 2020 290a 0a0a 636c 6173          )...clas
+0001a7b0: 7320 5465 7374 4e65 7477 6f72 6b28 756e  s TestNetwork(un
+0001a7c0: 6974 7465 7374 2e54 6573 7443 6173 6529  ittest.TestCase)
+0001a7d0: 3a0a 2020 2020 6465 6620 7365 7455 7028  :.    def setUp(
+0001a7e0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0001a7f0: 656c 662e 6861 726e 6573 7320 3d20 6f70  elf.harness = op
+0001a800: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0001a810: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0001a820: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0001a830: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+0001a840: 2d63 6861 726d 0a20 2020 2020 2020 2020  -charm.         
+0001a850: 2020 2072 6571 7569 7265 733a 0a20 2020     requires:.   
+0001a860: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+0001a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a880: 2069 6e74 6572 6661 6365 3a20 6461 7461   interface: data
+0001a890: 6261 7365 0a20 2020 2020 2020 2020 2020  base.           
+0001a8a0: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
+0001a8b0: 2020 2020 2020 2020 2020 696e 7465 7266            interf
+0001a8c0: 6163 653a 2078 797a 0a20 2020 2020 2020  ace: xyz.       
+0001a8d0: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+0001a8e0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0001a8f0: 7028 7365 6c66 2e68 6172 6e65 7373 2e63  p(self.harness.c
+0001a900: 6c65 616e 7570 290a 0a20 2020 2064 6566  leanup)..    def
+0001a910: 2074 6573 745f 6164 645f 6e65 7477 6f72   test_add_networ
+0001a920: 6b5f 6465 6661 756c 7473 2873 656c 6629  k_defaults(self)
+0001a930: 3a0a 2020 2020 2020 2020 7365 6c66 2e68  :.        self.h
+0001a940: 6172 6e65 7373 2e61 6464 5f6e 6574 776f  arness.add_netwo
+0001a950: 726b 2827 3130 2e30 2e30 2e31 3027 290a  rk('10.0.0.10').
+0001a960: 0a20 2020 2020 2020 2062 696e 6469 6e67  .        binding
+0001a970: 203d 2073 656c 662e 6861 726e 6573 732e   = self.harness.
+0001a980: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
+0001a990: 6728 2764 6227 290a 2020 2020 2020 2020  g('db').        
+0001a9a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0001a9b0: 2862 696e 6469 6e67 2e6e 616d 652c 2027  (binding.name, '
+0001a9c0: 6462 2729 0a20 2020 2020 2020 206e 6574  db').        net
+0001a9d0: 776f 726b 203d 2062 696e 6469 6e67 2e6e  work = binding.n
+0001a9e0: 6574 776f 726b 0a20 2020 2020 2020 2073  etwork.        s
+0001a9f0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001aa00: 6e65 7477 6f72 6b2e 6269 6e64 5f61 6464  network.bind_add
+0001aa10: 7265 7373 2c20 6970 6164 6472 6573 732e  ress, ipaddress.
+0001aa20: 4950 7634 4164 6472 6573 7328 2731 302e  IPv4Address('10.
+0001aa30: 302e 302e 3130 2729 290a 2020 2020 2020  0.0.10')).      
+0001aa40: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001aa50: 616c 286e 6574 776f 726b 2e69 6e67 7265  al(network.ingre
+0001aa60: 7373 5f61 6464 7265 7373 2c20 6970 6164  ss_address, ipad
+0001aa70: 6472 6573 732e 4950 7634 4164 6472 6573  dress.IPv4Addres
+0001aa80: 7328 2731 302e 302e 302e 3130 2729 290a  s('10.0.0.10')).
+0001aa90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001aaa0: 6572 7445 7175 616c 286e 6574 776f 726b  ertEqual(network
+0001aab0: 2e69 6e67 7265 7373 5f61 6464 7265 7373  .ingress_address
+0001aac0: 6573 2c20 5b69 7061 6464 7265 7373 2e49  es, [ipaddress.I
+0001aad0: 5076 3441 6464 7265 7373 2827 3130 2e30  Pv4Address('10.0
+0001aae0: 2e30 2e31 3027 295d 290a 2020 2020 2020  .0.10')]).      
+0001aaf0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001ab00: 616c 286e 6574 776f 726b 2e65 6772 6573  al(network.egres
+0001ab10: 735f 7375 626e 6574 732c 205b 6970 6164  s_subnets, [ipad
+0001ab20: 6472 6573 732e 4950 7634 4e65 7477 6f72  dress.IPv4Networ
+0001ab30: 6b28 2731 302e 302e 302e 302f 3234 2729  k('10.0.0.0/24')
+0001ab40: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+0001ab50: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+0001ab60: 6e65 7477 6f72 6b2e 696e 7465 7266 6163  network.interfac
+0001ab70: 6573 292c 2031 290a 2020 2020 2020 2020  es), 1).        
+0001ab80: 696e 7465 7266 6163 6520 3d20 6e65 7477  interface = netw
+0001ab90: 6f72 6b2e 696e 7465 7266 6163 6573 5b30  ork.interfaces[0
+0001aba0: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+0001abb0: 7373 6572 7445 7175 616c 2869 6e74 6572  ssertEqual(inter
+0001abc0: 6661 6365 2e6e 616d 652c 2027 6574 6830  face.name, 'eth0
+0001abd0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001abe0: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
+0001abf0: 7266 6163 652e 6164 6472 6573 732c 2069  rface.address, i
+0001ac00: 7061 6464 7265 7373 2e49 5076 3441 6464  paddress.IPv4Add
+0001ac10: 7265 7373 2827 3130 2e30 2e30 2e31 3027  ress('10.0.0.10'
+0001ac20: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0001ac30: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
+0001ac40: 7266 6163 652e 7375 626e 6574 2c20 6970  rface.subnet, ip
+0001ac50: 6164 6472 6573 732e 4950 7634 4e65 7477  address.IPv4Netw
+0001ac60: 6f72 6b28 2731 302e 302e 302e 302f 3234  ork('10.0.0.0/24
+0001ac70: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
+0001ac80: 745f 6164 645f 6e65 7477 6f72 6b5f 616c  t_add_network_al
+0001ac90: 6c5f 6172 6773 2873 656c 6629 3a0a 2020  l_args(self):.  
+0001aca0: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+0001acb0: 6420 3d20 7365 6c66 2e68 6172 6e65 7373  d = self.harness
+0001acc0: 2e61 6464 5f72 656c 6174 696f 6e28 2764  .add_relation('d
+0001acd0: 6227 2c20 2770 6f73 7467 7265 7371 6c27  b', 'postgresql'
+0001ace0: 290a 2020 2020 2020 2020 7365 6c66 2e68  ).        self.h
+0001acf0: 6172 6e65 7373 2e61 6464 5f6e 6574 776f  arness.add_netwo
+0001ad00: 726b 2827 3130 2e30 2e30 2e31 3027 2c0a  rk('10.0.0.10',.
+0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad30: 2065 6e64 706f 696e 743d 2764 6227 2c0a   endpoint='db',.
+0001ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad60: 2072 656c 6174 696f 6e5f 6964 3d72 656c   relation_id=rel
+0001ad70: 6174 696f 6e5f 6964 2c0a 2020 2020 2020  ation_id,.      
+0001ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad90: 2020 2020 2020 2020 2020 2063 6964 723d             cidr=
+0001ada0: 2731 302e 302e 302e 302f 3827 2c0a 2020  '10.0.0.0/8',.  
+0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001add0: 6e74 6572 6661 6365 3d27 6574 6831 272c  nterface='eth1',
+0001ade0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae00: 2020 696e 6772 6573 735f 6164 6472 6573    ingress_addres
+0001ae10: 7365 733d 5b27 3130 2e30 2e30 2e31 272c  ses=['10.0.0.1',
+0001ae20: 2027 3130 2e30 2e30 2e32 275d 2c0a 2020   '10.0.0.2'],.  
+0001ae30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001ae50: 6772 6573 735f 7375 626e 6574 733d 5b27  gress_subnets=['
+0001ae60: 3130 2e30 2e30 2e30 2f38 272c 2027 3130  10.0.0.0/8', '10
+0001ae70: 2e31 302e 302e 302f 3136 275d 290a 0a20  .10.0.0/16']).. 
+0001ae80: 2020 2020 2020 2072 656c 6174 696f 6e20         relation 
+0001ae90: 3d20 7365 6c66 2e68 6172 6e65 7373 2e6d  = self.harness.m
+0001aea0: 6f64 656c 2e67 6574 5f72 656c 6174 696f  odel.get_relatio
+0001aeb0: 6e28 2764 6227 2c20 7265 6c61 7469 6f6e  n('db', relation
+0001aec0: 5f69 6429 0a20 2020 2020 2020 2062 696e  _id).        bin
+0001aed0: 6469 6e67 203d 2073 656c 662e 6861 726e  ding = self.harn
+0001aee0: 6573 732e 6d6f 6465 6c2e 6765 745f 6269  ess.model.get_bi
+0001aef0: 6e64 696e 6728 7265 6c61 7469 6f6e 290a  nding(relation).
+0001af00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001af10: 6572 7445 7175 616c 2862 696e 6469 6e67  ertEqual(binding
+0001af20: 2e6e 616d 652c 2027 6462 2729 0a20 2020  .name, 'db').   
+0001af30: 2020 2020 206e 6574 776f 726b 203d 2062       network = b
+0001af40: 696e 6469 6e67 2e6e 6574 776f 726b 0a20  inding.network. 
+0001af50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001af60: 7274 4571 7561 6c28 6e65 7477 6f72 6b2e  rtEqual(network.
+0001af70: 6269 6e64 5f61 6464 7265 7373 2c20 6970  bind_address, ip
+0001af80: 6164 6472 6573 732e 4950 7634 4164 6472  address.IPv4Addr
+0001af90: 6573 7328 2731 302e 302e 302e 3130 2729  ess('10.0.0.10')
+0001afa0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001afb0: 7373 6572 7445 7175 616c 286e 6574 776f  ssertEqual(netwo
+0001afc0: 726b 2e69 6e67 7265 7373 5f61 6464 7265  rk.ingress_addre
+0001afd0: 7373 2c20 6970 6164 6472 6573 732e 4950  ss, ipaddress.IP
+0001afe0: 7634 4164 6472 6573 7328 2731 302e 302e  v4Address('10.0.
+0001aff0: 302e 3127 2929 0a20 2020 2020 2020 2073  0.1')).        s
+0001b000: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0001b010: 6e65 7477 6f72 6b2e 696e 6772 6573 735f  network.ingress_
+0001b020: 6164 6472 6573 7365 732c 0a20 2020 2020  addresses,.     
+0001b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b040: 2020 2020 5b69 7061 6464 7265 7373 2e49      [ipaddress.I
+0001b050: 5076 3441 6464 7265 7373 2827 3130 2e30  Pv4Address('10.0
+0001b060: 2e30 2e31 2729 2c20 6970 6164 6472 6573  .0.1'), ipaddres
+0001b070: 732e 4950 7634 4164 6472 6573 7328 2731  s.IPv4Address('1
+0001b080: 302e 302e 302e 3227 295d 290a 2020 2020  0.0.0.2')]).    
+0001b090: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b0a0: 7175 616c 286e 6574 776f 726b 2e65 6772  qual(network.egr
+0001b0b0: 6573 735f 7375 626e 6574 732c 0a20 2020  ess_subnets,.   
+0001b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0d0: 2020 2020 2020 5b69 7061 6464 7265 7373        [ipaddress
+0001b0e0: 2e49 5076 344e 6574 776f 726b 2827 3130  .IPv4Network('10
+0001b0f0: 2e30 2e30 2e30 2f38 2729 2c0a 2020 2020  .0.0.0/8'),.    
+0001b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b110: 2020 2020 2020 6970 6164 6472 6573 732e        ipaddress.
+0001b120: 4950 7634 4e65 7477 6f72 6b28 2731 302e  IPv4Network('10.
+0001b130: 3130 2e30 2e30 2f31 3627 295d 290a 2020  10.0.0/16')]).  
+0001b140: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b150: 7445 7175 616c 286c 656e 286e 6574 776f  tEqual(len(netwo
+0001b160: 726b 2e69 6e74 6572 6661 6365 7329 2c20  rk.interfaces), 
+0001b170: 3129 0a20 2020 2020 2020 2069 6e74 6572  1).        inter
+0001b180: 6661 6365 203d 206e 6574 776f 726b 2e69  face = network.i
+0001b190: 6e74 6572 6661 6365 735b 305d 0a20 2020  nterfaces[0].   
+0001b1a0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001b1b0: 4571 7561 6c28 696e 7465 7266 6163 652e  Equal(interface.
+0001b1c0: 6e61 6d65 2c20 2765 7468 3127 290a 2020  name, 'eth1').  
+0001b1d0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b1e0: 7445 7175 616c 2869 6e74 6572 6661 6365  tEqual(interface
+0001b1f0: 2e61 6464 7265 7373 2c20 6970 6164 6472  .address, ipaddr
+0001b200: 6573 732e 4950 7634 4164 6472 6573 7328  ess.IPv4Address(
+0001b210: 2731 302e 302e 302e 3130 2729 290a 2020  '10.0.0.10')).  
+0001b220: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001b230: 7445 7175 616c 2869 6e74 6572 6661 6365  tEqual(interface
+0001b240: 2e73 7562 6e65 742c 2069 7061 6464 7265  .subnet, ipaddre
+0001b250: 7373 2e49 5076 344e 6574 776f 726b 2827  ss.IPv4Network('
+0001b260: 3130 2e30 2e30 2e30 2f38 2729 290a 0a20  10.0.0.0/8')).. 
+0001b270: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
+0001b280: 6e65 7477 6f72 6b5f 7370 6563 6966 6963  network_specific
+0001b290: 5f65 6e64 706f 696e 7428 7365 6c66 293a  _endpoint(self):
+0001b2a0: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
+0001b2b0: 726e 6573 732e 6164 645f 6e65 7477 6f72  rness.add_networ
+0001b2c0: 6b28 2731 302e 302e 302e 3127 290a 2020  k('10.0.0.1').  
+0001b2d0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0001b2e0: 7373 2e61 6464 5f6e 6574 776f 726b 2827  ss.add_network('
+0001b2f0: 3130 2e30 2e32 2e31 272c 2065 6e64 706f  10.0.2.1', endpo
+0001b300: 696e 743d 2764 6227 290a 0a20 2020 2020  int='db')..     
+0001b310: 2020 2062 696e 6469 6e67 203d 2073 656c     binding = sel
+0001b320: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
+0001b330: 6765 745f 6269 6e64 696e 6728 2764 6227  get_binding('db'
+0001b340: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001b350: 7373 6572 7445 7175 616c 2862 696e 6469  ssertEqual(bindi
+0001b360: 6e67 2e6e 616d 652c 2027 6462 2729 0a20  ng.name, 'db'). 
+0001b370: 2020 2020 2020 206e 6574 776f 726b 203d         network =
+0001b380: 2062 696e 6469 6e67 2e6e 6574 776f 726b   binding.network
+0001b390: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001b3a0: 7365 7274 4571 7561 6c28 6e65 7477 6f72  sertEqual(networ
+0001b3b0: 6b2e 6269 6e64 5f61 6464 7265 7373 2c20  k.bind_address, 
+0001b3c0: 6970 6164 6472 6573 732e 4950 7634 4164  ipaddress.IPv4Ad
+0001b3d0: 6472 6573 7328 2731 302e 302e 322e 3127  dress('10.0.2.1'
+0001b3e0: 2929 0a0a 2020 2020 2020 2020 2320 456e  ))..        # En
+0001b3f0: 7375 7265 2062 696e 6469 6e67 2066 6f72  sure binding for
+0001b400: 2074 6865 206f 7468 6572 2069 6e74 6572   the other inter
+0001b410: 6661 6365 2069 7320 7374 696c 6c20 6f6e  face is still on
+0001b420: 2074 6865 2064 6566 6175 6c74 2076 616c   the default val
+0001b430: 7565 0a20 2020 2020 2020 2073 656c 662e  ue.        self.
+0001b440: 6173 7365 7274 4571 7561 6c28 7365 6c66  assertEqual(self
+0001b450: 2e68 6172 6e65 7373 2e6d 6f64 656c 2e67  .harness.model.g
+0001b460: 6574 5f62 696e 6469 6e67 2827 666f 6f27  et_binding('foo'
+0001b470: 292e 6e65 7477 6f72 6b2e 6269 6e64 5f61  ).network.bind_a
+0001b480: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
+0001b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4a0: 2069 7061 6464 7265 7373 2e49 5076 3441   ipaddress.IPv4A
+0001b4b0: 6464 7265 7373 2827 3130 2e30 2e30 2e31  ddress('10.0.0.1
+0001b4c0: 2729 290a 0a20 2020 2064 6566 2074 6573  '))..    def tes
+0001b4d0: 745f 6164 645f 6e65 7477 6f72 6b5f 7370  t_add_network_sp
+0001b4e0: 6563 6966 6963 5f72 656c 6174 696f 6e28  ecific_relation(
+0001b4f0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0001b500: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+0001b510: 6e65 7477 6f72 6b28 2731 302e 302e 302e  network('10.0.0.
+0001b520: 3127 290a 2020 2020 2020 2020 7365 6c66  1').        self
+0001b530: 2e68 6172 6e65 7373 2e61 6464 5f6e 6574  .harness.add_net
+0001b540: 776f 726b 2827 3130 2e30 2e32 2e31 272c  work('10.0.2.1',
+0001b550: 2065 6e64 706f 696e 743d 2764 6227 290a   endpoint='db').
+0001b560: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
+0001b570: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
+0001b580: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+0001b590: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
+0001b5a0: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+0001b5b0: 2e68 6172 6e65 7373 2e61 6464 5f6e 6574  .harness.add_net
+0001b5c0: 776f 726b 2827 3335 2e30 2e30 2e31 272c  work('35.0.0.1',
+0001b5d0: 2065 6e64 706f 696e 743d 2764 6227 2c20   endpoint='db', 
+0001b5e0: 7265 6c61 7469 6f6e 5f69 643d 7265 6c61  relation_id=rela
+0001b5f0: 7469 6f6e 5f69 6429 0a0a 2020 2020 2020  tion_id)..      
+0001b600: 2020 7265 6c61 7469 6f6e 203d 2073 656c    relation = sel
+0001b610: 662e 6861 726e 6573 732e 6d6f 6465 6c2e  f.harness.model.
+0001b620: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+0001b630: 272c 2072 656c 6174 696f 6e5f 6964 290a  ', relation_id).
+0001b640: 2020 2020 2020 2020 6269 6e64 696e 6720          binding 
+0001b650: 3d20 7365 6c66 2e68 6172 6e65 7373 2e6d  = self.harness.m
+0001b660: 6f64 656c 2e67 6574 5f62 696e 6469 6e67  odel.get_binding
+0001b670: 2872 656c 6174 696f 6e29 0a20 2020 2020  (relation).     
+0001b680: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001b690: 7561 6c28 6269 6e64 696e 672e 6e61 6d65  ual(binding.name
+0001b6a0: 2c20 2764 6227 290a 2020 2020 2020 2020  , 'db').        
+0001b6b0: 6e65 7477 6f72 6b20 3d20 6269 6e64 696e  network = bindin
+0001b6c0: 672e 6e65 7477 6f72 6b0a 2020 2020 2020  g.network.      
+0001b6d0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001b6e0: 616c 286e 6574 776f 726b 2e62 696e 645f  al(network.bind_
+0001b6f0: 6164 6472 6573 732c 2069 7061 6464 7265  address, ipaddre
+0001b700: 7373 2e49 5076 3441 6464 7265 7373 2827  ss.IPv4Address('
+0001b710: 3335 2e30 2e30 2e31 2729 290a 0a20 2020  35.0.0.1'))..   
+0001b720: 2020 2020 2023 2045 6e73 7572 6520 6269       # Ensure bi
+0001b730: 6e64 696e 6720 666f 7220 7468 6520 6f74  nding for the ot
+0001b740: 6865 7220 696e 7465 7266 6163 6520 6973  her interface is
+0001b750: 2073 7469 6c6c 206f 6e20 7468 6520 6465   still on the de
+0001b760: 6661 756c 7420 7661 6c75 650a 2020 2020  fault value.    
+0001b770: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001b780: 7175 616c 2873 656c 662e 6861 726e 6573  qual(self.harnes
+0001b790: 732e 6d6f 6465 6c2e 6765 745f 6269 6e64  s.model.get_bind
+0001b7a0: 696e 6728 2766 6f6f 2729 2e6e 6574 776f  ing('foo').netwo
+0001b7b0: 726b 2e62 696e 645f 6164 6472 6573 732c  rk.bind_address,
+0001b7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b7d0: 2020 2020 2020 2020 2020 6970 6164 6472            ipaddr
+0001b7e0: 6573 732e 4950 7634 4164 6472 6573 7328  ess.IPv4Address(
+0001b7f0: 2731 302e 302e 302e 3127 2929 0a0a 2020  '10.0.0.1'))..  
+0001b800: 2020 6465 6620 7465 7374 5f61 6464 5f6e    def test_add_n
+0001b810: 6574 776f 726b 5f65 6e64 706f 696e 745f  etwork_endpoint_
+0001b820: 6661 6c6c 6261 636b 2873 656c 6629 3a0a  fallback(self):.
+0001b830: 2020 2020 2020 2020 7265 6c61 7469 6f6e          relation
+0001b840: 5f69 6420 3d20 7365 6c66 2e68 6172 6e65  _id = self.harne
+0001b850: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+0001b860: 2764 6227 2c20 2770 6f73 7467 7265 7371  'db', 'postgresq
+0001b870: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+0001b880: 2e68 6172 6e65 7373 2e61 6464 5f6e 6574  .harness.add_net
+0001b890: 776f 726b 2827 3130 2e30 2e30 2e31 3027  work('10.0.0.10'
+0001b8a0: 2c20 656e 6470 6f69 6e74 3d27 6462 2729  , endpoint='db')
+0001b8b0: 0a0a 2020 2020 2020 2020 7265 6c61 7469  ..        relati
+0001b8c0: 6f6e 203d 2073 656c 662e 6861 726e 6573  on = self.harnes
+0001b8d0: 732e 6d6f 6465 6c2e 6765 745f 7265 6c61  s.model.get_rela
+0001b8e0: 7469 6f6e 2827 6462 272c 2072 656c 6174  tion('db', relat
+0001b8f0: 696f 6e5f 6964 290a 2020 2020 2020 2020  ion_id).        
+0001b900: 6269 6e64 696e 6720 3d20 7365 6c66 2e68  binding = self.h
+0001b910: 6172 6e65 7373 2e6d 6f64 656c 2e67 6574  arness.model.get
+0001b920: 5f62 696e 6469 6e67 2872 656c 6174 696f  _binding(relatio
+0001b930: 6e29 0a20 2020 2020 2020 2073 656c 662e  n).        self.
+0001b940: 6173 7365 7274 4571 7561 6c28 6269 6e64  assertEqual(bind
+0001b950: 696e 672e 6e61 6d65 2c20 2764 6227 290a  ing.name, 'db').
+0001b960: 2020 2020 2020 2020 6e65 7477 6f72 6b20          network 
+0001b970: 3d20 6269 6e64 696e 672e 6e65 7477 6f72  = binding.networ
+0001b980: 6b0a 2020 2020 2020 2020 7365 6c66 2e61  k.        self.a
+0001b990: 7373 6572 7445 7175 616c 286e 6574 776f  ssertEqual(netwo
+0001b9a0: 726b 2e62 696e 645f 6164 6472 6573 732c  rk.bind_address,
+0001b9b0: 2069 7061 6464 7265 7373 2e49 5076 3441   ipaddress.IPv4A
+0001b9c0: 6464 7265 7373 2827 3130 2e30 2e30 2e31  ddress('10.0.0.1
+0001b9d0: 3027 2929 0a0a 2020 2020 6465 6620 7465  0'))..    def te
+0001b9e0: 7374 5f61 6464 5f6e 6574 776f 726b 5f64  st_add_network_d
+0001b9f0: 6566 6175 6c74 5f66 616c 6c62 6163 6b28  efault_fallback(
+0001ba00: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0001ba10: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+0001ba20: 6e65 7477 6f72 6b28 2731 302e 302e 302e  network('10.0.0.
+0001ba30: 3130 2729 0a0a 2020 2020 2020 2020 6269  10')..        bi
+0001ba40: 6e64 696e 6720 3d20 7365 6c66 2e68 6172  nding = self.har
+0001ba50: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f62  ness.model.get_b
+0001ba60: 696e 6469 6e67 2827 6462 2729 0a20 2020  inding('db').   
+0001ba70: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001ba80: 4571 7561 6c28 6269 6e64 696e 672e 6e61  Equal(binding.na
+0001ba90: 6d65 2c20 2764 6227 290a 2020 2020 2020  me, 'db').      
+0001baa0: 2020 6e65 7477 6f72 6b20 3d20 6269 6e64    network = bind
+0001bab0: 696e 672e 6e65 7477 6f72 6b0a 2020 2020  ing.network.    
+0001bac0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001bad0: 7175 616c 286e 6574 776f 726b 2e62 696e  qual(network.bin
+0001bae0: 645f 6164 6472 6573 732c 2069 7061 6464  d_address, ipadd
+0001baf0: 7265 7373 2e49 5076 3441 6464 7265 7373  ress.IPv4Address
+0001bb00: 2827 3130 2e30 2e30 2e31 3027 2929 0a0a  ('10.0.0.10'))..
+0001bb10: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+0001bb20: 5f6e 6574 776f 726b 5f69 7076 3628 7365  _network_ipv6(se
+0001bb30: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+0001bb40: 662e 6861 726e 6573 732e 6164 645f 6e65  f.harness.add_ne
+0001bb50: 7477 6f72 6b28 2732 3030 313a 3064 6238  twork('2001:0db8
+0001bb60: 3a3a 613a 303a 303a 3127 290a 0a20 2020  ::a:0:0:1')..   
+0001bb70: 2020 2020 2062 696e 6469 6e67 203d 2073       binding = s
+0001bb80: 656c 662e 6861 726e 6573 732e 6d6f 6465  elf.harness.mode
+0001bb90: 6c2e 6765 745f 6269 6e64 696e 6728 2764  l.get_binding('d
+0001bba0: 6227 290a 2020 2020 2020 2020 7365 6c66  b').        self
+0001bbb0: 2e61 7373 6572 7445 7175 616c 2862 696e  .assertEqual(bin
+0001bbc0: 6469 6e67 2e6e 616d 652c 2027 6462 2729  ding.name, 'db')
+0001bbd0: 0a20 2020 2020 2020 206e 6574 776f 726b  .        network
+0001bbe0: 203d 2062 696e 6469 6e67 2e6e 6574 776f   = binding.netwo
+0001bbf0: 726b 0a20 2020 2020 2020 2073 656c 662e  rk.        self.
+0001bc00: 6173 7365 7274 4571 7561 6c28 6e65 7477  assertEqual(netw
+0001bc10: 6f72 6b2e 6269 6e64 5f61 6464 7265 7373  ork.bind_address
+0001bc20: 2c20 6970 6164 6472 6573 732e 4950 7636  , ipaddress.IPv6
+0001bc30: 4164 6472 6573 7328 2732 3030 313a 3064  Address('2001:0d
+0001bc40: 6238 3a3a 613a 303a 303a 3127 2929 0a20  b8::a:0:0:1')). 
+0001bc50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001bc60: 7274 4571 7561 6c28 6e65 7477 6f72 6b2e  rtEqual(network.
+0001bc70: 696e 6772 6573 735f 6164 6472 6573 732c  ingress_address,
+0001bc80: 2069 7061 6464 7265 7373 2e49 5076 3641   ipaddress.IPv6A
+0001bc90: 6464 7265 7373 2827 3230 3031 3a30 6462  ddress('2001:0db
+0001bca0: 383a 3a61 3a30 3a30 3a31 2729 290a 2020  8::a:0:0:1')).  
+0001bcb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001bcc0: 7445 7175 616c 286e 6574 776f 726b 2e69  tEqual(network.i
+0001bcd0: 6e67 7265 7373 5f61 6464 7265 7373 6573  ngress_addresses
+0001bce0: 2c20 5b69 7061 6464 7265 7373 2e49 5076  , [ipaddress.IPv
+0001bcf0: 3641 6464 7265 7373 2827 3230 3031 3a30  6Address('2001:0
+0001bd00: 6462 383a 3a61 3a30 3a30 3a31 2729 5d29  db8::a:0:0:1')])
+0001bd10: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001bd20: 7365 7274 4571 7561 6c28 6e65 7477 6f72  sertEqual(networ
+0001bd30: 6b2e 6567 7265 7373 5f73 7562 6e65 7473  k.egress_subnets
+0001bd40: 2c20 5b69 7061 6464 7265 7373 2e49 5076  , [ipaddress.IPv
+0001bd50: 364e 6574 776f 726b 2827 3230 3031 3a30  6Network('2001:0
+0001bd60: 6462 383a 3a30 3a30 3a30 3a30 2f36 3427  db8::0:0:0:0/64'
+0001bd70: 295d 290a 2020 2020 2020 2020 7365 6c66  )]).        self
+0001bd80: 2e61 7373 6572 7445 7175 616c 286c 656e  .assertEqual(len
+0001bd90: 286e 6574 776f 726b 2e69 6e74 6572 6661  (network.interfa
+0001bda0: 6365 7329 2c20 3129 0a20 2020 2020 2020  ces), 1).       
+0001bdb0: 2069 6e74 6572 6661 6365 203d 206e 6574   interface = net
+0001bdc0: 776f 726b 2e69 6e74 6572 6661 6365 735b  work.interfaces[
+0001bdd0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+0001bde0: 6173 7365 7274 4571 7561 6c28 696e 7465  assertEqual(inte
+0001bdf0: 7266 6163 652e 6e61 6d65 2c20 2765 7468  rface.name, 'eth
+0001be00: 3027 290a 2020 2020 2020 2020 7365 6c66  0').        self
+0001be10: 2e61 7373 6572 7445 7175 616c 2869 6e74  .assertEqual(int
+0001be20: 6572 6661 6365 2e61 6464 7265 7373 2c20  erface.address, 
+0001be30: 6970 6164 6472 6573 732e 4950 7636 4164  ipaddress.IPv6Ad
+0001be40: 6472 6573 7328 2732 3030 313a 3064 6238  dress('2001:0db8
+0001be50: 3a3a 613a 303a 303a 3127 2929 0a20 2020  ::a:0:0:1')).   
+0001be60: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001be70: 4571 7561 6c28 696e 7465 7266 6163 652e  Equal(interface.
+0001be80: 7375 626e 6574 2c20 6970 6164 6472 6573  subnet, ipaddres
+0001be90: 732e 4950 7636 4e65 7477 6f72 6b28 2732  s.IPv6Network('2
+0001bea0: 3030 313a 3064 6238 3a3a 303a 303a 303a  001:0db8::0:0:0:
+0001beb0: 302f 3634 2729 290a 0a20 2020 2064 6566  0/64'))..    def
+0001bec0: 2074 6573 745f 6e65 7477 6f72 6b5f 6765   test_network_ge
+0001bed0: 745f 7265 6c61 7469 6f6e 5f6e 6f74 5f66  t_relation_not_f
+0001bee0: 6f75 6e64 2873 656c 6629 3a0a 2020 2020  ound(self):.    
+0001bef0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0001bf00: 7365 7274 5261 6973 6573 286f 7073 2e52  sertRaises(ops.R
+0001bf10: 656c 6174 696f 6e4e 6f74 466f 756e 6445  elationNotFoundE
+0001bf20: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0001bf30: 2020 2073 656c 662e 6861 726e 6573 732e     self.harness.
+0001bf40: 6d6f 6465 6c2e 6765 745f 6269 6e64 696e  model.get_bindin
+0001bf50: 6728 2764 6227 292e 6e65 7477 6f72 6b0a  g('db').network.
+0001bf60: 0a20 2020 2064 6566 2074 6573 745f 6164  .    def test_ad
+0001bf70: 645f 6e65 7477 6f72 6b5f 656e 6470 6f69  d_network_endpoi
+0001bf80: 6e74 5f6e 6f74 5f69 6e5f 6d65 7461 2873  nt_not_in_meta(s
+0001bf90: 656c 6629 3a0a 2020 2020 2020 2020 7769  elf):.        wi
+0001bfa0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0001bfb0: 6973 6573 286f 7073 2e4d 6f64 656c 4572  ises(ops.ModelEr
+0001bfc0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0001bfd0: 2020 7365 6c66 2e68 6172 6e65 7373 2e61    self.harness.a
+0001bfe0: 6464 5f6e 6574 776f 726b 2827 3335 2e30  dd_network('35.0
+0001bff0: 2e30 2e31 272c 2065 6e64 706f 696e 743d  .0.1', endpoint=
+0001c000: 2778 797a 2729 0a0a 2020 2020 6465 6620  'xyz')..    def 
+0001c010: 7465 7374 5f61 6464 5f6e 6574 776f 726b  test_add_network
+0001c020: 5f72 656c 6174 696f 6e5f 6964 5f73 6574  _relation_id_set
+0001c030: 5f65 6e64 706f 696e 745f 6e6f 745f 7365  _endpoint_not_se
+0001c040: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+0001c050: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
+0001c060: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+0001c070: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+0001c080: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
+0001c090: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0001c0a0: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+0001c0b0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0001c0c0: 2020 2020 7365 6c66 2e68 6172 6e65 7373      self.harness
+0001c0d0: 2e61 6464 5f6e 6574 776f 726b 2827 3335  .add_network('35
+0001c0e0: 2e30 2e30 2e31 272c 2072 656c 6174 696f  .0.0.1', relatio
+0001c0f0: 6e5f 6964 3d72 656c 6174 696f 6e5f 6964  n_id=relation_id
+0001c100: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001c110: 6164 645f 6e65 7477 6f72 6b5f 7265 6c61  add_network_rela
+0001c120: 7469 6f6e 5f69 645f 696e 636f 7272 6563  tion_id_incorrec
+0001c130: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+0001c140: 2072 656c 6174 696f 6e5f 6964 203d 2073   relation_id = s
+0001c150: 656c 662e 6861 726e 6573 732e 6164 645f  elf.harness.add_
+0001c160: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+0001c170: 706f 7374 6772 6573 716c 2729 0a20 2020  postgresql').   
+0001c180: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+0001c190: 7373 6572 7452 6169 7365 7328 6f70 732e  ssertRaises(ops.
+0001c1a0: 4d6f 6465 6c45 7272 6f72 293a 0a20 2020  ModelError):.   
+0001c1b0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+0001c1c0: 726e 6573 732e 6164 645f 6e65 7477 6f72  rness.add_networ
+0001c1d0: 6b28 2733 352e 302e 302e 3127 2c20 656e  k('35.0.0.1', en
+0001c1e0: 6470 6f69 6e74 3d27 6462 272c 2072 656c  dpoint='db', rel
+0001c1f0: 6174 696f 6e5f 6964 3d72 656c 6174 696f  ation_id=relatio
+0001c200: 6e5f 6964 202b 2031 290a 0a20 2020 2064  n_id + 1)..    d
+0001c210: 6566 2074 6573 745f 6164 645f 6e65 7477  ef test_add_netw
+0001c220: 6f72 6b5f 656e 6470 6f69 6e74 5f61 6e64  ork_endpoint_and
+0001c230: 5f72 656c 6174 696f 6e5f 6964 5f64 6f5f  _relation_id_do_
+0001c240: 6e6f 745f 636f 7272 6573 706f 6e64 2873  not_correspond(s
+0001c250: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0001c260: 6c61 7469 6f6e 5f69 6420 3d20 7365 6c66  lation_id = self
+0001c270: 2e68 6172 6e65 7373 2e61 6464 5f72 656c  .harness.add_rel
+0001c280: 6174 696f 6e28 2764 6227 2c20 2770 6f73  ation('db', 'pos
+0001c290: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
+0001c2a0: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+0001c2b0: 7274 5261 6973 6573 286f 7073 2e4d 6f64  rtRaises(ops.Mod
+0001c2c0: 656c 4572 726f 7229 3a0a 2020 2020 2020  elError):.      
+0001c2d0: 2020 2020 2020 7365 6c66 2e68 6172 6e65        self.harne
+0001c2e0: 7373 2e61 6464 5f6e 6574 776f 726b 2827  ss.add_network('
+0001c2f0: 3335 2e30 2e30 2e31 272c 2065 6e64 706f  35.0.0.1', endpo
+0001c300: 696e 743d 2766 6f6f 272c 2072 656c 6174  int='foo', relat
+0001c310: 696f 6e5f 6964 3d72 656c 6174 696f 6e5f  ion_id=relation_
+0001c320: 6964 290a 0a0a 636c 6173 7320 4442 5265  id)...class DBRe
+0001c330: 6c61 7469 6f6e 4368 616e 6765 6448 656c  lationChangedHel
+0001c340: 7065 7228 6f70 732e 4f62 6a65 6374 293a  per(ops.Object):
+0001c350: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0001c360: 5f28 7365 6c66 2c20 7061 7265 6e74 2c20  _(self, parent, 
+0001c370: 6b65 7929 3a0a 2020 2020 2020 2020 7375  key):.        su
+0001c380: 7065 7228 292e 5f5f 696e 6974 5f5f 2870  per().__init__(p
+0001c390: 6172 656e 742c 206b 6579 290a 2020 2020  arent, key).    
+0001c3a0: 2020 2020 7365 6c66 2e63 6861 6e67 6573      self.changes
+0001c3b0: 203d 205b 5d0a 2020 2020 2020 2020 7061   = [].        pa
+0001c3c0: 7265 6e74 2e66 7261 6d65 776f 726b 2e6f  rent.framework.o
+0001c3d0: 6273 6572 7665 2870 6172 656e 742e 6f6e  bserve(parent.on
+0001c3e0: 2e64 625f 7265 6c61 7469 6f6e 5f63 6861  .db_relation_cha
+0001c3f0: 6e67 6564 2c20 7365 6c66 2e6f 6e5f 7265  nged, self.on_re
+0001c400: 6c61 7469 6f6e 5f63 6861 6e67 6564 290a  lation_changed).
+0001c410: 0a20 2020 2064 6566 206f 6e5f 7265 6c61  .    def on_rela
+0001c420: 7469 6f6e 5f63 6861 6e67 6564 2873 656c  tion_changed(sel
+0001c430: 662c 2065 7665 6e74 293a 0a20 2020 2020  f, event):.     
+0001c440: 2020 2069 6620 6576 656e 742e 756e 6974     if event.unit
+0001c450: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001c460: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0001c470: 6861 6e67 6573 2e61 7070 656e 6428 2865  hanges.append((e
+0001c480: 7665 6e74 2e72 656c 6174 696f 6e2e 6964  vent.relation.id
+0001c490: 2c20 6576 656e 742e 756e 6974 2e6e 616d  , event.unit.nam
+0001c4a0: 6529 290a 2020 2020 2020 2020 656c 7365  e)).        else
+0001c4b0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001c4c0: 6c66 2e63 6861 6e67 6573 2e61 7070 656e  lf.changes.appen
+0001c4d0: 6428 2865 7665 6e74 2e72 656c 6174 696f  d((event.relatio
+0001c4e0: 6e2e 6964 2c20 6576 656e 742e 6170 702e  n.id, event.app.
+0001c4f0: 6e61 6d65 2929 0a0a 0a63 6c61 7373 2052  name))...class R
+0001c500: 656c 6174 696f 6e43 6861 6e67 6564 5669  elationChangedVi
+0001c510: 6577 6572 286f 7073 2e4f 626a 6563 7429  ewer(ops.Object)
+0001c520: 3a0a 2020 2020 2222 2254 7261 636b 2072  :.    """Track r
+0001c530: 656c 6174 696f 6e5f 6368 616e 6765 6420  elation_changed 
+0001c540: 6576 656e 7473 2061 6e64 2073 6176 6573  events and saves
+0001c550: 2074 6865 2064 6174 6120 7365 656e 2069   the data seen i
+0001c560: 6e20 7468 6520 7265 6c61 7469 6f6e 2062  n the relation b
+0001c570: 7563 6b65 742e 2222 220a 0a20 2020 2064  ucket."""..    d
+0001c580: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+0001c590: 2c20 6368 6172 6d2c 2072 656c 6174 696f  , charm, relatio
+0001c5a0: 6e5f 6e61 6d65 293a 0a20 2020 2020 2020  n_name):.       
+0001c5b0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+0001c5c0: 5f28 6368 6172 6d2c 2072 656c 6174 696f  _(charm, relatio
+0001c5d0: 6e5f 6e61 6d65 290a 2020 2020 2020 2020  n_name).        
+0001c5e0: 7365 6c66 2e63 6861 6e67 6573 203d 205b  self.changes = [
+0001c5f0: 5d0a 2020 2020 2020 2020 6368 6172 6d2e  ].        charm.
+0001c600: 6672 616d 6577 6f72 6b2e 6f62 7365 7276  framework.observ
+0001c610: 6528 6368 6172 6d2e 6f6e 5b72 656c 6174  e(charm.on[relat
+0001c620: 696f 6e5f 6e61 6d65 5d2e 7265 6c61 7469  ion_name].relati
+0001c630: 6f6e 5f63 6861 6e67 6564 2c20 7365 6c66  on_changed, self
+0001c640: 2e6f 6e5f 7265 6c61 7469 6f6e 5f63 6861  .on_relation_cha
+0001c650: 6e67 6564 290a 0a20 2020 2064 6566 206f  nged)..    def o
+0001c660: 6e5f 7265 6c61 7469 6f6e 5f63 6861 6e67  n_relation_chang
+0001c670: 6564 2873 656c 662c 2065 7665 6e74 293a  ed(self, event):
+0001c680: 0a20 2020 2020 2020 2069 6620 6576 656e  .        if even
+0001c690: 742e 756e 6974 2069 7320 6e6f 7420 4e6f  t.unit is not No
+0001c6a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001c6b0: 6461 7461 203d 2065 7665 6e74 2e72 656c  data = event.rel
+0001c6c0: 6174 696f 6e2e 6461 7461 5b65 7665 6e74  ation.data[event
+0001c6d0: 2e75 6e69 745d 0a20 2020 2020 2020 2065  .unit].        e
+0001c6e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001c6f0: 2064 6174 6120 3d20 6576 656e 742e 7265   data = event.re
+0001c700: 6c61 7469 6f6e 2e64 6174 615b 6576 656e  lation.data[even
+0001c710: 742e 6170 705d 0a20 2020 2020 2020 2073  t.app].        s
+0001c720: 656c 662e 6368 616e 6765 732e 6170 7065  elf.changes.appe
+0001c730: 6e64 2864 6963 7428 6461 7461 2929 0a0a  nd(dict(data))..
+0001c740: 0a63 6c61 7373 2052 6563 6f72 6469 6e67  .class Recording
+0001c750: 4368 6172 6d28 6f70 732e 4368 6172 6d42  Charm(ops.CharmB
+0001c760: 6173 6529 3a0a 2020 2020 2222 2252 6563  ase):.    """Rec
+0001c770: 6f72 6420 7468 6520 6576 656e 7473 2074  ord the events t
+0001c780: 6861 7420 7765 2073 6565 2c20 616e 6420  hat we see, and 
+0001c790: 616e 7920 6173 736f 6369 6174 6564 2064  any associated d
+0001c7a0: 6174 612e 2222 220a 0a20 2020 2064 6566  ata."""..    def
+0001c7b0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0001c7c0: 6672 616d 6577 6f72 6b29 3a0a 2020 2020  framework):.    
+0001c7d0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+0001c7e0: 6974 5f5f 2866 7261 6d65 776f 726b 290a  it__(framework).
+0001c7f0: 2020 2020 2020 2020 7365 6c66 2e63 6861          self.cha
+0001c800: 6e67 6573 203d 205b 5d0a 2020 2020 2020  nges = [].      
+0001c810: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
+0001c820: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
+0001c830: 2e63 6f6e 6669 675f 6368 616e 6765 642c  .config_changed,
+0001c840: 2073 656c 662e 5f6f 6e5f 636f 6e66 6967   self._on_config
+0001c850: 5f63 6861 6e67 6564 290a 2020 2020 2020  _changed).      
+0001c860: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
+0001c870: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
+0001c880: 2e6c 6561 6465 725f 656c 6563 7465 642c  .leader_elected,
+0001c890: 2073 656c 662e 5f6f 6e5f 6c65 6164 6572   self._on_leader
+0001c8a0: 5f65 6c65 6374 6564 290a 2020 2020 2020  _elected).      
+0001c8b0: 2020 7365 6c66 2e66 7261 6d65 776f 726b    self.framework
+0001c8c0: 2e6f 6273 6572 7665 2873 656c 662e 6f6e  .observe(self.on
+0001c8d0: 2e6c 6561 6465 725f 7365 7474 696e 6773  .leader_settings
+0001c8e0: 5f63 6861 6e67 6564 2c20 7365 6c66 2e5f  _changed, self._
+0001c8f0: 6f6e 5f6c 6561 6465 725f 7365 7474 696e  on_leader_settin
+0001c900: 6773 5f63 6861 6e67 6564 290a 2020 2020  gs_changed).    
+0001c910: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
+0001c920: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
+0001c930: 6f6e 2e69 6e73 7461 6c6c 2c20 7365 6c66  on.install, self
+0001c940: 2e5f 6f6e 5f69 6e73 7461 6c6c 290a 2020  ._on_install).  
+0001c950: 2020 2020 2020 7365 6c66 2e66 7261 6d65        self.frame
+0001c960: 776f 726b 2e6f 6273 6572 7665 2873 656c  work.observe(sel
+0001c970: 662e 6f6e 2e73 7461 7274 2c20 7365 6c66  f.on.start, self
+0001c980: 2e5f 6f6e 5f73 7461 7274 290a 2020 2020  ._on_start).    
+0001c990: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
+0001c9a0: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
+0001c9b0: 6f6e 2e73 746f 702c 2073 656c 662e 5f6f  on.stop, self._o
+0001c9c0: 6e5f 7374 6f70 290a 2020 2020 2020 2020  n_stop).        
+0001c9d0: 7365 6c66 2e66 7261 6d65 776f 726b 2e6f  self.framework.o
+0001c9e0: 6273 6572 7665 2873 656c 662e 6f6e 2e72  bserve(self.on.r
+0001c9f0: 656d 6f76 652c 2073 656c 662e 5f6f 6e5f  emove, self._on_
+0001ca00: 7265 6d6f 7665 290a 2020 2020 2020 2020  remove).        
+0001ca10: 7365 6c66 2e66 7261 6d65 776f 726b 2e6f  self.framework.o
+0001ca20: 6273 6572 7665 2873 656c 662e 6f6e 2e75  bserve(self.on.u
+0001ca30: 7067 7261 6465 5f63 6861 726d 2c20 7365  pgrade_charm, se
+0001ca40: 6c66 2e5f 6f6e 5f75 7067 7261 6465 5f63  lf._on_upgrade_c
+0001ca50: 6861 726d 290a 2020 2020 2020 2020 7365  harm).        se
+0001ca60: 6c66 2e66 7261 6d65 776f 726b 2e6f 6273  lf.framework.obs
+0001ca70: 6572 7665 2873 656c 662e 6f6e 2e75 7064  erve(self.on.upd
+0001ca80: 6174 655f 7374 6174 7573 2c20 7365 6c66  ate_status, self
+0001ca90: 2e5f 6f6e 5f75 7064 6174 655f 7374 6174  ._on_update_stat
+0001caa0: 7573 290a 0a20 2020 2064 6566 2067 6574  us)..    def get
+0001cab0: 5f63 6861 6e67 6573 2873 656c 662c 2072  _changes(self, r
+0001cac0: 6573 6574 3d54 7275 6529 3a0a 2020 2020  eset=True):.    
+0001cad0: 2020 2020 6368 616e 6765 7320 3d20 7365      changes = se
+0001cae0: 6c66 2e63 6861 6e67 6573 0a20 2020 2020  lf.changes.     
+0001caf0: 2020 2069 6620 7265 7365 743a 0a20 2020     if reset:.   
+0001cb00: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
+0001cb10: 616e 6765 7320 3d20 5b5d 0a20 2020 2020  anges = [].     
+0001cb20: 2020 2072 6574 7572 6e20 6368 616e 6765     return change
+0001cb30: 730a 0a20 2020 2064 6566 205f 6f6e 5f69  s..    def _on_i
+0001cb40: 6e73 7461 6c6c 2873 656c 662c 205f 293a  nstall(self, _):
+0001cb50: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001cb60: 2e63 6f6e 6669 672e 6765 7428 2773 6574  .config.get('set
+0001cb70: 5f73 7461 7475 7327 293a 0a20 2020 2020  _status'):.     
+0001cb80: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
+0001cb90: 2e73 7461 7475 7320 3d20 6f70 732e 4d61  .status = ops.Ma
+0001cba0: 696e 7465 6e61 6e63 6553 7461 7475 7328  intenanceStatus(
+0001cbb0: 2253 7461 7475 7320 7365 7420 6f6e 2069  "Status set on i
+0001cbc0: 6e73 7461 6c6c 2229 0a20 2020 2020 2020  nstall").       
+0001cbd0: 2073 656c 662e 6368 616e 6765 732e 6170   self.changes.ap
+0001cbe0: 7065 6e64 2864 6963 7428 6e61 6d65 3d27  pend(dict(name='
+0001cbf0: 696e 7374 616c 6c27 2929 0a0a 2020 2020  install'))..    
+0001cc00: 6465 6620 5f6f 6e5f 7374 6172 7428 7365  def _on_start(se
+0001cc10: 6c66 2c20 5f29 3a0a 2020 2020 2020 2020  lf, _):.        
+0001cc20: 7365 6c66 2e63 6861 6e67 6573 2e61 7070  self.changes.app
+0001cc30: 656e 6428 6469 6374 286e 616d 653d 2773  end(dict(name='s
+0001cc40: 7461 7274 2729 290a 0a20 2020 2064 6566  tart'))..    def
+0001cc50: 205f 6f6e 5f73 746f 7028 7365 6c66 2c20   _on_stop(self, 
+0001cc60: 5f29 3a0a 2020 2020 2020 2020 7365 6c66  _):.        self
+0001cc70: 2e63 6861 6e67 6573 2e61 7070 656e 6428  .changes.append(
+0001cc80: 6469 6374 286e 616d 653d 2773 746f 7027  dict(name='stop'
+0001cc90: 2929 0a0a 2020 2020 6465 6620 5f6f 6e5f  ))..    def _on_
+0001cca0: 7265 6d6f 7665 2873 656c 662c 205f 293a  remove(self, _):
+0001ccb0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+0001ccc0: 616e 6765 732e 6170 7065 6e64 2864 6963  anges.append(dic
+0001ccd0: 7428 6e61 6d65 3d27 7265 6d6f 7665 2729  t(name='remove')
+0001cce0: 290a 0a20 2020 2064 6566 205f 6f6e 5f63  )..    def _on_c
+0001ccf0: 6f6e 6669 675f 6368 616e 6765 6428 7365  onfig_changed(se
+0001cd00: 6c66 2c20 5f29 3a0a 2020 2020 2020 2020  lf, _):.        
+0001cd10: 7365 6c66 2e63 6861 6e67 6573 2e61 7070  self.changes.app
+0001cd20: 656e 6428 6469 6374 286e 616d 653d 2763  end(dict(name='c
+0001cd30: 6f6e 6669 672d 6368 616e 6765 6427 2c20  onfig-changed', 
+0001cd40: 6461 7461 3d64 6963 7428 7365 6c66 2e66  data=dict(self.f
+0001cd50: 7261 6d65 776f 726b 2e6d 6f64 656c 2e63  ramework.model.c
+0001cd60: 6f6e 6669 6729 2929 0a0a 2020 2020 6465  onfig)))..    de
+0001cd70: 6620 5f6f 6e5f 6c65 6164 6572 5f65 6c65  f _on_leader_ele
+0001cd80: 6374 6564 2873 656c 662c 205f 293a 0a20  cted(self, _):. 
+0001cd90: 2020 2020 2020 2073 656c 662e 6368 616e         self.chan
+0001cda0: 6765 732e 6170 7065 6e64 2864 6963 7428  ges.append(dict(
+0001cdb0: 6e61 6d65 3d27 6c65 6164 6572 2d65 6c65  name='leader-ele
+0001cdc0: 6374 6564 2729 290a 0a20 2020 2064 6566  cted'))..    def
+0001cdd0: 205f 6f6e 5f6c 6561 6465 725f 7365 7474   _on_leader_sett
+0001cde0: 696e 6773 5f63 6861 6e67 6564 2873 656c  ings_changed(sel
+0001cdf0: 662c 205f 293a 0a20 2020 2020 2020 2073  f, _):.        s
+0001ce00: 656c 662e 6368 616e 6765 732e 6170 7065  elf.changes.appe
+0001ce10: 6e64 2864 6963 7428 6e61 6d65 3d27 6c65  nd(dict(name='le
+0001ce20: 6164 6572 2d73 6574 7469 6e67 732d 6368  ader-settings-ch
+0001ce30: 616e 6765 6427 2929 0a0a 2020 2020 6465  anged'))..    de
+0001ce40: 6620 5f6f 6e5f 7570 6772 6164 655f 6368  f _on_upgrade_ch
+0001ce50: 6172 6d28 7365 6c66 2c20 5f29 3a0a 2020  arm(self, _):.  
+0001ce60: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
+0001ce70: 6573 2e61 7070 656e 6428 6469 6374 286e  es.append(dict(n
+0001ce80: 616d 653d 2775 7067 7261 6465 2d63 6861  ame='upgrade-cha
+0001ce90: 726d 2729 290a 0a20 2020 2064 6566 205f  rm'))..    def _
+0001cea0: 6f6e 5f75 7064 6174 655f 7374 6174 7573  on_update_status
+0001ceb0: 2873 656c 662c 205f 293a 0a20 2020 2020  (self, _):.     
+0001cec0: 2020 2073 656c 662e 6368 616e 6765 732e     self.changes.
+0001ced0: 6170 7065 6e64 2864 6963 7428 6e61 6d65  append(dict(name
+0001cee0: 3d27 7570 6461 7465 2d73 7461 7475 7327  ='update-status'
+0001cef0: 2929 0a0a 0a63 6c61 7373 2052 656c 6174  ))...class Relat
+0001cf00: 696f 6e45 7665 6e74 4368 6172 6d28 5265  ionEventCharm(Re
+0001cf10: 636f 7264 696e 6743 6861 726d 293a 0a20  cordingCharm):. 
+0001cf20: 2020 2022 2222 5265 636f 7264 2065 7665     """Record eve
+0001cf30: 6e74 7320 7265 6c61 7465 6420 746f 2072  nts related to r
+0001cf40: 656c 6174 696f 6e20 6c69 6665 6379 636c  elation lifecycl
+0001cf50: 6573 2e22 2222 0a0a 2020 2020 6465 6620  es."""..    def 
+0001cf60: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
+0001cf70: 7261 6d65 776f 726b 293a 0a20 2020 2020  ramework):.     
+0001cf80: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+0001cf90: 745f 5f28 6672 616d 6577 6f72 6b29 0a20  t__(framework). 
+0001cfa0: 2020 2020 2020 2023 2057 6865 6e20 7365         # When se
+0001cfb0: 742c 2074 6869 7320 696e 7374 7275 6374  t, this instruct
+0001cfc0: 7320 7468 6520 6368 6172 6d20 746f 2069  s the charm to i
+0001cfd0: 6e63 6c75 6465 2061 2027 7265 6c61 7469  nclude a 'relati
+0001cfe0: 6f6e 5f64 6174 6127 2066 6965 6c64 2069  on_data' field i
+0001cff0: 6e20 7468 6520 2764 6174 6127 0a20 2020  n the 'data'.   
+0001d000: 2020 2020 2023 2073 6563 7469 6f6e 206f       # section o
+0001d010: 6620 6561 6368 2063 6861 6e67 6520 6974  f each change it
+0001d020: 206c 6f67 732c 2077 6869 6368 2061 6c6c   logs, which all
+0001d030: 6f77 7320 7573 2074 6f20 7465 7374 2077  ows us to test w
+0001d040: 6869 6368 2072 656c 6174 696f 6e20 6461  hich relation da
+0001d050: 7461 2077 6173 2061 7661 696c 6162 6c65  ta was available
+0001d060: 0a20 2020 2020 2020 2023 2069 6e20 6561  .        # in ea
+0001d070: 6368 2068 6f6f 6b20 696e 766f 6361 7469  ch hook invocati
+0001d080: 6f6e 0a20 2020 2020 2020 2073 656c 662e  on.        self.
+0001d090: 7265 636f 7264 5f72 656c 6174 696f 6e5f  record_relation_
+0001d0a0: 6461 7461 5f6f 6e5f 6576 656e 7473 203d  data_on_events =
+0001d0b0: 2046 616c 7365 0a0a 2020 2020 6465 6620   False..    def 
+0001d0c0: 6f62 7365 7276 655f 7265 6c61 7469 6f6e  observe_relation
+0001d0d0: 5f65 7665 6e74 7328 7365 6c66 2c20 7265  _events(self, re
+0001d0e0: 6c61 7469 6f6e 5f6e 616d 6529 3a0a 2020  lation_name):.  
+0001d0f0: 2020 2020 2020 7365 6c66 2e72 656c 6174        self.relat
+0001d100: 696f 6e5f 6e61 6d65 203d 2072 656c 6174  ion_name = relat
+0001d110: 696f 6e5f 6e61 6d65 0a20 2020 2020 2020  ion_name.       
+0001d120: 2073 656c 662e 6672 616d 6577 6f72 6b2e   self.framework.
+0001d130: 6f62 7365 7276 6528 7365 6c66 2e6f 6e5b  observe(self.on[
+0001d140: 7265 6c61 7469 6f6e 5f6e 616d 655d 2e72  relation_name].r
+0001d150: 656c 6174 696f 6e5f 6372 6561 7465 642c  elation_created,
+0001d160: 2073 656c 662e 5f6f 6e5f 7265 6c61 7469   self._on_relati
+0001d170: 6f6e 5f63 7265 6174 6564 290a 2020 2020  on_created).    
+0001d180: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
+0001d190: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
+0001d1a0: 6f6e 5b72 656c 6174 696f 6e5f 6e61 6d65  on[relation_name
+0001d1b0: 5d2e 7265 6c61 7469 6f6e 5f6a 6f69 6e65  ].relation_joine
+0001d1c0: 642c 2073 656c 662e 5f6f 6e5f 7265 6c61  d, self._on_rela
+0001d1d0: 7469 6f6e 5f6a 6f69 6e65 6429 0a20 2020  tion_joined).   
+0001d1e0: 2020 2020 2073 656c 662e 6672 616d 6577       self.framew
+0001d1f0: 6f72 6b2e 6f62 7365 7276 6528 7365 6c66  ork.observe(self
+0001d200: 2e6f 6e5b 7265 6c61 7469 6f6e 5f6e 616d  .on[relation_nam
+0001d210: 655d 2e72 656c 6174 696f 6e5f 6368 616e  e].relation_chan
+0001d220: 6765 642c 2073 656c 662e 5f6f 6e5f 7265  ged, self._on_re
+0001d230: 6c61 7469 6f6e 5f63 6861 6e67 6564 290a  lation_changed).
+0001d240: 2020 2020 2020 2020 7365 6c66 2e66 7261          self.fra
+0001d250: 6d65 776f 726b 2e6f 6273 6572 7665 2873  mework.observe(s
+0001d260: 656c 662e 6f6e 5b72 656c 6174 696f 6e5f  elf.on[relation_
+0001d270: 6e61 6d65 5d2e 7265 6c61 7469 6f6e 5f64  name].relation_d
+0001d280: 6570 6172 7465 642c 0a20 2020 2020 2020  eparted,.       
+0001d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2a0: 2020 2020 2020 2020 7365 6c66 2e5f 6f6e          self._on
+0001d2b0: 5f72 656c 6174 696f 6e5f 6465 7061 7274  _relation_depart
+0001d2c0: 6564 290a 2020 2020 2020 2020 7365 6c66  ed).        self
+0001d2d0: 2e66 7261 6d65 776f 726b 2e6f 6273 6572  .framework.obser
+0001d2e0: 7665 2873 656c 662e 6f6e 5b72 656c 6174  ve(self.on[relat
+0001d2f0: 696f 6e5f 6e61 6d65 5d2e 7265 6c61 7469  ion_name].relati
+0001d300: 6f6e 5f62 726f 6b65 6e2c 2073 656c 662e  on_broken, self.
+0001d310: 5f6f 6e5f 7265 6c61 7469 6f6e 5f62 726f  _on_relation_bro
+0001d320: 6b65 6e29 0a0a 2020 2020 6465 6620 5f6f  ken)..    def _o
+0001d330: 6e5f 7265 6c61 7469 6f6e 5f63 7265 6174  n_relation_creat
+0001d340: 6564 2873 656c 662c 2065 7665 6e74 293a  ed(self, event):
+0001d350: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
+0001d360: 6273 6572 7665 5f72 656c 6174 696f 6e5f  bserve_relation_
+0001d370: 6576 656e 7428 2772 656c 6174 696f 6e2d  event('relation-
+0001d380: 6372 6561 7465 6427 2c20 6576 656e 7429  created', event)
+0001d390: 0a0a 2020 2020 6465 6620 5f6f 6e5f 7265  ..    def _on_re
+0001d3a0: 6c61 7469 6f6e 5f6a 6f69 6e65 6428 7365  lation_joined(se
+0001d3b0: 6c66 2c20 6576 656e 7429 3a0a 2020 2020  lf, event):.    
+0001d3c0: 2020 2020 7365 6c66 2e5f 6f62 7365 7276      self._observ
+0001d3d0: 655f 7265 6c61 7469 6f6e 5f65 7665 6e74  e_relation_event
+0001d3e0: 2827 7265 6c61 7469 6f6e 2d6a 6f69 6e65  ('relation-joine
+0001d3f0: 6427 2c20 6576 656e 7429 0a0a 2020 2020  d', event)..    
+0001d400: 6465 6620 5f6f 6e5f 7265 6c61 7469 6f6e  def _on_relation
+0001d410: 5f63 6861 6e67 6564 2873 656c 662c 2065  _changed(self, e
+0001d420: 7665 6e74 293a 0a20 2020 2020 2020 2073  vent):.        s
+0001d430: 656c 662e 5f6f 6273 6572 7665 5f72 656c  elf._observe_rel
+0001d440: 6174 696f 6e5f 6576 656e 7428 2772 656c  ation_event('rel
+0001d450: 6174 696f 6e2d 6368 616e 6765 6427 2c20  ation-changed', 
+0001d460: 6576 656e 7429 0a0a 2020 2020 6465 6620  event)..    def 
+0001d470: 5f6f 6e5f 7265 6c61 7469 6f6e 5f64 6570  _on_relation_dep
+0001d480: 6172 7465 6428 7365 6c66 2c20 6576 656e  arted(self, even
+0001d490: 7429 3a0a 2020 2020 2020 2020 7365 6c66  t):.        self
+0001d4a0: 2e5f 6f62 7365 7276 655f 7265 6c61 7469  ._observe_relati
+0001d4b0: 6f6e 5f65 7665 6e74 2827 7265 6c61 7469  on_event('relati
+0001d4c0: 6f6e 2d64 6570 6172 7465 6427 2c20 6576  on-departed', ev
+0001d4d0: 656e 7429 0a0a 2020 2020 6465 6620 5f6f  ent)..    def _o
+0001d4e0: 6e5f 7265 6c61 7469 6f6e 5f62 726f 6b65  n_relation_broke
+0001d4f0: 6e28 7365 6c66 2c20 6576 656e 7429 3a0a  n(self, event):.
+0001d500: 2020 2020 2020 2020 7365 6c66 2e5f 6f62          self._ob
+0001d510: 7365 7276 655f 7265 6c61 7469 6f6e 5f65  serve_relation_e
+0001d520: 7665 6e74 2827 7265 6c61 7469 6f6e 2d62  vent('relation-b
+0001d530: 726f 6b65 6e27 2c20 6576 656e 7429 0a0a  roken', event)..
+0001d540: 2020 2020 6465 6620 5f6f 6273 6572 7665      def _observe
+0001d550: 5f72 656c 6174 696f 6e5f 6576 656e 7428  _relation_event(
+0001d560: 7365 6c66 2c20 6576 656e 745f 6e61 6d65  self, event_name
+0001d570: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
+0001d580: 2020 756e 6974 5f6e 616d 6520 3d20 4e6f    unit_name = No
+0001d590: 6e65 0a20 2020 2020 2020 2069 6620 6576  ne.        if ev
+0001d5a0: 656e 742e 756e 6974 2069 7320 6e6f 7420  ent.unit is not 
+0001d5b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001d5c0: 2020 756e 6974 5f6e 616d 6520 3d20 6576    unit_name = ev
+0001d5d0: 656e 742e 756e 6974 2e6e 616d 650a 2020  ent.unit.name.  
+0001d5e0: 2020 2020 2020 6170 705f 6e61 6d65 203d        app_name =
+0001d5f0: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
+0001d600: 2065 7665 6e74 2e61 7070 2069 7320 6e6f   event.app is no
+0001d610: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001d620: 2020 2020 6170 705f 6e61 6d65 203d 2065      app_name = e
+0001d630: 7665 6e74 2e61 7070 2e6e 616d 650a 0a20  vent.app.name.. 
+0001d640: 2020 2020 2020 2064 6174 6120 3d20 6469         data = di
+0001d650: 6374 2861 7070 3d61 7070 5f6e 616d 652c  ct(app=app_name,
+0001d660: 2075 6e69 743d 756e 6974 5f6e 616d 652c   unit=unit_name,
+0001d670: 2072 656c 6174 696f 6e5f 6964 3d65 7665   relation_id=eve
+0001d680: 6e74 2e72 656c 6174 696f 6e2e 6964 290a  nt.relation.id).
+0001d690: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001d6a0: 7461 6e63 6528 6576 656e 742c 206f 7073  tance(event, ops
+0001d6b0: 2e52 656c 6174 696f 6e44 6570 6172 7465  .RelationDeparte
+0001d6c0: 6445 7665 6e74 293a 0a20 2020 2020 2020  dEvent):.       
+0001d6d0: 2020 2020 2064 6174 615b 2764 6570 6172       data['depar
+0001d6e0: 7469 6e67 5f75 6e69 7427 5d20 3d20 6576  ting_unit'] = ev
+0001d6f0: 656e 742e 6465 7061 7274 696e 675f 756e  ent.departing_un
+0001d700: 6974 2e6e 616d 650a 0a20 2020 2020 2020  it.name..       
+0001d710: 2072 6563 6f72 6469 6e67 203d 2064 6963   recording = dic
+0001d720: 7428 6e61 6d65 3d65 7665 6e74 5f6e 616d  t(name=event_nam
+0001d730: 652c 2072 656c 6174 696f 6e3d 6576 656e  e, relation=even
+0001d740: 742e 7265 6c61 7469 6f6e 2e6e 616d 652c  t.relation.name,
+0001d750: 2064 6174 613d 6461 7461 290a 0a20 2020   data=data)..   
+0001d760: 2020 2020 2069 6620 7365 6c66 2e72 6563       if self.rec
+0001d770: 6f72 645f 7265 6c61 7469 6f6e 5f64 6174  ord_relation_dat
+0001d780: 615f 6f6e 5f65 7665 6e74 733a 0a20 2020  a_on_events:.   
+0001d790: 2020 2020 2020 2020 2072 6563 6f72 6469           recordi
+0001d7a0: 6e67 5b22 6461 7461 225d 2e75 7064 6174  ng["data"].updat
+0001d7b0: 6528 7b27 7265 6c61 7469 6f6e 5f64 6174  e({'relation_dat
+0001d7c0: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
+0001d7d0: 2020 2020 2020 7374 7228 782e 6e61 6d65        str(x.name
+0001d7e0: 293a 2064 6963 7428 6576 656e 742e 7265  ): dict(event.re
+0001d7f0: 6c61 7469 6f6e 2e64 6174 615b 785d 290a  lation.data[x]).
+0001d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d810: 666f 7220 7820 696e 2065 7665 6e74 2e72  for x in event.r
+0001d820: 656c 6174 696f 6e2e 6461 7461 0a20 2020  elation.data.   
+0001d830: 2020 2020 2020 2020 207d 7d29 0a0a 2020           }})..  
+0001d840: 2020 2020 2020 7365 6c66 2e63 6861 6e67        self.chang
+0001d850: 6573 2e61 7070 656e 6428 7265 636f 7264  es.append(record
+0001d860: 696e 6729 0a0a 0a63 6c61 7373 2052 656c  ing)...class Rel
+0001d870: 6174 696f 6e42 726f 6b65 6e54 6573 7465  ationBrokenTeste
+0001d880: 7228 5265 6c61 7469 6f6e 4576 656e 7443  r(RelationEventC
+0001d890: 6861 726d 293a 0a20 2020 2022 2222 4163  harm):.    """Ac
+0001d8a0: 6365 7373 2069 6e61 6363 6573 7369 626c  cess inaccessibl
+0001d8b0: 6520 7265 6c61 7469 6f6e 2064 6174 612e  e relation data.
+0001d8c0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+0001d8d0: 6e69 745f 5f28 7365 6c66 2c20 6672 616d  nit__(self, fram
+0001d8e0: 6577 6f72 6b29 3a0a 2020 2020 2020 2020  ework):.        
+0001d8f0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+0001d900: 2866 7261 6d65 776f 726b 290a 0a20 2020  (framework)..   
+0001d910: 2064 6566 205f 6f6e 5f72 656c 6174 696f   def _on_relatio
+0001d920: 6e5f 6272 6f6b 656e 2873 656c 662c 2065  n_broken(self, e
+0001d930: 7665 6e74 293a 0a20 2020 2020 2020 2070  vent):.        p
+0001d940: 7269 6e74 2865 7665 6e74 2e72 656c 6174  rint(event.relat
+0001d950: 696f 6e2e 6461 7461 5b65 7665 6e74 2e72  ion.data[event.r
+0001d960: 656c 6174 696f 6e2e 6170 705d 5b27 6261  elation.app]['ba
+0001d970: 7227 5d29 0a0a 0a63 6c61 7373 2043 6f6e  r'])...class Con
+0001d980: 7461 696e 6572 4576 656e 7443 6861 726d  tainerEventCharm
+0001d990: 2852 6563 6f72 6469 6e67 4368 6172 6d29  (RecordingCharm)
+0001d9a0: 3a0a 2020 2020 2222 2252 6563 6f72 6420  :.    """Record 
+0001d9b0: 6576 656e 7473 2072 656c 6174 6564 2074  events related t
+0001d9c0: 6f20 636f 6e74 6169 6e65 7220 6c69 6665  o container life
+0001d9d0: 6379 636c 6573 2e22 2222 0a0a 2020 2020  cycles."""..    
+0001d9e0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+0001d9f0: 662c 2066 7261 6d65 776f 726b 293a 0a20  f, framework):. 
+0001da00: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+0001da10: 5f69 6e69 745f 5f28 6672 616d 6577 6f72  _init__(framewor
+0001da20: 6b29 0a0a 2020 2020 6465 6620 6f62 7365  k)..    def obse
+0001da30: 7276 655f 636f 6e74 6169 6e65 725f 6576  rve_container_ev
+0001da40: 656e 7473 2873 656c 662c 2063 6f6e 7461  ents(self, conta
+0001da50: 696e 6572 5f6e 616d 6529 3a0a 2020 2020  iner_name):.    
+0001da60: 2020 2020 7365 6c66 2e66 7261 6d65 776f      self.framewo
+0001da70: 726b 2e6f 6273 6572 7665 2873 656c 662e  rk.observe(self.
+0001da80: 6f6e 5b63 6f6e 7461 696e 6572 5f6e 616d  on[container_nam
+0001da90: 655d 2e70 6562 626c 655f 7265 6164 792c  e].pebble_ready,
+0001daa0: 2073 656c 662e 5f6f 6e5f 7065 6262 6c65   self._on_pebble
+0001dab0: 5f72 6561 6479 290a 0a20 2020 2064 6566  _ready)..    def
+0001dac0: 205f 6f6e 5f70 6562 626c 655f 7265 6164   _on_pebble_read
+0001dad0: 7928 7365 6c66 2c20 6576 656e 7429 3a0a  y(self, event):.
+0001dae0: 2020 2020 2020 2020 7365 6c66 2e5f 6f62          self._ob
+0001daf0: 7365 7276 655f 636f 6e74 6169 6e65 725f  serve_container_
+0001db00: 6576 656e 7428 2770 6562 626c 652d 7265  event('pebble-re
+0001db10: 6164 7927 2c20 6576 656e 7429 0a0a 2020  ady', event)..  
+0001db20: 2020 6465 6620 5f6f 6273 6572 7665 5f63    def _observe_c
+0001db30: 6f6e 7461 696e 6572 5f65 7665 6e74 2873  ontainer_event(s
+0001db40: 656c 662c 2065 7665 6e74 5f6e 616d 652c  elf, event_name,
+0001db50: 2065 7665 6e74 3a20 6f70 732e 5065 6262   event: ops.Pebb
+0001db60: 6c65 5265 6164 7945 7665 6e74 293a 0a20  leReadyEvent):. 
+0001db70: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
+0001db80: 5f6e 616d 6520 3d20 4e6f 6e65 0a20 2020  _name = None.   
+0001db90: 2020 2020 2069 6620 6576 656e 742e 776f       if event.wo
+0001dba0: 726b 6c6f 6164 2069 7320 6e6f 7420 4e6f  rkload is not No
+0001dbb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001dbc0: 636f 6e74 6169 6e65 725f 6e61 6d65 203d  container_name =
+0001dbd0: 2065 7665 6e74 2e77 6f72 6b6c 6f61 642e   event.workload.
+0001dbe0: 6e61 6d65 0a20 2020 2020 2020 2073 656c  name.        sel
+0001dbf0: 662e 6368 616e 6765 732e 6170 7065 6e64  f.changes.append
+0001dc00: 280a 2020 2020 2020 2020 2020 2020 6469  (.            di
+0001dc10: 6374 286e 616d 653d 6576 656e 745f 6e61  ct(name=event_na
+0001dc20: 6d65 2c20 636f 6e74 6169 6e65 723d 636f  me, container=co
+0001dc30: 6e74 6169 6e65 725f 6e61 6d65 2929 0a0a  ntainer_name))..
+0001dc40: 0a64 6566 2067 6574 5f70 7562 6c69 635f  .def get_public_
+0001dc50: 6d65 7468 6f64 7328 6f62 6a29 3a0a 2020  methods(obj):.  
+0001dc60: 2020 2222 2247 6574 2074 6865 2070 7562    """Get the pub
+0001dc70: 6c69 6320 6174 7472 6962 7574 6573 206f  lic attributes o
+0001dc80: 6620 6f62 6a20 746f 2063 6f6d 7061 7265  f obj to compare
+0001dc90: 2074 6f20 616e 6f74 6865 7220 6f62 6a65   to another obje
+0001dca0: 6374 2e22 2222 0a20 2020 2070 7562 6c69  ct.""".    publi
+0001dcb0: 6320 3d20 7365 7428 290a 2020 2020 6d65  c = set().    me
+0001dcc0: 6d62 6572 7320 3d20 696e 7370 6563 742e  mbers = inspect.
+0001dcd0: 6765 746d 656d 6265 7273 286f 626a 290a  getmembers(obj).
+0001dce0: 2020 2020 666f 7220 6e61 6d65 2c20 6d65      for name, me
+0001dcf0: 6d62 6572 2069 6e20 6d65 6d62 6572 733a  mber in members:
+0001dd00: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+0001dd10: 2e73 7461 7274 7377 6974 6828 275f 2729  .startswith('_')
+0001dd20: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+0001dd30: 6e74 696e 7565 0a20 2020 2020 2020 2069  ntinue.        i
+0001dd40: 6620 696e 7370 6563 742e 6973 6675 6e63  f inspect.isfunc
+0001dd50: 7469 6f6e 286d 656d 6265 7229 206f 7220  tion(member) or 
+0001dd60: 696e 7370 6563 742e 6973 6d65 7468 6f64  inspect.ismethod
+0001dd70: 286d 656d 6265 7229 3a0a 2020 2020 2020  (member):.      
+0001dd80: 2020 2020 2020 7075 626c 6963 2e61 6464        public.add
+0001dd90: 286e 616d 6529 0a20 2020 2072 6574 7572  (name).    retur
+0001dda0: 6e20 7075 626c 6963 0a0a 0a63 6c61 7373  n public...class
+0001ddb0: 2054 6573 7454 6573 7469 6e67 4d6f 6465   TestTestingMode
+0001ddc0: 6c42 6163 6b65 6e64 2875 6e69 7474 6573  lBackend(unittes
+0001ddd0: 742e 5465 7374 4361 7365 293a 0a0a 2020  t.TestCase):..  
+0001dde0: 2020 6465 6620 7465 7374 5f63 6f6e 666f    def test_confo
+0001ddf0: 726d 735f 746f 5f6d 6f64 656c 5f62 6163  rms_to_model_bac
+0001de00: 6b65 6e64 2873 656c 6629 3a0a 2020 2020  kend(self):.    
+0001de10: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0001de20: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0001de30: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0001de40: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0001de50: 2020 2020 2020 6e61 6d65 3a20 6170 700a        name: app.
+0001de60: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0001de70: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001de80: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0001de90: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0001dea0: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
+0001deb0: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
+0001dec0: 2020 2020 206d 625f 6d65 7468 6f64 7320       mb_methods 
+0001ded0: 3d20 6765 745f 7075 626c 6963 5f6d 6574  = get_public_met
+0001dee0: 686f 6473 285f 4d6f 6465 6c42 6163 6b65  hods(_ModelBacke
+0001def0: 6e64 290a 2020 2020 2020 2020 6261 636b  nd).        back
+0001df00: 656e 645f 6d65 7468 6f64 7320 3d20 6765  end_methods = ge
+0001df10: 745f 7075 626c 6963 5f6d 6574 686f 6473  t_public_methods
+0001df20: 2862 6163 6b65 6e64 290a 2020 2020 2020  (backend).      
+0001df30: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0001df40: 616c 286d 625f 6d65 7468 6f64 732c 2062  al(mb_methods, b
+0001df50: 6163 6b65 6e64 5f6d 6574 686f 6473 290a  ackend_methods).
+0001df60: 0a20 2020 2064 6566 2074 6573 745f 6d6f  .    def test_mo
+0001df70: 6465 6c5f 7575 6964 5f69 735f 7575 6964  del_uuid_is_uuid
+0001df80: 5f76 3428 7365 6c66 293a 0a20 2020 2020  _v4(self):.     
+0001df90: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0001dfa0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0001dfb0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0001dfc0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+0001dfd0: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+0001dfe0: 6368 6172 6d0a 2020 2020 2020 2020 2727  charm.        ''
+0001dff0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001e000: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+0001e010: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+0001e020: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
+0001e030: 726e 6573 732e 5f62 6163 6b65 6e64 0a20  rness._backend. 
+0001e040: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0001e050: 7274 4571 7561 6c28 7575 6964 2e55 5549  rtEqual(uuid.UUI
+0001e060: 4428 6261 636b 656e 642e 6d6f 6465 6c5f  D(backend.model_
+0001e070: 7575 6964 292e 7665 7273 696f 6e2c 2034  uuid).version, 4
+0001e080: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001e090: 7374 6174 7573 5f73 6574 5f67 6574 5f75  status_set_get_u
+0001e0a0: 6e69 7428 7365 6c66 293a 0a20 2020 2020  nit(self):.     
+0001e0b0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0001e0c0: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0001e0d0: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0001e0e0: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+0001e0f0: 2020 2020 206e 616d 653a 2061 7070 0a20       name: app. 
+0001e100: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+0001e110: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+0001e120: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+0001e130: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+0001e140: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+0001e150: 7373 2e5f 6261 636b 656e 640a 2020 2020  ss._backend.    
+0001e160: 2020 2020 6261 636b 656e 642e 7374 6174      backend.stat
+0001e170: 7573 5f73 6574 2827 626c 6f63 6b65 6427  us_set('blocked'
+0001e180: 2c20 276d 6573 7361 6765 272c 2069 735f  , 'message', is_
+0001e190: 6170 703d 4661 6c73 6529 0a20 2020 2020  app=False).     
+0001e1a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0001e1b0: 7561 6c28 0a20 2020 2020 2020 2020 2020  ual(.           
+0001e1c0: 2062 6163 6b65 6e64 2e73 7461 7475 735f   backend.status_
+0001e1d0: 6765 7428 6973 5f61 7070 3d46 616c 7365  get(is_app=False
+0001e1e0: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
+0001e1f0: 2773 7461 7475 7327 3a20 2762 6c6f 636b  'status': 'block
+0001e200: 6564 272c 2027 6d65 7373 6167 6527 3a20  ed', 'message': 
+0001e210: 276d 6573 7361 6765 277d 290a 2020 2020  'message'}).    
+0001e220: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001e230: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+0001e240: 2020 6261 636b 656e 642e 7374 6174 7573    backend.status
+0001e250: 5f67 6574 2869 735f 6170 703d 5472 7565  _get(is_app=True
+0001e260: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
+0001e270: 2773 7461 7475 7327 3a20 2775 6e6b 6e6f  'status': 'unkno
+0001e280: 776e 272c 2027 6d65 7373 6167 6527 3a20  wn', 'message': 
+0001e290: 2727 7d29 0a0a 2020 2020 6465 6620 7465  ''})..    def te
+0001e2a0: 7374 5f73 7461 7475 735f 7365 745f 6765  st_status_set_ge
+0001e2b0: 745f 6170 7028 7365 6c66 293a 0a20 2020  t_app(self):.   
+0001e2c0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0001e2d0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0001e2e0: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+0001e2f0: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+0001e300: 2020 2020 2020 206e 616d 653a 2061 7070         name: app
+0001e310: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+0001e320: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001e330: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0001e340: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0001e350: 2020 2062 6163 6b65 6e64 203d 2068 6172     backend = har
+0001e360: 6e65 7373 2e5f 6261 636b 656e 640a 2020  ness._backend.  
+0001e370: 2020 2020 2020 6261 636b 656e 642e 7374        backend.st
+0001e380: 6174 7573 5f73 6574 2827 626c 6f63 6b65  atus_set('blocke
+0001e390: 6427 2c20 276d 6573 7361 6765 272c 2069  d', 'message', i
+0001e3a0: 735f 6170 703d 5472 7565 290a 2020 2020  s_app=True).    
+0001e3b0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001e3c0: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+0001e3d0: 2020 6261 636b 656e 642e 7374 6174 7573    backend.status
+0001e3e0: 5f67 6574 2869 735f 6170 703d 5472 7565  _get(is_app=True
+0001e3f0: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
+0001e400: 2773 7461 7475 7327 3a20 2762 6c6f 636b  'status': 'block
+0001e410: 6564 272c 2027 6d65 7373 6167 6527 3a20  ed', 'message': 
+0001e420: 276d 6573 7361 6765 277d 290a 2020 2020  'message'}).    
+0001e430: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001e440: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+0001e450: 2020 6261 636b 656e 642e 7374 6174 7573    backend.status
+0001e460: 5f67 6574 2869 735f 6170 703d 4661 6c73  _get(is_app=Fals
+0001e470: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0001e480: 7b27 7374 6174 7573 273a 2027 6d61 696e  {'status': 'main
+0001e490: 7465 6e61 6e63 6527 2c20 276d 6573 7361  tenance', 'messa
+0001e4a0: 6765 273a 2027 277d 290a 0a20 2020 2064  ge': ''})..    d
+0001e4b0: 6566 2074 6573 745f 7265 6c61 7469 6f6e  ef test_relation
+0001e4c0: 5f69 6473 5f75 6e6b 6e6f 776e 5f72 656c  _ids_unknown_rel
+0001e4d0: 6174 696f 6e28 7365 6c66 293a 0a20 2020  ation(self):.   
+0001e4e0: 2020 2020 2068 6172 6e65 7373 203d 206f       harness = o
+0001e4f0: 7073 2e74 6573 7469 6e67 2e48 6172 6e65  ps.testing.Harne
+0001e500: 7373 286f 7073 2e43 6861 726d 4261 7365  ss(ops.CharmBase
+0001e510: 2c20 6d65 7461 3d27 2727 0a20 2020 2020  , meta='''.     
+0001e520: 2020 2020 2020 206e 616d 653a 2074 6573         name: tes
+0001e530: 742d 6368 6172 6d0a 2020 2020 2020 2020  t-charm.        
+0001e540: 2020 2020 7072 6f76 6964 6573 3a0a 2020      provides:.  
+0001e550: 2020 2020 2020 2020 2020 2020 6462 3a0a              db:.
+0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e570: 696e 7465 7266 6163 653a 206d 7964 620a  interface: mydb.
+0001e580: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0001e590: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0001e5a0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0001e5b0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0001e5c0: 2020 6261 636b 656e 6420 3d20 6861 726e    backend = harn
+0001e5d0: 6573 732e 5f62 6163 6b65 6e64 0a20 2020  ess._backend.   
+0001e5e0: 2020 2020 2023 2057 6974 6820 6e6f 2072       # With no r
+0001e5f0: 656c 6174 696f 6e73 2061 6464 6564 2c20  elations added, 
+0001e600: 7765 206a 7573 7420 6765 7420 616e 2065  we just get an e
+0001e610: 6d70 7479 206c 6973 7420 666f 7220 7468  mpty list for th
+0001e620: 6520 696e 7465 7266 6163 650a 2020 2020  e interface.    
+0001e630: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0001e640: 7175 616c 2862 6163 6b65 6e64 2e72 656c  qual(backend.rel
+0001e650: 6174 696f 6e5f 6964 7328 2764 6227 292c  ation_ids('db'),
+0001e660: 205b 5d29 0a20 2020 2020 2020 2023 2042   []).        # B
+0001e670: 7574 2061 6e20 756e 6b6e 6f77 6e20 696e  ut an unknown in
+0001e680: 7465 7266 6163 6520 7261 6973 6573 2061  terface raises a
+0001e690: 204d 6f64 656c 4572 726f 720a 2020 2020   ModelError.    
+0001e6a0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0001e6b0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+0001e6c0: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+0001e6d0: 2020 2020 2020 2020 6261 636b 656e 642e          backend.
+0001e6e0: 7265 6c61 7469 6f6e 5f69 6473 2827 756e  relation_ids('un
+0001e6f0: 6b6e 6f77 6e27 290a 0a20 2020 2064 6566  known')..    def
+0001e700: 2074 6573 745f 7265 6c61 7469 6f6e 5f67   test_relation_g
+0001e710: 6574 5f75 6e6b 6e6f 776e 5f72 656c 6174  et_unknown_relat
+0001e720: 696f 6e5f 6964 2873 656c 6629 3a0a 2020  ion_id(self):.  
+0001e730: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+0001e740: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0001e750: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+0001e760: 652c 206d 6574 613d 2727 270a 2020 2020  e, meta='''.    
+0001e770: 2020 2020 2020 2020 6e61 6d65 3a20 7465          name: te
+0001e780: 7374 2d63 6861 726d 0a20 2020 2020 2020  st-charm.       
+0001e790: 2020 2020 2027 2727 290a 2020 2020 2020       ''').      
+0001e7a0: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0001e7b0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+0001e7c0: 7029 0a20 2020 2020 2020 2062 6163 6b65  p).        backe
+0001e7d0: 6e64 203d 2068 6172 6e65 7373 2e5f 6261  nd = harness._ba
+0001e7e0: 636b 656e 640a 2020 2020 2020 2020 7769  ckend.        wi
+0001e7f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0001e800: 6973 6573 286f 7073 2e52 656c 6174 696f  ises(ops.Relatio
+0001e810: 6e4e 6f74 466f 756e 6445 7272 6f72 293a  nNotFoundError):
+0001e820: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+0001e830: 6b65 6e64 2e72 656c 6174 696f 6e5f 6765  kend.relation_ge
+0001e840: 7428 3132 3334 2c20 2775 6e69 742f 3027  t(1234, 'unit/0'
+0001e850: 2c20 4661 6c73 6529 0a0a 2020 2020 6465  , False)..    de
+0001e860: 6620 7465 7374 5f72 656c 6174 696f 6e5f  f test_relation_
+0001e870: 6c69 7374 5f75 6e6b 6e6f 776e 5f72 656c  list_unknown_rel
+0001e880: 6174 696f 6e5f 6964 2873 656c 6629 3a0a  ation_id(self):.
+0001e890: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+0001e8a0: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+0001e8b0: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+0001e8c0: 6173 652c 206d 6574 613d 2727 270a 2020  ase, meta='''.  
+0001e8d0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+0001e8e0: 7465 7374 2d63 6861 726d 0a20 2020 2020  test-charm.     
+0001e8f0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+0001e900: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0001e910: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0001e920: 6e75 7029 0a20 2020 2020 2020 2062 6163  nup).        bac
+0001e930: 6b65 6e64 203d 2068 6172 6e65 7373 2e5f  kend = harness._
+0001e940: 6261 636b 656e 640a 2020 2020 2020 2020  backend.        
+0001e950: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0001e960: 5261 6973 6573 286f 7073 2e52 656c 6174  Raises(ops.Relat
+0001e970: 696f 6e4e 6f74 466f 756e 6445 7272 6f72  ionNotFoundError
+0001e980: 293a 0a20 2020 2020 2020 2020 2020 2062  ):.            b
+0001e990: 6163 6b65 6e64 2e72 656c 6174 696f 6e5f  ackend.relation_
+0001e9a0: 6c69 7374 2831 3233 3429 0a0a 2020 2020  list(1234)..    
+0001e9b0: 6465 6620 7465 7374 5f6c 617a 795f 7265  def test_lazy_re
+0001e9c0: 736f 7572 6365 5f64 6972 6563 746f 7279  source_directory
+0001e9d0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001e9e0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0001e9f0: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0001ea00: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0001ea10: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0001ea20: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0001ea30: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0001ea40: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
+0001ea50: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
+0001ea60: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+0001ea70: 653a 206f 6369 2d69 6d61 6765 0a20 2020  e: oci-image.   
+0001ea80: 2020 2020 2020 2020 2020 2020 2064 6573               des
+0001ea90: 6372 6970 7469 6f6e 3a20 2249 6d61 6765  cription: "Image
+0001eaa0: 2074 6f20 6465 706c 6f79 2e22 0a20 2020   to deploy.".   
+0001eab0: 2020 2020 2020 2020 2027 2727 290a 2020           ''').  
+0001eac0: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+0001ead0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+0001eae0: 6561 6e75 7029 0a20 2020 2020 2020 2068  eanup).        h
+0001eaf0: 6172 6e65 7373 2e70 6f70 756c 6174 655f  arness.populate_
+0001eb00: 6f63 695f 7265 736f 7572 6365 7328 290a  oci_resources().
+0001eb10: 2020 2020 2020 2020 6261 636b 656e 6420          backend 
+0001eb20: 3d20 6861 726e 6573 732e 5f62 6163 6b65  = harness._backe
+0001eb30: 6e64 0a20 2020 2020 2020 2073 656c 662e  nd.        self.
+0001eb40: 6173 7365 7274 4973 4e6f 6e65 2862 6163  assertIsNone(bac
+0001eb50: 6b65 6e64 2e5f 7265 736f 7572 6365 5f64  kend._resource_d
+0001eb60: 6972 290a 2020 2020 2020 2020 7061 7468  ir).        path
+0001eb70: 203d 2062 6163 6b65 6e64 2e72 6573 6f75   = backend.resou
+0001eb80: 7263 655f 6765 7428 2769 6d61 6765 2729  rce_get('image')
+0001eb90: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001eba0: 7365 7274 4973 4e6f 744e 6f6e 6528 6261  sertIsNotNone(ba
+0001ebb0: 636b 656e 642e 5f72 6573 6f75 7263 655f  ckend._resource_
+0001ebc0: 6469 7229 0a20 2020 2020 2020 2073 656c  dir).        sel
+0001ebd0: 662e 6173 7365 7274 5472 7565 280a 2020  f.assertTrue(.  
+0001ebe0: 2020 2020 2020 2020 2020 7374 7228 7061            str(pa
+0001ebf0: 7468 292e 7374 6172 7473 7769 7468 2873  th).startswith(s
+0001ec00: 7472 2862 6163 6b65 6e64 2e5f 7265 736f  tr(backend._reso
+0001ec10: 7572 6365 5f64 6972 2e6e 616d 6529 292c  urce_dir.name)),
+0001ec20: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0001ec30: 3d66 2765 7870 6563 7465 6420 7b70 6174  =f'expected {pat
+0001ec40: 687d 2074 6f20 6265 2061 2073 7562 6469  h} to be a subdi
+0001ec50: 7265 6374 6f72 7920 6f66 207b 6261 636b  rectory of {back
+0001ec60: 656e 642e 5f72 6573 6f75 7263 655f 6469  end._resource_di
+0001ec70: 722e 6e61 6d65 7d27 290a 0a20 2020 2064  r.name}')..    d
+0001ec80: 6566 2074 6573 745f 7265 736f 7572 6365  ef test_resource
+0001ec90: 5f67 6574 5f6e 6f5f 7265 736f 7572 6365  _get_no_resource
+0001eca0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001ecb0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0001ecc0: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0001ecd0: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0001ece0: 613d 2727 270a 2020 2020 2020 2020 2020  a='''.          
+0001ecf0: 2020 6e61 6d65 3a20 7465 7374 2d61 7070    name: test-app
+0001ed00: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0001ed10: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
+0001ed20: 2020 2020 2020 696d 6167 653a 0a20 2020        image:.   
+0001ed30: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+0001ed40: 653a 2066 696c 650a 2020 2020 2020 2020  e: file.        
+0001ed50: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+0001ed60: 696f 6e3a 2022 496d 6167 6520 746f 2064  ion: "Image to d
+0001ed70: 6570 6c6f 792e 220a 2020 2020 2020 2020  eploy.".        
+0001ed80: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
+0001ed90: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
+0001eda0: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
+0001edb0: 290a 2020 2020 2020 2020 6261 636b 656e  ).        backen
+0001edc0: 6420 3d20 6861 726e 6573 732e 5f62 6163  d = harness._bac
+0001edd0: 6b65 6e64 0a20 2020 2020 2020 2077 6974  kend.        wit
+0001ede0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0001edf0: 7365 7328 6f70 732e 4d6f 6465 6c45 7272  ses(ops.ModelErr
+0001ee00: 6f72 2920 6173 2063 6d3a 0a20 2020 2020  or) as cm:.     
+0001ee10: 2020 2020 2020 2062 6163 6b65 6e64 2e72         backend.r
+0001ee20: 6573 6f75 7263 655f 6765 7428 2766 6f6f  esource_get('foo
+0001ee30: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001ee40: 6173 7365 7274 496e 280a 2020 2020 2020  assertIn(.      
+0001ee50: 2020 2020 2020 2275 6e69 7473 2f75 6e69        "units/uni
+0001ee60: 742d 7465 7374 2d61 7070 2d30 2f72 6573  t-test-app-0/res
+0001ee70: 6f75 7263 6573 2f66 6f6f 3a20 7265 736f  ources/foo: reso
+0001ee80: 7572 6365 2374 6573 742d 6170 702f 666f  urce#test-app/fo
+0001ee90: 6f20 6e6f 7420 666f 756e 6422 2c0a 2020  o not found",.  
+0001eea0: 2020 2020 2020 2020 2020 7374 7228 636d            str(cm
+0001eeb0: 2e65 7863 6570 7469 6f6e 2929 0a0a 2020  .exception))..  
+0001eec0: 2020 6465 6620 7465 7374 5f72 656c 6174    def test_relat
+0001eed0: 696f 6e5f 7265 6d6f 7465 5f61 7070 5f6e  ion_remote_app_n
+0001eee0: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
+0001eef0: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0001ef00: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0001ef10: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0001ef20: 6d65 7461 3d27 2727 0a20 2020 2020 2020  meta='''.       
+0001ef30: 2020 2020 206e 616d 653a 2074 6573 742d       name: test-
+0001ef40: 6368 6172 6d0a 2020 2020 2020 2020 2020  charm.          
+0001ef50: 2020 7265 7175 6972 6573 3a0a 2020 2020    requires:.    
+0001ef60: 2020 2020 2020 2020 2020 2064 623a 0a20             db:. 
+0001ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef80: 696e 7465 7266 6163 653a 2066 6f6f 0a20  interface: foo. 
+0001ef90: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+0001efa0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+0001efb0: 436c 6561 6e75 7028 6861 726e 6573 732e  Cleanup(harness.
+0001efc0: 636c 6561 6e75 7029 0a20 2020 2020 2020  cleanup).       
+0001efd0: 2062 6163 6b65 6e64 203d 2068 6172 6e65   backend = harne
+0001efe0: 7373 2e5f 6261 636b 656e 640a 0a20 2020  ss._backend..   
+0001eff0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0001f000: 4973 2862 6163 6b65 6e64 2e72 656c 6174  Is(backend.relat
+0001f010: 696f 6e5f 7265 6d6f 7465 5f61 7070 5f6e  ion_remote_app_n
+0001f020: 616d 6528 3129 2c20 4e6f 6e65 290a 0a20  ame(1), None).. 
+0001f030: 2020 2020 2020 2072 656c 5f69 6420 3d20         rel_id = 
+0001f040: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0001f050: 7469 6f6e 2827 6462 272c 2027 706f 7374  tion('db', 'post
+0001f060: 6772 6573 716c 2729 0a20 2020 2020 2020  gresql').       
+0001f070: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+0001f080: 6c28 6261 636b 656e 642e 7265 6c61 7469  l(backend.relati
+0001f090: 6f6e 5f72 656d 6f74 655f 6170 705f 6e61  on_remote_app_na
+0001f0a0: 6d65 2872 656c 5f69 6429 2c20 2770 6f73  me(rel_id), 'pos
+0001f0b0: 7467 7265 7371 6c27 290a 2020 2020 2020  tgresql').      
+0001f0c0: 2020 6861 726e 6573 732e 6164 645f 7265    harness.add_re
+0001f0d0: 6c61 7469 6f6e 5f75 6e69 7428 7265 6c5f  lation_unit(rel_
+0001f0e0: 6964 2c20 2770 6f73 7467 7265 7371 6c2f  id, 'postgresql/
+0001f0f0: 3027 290a 2020 2020 2020 2020 6861 726e  0').        harn
+0001f100: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+0001f110: 5f75 6e69 7428 7265 6c5f 6964 2c20 2770  _unit(rel_id, 'p
+0001f120: 6f73 7467 7265 7371 6c2f 3127 290a 2020  ostgresql/1').  
+0001f130: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001f140: 7445 7175 616c 2862 6163 6b65 6e64 2e72  tEqual(backend.r
+0001f150: 656c 6174 696f 6e5f 7265 6d6f 7465 5f61  elation_remote_a
+0001f160: 7070 5f6e 616d 6528 7265 6c5f 6964 292c  pp_name(rel_id),
+0001f170: 2027 706f 7374 6772 6573 716c 2729 0a0a   'postgresql')..
+0001f180: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001f190: 6572 7449 7328 6261 636b 656e 642e 7265  ertIs(backend.re
+0001f1a0: 6c61 7469 6f6e 5f72 656d 6f74 655f 6170  lation_remote_ap
+0001f1b0: 705f 6e61 6d65 2837 292c 204e 6f6e 6529  p_name(7), None)
+0001f1c0: 0a0a 2020 2020 6465 6620 7465 7374 5f67  ..    def test_g
+0001f1d0: 6574 5f70 6562 626c 655f 6d65 7468 6f64  et_pebble_method
+0001f1e0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001f1f0: 2068 6172 6e65 7373 203d 206f 7073 2e74   harness = ops.t
+0001f200: 6573 7469 6e67 2e48 6172 6e65 7373 286f  esting.Harness(o
+0001f210: 7073 2e43 6861 726d 4261 7365 2c20 6d65  ps.CharmBase, me
+0001f220: 7461 3d27 2727 0a20 2020 2020 2020 2020  ta='''.         
+0001f230: 2020 206e 616d 653a 2074 6573 742d 6170     name: test-ap
+0001f240: 700a 2020 2020 2020 2020 2020 2020 2727  p.            ''
+0001f250: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0001f260: 6164 6443 6c65 616e 7570 2868 6172 6e65  addCleanup(harne
+0001f270: 7373 2e63 6c65 616e 7570 290a 2020 2020  ss.cleanup).    
+0001f280: 2020 2020 6261 636b 656e 6420 3d20 6861      backend = ha
+0001f290: 726e 6573 732e 5f62 6163 6b65 6e64 0a0a  rness._backend..
+0001f2a0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+0001f2b0: 2062 6163 6b65 6e64 2e67 6574 5f70 6562   backend.get_peb
+0001f2c0: 626c 6528 272f 6375 7374 6f6d 2f73 6f63  ble('/custom/soc
+0001f2d0: 6b65 742f 7061 7468 2729 0a20 2020 2020  ket/path').     
+0001f2e0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001f2f0: 496e 7374 616e 6365 2863 6c69 656e 742c  Instance(client,
+0001f300: 205f 5465 7374 696e 6750 6562 626c 6543   _TestingPebbleC
+0001f310: 6c69 656e 7429 0a0a 0a63 6c61 7373 205f  lient)...class _
+0001f320: 5465 7374 696e 6750 6562 626c 6543 6c69  TestingPebbleCli
+0001f330: 656e 744d 6978 696e 3a0a 2020 2020 6465  entMixin:.    de
+0001f340: 6620 6765 745f 7465 7374 696e 675f 636c  f get_testing_cl
+0001f350: 6965 6e74 2873 656c 6629 3a0a 2020 2020  ient(self):.    
+0001f360: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0001f370: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0001f380: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0001f390: 206d 6574 613d 2727 270a 2020 2020 2020   meta='''.      
+0001f3a0: 2020 2020 2020 6e61 6d65 3a20 7465 7374        name: test
+0001f3b0: 2d61 7070 0a20 2020 2020 2020 2020 2020  -app.           
+0001f3c0: 2063 6f6e 7461 696e 6572 733a 0a20 2020   containers:.   
+0001f3d0: 2020 2020 2020 2020 2020 206d 7963 6f6e             mycon
+0001f3e0: 7461 696e 6572 3a20 7b7d 0a20 2020 2020  tainer: {}.     
+0001f3f0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+0001f400: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0001f410: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0001f420: 6e75 7029 0a20 2020 2020 2020 2062 6163  nup).        bac
+0001f430: 6b65 6e64 203d 2068 6172 6e65 7373 2e5f  kend = harness._
+0001f440: 6261 636b 656e 640a 0a20 2020 2020 2020  backend..       
+0001f450: 2063 6c69 656e 7420 3d20 6261 636b 656e   client = backen
+0001f460: 642e 6765 745f 7065 6262 6c65 2827 2f63  d.get_pebble('/c
+0001f470: 6861 726d 2f63 6f6e 7461 696e 6572 732f  harm/containers/
+0001f480: 6d79 636f 6e74 6169 6e65 722f 7065 6262  mycontainer/pebb
+0001f490: 6c65 2e73 6f63 6b65 7427 290a 2020 2020  le.socket').    
+0001f4a0: 2020 2020 6861 726e 6573 732e 7365 745f      harness.set_
+0001f4b0: 6361 6e5f 636f 6e6e 6563 7428 276d 7963  can_connect('myc
+0001f4c0: 6f6e 7461 696e 6572 272c 2054 7275 6529  ontainer', True)
+0001f4d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001f4e0: 636c 6965 6e74 0a0a 0a23 2046 6f72 2074  client...# For t
+0001f4f0: 6573 7469 6e67 206e 6f6e 2066 696c 6520  esting non file 
+0001f500: 6f70 7320 6f66 2074 6865 2070 6562 626c  ops of the pebbl
+0001f510: 6520 7465 7374 696e 6720 636c 6965 6e74  e testing client
+0001f520: 2e0a 636c 6173 7320 5465 7374 5465 7374  ..class TestTest
+0001f530: 696e 6750 6562 626c 6543 6c69 656e 7428  ingPebbleClient(
+0001f540: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
+0001f550: 652c 205f 5465 7374 696e 6750 6562 626c  e, _TestingPebbl
+0001f560: 6543 6c69 656e 744d 6978 696e 293a 0a0a  eClientMixin):..
+0001f570: 2020 2020 6465 6620 7465 7374 5f6d 6574      def test_met
+0001f580: 686f 6473 5f6d 6174 6368 5f70 6562 626c  hods_match_pebbl
+0001f590: 655f 636c 6965 6e74 2873 656c 6629 3a0a  e_client(self):.
+0001f5a0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+0001f5b0: 2073 656c 662e 6765 745f 7465 7374 696e   self.get_testin
+0001f5c0: 675f 636c 6965 6e74 2829 0a20 2020 2020  g_client().     
+0001f5d0: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0001f5e0: 4e6f 744e 6f6e 6528 636c 6965 6e74 290a  NotNone(client).
+0001f5f0: 2020 2020 2020 2020 7065 6262 6c65 5f63          pebble_c
+0001f600: 6c69 656e 745f 6d65 7468 6f64 7320 3d20  lient_methods = 
+0001f610: 6765 745f 7075 626c 6963 5f6d 6574 686f  get_public_metho
+0001f620: 6473 2870 6562 626c 652e 436c 6965 6e74  ds(pebble.Client
+0001f630: 290a 2020 2020 2020 2020 7465 7374 696e  ).        testin
+0001f640: 675f 636c 6965 6e74 5f6d 6574 686f 6473  g_client_methods
+0001f650: 203d 2067 6574 5f70 7562 6c69 635f 6d65   = get_public_me
+0001f660: 7468 6f64 7328 636c 6965 6e74 290a 2020  thods(client).  
+0001f670: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0001f680: 7445 7175 616c 2870 6562 626c 655f 636c  tEqual(pebble_cl
+0001f690: 6965 6e74 5f6d 6574 686f 6473 2c20 7465  ient_methods, te
+0001f6a0: 7374 696e 675f 636c 6965 6e74 5f6d 6574  sting_client_met
+0001f6b0: 686f 6473 290a 0a20 2020 2064 6566 2074  hods)..    def t
+0001f6c0: 6573 745f 6164 645f 6c61 7965 7228 7365  est_add_layer(se
+0001f6d0: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
+0001f6e0: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
+0001f6f0: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
+0001f700: 2020 2020 2020 2020 706c 616e 203d 2063          plan = c
+0001f710: 6c69 656e 742e 6765 745f 706c 616e 2829  lient.get_plan()
+0001f720: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001f730: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
+0001f740: 6c61 6e2c 2070 6562 626c 652e 506c 616e  lan, pebble.Plan
+0001f750: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0001f760: 7373 6572 7445 7175 616c 2827 7b7d 5c6e  ssertEqual('{}\n
+0001f770: 272c 2070 6c61 6e2e 746f 5f79 616d 6c28  ', plan.to_yaml(
+0001f780: 2929 0a20 2020 2020 2020 2063 6c69 656e  )).        clien
+0001f790: 742e 6164 645f 6c61 7965 7228 2766 6f6f  t.add_layer('foo
+0001f7a0: 272c 2070 6562 626c 652e 4c61 7965 7228  ', pebble.Layer(
+0001f7b0: 2727 275c 0a20 2020 2020 2020 2020 2020  '''\.           
+0001f7c0: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
+0001f7d0: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+0001f7e0: 7074 696f 6e3a 207c 0a20 2020 2020 2020  ption: |.       
+0001f7f0: 2020 2020 2020 2041 206c 6f6e 6765 7220         A longer 
+0001f800: 6465 7363 7269 7074 696f 6e20 6162 6f75  description abou
+0001f810: 7420 466f 6f0a 2020 2020 2020 2020 2020  t Foo.          
+0001f820: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
+0001f830: 2020 2020 2020 2020 2020 7365 7276 3a0a            serv:.
+0001f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f850: 7375 6d6d 6172 793a 2053 6572 760a 2020  summary: Serv.  
+0001f860: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0001f870: 7363 7269 7074 696f 6e3a 207c 0a20 2020  scription: |.   
+0001f880: 2020 2020 2020 2020 2020 2020 2020 2041                 A
+0001f890: 2064 6573 6372 6970 7469 6f6e 2061 626f   description abo
+0001f8a0: 7574 2053 6572 7620 7468 6520 616d 617a  ut Serv the amaz
+0001f8b0: 696e 6720 7365 7276 6963 652e 0a20 2020  ing service..   
+0001f8c0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0001f8d0: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
+0001f8e0: 2020 2020 2020 2020 2020 2020 2020 6f76                ov
+0001f8f0: 6572 7269 6465 3a20 7265 706c 6163 650a  erride: replace.
+0001f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f910: 636f 6d6d 616e 643a 2027 2f62 696e 2f65  command: '/bin/e
+0001f920: 6368 6f20 6865 6c6c 6f27 0a20 2020 2020  cho hello'.     
+0001f930: 2020 2020 2020 2020 2020 2065 6e76 6972             envir
+0001f940: 6f6e 6d65 6e74 3a0a 2020 2020 2020 2020  onment:.        
+0001f950: 2020 2020 2020 2020 2020 4b45 593a 2056            KEY: V
+0001f960: 414c 5545 0a20 2020 2020 2020 2020 2020  ALUE.           
+0001f970: 2027 2727 2929 0a20 2020 2020 2020 2070   ''')).        p
+0001f980: 6c61 6e20 3d20 636c 6965 6e74 2e67 6574  lan = client.get
+0001f990: 5f70 6c61 6e28 290a 2020 2020 2020 2020  _plan().        
+0001f9a0: 2320 5468 6520 5941 4d4c 2073 686f 756c  # The YAML shoul
+0001f9b0: 6420 6265 206e 6f72 6d61 6c69 7a65 640a  d be normalized.
+0001f9c0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001f9d0: 6572 7445 7175 616c 2874 6578 7477 7261  ertEqual(textwra
+0001f9e0: 702e 6465 6465 6e74 2827 2727 5c0a 2020  p.dedent('''\.  
+0001f9f0: 2020 2020 2020 2020 2020 7365 7276 6963            servic
+0001fa00: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001fa10: 2020 7365 7276 3a0a 2020 2020 2020 2020    serv:.        
+0001fa20: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+0001fa30: 202f 6269 6e2f 6563 686f 2068 656c 6c6f   /bin/echo hello
+0001fa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fa50: 2064 6573 6372 6970 7469 6f6e 3a20 2741   description: 'A
+0001fa60: 2064 6573 6372 6970 7469 6f6e 2061 626f   description abo
+0001fa70: 7574 2053 6572 7620 7468 6520 616d 617a  ut Serv the amaz
+0001fa80: 696e 6720 7365 7276 6963 652e 0a0a 2020  ing service...  
+0001fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001faa0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001fab0: 2020 656e 7669 726f 6e6d 656e 743a 0a20    environment:. 
+0001fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fad0: 204b 4559 3a20 5641 4c55 450a 2020 2020   KEY: VALUE.    
+0001fae0: 2020 2020 2020 2020 2020 2020 6f76 6572              over
+0001faf0: 7269 6465 3a20 7265 706c 6163 650a 2020  ride: replace.  
+0001fb00: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001fb10: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
+0001fb20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001fb30: 756d 6d61 7279 3a20 5365 7276 0a20 2020  ummary: Serv.   
+0001fb40: 2020 2020 2020 2020 2027 2727 292c 2070           '''), p
+0001fb50: 6c61 6e2e 746f 5f79 616d 6c28 2929 0a0a  lan.to_yaml())..
+0001fb60: 2020 2020 6465 6620 7465 7374 5f61 6464      def test_add
+0001fb70: 5f6c 6179 6572 5f6d 6572 6765 2873 656c  _layer_merge(sel
+0001fb80: 6629 3a0a 2020 2020 2020 2020 636c 6965  f):.        clie
+0001fb90: 6e74 203d 2073 656c 662e 6765 745f 7465  nt = self.get_te
+0001fba0: 7374 696e 675f 636c 6965 6e74 2829 0a20  sting_client(). 
+0001fbb0: 2020 2020 2020 2070 6c61 6e20 3d20 636c         plan = cl
+0001fbc0: 6965 6e74 2e67 6574 5f70 6c61 6e28 290a  ient.get_plan().
+0001fbd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0001fbe0: 6572 7449 7349 6e73 7461 6e63 6528 706c  ertIsInstance(pl
+0001fbf0: 616e 2c20 7065 6262 6c65 2e50 6c61 6e29  an, pebble.Plan)
+0001fc00: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0001fc10: 7365 7274 4571 7561 6c28 277b 7d5c 6e27  sertEqual('{}\n'
+0001fc20: 2c20 706c 616e 2e74 6f5f 7961 6d6c 2829  , plan.to_yaml()
+0001fc30: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
+0001fc40: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
+0001fc50: 2c20 7065 6262 6c65 2e4c 6179 6572 2827  , pebble.Layer('
+0001fc60: 2727 5c0a 2020 2020 2020 2020 2020 2020  ''\.            
+0001fc70: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
+0001fc80: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+0001fc90: 7469 6f6e 3a20 7c0a 2020 2020 2020 2020  tion: |.        
+0001fca0: 2020 2020 2020 4120 6c6f 6e67 6572 2064        A longer d
+0001fcb0: 6573 6372 6970 7469 6f6e 2061 626f 7574  escription about
+0001fcc0: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
+0001fcd0: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
+0001fce0: 2020 2020 2020 2020 2073 6572 763a 0a20           serv:. 
+0001fcf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001fd00: 756d 6d61 7279 3a20 5365 7276 0a20 2020  ummary: Serv.   
+0001fd10: 2020 2020 2020 2020 2020 2020 2064 6573               des
+0001fd20: 6372 6970 7469 6f6e 3a20 7c0a 2020 2020  cription: |.    
+0001fd30: 2020 2020 2020 2020 2020 2020 2020 4120                A 
+0001fd40: 6465 7363 7269 7074 696f 6e20 6162 6f75  description abou
+0001fd50: 7420 5365 7276 2074 6865 2061 6d61 7a69  t Serv the amazi
+0001fd60: 6e67 2073 6572 7669 6365 2e0a 2020 2020  ng service..    
+0001fd70: 2020 2020 2020 2020 2020 2020 7374 6172              star
+0001fd80: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
+0001fd90: 2020 2020 2020 2020 2020 2020 206f 7665               ove
+0001fda0: 7272 6964 653a 2072 6570 6c61 6365 0a20  rride: replace. 
+0001fdb0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001fdc0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
+0001fdd0: 686f 2068 656c 6c6f 270a 2020 2020 2020  ho hello'.      
+0001fde0: 2020 2020 2020 2020 2020 656e 7669 726f            enviro
+0001fdf0: 6e6d 656e 743a 0a20 2020 2020 2020 2020  nment:.         
+0001fe00: 2020 2020 2020 2020 204b 4559 313a 2056           KEY1: V
+0001fe10: 414c 5545 310a 2020 2020 2020 2020 2020  ALUE1.          
+0001fe20: 2020 2020 2020 6166 7465 723a 0a20 2020        after:.   
+0001fe30: 2020 2020 2020 2020 2020 2020 202d 2074               - t
+0001fe40: 6869 6e67 310a 2020 2020 2020 2020 2020  hing1.          
+0001fe50: 2020 2020 2020 6265 666f 7265 3a0a 2020        before:.  
+0001fe60: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+0001fe70: 7468 696e 6731 0a20 2020 2020 2020 2020  thing1.         
+0001fe80: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+0001fe90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fea0: 202d 2074 6869 6e67 310a 2020 2020 2020   - thing1.      
+0001feb0: 2020 2020 2020 2020 2020 7573 6572 3a20            user: 
+0001fec0: 7573 6572 310a 2020 2020 2020 2020 2020  user1.          
+0001fed0: 2020 2020 2020 7573 6572 2d69 643a 2075        user-id: u
+0001fee0: 7365 7249 4431 0a20 2020 2020 2020 2020  serID1.         
+0001fef0: 2020 2020 2020 2067 726f 7570 3a20 6772         group: gr
+0001ff00: 6f75 7031 0a20 2020 2020 2020 2020 2020  oup1.           
+0001ff10: 2020 2020 2067 726f 7570 2d69 643a 2067       group-id: g
+0001ff20: 726f 7570 4944 310a 2020 2020 2020 2020  roupID1.        
+0001ff30: 2020 2020 2020 2020 6f6e 2d66 6169 6c75          on-failu
+0001ff40: 7265 3a20 7468 696e 6731 0a20 2020 2020  re: thing1.     
+0001ff50: 2020 2020 2020 2020 2020 206f 6e2d 7375             on-su
+0001ff60: 6363 6573 733a 2074 6869 6e67 310a 2020  ccess: thing1.  
+0001ff70: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+0001ff80: 2d63 6865 636b 2d66 6169 6c75 7265 3a0a  -check-failure:.
+0001ff90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffa0: 2020 4b45 5931 3a20 5641 4c55 4531 0a20    KEY1: VALUE1. 
+0001ffb0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0001ffc0: 6163 6b6f 6666 2d64 656c 6179 3a20 310a  ackoff-delay: 1.
+0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffe0: 6261 636b 6f66 662d 6661 6374 6f72 3a20  backoff-factor: 
+0001fff0: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+00020000: 2020 6261 636b 6f66 662d 6c69 6d69 743a    backoff-limit:
+00020010: 2031 0a20 2020 2020 2020 2020 2020 2027   1.            '
+00020020: 2727 2929 0a20 2020 2020 2020 2070 6c61  '')).        pla
+00020030: 6e20 3d20 636c 6965 6e74 2e67 6574 5f70  n = client.get_p
+00020040: 6c61 6e28 290a 2020 2020 2020 2020 2320  lan().        # 
+00020050: 5468 6520 5941 4d4c 2073 686f 756c 6420  The YAML should 
+00020060: 6265 206e 6f72 6d61 6c69 7a65 640a 2020  be normalized.  
+00020070: 2020 2020 2020 7365 6c66 2e6d 6178 4469        self.maxDi
+00020080: 6666 203d 204e 6f6e 650a 2020 2020 2020  ff = None.      
+00020090: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000200a0: 616c 2874 6578 7477 7261 702e 6465 6465  al(textwrap.dede
+000200b0: 6e74 2827 2727 5c0a 2020 2020 2020 2020  nt('''\.        
+000200c0: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
+000200d0: 2020 2020 2020 2020 2020 2020 7365 7276              serv
+000200e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000200f0: 2020 6166 7465 723a 0a20 2020 2020 2020    after:.       
+00020100: 2020 2020 2020 2020 202d 2074 6869 6e67           - thing
+00020110: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00020120: 2020 6261 636b 6f66 662d 6465 6c61 793a    backoff-delay:
+00020130: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00020140: 2020 2062 6163 6b6f 6666 2d66 6163 746f     backoff-facto
+00020150: 723a 2032 0a20 2020 2020 2020 2020 2020  r: 2.           
+00020160: 2020 2020 2062 6163 6b6f 6666 2d6c 696d       backoff-lim
+00020170: 6974 3a20 310a 2020 2020 2020 2020 2020  it: 1.          
+00020180: 2020 2020 2020 6265 666f 7265 3a0a 2020        before:.  
+00020190: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+000201a0: 7468 696e 6731 0a20 2020 2020 2020 2020  thing1.         
+000201b0: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+000201c0: 2f62 696e 2f65 6368 6f20 6865 6c6c 6f0a  /bin/echo hello.
+000201d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201e0: 6465 7363 7269 7074 696f 6e3a 2027 4120  description: 'A 
+000201f0: 6465 7363 7269 7074 696f 6e20 6162 6f75  description abou
+00020200: 7420 5365 7276 2074 6865 2061 6d61 7a69  t Serv the amazi
+00020210: 6e67 2073 6572 7669 6365 2e0a 0a20 2020  ng service...   
+00020220: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00020230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020240: 2065 6e76 6972 6f6e 6d65 6e74 3a0a 2020   environment:.  
+00020250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020260: 4b45 5931 3a20 5641 4c55 4531 0a20 2020  KEY1: VALUE1.   
+00020270: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00020280: 7570 3a20 6772 6f75 7031 0a20 2020 2020  up: group1.     
+00020290: 2020 2020 2020 2020 2020 2067 726f 7570             group
+000202a0: 2d69 643a 2067 726f 7570 4944 310a 2020  -id: groupID1.  
+000202b0: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+000202c0: 2d63 6865 636b 2d66 6169 6c75 7265 3a0a  -check-failure:.
+000202d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202e0: 2020 4b45 5931 3a20 5641 4c55 4531 0a20    KEY1: VALUE1. 
+000202f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00020300: 6e2d 6661 696c 7572 653a 2074 6869 6e67  n-failure: thing
+00020310: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00020320: 2020 6f6e 2d73 7563 6365 7373 3a20 7468    on-success: th
+00020330: 696e 6731 0a20 2020 2020 2020 2020 2020  ing1.           
+00020340: 2020 2020 206f 7665 7272 6964 653a 2072       override: r
+00020350: 6570 6c61 6365 0a20 2020 2020 2020 2020  eplace.         
+00020360: 2020 2020 2020 2072 6571 7569 7265 733a         requires:
+00020370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020380: 202d 2074 6869 6e67 310a 2020 2020 2020   - thing1.      
+00020390: 2020 2020 2020 2020 2020 7374 6172 7475            startu
+000203a0: 703a 2065 6e61 626c 6564 0a20 2020 2020  p: enabled.     
+000203b0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+000203c0: 7279 3a20 5365 7276 0a20 2020 2020 2020  ry: Serv.       
+000203d0: 2020 2020 2020 2020 2075 7365 723a 2075           user: u
+000203e0: 7365 7231 0a20 2020 2020 2020 2020 2020  ser1.           
+000203f0: 2020 2020 2075 7365 722d 6964 3a20 7573       user-id: us
+00020400: 6572 4944 310a 2020 2020 2020 2020 2020  erID1.          
+00020410: 2020 2727 2729 2c20 706c 616e 2e74 6f5f    '''), plan.to_
+00020420: 7961 6d6c 2829 290a 0a20 2020 2020 2020  yaml())..       
+00020430: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
+00020440: 7228 2766 6f6f 272c 2070 6562 626c 652e  r('foo', pebble.
+00020450: 4c61 7965 7228 2727 275c 0a20 2020 2020  Layer('''\.     
+00020460: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00020470: 466f 6f0a 2020 2020 2020 2020 2020 2020  Foo.            
+00020480: 6465 7363 7269 7074 696f 6e3a 207c 0a20  description: |. 
+00020490: 2020 2020 2020 2020 2020 2020 2041 206c               A l
+000204a0: 6f6e 6765 7220 6465 7363 7269 7074 696f  onger descriptio
+000204b0: 6e20 6162 6f75 7420 466f 6f0a 2020 2020  n about Foo.    
+000204c0: 2020 2020 2020 2020 7365 7276 6963 6573          services
+000204d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000204e0: 7365 7276 3a0a 2020 2020 2020 2020 2020  serv:.          
+000204f0: 2020 2020 2020 7375 6d6d 6172 793a 2053        summary: S
+00020500: 6572 760a 2020 2020 2020 2020 2020 2020  erv.            
+00020510: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
+00020520: 207c 0a20 2020 2020 2020 2020 2020 2020   |.             
+00020530: 2020 2020 2041 206e 6577 2064 6573 6372       A new descr
+00020540: 6970 7469 6f6e 206f 6620 7468 6520 7468  iption of the th
+00020550: 6520 616d 617a 696e 6720 5365 7276 2073  e amazing Serv s
+00020560: 6572 7669 6365 2e0a 2020 2020 2020 2020  ervice..        
+00020570: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
+00020580: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
+00020590: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
+000205a0: 653a 206d 6572 6765 0a20 2020 2020 2020  e: merge.       
+000205b0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+000205c0: 3a20 272f 6269 6e2f 6563 686f 2068 656c  : '/bin/echo hel
+000205d0: 6c6f 270a 2020 2020 2020 2020 2020 2020  lo'.            
+000205e0: 2020 2020 656e 7669 726f 6e6d 656e 743a      environment:
+000205f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020600: 2020 204b 4559 313a 2056 414c 5545 340a     KEY1: VALUE4.
+00020610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020620: 2020 4b45 5932 3a20 5641 4c55 4532 0a20    KEY2: VALUE2. 
+00020630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020640: 204b 4559 333a 2056 414c 5545 330a 2020   KEY3: VALUE3.  
+00020650: 2020 2020 2020 2020 2020 2020 2020 6166                af
+00020660: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
+00020670: 2020 2020 202d 2074 6869 6e67 320a 2020       - thing2.  
+00020680: 2020 2020 2020 2020 2020 2020 2020 6265                be
+00020690: 666f 7265 3a0a 2020 2020 2020 2020 2020  fore:.          
+000206a0: 2020 2020 2020 2d20 7468 696e 6732 0a20        - thing2. 
+000206b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000206c0: 6571 7569 7265 733a 0a20 2020 2020 2020  equires:.       
+000206d0: 2020 2020 2020 2020 202d 2074 6869 6e67           - thing
+000206e0: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+000206f0: 2020 7573 6572 3a20 7573 6572 320a 2020    user: user2.  
+00020700: 2020 2020 2020 2020 2020 2020 2020 7573                us
+00020710: 6572 2d69 643a 2075 7365 7249 4432 0a20  er-id: userID2. 
+00020720: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00020730: 726f 7570 3a20 6772 6f75 7032 0a20 2020  roup: group2.   
+00020740: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00020750: 7570 2d69 643a 2067 726f 7570 4944 320a  up-id: groupID2.
+00020760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020770: 6f6e 2d73 7563 6365 7373 3a20 7468 696e  on-success: thin
+00020780: 6732 0a20 2020 2020 2020 2020 2020 2020  g2.             
+00020790: 2020 206f 6e2d 6661 696c 7572 653a 2074     on-failure: t
+000207a0: 6869 6e67 320a 2020 2020 2020 2020 2020  hing2.          
+000207b0: 2020 2020 2020 6f6e 2d63 6865 636b 2d66        on-check-f
+000207c0: 6169 6c75 7265 3a0a 2020 2020 2020 2020  ailure:.        
+000207d0: 2020 2020 2020 2020 2020 4b45 5931 3a20            KEY1: 
+000207e0: 5641 4c55 4534 0a20 2020 2020 2020 2020  VALUE4.         
+000207f0: 2020 2020 2020 2020 204b 4559 323a 2056           KEY2: V
+00020800: 414c 5545 320a 2020 2020 2020 2020 2020  ALUE2.          
+00020810: 2020 2020 2020 2020 4b45 5933 3a20 5641          KEY3: VA
+00020820: 4c55 4533 0a20 2020 2020 2020 2020 2020  LUE3.           
+00020830: 2020 2020 2062 6163 6b6f 6666 2d64 656c       backoff-del
+00020840: 6179 3a20 320a 2020 2020 2020 2020 2020  ay: 2.          
+00020850: 2020 2020 2020 6261 636b 6f66 662d 6661        backoff-fa
+00020860: 6374 6f72 3a20 330a 2020 2020 2020 2020  ctor: 3.        
+00020870: 2020 2020 2020 2020 6261 636b 6f66 662d          backoff-
+00020880: 6c69 6d69 743a 2032 0a20 2020 2020 2020  limit: 2.       
+00020890: 2020 2020 2027 2727 292c 2063 6f6d 6269       '''), combi
+000208a0: 6e65 3d54 7275 6529 0a20 2020 2020 2020  ne=True).       
+000208b0: 2070 6c61 6e20 3d20 636c 6965 6e74 2e67   plan = client.g
+000208c0: 6574 5f70 6c61 6e28 290a 2020 2020 2020  et_plan().      
+000208d0: 2020 2320 5468 6520 5941 4d4c 2073 686f    # The YAML sho
+000208e0: 756c 6420 6265 206e 6f72 6d61 6c69 7a65  uld be normalize
+000208f0: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
+00020900: 7373 6572 7445 7175 616c 2874 6578 7477  ssertEqual(textw
+00020910: 7261 702e 6465 6465 6e74 2827 2727 5c0a  rap.dedent('''\.
+00020920: 2020 2020 2020 2020 2020 2020 7365 7276              serv
+00020930: 6963 6573 3a0a 2020 2020 2020 2020 2020  ices:.          
+00020940: 2020 2020 7365 7276 3a0a 2020 2020 2020      serv:.      
+00020950: 2020 2020 2020 2020 2020 6166 7465 723a            after:
+00020960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020970: 202d 2074 6869 6e67 310a 2020 2020 2020   - thing1.      
+00020980: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
+00020990: 6732 0a20 2020 2020 2020 2020 2020 2020  g2.             
+000209a0: 2020 2062 6163 6b6f 6666 2d64 656c 6179     backoff-delay
+000209b0: 3a20 320a 2020 2020 2020 2020 2020 2020  : 2.            
+000209c0: 2020 2020 6261 636b 6f66 662d 6661 6374      backoff-fact
+000209d0: 6f72 3a20 330a 2020 2020 2020 2020 2020  or: 3.          
+000209e0: 2020 2020 2020 6261 636b 6f66 662d 6c69        backoff-li
+000209f0: 6d69 743a 2032 0a20 2020 2020 2020 2020  mit: 2.         
+00020a00: 2020 2020 2020 2062 6566 6f72 653a 0a20         before:. 
+00020a10: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+00020a20: 2074 6869 6e67 310a 2020 2020 2020 2020   thing1.        
+00020a30: 2020 2020 2020 2020 2d20 7468 696e 6732          - thing2
+00020a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020a50: 2063 6f6d 6d61 6e64 3a20 2f62 696e 2f65   command: /bin/e
+00020a60: 6368 6f20 6865 6c6c 6f0a 2020 2020 2020  cho hello.      
+00020a70: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+00020a80: 7074 696f 6e3a 2027 4120 6e65 7720 6465  ption: 'A new de
+00020a90: 7363 7269 7074 696f 6e20 6f66 2074 6865  scription of the
+00020aa0: 2074 6865 2061 6d61 7a69 6e67 2053 6572   the amazing Ser
+00020ab0: 7620 7365 7276 6963 652e 0a0a 2020 2020  v service...    
+00020ac0: 2020 2020 2020 2020 2020 2020 2020 270a                '.
+00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ae0: 656e 7669 726f 6e6d 656e 743a 0a20 2020  environment:.   
+00020af0: 2020 2020 2020 2020 2020 2020 2020 204b                 K
+00020b00: 4559 313a 2056 414c 5545 340a 2020 2020  EY1: VALUE4.    
+00020b10: 2020 2020 2020 2020 2020 2020 2020 4b45                KE
+00020b20: 5932 3a20 5641 4c55 4532 0a20 2020 2020  Y2: VALUE2.     
+00020b30: 2020 2020 2020 2020 2020 2020 204b 4559               KEY
+00020b40: 333a 2056 414c 5545 330a 2020 2020 2020  3: VALUE3.      
+00020b50: 2020 2020 2020 2020 2020 6772 6f75 703a            group:
+00020b60: 2067 726f 7570 320a 2020 2020 2020 2020   group2.        
+00020b70: 2020 2020 2020 2020 6772 6f75 702d 6964          group-id
+00020b80: 3a20 6772 6f75 7049 4432 0a20 2020 2020  : groupID2.     
+00020b90: 2020 2020 2020 2020 2020 206f 6e2d 6368             on-ch
+00020ba0: 6563 6b2d 6661 696c 7572 653a 0a20 2020  eck-failure:.   
+00020bb0: 2020 2020 2020 2020 2020 2020 2020 204b                 K
+00020bc0: 4559 313a 2056 414c 5545 340a 2020 2020  EY1: VALUE4.    
+00020bd0: 2020 2020 2020 2020 2020 2020 2020 4b45                KE
+00020be0: 5932 3a20 5641 4c55 4532 0a20 2020 2020  Y2: VALUE2.     
+00020bf0: 2020 2020 2020 2020 2020 2020 204b 4559               KEY
+00020c00: 333a 2056 414c 5545 330a 2020 2020 2020  3: VALUE3.      
+00020c10: 2020 2020 2020 2020 2020 6f6e 2d66 6169            on-fai
+00020c20: 6c75 7265 3a20 7468 696e 6732 0a20 2020  lure: thing2.   
+00020c30: 2020 2020 2020 2020 2020 2020 206f 6e2d               on-
+00020c40: 7375 6363 6573 733a 2074 6869 6e67 320a  success: thing2.
+00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c60: 6f76 6572 7269 6465 3a20 6d65 7267 650a  override: merge.
+00020c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c80: 7265 7175 6972 6573 3a0a 2020 2020 2020  requires:.      
+00020c90: 2020 2020 2020 2020 2020 2d20 7468 696e            - thin
+00020ca0: 6731 0a20 2020 2020 2020 2020 2020 2020  g1.             
+00020cb0: 2020 202d 2074 6869 6e67 320a 2020 2020     - thing2.    
+00020cc0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00020cd0: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
+00020ce0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+00020cf0: 6d61 7279 3a20 5365 7276 0a20 2020 2020  mary: Serv.     
+00020d00: 2020 2020 2020 2020 2020 2075 7365 723a             user:
+00020d10: 2075 7365 7232 0a20 2020 2020 2020 2020   user2.         
+00020d20: 2020 2020 2020 2075 7365 722d 6964 3a20         user-id: 
+00020d30: 7573 6572 4944 320a 2020 2020 2020 2020  userID2.        
+00020d40: 2020 2020 2727 2729 2c20 706c 616e 2e74      '''), plan.t
+00020d50: 6f5f 7961 6d6c 2829 290a 0a20 2020 2064  o_yaml())..    d
+00020d60: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
+00020d70: 725f 6e6f 745f 636f 6d62 696e 6564 2873  r_not_combined(s
+00020d80: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
+00020d90: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
+00020da0: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
+00020db0: 0a20 2020 2020 2020 2070 6c61 6e20 3d20  .        plan = 
+00020dc0: 636c 6965 6e74 2e67 6574 5f70 6c61 6e28  client.get_plan(
+00020dd0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00020de0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+00020df0: 706c 616e 2c20 7065 6262 6c65 2e50 6c61  plan, pebble.Pla
+00020e00: 6e29 0a20 2020 2020 2020 2073 656c 662e  n).        self.
+00020e10: 6173 7365 7274 4571 7561 6c28 277b 7d5c  assertEqual('{}\
+00020e20: 6e27 2c20 706c 616e 2e74 6f5f 7961 6d6c  n', plan.to_yaml
+00020e30: 2829 290a 2020 2020 2020 2020 7365 7276  ()).        serv
+00020e40: 6963 6520 3d20 7465 7874 7772 6170 2e64  ice = textwrap.d
+00020e50: 6564 656e 7428 2727 275c 0a20 2020 2020  edent('''\.     
+00020e60: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00020e70: 466f 6f0a 2020 2020 2020 2020 2020 2020  Foo.            
+00020e80: 6465 7363 7269 7074 696f 6e3a 207c 0a20  description: |. 
+00020e90: 2020 2020 2020 2020 2020 2020 2041 206c               A l
+00020ea0: 6f6e 6765 7220 6465 7363 7269 7074 696f  onger descriptio
+00020eb0: 6e20 6162 6f75 7420 466f 6f0a 2020 2020  n about Foo.    
+00020ec0: 2020 2020 2020 2020 7365 7276 6963 6573          services
+00020ed0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020ee0: 7365 7276 3a0a 2020 2020 2020 2020 2020  serv:.          
+00020ef0: 2020 2020 2020 7375 6d6d 6172 793a 2053        summary: S
+00020f00: 6572 760a 2020 2020 2020 2020 2020 2020  erv.            
+00020f10: 2020 2020 6465 7363 7269 7074 696f 6e3a      description:
+00020f20: 207c 0a20 2020 2020 2020 2020 2020 2020   |.             
+00020f30: 2020 2020 2041 2064 6573 6372 6970 7469       A descripti
+00020f40: 6f6e 2061 626f 7574 2053 6572 7620 7468  on about Serv th
+00020f50: 6520 616d 617a 696e 6720 7365 7276 6963  e amazing servic
+00020f60: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+00020f70: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
+00020f80: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
+00020f90: 2020 2020 6f76 6572 7269 6465 3a20 7265      override: re
+00020fa0: 706c 6163 650a 2020 2020 2020 2020 2020  place.          
+00020fb0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+00020fc0: 2f62 696e 2f65 6368 6f20 6865 6c6c 6f27  /bin/echo hello'
+00020fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020fe0: 2065 6e76 6972 6f6e 6d65 6e74 3a0a 2020   environment:.  
+00020ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021000: 4b45 593a 2056 414c 5545 0a20 2020 2020  KEY: VALUE.     
+00021010: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+00021020: 2020 2020 636c 6965 6e74 2e61 6464 5f6c      client.add_l
+00021030: 6179 6572 2827 666f 6f27 2c20 7065 6262  ayer('foo', pebb
+00021040: 6c65 2e4c 6179 6572 2873 6572 7669 6365  le.Layer(service
+00021050: 2929 0a20 2020 2020 2020 2023 2054 4f44  )).        # TOD
+00021060: 4f3a 206a 616d 2032 3032 312d 3034 2d31  O: jam 2021-04-1
+00021070: 3920 5765 2073 686f 756c 6420 6861 7665  9 We should have
+00021080: 2061 2063 6c65 6172 6572 2065 7272 6f72   a clearer error
+00021090: 2074 7970 6520 666f 7220 7468 6973 2063   type for this c
+000210a0: 6173 652e 2054 6865 2061 6374 7561 6c0a  ase. The actual.
+000210b0: 2020 2020 2020 2020 2320 2070 6562 626c          #  pebbl
+000210c0: 6520 7261 6973 6573 2061 6e20 4854 5450  e raises an HTTP
+000210d0: 2065 7863 6570 7469 6f6e 2e20 5365 6520   exception. See 
+000210e0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+000210f0: 6f6d 2f63 616e 6f6e 6963 616c 2f6f 7065  om/canonical/ope
+00021100: 7261 746f 722f 6973 7375 6573 2f35 3134  rator/issues/514
+00021110: 0a20 2020 2020 2020 2023 2020 7468 6174  .        #  that
+00021120: 2074 6869 7320 7368 6f75 6c64 2062 6520   this should be 
+00021130: 636c 6561 6e65 6420 7570 2069 6e74 6f20  cleaned up into 
+00021140: 6120 636c 6561 7265 7220 6572 726f 7220  a clearer error 
+00021150: 7479 7065 2c20 686f 7765 7665 722c 2074  type, however, t
+00021160: 6865 7920 7368 6f75 6c64 2067 6574 2061  hey should get a
+00021170: 6e0a 2020 2020 2020 2020 2320 2065 7272  n.        #  err
+00021180: 6f72 0a20 2020 2020 2020 2077 6974 6820  or.        with 
+00021190: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+000211a0: 7328 5275 6e74 696d 6545 7272 6f72 293a  s(RuntimeError):
+000211b0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+000211c0: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
+000211d0: 6f6f 272c 2070 6562 626c 652e 4c61 7965  oo', pebble.Laye
+000211e0: 7228 7365 7276 6963 6529 290a 0a20 2020  r(service))..   
+000211f0: 2064 6566 2074 6573 745f 6164 645f 6c61   def test_add_la
+00021200: 7965 725f 7468 7265 655f 7365 7276 6963  yer_three_servic
+00021210: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
+00021220: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
+00021230: 6765 745f 7465 7374 696e 675f 636c 6965  get_testing_clie
+00021240: 6e74 2829 0a20 2020 2020 2020 2063 6c69  nt().        cli
+00021250: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
+00021260: 6f6f 272c 2027 2727 5c0a 2020 2020 2020  oo', '''\.      
+00021270: 2020 2020 2020 7375 6d6d 6172 793a 2066        summary: f
+00021280: 6f6f 0a20 2020 2020 2020 2020 2020 2073  oo.            s
+00021290: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
+000212a0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+000212b0: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+000212c0: 6172 793a 2046 6f6f 0a20 2020 2020 2020  ary: Foo.       
+000212d0: 2020 2020 2020 2020 2073 7461 7274 7570           startup
+000212e0: 3a20 656e 6162 6c65 640a 2020 2020 2020  : enabled.      
+000212f0: 2020 2020 2020 2020 2020 6f76 6572 7269            overri
+00021300: 6465 3a20 7265 706c 6163 650a 2020 2020  de: replace.    
+00021310: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+00021320: 616e 643a 2027 2f62 696e 2f65 6368 6f20  and: '/bin/echo 
+00021330: 666f 6f27 0a20 2020 2020 2020 2020 2020  foo'.           
+00021340: 2027 2727 290a 2020 2020 2020 2020 636c   ''').        cl
+00021350: 6965 6e74 2e61 6464 5f6c 6179 6572 2827  ient.add_layer('
+00021360: 6261 7227 2c20 2727 275c 0a20 2020 2020  bar', '''\.     
+00021370: 2020 2020 2020 2073 756d 6d61 7279 3a20         summary: 
+00021380: 6261 720a 2020 2020 2020 2020 2020 2020  bar.            
+00021390: 7365 7276 6963 6573 3a0a 2020 2020 2020  services:.      
+000213a0: 2020 2020 2020 2020 6261 723a 0a20 2020          bar:.   
+000213b0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+000213c0: 6d61 7279 3a20 5468 6520 4772 6561 7420  mary: The Great 
+000213d0: 4261 720a 2020 2020 2020 2020 2020 2020  Bar.            
+000213e0: 2020 2020 7374 6172 7475 703a 2065 6e61      startup: ena
+000213f0: 626c 6564 0a20 2020 2020 2020 2020 2020  bled.           
+00021400: 2020 2020 206f 7665 7272 6964 653a 2072       override: r
+00021410: 6570 6c61 6365 0a20 2020 2020 2020 2020  eplace.         
+00021420: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+00021430: 272f 6269 6e2f 6563 686f 2062 6172 270a  '/bin/echo bar'.
+00021440: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+00021450: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00021460: 6164 645f 6c61 7965 7228 2762 617a 272c  add_layer('baz',
+00021470: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
+00021480: 2020 7375 6d6d 6172 793a 2062 617a 0a20    summary: baz. 
+00021490: 2020 2020 2020 2020 2020 2073 6572 7669             servi
+000214a0: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+000214b0: 2020 2062 617a 3a0a 2020 2020 2020 2020     baz:.        
+000214c0: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+000214d0: 204e 6f74 2042 6172 2c20 6275 7420 4261   Not Bar, but Ba
+000214e0: 7a0a 2020 2020 2020 2020 2020 2020 2020  z.              
+000214f0: 2020 7374 6172 7475 703a 2065 6e61 626c    startup: enabl
+00021500: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+00021510: 2020 206f 7665 7272 6964 653a 2072 6570     override: rep
+00021520: 6c61 6365 0a20 2020 2020 2020 2020 2020  lace.           
+00021530: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
+00021540: 6269 6e2f 6563 686f 2062 617a 270a 2020  bin/echo baz'.  
+00021550: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+00021560: 2020 2020 2020 2070 6c61 6e20 3d20 636c         plan = cl
+00021570: 6965 6e74 2e67 6574 5f70 6c61 6e28 290a  ient.get_plan().
+00021580: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
+00021590: 4469 6666 203d 2031 3030 300a 2020 2020  Diff = 1000.    
+000215a0: 2020 2020 2320 416c 7068 6162 6574 6963      # Alphabetic
+000215b0: 616c 2073 6572 7669 6365 732c 2061 6e64  al services, and
+000215c0: 2074 6865 2059 414d 4c20 7368 6f75 6c64   the YAML should
+000215d0: 2062 6520 6e6f 726d 616c 697a 6564 0a20   be normalized. 
+000215e0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000215f0: 7274 4571 7561 6c28 7465 7874 7772 6170  rtEqual(textwrap
+00021600: 2e64 6564 656e 7428 2727 275c 0a20 2020  .dedent('''\.   
+00021610: 2020 2020 2020 2020 2073 6572 7669 6365           service
+00021620: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00021630: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
+00021640: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
+00021650: 6269 6e2f 6563 686f 2062 6172 0a20 2020  bin/echo bar.   
+00021660: 2020 2020 2020 2020 2020 2020 206f 7665               ove
+00021670: 7272 6964 653a 2072 6570 6c61 6365 0a20  rride: replace. 
+00021680: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00021690: 7461 7274 7570 3a20 656e 6162 6c65 640a  tartup: enabled.
+000216a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000216b0: 7375 6d6d 6172 793a 2054 6865 2047 7265  summary: The Gre
+000216c0: 6174 2042 6172 0a20 2020 2020 2020 2020  at Bar.         
+000216d0: 2020 2020 2062 617a 3a0a 2020 2020 2020       baz:.      
+000216e0: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+000216f0: 643a 202f 6269 6e2f 6563 686f 2062 617a  d: /bin/echo baz
+00021700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021710: 206f 7665 7272 6964 653a 2072 6570 6c61   override: repla
+00021720: 6365 0a20 2020 2020 2020 2020 2020 2020  ce.             
+00021730: 2020 2073 7461 7274 7570 3a20 656e 6162     startup: enab
+00021740: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
+00021750: 2020 2020 7375 6d6d 6172 793a 204e 6f74      summary: Not
+00021760: 2042 6172 2c20 6275 7420 4261 7a0a 2020   Bar, but Baz.  
+00021770: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
+00021780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021790: 2063 6f6d 6d61 6e64 3a20 2f62 696e 2f65   command: /bin/e
+000217a0: 6368 6f20 666f 6f0a 2020 2020 2020 2020  cho foo.        
+000217b0: 2020 2020 2020 2020 6f76 6572 7269 6465          override
+000217c0: 3a20 7265 706c 6163 650a 2020 2020 2020  : replace.      
+000217d0: 2020 2020 2020 2020 2020 7374 6172 7475            startu
+000217e0: 703a 2065 6e61 626c 6564 0a20 2020 2020  p: enabled.     
+000217f0: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00021800: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
+00021810: 2020 2020 2727 2729 2c20 706c 616e 2e74      '''), plan.t
+00021820: 6f5f 7961 6d6c 2829 290a 0a20 2020 2064  o_yaml())..    d
+00021830: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
+00021840: 725f 636f 6d62 696e 655f 6e6f 5f6f 7665  r_combine_no_ove
+00021850: 7272 6964 6528 7365 6c66 293a 0a20 2020  rride(self):.   
+00021860: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
+00021870: 6c66 2e67 6574 5f74 6573 7469 6e67 5f63  lf.get_testing_c
+00021880: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
+00021890: 636c 6965 6e74 2e61 6464 5f6c 6179 6572  client.add_layer
+000218a0: 2827 666f 6f27 2c20 2727 275c 0a20 2020  ('foo', '''\.   
+000218b0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+000218c0: 3a20 666f 6f0a 2020 2020 2020 2020 2020  : foo.          
+000218d0: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
+000218e0: 2020 2020 2020 2020 2020 666f 6f3a 0a20            foo:. 
+000218f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00021900: 756d 6d61 7279 3a20 466f 6f0a 2020 2020  ummary: Foo.    
+00021910: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+00021920: 2027 2f62 696e 2f65 6368 6f20 666f 6f27   '/bin/echo foo'
+00021930: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00021940: 290a 2020 2020 2020 2020 2320 544f 444f  ).        # TODO
+00021950: 3a20 6a61 6d20 3230 3231 2d30 342d 3139  : jam 2021-04-19
+00021960: 2050 6562 626c 6520 6375 7272 656e 746c   Pebble currentl
+00021970: 7920 7261 6973 6573 2061 2048 5454 5020  y raises a HTTP 
+00021980: 4572 726f 7220 3530 3020 496e 7465 726e  Error 500 Intern
+00021990: 616c 2053 6572 7669 6365 2045 7272 6f72  al Service Error
+000219a0: 0a20 2020 2020 2020 2023 2020 6966 2079  .        #  if y
+000219b0: 6f75 2064 6f6e 2774 2073 7570 706c 7920  ou don't supply 
+000219c0: 616e 206f 7665 7272 6964 6520 6469 7265  an override dire
+000219d0: 6374 6976 652e 2054 6861 7420 6e65 6564  ctive. That need
+000219e0: 7320 746f 2062 6520 6669 7865 6420 616e  s to be fixed an
+000219f0: 6420 7468 6973 2074 6573 740a 2020 2020  d this test.    
+00021a00: 2020 2020 2320 2073 686f 756c 6420 6265      #  should be
+00021a10: 2075 7064 6174 6564 2e20 6874 7470 733a   updated. https:
+00021a20: 2f2f 6769 7468 7562 2e63 6f6d 2f63 616e  //github.com/can
+00021a30: 6f6e 6963 616c 2f6f 7065 7261 746f 722f  onical/operator/
+00021a40: 6973 7375 6573 2f35 3134 0a20 2020 2020  issues/514.     
+00021a50: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00021a60: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+00021a70: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00021a80: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
+00021a90: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
+00021aa0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00021ab0: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
+00021ac0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00021ad0: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
+00021ae0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+00021af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b00: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
+00021b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021b20: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
+00021b30: 6269 6e2f 6563 686f 2066 6f6f 270a 2020  bin/echo foo'.  
+00021b40: 2020 2020 2020 2020 2020 2020 2020 2727                ''
+00021b50: 272c 2063 6f6d 6269 6e65 3d54 7275 6529  ', combine=True)
+00021b60: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+00021b70: 6464 5f6c 6179 6572 5f63 6f6d 6269 6e65  dd_layer_combine
+00021b80: 5f6f 7665 7272 6964 655f 7265 706c 6163  _override_replac
+00021b90: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00021ba0: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
+00021bb0: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
+00021bc0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
+00021bd0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
+00021be0: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
+00021bf0: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
+00021c00: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
+00021c10: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
+00021c20: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
+00021c30: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00021c40: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
+00021c50: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+00021c60: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
+00021c70: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
+00021c80: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
+00021c90: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
+00021ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021cb0: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
+00021cc0: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
+00021cd0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00021ce0: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
+00021cf0: 7965 7228 2766 6f6f 272c 2027 2727 5c0a  yer('foo', '''\.
+00021d00: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00021d10: 6172 793a 2066 6f6f 0a20 2020 2020 2020  ary: foo.       
+00021d20: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
+00021d30: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
+00021d40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021d50: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
+00021d60: 2f65 6368 6f20 666f 6f20 6e65 7727 0a20  /echo foo new'. 
+00021d70: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00021d80: 7665 7272 6964 653a 2072 6570 6c61 6365  verride: replace
+00021d90: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00021da0: 2c20 636f 6d62 696e 653d 5472 7565 290a  , combine=True).
+00021db0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00021dc0: 6572 7445 7175 616c 2874 6578 7477 7261  ertEqual(textwra
+00021dd0: 702e 6465 6465 6e74 2827 2727 5c0a 2020  p.dedent('''\.  
+00021de0: 2020 2020 2020 2020 2020 7365 7276 6963            servic
+00021df0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00021e00: 2020 6261 723a 0a20 2020 2020 2020 2020    bar:.         
+00021e10: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+00021e20: 2f62 696e 2f65 6368 6f20 6261 720a 2020  /bin/echo bar.  
+00021e30: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00021e40: 6d6d 6172 793a 2042 6172 0a20 2020 2020  mmary: Bar.     
+00021e50: 2020 2020 2020 2020 2066 6f6f 3a0a 2020           foo:.  
+00021e60: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00021e70: 6d6d 616e 643a 202f 6269 6e2f 6563 686f  mmand: /bin/echo
+00021e80: 2066 6f6f 206e 6577 0a20 2020 2020 2020   foo new.       
+00021e90: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
+00021ea0: 653a 2072 6570 6c61 6365 0a20 2020 2020  e: replace.     
+00021eb0: 2020 2020 2020 2027 2727 292c 2063 6c69         '''), cli
+00021ec0: 656e 742e 6765 745f 706c 616e 2829 2e74  ent.get_plan().t
+00021ed0: 6f5f 7961 6d6c 2829 290a 0a20 2020 2064  o_yaml())..    d
+00021ee0: 6566 2074 6573 745f 6164 645f 6c61 7965  ef test_add_laye
+00021ef0: 725f 636f 6d62 696e 655f 6f76 6572 7269  r_combine_overri
+00021f00: 6465 5f6d 6572 6765 2873 656c 6629 3a0a  de_merge(self):.
+00021f10: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+00021f20: 2073 656c 662e 6765 745f 7465 7374 696e   self.get_testin
+00021f30: 675f 636c 6965 6e74 2829 0a20 2020 2020  g_client().     
+00021f40: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
+00021f50: 7965 7228 2766 6f6f 272c 2027 2727 5c0a  yer('foo', '''\.
+00021f60: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00021f70: 6172 793a 2066 6f6f 0a20 2020 2020 2020  ary: foo.       
+00021f80: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
+00021f90: 2020 2020 2020 2020 2020 2020 2062 6172               bar
+00021fa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021fb0: 2020 7375 6d6d 6172 793a 2042 6172 0a20    summary: Bar. 
+00021fc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00021fd0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
+00021fe0: 686f 2062 6172 270a 2020 2020 2020 2020  ho bar'.        
+00021ff0: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
+00022000: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00022010: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
+00022020: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+00022030: 2027 2f62 696e 2f65 6368 6f20 666f 6f27   '/bin/echo foo'
+00022040: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00022050: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
+00022060: 2e61 6464 5f6c 6179 6572 2827 666f 6f27  .add_layer('foo'
+00022070: 2c20 2727 275c 0a20 2020 2020 2020 2020  , '''\.         
+00022080: 2020 2073 756d 6d61 7279 3a20 666f 6f0a     summary: foo.
+00022090: 2020 2020 2020 2020 2020 2020 7365 7276              serv
+000220a0: 6963 6573 3a0a 2020 2020 2020 2020 2020  ices:.          
+000220b0: 2020 2020 666f 6f3a 0a20 2020 2020 2020      foo:.       
+000220c0: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+000220d0: 3a20 466f 6f0a 2020 2020 2020 2020 2020  : Foo.          
+000220e0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+000220f0: 2f62 696e 2f65 6368 6f20 666f 6f62 270a  /bin/echo foob'.
+00022100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022110: 6f76 6572 7269 6465 3a20 6d65 7267 650a  override: merge.
+00022120: 2020 2020 2020 2020 2020 2020 2727 272c              ''',
+00022130: 2063 6f6d 6269 6e65 3d54 7275 6529 0a20   combine=True). 
+00022140: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00022150: 7274 4571 7561 6c28 7465 7874 7772 6170  rtEqual(textwrap
+00022160: 2e64 6564 656e 7428 2727 275c 0a20 2020  .dedent('''\.   
+00022170: 2020 2020 2020 2020 2073 6572 7669 6365           service
+00022180: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00022190: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
+000221a0: 2020 2020 2020 636f 6d6d 616e 643a 202f        command: /
+000221b0: 6269 6e2f 6563 686f 2062 6172 0a20 2020  bin/echo bar.   
+000221c0: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+000221d0: 6d61 7279 3a20 4261 720a 2020 2020 2020  mary: Bar.      
+000221e0: 2020 2020 2020 2020 666f 6f3a 0a20 2020          foo:.   
+000221f0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00022200: 6d61 6e64 3a20 2f62 696e 2f65 6368 6f20  mand: /bin/echo 
+00022210: 666f 6f62 0a20 2020 2020 2020 2020 2020  foob.           
+00022220: 2020 2020 206f 7665 7272 6964 653a 206d       override: m
+00022230: 6572 6765 0a20 2020 2020 2020 2020 2020  erge.           
+00022240: 2020 2020 2073 756d 6d61 7279 3a20 466f       summary: Fo
+00022250: 6f0a 2020 2020 2020 2020 2020 2020 2727  o.            ''
+00022260: 2729 2c20 636c 6965 6e74 2e67 6574 5f70  '), client.get_p
+00022270: 6c61 6e28 292e 746f 5f79 616d 6c28 2929  lan().to_yaml())
+00022280: 0a0a 2020 2020 6465 6620 7465 7374 5f61  ..    def test_a
+00022290: 6464 5f6c 6179 6572 5f63 6f6d 6269 6e65  dd_layer_combine
+000222a0: 5f6f 7665 7272 6964 655f 756e 6b6e 6f77  _override_unknow
+000222b0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+000222c0: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
+000222d0: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
+000222e0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
+000222f0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
+00022300: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
+00022310: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
+00022320: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
+00022330: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
+00022340: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
+00022350: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00022360: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
+00022370: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+00022380: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
+00022390: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
+000223a0: 6f6f 3a0a 2020 2020 2020 2020 2020 2020  oo:.            
+000223b0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
+000223c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000223d0: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
+000223e0: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
+000223f0: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00022400: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00022410: 6572 7452 6169 7365 7328 5275 6e74 696d  ertRaises(Runtim
+00022420: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00022430: 2020 2020 2063 6c69 656e 742e 6164 645f       client.add_
+00022440: 6c61 7965 7228 2766 6f6f 272c 2027 2727  layer('foo', '''
+00022450: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00022460: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
+00022470: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00022480: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
+00022490: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+000224a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000224b0: 2020 2020 7375 6d6d 6172 793a 2046 6f6f      summary: Foo
+000224c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000224d0: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
+000224e0: 6269 6e2f 6563 686f 2066 6f6f 6227 0a20  bin/echo foob'. 
+000224f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022500: 2020 206f 7665 7272 6964 653a 2062 6c61     override: bla
+00022510: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+00022520: 2020 2727 272c 2063 6f6d 6269 6e65 3d54    ''', combine=T
+00022530: 7275 6529 0a0a 2020 2020 6465 6620 7465  rue)..    def te
+00022540: 7374 5f67 6574 5f73 6572 7669 6365 735f  st_get_services_
+00022550: 6e6f 6e65 2873 656c 6629 3a0a 2020 2020  none(self):.    
+00022560: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
+00022570: 662e 6765 745f 7465 7374 696e 675f 636c  f.get_testing_cl
+00022580: 6965 6e74 2829 0a20 2020 2020 2020 2073  ient().        s
+00022590: 6572 7669 6365 5f69 6e66 6f20 3d20 636c  ervice_info = cl
+000225a0: 6965 6e74 2e67 6574 5f73 6572 7669 6365  ient.get_service
+000225b0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
+000225c0: 2e61 7373 6572 7445 7175 616c 285b 5d2c  .assertEqual([],
+000225d0: 2073 6572 7669 6365 5f69 6e66 6f29 0a0a   service_info)..
+000225e0: 2020 2020 6465 6620 7465 7374 5f67 6574      def test_get
+000225f0: 5f73 6572 7669 6365 735f 6e6f 745f 7374  _services_not_st
+00022600: 6172 7465 6428 7365 6c66 293a 0a20 2020  arted(self):.   
+00022610: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
+00022620: 6c66 2e67 6574 5f74 6573 7469 6e67 5f63  lf.get_testing_c
+00022630: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
+00022640: 636c 6965 6e74 2e61 6464 5f6c 6179 6572  client.add_layer
+00022650: 2827 666f 6f27 2c20 2727 275c 0a20 2020  ('foo', '''\.   
+00022660: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+00022670: 3a20 666f 6f0a 2020 2020 2020 2020 2020  : foo.          
+00022680: 2020 7365 7276 6963 6573 3a0a 2020 2020    services:.    
+00022690: 2020 2020 2020 2020 2020 666f 6f3a 0a20            foo:. 
+000226a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000226b0: 756d 6d61 7279 3a20 466f 6f0a 2020 2020  ummary: Foo.    
+000226c0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+000226d0: 7475 703a 2065 6e61 626c 6564 0a20 2020  tup: enabled.   
+000226e0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+000226f0: 6d61 6e64 3a20 272f 6269 6e2f 6563 686f  mand: '/bin/echo
+00022700: 2066 6f6f 270a 2020 2020 2020 2020 2020   foo'.          
+00022710: 2020 2020 6261 723a 0a20 2020 2020 2020      bar:.       
+00022720: 2020 2020 2020 2020 2073 756d 6d61 7279           summary
+00022730: 3a20 4261 720a 2020 2020 2020 2020 2020  : Bar.          
+00022740: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+00022750: 2f62 696e 2f65 6368 6f20 6261 7227 0a20  /bin/echo bar'. 
+00022760: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00022770: 2020 2020 2020 2020 696e 666f 7320 3d20          infos = 
+00022780: 636c 6965 6e74 2e67 6574 5f73 6572 7669  client.get_servi
+00022790: 6365 7328 290a 2020 2020 2020 2020 7365  ces().        se
+000227a0: 6c66 2e61 7373 6572 7445 7175 616c 286c  lf.assertEqual(l
+000227b0: 656e 2869 6e66 6f73 292c 2032 290a 2020  en(infos), 2).  
+000227c0: 2020 2020 2020 6261 725f 696e 666f 203d        bar_info =
+000227d0: 2069 6e66 6f73 5b30 5d0a 2020 2020 2020   infos[0].      
+000227e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000227f0: 616c 2827 6261 7227 2c20 6261 725f 696e  al('bar', bar_in
+00022800: 666f 2e6e 616d 6529 0a20 2020 2020 2020  fo.name).       
+00022810: 2023 2044 6566 6175 6c74 2077 6865 6e20   # Default when 
+00022820: 6e6f 7420 7370 6563 6966 6965 6420 6973  not specified is
+00022830: 2044 4953 4142 4c45 440a 2020 2020 2020   DISABLED.      
+00022840: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00022850: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
+00022860: 6553 7461 7274 7570 2e44 4953 4142 4c45  eStartup.DISABLE
+00022870: 442c 2062 6172 5f69 6e66 6f2e 7374 6172  D, bar_info.star
+00022880: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
+00022890: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
+000228a0: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
+000228b0: 7573 2e49 4e41 4354 4956 452c 2062 6172  us.INACTIVE, bar
+000228c0: 5f69 6e66 6f2e 6375 7272 656e 7429 0a20  _info.current). 
+000228d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000228e0: 7274 4661 6c73 6528 6261 725f 696e 666f  rtFalse(bar_info
+000228f0: 2e69 735f 7275 6e6e 696e 6728 2929 0a20  .is_running()). 
+00022900: 2020 2020 2020 2066 6f6f 5f69 6e66 6f20         foo_info 
+00022910: 3d20 696e 666f 735b 315d 0a20 2020 2020  = infos[1].     
+00022920: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00022930: 7561 6c28 2766 6f6f 272c 2066 6f6f 5f69  ual('foo', foo_i
+00022940: 6e66 6f2e 6e61 6d65 290a 2020 2020 2020  nfo.name).      
+00022950: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00022960: 616c 2870 6562 626c 652e 5365 7276 6963  al(pebble.Servic
+00022970: 6553 7461 7274 7570 2e45 4e41 424c 4544  eStartup.ENABLED
+00022980: 2c20 666f 6f5f 696e 666f 2e73 7461 7274  , foo_info.start
+00022990: 7570 290a 2020 2020 2020 2020 7365 6c66  up).        self
+000229a0: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
+000229b0: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
+000229c0: 732e 494e 4143 5449 5645 2c20 666f 6f5f  s.INACTIVE, foo_
+000229d0: 696e 666f 2e63 7572 7265 6e74 290a 2020  info.current).  
+000229e0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+000229f0: 7446 616c 7365 2866 6f6f 5f69 6e66 6f2e  tFalse(foo_info.
+00022a00: 6973 5f72 756e 6e69 6e67 2829 290a 0a20  is_running()).. 
+00022a10: 2020 2064 6566 2074 6573 745f 6765 745f     def test_get_
+00022a20: 7365 7276 6963 6573 5f61 7574 6f73 7461  services_autosta
+00022a30: 7274 2873 656c 6629 3a0a 2020 2020 2020  rt(self):.      
+00022a40: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
+00022a50: 6765 745f 7465 7374 696e 675f 636c 6965  get_testing_clie
+00022a60: 6e74 2829 0a20 2020 2020 2020 2063 6c69  nt().        cli
+00022a70: 656e 742e 6164 645f 6c61 7965 7228 2766  ent.add_layer('f
+00022a80: 6f6f 272c 2027 2727 5c0a 2020 2020 2020  oo', '''\.      
+00022a90: 2020 2020 2020 7375 6d6d 6172 793a 2066        summary: f
+00022aa0: 6f6f 0a20 2020 2020 2020 2020 2020 2073  oo.            s
+00022ab0: 6572 7669 6365 733a 0a20 2020 2020 2020  ervices:.       
+00022ac0: 2020 2020 2020 2066 6f6f 3a0a 2020 2020         foo:.    
+00022ad0: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00022ae0: 6172 793a 2046 6f6f 0a20 2020 2020 2020  ary: Foo.       
+00022af0: 2020 2020 2020 2020 2073 7461 7274 7570           startup
+00022b00: 3a20 656e 6162 6c65 640a 2020 2020 2020  : enabled.      
+00022b10: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+00022b20: 643a 2027 2f62 696e 2f65 6368 6f20 666f  d: '/bin/echo fo
+00022b30: 6f27 0a20 2020 2020 2020 2020 2020 2020  o'.             
+00022b40: 2062 6172 3a0a 2020 2020 2020 2020 2020   bar:.          
+00022b50: 2020 2020 2020 7375 6d6d 6172 793a 2042        summary: B
+00022b60: 6172 0a20 2020 2020 2020 2020 2020 2020  ar.             
+00022b70: 2020 2063 6f6d 6d61 6e64 3a20 272f 6269     command: '/bi
+00022b80: 6e2f 6563 686f 2062 6172 270a 2020 2020  n/echo bar'.    
+00022b90: 2020 2020 2020 2020 2727 2729 0a20 2020          ''').   
+00022ba0: 2020 2020 2063 6c69 656e 742e 6175 746f       client.auto
+00022bb0: 7374 6172 745f 7365 7276 6963 6573 2829  start_services()
+00022bc0: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
+00022bd0: 2063 6c69 656e 742e 6765 745f 7365 7276   client.get_serv
+00022be0: 6963 6573 2829 0a20 2020 2020 2020 2073  ices().        s
+00022bf0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00022c00: 6c65 6e28 696e 666f 7329 2c20 3229 0a20  len(infos), 2). 
+00022c10: 2020 2020 2020 2062 6172 5f69 6e66 6f20         bar_info 
+00022c20: 3d20 696e 666f 735b 305d 0a20 2020 2020  = infos[0].     
+00022c30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00022c40: 7561 6c28 2762 6172 272c 2062 6172 5f69  ual('bar', bar_i
+00022c50: 6e66 6f2e 6e61 6d65 290a 2020 2020 2020  nfo.name).      
+00022c60: 2020 2320 4465 6661 756c 7420 7768 656e    # Default when
+00022c70: 206e 6f74 2073 7065 6369 6669 6564 2069   not specified i
+00022c80: 7320 4449 5341 424c 4544 0a20 2020 2020  s DISABLED.     
+00022c90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00022ca0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
+00022cb0: 6365 5374 6172 7475 702e 4449 5341 424c  ceStartup.DISABL
+00022cc0: 4544 2c20 6261 725f 696e 666f 2e73 7461  ED, bar_info.sta
+00022cd0: 7274 7570 290a 2020 2020 2020 2020 7365  rtup).        se
+00022ce0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00022cf0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+00022d00: 7475 732e 494e 4143 5449 5645 2c20 6261  tus.INACTIVE, ba
+00022d10: 725f 696e 666f 2e63 7572 7265 6e74 290a  r_info.current).
+00022d20: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00022d30: 6572 7446 616c 7365 2862 6172 5f69 6e66  ertFalse(bar_inf
+00022d40: 6f2e 6973 5f72 756e 6e69 6e67 2829 290a  o.is_running()).
+00022d50: 2020 2020 2020 2020 666f 6f5f 696e 666f          foo_info
+00022d60: 203d 2069 6e66 6f73 5b31 5d0a 2020 2020   = infos[1].    
+00022d70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00022d80: 7175 616c 2827 666f 6f27 2c20 666f 6f5f  qual('foo', foo_
+00022d90: 696e 666f 2e6e 616d 6529 0a20 2020 2020  info.name).     
+00022da0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00022db0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
+00022dc0: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
+00022dd0: 442c 2066 6f6f 5f69 6e66 6f2e 7374 6172  D, foo_info.star
+00022de0: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
+00022df0: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
+00022e00: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
+00022e10: 7573 2e41 4354 4956 452c 2066 6f6f 5f69  us.ACTIVE, foo_i
+00022e20: 6e66 6f2e 6375 7272 656e 7429 0a20 2020  nfo.current).   
+00022e30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00022e40: 5472 7565 2866 6f6f 5f69 6e66 6f2e 6973  True(foo_info.is
+00022e50: 5f72 756e 6e69 6e67 2829 290a 0a20 2020  _running())..   
+00022e60: 2064 6566 2074 6573 745f 6765 745f 7365   def test_get_se
+00022e70: 7276 6963 6573 5f73 7461 7274 5f73 746f  rvices_start_sto
+00022e80: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
+00022e90: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
+00022ea0: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
+00022eb0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
+00022ec0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
+00022ed0: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
+00022ee0: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
+00022ef0: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
+00022f00: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
+00022f10: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
+00022f20: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00022f30: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
+00022f40: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
+00022f50: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
+00022f60: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+00022f70: 3a20 272f 6269 6e2f 6563 686f 2066 6f6f  : '/bin/echo foo
+00022f80: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00022f90: 6261 723a 0a20 2020 2020 2020 2020 2020  bar:.           
+00022fa0: 2020 2020 2073 756d 6d61 7279 3a20 4261       summary: Ba
+00022fb0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00022fc0: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
+00022fd0: 2f65 6368 6f20 6261 7227 0a20 2020 2020  /echo bar'.     
+00022fe0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+00022ff0: 2020 2020 636c 6965 6e74 2e73 7461 7274      client.start
+00023000: 5f73 6572 7669 6365 7328 5b27 6261 7227  _services(['bar'
+00023010: 5d29 0a20 2020 2020 2020 2069 6e66 6f73  ]).        infos
+00023020: 203d 2063 6c69 656e 742e 6765 745f 7365   = client.get_se
+00023030: 7276 6963 6573 2829 0a20 2020 2020 2020  rvices().       
+00023040: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00023050: 6c28 6c65 6e28 696e 666f 7329 2c20 3229  l(len(infos), 2)
+00023060: 0a20 2020 2020 2020 2062 6172 5f69 6e66  .        bar_inf
+00023070: 6f20 3d20 696e 666f 735b 305d 0a20 2020  o = infos[0].   
+00023080: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00023090: 4571 7561 6c28 2762 6172 272c 2062 6172  Equal('bar', bar
+000230a0: 5f69 6e66 6f2e 6e61 6d65 290a 2020 2020  _info.name).    
+000230b0: 2020 2020 2320 4576 656e 2074 686f 7567      # Even thoug
+000230c0: 6820 6261 7220 6465 6661 756c 7473 2074  h bar defaults t
+000230d0: 6f20 4449 5341 424c 4544 2c20 7765 2065  o DISABLED, we e
+000230e0: 7870 6c69 6369 746c 7920 7374 6172 7465  xplicitly starte
+000230f0: 6420 6974 0a20 2020 2020 2020 2073 656c  d it.        sel
+00023100: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
+00023110: 6262 6c65 2e53 6572 7669 6365 5374 6172  bble.ServiceStar
+00023120: 7475 702e 4449 5341 424c 4544 2c20 6261  tup.DISABLED, ba
+00023130: 725f 696e 666f 2e73 7461 7274 7570 290a  r_info.startup).
+00023140: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00023150: 6572 7445 7175 616c 2870 6562 626c 652e  ertEqual(pebble.
+00023160: 5365 7276 6963 6553 7461 7475 732e 4143  ServiceStatus.AC
+00023170: 5449 5645 2c20 6261 725f 696e 666f 2e63  TIVE, bar_info.c
+00023180: 7572 7265 6e74 290a 2020 2020 2020 2020  urrent).        
+00023190: 2320 666f 6f20 776f 756c 6420 6265 2073  # foo would be s
+000231a0: 7461 7274 6564 2062 7920 6175 746f 7374  tarted by autost
+000231b0: 6172 742c 2062 7574 2077 6520 6f6e 6c79  art, but we only
+000231c0: 2063 616c 6c65 6420 7374 6172 745f 7365   called start_se
+000231d0: 7276 6963 6573 0a20 2020 2020 2020 2066  rvices.        f
+000231e0: 6f6f 5f69 6e66 6f20 3d20 696e 666f 735b  oo_info = infos[
+000231f0: 315d 0a20 2020 2020 2020 2073 656c 662e  1].        self.
+00023200: 6173 7365 7274 4571 7561 6c28 2766 6f6f  assertEqual('foo
+00023210: 272c 2066 6f6f 5f69 6e66 6f2e 6e61 6d65  ', foo_info.name
+00023220: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00023230: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
+00023240: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
+00023250: 2e45 4e41 424c 4544 2c20 666f 6f5f 696e  .ENABLED, foo_in
+00023260: 666f 2e73 7461 7274 7570 290a 2020 2020  fo.startup).    
+00023270: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00023280: 7175 616c 2870 6562 626c 652e 5365 7276  qual(pebble.Serv
+00023290: 6963 6553 7461 7475 732e 494e 4143 5449  iceStatus.INACTI
+000232a0: 5645 2c20 666f 6f5f 696e 666f 2e63 7572  VE, foo_info.cur
+000232b0: 7265 6e74 290a 2020 2020 2020 2020 636c  rent).        cl
+000232c0: 6965 6e74 2e73 746f 705f 7365 7276 6963  ient.stop_servic
+000232d0: 6573 285b 2762 6172 275d 290a 2020 2020  es(['bar']).    
+000232e0: 2020 2020 696e 666f 7320 3d20 636c 6965      infos = clie
+000232f0: 6e74 2e67 6574 5f73 6572 7669 6365 7328  nt.get_services(
+00023300: 290a 2020 2020 2020 2020 6261 725f 696e  ).        bar_in
+00023310: 666f 203d 2069 6e66 6f73 5b30 5d0a 2020  fo = infos[0].  
+00023320: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00023330: 7445 7175 616c 2827 6261 7227 2c20 6261  tEqual('bar', ba
+00023340: 725f 696e 666f 2e6e 616d 6529 0a20 2020  r_info.name).   
+00023350: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00023360: 4571 7561 6c28 7065 6262 6c65 2e53 6572  Equal(pebble.Ser
+00023370: 7669 6365 5374 6172 7475 702e 4449 5341  viceStartup.DISA
+00023380: 424c 4544 2c20 6261 725f 696e 666f 2e73  BLED, bar_info.s
+00023390: 7461 7274 7570 290a 2020 2020 2020 2020  tartup).        
+000233a0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+000233b0: 2870 6562 626c 652e 5365 7276 6963 6553  (pebble.ServiceS
+000233c0: 7461 7475 732e 494e 4143 5449 5645 2c20  tatus.INACTIVE, 
+000233d0: 6261 725f 696e 666f 2e63 7572 7265 6e74  bar_info.current
+000233e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+000233f0: 6765 745f 7365 7276 6963 6573 5f62 6164  get_services_bad
+00023400: 5f72 6571 7565 7374 2873 656c 6629 3a0a  _request(self):.
+00023410: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+00023420: 2073 656c 662e 6765 745f 7465 7374 696e   self.get_testin
+00023430: 675f 636c 6965 6e74 2829 0a20 2020 2020  g_client().     
+00023440: 2020 2063 6c69 656e 742e 6164 645f 6c61     client.add_la
+00023450: 7965 7228 2766 6f6f 272c 2027 2727 5c0a  yer('foo', '''\.
+00023460: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00023470: 6172 793a 2066 6f6f 0a20 2020 2020 2020  ary: foo.       
+00023480: 2020 2020 2073 6572 7669 6365 733a 0a20       services:. 
+00023490: 2020 2020 2020 2020 2020 2020 2066 6f6f               foo
+000234a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000234b0: 2020 7375 6d6d 6172 793a 2046 6f6f 0a20    summary: Foo. 
+000234c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000234d0: 7461 7274 7570 3a20 656e 6162 6c65 640a  tartup: enabled.
+000234e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000234f0: 636f 6d6d 616e 643a 2027 2f62 696e 2f65  command: '/bin/e
+00023500: 6368 6f20 666f 6f27 0a20 2020 2020 2020  cho foo'.       
+00023510: 2020 2020 2020 2062 6172 3a0a 2020 2020         bar:.    
+00023520: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
+00023530: 6172 793a 2042 6172 0a20 2020 2020 2020  ary: Bar.       
+00023540: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+00023550: 3a20 272f 6269 6e2f 6563 686f 2062 6172  : '/bin/echo bar
+00023560: 270a 2020 2020 2020 2020 2020 2020 2727  '.            ''
+00023570: 2729 0a20 2020 2020 2020 2023 2049 7420  ').        # It 
+00023580: 6973 2061 2063 6f6d 6d6f 6e20 6d69 7374  is a common mist
+00023590: 616b 6520 746f 2070 6173 7320 6a75 7374  ake to pass just
+000235a0: 2061 206e 616d 6520 7673 2061 206c 6973   a name vs a lis
+000235b0: 7420 6f66 206e 616d 6573 2c20 736f 2063  t of names, so c
+000235c0: 6174 6368 2069 7420 7769 7468 2061 0a20  atch it with a. 
+000235d0: 2020 2020 2020 2023 2054 7970 6545 7272         # TypeErr
+000235e0: 6f72 0a20 2020 2020 2020 2077 6974 6820  or.        with 
+000235f0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+00023600: 7328 5479 7065 4572 726f 7229 3a0a 2020  s(TypeError):.  
+00023610: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00023620: 2e67 6574 5f73 6572 7669 6365 7328 2766  .get_services('f
+00023630: 6f6f 2729 0a0a 2020 2020 6465 6620 7465  oo')..    def te
+00023640: 7374 5f67 6574 5f73 6572 7669 6365 735f  st_get_services_
+00023650: 7375 6273 6574 2873 656c 6629 3a0a 2020  subset(self):.  
+00023660: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+00023670: 656c 662e 6765 745f 7465 7374 696e 675f  elf.get_testing_
+00023680: 636c 6965 6e74 2829 0a20 2020 2020 2020  client().       
+00023690: 2063 6c69 656e 742e 6164 645f 6c61 7965   client.add_laye
+000236a0: 7228 2766 6f6f 272c 2027 2727 5c0a 2020  r('foo', '''\.  
+000236b0: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+000236c0: 793a 2066 6f6f 0a20 2020 2020 2020 2020  y: foo.         
+000236d0: 2020 2073 6572 7669 6365 733a 0a20 2020     services:.   
+000236e0: 2020 2020 2020 2020 2020 2066 6f6f 3a0a             foo:.
+000236f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023700: 7375 6d6d 6172 793a 2046 6f6f 0a20 2020  summary: Foo.   
+00023710: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00023720: 7274 7570 3a20 656e 6162 6c65 640a 2020  rtup: enabled.  
+00023730: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00023740: 6d6d 616e 643a 2027 2f62 696e 2f65 6368  mmand: '/bin/ech
+00023750: 6f20 666f 6f27 0a20 2020 2020 2020 2020  o foo'.         
+00023760: 2020 2020 2062 6172 3a0a 2020 2020 2020       bar:.      
+00023770: 2020 2020 2020 2020 2020 7375 6d6d 6172            summar
+00023780: 793a 2042 6172 0a20 2020 2020 2020 2020  y: Bar.         
+00023790: 2020 2020 2020 2063 6f6d 6d61 6e64 3a20         command: 
+000237a0: 272f 6269 6e2f 6563 686f 2062 6172 270a  '/bin/echo bar'.
+000237b0: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+000237c0: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
+000237d0: 2063 6c69 656e 742e 6765 745f 7365 7276   client.get_serv
+000237e0: 6963 6573 285b 2766 6f6f 275d 290a 2020  ices(['foo']).  
+000237f0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00023800: 7445 7175 616c 286c 656e 2869 6e66 6f73  tEqual(len(infos
+00023810: 292c 2031 290a 2020 2020 2020 2020 666f  ), 1).        fo
+00023820: 6f5f 696e 666f 203d 2069 6e66 6f73 5b30  o_info = infos[0
+00023830: 5d0a 2020 2020 2020 2020 7365 6c66 2e61  ].        self.a
+00023840: 7373 6572 7445 7175 616c 2827 666f 6f27  ssertEqual('foo'
+00023850: 2c20 666f 6f5f 696e 666f 2e6e 616d 6529  , foo_info.name)
+00023860: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00023870: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
+00023880: 2e53 6572 7669 6365 5374 6172 7475 702e  .ServiceStartup.
+00023890: 454e 4142 4c45 442c 2066 6f6f 5f69 6e66  ENABLED, foo_inf
+000238a0: 6f2e 7374 6172 7475 7029 0a20 2020 2020  o.startup).     
+000238b0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+000238c0: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
+000238d0: 6365 5374 6174 7573 2e49 4e41 4354 4956  ceStatus.INACTIV
+000238e0: 452c 2066 6f6f 5f69 6e66 6f2e 6375 7272  E, foo_info.curr
+000238f0: 656e 7429 0a0a 2020 2020 6465 6620 7465  ent)..    def te
+00023900: 7374 5f67 6574 5f73 6572 7669 6365 735f  st_get_services_
+00023910: 756e 6b6e 6f77 6e28 7365 6c66 293a 0a20  unknown(self):. 
+00023920: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
+00023930: 7365 6c66 2e67 6574 5f74 6573 7469 6e67  self.get_testing
+00023940: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
+00023950: 2020 636c 6965 6e74 2e61 6464 5f6c 6179    client.add_lay
+00023960: 6572 2827 666f 6f27 2c20 2727 275c 0a20  er('foo', '''\. 
+00023970: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00023980: 7279 3a20 666f 6f0a 2020 2020 2020 2020  ry: foo.        
+00023990: 2020 2020 7365 7276 6963 6573 3a0a 2020      services:.  
+000239a0: 2020 2020 2020 2020 2020 2020 666f 6f3a              foo:
+000239b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000239c0: 2073 756d 6d61 7279 3a20 466f 6f0a 2020   summary: Foo.  
+000239d0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000239e0: 6172 7475 703a 2065 6e61 626c 6564 0a20  artup: enabled. 
+000239f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00023a00: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
+00023a10: 686f 2066 6f6f 270a 2020 2020 2020 2020  ho foo'.        
+00023a20: 2020 2020 2020 6261 723a 0a20 2020 2020        bar:.     
+00023a30: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00023a40: 7279 3a20 4261 720a 2020 2020 2020 2020  ry: Bar.        
+00023a50: 2020 2020 2020 2020 636f 6d6d 616e 643a          command:
+00023a60: 2027 2f62 696e 2f65 6368 6f20 6261 7227   '/bin/echo bar'
+00023a70: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+00023a80: 290a 2020 2020 2020 2020 2320 5468 6973  ).        # This
+00023a90: 2064 6f65 736e 2774 2073 6565 6d20 746f   doesn't seem to
+00023aa0: 2062 6520 616e 2065 7272 6f72 2061 7420   be an error at 
+00023ab0: 7468 6520 6d6f 6d65 6e74 2e0a 2020 2020  the moment..    
+00023ac0: 2020 2020 2320 7065 6262 6c65 5f63 6c69      # pebble_cli
+00023ad0: 2e70 7920 7365 7276 6963 6520 6a75 7374  .py service just
+00023ae0: 2072 6574 7572 6e73 2061 6e20 656d 7074   returns an empt
+00023af0: 7920 6c69 7374 0a20 2020 2020 2020 2023  y list.        #
+00023b00: 2070 6562 626c 6520 7365 7276 6963 6520   pebble service 
+00023b10: 756e 6b6e 6f77 6e20 7361 7973 2022 4e6f  unknown says "No
+00023b20: 206d 6174 6368 696e 6720 7365 7276 6963   matching servic
+00023b30: 6573 2220 2862 7574 2065 7869 7473 2030  es" (but exits 0
+00023b40: 290a 2020 2020 2020 2020 696e 666f 7320  ).        infos 
+00023b50: 3d20 636c 6965 6e74 2e67 6574 5f73 6572  = client.get_ser
+00023b60: 7669 6365 7328 5b27 756e 6b6e 6f77 6e27  vices(['unknown'
+00023b70: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00023b80: 6173 7365 7274 4571 7561 6c28 696e 666f  assertEqual(info
+00023b90: 732c 205b 5d29 0a0a 2020 2020 6465 6620  s, [])..    def 
+00023ba0: 7465 7374 5f69 6e76 616c 6964 5f73 7461  test_invalid_sta
+00023bb0: 7274 5f73 6572 7669 6365 2873 656c 6629  rt_service(self)
+00023bc0: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
+00023bd0: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
+00023be0: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
+00023bf0: 2020 2020 2023 2054 4f44 4f3a 206a 616d       # TODO: jam
+00023c00: 2032 3032 312d 3034 2d32 3020 5468 6973   2021-04-20 This
+00023c10: 2073 686f 756c 6420 6265 636f 6d65 2061   should become a
+00023c20: 2062 6574 7465 7220 6572 726f 720a 2020   better error.  
+00023c30: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00023c40: 6173 7365 7274 5261 6973 6573 2852 756e  assertRaises(Run
+00023c50: 7469 6d65 4572 726f 7229 3a0a 2020 2020  timeError):.    
+00023c60: 2020 2020 2020 2020 636c 6965 6e74 2e73          client.s
+00023c70: 7461 7274 5f73 6572 7669 6365 7328 5b27  tart_services(['
+00023c80: 756e 6b6e 6f77 6e27 5d29 0a0a 2020 2020  unknown'])..    
+00023c90: 6465 6620 7465 7374 5f73 7461 7274 5f73  def test_start_s
+00023ca0: 6572 7669 6365 5f73 7472 2873 656c 6629  ervice_str(self)
+00023cb0: 3a0a 2020 2020 2020 2020 2320 5374 6172  :.        # Star
+00023cc0: 7420 7365 7276 6963 6520 7461 6b65 7320  t service takes 
+00023cd0: 6120 6c69 7374 206f 6620 6e61 6d65 732c  a list of names,
+00023ce0: 2062 7574 2069 7420 6973 2072 6561 6c6c   but it is reall
+00023cf0: 7920 6561 7379 2074 6f20 6163 6369 6465  y easy to accide
+00023d00: 6e74 616c 6c79 2070 6173 7320 6a75 7374  ntally pass just
+00023d10: 2061 0a20 2020 2020 2020 2023 206e 616d   a.        # nam
+00023d20: 650a 2020 2020 2020 2020 636c 6965 6e74  e.        client
+00023d30: 203d 2073 656c 662e 6765 745f 7465 7374   = self.get_test
+00023d40: 696e 675f 636c 6965 6e74 2829 0a20 2020  ing_client().   
+00023d50: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00023d60: 7373 6572 7452 6169 7365 7328 5479 7065  ssertRaises(Type
+00023d70: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00023d80: 2020 2020 636c 6965 6e74 2e73 7461 7274      client.start
+00023d90: 5f73 6572 7669 6365 7328 2775 6e6b 6e6f  _services('unkno
+00023da0: 776e 2729 0a0a 2020 2020 6465 6620 7465  wn')..    def te
+00023db0: 7374 5f73 746f 705f 7365 7276 6963 655f  st_stop_service_
+00023dc0: 7374 7228 7365 6c66 293a 0a20 2020 2020  str(self):.     
+00023dd0: 2020 2023 2053 7461 7274 2073 6572 7669     # Start servi
+00023de0: 6365 2074 616b 6573 2061 206c 6973 7420  ce takes a list 
+00023df0: 6f66 206e 616d 6573 2c20 6275 7420 6974  of names, but it
+00023e00: 2069 7320 7265 616c 6c79 2065 6173 7920   is really easy 
+00023e10: 746f 2061 6363 6964 656e 7461 6c6c 7920  to accidentally 
+00023e20: 7061 7373 206a 7573 7420 610a 2020 2020  pass just a.    
+00023e30: 2020 2020 2320 6e61 6d65 0a20 2020 2020      # name.     
+00023e40: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00023e50: 2e67 6574 5f74 6573 7469 6e67 5f63 6c69  .get_testing_cli
+00023e60: 656e 7428 290a 2020 2020 2020 2020 7769  ent().        wi
+00023e70: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00023e80: 6973 6573 2854 7970 6545 7272 6f72 293a  ises(TypeError):
+00023e90: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00023ea0: 656e 742e 7374 6f70 5f73 6572 7669 6365  ent.stop_service
+00023eb0: 7328 2775 6e6b 6e6f 776e 2729 0a0a 2020  s('unknown')..  
+00023ec0: 2020 6465 6620 7465 7374 5f6d 6978 6564    def test_mixed
+00023ed0: 5f73 7461 7274 5f73 6572 7669 6365 2873  _start_service(s
+00023ee0: 656c 6629 3a0a 2020 2020 2020 2020 636c  elf):.        cl
+00023ef0: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
+00023f00: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
+00023f10: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00023f20: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
+00023f30: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
+00023f40: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
+00023f50: 2020 2020 2020 2020 2020 2073 6572 7669             servi
+00023f60: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+00023f70: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
+00023f80: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+00023f90: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
+00023fa0: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
+00023fb0: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
+00023fc0: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+00023fd0: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
+00023fe0: 2020 2020 2020 2020 2020 2027 2727 290a             ''').
+00023ff0: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
+00024000: 6a61 6d20 3230 3231 2d30 342d 3230 2062  jam 2021-04-20 b
+00024010: 6574 7465 7220 6572 726f 7220 7479 7065  etter error type
+00024020: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00024030: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00024040: 5275 6e74 696d 6545 7272 6f72 293a 0a20  RuntimeError):. 
+00024050: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+00024060: 742e 7374 6172 745f 7365 7276 6963 6573  t.start_services
+00024070: 285b 2766 6f6f 272c 2027 756e 6b6e 6f77  (['foo', 'unknow
+00024080: 6e27 5d29 0a20 2020 2020 2020 2023 2066  n']).        # f
+00024090: 6f6f 2073 686f 756c 6420 6e6f 7420 6265  oo should not be
+000240a0: 2073 7461 7274 6564 0a20 2020 2020 2020   started.       
+000240b0: 2069 6e66 6f73 203d 2063 6c69 656e 742e   infos = client.
+000240c0: 6765 745f 7365 7276 6963 6573 2829 0a20  get_services(). 
+000240d0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000240e0: 7274 4571 7561 6c28 6c65 6e28 696e 666f  rtEqual(len(info
+000240f0: 7329 2c20 3129 0a20 2020 2020 2020 2066  s), 1).        f
+00024100: 6f6f 5f69 6e66 6f20 3d20 696e 666f 735b  oo_info = infos[
+00024110: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+00024120: 6173 7365 7274 4571 7561 6c28 2766 6f6f  assertEqual('foo
+00024130: 272c 2066 6f6f 5f69 6e66 6f2e 6e61 6d65  ', foo_info.name
+00024140: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00024150: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
+00024160: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
+00024170: 2e45 4e41 424c 4544 2c20 666f 6f5f 696e  .ENABLED, foo_in
+00024180: 666f 2e73 7461 7274 7570 290a 2020 2020  fo.startup).    
+00024190: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000241a0: 7175 616c 2870 6562 626c 652e 5365 7276  qual(pebble.Serv
+000241b0: 6963 6553 7461 7475 732e 494e 4143 5449  iceStatus.INACTI
+000241c0: 5645 2c20 666f 6f5f 696e 666f 2e63 7572  VE, foo_info.cur
+000241d0: 7265 6e74 290a 0a20 2020 2064 6566 2074  rent)..    def t
+000241e0: 6573 745f 7374 6f70 5f73 6572 7669 6365  est_stop_service
+000241f0: 735f 756e 6b6e 6f77 6e28 7365 6c66 293a  s_unknown(self):
+00024200: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
+00024210: 3d20 7365 6c66 2e67 6574 5f74 6573 7469  = self.get_testi
+00024220: 6e67 5f63 6c69 656e 7428 290a 2020 2020  ng_client().    
+00024230: 2020 2020 636c 6965 6e74 2e61 6464 5f6c      client.add_l
+00024240: 6179 6572 2827 666f 6f27 2c20 2727 275c  ayer('foo', '''\
+00024250: 0a20 2020 2020 2020 2020 2020 2073 756d  .            sum
+00024260: 6d61 7279 3a20 666f 6f0a 2020 2020 2020  mary: foo.      
+00024270: 2020 2020 2020 7365 7276 6963 6573 3a0a        services:.
+00024280: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00024290: 6f3a 0a20 2020 2020 2020 2020 2020 2020  o:.             
+000242a0: 2020 2073 756d 6d61 7279 3a20 466f 6f0a     summary: Foo.
+000242b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000242c0: 7374 6172 7475 703a 2065 6e61 626c 6564  startup: enabled
+000242d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000242e0: 2063 6f6d 6d61 6e64 3a20 272f 6269 6e2f   command: '/bin/
+000242f0: 6563 686f 2066 6f6f 270a 2020 2020 2020  echo foo'.      
+00024300: 2020 2020 2020 2727 2729 0a20 2020 2020        ''').     
+00024310: 2020 2063 6c69 656e 742e 6175 746f 7374     client.autost
+00024320: 6172 745f 7365 7276 6963 6573 2829 0a20  art_services(). 
+00024330: 2020 2020 2020 2023 2054 4f44 4f3a 206a         # TODO: j
+00024340: 616d 2032 3032 312d 3034 2d32 3020 6265  am 2021-04-20 be
+00024350: 7474 6572 2065 7272 6f72 2074 7970 650a  tter error type.
+00024360: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00024370: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
+00024380: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
+00024390: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+000243a0: 2e73 746f 705f 7365 7276 6963 6573 285b  .stop_services([
+000243b0: 2766 6f6f 272c 2027 756e 6b6e 6f77 6e27  'foo', 'unknown'
+000243c0: 5d29 0a20 2020 2020 2020 2023 2066 6f6f  ]).        # foo
+000243d0: 2073 686f 756c 6420 7374 696c 6c20 6265   should still be
+000243e0: 2072 756e 6e69 6e67 0a20 2020 2020 2020   running.       
+000243f0: 2069 6e66 6f73 203d 2063 6c69 656e 742e   infos = client.
+00024400: 6765 745f 7365 7276 6963 6573 2829 0a20  get_services(). 
+00024410: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00024420: 7274 4571 7561 6c28 6c65 6e28 696e 666f  rtEqual(len(info
+00024430: 7329 2c20 3129 0a20 2020 2020 2020 2066  s), 1).        f
+00024440: 6f6f 5f69 6e66 6f20 3d20 696e 666f 735b  oo_info = infos[
+00024450: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+00024460: 6173 7365 7274 4571 7561 6c28 2766 6f6f  assertEqual('foo
+00024470: 272c 2066 6f6f 5f69 6e66 6f2e 6e61 6d65  ', foo_info.name
+00024480: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00024490: 7373 6572 7445 7175 616c 2870 6562 626c  ssertEqual(pebbl
+000244a0: 652e 5365 7276 6963 6553 7461 7274 7570  e.ServiceStartup
+000244b0: 2e45 4e41 424c 4544 2c20 666f 6f5f 696e  .ENABLED, foo_in
+000244c0: 666f 2e73 7461 7274 7570 290a 2020 2020  fo.startup).    
+000244d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000244e0: 7175 616c 2870 6562 626c 652e 5365 7276  qual(pebble.Serv
+000244f0: 6963 6553 7461 7475 732e 4143 5449 5645  iceStatus.ACTIVE
+00024500: 2c20 666f 6f5f 696e 666f 2e63 7572 7265  , foo_info.curre
+00024510: 6e74 290a 0a20 2020 2064 6566 2074 6573  nt)..    def tes
+00024520: 745f 7374 6172 745f 7374 6172 7465 645f  t_start_started_
+00024530: 7365 7276 6963 6528 7365 6c66 293a 0a20  service(self):. 
+00024540: 2020 2020 2020 2023 2050 6562 626c 6520         # Pebble 
+00024550: 6d61 696e 7461 696e 7320 6964 656d 706f  maintains idempo
+00024560: 7465 6e63 7920 6576 656e 2069 6620 796f  tency even if yo
+00024570: 7520 7374 6172 7420 6120 7365 7276 6963  u start a servic
+00024580: 650a 2020 2020 2020 2020 2320 7768 6963  e.        # whic
+00024590: 6820 6973 2061 6c72 6561 6479 2073 7461  h is already sta
+000245a0: 7274 6564 2e0a 2020 2020 2020 2020 636c  rted..        cl
+000245b0: 6965 6e74 203d 2073 656c 662e 6765 745f  ient = self.get_
+000245c0: 7465 7374 696e 675f 636c 6965 6e74 2829  testing_client()
+000245d0: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+000245e0: 6164 645f 6c61 7965 7228 2766 6f6f 272c  add_layer('foo',
+000245f0: 2027 2727 5c0a 2020 2020 2020 2020 2020   '''\.          
+00024600: 2020 7375 6d6d 6172 793a 2066 6f6f 0a20    summary: foo. 
+00024610: 2020 2020 2020 2020 2020 2073 6572 7669             servi
+00024620: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+00024630: 2020 2066 6f6f 3a0a 2020 2020 2020 2020     foo:.        
+00024640: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+00024650: 2046 6f6f 0a20 2020 2020 2020 2020 2020   Foo.           
+00024660: 2020 2020 2073 7461 7274 7570 3a20 656e       startup: en
+00024670: 6162 6c65 640a 2020 2020 2020 2020 2020  abled.          
+00024680: 2020 2020 2020 636f 6d6d 616e 643a 2027        command: '
+00024690: 2f62 696e 2f65 6368 6f20 666f 6f27 0a20  /bin/echo foo'. 
+000246a0: 2020 2020 2020 2020 2020 2020 2062 6172               bar
+000246b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000246c0: 2020 7375 6d6d 6172 793a 2042 6172 0a20    summary: Bar. 
+000246d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000246e0: 6f6d 6d61 6e64 3a20 272f 6269 6e2f 6563  ommand: '/bin/ec
+000246f0: 686f 2062 6172 270a 2020 2020 2020 2020  ho bar'.        
+00024700: 2020 2020 2727 2729 0a20 2020 2020 2020      ''').       
+00024710: 2063 6c69 656e 742e 6175 746f 7374 6172   client.autostar
+00024720: 745f 7365 7276 6963 6573 2829 0a20 2020  t_services().   
+00024730: 2020 2020 2023 2046 6f6f 2069 7320 6e6f       # Foo is no
+00024740: 7720 7374 6172 7465 642c 2062 7574 2042  w started, but B
+00024750: 6172 2069 7320 6e6f 740a 2020 2020 2020  ar is not.      
+00024760: 2020 636c 6965 6e74 2e73 7461 7274 5f73    client.start_s
+00024770: 6572 7669 6365 7328 5b27 6261 7227 2c20  ervices(['bar', 
+00024780: 2766 6f6f 275d 290a 2020 2020 2020 2020  'foo']).        
+00024790: 2320 666f 6f20 616e 6420 6261 7220 6172  # foo and bar ar
+000247a0: 6520 626f 7468 2073 7461 7274 6564 0a20  e both started. 
+000247b0: 2020 2020 2020 2069 6e66 6f73 203d 2063         infos = c
+000247c0: 6c69 656e 742e 6765 745f 7365 7276 6963  lient.get_servic
+000247d0: 6573 2829 0a20 2020 2020 2020 2073 656c  es().        sel
+000247e0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+000247f0: 6e28 696e 666f 7329 2c20 3229 0a20 2020  n(infos), 2).   
+00024800: 2020 2020 2062 6172 5f69 6e66 6f20 3d20       bar_info = 
+00024810: 696e 666f 735b 305d 0a20 2020 2020 2020  infos[0].       
+00024820: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00024830: 6c28 2762 6172 272c 2062 6172 5f69 6e66  l('bar', bar_inf
+00024840: 6f2e 6e61 6d65 290a 2020 2020 2020 2020  o.name).        
+00024850: 2320 4465 6661 756c 7420 7768 656e 206e  # Default when n
+00024860: 6f74 2073 7065 6369 6669 6564 2069 7320  ot specified is 
+00024870: 4449 5341 424c 4544 0a20 2020 2020 2020  DISABLED.       
+00024880: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00024890: 6c28 7065 6262 6c65 2e53 6572 7669 6365  l(pebble.Service
+000248a0: 5374 6172 7475 702e 4449 5341 424c 4544  Startup.DISABLED
+000248b0: 2c20 6261 725f 696e 666f 2e73 7461 7274  , bar_info.start
+000248c0: 7570 290a 2020 2020 2020 2020 7365 6c66  up).        self
+000248d0: 2e61 7373 6572 7445 7175 616c 2870 6562  .assertEqual(peb
+000248e0: 626c 652e 5365 7276 6963 6553 7461 7475  ble.ServiceStatu
+000248f0: 732e 4143 5449 5645 2c20 6261 725f 696e  s.ACTIVE, bar_in
+00024900: 666f 2e63 7572 7265 6e74 290a 2020 2020  fo.current).    
+00024910: 2020 2020 666f 6f5f 696e 666f 203d 2069      foo_info = i
+00024920: 6e66 6f73 5b31 5d0a 2020 2020 2020 2020  nfos[1].        
+00024930: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00024940: 2827 666f 6f27 2c20 666f 6f5f 696e 666f  ('foo', foo_info
+00024950: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
+00024960: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00024970: 7065 6262 6c65 2e53 6572 7669 6365 5374  pebble.ServiceSt
+00024980: 6172 7475 702e 454e 4142 4c45 442c 2066  artup.ENABLED, f
+00024990: 6f6f 5f69 6e66 6f2e 7374 6172 7475 7029  oo_info.startup)
+000249a0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+000249b0: 7365 7274 4571 7561 6c28 7065 6262 6c65  sertEqual(pebble
+000249c0: 2e53 6572 7669 6365 5374 6174 7573 2e41  .ServiceStatus.A
+000249d0: 4354 4956 452c 2066 6f6f 5f69 6e66 6f2e  CTIVE, foo_info.
+000249e0: 6375 7272 656e 7429 0a0a 2020 2020 6465  current)..    de
+000249f0: 6620 7465 7374 5f73 746f 705f 7374 6f70  f test_stop_stop
+00024a00: 7065 645f 7365 7276 6963 6528 7365 6c66  ped_service(self
+00024a10: 293a 0a20 2020 2020 2020 2023 2050 6562  ):.        # Peb
+00024a20: 626c 6520 6d61 696e 7461 696e 7320 6964  ble maintains id
+00024a30: 656d 706f 7465 6e63 7920 6576 656e 2069  empotency even i
+00024a40: 6620 796f 7520 7374 6f70 2061 2073 6572  f you stop a ser
+00024a50: 7669 6365 0a20 2020 2020 2020 2023 2077  vice.        # w
+00024a60: 6869 6368 2069 7320 616c 7265 6164 7920  hich is already 
+00024a70: 7374 6f70 7065 642e 0a20 2020 2020 2020  stopped..       
+00024a80: 2063 6c69 656e 7420 3d20 7365 6c66 2e67   client = self.g
+00024a90: 6574 5f74 6573 7469 6e67 5f63 6c69 656e  et_testing_clien
+00024aa0: 7428 290a 2020 2020 2020 2020 636c 6965  t().        clie
+00024ab0: 6e74 2e61 6464 5f6c 6179 6572 2827 666f  nt.add_layer('fo
+00024ac0: 6f27 2c20 2727 275c 0a20 2020 2020 2020  o', '''\.       
+00024ad0: 2020 2020 2073 756d 6d61 7279 3a20 666f       summary: fo
+00024ae0: 6f0a 2020 2020 2020 2020 2020 2020 7365  o.            se
+00024af0: 7276 6963 6573 3a0a 2020 2020 2020 2020  rvices:.        
+00024b00: 2020 2020 2020 666f 6f3a 0a20 2020 2020        foo:.     
+00024b10: 2020 2020 2020 2020 2020 2073 756d 6d61             summa
+00024b20: 7279 3a20 466f 6f0a 2020 2020 2020 2020  ry: Foo.        
+00024b30: 2020 2020 2020 2020 7374 6172 7475 703a          startup:
+00024b40: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
+00024b50: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+00024b60: 3a20 272f 6269 6e2f 6563 686f 2066 6f6f  : '/bin/echo foo
+00024b70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00024b80: 6261 723a 0a20 2020 2020 2020 2020 2020  bar:.           
+00024b90: 2020 2020 2073 756d 6d61 7279 3a20 4261       summary: Ba
+00024ba0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00024bb0: 2020 636f 6d6d 616e 643a 2027 2f62 696e    command: '/bin
+00024bc0: 2f65 6368 6f20 6261 7227 0a20 2020 2020  /echo bar'.     
+00024bd0: 2020 2020 2020 2027 2727 290a 2020 2020         ''').    
+00024be0: 2020 2020 636c 6965 6e74 2e61 7574 6f73      client.autos
+00024bf0: 7461 7274 5f73 6572 7669 6365 7328 290a  tart_services().
+00024c00: 2020 2020 2020 2020 2320 466f 6f20 6973          # Foo is
+00024c10: 206e 6f77 2073 7461 7274 6564 2c20 6275   now started, bu
+00024c20: 7420 4261 7220 6973 206e 6f74 0a20 2020  t Bar is not.   
+00024c30: 2020 2020 2063 6c69 656e 742e 7374 6f70       client.stop
+00024c40: 5f73 6572 7669 6365 7328 5b27 666f 6f27  _services(['foo'
+00024c50: 2c20 2762 6172 275d 290a 2020 2020 2020  , 'bar']).      
+00024c60: 2020 2320 666f 6f20 616e 6420 6261 7220    # foo and bar 
+00024c70: 6172 6520 626f 7468 2073 746f 7070 6564  are both stopped
+00024c80: 0a20 2020 2020 2020 2069 6e66 6f73 203d  .        infos =
+00024c90: 2063 6c69 656e 742e 6765 745f 7365 7276   client.get_serv
+00024ca0: 6963 6573 2829 0a20 2020 2020 2020 2073  ices().        s
+00024cb0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00024cc0: 6c65 6e28 696e 666f 7329 2c20 3229 0a20  len(infos), 2). 
+00024cd0: 2020 2020 2020 2062 6172 5f69 6e66 6f20         bar_info 
+00024ce0: 3d20 696e 666f 735b 305d 0a20 2020 2020  = infos[0].     
+00024cf0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00024d00: 7561 6c28 2762 6172 272c 2062 6172 5f69  ual('bar', bar_i
+00024d10: 6e66 6f2e 6e61 6d65 290a 2020 2020 2020  nfo.name).      
+00024d20: 2020 2320 4465 6661 756c 7420 7768 656e    # Default when
+00024d30: 206e 6f74 2073 7065 6369 6669 6564 2069   not specified i
+00024d40: 7320 4449 5341 424c 4544 0a20 2020 2020  s DISABLED.     
+00024d50: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00024d60: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
+00024d70: 6365 5374 6172 7475 702e 4449 5341 424c  ceStartup.DISABL
+00024d80: 4544 2c20 6261 725f 696e 666f 2e73 7461  ED, bar_info.sta
+00024d90: 7274 7570 290a 2020 2020 2020 2020 7365  rtup).        se
+00024da0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+00024db0: 6562 626c 652e 5365 7276 6963 6553 7461  ebble.ServiceSta
+00024dc0: 7475 732e 494e 4143 5449 5645 2c20 6261  tus.INACTIVE, ba
+00024dd0: 725f 696e 666f 2e63 7572 7265 6e74 290a  r_info.current).
+00024de0: 2020 2020 2020 2020 666f 6f5f 696e 666f          foo_info
+00024df0: 203d 2069 6e66 6f73 5b31 5d0a 2020 2020   = infos[1].    
+00024e00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00024e10: 7175 616c 2827 666f 6f27 2c20 666f 6f5f  qual('foo', foo_
+00024e20: 696e 666f 2e6e 616d 6529 0a20 2020 2020  info.name).     
+00024e30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00024e40: 7561 6c28 7065 6262 6c65 2e53 6572 7669  ual(pebble.Servi
+00024e50: 6365 5374 6172 7475 702e 454e 4142 4c45  ceStartup.ENABLE
+00024e60: 442c 2066 6f6f 5f69 6e66 6f2e 7374 6172  D, foo_info.star
+00024e70: 7475 7029 0a20 2020 2020 2020 2073 656c  tup).        sel
+00024e80: 662e 6173 7365 7274 4571 7561 6c28 7065  f.assertEqual(pe
+00024e90: 6262 6c65 2e53 6572 7669 6365 5374 6174  bble.ServiceStat
+00024ea0: 7573 2e49 4e41 4354 4956 452c 2066 6f6f  us.INACTIVE, foo
+00024eb0: 5f69 6e66 6f2e 6375 7272 656e 7429 0a0a  _info.current)..
+00024ec0: 2020 2020 4020 756e 6974 7465 7374 2e73      @ unittest.s
+00024ed0: 6b69 7055 6e6c 6573 7328 6973 5f6c 696e  kipUnless(is_lin
+00024ee0: 7578 2c20 2750 6562 626c 6520 7275 6e73  ux, 'Pebble runs
+00024ef0: 206f 6e20 4c69 6e75 7827 290a 2020 2020   on Linux').    
+00024f00: 6465 6620 7465 7374 5f73 656e 645f 7369  def test_send_si
+00024f10: 676e 616c 2873 656c 6629 3a0a 2020 2020  gnal(self):.    
+00024f20: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
+00024f30: 662e 6765 745f 7465 7374 696e 675f 636c  f.get_testing_cl
+00024f40: 6965 6e74 2829 0a20 2020 2020 2020 2063  ient().        c
+00024f50: 6c69 656e 742e 6164 645f 6c61 7965 7228  lient.add_layer(
+00024f60: 2766 6f6f 272c 2027 2727 5c0a 2020 2020  'foo', '''\.    
+00024f70: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+00024f80: 2066 6f6f 0a20 2020 2020 2020 2020 2020   foo.           
+00024f90: 2073 6572 7669 6365 733a 0a20 2020 2020   services:.     
+00024fa0: 2020 2020 2020 2020 2066 6f6f 3a0a 2020           foo:.  
+00024fb0: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00024fc0: 6d6d 6172 793a 2046 6f6f 0a20 2020 2020  mmary: Foo.     
+00024fd0: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00024fe0: 7570 3a20 656e 6162 6c65 640a 2020 2020  up: enabled.    
+00024ff0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+00025000: 616e 643a 2027 2f62 696e 2f65 6368 6f20  and: '/bin/echo 
+00025010: 666f 6f27 0a20 2020 2020 2020 2020 2020  foo'.           
+00025020: 2020 2062 6172 3a0a 2020 2020 2020 2020     bar:.        
+00025030: 2020 2020 2020 2020 7375 6d6d 6172 793a          summary:
+00025040: 2042 6172 0a20 2020 2020 2020 2020 2020   Bar.           
+00025050: 2020 2020 2063 6f6d 6d61 6e64 3a20 272f       command: '/
+00025060: 6269 6e2f 6563 686f 2062 6172 270a 2020  bin/echo bar'.  
+00025070: 2020 2020 2020 2020 2020 2727 2729 0a20            '''). 
+00025080: 2020 2020 2020 2063 6c69 656e 742e 6175         client.au
+00025090: 746f 7374 6172 745f 7365 7276 6963 6573  tostart_services
+000250a0: 2829 0a20 2020 2020 2020 2023 2046 6f6f  ().        # Foo
+000250b0: 2069 7320 6e6f 7720 7374 6172 7465 642c   is now started,
+000250c0: 2062 7574 2042 6172 2069 7320 6e6f 740a   but Bar is not.
+000250d0: 0a20 2020 2020 2020 2023 2053 656e 6420  .        # Send 
+000250e0: 6120 7661 6c69 6420 7369 676e 616c 2074  a valid signal t
+000250f0: 6f20 6120 7275 6e6e 696e 6720 7365 7276  o a running serv
+00025100: 6963 650a 2020 2020 2020 2020 636c 6965  ice.        clie
+00025110: 6e74 2e73 656e 645f 7369 676e 616c 2822  nt.send_signal("
+00025120: 5349 4749 4e54 222c 2022 666f 6f22 290a  SIGINT", "foo").
+00025130: 0a20 2020 2020 2020 2023 2053 656e 6420  .        # Send 
+00025140: 6120 7661 6c69 6420 7369 676e 616c 2062  a valid signal b
+00025150: 7574 206f 6d69 7420 7365 7276 6963 6520  ut omit service 
+00025160: 6e61 6d65 0a20 2020 2020 2020 2077 6974  name.        wit
+00025170: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00025180: 7365 7328 5479 7065 4572 726f 7229 3a0a  ses(TypeError):.
+00025190: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+000251a0: 6e74 2e73 656e 645f 7369 676e 616c 2822  nt.send_signal("
+000251b0: 5349 4749 4e54 2229 0a0a 2020 2020 2020  SIGINT")..      
+000251c0: 2020 2320 5365 6e64 2061 6e20 696e 7661    # Send an inva
+000251d0: 6c69 6420 7369 676e 616c 2074 6f20 6120  lid signal to a 
+000251e0: 7275 6e6e 696e 6720 7365 7276 6963 650a  running service.
+000251f0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00025200: 662e 6173 7365 7274 5261 6973 6573 2870  f.assertRaises(p
+00025210: 6562 626c 652e 4150 4945 7272 6f72 293a  ebble.APIError):
+00025220: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00025230: 656e 742e 7365 6e64 5f73 6967 6e61 6c28  ent.send_signal(
+00025240: 2273 6967 696e 7422 2c20 2266 6f6f 2229  "sigint", "foo")
+00025250: 0a0a 2020 2020 2020 2020 2320 5365 6e64  ..        # Send
+00025260: 2061 2076 616c 6964 2073 6967 6e61 6c20   a valid signal 
+00025270: 746f 2061 2073 746f 7070 6564 2073 6572  to a stopped ser
+00025280: 7669 6365 0a20 2020 2020 2020 2077 6974  vice.        wit
+00025290: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+000252a0: 7365 7328 7065 6262 6c65 2e41 5049 4572  ses(pebble.APIEr
+000252b0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000252c0: 2020 636c 6965 6e74 2e73 656e 645f 7369    client.send_si
+000252d0: 676e 616c 2822 5349 4749 4e54 222c 2022  gnal("SIGINT", "
+000252e0: 6261 7222 290a 0a20 2020 2020 2020 2023  bar")..        #
+000252f0: 2053 656e 6420 6120 7661 6c69 6420 7369   Send a valid si
+00025300: 676e 616c 2074 6f20 6120 6e6f 6e2d 6578  gnal to a non-ex
+00025310: 6973 7469 6e67 2073 6572 7669 6365 0a20  isting service. 
+00025320: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00025330: 2e61 7373 6572 7452 6169 7365 7328 7065  .assertRaises(pe
+00025340: 6262 6c65 2e41 5049 4572 726f 7229 3a0a  bble.APIError):.
+00025350: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00025360: 6e74 2e73 656e 645f 7369 676e 616c 2822  nt.send_signal("
+00025370: 5349 4749 4e54 222c 2022 6261 7a22 290a  SIGINT", "baz").
+00025380: 0a20 2020 2020 2020 2023 2053 656e 6420  .        # Send 
+00025390: 6120 7661 6c69 6420 7369 676e 616c 2074  a valid signal t
+000253a0: 6f20 6120 6d75 6c74 6970 6c65 2073 6572  o a multiple ser
+000253b0: 7669 6365 732c 206f 6e65 206f 6620 7768  vices, one of wh
+000253c0: 6963 6820 6973 206e 6f74 2072 756e 6e69  ich is not runni
+000253d0: 6e67 0a20 2020 2020 2020 2077 6974 6820  ng.        with 
+000253e0: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+000253f0: 7328 7065 6262 6c65 2e41 5049 4572 726f  s(pebble.APIErro
+00025400: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00025410: 636c 6965 6e74 2e73 656e 645f 7369 676e  client.send_sign
+00025420: 616c 2822 5349 4749 4e54 222c 2022 666f  al("SIGINT", "fo
+00025430: 6f22 2c20 2262 6172 2229 0a0a 0a23 2046  o", "bar")...# F
+00025440: 6f72 2074 6573 7469 6e67 2066 696c 652d  or testing file-
+00025450: 6f70 7320 6f66 2074 6865 2070 6562 626c  ops of the pebbl
+00025460: 6520 636c 6965 6e74 2e20 2054 6869 7320  e client.  This 
+00025470: 6973 2072 6566 6163 746f 7265 6420 696e  is refactored in
+00025480: 746f 2061 0a23 2073 6570 6172 6174 6520  to a.# separate 
+00025490: 6d69 7869 6e20 736f 2077 6520 6361 6e20  mixin so we can 
+000254a0: 7275 6e20 7468 6573 6520 7465 7374 7320  run these tests 
+000254b0: 6167 6169 6e73 7420 626f 7468 2074 6865  against both the
+000254c0: 206d 6f63 6b20 636c 6965 6e74 2061 730a   mock client as.
+000254d0: 2320 7765 6c6c 2061 7320 6120 7265 616c  # well as a real
+000254e0: 2070 6562 626c 6520 7365 7276 6572 2069   pebble server i
+000254f0: 6e73 7461 6e63 652e 0a63 6c61 7373 205f  nstance..class _
+00025500: 5065 6262 6c65 5374 6f72 6167 6541 5049  PebbleStorageAPI
+00025510: 7354 6573 744d 6978 696e 3a0a 2020 2020  sTestMixin:.    
+00025520: 2320 4f76 6572 7269 6465 2074 6869 7320  # Override this 
+00025530: 696e 2063 6c61 7373 6573 2075 7369 6e67  in classes using
+00025540: 2074 6869 7320 6d69 7869 6e2e 0a20 2020   this mixin..   
+00025550: 2023 2054 6869 7320 7368 6f75 6c64 2062   # This should b
+00025560: 6520 7365 7420 746f 2061 6e79 206e 6f6e  e set to any non
+00025570: 2d65 6d70 7479 2070 6174 682c 2062 7574  -empty path, but
+00025580: 2077 6974 686f 7574 2061 2074 7261 696c   without a trail
+00025590: 696e 6720 2f2e 0a20 2020 2070 7265 6669  ing /..    prefi
+000255a0: 7820 3d20 4e6f 6e65 0a0a 2020 2020 6465  x = None..    de
+000255b0: 6620 7465 7374 5f70 7573 685f 616e 645f  f test_push_and_
+000255c0: 7075 6c6c 5f62 7974 6573 2873 656c 6629  pull_bytes(self)
+000255d0: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
+000255e0: 7465 7374 5f70 7573 685f 616e 645f 7075  test_push_and_pu
+000255f0: 6c6c 5f64 6174 6128 0a20 2020 2020 2020  ll_data(.       
+00025600: 2020 2020 206f 7269 6769 6e61 6c5f 6461       original_da
+00025610: 7461 3d62 225c 7830 305c 7830 315c 7830  ta=b"\x00\x01\x0
+00025620: 325c 7830 335c 7830 3422 2c0a 2020 2020  2\x03\x04",.    
+00025630: 2020 2020 2020 2020 656e 636f 6469 6e67          encoding
+00025640: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00025650: 2020 2073 7472 6561 6d5f 636c 6173 733d     stream_class=
+00025660: 696f 2e42 7974 6573 494f 290a 0a20 2020  io.BytesIO)..   
+00025670: 2064 6566 2074 6573 745f 7075 7368 5f61   def test_push_a
+00025680: 6e64 5f70 756c 6c5f 6e6f 6e5f 7574 6638  nd_pull_non_utf8
+00025690: 5f64 6174 6128 7365 6c66 293a 0a20 2020  _data(self):.   
+000256a0: 2020 2020 2073 656c 662e 5f74 6573 745f       self._test_
+000256b0: 7075 7368 5f61 6e64 5f70 756c 6c5f 6461  push_and_pull_da
+000256c0: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
+000256d0: 6f72 6967 696e 616c 5f64 6174 613d 27e6  original_data='.
+000256e0: 97a5 e69c ace8 aa9e 272c 2020 2320 224a  ........',  # "J
+000256f0: 6170 616e 6573 6522 2069 6e20 4a61 7061  apanese" in Japa
+00025700: 6e65 7365 0a20 2020 2020 2020 2020 2020  nese.           
+00025710: 2065 6e63 6f64 696e 673d 2773 6a69 7327   encoding='sjis'
+00025720: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00025730: 7265 616d 5f63 6c61 7373 3d69 6f2e 5374  ream_class=io.St
+00025740: 7269 6e67 494f 290a 0a20 2020 2064 6566  ringIO)..    def
+00025750: 205f 7465 7374 5f70 7573 685f 616e 645f   _test_push_and_
+00025760: 7075 6c6c 5f64 6174 6128 7365 6c66 2c20  pull_data(self, 
+00025770: 6f72 6967 696e 616c 5f64 6174 612c 2065  original_data, e
+00025780: 6e63 6f64 696e 672c 2073 7472 6561 6d5f  ncoding, stream_
+00025790: 636c 6173 7329 3a0a 2020 2020 2020 2020  class):.        
+000257a0: 636c 6965 6e74 203d 2073 656c 662e 636c  client = self.cl
+000257b0: 6965 6e74 0a20 2020 2020 2020 2063 6c69  ient.        cli
+000257c0: 656e 742e 7075 7368 2866 227b 7365 6c66  ent.push(f"{self
+000257d0: 2e70 7265 6669 787d 2f74 6573 7422 2c20  .prefix}/test", 
+000257e0: 6f72 6967 696e 616c 5f64 6174 612c 2065  original_data, e
+000257f0: 6e63 6f64 696e 673d 656e 636f 6469 6e67  ncoding=encoding
+00025800: 290a 2020 2020 2020 2020 7769 7468 2063  ).        with c
+00025810: 6c69 656e 742e 7075 6c6c 2866 227b 7365  lient.pull(f"{se
+00025820: 6c66 2e70 7265 6669 787d 2f74 6573 7422  lf.prefix}/test"
+00025830: 2c20 656e 636f 6469 6e67 3d65 6e63 6f64  , encoding=encod
+00025840: 696e 6729 2061 7320 696e 6669 6c65 3a0a  ing) as infile:.
+00025850: 2020 2020 2020 2020 2020 2020 7265 6365              rece
+00025860: 6976 6564 5f64 6174 6120 3d20 696e 6669  ived_data = infi
+00025870: 6c65 2e72 6561 6428 290a 2020 2020 2020  le.read().      
+00025880: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00025890: 616c 286f 7269 6769 6e61 6c5f 6461 7461  al(original_data
+000258a0: 2c20 7265 6365 6976 6564 5f64 6174 6129  , received_data)
+000258b0: 0a0a 2020 2020 2020 2020 2320 5765 2061  ..        # We a
+000258c0: 6c73 6f20 7375 7070 6f72 7420 6669 6c65  lso support file
+000258d0: 2d6c 696b 6520 6f62 6a65 6374 7320 6173  -like objects as
+000258e0: 2069 6e70 7574 2c20 736f 206c 6574 2773   input, so let's
+000258f0: 2074 6573 7420 7468 6174 2063 6173 6520   test that case 
+00025900: 6173 2077 656c 6c2e 0a20 2020 2020 2020  as well..       
+00025910: 2073 6d61 6c6c 5f66 696c 6520 3d20 7374   small_file = st
+00025920: 7265 616d 5f63 6c61 7373 286f 7269 6769  ream_class(origi
+00025930: 6e61 6c5f 6461 7461 290a 2020 2020 2020  nal_data).      
+00025940: 2020 636c 6965 6e74 2e70 7573 6828 6622    client.push(f"
+00025950: 7b73 656c 662e 7072 6566 6978 7d2f 7465  {self.prefix}/te
+00025960: 7374 222c 2073 6d61 6c6c 5f66 696c 652c  st", small_file,
+00025970: 2065 6e63 6f64 696e 673d 656e 636f 6469   encoding=encodi
+00025980: 6e67 290a 2020 2020 2020 2020 7769 7468  ng).        with
+00025990: 2063 6c69 656e 742e 7075 6c6c 2866 227b   client.pull(f"{
+000259a0: 7365 6c66 2e70 7265 6669 787d 2f74 6573  self.prefix}/tes
+000259b0: 7422 2c20 656e 636f 6469 6e67 3d65 6e63  t", encoding=enc
+000259c0: 6f64 696e 6729 2061 7320 696e 6669 6c65  oding) as infile
+000259d0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000259e0: 6365 6976 6564 5f64 6174 6120 3d20 696e  ceived_data = in
+000259f0: 6669 6c65 2e72 6561 6428 290a 2020 2020  file.read().    
+00025a00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00025a10: 7175 616c 286f 7269 6769 6e61 6c5f 6461  qual(original_da
+00025a20: 7461 2c20 7265 6365 6976 6564 5f64 6174  ta, received_dat
+00025a30: 6129 0a0a 2020 2020 6465 6620 7465 7374  a)..    def test
+00025a40: 5f70 7573 685f 616e 645f 7075 6c6c 5f6c  _push_and_pull_l
+00025a50: 6172 6765 725f 6669 6c65 2873 656c 6629  arger_file(self)
+00025a60: 3a0a 2020 2020 2020 2020 2320 496e 7465  :.        # Inte
+00025a70: 6e74 3a20 746f 2065 6e73 7572 6520 7468  nt: to ensure th
+00025a80: 696e 6773 2077 6f72 6b20 6170 7072 6f70  ings work approp
+00025a90: 7269 6174 656c 7920 7769 7468 206c 6172  riately with lar
+00025aa0: 6765 7220 6669 6c65 732e 0a20 2020 2020  ger files..     
+00025ab0: 2020 2023 204c 6172 6765 7220 6669 6c65     # Larger file
+00025ac0: 7320 6d61 7920 6265 2073 656e 742f 7265  s may be sent/re
+00025ad0: 6365 6976 6564 2069 6e20 6d75 6c74 6970  ceived in multip
+00025ae0: 6c65 2063 6875 6e6b 733b 2074 6869 7320  le chunks; this 
+00025af0: 7368 6f75 6c64 2068 656c 7020 666f 720a  should help for.
+00025b00: 2020 2020 2020 2020 2320 6368 6563 6b69          # checki
+00025b10: 6e67 2074 6861 7420 7375 6368 206c 6f67  ng that such log
+00025b20: 6963 2069 7320 636f 7272 6563 742e 0a20  ic is correct.. 
+00025b30: 2020 2020 2020 2064 6174 615f 7369 7a65         data_size
+00025b40: 203d 2031 3032 3420 2a20 3130 3234 0a20   = 1024 * 1024. 
+00025b50: 2020 2020 2020 206f 7269 6769 6e61 6c5f         original_
+00025b60: 6461 7461 203d 206f 732e 7572 616e 646f  data = os.urando
+00025b70: 6d28 6461 7461 5f73 697a 6529 0a0a 2020  m(data_size)..  
+00025b80: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+00025b90: 656c 662e 636c 6965 6e74 0a20 2020 2020  elf.client.     
+00025ba0: 2020 2063 6c69 656e 742e 7075 7368 2866     client.push(f
+00025bb0: 227b 7365 6c66 2e70 7265 6669 787d 2f74  "{self.prefix}/t
+00025bc0: 6573 7422 2c20 6f72 6967 696e 616c 5f64  est", original_d
+00025bd0: 6174 612c 2065 6e63 6f64 696e 673d 4e6f  ata, encoding=No
+00025be0: 6e65 290a 2020 2020 2020 2020 7769 7468  ne).        with
+00025bf0: 2063 6c69 656e 742e 7075 6c6c 2866 227b   client.pull(f"{
+00025c00: 7365 6c66 2e70 7265 6669 787d 2f74 6573  self.prefix}/tes
+00025c10: 7422 2c20 656e 636f 6469 6e67 3d4e 6f6e  t", encoding=Non
+00025c20: 6529 2061 7320 696e 6669 6c65 3a0a 2020  e) as infile:.  
+00025c30: 2020 2020 2020 2020 2020 7265 6365 6976            receiv
+00025c40: 6564 5f64 6174 6120 3d20 696e 6669 6c65  ed_data = infile
+00025c50: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
+00025c60: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00025c70: 286f 7269 6769 6e61 6c5f 6461 7461 2c20  (original_data, 
+00025c80: 7265 6365 6976 6564 5f64 6174 6129 0a0a  received_data)..
+00025c90: 2020 2020 6465 6620 7465 7374 5f70 7573      def test_pus
+00025ca0: 685f 746f 5f6e 6f6e 5f65 7869 7374 656e  h_to_non_existen
+00025cb0: 745f 7375 6264 6972 2873 656c 6629 3a0a  t_subdir(self):.
+00025cc0: 2020 2020 2020 2020 6461 7461 203d 2027          data = '
+00025cd0: 6461 7461 270a 2020 2020 2020 2020 636c  data'.        cl
+00025ce0: 6965 6e74 203d 2073 656c 662e 636c 6965  ient = self.clie
+00025cf0: 6e74 0a0a 2020 2020 2020 2020 7769 7468  nt..        with
+00025d00: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00025d10: 6573 2870 6562 626c 652e 5061 7468 4572  es(pebble.PathEr
+00025d20: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
+00025d30: 2020 2020 2020 2020 636c 6965 6e74 2e70          client.p
+00025d40: 7573 6828 6622 7b73 656c 662e 7072 6566  ush(f"{self.pref
+00025d50: 6978 7d2f 6e6f 6e65 7869 7374 656e 745f  ix}/nonexistent_
+00025d60: 6469 722f 7465 7374 222c 2064 6174 612c  dir/test", data,
+00025d70: 206d 616b 655f 6469 7273 3d46 616c 7365   make_dirs=False
+00025d80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00025d90: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00025da0: 6365 7074 696f 6e2e 6b69 6e64 2c20 276e  ception.kind, 'n
+00025db0: 6f74 2d66 6f75 6e64 2729 0a0a 2020 2020  ot-found')..    
+00025dc0: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
+00025dd0: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
+00025de0: 6e6f 6e65 7869 7374 656e 745f 6469 722f  nonexistent_dir/
+00025df0: 7465 7374 222c 2064 6174 612c 206d 616b  test", data, mak
+00025e00: 655f 6469 7273 3d54 7275 6529 0a0a 2020  e_dirs=True)..  
+00025e10: 2020 6465 6620 7465 7374 5f70 7573 685f    def test_push_
+00025e20: 6173 5f63 6869 6c64 5f6f 665f 6669 6c65  as_child_of_file
+00025e30: 5f72 6169 7365 735f 6572 726f 7228 7365  _raises_error(se
+00025e40: 6c66 293a 0a20 2020 2020 2020 2064 6174  lf):.        dat
+00025e50: 6120 3d20 2764 6174 6127 0a20 2020 2020  a = 'data'.     
+00025e60: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00025e70: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
+00025e80: 636c 6965 6e74 2e70 7573 6828 6622 7b73  client.push(f"{s
+00025e90: 656c 662e 7072 6566 6978 7d2f 6669 6c65  elf.prefix}/file
+00025ea0: 222c 2064 6174 6129 0a20 2020 2020 2020  ", data).       
+00025eb0: 2077 6974 6820 7365 6c66 2e61 7373 6572   with self.asser
+00025ec0: 7452 6169 7365 7328 7065 6262 6c65 2e50  tRaises(pebble.P
+00025ed0: 6174 6845 7272 6f72 2920 6173 2063 6d3a  athError) as cm:
+00025ee0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00025ef0: 656e 742e 7075 7368 2866 227b 7365 6c66  ent.push(f"{self
+00025f00: 2e70 7265 6669 787d 2f66 696c 652f 6669  .prefix}/file/fi
+00025f10: 6c65 222c 2064 6174 6129 0a20 2020 2020  le", data).     
+00025f20: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00025f30: 7561 6c28 636d 2e65 7863 6570 7469 6f6e  ual(cm.exception
+00025f40: 2e6b 696e 642c 2027 6765 6e65 7269 632d  .kind, 'generic-
+00025f50: 6669 6c65 2d65 7272 6f72 2729 0a0a 2020  file-error')..  
+00025f60: 2020 6465 6620 7465 7374 5f70 7573 685f    def test_push_
+00025f70: 7769 7468 5f70 6572 6d69 7373 696f 6e5f  with_permission_
+00025f80: 6d61 736b 2873 656c 6629 3a0a 2020 2020  mask(self):.    
+00025f90: 2020 2020 6461 7461 203d 2027 6461 7461      data = 'data
+00025fa0: 270a 2020 2020 2020 2020 636c 6965 6e74  '.        client
+00025fb0: 203d 2073 656c 662e 636c 6965 6e74 0a20   = self.client. 
+00025fc0: 2020 2020 2020 2063 6c69 656e 742e 7075         client.pu
+00025fd0: 7368 2866 227b 7365 6c66 2e70 7265 6669  sh(f"{self.prefi
+00025fe0: 787d 2f66 696c 6522 2c20 6461 7461 2c20  x}/file", data, 
+00025ff0: 7065 726d 6973 7369 6f6e 733d 306f 3630  permissions=0o60
+00026000: 3029 0a20 2020 2020 2020 2063 6c69 656e  0).        clien
+00026010: 742e 7075 7368 2866 227b 7365 6c66 2e70  t.push(f"{self.p
+00026020: 7265 6669 787d 2f66 696c 6522 2c20 6461  refix}/file", da
+00026030: 7461 2c20 7065 726d 6973 7369 6f6e 733d  ta, permissions=
+00026040: 306f 3737 3729 0a20 2020 2020 2020 2023  0o777).        #
+00026050: 2049 6620 7065 726d 6973 7369 6f6e 7320   If permissions 
+00026060: 6172 6520 6f75 7473 6964 6520 6f66 2074  are outside of t
+00026070: 6865 2072 616e 6765 2030 6f30 3030 2074  he range 0o000 t
+00026080: 6872 6f75 6768 2030 6f37 3737 2c20 616e  hrough 0o777, an
+00026090: 2065 7863 6570 7469 6f6e 2073 686f 756c   exception shoul
+000260a0: 6420 6265 0a20 2020 2020 2020 2023 2072  d be.        # r
+000260b0: 6169 7365 642e 0a20 2020 2020 2020 2066  aised..        f
+000260c0: 6f72 2062 6164 5f70 6572 6d69 7373 696f  or bad_permissio
+000260d0: 6e20 696e 2028 0a20 2020 2020 2020 2020  n in (.         
+000260e0: 2020 2030 6f31 3030 302c 2020 2320 4578     0o1000,  # Ex
+000260f0: 6365 6564 7320 306f 3737 370a 2020 2020  ceeds 0o777.    
+00026100: 2020 2020 2020 2020 2d31 2c20 2020 2020          -1,     
+00026110: 2023 204c 6573 7320 7468 616e 2030 6f30   # Less than 0o0
+00026120: 3030 0a20 2020 2020 2020 2029 3a0a 2020  00.        ):.  
+00026130: 2020 2020 2020 2020 2020 7769 7468 2073            with s
+00026140: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+00026150: 2870 6562 626c 652e 5061 7468 4572 726f  (pebble.PathErro
+00026160: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
+00026170: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00026180: 2e70 7573 6828 6622 7b73 656c 662e 7072  .push(f"{self.pr
+00026190: 6566 6978 7d2f 6669 6c65 222c 2064 6174  efix}/file", dat
+000261a0: 612c 2070 6572 6d69 7373 696f 6e73 3d62  a, permissions=b
+000261b0: 6164 5f70 6572 6d69 7373 696f 6e29 0a20  ad_permission). 
+000261c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000261d0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
+000261e0: 7469 6f6e 2e6b 696e 642c 2027 6765 6e65  tion.kind, 'gene
+000261f0: 7269 632d 6669 6c65 2d65 7272 6f72 2729  ric-file-error')
+00026200: 0a0a 2020 2020 6465 6620 7465 7374 5f70  ..    def test_p
+00026210: 7573 685f 6669 6c65 735f 616e 645f 6c69  ush_files_and_li
+00026220: 7374 2873 656c 6629 3a0a 2020 2020 2020  st(self):.      
+00026230: 2020 6461 7461 203d 2027 6461 7461 270a    data = 'data'.
+00026240: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+00026250: 2073 656c 662e 636c 6965 6e74 0a0a 2020   self.client..  
+00026260: 2020 2020 2020 2320 4c65 7427 7320 7075        # Let's pu
+00026270: 7368 2074 6865 2066 6972 7374 2066 696c  sh the first fil
+00026280: 6520 7769 7468 2061 2062 756e 6368 206f  e with a bunch o
+00026290: 6620 6465 7461 696c 732e 2020 5765 276c  f details.  We'l
+000262a0: 6c20 6368 6563 6b20 6f6e 2074 6869 7320  l check on this 
+000262b0: 6c61 7465 722e 0a20 2020 2020 2020 2063  later..        c
+000262c0: 6c69 656e 742e 7075 7368 280a 2020 2020  lient.push(.    
+000262d0: 2020 2020 2020 2020 6622 7b73 656c 662e          f"{self.
+000262e0: 7072 6566 6978 7d2f 6669 6c65 3122 2c20  prefix}/file1", 
+000262f0: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+00026300: 2020 7065 726d 6973 7369 6f6e 733d 306f    permissions=0o
+00026310: 3632 3029 0a0a 2020 2020 2020 2020 2320  620)..        # 
+00026320: 446f 2061 2071 7569 636b 2070 7573 6820  Do a quick push 
+00026330: 7769 7468 2064 6566 6175 6c74 7320 666f  with defaults fo
+00026340: 7220 7468 6520 6f74 6865 7220 6669 6c65  r the other file
+00026350: 732e 0a20 2020 2020 2020 2063 6c69 656e  s..        clien
+00026360: 742e 7075 7368 2866 227b 7365 6c66 2e70  t.push(f"{self.p
+00026370: 7265 6669 787d 2f66 696c 6532 222c 2064  refix}/file2", d
+00026380: 6174 6129 0a20 2020 2020 2020 2063 6c69  ata).        cli
+00026390: 656e 742e 7075 7368 2866 227b 7365 6c66  ent.push(f"{self
+000263a0: 2e70 7265 6669 787d 2f66 696c 6533 222c  .prefix}/file3",
+000263b0: 2064 6174 6129 0a0a 2020 2020 2020 2020   data)..        
+000263c0: 6669 6c65 7320 3d20 636c 6965 6e74 2e6c  files = client.l
+000263d0: 6973 745f 6669 6c65 7328 6622 7b73 656c  ist_files(f"{sel
+000263e0: 662e 7072 6566 6978 7d2f 2229 0a20 2020  f.prefix}/").   
+000263f0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00026400: 4571 7561 6c28 7b66 696c 652e 7061 7468  Equal({file.path
+00026410: 2066 6f72 2066 696c 6520 696e 2066 696c   for file in fil
+00026420: 6573 7d2c 0a20 2020 2020 2020 2020 2020  es},.           
+00026430: 2020 2020 2020 2020 2020 2020 2020 7b73                {s
+00026440: 656c 662e 7072 6566 6978 202b 2066 696c  elf.prefix + fil
+00026450: 6520 666f 7220 6669 6c65 2069 6e20 2827  e for file in ('
+00026460: 2f66 696c 6531 272c 2027 2f66 696c 6532  /file1', '/file2
+00026470: 272c 2027 2f66 696c 6533 2729 7d29 0a0a  ', '/file3')})..
+00026480: 2020 2020 2020 2020 2320 4c65 7427 7320          # Let's 
+00026490: 7075 6c6c 2074 6865 2066 6972 7374 2066  pull the first f
+000264a0: 696c 6520 6167 6169 6e20 616e 6420 6368  ile again and ch
+000264b0: 6563 6b20 6974 7320 6465 7461 696c 730a  eck its details.
+000264c0: 2020 2020 2020 2020 6669 6c65 203d 205b          file = [
+000264d0: 6620 666f 7220 6620 696e 2066 696c 6573  f for f in files
+000264e0: 2069 6620 662e 7061 7468 203d 3d20 6622   if f.path == f"
+000264f0: 7b73 656c 662e 7072 6566 6978 7d2f 6669  {self.prefix}/fi
+00026500: 6c65 3122 5d5b 305d 0a20 2020 2020 2020  le1"][0].       
+00026510: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00026520: 6c28 6669 6c65 2e6e 616d 652c 2027 6669  l(file.name, 'fi
+00026530: 6c65 3127 290a 2020 2020 2020 2020 7365  le1').        se
+00026540: 6c66 2e61 7373 6572 7445 7175 616c 2866  lf.assertEqual(f
+00026550: 696c 652e 7479 7065 2c20 7065 6262 6c65  ile.type, pebble
+00026560: 2e46 696c 6554 7970 652e 4649 4c45 290a  .FileType.FILE).
+00026570: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00026580: 6572 7445 7175 616c 2866 696c 652e 7369  ertEqual(file.si
+00026590: 7a65 2c20 3429 0a20 2020 2020 2020 2073  ze, 4).        s
+000265a0: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+000265b0: 616e 6365 2866 696c 652e 6c61 7374 5f6d  ance(file.last_m
+000265c0: 6f64 6966 6965 642c 2064 6174 6574 696d  odified, datetim
+000265d0: 652e 6461 7465 7469 6d65 290a 2020 2020  e.datetime).    
+000265e0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+000265f0: 7175 616c 2866 696c 652e 7065 726d 6973  qual(file.permis
+00026600: 7369 6f6e 732c 2030 6f36 3230 290a 2020  sions, 0o620).  
+00026610: 2020 2020 2020 2320 536b 6970 7069 6e67        # Skipping
+00026620: 206f 776e 6572 7368 6970 2063 6865 636b   ownership check
+00026630: 7320 6865 7265 3b20 6f77 6e65 7273 6869  s here; ownershi
+00026640: 7020 7769 6c6c 2062 6520 6368 6563 6b65  p will be checke
+00026650: 6420 696e 2070 7572 656c 792d 6d6f 636b  d in purely-mock
+00026660: 6564 2074 6573 7473 0a0a 2020 2020 6465  ed tests..    de
+00026670: 6620 7465 7374 5f70 7573 685f 616e 645f  f test_push_and_
+00026680: 6c69 7374 5f66 696c 6528 7365 6c66 293a  list_file(self):
+00026690: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
+000266a0: 2764 6174 6127 0a20 2020 2020 2020 2063  'data'.        c
+000266b0: 6c69 656e 7420 3d20 7365 6c66 2e63 6c69  lient = self.cli
+000266c0: 656e 740a 2020 2020 2020 2020 636c 6965  ent.        clie
+000266d0: 6e74 2e70 7573 6828 6622 7b73 656c 662e  nt.push(f"{self.
+000266e0: 7072 6566 6978 7d2f 6669 6c65 222c 2064  prefix}/file", d
+000266f0: 6174 6129 0a20 2020 2020 2020 2066 696c  ata).        fil
+00026700: 6573 203d 2063 6c69 656e 742e 6c69 7374  es = client.list
+00026710: 5f66 696c 6573 2866 227b 7365 6c66 2e70  _files(f"{self.p
+00026720: 7265 6669 787d 2f22 290a 2020 2020 2020  refix}/").      
+00026730: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00026740: 616c 287b 6669 6c65 2e70 6174 6820 666f  al({file.path fo
+00026750: 7220 6669 6c65 2069 6e20 6669 6c65 737d  r file in files}
+00026760: 2c20 7b66 227b 7365 6c66 2e70 7265 6669  , {f"{self.prefi
+00026770: 787d 2f66 696c 6522 7d29 0a0a 2020 2020  x}/file"})..    
+00026780: 6465 6620 7465 7374 5f70 7573 685f 6669  def test_push_fi
+00026790: 6c65 5f77 6974 685f 7265 6c61 7469 7665  le_with_relative
+000267a0: 5f70 6174 685f 6661 696c 7328 7365 6c66  _path_fails(self
+000267b0: 293a 0a20 2020 2020 2020 2063 6c69 656e  ):.        clien
+000267c0: 7420 3d20 7365 6c66 2e63 6c69 656e 740a  t = self.client.
+000267d0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000267e0: 662e 6173 7365 7274 5261 6973 6573 2870  f.assertRaises(p
+000267f0: 6562 626c 652e 5061 7468 4572 726f 7229  ebble.PathError)
+00026800: 2061 7320 636d 3a0a 2020 2020 2020 2020   as cm:.        
+00026810: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
+00026820: 2766 696c 6527 2c20 2727 290a 2020 2020  'file', '').    
+00026830: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00026840: 7175 616c 2863 6d2e 6578 6365 7074 696f  qual(cm.exceptio
+00026850: 6e2e 6b69 6e64 2c20 2767 656e 6572 6963  n.kind, 'generic
+00026860: 2d66 696c 652d 6572 726f 7227 290a 0a20  -file-error').. 
+00026870: 2020 2064 6566 2074 6573 745f 7075 6c6c     def test_pull
+00026880: 5f6e 6f74 5f66 6f75 6e64 2873 656c 6629  _not_found(self)
+00026890: 3a0a 2020 2020 2020 2020 7769 7468 2073  :.        with s
+000268a0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000268b0: 2870 6562 626c 652e 5061 7468 4572 726f  (pebble.PathErro
+000268c0: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
+000268d0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+000268e0: 742e 7075 6c6c 2822 2f6e 6f74 2f66 6f75  t.pull("/not/fou
+000268f0: 6e64 2229 0a20 2020 2020 2020 2073 656c  nd").        sel
+00026900: 662e 6173 7365 7274 4571 7561 6c28 636d  f.assertEqual(cm
+00026910: 2e65 7863 6570 7469 6f6e 2e6b 696e 642c  .exception.kind,
+00026920: 2022 6e6f 742d 666f 756e 6422 290a 2020   "not-found").  
+00026930: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00026940: 7449 6e28 222f 6e6f 742f 666f 756e 6422  tIn("/not/found"
+00026950: 2c20 636d 2e65 7863 6570 7469 6f6e 2e6d  , cm.exception.m
+00026960: 6573 7361 6765 290a 0a20 2020 2064 6566  essage)..    def
+00026970: 2074 6573 745f 7075 6c6c 5f64 6972 6563   test_pull_direc
+00026980: 746f 7279 2873 656c 6629 3a0a 2020 2020  tory(self):.    
+00026990: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+000269a0: 6d61 6b65 5f64 6972 2866 227b 7365 6c66  make_dir(f"{self
+000269b0: 2e70 7265 6669 787d 2f73 7562 6469 7222  .prefix}/subdir"
+000269c0: 290a 2020 2020 2020 2020 7769 7468 2073  ).        with s
+000269d0: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+000269e0: 2870 6562 626c 652e 5061 7468 4572 726f  (pebble.PathErro
+000269f0: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
+00026a00: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00026a10: 742e 7075 6c6c 2866 227b 7365 6c66 2e70  t.pull(f"{self.p
+00026a20: 7265 6669 787d 2f73 7562 6469 7222 290a  refix}/subdir").
+00026a30: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00026a40: 6572 7445 7175 616c 2863 6d2e 6578 6365  ertEqual(cm.exce
+00026a50: 7074 696f 6e2e 6b69 6e64 2c20 2267 656e  ption.kind, "gen
+00026a60: 6572 6963 2d66 696c 652d 6572 726f 7222  eric-file-error"
+00026a70: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00026a80: 7373 6572 7449 6e28 6622 7b73 656c 662e  ssertIn(f"{self.
+00026a90: 7072 6566 6978 7d2f 7375 6264 6972 222c  prefix}/subdir",
+00026aa0: 2063 6d2e 6578 6365 7074 696f 6e2e 6d65   cm.exception.me
+00026ab0: 7373 6167 6529 0a0a 2020 2020 6465 6620  ssage)..    def 
+00026ac0: 7465 7374 5f6c 6973 745f 6669 6c65 735f  test_list_files_
+00026ad0: 6e6f 745f 666f 756e 645f 7261 6973 6573  not_found_raises
+00026ae0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00026af0: 636c 6965 6e74 203d 2073 656c 662e 636c  client = self.cl
+00026b00: 6965 6e74 0a20 2020 2020 2020 2077 6974  ient.        wit
+00026b10: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00026b20: 7365 7328 7065 6262 6c65 2e41 5049 4572  ses(pebble.APIEr
+00026b30: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
+00026b40: 2020 2020 2020 2020 636c 6965 6e74 2e6c          client.l
+00026b50: 6973 745f 6669 6c65 7328 222f 6e6f 742f  ist_files("/not/
+00026b60: 6578 6973 7469 6e67 2f66 696c 652f 2229  existing/file/")
+00026b70: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00026b80: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
+00026b90: 6570 7469 6f6e 2e63 6f64 652c 2034 3034  eption.code, 404
+00026ba0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00026bb0: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00026bc0: 6365 7074 696f 6e2e 7374 6174 7573 2c20  ception.status, 
+00026bd0: 274e 6f74 2046 6f75 6e64 2729 0a20 2020  'Not Found').   
+00026be0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00026bf0: 4571 7561 6c28 636d 2e65 7863 6570 7469  Equal(cm.excepti
+00026c00: 6f6e 2e6d 6573 7361 6765 2c20 2773 7461  on.message, 'sta
+00026c10: 7420 2f6e 6f74 2f65 7869 7374 696e 672f  t /not/existing/
+00026c20: 6669 6c65 2f3a 206e 6f20 270a 2020 2020  file/: no '.    
+00026c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c50: 2020 2020 2020 2020 2020 2027 7375 6368             'such
+00026c60: 2066 696c 6520 6f72 2064 6972 6563 746f   file or directo
+00026c70: 7279 2729 0a0a 2020 2020 6465 6620 7465  ry')..    def te
+00026c80: 7374 5f6c 6973 745f 6469 7265 6374 6f72  st_list_director
+00026c90: 795f 6f62 6a65 6374 5f69 7473 656c 6628  y_object_itself(
+00026ca0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
+00026cb0: 6c69 656e 7420 3d20 7365 6c66 2e63 6c69  lient = self.cli
+00026cc0: 656e 740a 0a20 2020 2020 2020 2023 2054  ent..        # T
+00026cd0: 6573 7420 7769 7468 2072 6f6f 7420 6469  est with root di
+00026ce0: 720a 2020 2020 2020 2020 2320 2853 7065  r.        # (Spe
+00026cf0: 6369 616c 2063 6173 653b 2077 6520 776f  cial case; we wo
+00026d00: 6e27 7420 7072 6566 6978 2074 6869 732c  n't prefix this,
+00026d10: 2065 7665 6e20 7768 656e 2075 7369 6e67   even when using
+00026d20: 2074 6865 2072 6561 6c20 5065 6262 6c65   the real Pebble
+00026d30: 2073 6572 7665 722e 290a 2020 2020 2020   server.).      
+00026d40: 2020 6669 6c65 7320 3d20 636c 6965 6e74    files = client
+00026d50: 2e6c 6973 745f 6669 6c65 7328 272f 272c  .list_files('/',
+00026d60: 2069 7473 656c 663d 5472 7565 290a 2020   itself=True).  
+00026d70: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00026d80: 7445 7175 616c 286c 656e 2866 696c 6573  tEqual(len(files
+00026d90: 292c 2031 290a 2020 2020 2020 2020 6469  ), 1).        di
+00026da0: 725f 203d 2066 696c 6573 5b30 5d0a 2020  r_ = files[0].  
+00026db0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00026dc0: 7445 7175 616c 2864 6972 5f2e 7061 7468  tEqual(dir_.path
+00026dd0: 2c20 272f 2729 0a20 2020 2020 2020 2073  , '/').        s
+00026de0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00026df0: 6469 725f 2e6e 616d 652c 2027 2f27 290a  dir_.name, '/').
+00026e00: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00026e10: 6572 7445 7175 616c 2864 6972 5f2e 7479  ertEqual(dir_.ty
+00026e20: 7065 2c20 7065 6262 6c65 2e46 696c 6554  pe, pebble.FileT
+00026e30: 7970 652e 4449 5245 4354 4f52 5929 0a0a  ype.DIRECTORY)..
+00026e40: 2020 2020 2020 2020 2320 5465 7374 2077          # Test w
+00026e50: 6974 6820 7375 6264 6972 730a 2020 2020  ith subdirs.    
+00026e60: 2020 2020 636c 6965 6e74 2e6d 616b 655f      client.make_
+00026e70: 6469 7228 6622 7b73 656c 662e 7072 6566  dir(f"{self.pref
+00026e80: 6978 7d2f 7375 6264 6972 2229 0a20 2020  ix}/subdir").   
+00026e90: 2020 2020 2066 696c 6573 203d 2063 6c69       files = cli
+00026ea0: 656e 742e 6c69 7374 5f66 696c 6573 2866  ent.list_files(f
+00026eb0: 227b 7365 6c66 2e70 7265 6669 787d 2f73  "{self.prefix}/s
+00026ec0: 7562 6469 7222 2c20 6974 7365 6c66 3d54  ubdir", itself=T
+00026ed0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+00026ee0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+00026ef0: 6e28 6669 6c65 7329 2c20 3129 0a20 2020  n(files), 1).   
+00026f00: 2020 2020 2064 6972 5f20 3d20 6669 6c65       dir_ = file
+00026f10: 735b 305d 0a20 2020 2020 2020 2073 656c  s[0].        sel
+00026f20: 662e 6173 7365 7274 4571 7561 6c28 6469  f.assertEqual(di
+00026f30: 725f 2e6e 616d 652c 2027 7375 6264 6972  r_.name, 'subdir
+00026f40: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00026f50: 6173 7365 7274 4571 7561 6c28 6469 725f  assertEqual(dir_
+00026f60: 2e74 7970 652c 2070 6562 626c 652e 4669  .type, pebble.Fi
+00026f70: 6c65 5479 7065 2e44 4952 4543 544f 5259  leType.DIRECTORY
+00026f80: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+00026f90: 7075 7368 5f66 696c 6573 5f61 6e64 5f6c  push_files_and_l
+00026fa0: 6973 745f 6279 5f70 6174 7465 726e 2873  ist_by_pattern(s
+00026fb0: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
+00026fc0: 4e6f 7465 3a20 676c 6f62 2070 6174 7465  Note: glob patte
+00026fd0: 726e 2064 656c 7461 7320 646f 2065 7869  rn deltas do exi
+00026fe0: 7374 2062 6574 7765 656e 2067 6f6c 616e  st between golan
+00026ff0: 6720 616e 6420 5079 7468 6f6e 2c20 6275  g and Python, bu
+00027000: 7420 6865 7265 2c0a 2020 2020 2020 2020  t here,.        
+00027010: 2320 7765 276c 6c20 6a75 7374 2075 7365  # we'll just use
+00027020: 2061 2073 696d 706c 6520 2a20 7061 7474   a simple * patt
+00027030: 6572 6e2e 0a20 2020 2020 2020 2064 6174  ern..        dat
+00027040: 6120 3d20 2764 6174 6127 0a20 2020 2020  a = 'data'.     
+00027050: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00027060: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
+00027070: 666f 7220 6669 6c65 6e61 6d65 2069 6e20  for filename in 
+00027080: 280a 2020 2020 2020 2020 2020 2020 272f  (.            '/
+00027090: 6669 6c65 312e 677a 272c 0a20 2020 2020  file1.gz',.     
+000270a0: 2020 2020 2020 2027 2f66 696c 6532 2e74         '/file2.t
+000270b0: 6172 2e67 7a27 2c0a 2020 2020 2020 2020  ar.gz',.        
+000270c0: 2020 2020 272f 6669 6c65 332e 7461 722e      '/file3.tar.
+000270d0: 627a 3227 2c0a 2020 2020 2020 2020 2020  bz2',.          
+000270e0: 2020 272f 6261 636b 7570 5f66 696c 652e    '/backup_file.
+000270f0: 677a 272c 0a20 2020 2020 2020 2029 3a0a  gz',.        ):.
+00027100: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00027110: 6e74 2e70 7573 6828 7365 6c66 2e70 7265  nt.push(self.pre
+00027120: 6669 7820 2b20 6669 6c65 6e61 6d65 2c20  fix + filename, 
+00027130: 6461 7461 290a 2020 2020 2020 2020 6669  data).        fi
+00027140: 6c65 7320 3d20 636c 6965 6e74 2e6c 6973  les = client.lis
+00027150: 745f 6669 6c65 7328 6622 7b73 656c 662e  t_files(f"{self.
+00027160: 7072 6566 6978 7d2f 222c 2070 6174 7465  prefix}/", patte
+00027170: 726e 3d27 6669 6c65 2a2e 677a 2729 0a20  rn='file*.gz'). 
+00027180: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00027190: 7274 4571 7561 6c28 7b66 696c 652e 7061  rtEqual({file.pa
+000271a0: 7468 2066 6f72 2066 696c 6520 696e 2066  th for file in f
+000271b0: 696c 6573 7d2c 0a20 2020 2020 2020 2020  iles},.         
+000271c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000271d0: 7b73 656c 662e 7072 6566 6978 202b 2066  {self.prefix + f
+000271e0: 696c 6520 666f 7220 6669 6c65 2069 6e20  ile for file in 
+000271f0: 2827 2f66 696c 6531 2e67 7a27 2c20 272f  ('/file1.gz', '/
+00027200: 6669 6c65 322e 7461 722e 677a 2729 7d29  file2.tar.gz')})
+00027210: 0a0a 2020 2020 6465 6620 7465 7374 5f6d  ..    def test_m
+00027220: 616b 655f 6469 7265 6374 6f72 7928 7365  ake_directory(se
+00027230: 6c66 293a 0a20 2020 2020 2020 2063 6c69  lf):.        cli
+00027240: 656e 7420 3d20 7365 6c66 2e63 6c69 656e  ent = self.clien
+00027250: 740a 2020 2020 2020 2020 636c 6965 6e74  t.        client
+00027260: 2e6d 616b 655f 6469 7228 6622 7b73 656c  .make_dir(f"{sel
+00027270: 662e 7072 6566 6978 7d2f 7375 6264 6972  f.prefix}/subdir
+00027280: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00027290: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+000272a0: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
+000272b0: 6c69 7374 5f66 696c 6573 2866 227b 7365  list_files(f"{se
+000272c0: 6c66 2e70 7265 6669 787d 2f22 2c20 7061  lf.prefix}/", pa
+000272d0: 7474 6572 6e3d 2773 7562 6469 7227 295b  ttern='subdir')[
+000272e0: 305d 2e70 6174 682c 0a20 2020 2020 2020  0].path,.       
+000272f0: 2020 2020 2066 227b 7365 6c66 2e70 7265       f"{self.pre
+00027300: 6669 787d 2f73 7562 6469 7222 290a 2020  fix}/subdir").  
+00027310: 2020 2020 2020 636c 6965 6e74 2e6d 616b        client.mak
+00027320: 655f 6469 7228 6622 7b73 656c 662e 7072  e_dir(f"{self.pr
+00027330: 6566 6978 7d2f 7375 6264 6972 2f73 7562  efix}/subdir/sub
+00027340: 6469 7222 290a 2020 2020 2020 2020 7365  dir").        se
+00027350: 6c66 2e61 7373 6572 7445 7175 616c 280a  lf.assertEqual(.
+00027360: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00027370: 6e74 2e6c 6973 745f 6669 6c65 7328 6622  nt.list_files(f"
+00027380: 7b73 656c 662e 7072 6566 6978 7d2f 7375  {self.prefix}/su
+00027390: 6264 6972 222c 2070 6174 7465 726e 3d27  bdir", pattern='
+000273a0: 7375 6264 6972 2729 5b30 5d2e 7061 7468  subdir')[0].path
+000273b0: 2c0a 2020 2020 2020 2020 2020 2020 6622  ,.            f"
+000273c0: 7b73 656c 662e 7072 6566 6978 7d2f 7375  {self.prefix}/su
+000273d0: 6264 6972 2f73 7562 6469 7222 290a 0a20  bdir/subdir").. 
+000273e0: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
+000273f0: 5f64 6972 6563 746f 7279 5f72 6563 7572  _directory_recur
+00027400: 7369 7665 6c79 2873 656c 6629 3a0a 2020  sively(self):.  
+00027410: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+00027420: 656c 662e 636c 6965 6e74 0a0a 2020 2020  elf.client..    
+00027430: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00027440: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
+00027450: 652e 5061 7468 4572 726f 7229 2061 7320  e.PathError) as 
+00027460: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
+00027470: 636c 6965 6e74 2e6d 616b 655f 6469 7228  client.make_dir(
+00027480: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
+00027490: 7375 6264 6972 2f73 7562 6469 7222 2c20  subdir/subdir", 
+000274a0: 6d61 6b65 5f70 6172 656e 7473 3d46 616c  make_parents=Fal
+000274b0: 7365 290a 2020 2020 2020 2020 7365 6c66  se).        self
+000274c0: 2e61 7373 6572 7445 7175 616c 2863 6d2e  .assertEqual(cm.
+000274d0: 6578 6365 7074 696f 6e2e 6b69 6e64 2c20  exception.kind, 
+000274e0: 276e 6f74 2d66 6f75 6e64 2729 0a0a 2020  'not-found')..  
+000274f0: 2020 2020 2020 636c 6965 6e74 2e6d 616b        client.mak
+00027500: 655f 6469 7228 6622 7b73 656c 662e 7072  e_dir(f"{self.pr
+00027510: 6566 6978 7d2f 7375 6264 6972 2f73 7562  efix}/subdir/sub
+00027520: 6469 7222 2c20 6d61 6b65 5f70 6172 656e  dir", make_paren
+00027530: 7473 3d54 7275 6529 0a20 2020 2020 2020  ts=True).       
+00027540: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00027550: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
+00027560: 6c69 656e 742e 6c69 7374 5f66 696c 6573  lient.list_files
+00027570: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
+00027580: 2f73 7562 6469 7222 2c20 7061 7474 6572  /subdir", patter
+00027590: 6e3d 2773 7562 6469 7227 295b 305d 2e70  n='subdir')[0].p
+000275a0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+000275b0: 2066 227b 7365 6c66 2e70 7265 6669 787d   f"{self.prefix}
+000275c0: 2f73 7562 6469 722f 7375 6264 6972 2229  /subdir/subdir")
+000275d0: 0a0a 2020 2020 6465 6620 7465 7374 5f6d  ..    def test_m
+000275e0: 616b 655f 6469 7265 6374 6f72 795f 7769  ake_directory_wi
+000275f0: 7468 5f72 656c 6174 6976 655f 7061 7468  th_relative_path
+00027600: 5f66 6169 6c73 2873 656c 6629 3a0a 2020  _fails(self):.  
+00027610: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+00027620: 656c 662e 636c 6965 6e74 0a20 2020 2020  elf.client.     
+00027630: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+00027640: 6572 7452 6169 7365 7328 7065 6262 6c65  ertRaises(pebble
+00027650: 2e50 6174 6845 7272 6f72 2920 6173 2063  .PathError) as c
+00027660: 6d3a 0a20 2020 2020 2020 2020 2020 2063  m:.            c
+00027670: 6c69 656e 742e 6d61 6b65 5f64 6972 2827  lient.make_dir('
+00027680: 6469 7227 290a 2020 2020 2020 2020 7365  dir').        se
+00027690: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+000276a0: 6d2e 6578 6365 7074 696f 6e2e 6b69 6e64  m.exception.kind
+000276b0: 2c20 2767 656e 6572 6963 2d66 696c 652d  , 'generic-file-
+000276c0: 6572 726f 7227 290a 0a20 2020 2064 6566  error')..    def
+000276d0: 2074 6573 745f 6d61 6b65 5f73 7562 6469   test_make_subdi
+000276e0: 725f 6f66 5f66 696c 655f 6661 696c 7328  r_of_file_fails(
+000276f0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
+00027700: 6c69 656e 7420 3d20 7365 6c66 2e63 6c69  lient = self.cli
+00027710: 656e 740a 2020 2020 2020 2020 636c 6965  ent.        clie
+00027720: 6e74 2e70 7573 6828 6622 7b73 656c 662e  nt.push(f"{self.
+00027730: 7072 6566 6978 7d2f 6669 6c65 222c 2027  prefix}/file", '
+00027740: 6461 7461 2729 0a0a 2020 2020 2020 2020  data')..        
+00027750: 2320 4469 7265 6374 2063 6869 6c64 2063  # Direct child c
+00027760: 6173 650a 2020 2020 2020 2020 7769 7468  ase.        with
+00027770: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00027780: 6573 2870 6562 626c 652e 5061 7468 4572  es(pebble.PathEr
+00027790: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
+000277a0: 2020 2020 2020 2020 636c 6965 6e74 2e6d          client.m
+000277b0: 616b 655f 6469 7228 6622 7b73 656c 662e  ake_dir(f"{self.
+000277c0: 7072 6566 6978 7d2f 6669 6c65 2f73 7562  prefix}/file/sub
+000277d0: 6469 7222 290a 2020 2020 2020 2020 7365  dir").        se
+000277e0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+000277f0: 6d2e 6578 6365 7074 696f 6e2e 6b69 6e64  m.exception.kind
+00027800: 2c20 2767 656e 6572 6963 2d66 696c 652d  , 'generic-file-
+00027810: 6572 726f 7227 290a 0a20 2020 2020 2020  error')..       
+00027820: 2023 2052 6563 7572 7369 7665 2063 7265   # Recursive cre
+00027830: 6174 696f 6e20 6361 7365 2c20 696e 2063  ation case, in c
+00027840: 6173 6520 6974 7320 666c 6f77 2069 7320  ase its flow is 
+00027850: 6469 6666 6572 656e 740a 2020 2020 2020  different.      
+00027860: 2020 7769 7468 2073 656c 662e 6173 7365    with self.asse
+00027870: 7274 5261 6973 6573 2870 6562 626c 652e  rtRaises(pebble.
+00027880: 5061 7468 4572 726f 7229 2061 7320 636d  PathError) as cm
+00027890: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+000278a0: 6965 6e74 2e6d 616b 655f 6469 7228 6622  ient.make_dir(f"
+000278b0: 7b73 656c 662e 7072 6566 6978 7d2f 6669  {self.prefix}/fi
+000278c0: 6c65 2f73 7562 6469 722f 7375 6264 6972  le/subdir/subdir
+000278d0: 222c 206d 616b 655f 7061 7265 6e74 733d  ", make_parents=
+000278e0: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
+000278f0: 6c66 2e61 7373 6572 7445 7175 616c 2863  lf.assertEqual(c
+00027900: 6d2e 6578 6365 7074 696f 6e2e 6b69 6e64  m.exception.kind
+00027910: 2c20 2767 656e 6572 6963 2d66 696c 652d  , 'generic-file-
+00027920: 6572 726f 7227 290a 0a20 2020 2064 6566  error')..    def
+00027930: 2074 6573 745f 6d61 6b65 5f64 6972 5f77   test_make_dir_w
+00027940: 6974 685f 7065 726d 6973 7369 6f6e 5f6d  ith_permission_m
+00027950: 6173 6b28 7365 6c66 293a 0a20 2020 2020  ask(self):.     
+00027960: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00027970: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
+00027980: 636c 6965 6e74 2e6d 616b 655f 6469 7228  client.make_dir(
+00027990: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
+000279a0: 6469 7231 222c 2070 6572 6d69 7373 696f  dir1", permissio
+000279b0: 6e73 3d30 6f37 3030 290a 2020 2020 2020  ns=0o700).      
+000279c0: 2020 636c 6965 6e74 2e6d 616b 655f 6469    client.make_di
+000279d0: 7228 6622 7b73 656c 662e 7072 6566 6978  r(f"{self.prefix
+000279e0: 7d2f 6469 7232 222c 2070 6572 6d69 7373  }/dir2", permiss
+000279f0: 696f 6e73 3d30 6f37 3737 290a 0a20 2020  ions=0o777)..   
+00027a00: 2020 2020 2066 696c 6573 203d 2063 6c69       files = cli
+00027a10: 656e 742e 6c69 7374 5f66 696c 6573 2866  ent.list_files(f
+00027a20: 227b 7365 6c66 2e70 7265 6669 787d 2f22  "{self.prefix}/"
+00027a30: 2c20 7061 7474 6572 6e3d 2764 6972 2a27  , pattern='dir*'
+00027a40: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00027a50: 7373 6572 7445 7175 616c 285b 6620 666f  ssertEqual([f fo
+00027a60: 7220 6620 696e 2066 696c 6573 2069 6620  r f in files if 
+00027a70: 662e 7061 7468 203d 3d20 6622 7b73 656c  f.path == f"{sel
+00027a80: 662e 7072 6566 6978 7d2f 6469 7231 225d  f.prefix}/dir1"]
+00027a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027aa0: 2020 2020 2020 2020 2020 5b30 5d2e 7065            [0].pe
+00027ab0: 726d 6973 7369 6f6e 732c 2030 6f37 3030  rmissions, 0o700
+00027ac0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00027ad0: 7373 6572 7445 7175 616c 285b 6620 666f  ssertEqual([f fo
+00027ae0: 7220 6620 696e 2066 696c 6573 2069 6620  r f in files if 
+00027af0: 662e 7061 7468 203d 3d20 6622 7b73 656c  f.path == f"{sel
+00027b00: 662e 7072 6566 6978 7d2f 6469 7232 225d  f.prefix}/dir2"]
+00027b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027b20: 2020 2020 2020 2020 2020 5b30 5d2e 7065            [0].pe
+00027b30: 726d 6973 7369 6f6e 732c 2030 6f37 3737  rmissions, 0o777
+00027b40: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
+00027b50: 7065 726d 6973 7369 6f6e 7320 6172 6520  permissions are 
+00027b60: 6f75 7473 6964 6520 6f66 2074 6865 2072  outside of the r
+00027b70: 616e 6765 2030 6f30 3030 2074 6872 6f75  ange 0o000 throu
+00027b80: 6768 2030 6f37 3737 2c20 616e 2065 7863  gh 0o777, an exc
+00027b90: 6570 7469 6f6e 2073 686f 756c 6420 6265  eption should be
+00027ba0: 0a20 2020 2020 2020 2023 2072 6169 7365  .        # raise
+00027bb0: 642e 0a20 2020 2020 2020 2066 6f72 2069  d..        for i
+00027bc0: 2c20 6261 645f 7065 726d 6973 7369 6f6e  , bad_permission
+00027bd0: 2069 6e20 656e 756d 6572 6174 6528 280a   in enumerate((.
+00027be0: 2020 2020 2020 2020 2020 2020 306f 3130              0o10
+00027bf0: 3030 2c20 2023 2045 7863 6565 6473 2030  00,  # Exceeds 0
+00027c00: 6f37 3737 0a20 2020 2020 2020 2020 2020  o777.           
+00027c10: 202d 312c 2020 2020 2020 2320 4c65 7373   -1,      # Less
+00027c20: 2074 6861 6e20 306f 3030 300a 2020 2020   than 0o000.    
+00027c30: 2020 2020 2929 3a0a 2020 2020 2020 2020      )):.        
+00027c40: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+00027c50: 7365 7274 5261 6973 6573 2870 6562 626c  sertRaises(pebbl
+00027c60: 652e 5061 7468 4572 726f 7229 2061 7320  e.PathError) as 
+00027c70: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
+00027c80: 2020 2020 636c 6965 6e74 2e6d 616b 655f      client.make_
+00027c90: 6469 7228 6622 7b73 656c 662e 7072 6566  dir(f"{self.pref
+00027ca0: 6978 7d2f 6469 7233 5f7b 697d 222c 2070  ix}/dir3_{i}", p
+00027cb0: 6572 6d69 7373 696f 6e73 3d62 6164 5f70  ermissions=bad_p
+00027cc0: 6572 6d69 7373 696f 6e29 0a20 2020 2020  ermission).     
+00027cd0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00027ce0: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
+00027cf0: 7469 6f6e 2e6b 696e 642c 2027 6765 6e65  tion.kind, 'gene
+00027d00: 7269 632d 6669 6c65 2d65 7272 6f72 2729  ric-file-error')
+00027d10: 0a0a 2020 2020 6465 6620 7465 7374 5f72  ..    def test_r
+00027d20: 656d 6f76 655f 7061 7468 2873 656c 6629  emove_path(self)
+00027d30: 3a0a 2020 2020 2020 2020 636c 6965 6e74  :.        client
+00027d40: 203d 2073 656c 662e 636c 6965 6e74 0a20   = self.client. 
+00027d50: 2020 2020 2020 2063 6c69 656e 742e 7075         client.pu
+00027d60: 7368 2866 227b 7365 6c66 2e70 7265 6669  sh(f"{self.prefi
+00027d70: 787d 2f66 696c 6522 2c20 2727 290a 2020  x}/file", '').  
+00027d80: 2020 2020 2020 636c 6965 6e74 2e6d 616b        client.mak
+00027d90: 655f 6469 7228 6622 7b73 656c 662e 7072  e_dir(f"{self.pr
+00027da0: 6566 6978 7d2f 6469 722f 7375 6264 6972  efix}/dir/subdir
+00027db0: 222c 206d 616b 655f 7061 7265 6e74 733d  ", make_parents=
+00027dc0: 5472 7565 290a 2020 2020 2020 2020 636c  True).        cl
+00027dd0: 6965 6e74 2e70 7573 6828 6622 7b73 656c  ient.push(f"{sel
+00027de0: 662e 7072 6566 6978 7d2f 6469 722f 7375  f.prefix}/dir/su
+00027df0: 6264 6972 2f66 696c 6531 222c 2027 2729  bdir/file1", '')
+00027e00: 0a20 2020 2020 2020 2063 6c69 656e 742e  .        client.
+00027e10: 7075 7368 2866 227b 7365 6c66 2e70 7265  push(f"{self.pre
+00027e20: 6669 787d 2f64 6972 2f73 7562 6469 722f  fix}/dir/subdir/
+00027e30: 6669 6c65 3222 2c20 2727 290a 2020 2020  file2", '').    
+00027e40: 2020 2020 636c 6965 6e74 2e70 7573 6828      client.push(
+00027e50: 6622 7b73 656c 662e 7072 6566 6978 7d2f  f"{self.prefix}/
+00027e60: 6469 722f 7375 6264 6972 2f66 696c 6533  dir/subdir/file3
+00027e70: 222c 2027 2729 0a20 2020 2020 2020 2063  ", '').        c
+00027e80: 6c69 656e 742e 6d61 6b65 5f64 6972 2866  lient.make_dir(f
+00027e90: 227b 7365 6c66 2e70 7265 6669 787d 2f65  "{self.prefix}/e
+00027ea0: 6d70 7479 5f64 6972 2229 0a0a 2020 2020  mpty_dir")..    
+00027eb0: 2020 2020 636c 6965 6e74 2e72 656d 6f76      client.remov
+00027ec0: 655f 7061 7468 2866 227b 7365 6c66 2e70  e_path(f"{self.p
+00027ed0: 7265 6669 787d 2f66 696c 6522 290a 0a20  refix}/file").. 
+00027ee0: 2020 2020 2020 2063 6c69 656e 742e 7265         client.re
+00027ef0: 6d6f 7665 5f70 6174 6828 6622 7b73 656c  move_path(f"{sel
+00027f00: 662e 7072 6566 6978 7d2f 656d 7074 795f  f.prefix}/empty_
+00027f10: 6469 7222 290a 0a20 2020 2020 2020 2023  dir")..        #
+00027f20: 2052 656d 6f76 6520 6e6f 6e2d 656d 7074   Remove non-empt
+00027f30: 7920 6469 7265 6374 6f72 792c 2072 6563  y directory, rec
+00027f40: 7572 7369 7665 3d46 616c 7365 3a20 6572  ursive=False: er
+00027f50: 726f 720a 2020 2020 2020 2020 7769 7468  ror.        with
+00027f60: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+00027f70: 6573 2870 6562 626c 652e 5061 7468 4572  es(pebble.PathEr
+00027f80: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
+00027f90: 2020 2020 2020 2020 636c 6965 6e74 2e72          client.r
+00027fa0: 656d 6f76 655f 7061 7468 2866 227b 7365  emove_path(f"{se
+00027fb0: 6c66 2e70 7265 6669 787d 2f64 6972 222c  lf.prefix}/dir",
+00027fc0: 2072 6563 7572 7369 7665 3d46 616c 7365   recursive=False
+00027fd0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00027fe0: 7373 6572 7445 7175 616c 2863 6d2e 6578  ssertEqual(cm.ex
+00027ff0: 6365 7074 696f 6e2e 6b69 6e64 2c20 2767  ception.kind, 'g
+00028000: 656e 6572 6963 2d66 696c 652d 6572 726f  eneric-file-erro
+00028010: 7227 290a 0a20 2020 2020 2020 2023 2052  r')..        # R
+00028020: 656d 6f76 6520 6e6f 6e2d 656d 7074 7920  emove non-empty 
+00028030: 6469 7265 6374 6f72 792c 2072 6563 7572  directory, recur
+00028040: 7369 7665 3d54 7275 653a 2073 7563 6365  sive=True: succe
+00028050: 6564 7320 2861 6e64 2072 656d 6f76 6573  eds (and removes
+00028060: 2063 6869 6c64 206f 626a 6563 7473 290a   child objects).
+00028070: 2020 2020 2020 2020 636c 6965 6e74 2e72          client.r
+00028080: 656d 6f76 655f 7061 7468 2866 227b 7365  emove_path(f"{se
+00028090: 6c66 2e70 7265 6669 787d 2f64 6972 222c  lf.prefix}/dir",
+000280a0: 2072 6563 7572 7369 7665 3d54 7275 6529   recursive=True)
+000280b0: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
+000280c0: 7665 206e 6f6e 2d65 7869 7374 656e 7420  ve non-existent 
+000280d0: 7061 7468 2c20 7265 6375 7273 6976 653d  path, recursive=
+000280e0: 4661 6c73 653a 2065 7272 6f72 0a20 2020  False: error.   
+000280f0: 2020 2020 2077 6974 6820 7365 6c66 2e61       with self.a
+00028100: 7373 6572 7452 6169 7365 7328 7065 6262  ssertRaises(pebb
+00028110: 6c65 2e50 6174 6845 7272 6f72 2920 6173  le.PathError) as
+00028120: 2063 6d3a 0a20 2020 2020 2020 2020 2020   cm:.           
+00028130: 2063 6c69 656e 742e 7265 6d6f 7665 5f70   client.remove_p
+00028140: 6174 6828 6622 7b73 656c 662e 7072 6566  ath(f"{self.pref
+00028150: 6978 7d2f 6469 722f 646f 6573 2f6e 6f74  ix}/dir/does/not
+00028160: 2f65 7869 7374 2f61 7364 6622 2c20 7265  /exist/asdf", re
+00028170: 6375 7273 6976 653d 4661 6c73 6529 0a20  cursive=False). 
+00028180: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00028190: 7274 4571 7561 6c28 636d 2e65 7863 6570  rtEqual(cm.excep
+000281a0: 7469 6f6e 2e6b 696e 642c 2027 6e6f 742d  tion.kind, 'not-
+000281b0: 666f 756e 6427 290a 0a20 2020 2020 2020  found')..       
+000281c0: 2023 2052 656d 6f76 6520 6e6f 6e2d 6578   # Remove non-ex
+000281d0: 6973 7465 6e74 2070 6174 682c 2072 6563  istent path, rec
+000281e0: 7572 7369 7665 3d54 7275 653a 2073 7563  ursive=True: suc
+000281f0: 6365 6564 730a 2020 2020 2020 2020 636c  ceeds.        cl
+00028200: 6965 6e74 2e72 656d 6f76 655f 7061 7468  ient.remove_path
+00028210: 2866 227b 7365 6c66 2e70 7265 6669 787d  (f"{self.prefix}
+00028220: 2f64 6972 2f64 6f65 732f 6e6f 742f 6578  /dir/does/not/ex
+00028230: 6973 742f 6173 6466 222c 2072 6563 7572  ist/asdf", recur
+00028240: 7369 7665 3d54 7275 6529 0a0a 2020 2020  sive=True)..    
+00028250: 2320 4f74 6865 7220 6e6f 7465 733a 0a20  # Other notes:. 
+00028260: 2020 2023 202a 2050 6172 656e 7420 6469     # * Parent di
+00028270: 7265 6374 6f72 6965 7320 6372 6561 7465  rectories create
+00028280: 6420 7669 6120 7075 7368 286d 616b 655f  d via push(make_
+00028290: 6469 7273 3d54 7275 6529 2064 6566 6175  dirs=True) defau
+000282a0: 6c74 2074 6f20 726f 6f74 3a72 6f6f 7420  lt to root:root 
+000282b0: 6f77 6e65 7273 6869 700a 2020 2020 2320  ownership.    # 
+000282c0: 2020 616e 6420 7768 6174 6576 6572 2070    and whatever p
+000282d0: 6572 6d69 7373 696f 6e73 2061 7265 2073  ermissions are s
+000282e0: 7065 6369 6669 6564 2076 6961 2074 6865  pecified via the
+000282f0: 2070 6572 6d69 7373 696f 6e73 2061 7267   permissions arg
+00028300: 756d 656e 743b 2061 7320 7765 2064 6566  ument; as we def
+00028310: 6175 6c74 2074 6f20 4e6f 6e65 0a20 2020  ault to None.   
+00028320: 2023 2020 2066 6f72 206f 776e 6572 7368   #   for ownersh
+00028330: 6970 2f70 6572 6d69 7373 696f 6e73 2c20  ip/permissions, 
+00028340: 7765 2064 6f20 6967 6e6f 7265 2074 6869  we do ignore thi
+00028350: 7320 6e75 616e 6365 2e0a 2020 2020 2320  s nuance..    # 
+00028360: 2a20 5061 7265 6e74 2064 6972 6563 746f  * Parent directo
+00028370: 7269 6573 2063 7265 6174 6564 2076 6961  ries created via
+00028380: 206d 616b 655f 6469 7228 6d61 6b65 5f70   make_dir(make_p
+00028390: 6172 656e 7473 3d54 7275 6529 2064 6566  arents=True) def
+000283a0: 6175 6c74 2074 6f20 726f 6f74 3a72 6f6f  ault to root:roo
+000283b0: 7420 6f77 6e65 7273 6869 700a 2020 2020  t ownership.    
+000283c0: 2320 2020 616e 6420 306f 3735 3520 7065  #   and 0o755 pe
+000283d0: 726d 6973 7369 6f6e 733b 2061 7320 7765  rmissions; as we
+000283e0: 2064 6566 6175 6c74 2074 6f20 4e6f 6e65   default to None
+000283f0: 2066 6f72 206f 776e 6572 7368 6970 2f70   for ownership/p
+00028400: 6572 6d69 7373 696f 6e73 2c20 7765 2064  ermissions, we d
+00028410: 6f20 6967 6e6f 7265 2074 6869 730a 2020  o ignore this.  
+00028420: 2020 2320 2020 6e75 616e 6365 2e0a 0a0a    #   nuance....
+00028430: 636c 6173 7320 4765 6e65 7269 6354 6573  class GenericTes
+00028440: 7469 6e67 4669 6c65 7379 7374 656d 5465  tingFilesystemTe
+00028450: 7374 733a 0a20 2020 2064 6566 2074 6573  sts:.    def tes
+00028460: 745f 6c69 7374 6469 725f 726f 6f74 5f6f  t_listdir_root_o
+00028470: 6e5f 656d 7074 795f 6f73 2873 656c 6629  n_empty_os(self)
+00028480: 3a0a 2020 2020 2020 2020 7365 6c66 2e61  :.        self.a
+00028490: 7373 6572 7445 7175 616c 2873 656c 662e  ssertEqual(self.
+000284a0: 6673 2e6c 6973 745f 6469 7228 272f 2729  fs.list_dir('/')
+000284b0: 2c20 5b5d 290a 0a20 2020 2064 6566 2074  , [])..    def t
+000284c0: 6573 745f 6c69 7374 6469 725f 6f6e 5f6e  est_listdir_on_n
+000284d0: 6f6e 6578 6973 7465 6e74 5f64 6972 2873  onexistent_dir(s
+000284e0: 656c 6629 3a0a 2020 2020 2020 2020 7769  elf):.        wi
+000284f0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+00028500: 6973 6573 2846 696c 654e 6f74 466f 756e  ises(FileNotFoun
+00028510: 6445 7272 6f72 2920 6173 2063 6d3a 0a20  dError) as cm:. 
+00028520: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00028530: 6673 2e6c 6973 745f 6469 7228 272f 6574  fs.list_dir('/et
+00028540: 6327 290a 2020 2020 2020 2020 7365 6c66  c').        self
+00028550: 2e61 7373 6572 7454 7275 6528 272f 6574  .assertTrue('/et
+00028560: 6327 2069 6e20 636d 2e65 7863 6570 7469  c' in cm.excepti
+00028570: 6f6e 2e61 7267 735b 305d 290a 0a20 2020  on.args[0])..   
+00028580: 2064 6566 2074 6573 745f 6c69 7374 6469   def test_listdi
+00028590: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
+000285a0: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
+000285b0: 6469 7228 272f 6f70 7427 290a 2020 2020  dir('/opt').    
+000285c0: 2020 2020 7365 6c66 2e66 732e 6372 6561      self.fs.crea
+000285d0: 7465 5f66 696c 6528 272f 6f70 742f 6669  te_file('/opt/fi
+000285e0: 6c65 3127 2c20 2764 6174 6127 290a 2020  le1', 'data').  
+000285f0: 2020 2020 2020 7365 6c66 2e66 732e 6372        self.fs.cr
+00028600: 6561 7465 5f66 696c 6528 272f 6f70 742f  eate_file('/opt/
+00028610: 6669 6c65 3227 2c20 2764 6174 6127 290a  file2', 'data').
+00028620: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+00028630: 5f72 6573 756c 7473 203d 207b 0a20 2020  _results = {.   
+00028640: 2020 2020 2020 2020 2070 6174 686c 6962           pathlib
+00028650: 2e50 7572 6550 6f73 6978 5061 7468 2827  .PurePosixPath('
+00028660: 2f6f 7074 2f66 696c 6531 2729 2c0a 2020  /opt/file1'),.  
+00028670: 2020 2020 2020 2020 2020 7061 7468 6c69            pathli
+00028680: 622e 5075 7265 506f 7369 7850 6174 6828  b.PurePosixPath(
+00028690: 272f 6f70 742f 6669 6c65 3227 297d 0a20  '/opt/file2')}. 
+000286a0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000286b0: 7274 4571 7561 6c28 6578 7065 6374 6564  rtEqual(expected
+000286c0: 5f72 6573 756c 7473 2c20 7b66 2e70 6174  _results, {f.pat
+000286d0: 6820 666f 7220 6620 696e 2073 656c 662e  h for f in self.
+000286e0: 6673 2e6c 6973 745f 6469 7228 272f 6f70  fs.list_dir('/op
+000286f0: 7427 297d 290a 2020 2020 2020 2020 2320  t')}).        # 
+00028700: 456e 7375 7265 2074 6861 7420 5061 7468  Ensure that Path
+00028710: 7320 616c 736f 2077 6f72 6b20 666f 7220  s also work for 
+00028720: 6c69 7374 6469 720a 2020 2020 2020 2020  listdir.        
+00028730: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00028740: 280a 2020 2020 2020 2020 2020 2020 6578  (.            ex
+00028750: 7065 6374 6564 5f72 6573 756c 7473 2c20  pected_results, 
+00028760: 7b66 2e70 6174 6820 666f 7220 6620 696e  {f.path for f in
+00028770: 2073 656c 662e 6673 2e6c 6973 745f 6469   self.fs.list_di
+00028780: 7228 7061 7468 6c69 622e 5075 7265 506f  r(pathlib.PurePo
+00028790: 7369 7850 6174 6828 272f 6f70 7427 2929  sixPath('/opt'))
+000287a0: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
+000287b0: 5f6c 6973 7464 6972 5f6f 6e5f 6669 6c65  _listdir_on_file
+000287c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000287d0: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
+000287e0: 696c 6528 272f 6669 6c65 272c 2027 6461  ile('/file', 'da
+000287f0: 7461 2729 0a20 2020 2020 2020 2077 6974  ta').        wit
+00028800: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00028810: 7365 7328 4e6f 7441 4469 7265 6374 6f72  ses(NotADirector
+00028820: 7945 7272 6f72 2920 6173 2063 6d3a 0a20  yError) as cm:. 
+00028830: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00028840: 6673 2e6c 6973 745f 6469 7228 272f 6669  fs.list_dir('/fi
+00028850: 6c65 2729 0a20 2020 2020 2020 2073 656c  le').        sel
+00028860: 662e 6173 7365 7274 5472 7565 2827 2f66  f.assertTrue('/f
+00028870: 696c 6527 2069 6e20 636d 2e65 7863 6570  ile' in cm.excep
+00028880: 7469 6f6e 2e61 7267 735b 305d 290a 0a20  tion.args[0]).. 
+00028890: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
+000288a0: 6469 7228 7365 6c66 293a 0a20 2020 2020  dir(self):.     
+000288b0: 2020 2064 203d 2073 656c 662e 6673 2e63     d = self.fs.c
+000288c0: 7265 6174 655f 6469 7228 272f 6574 6327  reate_dir('/etc'
+000288d0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000288e0: 7373 6572 7445 7175 616c 2864 2e6e 616d  ssertEqual(d.nam
+000288f0: 652c 2027 6574 6327 290a 2020 2020 2020  e, 'etc').      
+00028900: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00028910: 616c 2864 2e70 6174 682c 2070 6174 686c  al(d.path, pathl
+00028920: 6962 2e50 7572 6550 6f73 6978 5061 7468  ib.PurePosixPath
+00028930: 2827 2f65 7463 2729 290a 2020 2020 2020  ('/etc')).      
+00028940: 2020 6432 203d 2073 656c 662e 6673 2e63    d2 = self.fs.c
+00028950: 7265 6174 655f 6469 7228 272f 6574 632f  reate_dir('/etc/
+00028960: 696e 6974 2e64 2729 0a20 2020 2020 2020  init.d').       
+00028970: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00028980: 6c28 6432 2e6e 616d 652c 2027 696e 6974  l(d2.name, 'init
+00028990: 2e64 2729 0a20 2020 2020 2020 2073 656c  .d').        sel
+000289a0: 662e 6173 7365 7274 4571 7561 6c28 6432  f.assertEqual(d2
+000289b0: 2e70 6174 682c 2070 6174 686c 6962 2e50  .path, pathlib.P
+000289c0: 7572 6550 6f73 6978 5061 7468 2827 2f65  urePosixPath('/e
+000289d0: 7463 2f69 6e69 742e 6427 2929 0a0a 2020  tc/init.d'))..  
+000289e0: 2020 6465 6620 7465 7374 5f6d 616b 6564    def test_maked
+000289f0: 6972 5f66 6169 6c73 5f69 665f 616c 7265  ir_fails_if_alre
+00028a00: 6164 795f 6578 6973 7473 2873 656c 6629  ady_exists(self)
+00028a10: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
+00028a20: 732e 6372 6561 7465 5f64 6972 2827 2f65  s.create_dir('/e
+00028a30: 7463 2729 0a20 2020 2020 2020 2077 6974  tc').        wit
+00028a40: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+00028a50: 7365 7328 4669 6c65 4578 6973 7473 4572  ses(FileExistsEr
+00028a60: 726f 7229 2061 7320 636d 3a0a 2020 2020  ror) as cm:.    
+00028a70: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
+00028a80: 6372 6561 7465 5f64 6972 2827 2f65 7463  create_dir('/etc
+00028a90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00028aa0: 6173 7365 7274 5472 7565 2827 2f65 7463  assertTrue('/etc
+00028ab0: 2720 696e 2063 6d2e 6578 6365 7074 696f  ' in cm.exceptio
+00028ac0: 6e2e 6172 6773 5b30 5d29 0a0a 2020 2020  n.args[0])..    
+00028ad0: 6465 6620 7465 7374 5f6d 616b 6564 6972  def test_makedir
+00028ae0: 5f73 7563 6365 6564 735f 6966 5f61 6c72  _succeeds_if_alr
+00028af0: 6561 6479 5f65 7869 7374 735f 7768 656e  eady_exists_when
+00028b00: 5f6d 616b 655f 7061 7265 6e74 735f 7472  _make_parents_tr
+00028b10: 7565 2873 656c 6629 3a0a 2020 2020 2020  ue(self):.      
+00028b20: 2020 6431 203d 2073 656c 662e 6673 2e63    d1 = self.fs.c
+00028b30: 7265 6174 655f 6469 7228 272f 6574 6327  reate_dir('/etc'
+00028b40: 290a 2020 2020 2020 2020 6432 203d 2073  ).        d2 = s
+00028b50: 656c 662e 6673 2e63 7265 6174 655f 6469  elf.fs.create_di
+00028b60: 7228 272f 6574 6327 2c20 6d61 6b65 5f70  r('/etc', make_p
+00028b70: 6172 656e 7473 3d54 7275 6529 0a20 2020  arents=True).   
+00028b80: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00028b90: 4571 7561 6c28 6431 2e70 6174 682c 2064  Equal(d1.path, d
+00028ba0: 322e 7061 7468 290a 2020 2020 2020 2020  2.path).        
+00028bb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00028bc0: 2864 312e 6e61 6d65 2c20 6432 2e6e 616d  (d1.name, d2.nam
+00028bd0: 6529 0a0a 2020 2020 6465 6620 7465 7374  e)..    def test
+00028be0: 5f6d 616b 6564 6972 5f66 6169 6c73 5f69  _makedir_fails_i
+00028bf0: 665f 7061 7265 6e74 5f64 6972 5f64 6f65  f_parent_dir_doe
+00028c00: 736e 745f 6578 6973 7428 7365 6c66 293a  snt_exist(self):
+00028c10: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00028c20: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00028c30: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+00028c40: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
+00028c50: 2020 2020 2020 7365 6c66 2e66 732e 6372        self.fs.cr
+00028c60: 6561 7465 5f64 6972 2827 2f65 7463 2f69  eate_dir('/etc/i
+00028c70: 6e69 742e 6427 290a 2020 2020 2020 2020  nit.d').        
+00028c80: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+00028c90: 272f 6574 6327 2069 6e20 636d 2e65 7863  '/etc' in cm.exc
+00028ca0: 6570 7469 6f6e 2e61 7267 735b 305d 290a  eption.args[0]).
+00028cb0: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
+00028cc0: 6b65 5f61 6e64 5f6c 6973 745f 6469 7265  ke_and_list_dire
+00028cd0: 6374 6f72 7928 7365 6c66 293a 0a20 2020  ctory(self):.   
+00028ce0: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
+00028cf0: 6174 655f 6469 7228 272f 6574 6327 290a  ate_dir('/etc').
+00028d00: 2020 2020 2020 2020 7365 6c66 2e66 732e          self.fs.
+00028d10: 6372 6561 7465 5f64 6972 2827 2f76 6172  create_dir('/var
+00028d20: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00028d30: 6173 7365 7274 4571 7561 6c28 0a20 2020  assertEqual(.   
+00028d40: 2020 2020 2020 2020 207b 662e 7061 7468           {f.path
+00028d50: 2066 6f72 2066 2069 6e20 7365 6c66 2e66   for f in self.f
+00028d60: 732e 6c69 7374 5f64 6972 2827 2f27 297d  s.list_dir('/')}
+00028d70: 2c0a 2020 2020 2020 2020 2020 2020 7b70  ,.            {p
+00028d80: 6174 686c 6962 2e50 7572 6550 6f73 6978  athlib.PurePosix
+00028d90: 5061 7468 2827 2f65 7463 2729 2c20 7061  Path('/etc'), pa
+00028da0: 7468 6c69 622e 5075 7265 506f 7369 7850  thlib.PurePosixP
+00028db0: 6174 6828 272f 7661 7227 297d 290a 0a20  ath('/var')}).. 
+00028dc0: 2020 2064 6566 2074 6573 745f 6d61 6b65     def test_make
+00028dd0: 5f64 6972 6563 746f 7279 5f72 6563 7572  _directory_recur
+00028de0: 7369 7665 6c79 2873 656c 6629 3a0a 2020  sively(self):.  
+00028df0: 2020 2020 2020 7365 6c66 2e66 732e 6372        self.fs.cr
+00028e00: 6561 7465 5f64 6972 2827 2f65 7463 2f69  eate_dir('/etc/i
+00028e10: 6e69 742e 6427 2c20 6d61 6b65 5f70 6172  nit.d', make_par
+00028e20: 656e 7473 3d54 7275 6529 0a20 2020 2020  ents=True).     
+00028e30: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+00028e40: 7561 6c28 5b73 7472 286f 2e70 6174 6829  ual([str(o.path)
+00028e50: 2066 6f72 206f 2069 6e20 7365 6c66 2e66   for o in self.f
+00028e60: 732e 6c69 7374 5f64 6972 2827 2f27 295d  s.list_dir('/')]
+00028e70: 2c20 5b27 2f65 7463 275d 290a 2020 2020  , ['/etc']).    
+00028e80: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00028e90: 7175 616c 285b 7374 7228 6f2e 7061 7468  qual([str(o.path
+00028ea0: 2920 666f 7220 6f20 696e 2073 656c 662e  ) for o in self.
+00028eb0: 6673 2e6c 6973 745f 6469 7228 272f 6574  fs.list_dir('/et
+00028ec0: 6327 295d 2c20 5b27 2f65 7463 2f69 6e69  c')], ['/etc/ini
+00028ed0: 742e 6427 5d29 0a0a 2020 2020 6465 6620  t.d'])..    def 
+00028ee0: 7465 7374 5f6d 616b 6564 6972 5f70 6174  test_makedir_pat
+00028ef0: 685f 6d75 7374 5f73 7461 7274 5f77 6974  h_must_start_wit
+00028f00: 685f 736c 6173 6828 7365 6c66 293a 0a20  h_slash(self):. 
+00028f10: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00028f20: 2e61 7373 6572 7452 6169 7365 7328 4e6f  .assertRaises(No
+00028f30: 6e41 6273 6f6c 7574 6550 6174 6845 7272  nAbsolutePathErr
+00028f40: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00028f50: 2073 656c 662e 6673 2e63 7265 6174 655f   self.fs.create_
+00028f60: 6469 7228 226e 6f73 6c61 7368 2229 0a0a  dir("noslash")..
+00028f70: 2020 2020 6465 6620 7465 7374 5f63 7265      def test_cre
+00028f80: 6174 655f 6669 6c65 5f66 6169 6c73 5f69  ate_file_fails_i
+00028f90: 665f 7061 7265 6e74 5f64 6972 5f64 6f65  f_parent_dir_doe
+00028fa0: 736e 745f 6578 6973 7428 7365 6c66 293a  snt_exist(self):
+00028fb0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00028fc0: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+00028fd0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+00028fe0: 7229 2061 7320 636d 3a0a 2020 2020 2020  r) as cm:.      
+00028ff0: 2020 2020 2020 7365 6c66 2e66 732e 6372        self.fs.cr
+00029000: 6561 7465 5f66 696c 6528 272f 6574 632f  eate_file('/etc/
+00029010: 7061 7373 7764 272c 2022 666f 6f22 290a  passwd', "foo").
+00029020: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00029030: 6572 7454 7275 6528 272f 6574 6327 2069  ertTrue('/etc' i
+00029040: 6e20 636d 2e65 7863 6570 7469 6f6e 2e61  n cm.exception.a
+00029050: 7267 735b 305d 290a 0a20 2020 2064 6566  rgs[0])..    def
+00029060: 2074 6573 745f 6372 6561 7465 5f66 696c   test_create_fil
+00029070: 655f 7375 6363 6565 6473 5f69 665f 7061  e_succeeds_if_pa
+00029080: 7265 6e74 5f64 6972 5f64 6f65 736e 745f  rent_dir_doesnt_
+00029090: 6578 6973 745f 7768 656e 5f6d 616b 655f  exist_when_make_
+000290a0: 6469 7273 5f74 7275 6528 7365 6c66 293a  dirs_true(self):
+000290b0: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
+000290c0: 2e63 7265 6174 655f 6669 6c65 2827 2f74  .create_file('/t
+000290d0: 6573 742f 7375 6264 6972 2f74 6573 7466  est/subdir/testf
+000290e0: 696c 6527 2c20 2266 6f6f 222c 206d 616b  ile', "foo", mak
+000290f0: 655f 6469 7273 3d54 7275 6529 0a20 2020  e_dirs=True).   
+00029100: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
+00029110: 732e 6f70 656e 2827 2f74 6573 742f 7375  s.open('/test/su
+00029120: 6264 6972 2f74 6573 7466 696c 6527 2920  bdir/testfile') 
+00029130: 6173 2069 6e66 696c 653a 0a20 2020 2020  as infile:.     
+00029140: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00029150: 7274 4571 7561 6c28 696e 6669 6c65 2e72  rtEqual(infile.r
+00029160: 6561 6428 292c 2027 666f 6f27 290a 0a20  ead(), 'foo').. 
+00029170: 2020 2064 6566 2074 6573 745f 6372 6561     def test_crea
+00029180: 7465 5f66 696c 655f 6672 6f6d 5f73 7472  te_file_from_str
+00029190: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000291a0: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
+000291b0: 696c 6528 272f 7465 7374 272c 2022 666f  ile('/test', "fo
+000291c0: 6f22 290a 2020 2020 2020 2020 7769 7468  o").        with
+000291d0: 2073 656c 662e 6673 2e6f 7065 6e28 272f   self.fs.open('/
+000291e0: 7465 7374 2729 2061 7320 696e 6669 6c65  test') as infile
+000291f0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00029200: 6c66 2e61 7373 6572 7445 7175 616c 2869  lf.assertEqual(i
+00029210: 6e66 696c 652e 7265 6164 2829 2c20 2766  nfile.read(), 'f
+00029220: 6f6f 2729 0a0a 2020 2020 6465 6620 7465  oo')..    def te
+00029230: 7374 5f63 7265 6174 655f 6669 6c65 5f66  st_create_file_f
+00029240: 726f 6d5f 6279 7465 7328 7365 6c66 293a  rom_bytes(self):
+00029250: 0a20 2020 2020 2020 2073 656c 662e 6673  .        self.fs
+00029260: 2e63 7265 6174 655f 6669 6c65 2827 2f74  .create_file('/t
+00029270: 6573 7427 2c20 6222 666f 6f22 290a 2020  est', b"foo").  
+00029280: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00029290: 6673 2e6f 7065 6e28 272f 7465 7374 272c  fs.open('/test',
+000292a0: 2065 6e63 6f64 696e 673d 4e6f 6e65 2920   encoding=None) 
+000292b0: 6173 2069 6e66 696c 653a 0a20 2020 2020  as infile:.     
+000292c0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+000292d0: 7274 4571 7561 6c28 696e 6669 6c65 2e72  rtEqual(infile.r
+000292e0: 6561 6428 292c 2062 2766 6f6f 2729 0a0a  ead(), b'foo')..
+000292f0: 2020 2020 6465 6620 7465 7374 5f63 7265      def test_cre
+00029300: 6174 655f 6669 6c65 5f66 726f 6d5f 6669  ate_file_from_fi
+00029310: 6c65 7328 7365 6c66 293a 0a20 2020 2020  les(self):.     
+00029320: 2020 2064 6174 6120 3d20 2266 6f6f 220a     data = "foo".
+00029330: 0a20 2020 2020 2020 2073 696f 203d 2053  .        sio = S
+00029340: 7472 696e 6749 4f28 6461 7461 290a 2020  tringIO(data).  
+00029350: 2020 2020 2020 7365 6c66 2e66 732e 6372        self.fs.cr
+00029360: 6561 7465 5f66 696c 6528 272f 7465 7374  eate_file('/test
+00029370: 272c 2073 696f 290a 2020 2020 2020 2020  ', sio).        
+00029380: 7769 7468 2073 656c 662e 6673 2e6f 7065  with self.fs.ope
+00029390: 6e28 272f 7465 7374 2729 2061 7320 696e  n('/test') as in
+000293a0: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+000293b0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+000293c0: 616c 2869 6e66 696c 652e 7265 6164 2829  al(infile.read()
+000293d0: 2c20 2766 6f6f 2729 0a0a 2020 2020 2020  , 'foo')..      
+000293e0: 2020 6269 6f20 3d20 4279 7465 7349 4f28    bio = BytesIO(
+000293f0: 6461 7461 2e65 6e63 6f64 6528 2929 0a20  data.encode()). 
+00029400: 2020 2020 2020 2073 656c 662e 6673 2e63         self.fs.c
+00029410: 7265 6174 655f 6669 6c65 2827 2f74 6573  reate_file('/tes
+00029420: 7432 272c 2062 696f 290a 2020 2020 2020  t2', bio).      
+00029430: 2020 7769 7468 2073 656c 662e 6673 2e6f    with self.fs.o
+00029440: 7065 6e28 272f 7465 7374 3227 2920 6173  pen('/test2') as
+00029450: 2069 6e66 696c 653a 0a20 2020 2020 2020   infile:.       
+00029460: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+00029470: 4571 7561 6c28 696e 6669 6c65 2e72 6561  Equal(infile.rea
+00029480: 6428 292c 2027 666f 6f27 290a 0a20 2020  d(), 'foo')..   
+00029490: 2064 6566 2074 6573 745f 6372 6561 7465   def test_create
+000294a0: 5f61 6e64 5f72 6561 645f 7769 7468 5f64  _and_read_with_d
+000294b0: 6966 6665 7265 6e74 5f65 6e63 6f64 696e  ifferent_encodin
+000294c0: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
+000294d0: 2020 2320 7772 6974 6520 7374 722c 2072    # write str, r
+000294e0: 6561 6420 6173 2075 7466 2d38 2062 7974  ead as utf-8 byt
+000294f0: 6573 0a20 2020 2020 2020 2073 656c 662e  es.        self.
+00029500: 6673 2e63 7265 6174 655f 6669 6c65 2827  fs.create_file('
+00029510: 2f74 6573 7427 2c20 2266 6f6f 2229 0a20  /test', "foo"). 
+00029520: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00029530: 2e66 732e 6f70 656e 2827 2f74 6573 7427  .fs.open('/test'
+00029540: 2c20 656e 636f 6469 6e67 3d4e 6f6e 6529  , encoding=None)
+00029550: 2061 7320 696e 6669 6c65 3a0a 2020 2020   as infile:.    
+00029560: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+00029570: 6572 7445 7175 616c 2869 6e66 696c 652e  ertEqual(infile.
+00029580: 7265 6164 2829 2c20 6227 666f 6f27 290a  read(), b'foo').
+00029590: 0a20 2020 2020 2020 2023 2077 7269 7465  .        # write
+000295a0: 2062 7974 6573 2c20 7265 6164 2061 7320   bytes, read as 
+000295b0: 7574 662d 382d 6465 636f 6465 6420 7374  utf-8-decoded st
+000295c0: 720a 2020 2020 2020 2020 6461 7461 203d  r.        data =
+000295d0: 2022 e697 a5e6 9cac e8aa 9e22 2020 2320   "........."  # 
+000295e0: 4a61 7061 6e65 7365 2066 6f72 2022 4a61  Japanese for "Ja
+000295f0: 7061 6e65 7365 220a 2020 2020 2020 2020  panese".        
+00029600: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
+00029610: 696c 6528 272f 7465 7374 3227 2c20 6461  ile('/test2', da
+00029620: 7461 2e65 6e63 6f64 6528 2775 7466 2d38  ta.encode('utf-8
+00029630: 2729 290a 2020 2020 2020 2020 7769 7468  ')).        with
+00029640: 2073 656c 662e 6673 2e6f 7065 6e28 272f   self.fs.open('/
+00029650: 7465 7374 3227 2920 6173 2069 6e66 696c  test2') as infil
+00029660: 653a 2020 2020 2020 2020 2020 2020 2020  e:              
+00029670: 2020 2020 2020 2320 496d 706c 6963 6974        # Implicit
+00029680: 2075 7466 2d38 2072 6561 640a 2020 2020   utf-8 read.    
+00029690: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000296a0: 6572 7445 7175 616c 2869 6e66 696c 652e  ertEqual(infile.
+000296b0: 7265 6164 2829 2c20 6461 7461 290a 2020  read(), data).  
+000296c0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000296d0: 6673 2e6f 7065 6e28 272f 7465 7374 3227  fs.open('/test2'
+000296e0: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
+000296f0: 3827 2920 6173 2069 6e66 696c 653a 2020  8') as infile:  
+00029700: 2320 4578 706c 6963 6974 2075 7466 2d38  # Explicit utf-8
+00029710: 2072 6561 640a 2020 2020 2020 2020 2020   read.          
+00029720: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+00029730: 616c 2869 6e66 696c 652e 7265 6164 2829  al(infile.read()
+00029740: 2c20 6461 7461 290a 0a20 2020 2064 6566  , data)..    def
+00029750: 2074 6573 745f 6f70 656e 5f64 6972 6563   test_open_direc
+00029760: 746f 7279 5f66 6169 6c73 2873 656c 6629  tory_fails(self)
+00029770: 3a0a 2020 2020 2020 2020 7365 6c66 2e66  :.        self.f
+00029780: 732e 6372 6561 7465 5f64 6972 2827 2f64  s.create_dir('/d
+00029790: 6972 3127 290a 2020 2020 2020 2020 7769  ir1').        wi
+000297a0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+000297b0: 6973 6573 2849 7341 4469 7265 6374 6f72  ises(IsADirector
+000297c0: 7945 7272 6f72 2920 6173 2063 6d3a 0a20  yError) as cm:. 
+000297d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000297e0: 6673 2e6f 7065 6e28 272f 6469 7231 2729  fs.open('/dir1')
+000297f0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+00029800: 7365 7274 4571 7561 6c28 636d 2e65 7863  sertEqual(cm.exc
+00029810: 6570 7469 6f6e 2e61 7267 735b 305d 2c20  eption.args[0], 
+00029820: 272f 6469 7231 2729 0a0a 2020 2020 6465  '/dir1')..    de
+00029830: 6620 7465 7374 5f64 656c 6574 655f 6669  f test_delete_fi
+00029840: 6c65 2873 656c 6629 3a0a 2020 2020 2020  le(self):.      
+00029850: 2020 7365 6c66 2e66 732e 6372 6561 7465    self.fs.create
+00029860: 5f66 696c 6528 272f 7465 7374 272c 2022  _file('/test', "
+00029870: 666f 6f22 290a 2020 2020 2020 2020 7365  foo").        se
+00029880: 6c66 2e66 732e 6465 6c65 7465 5f70 6174  lf.fs.delete_pat
+00029890: 6828 272f 7465 7374 2729 0a20 2020 2020  h('/test').     
+000298a0: 2020 2077 6974 6820 7365 6c66 2e61 7373     with self.ass
+000298b0: 6572 7452 6169 7365 7328 4669 6c65 4e6f  ertRaises(FileNo
+000298c0: 7446 6f75 6e64 4572 726f 7229 2061 7320  tFoundError) as 
+000298d0: 636d 3a0a 2020 2020 2020 2020 2020 2020  cm:.            
+000298e0: 7365 6c66 2e66 732e 6765 745f 7061 7468  self.fs.get_path
+000298f0: 2827 2f74 6573 7427 290a 0a20 2020 2020  ('/test')..     
+00029900: 2020 2023 2044 656c 6574 696e 6720 6465     # Deleting de
+00029910: 6c65 7465 6420 6669 6c65 7320 7368 6f75  leted files shou
+00029920: 6c64 2066 6169 6c20 6173 2077 656c 6c0a  ld fail as well.
+00029930: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00029940: 662e 6173 7365 7274 5261 6973 6573 2846  f.assertRaises(F
+00029950: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+00029960: 2920 6173 2063 6d3a 0a20 2020 2020 2020  ) as cm:.       
+00029970: 2020 2020 2073 656c 662e 6673 2e64 656c       self.fs.del
+00029980: 6574 655f 7061 7468 2827 2f74 6573 7427  ete_path('/test'
+00029990: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000299a0: 7373 6572 7454 7275 6528 272f 7465 7374  ssertTrue('/test
+000299b0: 2720 696e 2063 6d2e 6578 6365 7074 696f  ' in cm.exceptio
+000299c0: 6e2e 6172 6773 5b30 5d29 0a0a 2020 2020  n.args[0])..    
+000299d0: 6465 6620 7465 7374 5f63 7265 6174 655f  def test_create_
+000299e0: 6469 725f 7769 7468 5f65 7874 7261 5f61  dir_with_extra_a
+000299f0: 7267 7328 7365 6c66 293a 0a20 2020 2020  rgs(self):.     
+00029a00: 2020 2064 203d 2073 656c 662e 6673 2e63     d = self.fs.c
+00029a10: 7265 6174 655f 6469 7228 272f 6469 7231  reate_dir('/dir1
+00029a20: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00029a30: 6173 7365 7274 4571 7561 6c28 642e 6b77  assertEqual(d.kw
+00029a40: 6172 6773 2c20 7b7d 290a 0a20 2020 2020  args, {})..     
+00029a50: 2020 2064 203d 2073 656c 662e 6673 2e63     d = self.fs.c
+00029a60: 7265 6174 655f 6469 7228 0a20 2020 2020  reate_dir(.     
+00029a70: 2020 2020 2020 2027 2f64 6972 3227 2c20         '/dir2', 
+00029a80: 7065 726d 6973 7369 6f6e 733d 306f 3730  permissions=0o70
+00029a90: 302c 2075 7365 723d 2775 6275 6e74 7527  0, user='ubuntu'
+00029aa0: 2c20 7573 6572 5f69 643d 3130 3030 2c20  , user_id=1000, 
+00029ab0: 6772 6f75 703d 2777 7777 2d64 6174 6127  group='www-data'
+00029ac0: 2c20 6772 6f75 705f 6964 3d33 3329 0a20  , group_id=33). 
+00029ad0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+00029ae0: 7274 4571 7561 6c28 642e 6b77 6172 6773  rtEqual(d.kwargs
+00029af0: 2c20 7b0a 2020 2020 2020 2020 2020 2020  , {.            
+00029b00: 2770 6572 6d69 7373 696f 6e73 273a 2030  'permissions': 0
+00029b10: 6f37 3030 2c0a 2020 2020 2020 2020 2020  o700,.          
+00029b20: 2020 2775 7365 7227 3a20 2775 6275 6e74    'user': 'ubunt
+00029b30: 7527 2c0a 2020 2020 2020 2020 2020 2020  u',.            
+00029b40: 2775 7365 725f 6964 273a 2031 3030 302c  'user_id': 1000,
+00029b50: 0a20 2020 2020 2020 2020 2020 2027 6772  .            'gr
+00029b60: 6f75 7027 3a20 2777 7777 2d64 6174 6127  oup': 'www-data'
+00029b70: 2c0a 2020 2020 2020 2020 2020 2020 2767  ,.            'g
+00029b80: 726f 7570 5f69 6427 3a20 3333 2c0a 2020  roup_id': 33,.  
+00029b90: 2020 2020 2020 7d29 0a0a 2020 2020 6465        })..    de
+00029ba0: 6620 7465 7374 5f63 7265 6174 655f 6669  f test_create_fi
+00029bb0: 6c65 5f77 6974 685f 6578 7472 615f 6172  le_with_extra_ar
+00029bc0: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
+00029bd0: 2020 6620 3d20 7365 6c66 2e66 732e 6372    f = self.fs.cr
+00029be0: 6561 7465 5f66 696c 6528 272f 6669 6c65  eate_file('/file
+00029bf0: 3127 2c20 2764 6174 6127 290a 2020 2020  1', 'data').    
+00029c00: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+00029c10: 7175 616c 2866 2e6b 7761 7267 732c 207b  qual(f.kwargs, {
+00029c20: 7d29 0a0a 2020 2020 2020 2020 6620 3d20  })..        f = 
+00029c30: 7365 6c66 2e66 732e 6372 6561 7465 5f66  self.fs.create_f
+00029c40: 696c 6528 0a20 2020 2020 2020 2020 2020  ile(.           
+00029c50: 2027 2f66 696c 6532 272c 2027 6461 7461   '/file2', 'data
+00029c60: 272c 0a20 2020 2020 2020 2020 2020 2070  ',.            p
+00029c70: 6572 6d69 7373 696f 6e73 3d30 6f37 3534  ermissions=0o754
+00029c80: 2c20 7573 6572 3d27 7562 756e 7475 272c  , user='ubuntu',
+00029c90: 2075 7365 725f 6964 3d31 3030 302c 2067   user_id=1000, g
+00029ca0: 726f 7570 3d27 7777 772d 6461 7461 272c  roup='www-data',
+00029cb0: 2067 726f 7570 5f69 643d 3333 290a 2020   group_id=33).  
+00029cc0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00029cd0: 7445 7175 616c 2866 2e6b 7761 7267 732c  tEqual(f.kwargs,
+00029ce0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00029cf0: 7065 726d 6973 7369 6f6e 7327 3a20 306f  permissions': 0o
+00029d00: 3735 342c 0a20 2020 2020 2020 2020 2020  754,.           
+00029d10: 2027 7573 6572 273a 2027 7562 756e 7475   'user': 'ubuntu
+00029d20: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00029d30: 7573 6572 5f69 6427 3a20 3130 3030 2c0a  user_id': 1000,.
+00029d40: 2020 2020 2020 2020 2020 2020 2767 726f              'gro
+00029d50: 7570 273a 2027 7777 772d 6461 7461 272c  up': 'www-data',
+00029d60: 0a20 2020 2020 2020 2020 2020 2027 6772  .            'gr
+00029d70: 6f75 705f 6964 273a 2033 332c 0a20 2020  oup_id': 33,.   
+00029d80: 2020 2020 207d 290a 0a20 2020 2064 6566       })..    def
+00029d90: 2074 6573 745f 6765 7461 7474 7228 7365   test_getattr(se
+00029da0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00029db0: 662e 6673 2e63 7265 6174 655f 6469 7228  f.fs.create_dir(
+00029dc0: 272f 6574 632f 696e 6974 2e64 272c 206d  '/etc/init.d', m
+00029dd0: 616b 655f 7061 7265 6e74 733d 5472 7565  ake_parents=True
+00029de0: 290a 0a20 2020 2020 2020 2023 2042 7920  )..        # By 
+00029df0: 7061 7468 0a20 2020 2020 2020 206f 203d  path.        o =
+00029e00: 2073 656c 662e 6673 2e67 6574 5f70 6174   self.fs.get_pat
+00029e10: 6828 7061 7468 6c69 622e 5075 7265 506f  h(pathlib.PurePo
+00029e20: 7369 7850 6174 6828 272f 6574 632f 696e  sixPath('/etc/in
+00029e30: 6974 2e64 2729 290a 2020 2020 2020 2020  it.d')).        
+00029e40: 7365 6c66 2e61 7373 6572 7449 7349 6e73  self.assertIsIns
+00029e50: 7461 6e63 6528 6f2c 205f 4469 7265 6374  tance(o, _Direct
+00029e60: 6f72 7929 0a20 2020 2020 2020 2073 656c  ory).        sel
+00029e70: 662e 6173 7365 7274 4571 7561 6c28 6f2e  f.assertEqual(o.
+00029e80: 7061 7468 2c20 7061 7468 6c69 622e 5075  path, pathlib.Pu
+00029e90: 7265 506f 7369 7850 6174 6828 272f 6574  rePosixPath('/et
+00029ea0: 632f 696e 6974 2e64 2729 290a 0a20 2020  c/init.d'))..   
+00029eb0: 2020 2020 2023 2042 7920 7374 720a 2020       # By str.  
+00029ec0: 2020 2020 2020 6f20 3d20 7365 6c66 2e66        o = self.f
+00029ed0: 732e 6765 745f 7061 7468 2827 2f65 7463  s.get_path('/etc
+00029ee0: 2f69 6e69 742e 6427 290a 2020 2020 2020  /init.d').      
+00029ef0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+00029f00: 6e73 7461 6e63 6528 6f2c 205f 4469 7265  nstance(o, _Dire
+00029f10: 6374 6f72 7929 0a20 2020 2020 2020 2073  ctory).        s
+00029f20: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+00029f30: 6f2e 7061 7468 2c20 7061 7468 6c69 622e  o.path, pathlib.
+00029f40: 5075 7265 506f 7369 7850 6174 6828 272f  PurePosixPath('/
+00029f50: 6574 632f 696e 6974 2e64 2729 290a 0a20  etc/init.d')).. 
+00029f60: 2020 2064 6566 2074 6573 745f 6765 7461     def test_geta
+00029f70: 7474 725f 6669 6c65 5f6e 6f74 5f66 6f75  ttr_file_not_fou
+00029f80: 6e64 2873 656c 6629 3a0a 2020 2020 2020  nd(self):.      
+00029f90: 2020 2320 4172 6775 6162 6c79 2074 6869    # Arguably thi
+00029fa0: 7320 636f 756c 6420 6265 2061 204b 6579  s could be a Key
+00029fb0: 4572 726f 7220 6769 7665 6e20 7468 6520  Error given the 
+00029fc0: 6469 6374 696f 6e61 7279 2d73 7479 6c65  dictionary-style
+00029fd0: 2061 6363 6573 732e 0a20 2020 2020 2020   access..       
+00029fe0: 2023 2048 6f77 6576 6572 2c20 4669 6c65   # However, File
+00029ff0: 4e6f 7446 6f75 6e64 4572 726f 7220 7365  NotFoundError se
+0002a000: 656d 7320 6d6f 7265 2061 7070 726f 7072  ems more appropr
+0002a010: 6961 7465 2066 6f72 2061 2066 696c 6573  iate for a files
+0002a020: 7973 7465 6d2c 2061 6e64 2069 740a 2020  ystem, and it.  
+0002a030: 2020 2020 2020 2320 6769 7665 7320 6120        # gives a 
+0002a040: 636c 6f73 6572 2073 656d 616e 7469 6320  closer semantic 
+0002a050: 6665 656c 696e 672c 2069 6e20 6d79 206f  feeling, in my o
+0002a060: 7069 6e69 6f6e 2e0a 2020 2020 2020 2020  pinion..        
+0002a070: 7769 7468 2073 656c 662e 6173 7365 7274  with self.assert
+0002a080: 5261 6973 6573 2846 696c 654e 6f74 466f  Raises(FileNotFo
+0002a090: 756e 6445 7272 6f72 2920 6173 2063 6d3a  undError) as cm:
+0002a0a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002a0b0: 662e 6673 2e67 6574 5f70 6174 6828 272f  f.fs.get_path('/
+0002a0c0: 6e6f 6e65 7869 7374 656e 745f 6669 6c65  nonexistent_file
+0002a0d0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0002a0e0: 6173 7365 7274 5472 7565 2827 2f6e 6f6e  assertTrue('/non
+0002a0f0: 6578 6973 7465 6e74 5f66 696c 6527 2069  existent_file' i
+0002a100: 6e20 636d 2e65 7863 6570 7469 6f6e 2e61  n cm.exception.a
+0002a110: 7267 735b 305d 290a 0a0a 636c 6173 7320  rgs[0])...class 
+0002a120: 5465 7374 5465 7374 696e 6746 696c 6573  TestTestingFiles
+0002a130: 7973 7465 6d28 4765 6e65 7269 6354 6573  ystem(GenericTes
+0002a140: 7469 6e67 4669 6c65 7379 7374 656d 5465  tingFilesystemTe
+0002a150: 7374 732c 2075 6e69 7474 6573 742e 5465  sts, unittest.Te
+0002a160: 7374 4361 7365 293a 0a20 2020 2064 6566  stCase):.    def
+0002a170: 2073 6574 5570 2873 656c 6629 3a0a 2020   setUp(self):.  
+0002a180: 2020 2020 2020 7365 6c66 2e66 7320 3d20        self.fs = 
+0002a190: 5f54 6573 7469 6e67 4669 6c65 7379 7374  _TestingFilesyst
+0002a1a0: 656d 2829 0a0a 2020 2020 6465 6620 7465  em()..    def te
+0002a1b0: 7374 5f73 746f 7261 6765 5f6d 6f75 6e74  st_storage_mount
+0002a1c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0002a1d0: 746d 7064 6972 203d 2074 656d 7066 696c  tmpdir = tempfil
+0002a1e0: 652e 5465 6d70 6f72 6172 7944 6972 6563  e.TemporaryDirec
+0002a1f0: 746f 7279 2829 0a20 2020 2020 2020 2073  tory().        s
+0002a200: 656c 662e 6673 2e61 6464 5f6d 6f75 6e74  elf.fs.add_mount
+0002a210: 2827 666f 6f27 2c20 272f 666f 6f27 2c20  ('foo', '/foo', 
+0002a220: 746d 7064 6972 2e6e 616d 6529 0a20 2020  tmpdir.name).   
+0002a230: 2020 2020 2073 656c 662e 6673 2e63 7265       self.fs.cre
+0002a240: 6174 655f 6669 6c65 2827 2f66 6f6f 2f62  ate_file('/foo/b
+0002a250: 6172 2f62 617a 2e74 7874 272c 2027 7175  ar/baz.txt', 'qu
+0002a260: 7578 272c 206d 616b 655f 6469 7273 3d54  ux', make_dirs=T
+0002a270: 7275 6529 0a0a 2020 2020 2020 2020 746d  rue)..        tm
+0002a280: 7070 6174 6820 3d20 6f73 2e70 6174 682e  ppath = os.path.
+0002a290: 6a6f 696e 2874 6d70 6469 722e 6e61 6d65  join(tmpdir.name
+0002a2a0: 2c20 2762 6172 2f62 617a 2e74 7874 2729  , 'bar/baz.txt')
+0002a2b0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002a2c0: 7365 7274 5472 7565 286f 732e 7061 7468  sertTrue(os.path
+0002a2d0: 2e65 7869 7374 7328 746d 7070 6174 6829  .exists(tmppath)
+0002a2e0: 290a 2020 2020 2020 2020 7769 7468 206f  ).        with o
+0002a2f0: 7065 6e28 746d 7070 6174 6829 2061 7320  pen(tmppath) as 
+0002a300: 663a 0a20 2020 2020 2020 2020 2020 2073  f:.            s
+0002a310: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0002a320: 662e 7265 6164 2829 2c20 2771 7575 7827  f.read(), 'quux'
+0002a330: 290a 0a0a 636c 6173 7320 5465 7374 5465  )...class TestTe
+0002a340: 7374 696e 6753 746f 7261 6765 4d6f 756e  stingStorageMoun
+0002a350: 7428 4765 6e65 7269 6354 6573 7469 6e67  t(GenericTesting
+0002a360: 4669 6c65 7379 7374 656d 5465 7374 732c  FilesystemTests,
+0002a370: 2075 6e69 7474 6573 742e 5465 7374 4361   unittest.TestCa
+0002a380: 7365 293a 0a20 2020 2064 6566 2073 6574  se):.    def set
+0002a390: 5570 2873 656c 6629 3a0a 2020 2020 2020  Up(self):.      
+0002a3a0: 2020 7365 6c66 2e74 6d70 203d 2074 656d    self.tmp = tem
+0002a3b0: 7066 696c 652e 5465 6d70 6f72 6172 7944  pfile.TemporaryD
+0002a3c0: 6972 6563 746f 7279 2829 0a20 2020 2020  irectory().     
+0002a3d0: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0002a3e0: 7570 2873 656c 662e 746d 702e 636c 6561  up(self.tmp.clea
+0002a3f0: 6e75 7029 0a20 2020 2020 2020 2073 656c  nup).        sel
+0002a400: 662e 6673 203d 205f 5465 7374 696e 6753  f.fs = _TestingS
+0002a410: 746f 7261 6765 4d6f 756e 7428 272f 272c  torageMount('/',
+0002a420: 2070 6174 686c 6962 2e50 6174 6828 7365   pathlib.Path(se
+0002a430: 6c66 2e74 6d70 2e6e 616d 6529 290a 0a0a  lf.tmp.name))...
+0002a440: 636c 6173 7320 5465 7374 5065 6262 6c65  class TestPebble
+0002a450: 5374 6f72 6167 6541 5049 7355 7369 6e67  StorageAPIsUsing
+0002a460: 4d6f 636b 7328 0a20 2020 2020 2020 2075  Mocks(.        u
+0002a470: 6e69 7474 6573 742e 5465 7374 4361 7365  nittest.TestCase
+0002a480: 2c0a 2020 2020 2020 2020 5f54 6573 7469  ,.        _Testi
+0002a490: 6e67 5065 6262 6c65 436c 6965 6e74 4d69  ngPebbleClientMi
+0002a4a0: 7869 6e2c 0a20 2020 2020 2020 205f 5065  xin,.        _Pe
+0002a4b0: 6262 6c65 5374 6f72 6167 6541 5049 7354  bbleStorageAPIsT
+0002a4c0: 6573 744d 6978 696e 293a 0a20 2020 2064  estMixin):.    d
+0002a4d0: 6566 2073 6574 5570 2873 656c 6629 3a0a  ef setUp(self):.
+0002a4e0: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
+0002a4f0: 6669 7820 3d20 272f 7072 6566 6978 270a  fix = '/prefix'.
+0002a500: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0002a510: 656e 7420 3d20 7365 6c66 2e67 6574 5f74  ent = self.get_t
+0002a520: 6573 7469 6e67 5f63 6c69 656e 7428 290a  esting_client().
+0002a530: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0002a540: 7072 6566 6978 3a0a 2020 2020 2020 2020  prefix:.        
+0002a550: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
+0002a560: 6d61 6b65 5f64 6972 2873 656c 662e 7072  make_dir(self.pr
+0002a570: 6566 6978 2c20 6d61 6b65 5f70 6172 656e  efix, make_paren
+0002a580: 7473 3d54 7275 6529 0a0a 2020 2020 4075  ts=True)..    @u
+0002a590: 6e69 7474 6573 742e 736b 6970 556e 6c65  nittest.skipUnle
+0002a5a0: 7373 2869 735f 6c69 6e75 782c 2027 5065  ss(is_linux, 'Pe
+0002a5b0: 6262 6c65 2072 756e 7320 6f6e 204c 696e  bble runs on Lin
+0002a5c0: 7578 2729 0a20 2020 2064 6566 2074 6573  ux').    def tes
+0002a5d0: 745f 636f 6e74 6169 6e65 725f 7374 6f72  t_container_stor
+0002a5e0: 6167 655f 6d6f 756e 7473 2873 656c 6629  age_mounts(self)
+0002a5f0: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0002a600: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0002a610: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+0002a620: 6d42 6173 652c 206d 6574 613d 2727 270a  mBase, meta='''.
+0002a630: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0002a640: 3a20 7465 7374 2d61 7070 0a20 2020 2020  : test-app.     
+0002a650: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
+0002a660: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002a670: 2020 2063 313a 0a20 2020 2020 2020 2020     c1:.         
+0002a680: 2020 2020 2020 2020 2020 206d 6f75 6e74             mount
+0002a690: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002a6a0: 2020 2020 2020 2020 2020 202d 2073 746f             - sto
+0002a6b0: 7261 6765 3a20 7374 6f72 6531 0a20 2020  rage: store1.   
+0002a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6d0: 2020 2020 2020 206c 6f63 6174 696f 6e3a         location:
+0002a6e0: 202f 6d6f 756e 7473 2f66 6f6f 0a20 2020   /mounts/foo.   
+0002a6f0: 2020 2020 2020 2020 2020 2020 2063 323a               c2:
+0002a700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a710: 2020 2020 206d 6f75 6e74 733a 0a20 2020       mounts:.   
+0002a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a730: 2020 2020 202d 2073 746f 7261 6765 3a20       - storage: 
+0002a740: 7374 6f72 6532 0a20 2020 2020 2020 2020  store2.         
+0002a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a760: 206c 6f63 6174 696f 6e3a 202f 6d6f 756e   location: /moun
+0002a770: 7473 2f66 6f6f 0a20 2020 2020 2020 2020  ts/foo.         
+0002a780: 2020 2020 2020 2063 333a 0a20 2020 2020         c3:.     
+0002a790: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0002a7a0: 6f75 6e74 733a 0a20 2020 2020 2020 2020  ounts:.         
+0002a7b0: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+0002a7c0: 2073 746f 7261 6765 3a20 7374 6f72 6531   storage: store1
+0002a7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a7e0: 2020 2020 2020 2020 2020 206c 6f63 6174             locat
+0002a7f0: 696f 6e3a 202f 6d6f 756e 7473 2f62 6172  ion: /mounts/bar
+0002a800: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002a810: 7261 6765 3a0a 2020 2020 2020 2020 2020  rage:.          
+0002a820: 2020 2020 2020 7374 6f72 6531 3a0a 2020        store1:.  
+0002a830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a840: 2020 7479 7065 3a20 6669 6c65 7379 7374    type: filesyst
+0002a850: 656d 0a20 2020 2020 2020 2020 2020 2020  em.             
+0002a860: 2020 2073 746f 7265 323a 0a20 2020 2020     store2:.     
+0002a870: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002a880: 7970 653a 2066 696c 6573 7973 7465 6d0a  ype: filesystem.
+0002a890: 2020 2020 2020 2020 2020 2020 2727 2729              ''')
+0002a8a0: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0002a8b0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0002a8c0: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
+0002a8d0: 2020 2073 746f 7265 5f69 6420 3d20 6861     store_id = ha
+0002a8e0: 726e 6573 732e 6164 645f 7374 6f72 6167  rness.add_storag
+0002a8f0: 6528 2773 746f 7265 3127 295b 305d 0a20  e('store1')[0]. 
+0002a900: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
+0002a910: 7474 6163 685f 7374 6f72 6167 6528 7374  ttach_storage(st
+0002a920: 6f72 655f 6964 290a 0a20 2020 2020 2020  ore_id)..       
+0002a930: 2068 6172 6e65 7373 2e62 6567 696e 2829   harness.begin()
+0002a940: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0002a950: 2e73 6574 5f63 616e 5f63 6f6e 6e65 6374  .set_can_connect
+0002a960: 2827 6331 272c 2054 7275 6529 0a20 2020  ('c1', True).   
+0002a970: 2020 2020 2068 6172 6e65 7373 2e73 6574       harness.set
+0002a980: 5f63 616e 5f63 6f6e 6e65 6374 2827 6332  _can_connect('c2
+0002a990: 272c 2054 7275 6529 0a20 2020 2020 2020  ', True).       
+0002a9a0: 2068 6172 6e65 7373 2e73 6574 5f63 616e   harness.set_can
+0002a9b0: 5f63 6f6e 6e65 6374 2827 6333 272c 2054  _connect('c3', T
+0002a9c0: 7275 6529 0a0a 2020 2020 2020 2020 2320  rue)..        # 
+0002a9d0: 7075 7368 2066 696c 6520 746f 2063 3120  push file to c1 
+0002a9e0: 7374 6f72 6167 6520 6d6f 756e 742c 2063  storage mount, c
+0002a9f0: 6865 636b 2074 6861 7420 7765 2063 616e  heck that we can
+0002aa00: 2073 6565 2069 7420 696e 2063 6861 726d   see it in charm
+0002aa10: 2063 6f6e 7461 696e 6572 2073 746f 7261   container stora
+0002aa20: 6765 2070 6174 682e 0a20 2020 2020 2020  ge path..       
+0002aa30: 2063 3120 3d20 6861 726e 6573 732e 6d6f   c1 = harness.mo
+0002aa40: 6465 6c2e 756e 6974 2e67 6574 5f63 6f6e  del.unit.get_con
+0002aa50: 7461 696e 6572 2827 6331 2729 0a20 2020  tainer('c1').   
+0002aa60: 2020 2020 2063 315f 666e 616d 6520 3d20       c1_fname = 
+0002aa70: 2766 6f6f 2e74 7874 270a 2020 2020 2020  'foo.txt'.      
+0002aa80: 2020 6331 5f66 7061 7468 203d 206f 732e    c1_fpath = os.
+0002aa90: 7061 7468 2e6a 6f69 6e28 272f 6d6f 756e  path.join('/moun
+0002aaa0: 7473 2f66 6f6f 272c 2063 315f 666e 616d  ts/foo', c1_fnam
+0002aab0: 6529 0a20 2020 2020 2020 2063 312e 7075  e).        c1.pu
+0002aac0: 7368 2863 315f 6670 6174 682c 2027 3432  sh(c1_fpath, '42
+0002aad0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+0002aae0: 6173 7365 7274 5472 7565 2863 312e 6578  assertTrue(c1.ex
+0002aaf0: 6973 7473 2863 315f 6670 6174 6829 290a  ists(c1_fpath)).
+0002ab00: 2020 2020 2020 2020 6670 6174 6820 3d20          fpath = 
+0002ab10: 6f73 2e70 6174 682e 6a6f 696e 2873 7472  os.path.join(str
+0002ab20: 2868 6172 6e65 7373 2e6d 6f64 656c 2e73  (harness.model.s
+0002ab30: 746f 7261 6765 735b 2773 746f 7265 3127  torages['store1'
+0002ab40: 5d5b 305d 2e6c 6f63 6174 696f 6e29 2c20  ][0].location), 
+0002ab50: 2766 6f6f 2e74 7874 2729 0a20 2020 2020  'foo.txt').     
+0002ab60: 2020 2077 6974 6820 6f70 656e 2866 7061     with open(fpa
+0002ab70: 7468 2920 6173 2066 3a0a 2020 2020 2020  th) as f:.      
+0002ab80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002ab90: 7445 7175 616c 2827 3432 272c 2066 2e72  tEqual('42', f.r
+0002aba0: 6561 6428 2929 0a0a 2020 2020 2020 2020  ead())..        
+0002abb0: 2320 6368 6563 6b20 7468 6174 2074 6865  # check that the
+0002abc0: 2066 696c 6520 6973 206e 6f74 2076 6973   file is not vis
+0002abd0: 6962 6c65 2069 6e20 6332 2077 6869 6368  ible in c2 which
+0002abe0: 2068 6173 2061 2064 6966 6665 7265 6e74   has a different
+0002abf0: 2073 746f 7261 6765 206d 6f75 6e74 0a20   storage mount. 
+0002ac00: 2020 2020 2020 2063 3220 3d20 6861 726e         c2 = harn
+0002ac10: 6573 732e 6d6f 6465 6c2e 756e 6974 2e67  ess.model.unit.g
+0002ac20: 6574 5f63 6f6e 7461 696e 6572 2827 6332  et_container('c2
+0002ac30: 2729 0a20 2020 2020 2020 2063 325f 6670  ').        c2_fp
+0002ac40: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
+0002ac50: 696e 2827 2f6d 6f75 6e74 732f 666f 6f27  in('/mounts/foo'
+0002ac60: 2c20 6331 5f66 6e61 6d65 290a 2020 2020  , c1_fname).    
+0002ac70: 2020 2020 7365 6c66 2e61 7373 6572 7446      self.assertF
+0002ac80: 616c 7365 2863 322e 6578 6973 7473 2863  alse(c2.exists(c
+0002ac90: 325f 6670 6174 6829 290a 0a20 2020 2020  2_fpath))..     
+0002aca0: 2020 2023 2063 6865 636b 2074 6861 7420     # check that 
+0002acb0: 7468 6520 6669 6c65 2069 7320 7669 7369  the file is visi
+0002acc0: 626c 6520 696e 2063 3320 7768 6963 6820  ble in c3 which 
+0002acd0: 6861 7320 7468 6520 7361 6d65 2073 746f  has the same sto
+0002ace0: 7261 6765 206d 6f75 6e74 0a20 2020 2020  rage mount.     
+0002acf0: 2020 2063 3320 3d20 6861 726e 6573 732e     c3 = harness.
+0002ad00: 6d6f 6465 6c2e 756e 6974 2e67 6574 5f63  model.unit.get_c
+0002ad10: 6f6e 7461 696e 6572 2827 6333 2729 0a20  ontainer('c3'). 
+0002ad20: 2020 2020 2020 2063 335f 6670 6174 6820         c3_fpath 
+0002ad30: 3d20 6f73 2e70 6174 682e 6a6f 696e 2827  = os.path.join('
+0002ad40: 2f6d 6f75 6e74 732f 6261 7227 2c20 6331  /mounts/bar', c1
+0002ad50: 5f66 6e61 6d65 290a 2020 2020 2020 2020  _fname).        
+0002ad60: 7365 6c66 2e61 7373 6572 7454 7275 6528  self.assertTrue(
+0002ad70: 6333 2e65 7869 7374 7328 6333 5f66 7061  c3.exists(c3_fpa
+0002ad80: 7468 2929 0a20 2020 2020 2020 2077 6974  th)).        wit
+0002ad90: 6820 6333 2e70 756c 6c28 6333 5f66 7061  h c3.pull(c3_fpa
+0002ada0: 7468 2920 6173 2066 3a0a 2020 2020 2020  th) as f:.      
+0002adb0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002adc0: 7445 7175 616c 2827 3432 272c 2066 2e72  tEqual('42', f.r
+0002add0: 6561 6428 2929 0a0a 2020 2020 2020 2020  ead())..        
+0002ade0: 2320 7465 7374 2061 6c6c 206f 7468 6572  # test all other
+0002adf0: 2063 6f6e 7461 696e 6572 2066 696c 6520   container file 
+0002ae00: 6f70 730a 2020 2020 2020 2020 7769 7468  ops.        with
+0002ae10: 2063 312e 7075 6c6c 2863 315f 6670 6174   c1.pull(c1_fpat
+0002ae20: 6829 2061 7320 663a 0a20 2020 2020 2020  h) as f:.       
+0002ae30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002ae40: 4571 7561 6c28 2734 3227 2c20 662e 7265  Equal('42', f.re
+0002ae50: 6164 2829 290a 2020 2020 2020 2020 6669  ad()).        fi
+0002ae60: 6c65 7320 3d20 6331 2e6c 6973 745f 6669  les = c1.list_fi
+0002ae70: 6c65 7328 6331 5f66 7061 7468 290a 2020  les(c1_fpath).  
+0002ae80: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002ae90: 7445 7175 616c 285b 6331 5f66 7061 7468  tEqual([c1_fpath
+0002aea0: 5d2c 205b 6669 2e70 6174 6820 666f 7220  ], [fi.path for 
+0002aeb0: 6669 2069 6e20 6669 6c65 735d 290a 2020  fi in files]).  
+0002aec0: 2020 2020 2020 6331 2e72 656d 6f76 655f        c1.remove_
+0002aed0: 7061 7468 2863 315f 6670 6174 6829 0a20  path(c1_fpath). 
+0002aee0: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002aef0: 7274 4661 6c73 6528 6331 2e65 7869 7374  rtFalse(c1.exist
+0002af00: 7328 6331 5f66 7061 7468 2929 0a0a 2020  s(c1_fpath))..  
+0002af10: 2020 2020 2020 2320 7465 7374 2064 6574        # test det
+0002af20: 6163 6869 6e67 2073 746f 7261 6765 0a20  aching storage. 
+0002af30: 2020 2020 2020 2063 312e 7075 7368 2863         c1.push(c
+0002af40: 315f 6670 6174 682c 2027 3432 2729 0a20  1_fpath, '42'). 
+0002af50: 2020 2020 2020 2073 656c 662e 6173 7365         self.asse
+0002af60: 7274 5472 7565 2863 312e 6578 6973 7473  rtTrue(c1.exists
+0002af70: 2863 315f 6670 6174 6829 290a 2020 2020  (c1_fpath)).    
+0002af80: 2020 2020 7374 6f72 6531 5f69 6420 3d20      store1_id = 
+0002af90: 6861 726e 6573 732e 6d6f 6465 6c2e 7374  harness.model.st
+0002afa0: 6f72 6167 6573 5b27 7374 6f72 6531 275d  orages['store1']
+0002afb0: 5b30 5d2e 6675 6c6c 5f69 640a 2020 2020  [0].full_id.    
+0002afc0: 2020 2020 6861 726e 6573 732e 7265 6d6f      harness.remo
+0002afd0: 7665 5f73 746f 7261 6765 2873 746f 7265  ve_storage(store
+0002afe0: 315f 6964 290a 2020 2020 2020 2020 7365  1_id).        se
+0002aff0: 6c66 2e61 7373 6572 7446 616c 7365 2863  lf.assertFalse(c
+0002b000: 312e 6578 6973 7473 2863 315f 6670 6174  1.exists(c1_fpat
+0002b010: 6829 290a 0a20 2020 2064 6566 2074 6573  h))..    def tes
+0002b020: 745f 7075 7368 5f77 6974 685f 6f77 6e65  t_push_with_owne
+0002b030: 7273 6869 7028 7365 6c66 293a 0a20 2020  rship(self):.   
+0002b040: 2020 2020 2023 204e 6f74 653a 2054 6f20       # Note: To 
+0002b050: 7369 6d70 6c69 6679 2069 6d70 6c65 6d65  simplify impleme
+0002b060: 6e74 6174 696f 6e2c 206f 776e 6572 7368  ntation, ownersh
+0002b070: 6970 2069 7320 7369 6d70 6c79 2073 746f  ip is simply sto
+0002b080: 7265 6420 6173 2d69 7320 7769 7468 206e  red as-is with n
+0002b090: 6f20 7665 7269 6669 6361 7469 6f6e 2e0a  o verification..
+0002b0a0: 2020 2020 2020 2020 6461 7461 203d 2027          data = '
+0002b0b0: 6461 7461 270a 2020 2020 2020 2020 636c  data'.        cl
+0002b0c0: 6965 6e74 203d 2073 656c 662e 636c 6965  ient = self.clie
+0002b0d0: 6e74 0a20 2020 2020 2020 2063 6c69 656e  nt.        clien
+0002b0e0: 742e 7075 7368 2866 227b 7365 6c66 2e70  t.push(f"{self.p
+0002b0f0: 7265 6669 787d 2f66 696c 6522 2c20 6461  refix}/file", da
+0002b100: 7461 2c20 7573 6572 5f69 643d 312c 2075  ta, user_id=1, u
+0002b110: 7365 723d 2766 6f6f 272c 2067 726f 7570  ser='foo', group
+0002b120: 5f69 643d 332c 2067 726f 7570 3d27 6261  _id=3, group='ba
+0002b130: 7227 290a 2020 2020 2020 2020 6669 6c65  r').        file
+0002b140: 5f20 3d20 636c 6965 6e74 2e6c 6973 745f  _ = client.list_
+0002b150: 6669 6c65 7328 6622 7b73 656c 662e 7072  files(f"{self.pr
+0002b160: 6566 6978 7d2f 6669 6c65 2229 5b30 5d0a  efix}/file")[0].
+0002b170: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002b180: 6572 7445 7175 616c 2866 696c 655f 2e75  ertEqual(file_.u
+0002b190: 7365 725f 6964 2c20 3129 0a20 2020 2020  ser_id, 1).     
+0002b1a0: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0002b1b0: 7561 6c28 6669 6c65 5f2e 7573 6572 2c20  ual(file_.user, 
+0002b1c0: 2766 6f6f 2729 0a20 2020 2020 2020 2073  'foo').        s
+0002b1d0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0002b1e0: 6669 6c65 5f2e 6772 6f75 705f 6964 2c20  file_.group_id, 
+0002b1f0: 3329 0a20 2020 2020 2020 2073 656c 662e  3).        self.
+0002b200: 6173 7365 7274 4571 7561 6c28 6669 6c65  assertEqual(file
+0002b210: 5f2e 6772 6f75 702c 2027 6261 7227 290a  _.group, 'bar').
+0002b220: 0a20 2020 2064 6566 2074 6573 745f 6d61  .    def test_ma
+0002b230: 6b65 5f64 6972 5f77 6974 685f 6f77 6e65  ke_dir_with_owne
+0002b240: 7273 6869 7028 7365 6c66 293a 0a20 2020  rship(self):.   
+0002b250: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
+0002b260: 6c66 2e63 6c69 656e 740a 2020 2020 2020  lf.client.      
+0002b270: 2020 636c 6965 6e74 2e6d 616b 655f 6469    client.make_di
+0002b280: 7228 6622 7b73 656c 662e 7072 6566 6978  r(f"{self.prefix
+0002b290: 7d2f 6469 7231 222c 2075 7365 725f 6964  }/dir1", user_id
+0002b2a0: 3d31 2c20 7573 6572 3d22 666f 6f22 2c20  =1, user="foo", 
+0002b2b0: 6772 6f75 705f 6964 3d33 2c20 6772 6f75  group_id=3, grou
+0002b2c0: 703d 2262 6172 2229 0a20 2020 2020 2020  p="bar").       
+0002b2d0: 2064 6972 5f20 3d20 636c 6965 6e74 2e6c   dir_ = client.l
+0002b2e0: 6973 745f 6669 6c65 7328 6622 7b73 656c  ist_files(f"{sel
+0002b2f0: 662e 7072 6566 6978 7d2f 6469 7231 222c  f.prefix}/dir1",
+0002b300: 2069 7473 656c 663d 5472 7565 295b 305d   itself=True)[0]
+0002b310: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002b320: 7365 7274 4571 7561 6c28 6469 725f 2e75  sertEqual(dir_.u
+0002b330: 7365 725f 6964 2c20 3129 0a20 2020 2020  ser_id, 1).     
+0002b340: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0002b350: 7561 6c28 6469 725f 2e75 7365 722c 2022  ual(dir_.user, "
+0002b360: 666f 6f22 290a 2020 2020 2020 2020 7365  foo").        se
+0002b370: 6c66 2e61 7373 6572 7445 7175 616c 2864  lf.assertEqual(d
+0002b380: 6972 5f2e 6772 6f75 705f 6964 2c20 3329  ir_.group_id, 3)
+0002b390: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002b3a0: 7365 7274 4571 7561 6c28 6469 725f 2e67  sertEqual(dir_.g
+0002b3b0: 726f 7570 2c20 2262 6172 2229 0a0a 0a40  roup, "bar")...@
+0002b3c0: 756e 6974 7465 7374 2e73 6b69 7055 6e6c  unittest.skipUnl
+0002b3d0: 6573 7328 6f73 2e67 6574 656e 7628 2752  ess(os.getenv('R
+0002b3e0: 554e 5f52 4541 4c5f 5045 4242 4c45 5f54  UN_REAL_PEBBLE_T
+0002b3f0: 4553 5453 2729 2c20 2752 554e 5f52 4541  ESTS'), 'RUN_REA
+0002b400: 4c5f 5045 4242 4c45 5f54 4553 5453 206e  L_PEBBLE_TESTS n
+0002b410: 6f74 2073 6574 2729 0a63 6c61 7373 2054  ot set').class T
+0002b420: 6573 7450 6562 626c 6553 746f 7261 6765  estPebbleStorage
+0002b430: 4150 4973 5573 696e 6752 6561 6c50 6562  APIsUsingRealPeb
+0002b440: 626c 6528 756e 6974 7465 7374 2e54 6573  ble(unittest.Tes
+0002b450: 7443 6173 652c 205f 5065 6262 6c65 5374  tCase, _PebbleSt
+0002b460: 6f72 6167 6541 5049 7354 6573 744d 6978  orageAPIsTestMix
+0002b470: 696e 293a 0a20 2020 2064 6566 2073 6574  in):.    def set
+0002b480: 5570 2873 656c 6629 3a0a 2020 2020 2020  Up(self):.      
+0002b490: 2020 736f 636b 6574 5f70 6174 6820 3d20    socket_path = 
+0002b4a0: 6f73 2e67 6574 656e 7628 2750 4542 424c  os.getenv('PEBBL
+0002b4b0: 455f 534f 434b 4554 2729 0a20 2020 2020  E_SOCKET').     
+0002b4c0: 2020 2070 6562 626c 655f 6469 7220 3d20     pebble_dir = 
+0002b4d0: 6f73 2e67 6574 656e 7628 2750 4542 424c  os.getenv('PEBBL
+0002b4e0: 4527 290a 2020 2020 2020 2020 6966 206e  E').        if n
+0002b4f0: 6f74 2073 6f63 6b65 745f 7061 7468 2061  ot socket_path a
+0002b500: 6e64 2070 6562 626c 655f 6469 723a 0a20  nd pebble_dir:. 
+0002b510: 2020 2020 2020 2020 2020 2073 6f63 6b65             socke
+0002b520: 745f 7061 7468 203d 206f 732e 7061 7468  t_path = os.path
+0002b530: 2e6a 6f69 6e28 7065 6262 6c65 5f64 6972  .join(pebble_dir
+0002b540: 2c20 272e 7065 6262 6c65 2e73 6f63 6b65  , '.pebble.socke
+0002b550: 7427 290a 2020 2020 2020 2020 6173 7365  t').        asse
+0002b560: 7274 2073 6f63 6b65 745f 7061 7468 2061  rt socket_path a
+0002b570: 6e64 2070 6562 626c 655f 6469 722c 2027  nd pebble_dir, '
+0002b580: 5045 4242 4c45 206d 7573 7420 6265 2073  PEBBLE must be s
+0002b590: 6574 2069 6620 5255 4e5f 5245 414c 5f50  et if RUN_REAL_P
+0002b5a0: 4542 424c 455f 5445 5354 5320 7365 7427  EBBLE_TESTS set'
+0002b5b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e70  ..        self.p
+0002b5c0: 7265 6669 7820 3d20 7465 6d70 6669 6c65  refix = tempfile
+0002b5d0: 2e6d 6b64 7465 6d70 2864 6972 3d70 6562  .mkdtemp(dir=peb
+0002b5e0: 626c 655f 6469 7229 0a20 2020 2020 2020  ble_dir).       
+0002b5f0: 2073 656c 662e 636c 6965 6e74 203d 2070   self.client = p
+0002b600: 6562 626c 652e 436c 6965 6e74 2873 6f63  ebble.Client(soc
+0002b610: 6b65 745f 7061 7468 3d73 6f63 6b65 745f  ket_path=socket_
+0002b620: 7061 7468 290a 0a20 2020 2064 6566 2074  path)..    def t
+0002b630: 6561 7244 6f77 6e28 7365 6c66 293a 0a20  earDown(self):. 
+0002b640: 2020 2020 2020 2073 6875 7469 6c2e 726d         shutil.rm
+0002b650: 7472 6565 2873 656c 662e 7072 6566 6978  tree(self.prefix
+0002b660: 290a 0a20 2020 2023 2052 656d 6f76 6520  )..    # Remove 
+0002b670: 7468 6973 2065 6e74 6972 656c 7920 6f6e  this entirely on
+0002b680: 6365 2074 6865 2061 7373 6f63 6961 7465  ce the associate
+0002b690: 6420 6275 6720 6973 2066 6978 6564 3b20  d bug is fixed; 
+0002b6a0: 6974 206f 7665 7272 6964 6573 2074 6865  it overrides the
+0002b6b0: 206f 7269 6769 6e61 6c20 7465 7374 2069   original test i
+0002b6c0: 6e20 7468 650a 2020 2020 2320 7465 7374  n the.    # test
+0002b6d0: 206d 6978 696e 2063 6c61 7373 2e0a 2020   mixin class..  
+0002b6e0: 2020 4075 6e69 7474 6573 742e 736b 6970    @unittest.skip
+0002b6f0: 2827 7065 6e64 696e 6720 7265 736f 6c75  ('pending resolu
+0002b700: 7469 6f6e 206f 6620 6874 7470 733a 2f2f  tion of https://
+0002b710: 6769 7468 7562 2e63 6f6d 2f63 616e 6f6e  github.com/canon
+0002b720: 6963 616c 2f70 6562 626c 652f 6973 7375  ical/pebble/issu
+0002b730: 6573 2f38 3027 290a 2020 2020 6465 6620  es/80').    def 
+0002b740: 7465 7374 5f6d 616b 655f 6469 725f 7769  test_make_dir_wi
+0002b750: 7468 5f70 6572 6d69 7373 696f 6e5f 6d61  th_permission_ma
+0002b760: 736b 2873 656c 6629 3a0a 2020 2020 2020  sk(self):.      
+0002b770: 2020 7061 7373 0a0a 0a63 6c61 7373 2054    pass...class T
+0002b780: 6573 7453 6563 7265 7473 2875 6e69 7474  estSecrets(unitt
+0002b790: 6573 742e 5465 7374 4361 7365 293a 0a20  est.TestCase):. 
+0002b7a0: 2020 2064 6566 2074 6573 745f 6164 645f     def test_add_
+0002b7b0: 6d6f 6465 6c5f 7365 6372 6574 5f62 795f  model_secret_by_
+0002b7c0: 6170 705f 6e61 6d65 5f73 7472 2873 656c  app_name_str(sel
+0002b7d0: 6629 3a0a 2020 2020 2020 2020 6861 726e  f):.        harn
+0002b7e0: 6573 7320 3d20 6f70 732e 7465 7374 696e  ess = ops.testin
+0002b7f0: 672e 4861 726e 6573 7328 6f70 732e 4368  g.Harness(ops.Ch
+0002b800: 6172 6d42 6173 652c 206d 6574 613d 276e  armBase, meta='n
+0002b810: 616d 653a 2077 6562 6170 7027 290a 2020  ame: webapp').  
+0002b820: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+0002b830: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+0002b840: 6561 6e75 7029 0a20 2020 2020 2020 2072  eanup).        r
+0002b850: 656c 6174 696f 6e5f 6964 203d 2068 6172  elation_id = har
+0002b860: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+0002b870: 6e28 2764 6227 2c20 2764 6174 6162 6173  n('db', 'databas
+0002b880: 6527 290a 2020 2020 2020 2020 6861 726e  e').        harn
+0002b890: 6573 732e 6164 645f 7265 6c61 7469 6f6e  ess.add_relation
+0002b8a0: 5f75 6e69 7428 7265 6c61 7469 6f6e 5f69  _unit(relation_i
+0002b8b0: 642c 2027 6461 7461 6261 7365 2f30 2729  d, 'database/0')
+0002b8c0: 0a0a 2020 2020 2020 2020 7365 6372 6574  ..        secret
+0002b8d0: 5f69 6420 3d20 6861 726e 6573 732e 6164  _id = harness.ad
+0002b8e0: 645f 6d6f 6465 6c5f 7365 6372 6574 2827  d_model_secret('
+0002b8f0: 6461 7461 6261 7365 272c 207b 2770 6173  database', {'pas
+0002b900: 7377 6f72 6427 3a20 2768 756e 7465 7232  sword': 'hunter2
+0002b910: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
+0002b920: 6573 732e 6772 616e 745f 7365 6372 6574  ess.grant_secret
+0002b930: 2873 6563 7265 745f 6964 2c20 2777 6562  (secret_id, 'web
+0002b940: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
+0002b950: 6372 6574 203d 2068 6172 6e65 7373 2e6d  cret = harness.m
+0002b960: 6f64 656c 2e67 6574 5f73 6563 7265 7428  odel.get_secret(
+0002b970: 6964 3d73 6563 7265 745f 6964 290a 2020  id=secret_id).  
+0002b980: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002b990: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
+0002b9a0: 2c20 7365 6372 6574 5f69 6429 0a20 2020  , secret_id).   
+0002b9b0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002b9c0: 4571 7561 6c28 7365 6372 6574 2e67 6574  Equal(secret.get
+0002b9d0: 5f63 6f6e 7465 6e74 2829 2c20 7b27 7061  _content(), {'pa
+0002b9e0: 7373 776f 7264 273a 2027 6875 6e74 6572  ssword': 'hunter
+0002b9f0: 3227 7d29 0a0a 2020 2020 6465 6620 7465  2'})..    def te
+0002ba00: 7374 5f61 6464 5f6d 6f64 656c 5f73 6563  st_add_model_sec
+0002ba10: 7265 745f 6279 5f61 7070 5f69 6e73 7461  ret_by_app_insta
+0002ba20: 6e63 6528 7365 6c66 293a 0a20 2020 2020  nce(self):.     
+0002ba30: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0002ba40: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0002ba50: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0002ba60: 6d65 7461 3d27 6e61 6d65 3a20 7765 6261  meta='name: weba
+0002ba70: 7070 2729 0a20 2020 2020 2020 2073 656c  pp').        sel
+0002ba80: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0002ba90: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0002baa0: 2020 2020 2020 7265 6c61 7469 6f6e 5f69        relation_i
+0002bab0: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+0002bac0: 7265 6c61 7469 6f6e 2827 6462 272c 2027  relation('db', '
+0002bad0: 6461 7461 6261 7365 2729 0a20 2020 2020  database').     
+0002bae0: 2020 2068 6172 6e65 7373 2e61 6464 5f72     harness.add_r
+0002baf0: 656c 6174 696f 6e5f 756e 6974 2872 656c  elation_unit(rel
+0002bb00: 6174 696f 6e5f 6964 2c20 2764 6174 6162  ation_id, 'datab
+0002bb10: 6173 652f 3027 290a 0a20 2020 2020 2020  ase/0')..       
+0002bb20: 2061 7070 203d 2068 6172 6e65 7373 2e6d   app = harness.m
+0002bb30: 6f64 656c 2e67 6574 5f61 7070 2827 6461  odel.get_app('da
+0002bb40: 7461 6261 7365 2729 0a20 2020 2020 2020  tabase').       
+0002bb50: 2073 6563 7265 745f 6964 203d 2068 6172   secret_id = har
+0002bb60: 6e65 7373 2e61 6464 5f6d 6f64 656c 5f73  ness.add_model_s
+0002bb70: 6563 7265 7428 6170 702c 207b 2770 6173  ecret(app, {'pas
+0002bb80: 7377 6f72 6427 3a20 2768 756e 7465 7233  sword': 'hunter3
+0002bb90: 277d 290a 2020 2020 2020 2020 6861 726e  '}).        harn
+0002bba0: 6573 732e 6772 616e 745f 7365 6372 6574  ess.grant_secret
+0002bbb0: 2873 6563 7265 745f 6964 2c20 2777 6562  (secret_id, 'web
+0002bbc0: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
+0002bbd0: 6372 6574 203d 2068 6172 6e65 7373 2e6d  cret = harness.m
+0002bbe0: 6f64 656c 2e67 6574 5f73 6563 7265 7428  odel.get_secret(
+0002bbf0: 6964 3d73 6563 7265 745f 6964 290a 2020  id=secret_id).  
+0002bc00: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002bc10: 7445 7175 616c 2873 6563 7265 742e 6964  tEqual(secret.id
+0002bc20: 2c20 7365 6372 6574 5f69 6429 0a20 2020  , secret_id).   
+0002bc30: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002bc40: 4571 7561 6c28 7365 6372 6574 2e67 6574  Equal(secret.get
+0002bc50: 5f63 6f6e 7465 6e74 2829 2c20 7b27 7061  _content(), {'pa
+0002bc60: 7373 776f 7264 273a 2027 6875 6e74 6572  ssword': 'hunter
+0002bc70: 3327 7d29 0a0a 2020 2020 6465 6620 7465  3'})..    def te
+0002bc80: 7374 5f61 6464 5f6d 6f64 656c 5f73 6563  st_add_model_sec
+0002bc90: 7265 745f 6279 5f75 6e69 745f 696e 7374  ret_by_unit_inst
+0002bca0: 616e 6365 2873 656c 6629 3a0a 2020 2020  ance(self):.    
+0002bcb0: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0002bcc0: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0002bcd0: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0002bce0: 206d 6574 613d 276e 616d 653a 2077 6562   meta='name: web
+0002bcf0: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
+0002bd00: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+0002bd10: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+0002bd20: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+0002bd30: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+0002bd40: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+0002bd50: 2764 6174 6162 6173 6527 290a 2020 2020  'database').    
+0002bd60: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+0002bd70: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
+0002bd80: 6c61 7469 6f6e 5f69 642c 2027 6461 7461  lation_id, 'data
+0002bd90: 6261 7365 2f30 2729 0a0a 2020 2020 2020  base/0')..      
+0002bda0: 2020 756e 6974 203d 2068 6172 6e65 7373    unit = harness
+0002bdb0: 2e6d 6f64 656c 2e67 6574 5f75 6e69 7428  .model.get_unit(
+0002bdc0: 2764 6174 6162 6173 652f 3027 290a 2020  'database/0').  
+0002bdd0: 2020 2020 2020 7365 6372 6574 5f69 6420        secret_id 
+0002bde0: 3d20 6861 726e 6573 732e 6164 645f 6d6f  = harness.add_mo
+0002bdf0: 6465 6c5f 7365 6372 6574 2875 6e69 742c  del_secret(unit,
+0002be00: 207b 2770 6173 7377 6f72 6427 3a20 2768   {'password': 'h
+0002be10: 756e 7465 7234 277d 290a 2020 2020 2020  unter4'}).      
+0002be20: 2020 6861 726e 6573 732e 6772 616e 745f    harness.grant_
+0002be30: 7365 6372 6574 2873 6563 7265 745f 6964  secret(secret_id
+0002be40: 2c20 2777 6562 6170 7027 290a 2020 2020  , 'webapp').    
+0002be50: 2020 2020 7365 6372 6574 203d 2068 6172      secret = har
+0002be60: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f73  ness.model.get_s
+0002be70: 6563 7265 7428 6964 3d73 6563 7265 745f  ecret(id=secret_
+0002be80: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
+0002be90: 2e61 7373 6572 7445 7175 616c 2873 6563  .assertEqual(sec
+0002bea0: 7265 742e 6964 2c20 7365 6372 6574 5f69  ret.id, secret_i
+0002beb0: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+0002bec0: 6173 7365 7274 4571 7561 6c28 7365 6372  assertEqual(secr
+0002bed0: 6574 2e67 6574 5f63 6f6e 7465 6e74 2829  et.get_content()
+0002bee0: 2c20 7b27 7061 7373 776f 7264 273a 2027  , {'password': '
+0002bef0: 6875 6e74 6572 3427 7d29 0a0a 2020 2020  hunter4'})..    
+0002bf00: 6465 6620 7465 7374 5f61 6464 5f6d 6f64  def test_add_mod
+0002bf10: 656c 5f73 6563 7265 745f 696e 7661 6c69  el_secret_invali
+0002bf20: 645f 636f 6e74 656e 7428 7365 6c66 293a  d_content(self):
+0002bf30: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0002bf40: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+0002bf50: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+0002bf60: 4261 7365 2c20 6d65 7461 3d27 6e61 6d65  Base, meta='name
+0002bf70: 3a20 7765 6261 7070 2729 0a20 2020 2020  : webapp').     
+0002bf80: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0002bf90: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+0002bfa0: 7570 290a 0a20 2020 2020 2020 2077 6974  up)..        wit
+0002bfb0: 6820 7365 6c66 2e61 7373 6572 7452 6169  h self.assertRai
+0002bfc0: 7365 7328 5661 6c75 6545 7272 6f72 293a  ses(ValueError):
+0002bfd0: 0a20 2020 2020 2020 2020 2020 2068 6172  .            har
+0002bfe0: 6e65 7373 2e61 6464 5f6d 6f64 656c 5f73  ness.add_model_s
+0002bff0: 6563 7265 7428 2764 6174 6162 6173 6527  ecret('database'
+0002c000: 2c20 7b27 7827 3a20 2779 277d 2920 2023  , {'x': 'y'})  #
+0002c010: 206b 6579 2074 6f6f 2073 686f 7274 0a0a   key too short..
+0002c020: 2020 2020 6465 6620 7465 7374 5f73 6574      def test_set
+0002c030: 5f73 6563 7265 745f 636f 6e74 656e 7428  _secret_content(
+0002c040: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0002c050: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0002c060: 7469 6e67 2e48 6172 6e65 7373 2845 7665  ting.Harness(Eve
+0002c070: 6e74 5265 636f 7264 6572 2c20 6d65 7461  ntRecorder, meta
+0002c080: 3d27 6e61 6d65 3a20 7765 6261 7070 2729  ='name: webapp')
+0002c090: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0002c0a0: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0002c0b0: 2e63 6c65 616e 7570 290a 2020 2020 2020  .cleanup).      
+0002c0c0: 2020 7265 6c61 7469 6f6e 5f69 6420 3d20    relation_id = 
+0002c0d0: 6861 726e 6573 732e 6164 645f 7265 6c61  harness.add_rela
+0002c0e0: 7469 6f6e 2827 6462 272c 2027 6461 7461  tion('db', 'data
+0002c0f0: 6261 7365 2729 0a20 2020 2020 2020 2068  base').        h
+0002c100: 6172 6e65 7373 2e61 6464 5f72 656c 6174  arness.add_relat
+0002c110: 696f 6e5f 756e 6974 2872 656c 6174 696f  ion_unit(relatio
+0002c120: 6e5f 6964 2c20 2764 6174 6162 6173 652f  n_id, 'database/
+0002c130: 3027 290a 0a20 2020 2020 2020 2073 6563  0')..        sec
+0002c140: 7265 745f 6964 203d 2068 6172 6e65 7373  ret_id = harness
+0002c150: 2e61 6464 5f6d 6f64 656c 5f73 6563 7265  .add_model_secre
+0002c160: 7428 2764 6174 6162 6173 6527 2c20 7b27  t('database', {'
+0002c170: 666f 6f27 3a20 2731 277d 290a 2020 2020  foo': '1'}).    
+0002c180: 2020 2020 6861 726e 6573 732e 6772 616e      harness.gran
+0002c190: 745f 7365 6372 6574 2873 6563 7265 745f  t_secret(secret_
+0002c1a0: 6964 2c20 2777 6562 6170 7027 290a 2020  id, 'webapp').  
+0002c1b0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+0002c1c0: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
+0002c1d0: 726e 6573 732e 6672 616d 6577 6f72 6b2e  rness.framework.
+0002c1e0: 6f62 7365 7276 6528 6861 726e 6573 732e  observe(harness.
+0002c1f0: 6368 6172 6d2e 6f6e 2e73 6563 7265 745f  charm.on.secret_
+0002c200: 6368 616e 6765 642c 2068 6172 6e65 7373  changed, harness
+0002c210: 2e63 6861 726d 2e72 6563 6f72 645f 6576  .charm.record_ev
+0002c220: 656e 7429 0a20 2020 2020 2020 2068 6172  ent).        har
+0002c230: 6e65 7373 2e73 6574 5f73 6563 7265 745f  ness.set_secret_
+0002c240: 636f 6e74 656e 7428 7365 6372 6574 5f69  content(secret_i
+0002c250: 642c 207b 2766 6f6f 273a 2027 3227 7d29  d, {'foo': '2'})
+0002c260: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0002c270: 7373 6572 7445 7175 616c 286c 656e 2868  ssertEqual(len(h
+0002c280: 6172 6e65 7373 2e63 6861 726d 2e65 7665  arness.charm.eve
+0002c290: 6e74 7329 2c20 3129 0a20 2020 2020 2020  nts), 1).       
+0002c2a0: 2065 7665 6e74 203d 2068 6172 6e65 7373   event = harness
+0002c2b0: 2e63 6861 726d 2e65 7665 6e74 735b 305d  .charm.events[0]
+0002c2c0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002c2d0: 7365 7274 4973 496e 7374 616e 6365 2865  sertIsInstance(e
+0002c2e0: 7665 6e74 2c20 6f70 732e 5365 6372 6574  vent, ops.Secret
+0002c2f0: 4368 616e 6765 6445 7665 6e74 290a 2020  ChangedEvent).  
+0002c300: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002c310: 7445 7175 616c 2865 7665 6e74 2e73 6563  tEqual(event.sec
+0002c320: 7265 742e 6765 745f 636f 6e74 656e 7428  ret.get_content(
+0002c330: 292c 207b 2766 6f6f 273a 2027 3127 7d29  ), {'foo': '1'})
+0002c340: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002c350: 7365 7274 4571 7561 6c28 6576 656e 742e  sertEqual(event.
+0002c360: 7365 6372 6574 2e67 6574 5f63 6f6e 7465  secret.get_conte
+0002c370: 6e74 2872 6566 7265 7368 3d54 7275 6529  nt(refresh=True)
+0002c380: 2c20 7b27 666f 6f27 3a20 2732 277d 290a  , {'foo': '2'}).
+0002c390: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002c3a0: 6572 7445 7175 616c 2865 7665 6e74 2e73  ertEqual(event.s
+0002c3b0: 6563 7265 742e 6765 745f 636f 6e74 656e  ecret.get_conten
+0002c3c0: 7428 292c 207b 2766 6f6f 273a 2027 3227  t(), {'foo': '2'
+0002c3d0: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
+0002c3e0: 2e61 7373 6572 7445 7175 616c 2868 6172  .assertEqual(har
+0002c3f0: 6e65 7373 2e67 6574 5f73 6563 7265 745f  ness.get_secret_
+0002c400: 7265 7669 7369 6f6e 7328 7365 6372 6574  revisions(secret
+0002c410: 5f69 6429 2c20 5b31 2c20 325d 290a 0a20  _id), [1, 2]).. 
+0002c420: 2020 2064 6566 2074 6573 745f 7365 745f     def test_set_
+0002c430: 7365 6372 6574 5f63 6f6e 7465 6e74 5f77  secret_content_w
+0002c440: 726f 6e67 5f6f 776e 6572 2873 656c 6629  rong_owner(self)
+0002c450: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0002c460: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0002c470: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+0002c480: 6d42 6173 652c 206d 6574 613d 276e 616d  mBase, meta='nam
+0002c490: 653a 2077 6562 6170 7027 290a 2020 2020  e: webapp').    
+0002c4a0: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0002c4b0: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0002c4c0: 6e75 7029 0a0a 2020 2020 2020 2020 7365  nup)..        se
+0002c4d0: 6372 6574 203d 2068 6172 6e65 7373 2e6d  cret = harness.m
+0002c4e0: 6f64 656c 2e61 7070 2e61 6464 5f73 6563  odel.app.add_sec
+0002c4f0: 7265 7428 7b27 666f 6f27 3a20 2762 6172  ret({'foo': 'bar
+0002c500: 277d 290a 2020 2020 2020 2020 7769 7468  '}).        with
+0002c510: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0002c520: 6573 2852 756e 7469 6d65 4572 726f 7229  es(RuntimeError)
+0002c530: 3a0a 2020 2020 2020 2020 2020 2020 6861  :.            ha
+0002c540: 726e 6573 732e 7365 745f 7365 6372 6574  rness.set_secret
+0002c550: 5f63 6f6e 7465 6e74 2873 6563 7265 742e  _content(secret.
+0002c560: 6964 2c20 7b27 6261 7227 3a20 2766 6f6f  id, {'bar': 'foo
+0002c570: 277d 290a 0a20 2020 2064 6566 2074 6573  '})..    def tes
+0002c580: 745f 7365 745f 7365 6372 6574 5f63 6f6e  t_set_secret_con
+0002c590: 7465 6e74 5f69 6e76 616c 6964 5f73 6563  tent_invalid_sec
+0002c5a0: 7265 745f 6964 2873 656c 6629 3a0a 2020  ret_id(self):.  
+0002c5b0: 2020 2020 2020 6861 726e 6573 7320 3d20        harness = 
+0002c5c0: 6f70 732e 7465 7374 696e 672e 4861 726e  ops.testing.Harn
+0002c5d0: 6573 7328 6f70 732e 4368 6172 6d42 6173  ess(ops.CharmBas
+0002c5e0: 652c 206d 6574 613d 276e 616d 653a 2077  e, meta='name: w
+0002c5f0: 6562 6170 7027 290a 2020 2020 2020 2020  ebapp').        
+0002c600: 7365 6c66 2e61 6464 436c 6561 6e75 7028  self.addCleanup(
+0002c610: 6861 726e 6573 732e 636c 6561 6e75 7029  harness.cleanup)
+0002c620: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
+0002c630: 656c 662e 6173 7365 7274 5261 6973 6573  elf.assertRaises
+0002c640: 2852 756e 7469 6d65 4572 726f 7229 3a0a  (RuntimeError):.
+0002c650: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+0002c660: 6573 732e 7365 745f 7365 6372 6574 5f63  ess.set_secret_c
+0002c670: 6f6e 7465 6e74 2827 6173 6466 272c 207b  ontent('asdf', {
+0002c680: 2766 6f6f 273a 2027 6261 7227 7d29 0a0a  'foo': 'bar'})..
+0002c690: 2020 2020 6465 6620 7465 7374 5f73 6574      def test_set
+0002c6a0: 5f73 6563 7265 745f 636f 6e74 656e 745f  _secret_content_
+0002c6b0: 696e 7661 6c69 645f 636f 6e74 656e 7428  invalid_content(
+0002c6c0: 7365 6c66 293a 0a20 2020 2020 2020 2068  self):.        h
+0002c6d0: 6172 6e65 7373 203d 206f 7073 2e74 6573  arness = ops.tes
+0002c6e0: 7469 6e67 2e48 6172 6e65 7373 286f 7073  ting.Harness(ops
+0002c6f0: 2e43 6861 726d 4261 7365 2c20 6d65 7461  .CharmBase, meta
+0002c700: 3d27 6e61 6d65 3a20 7765 6261 7070 2729  ='name: webapp')
+0002c710: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
+0002c720: 6443 6c65 616e 7570 2868 6172 6e65 7373  dCleanup(harness
+0002c730: 2e63 6c65 616e 7570 290a 0a20 2020 2020  .cleanup)..     
+0002c740: 2020 2073 6563 7265 745f 6964 203d 2068     secret_id = h
+0002c750: 6172 6e65 7373 2e61 6464 5f6d 6f64 656c  arness.add_model
+0002c760: 5f73 6563 7265 7428 2764 6174 6162 6173  _secret('databas
+0002c770: 6527 2c20 7b27 666f 6f27 3a20 2762 6172  e', {'foo': 'bar
+0002c780: 277d 290a 2020 2020 2020 2020 7769 7468  '}).        with
+0002c790: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0002c7a0: 6573 2856 616c 7565 4572 726f 7229 3a0a  es(ValueError):.
+0002c7b0: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+0002c7c0: 6573 732e 7365 745f 7365 6372 6574 5f63  ess.set_secret_c
+0002c7d0: 6f6e 7465 6e74 2873 6563 7265 745f 6964  ontent(secret_id
+0002c7e0: 2c20 7b27 7827 3a20 2779 277d 290a 0a20  , {'x': 'y'}).. 
+0002c7f0: 2020 2064 6566 2074 6573 745f 6772 616e     def test_gran
+0002c800: 745f 7365 6372 6574 5f61 6e64 5f72 6576  t_secret_and_rev
+0002c810: 6f6b 655f 7365 6372 6574 2873 656c 6629  oke_secret(self)
+0002c820: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0002c830: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0002c840: 4861 726e 6573 7328 6f70 732e 4368 6172  Harness(ops.Char
+0002c850: 6d42 6173 652c 206d 6574 613d 276e 616d  mBase, meta='nam
+0002c860: 653a 2077 6562 6170 7027 290a 2020 2020  e: webapp').    
+0002c870: 2020 2020 7365 6c66 2e61 6464 436c 6561      self.addClea
+0002c880: 6e75 7028 6861 726e 6573 732e 636c 6561  nup(harness.clea
+0002c890: 6e75 7029 0a20 2020 2020 2020 2072 656c  nup).        rel
+0002c8a0: 6174 696f 6e5f 6964 203d 2068 6172 6e65  ation_id = harne
+0002c8b0: 7373 2e61 6464 5f72 656c 6174 696f 6e28  ss.add_relation(
+0002c8c0: 2764 6227 2c20 2764 6174 6162 6173 6527  'db', 'database'
+0002c8d0: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0002c8e0: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+0002c8f0: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
+0002c900: 2027 6461 7461 6261 7365 2f30 2729 0a0a   'database/0')..
+0002c910: 2020 2020 2020 2020 7365 6372 6574 5f69          secret_i
+0002c920: 6420 3d20 6861 726e 6573 732e 6164 645f  d = harness.add_
+0002c930: 6d6f 6465 6c5f 7365 6372 6574 2827 6461  model_secret('da
+0002c940: 7461 6261 7365 272c 207b 2770 6173 7377  tabase', {'passw
+0002c950: 6f72 6427 3a20 2768 756e 7465 7232 277d  ord': 'hunter2'}
+0002c960: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0002c970: 732e 6772 616e 745f 7365 6372 6574 2873  s.grant_secret(s
+0002c980: 6563 7265 745f 6964 2c20 2777 6562 6170  ecret_id, 'webap
+0002c990: 7027 290a 2020 2020 2020 2020 7365 6372  p').        secr
+0002c9a0: 6574 203d 2068 6172 6e65 7373 2e6d 6f64  et = harness.mod
+0002c9b0: 656c 2e67 6574 5f73 6563 7265 7428 6964  el.get_secret(id
+0002c9c0: 3d73 6563 7265 745f 6964 290a 2020 2020  =secret_id).    
+0002c9d0: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002c9e0: 7175 616c 2873 6563 7265 742e 6964 2c20  qual(secret.id, 
+0002c9f0: 7365 6372 6574 5f69 6429 0a20 2020 2020  secret_id).     
+0002ca00: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0002ca10: 7561 6c28 7365 6372 6574 2e67 6574 5f63  ual(secret.get_c
+0002ca20: 6f6e 7465 6e74 2829 2c20 7b27 7061 7373  ontent(), {'pass
+0002ca30: 776f 7264 273a 2027 6875 6e74 6572 3227  word': 'hunter2'
+0002ca40: 7d29 0a0a 2020 2020 2020 2020 6861 726e  })..        harn
+0002ca50: 6573 732e 7265 766f 6b65 5f73 6563 7265  ess.revoke_secre
+0002ca60: 7428 7365 6372 6574 5f69 642c 2027 7765  t(secret_id, 'we
+0002ca70: 6261 7070 2729 0a20 2020 2020 2020 2077  bapp').        w
+0002ca80: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0002ca90: 6169 7365 7328 6f70 732e 5365 6372 6574  aises(ops.Secret
+0002caa0: 4e6f 7446 6f75 6e64 4572 726f 7229 3a0a  NotFoundError):.
+0002cab0: 2020 2020 2020 2020 2020 2020 6861 726e              harn
+0002cac0: 6573 732e 6d6f 6465 6c2e 6765 745f 7365  ess.model.get_se
+0002cad0: 6372 6574 2869 643d 7365 6372 6574 5f69  cret(id=secret_i
+0002cae0: 6429 0a0a 2020 2020 6465 6620 7465 7374  d)..    def test
+0002caf0: 5f67 7261 6e74 5f73 6563 7265 745f 7772  _grant_secret_wr
+0002cb00: 6f6e 675f 6170 7028 7365 6c66 293a 0a20  ong_app(self):. 
+0002cb10: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+0002cb20: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+0002cb30: 6e65 7373 286f 7073 2e43 6861 726d 4261  ness(ops.CharmBa
+0002cb40: 7365 2c20 6d65 7461 3d27 6e61 6d65 3a20  se, meta='name: 
+0002cb50: 7765 6261 7070 2729 0a20 2020 2020 2020  webapp').       
+0002cb60: 2073 656c 662e 6164 6443 6c65 616e 7570   self.addCleanup
+0002cb70: 2868 6172 6e65 7373 2e63 6c65 616e 7570  (harness.cleanup
+0002cb80: 290a 2020 2020 2020 2020 7265 6c61 7469  ).        relati
+0002cb90: 6f6e 5f69 6420 3d20 6861 726e 6573 732e  on_id = harness.
+0002cba0: 6164 645f 7265 6c61 7469 6f6e 2827 6462  add_relation('db
+0002cbb0: 272c 2027 6461 7461 6261 7365 2729 0a20  ', 'database'). 
+0002cbc0: 2020 2020 2020 2068 6172 6e65 7373 2e61         harness.a
+0002cbd0: 6464 5f72 656c 6174 696f 6e5f 756e 6974  dd_relation_unit
+0002cbe0: 2872 656c 6174 696f 6e5f 6964 2c20 2764  (relation_id, 'd
+0002cbf0: 6174 6162 6173 652f 3027 290a 0a20 2020  atabase/0')..   
+0002cc00: 2020 2020 2073 6563 7265 745f 6964 203d       secret_id =
+0002cc10: 2068 6172 6e65 7373 2e61 6464 5f6d 6f64   harness.add_mod
+0002cc20: 656c 5f73 6563 7265 7428 2764 6174 6162  el_secret('datab
+0002cc30: 6173 6527 2c20 7b27 7061 7373 776f 7264  ase', {'password
+0002cc40: 273a 2027 6875 6e74 6572 3227 7d29 0a20  ': 'hunter2'}). 
+0002cc50: 2020 2020 2020 2068 6172 6e65 7373 2e67         harness.g
+0002cc60: 7261 6e74 5f73 6563 7265 7428 7365 6372  rant_secret(secr
+0002cc70: 6574 5f69 642c 2027 6f74 6865 7261 7070  et_id, 'otherapp
+0002cc80: 2729 0a20 2020 2020 2020 2077 6974 6820  ').        with 
+0002cc90: 7365 6c66 2e61 7373 6572 7452 6169 7365  self.assertRaise
+0002cca0: 7328 6f70 732e 5365 6372 6574 4e6f 7446  s(ops.SecretNotF
+0002ccb0: 6f75 6e64 4572 726f 7229 3a0a 2020 2020  oundError):.    
+0002ccc0: 2020 2020 2020 2020 6861 726e 6573 732e          harness.
+0002ccd0: 6d6f 6465 6c2e 6765 745f 7365 6372 6574  model.get_secret
+0002cce0: 2869 643d 7365 6372 6574 5f69 6429 0a0a  (id=secret_id)..
+0002ccf0: 2020 2020 6465 6620 7465 7374 5f67 7261      def test_gra
+0002cd00: 6e74 5f73 6563 7265 745f 7772 6f6e 675f  nt_secret_wrong_
+0002cd10: 756e 6974 2873 656c 6629 3a0a 2020 2020  unit(self):.    
+0002cd20: 2020 2020 6861 726e 6573 7320 3d20 6f70      harness = op
+0002cd30: 732e 7465 7374 696e 672e 4861 726e 6573  s.testing.Harnes
+0002cd40: 7328 6f70 732e 4368 6172 6d42 6173 652c  s(ops.CharmBase,
+0002cd50: 206d 6574 613d 276e 616d 653a 2077 6562   meta='name: web
+0002cd60: 6170 7027 290a 2020 2020 2020 2020 7365  app').        se
+0002cd70: 6c66 2e61 6464 436c 6561 6e75 7028 6861  lf.addCleanup(ha
+0002cd80: 726e 6573 732e 636c 6561 6e75 7029 0a20  rness.cleanup). 
+0002cd90: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+0002cda0: 6964 203d 2068 6172 6e65 7373 2e61 6464  id = harness.add
+0002cdb0: 5f72 656c 6174 696f 6e28 2764 6227 2c20  _relation('db', 
+0002cdc0: 2764 6174 6162 6173 6527 290a 2020 2020  'database').    
+0002cdd0: 2020 2020 6861 726e 6573 732e 6164 645f      harness.add_
+0002cde0: 7265 6c61 7469 6f6e 5f75 6e69 7428 7265  relation_unit(re
+0002cdf0: 6c61 7469 6f6e 5f69 642c 2027 6461 7461  lation_id, 'data
+0002ce00: 6261 7365 2f30 2729 0a0a 2020 2020 2020  base/0')..      
+0002ce10: 2020 7365 6372 6574 5f69 6420 3d20 6861    secret_id = ha
+0002ce20: 726e 6573 732e 6164 645f 6d6f 6465 6c5f  rness.add_model_
+0002ce30: 7365 6372 6574 2827 6461 7461 6261 7365  secret('database
+0002ce40: 272c 207b 2770 6173 7377 6f72 6427 3a20  ', {'password': 
+0002ce50: 2768 756e 7465 7232 277d 290a 2020 2020  'hunter2'}).    
+0002ce60: 2020 2020 6861 726e 6573 732e 6772 616e      harness.gran
+0002ce70: 745f 7365 6372 6574 2873 6563 7265 745f  t_secret(secret_
+0002ce80: 6964 2c20 2777 6562 6170 702f 3127 2920  id, 'webapp/1') 
+0002ce90: 2023 2073 686f 756c 6420 6265 2077 6562   # should be web
+0002cea0: 6170 702f 300a 2020 2020 2020 2020 7769  app/0.        wi
+0002ceb0: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0002cec0: 6973 6573 286f 7073 2e53 6563 7265 744e  ises(ops.SecretN
+0002ced0: 6f74 466f 756e 6445 7272 6f72 293a 0a20  otFoundError):. 
+0002cee0: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+0002cef0: 7373 2e6d 6f64 656c 2e67 6574 5f73 6563  ss.model.get_sec
+0002cf00: 7265 7428 6964 3d73 6563 7265 745f 6964  ret(id=secret_id
+0002cf10: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0002cf20: 6772 616e 745f 7365 6372 6574 5f6e 6f5f  grant_secret_no_
+0002cf30: 7265 6c61 7469 6f6e 2873 656c 6629 3a0a  relation(self):.
+0002cf40: 2020 2020 2020 2020 6861 726e 6573 7320          harness 
+0002cf50: 3d20 6f70 732e 7465 7374 696e 672e 4861  = ops.testing.Ha
+0002cf60: 726e 6573 7328 6f70 732e 4368 6172 6d42  rness(ops.CharmB
+0002cf70: 6173 652c 206d 6574 613d 276e 616d 653a  ase, meta='name:
+0002cf80: 2077 6562 6170 7027 290a 2020 2020 2020   webapp').      
+0002cf90: 2020 7365 6c66 2e61 6464 436c 6561 6e75    self.addCleanu
+0002cfa0: 7028 6861 726e 6573 732e 636c 6561 6e75  p(harness.cleanu
+0002cfb0: 7029 0a0a 2020 2020 2020 2020 7365 6372  p)..        secr
+0002cfc0: 6574 5f69 6420 3d20 6861 726e 6573 732e  et_id = harness.
+0002cfd0: 6164 645f 6d6f 6465 6c5f 7365 6372 6574  add_model_secret
+0002cfe0: 2827 6461 7461 6261 7365 272c 207b 2770  ('database', {'p
+0002cff0: 6173 7377 6f72 6427 3a20 2768 756e 7465  assword': 'hunte
+0002d000: 7232 277d 290a 2020 2020 2020 2020 7769  r2'}).        wi
+0002d010: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0002d020: 6973 6573 2852 756e 7469 6d65 4572 726f  ises(RuntimeErro
+0002d030: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0002d040: 6861 726e 6573 732e 6772 616e 745f 7365  harness.grant_se
+0002d050: 6372 6574 2873 6563 7265 745f 6964 2c20  cret(secret_id, 
+0002d060: 2777 6562 6170 7027 290a 0a20 2020 2064  'webapp')..    d
+0002d070: 6566 2074 6573 745f 6765 745f 7365 6372  ef test_get_secr
+0002d080: 6574 5f67 7261 6e74 7328 7365 6c66 293a  et_grants(self):
+0002d090: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0002d0a0: 203d 206f 7073 2e74 6573 7469 6e67 2e48   = ops.testing.H
+0002d0b0: 6172 6e65 7373 286f 7073 2e43 6861 726d  arness(ops.Charm
+0002d0c0: 4261 7365 2c20 6d65 7461 3d27 6e61 6d65  Base, meta='name
+0002d0d0: 3a20 6461 7461 6261 7365 2729 0a20 2020  : database').   
+0002d0e0: 2020 2020 2073 656c 662e 6164 6443 6c65       self.addCle
+0002d0f0: 616e 7570 2868 6172 6e65 7373 2e63 6c65  anup(harness.cle
+0002d100: 616e 7570 290a 0a20 2020 2020 2020 2072  anup)..        r
+0002d110: 656c 6174 696f 6e5f 6964 203d 2068 6172  elation_id = har
+0002d120: 6e65 7373 2e61 6464 5f72 656c 6174 696f  ness.add_relatio
+0002d130: 6e28 2764 6227 2c20 2777 6562 6170 7027  n('db', 'webapp'
+0002d140: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0002d150: 732e 6164 645f 7265 6c61 7469 6f6e 5f75  s.add_relation_u
+0002d160: 6e69 7428 7265 6c61 7469 6f6e 5f69 642c  nit(relation_id,
+0002d170: 2027 7765 6261 7070 2f30 2729 0a0a 2020   'webapp/0')..  
+0002d180: 2020 2020 2020 7365 6372 6574 203d 2068        secret = h
+0002d190: 6172 6e65 7373 2e6d 6f64 656c 2e61 7070  arness.model.app
+0002d1a0: 2e61 6464 5f73 6563 7265 7428 7b27 666f  .add_secret({'fo
+0002d1b0: 6f27 3a20 2778 277d 290a 2020 2020 2020  o': 'x'}).      
+0002d1c0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002d1d0: 616c 2868 6172 6e65 7373 2e67 6574 5f73  al(harness.get_s
+0002d1e0: 6563 7265 745f 6772 616e 7473 2873 6563  ecret_grants(sec
+0002d1f0: 7265 742e 6964 2c20 7265 6c61 7469 6f6e  ret.id, relation
+0002d200: 5f69 6429 2c20 7365 7428 2929 0a20 2020  _id), set()).   
+0002d210: 2020 2020 2073 6563 7265 742e 6772 616e       secret.gran
+0002d220: 7428 6861 726e 6573 732e 6d6f 6465 6c2e  t(harness.model.
+0002d230: 6765 745f 7265 6c61 7469 6f6e 2827 6462  get_relation('db
+0002d240: 2729 290a 2020 2020 2020 2020 7365 6c66  ')).        self
+0002d250: 2e61 7373 6572 7445 7175 616c 2868 6172  .assertEqual(har
+0002d260: 6e65 7373 2e67 6574 5f73 6563 7265 745f  ness.get_secret_
+0002d270: 6772 616e 7473 2873 6563 7265 742e 6964  grants(secret.id
+0002d280: 2c20 7265 6c61 7469 6f6e 5f69 6429 2c20  , relation_id), 
+0002d290: 7b27 7765 6261 7070 277d 290a 0a20 2020  {'webapp'})..   
+0002d2a0: 2020 2020 2073 6563 7265 742e 7265 766f       secret.revo
+0002d2b0: 6b65 2868 6172 6e65 7373 2e6d 6f64 656c  ke(harness.model
+0002d2c0: 2e67 6574 5f72 656c 6174 696f 6e28 2764  .get_relation('d
+0002d2d0: 6227 2929 0a20 2020 2020 2020 2073 656c  b')).        sel
+0002d2e0: 662e 6173 7365 7274 4571 7561 6c28 6861  f.assertEqual(ha
+0002d2f0: 726e 6573 732e 6765 745f 7365 6372 6574  rness.get_secret
+0002d300: 5f67 7261 6e74 7328 7365 6372 6574 2e69  _grants(secret.i
+0002d310: 642c 2072 656c 6174 696f 6e5f 6964 292c  d, relation_id),
+0002d320: 2073 6574 2829 290a 2020 2020 2020 2020   set()).        
+0002d330: 7365 6372 6574 2e67 7261 6e74 2868 6172  secret.grant(har
+0002d340: 6e65 7373 2e6d 6f64 656c 2e67 6574 5f72  ness.model.get_r
+0002d350: 656c 6174 696f 6e28 2764 6227 292c 2075  elation('db'), u
+0002d360: 6e69 743d 6861 726e 6573 732e 6d6f 6465  nit=harness.mode
+0002d370: 6c2e 6765 745f 756e 6974 2827 7765 6261  l.get_unit('weba
+0002d380: 7070 2f30 2729 290a 2020 2020 2020 2020  pp/0')).        
+0002d390: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002d3a0: 2868 6172 6e65 7373 2e67 6574 5f73 6563  (harness.get_sec
+0002d3b0: 7265 745f 6772 616e 7473 2873 6563 7265  ret_grants(secre
+0002d3c0: 742e 6964 2c20 7265 6c61 7469 6f6e 5f69  t.id, relation_i
+0002d3d0: 6429 2c20 7b27 7765 6261 7070 2f30 277d  d), {'webapp/0'}
+0002d3e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0002d3f0: 7472 6967 6765 725f 7365 6372 6574 5f72  trigger_secret_r
+0002d400: 6f74 6174 696f 6e28 7365 6c66 293a 0a20  otation(self):. 
+0002d410: 2020 2020 2020 2068 6172 6e65 7373 203d         harness =
+0002d420: 206f 7073 2e74 6573 7469 6e67 2e48 6172   ops.testing.Har
+0002d430: 6e65 7373 2845 7665 6e74 5265 636f 7264  ness(EventRecord
+0002d440: 6572 2c20 6d65 7461 3d27 6e61 6d65 3a20  er, meta='name: 
+0002d450: 6461 7461 6261 7365 2729 0a20 2020 2020  database').     
+0002d460: 2020 2073 656c 662e 6164 6443 6c65 616e     self.addClean
+0002d470: 7570 2868 6172 6e65 7373 2e63 6c65 616e  up(harness.clean
+0002d480: 7570 290a 0a20 2020 2020 2020 2073 6563  up)..        sec
+0002d490: 7265 7420 3d20 6861 726e 6573 732e 6d6f  ret = harness.mo
+0002d4a0: 6465 6c2e 6170 702e 6164 645f 7365 6372  del.app.add_secr
+0002d4b0: 6574 287b 2766 6f6f 273a 2027 7827 7d2c  et({'foo': 'x'},
+0002d4c0: 206c 6162 656c 3d27 6c62 6c27 290a 2020   label='lbl').  
+0002d4d0: 2020 2020 2020 6861 726e 6573 732e 6265        harness.be
+0002d4e0: 6769 6e28 290a 2020 2020 2020 2020 6861  gin().        ha
+0002d4f0: 726e 6573 732e 6672 616d 6577 6f72 6b2e  rness.framework.
+0002d500: 6f62 7365 7276 6528 6861 726e 6573 732e  observe(harness.
+0002d510: 6368 6172 6d2e 6f6e 2e73 6563 7265 745f  charm.on.secret_
+0002d520: 726f 7461 7465 2c20 6861 726e 6573 732e  rotate, harness.
+0002d530: 6368 6172 6d2e 7265 636f 7264 5f65 7665  charm.record_eve
+0002d540: 6e74 290a 2020 2020 2020 2020 6861 726e  nt).        harn
+0002d550: 6573 732e 7472 6967 6765 725f 7365 6372  ess.trigger_secr
+0002d560: 6574 5f72 6f74 6174 696f 6e28 7365 6372  et_rotation(secr
+0002d570: 6574 2e69 6429 0a20 2020 2020 2020 2068  et.id).        h
+0002d580: 6172 6e65 7373 2e74 7269 6767 6572 5f73  arness.trigger_s
+0002d590: 6563 7265 745f 726f 7461 7469 6f6e 2873  ecret_rotation(s
+0002d5a0: 6563 7265 742e 6964 2c20 6c61 6265 6c3d  ecret.id, label=
+0002d5b0: 276f 7665 7272 6964 6527 290a 0a20 2020  'override')..   
+0002d5c0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002d5d0: 4571 7561 6c28 6c65 6e28 6861 726e 6573  Equal(len(harnes
+0002d5e0: 732e 6368 6172 6d2e 6576 656e 7473 292c  s.charm.events),
+0002d5f0: 2032 290a 2020 2020 2020 2020 6576 656e   2).        even
+0002d600: 7420 3d20 6861 726e 6573 732e 6368 6172  t = harness.char
+0002d610: 6d2e 6576 656e 7473 5b30 5d0a 2020 2020  m.events[0].    
+0002d620: 2020 2020 7365 6c66 2e61 7373 6572 7449      self.assertI
+0002d630: 7349 6e73 7461 6e63 6528 6576 656e 742c  sInstance(event,
+0002d640: 206f 7073 2e53 6563 7265 7452 6f74 6174   ops.SecretRotat
+0002d650: 6545 7665 6e74 290a 2020 2020 2020 2020  eEvent).        
+0002d660: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+0002d670: 2865 7665 6e74 2e73 6563 7265 742e 6c61  (event.secret.la
+0002d680: 6265 6c2c 2027 6c62 6c27 290a 2020 2020  bel, 'lbl').    
+0002d690: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002d6a0: 7175 616c 2865 7665 6e74 2e73 6563 7265  qual(event.secre
+0002d6b0: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
+0002d6c0: 207b 2766 6f6f 273a 2027 7827 7d29 0a20   {'foo': 'x'}). 
+0002d6d0: 2020 2020 2020 2065 7665 6e74 203d 2068         event = h
+0002d6e0: 6172 6e65 7373 2e63 6861 726d 2e65 7665  arness.charm.eve
+0002d6f0: 6e74 735b 315d 0a20 2020 2020 2020 2073  nts[1].        s
+0002d700: 656c 662e 6173 7365 7274 4973 496e 7374  elf.assertIsInst
+0002d710: 616e 6365 2865 7665 6e74 2c20 6f70 732e  ance(event, ops.
+0002d720: 5365 6372 6574 526f 7461 7465 4576 656e  SecretRotateEven
+0002d730: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0002d740: 6173 7365 7274 4571 7561 6c28 6576 656e  assertEqual(even
+0002d750: 742e 7365 6372 6574 2e6c 6162 656c 2c20  t.secret.label, 
+0002d760: 276f 7665 7272 6964 6527 290a 2020 2020  'override').    
+0002d770: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
+0002d780: 7175 616c 2865 7665 6e74 2e73 6563 7265  qual(event.secre
+0002d790: 742e 6765 745f 636f 6e74 656e 7428 292c  t.get_content(),
+0002d7a0: 207b 2766 6f6f 273a 2027 7827 7d29 0a0a   {'foo': 'x'})..
+0002d7b0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0002d7c0: 662e 6173 7365 7274 5261 6973 6573 2852  f.assertRaises(R
+0002d7d0: 756e 7469 6d65 4572 726f 7229 3a0a 2020  untimeError):.  
+0002d7e0: 2020 2020 2020 2020 2020 6861 726e 6573            harnes
+0002d7f0: 732e 7472 6967 6765 725f 7365 6372 6574  s.trigger_secret
+0002d800: 5f72 6f74 6174 696f 6e28 276e 6f73 6563  _rotation('nosec
+0002d810: 7265 7427 290a 0a20 2020 2064 6566 2074  ret')..    def t
+0002d820: 6573 745f 7472 6967 6765 725f 7365 6372  est_trigger_secr
+0002d830: 6574 5f72 656d 6f76 616c 2873 656c 6629  et_removal(self)
+0002d840: 3a0a 2020 2020 2020 2020 6861 726e 6573  :.        harnes
+0002d850: 7320 3d20 6f70 732e 7465 7374 696e 672e  s = ops.testing.
+0002d860: 4861 726e 6573 7328 4576 656e 7452 6563  Harness(EventRec
+0002d870: 6f72 6465 722c 206d 6574 613d 276e 616d  order, meta='nam
+0002d880: 653a 2064 6174 6162 6173 6527 290a 2020  e: database').  
+0002d890: 2020 2020 2020 7365 6c66 2e61 6464 436c        self.addCl
+0002d8a0: 6561 6e75 7028 6861 726e 6573 732e 636c  eanup(harness.cl
+0002d8b0: 6561 6e75 7029 0a0a 2020 2020 2020 2020  eanup)..        
+0002d8c0: 7365 6372 6574 203d 2068 6172 6e65 7373  secret = harness
+0002d8d0: 2e6d 6f64 656c 2e61 7070 2e61 6464 5f73  .model.app.add_s
+0002d8e0: 6563 7265 7428 7b27 666f 6f27 3a20 2778  ecret({'foo': 'x
+0002d8f0: 277d 2c20 6c61 6265 6c3d 276c 626c 2729  '}, label='lbl')
+0002d900: 0a20 2020 2020 2020 2068 6172 6e65 7373  .        harness
+0002d910: 2e62 6567 696e 2829 0a20 2020 2020 2020  .begin().       
+0002d920: 2068 6172 6e65 7373 2e66 7261 6d65 776f   harness.framewo
+0002d930: 726b 2e6f 6273 6572 7665 2868 6172 6e65  rk.observe(harne
+0002d940: 7373 2e63 6861 726d 2e6f 6e2e 7365 6372  ss.charm.on.secr
+0002d950: 6574 5f72 656d 6f76 652c 2068 6172 6e65  et_remove, harne
+0002d960: 7373 2e63 6861 726d 2e72 6563 6f72 645f  ss.charm.record_
+0002d970: 6576 656e 7429 0a20 2020 2020 2020 2068  event).        h
+0002d980: 6172 6e65 7373 2e74 7269 6767 6572 5f73  arness.trigger_s
+0002d990: 6563 7265 745f 7265 6d6f 7661 6c28 7365  ecret_removal(se
+0002d9a0: 6372 6574 2e69 642c 2031 290a 2020 2020  cret.id, 1).    
+0002d9b0: 2020 2020 6861 726e 6573 732e 7472 6967      harness.trig
+0002d9c0: 6765 725f 7365 6372 6574 5f72 656d 6f76  ger_secret_remov
+0002d9d0: 616c 2873 6563 7265 742e 6964 2c20 3432  al(secret.id, 42
+0002d9e0: 2c20 6c61 6265 6c3d 276f 7665 7272 6964  , label='overrid
+0002d9f0: 6527 290a 0a20 2020 2020 2020 2073 656c  e')..        sel
+0002da00: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+0002da10: 6e28 6861 726e 6573 732e 6368 6172 6d2e  n(harness.charm.
+0002da20: 6576 656e 7473 292c 2032 290a 2020 2020  events), 2).    
+0002da30: 2020 2020 6576 656e 7420 3d20 6861 726e      event = harn
+0002da40: 6573 732e 6368 6172 6d2e 6576 656e 7473  ess.charm.events
+0002da50: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
+0002da60: 2e61 7373 6572 7449 7349 6e73 7461 6e63  .assertIsInstanc
+0002da70: 6528 6576 656e 742c 206f 7073 2e53 6563  e(event, ops.Sec
+0002da80: 7265 7452 656d 6f76 6545 7665 6e74 290a  retRemoveEvent).
+0002da90: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002daa0: 6572 7445 7175 616c 2865 7665 6e74 2e73  ertEqual(event.s
+0002dab0: 6563 7265 742e 6c61 6265 6c2c 2027 6c62  ecret.label, 'lb
+0002dac0: 6c27 290a 2020 2020 2020 2020 7365 6c66  l').        self
+0002dad0: 2e61 7373 6572 7445 7175 616c 2865 7665  .assertEqual(eve
+0002dae0: 6e74 2e72 6576 6973 696f 6e2c 2031 290a  nt.revision, 1).
+0002daf0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002db00: 6572 7445 7175 616c 2865 7665 6e74 2e73  ertEqual(event.s
+0002db10: 6563 7265 742e 6765 745f 636f 6e74 656e  ecret.get_conten
+0002db20: 7428 292c 207b 2766 6f6f 273a 2027 7827  t(), {'foo': 'x'
+0002db30: 7d29 0a20 2020 2020 2020 2065 7665 6e74  }).        event
+0002db40: 203d 2068 6172 6e65 7373 2e63 6861 726d   = harness.charm
+0002db50: 2e65 7665 6e74 735b 315d 0a20 2020 2020  .events[1].     
+0002db60: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0002db70: 496e 7374 616e 6365 2865 7665 6e74 2c20  Instance(event, 
+0002db80: 6f70 732e 5365 6372 6574 5265 6d6f 7665  ops.SecretRemove
+0002db90: 4576 656e 7429 0a20 2020 2020 2020 2073  Event).        s
+0002dba0: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
+0002dbb0: 6576 656e 742e 7365 6372 6574 2e6c 6162  event.secret.lab
+0002dbc0: 656c 2c20 276f 7665 7272 6964 6527 290a  el, 'override').
+0002dbd0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+0002dbe0: 6572 7445 7175 616c 2865 7665 6e74 2e72  ertEqual(event.r
+0002dbf0: 6576 6973 696f 6e2c 2034 3229 0a20 2020  evision, 42).   
+0002dc00: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002dc10: 4571 7561 6c28 6576 656e 742e 7365 6372  Equal(event.secr
+0002dc20: 6574 2e67 6574 5f63 6f6e 7465 6e74 2829  et.get_content()
+0002dc30: 2c20 7b27 666f 6f27 3a20 2778 277d 290a  , {'foo': 'x'}).
+0002dc40: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+0002dc50: 6c66 2e61 7373 6572 7452 6169 7365 7328  lf.assertRaises(
+0002dc60: 5275 6e74 696d 6545 7272 6f72 293a 0a20  RuntimeError):. 
+0002dc70: 2020 2020 2020 2020 2020 2068 6172 6e65             harne
+0002dc80: 7373 2e74 7269 6767 6572 5f73 6563 7265  ss.trigger_secre
+0002dc90: 745f 7265 6d6f 7661 6c28 276e 6f73 6563  t_removal('nosec
+0002dca0: 7265 7427 2c20 3129 0a0a 2020 2020 6465  ret', 1)..    de
+0002dcb0: 6620 7465 7374 5f74 7269 6767 6572 5f73  f test_trigger_s
+0002dcc0: 6563 7265 745f 6578 7069 7261 7469 6f6e  ecret_expiration
+0002dcd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0002dce0: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0002dcf0: 7374 696e 672e 4861 726e 6573 7328 4576  sting.Harness(Ev
+0002dd00: 656e 7452 6563 6f72 6465 722c 206d 6574  entRecorder, met
+0002dd10: 613d 276e 616d 653a 2064 6174 6162 6173  a='name: databas
+0002dd20: 6527 290a 2020 2020 2020 2020 7365 6c66  e').        self
+0002dd30: 2e61 6464 436c 6561 6e75 7028 6861 726e  .addCleanup(harn
+0002dd40: 6573 732e 636c 6561 6e75 7029 0a0a 2020  ess.cleanup)..  
+0002dd50: 2020 2020 2020 7365 6372 6574 203d 2068        secret = h
+0002dd60: 6172 6e65 7373 2e6d 6f64 656c 2e61 7070  arness.model.app
+0002dd70: 2e61 6464 5f73 6563 7265 7428 7b27 666f  .add_secret({'fo
+0002dd80: 6f27 3a20 2778 277d 2c20 6c61 6265 6c3d  o': 'x'}, label=
+0002dd90: 276c 626c 2729 0a20 2020 2020 2020 2068  'lbl').        h
+0002dda0: 6172 6e65 7373 2e62 6567 696e 2829 0a20  arness.begin(). 
+0002ddb0: 2020 2020 2020 2068 6172 6e65 7373 2e66         harness.f
+0002ddc0: 7261 6d65 776f 726b 2e6f 6273 6572 7665  ramework.observe
+0002ddd0: 2868 6172 6e65 7373 2e63 6861 726d 2e6f  (harness.charm.o
+0002dde0: 6e2e 7365 6372 6574 5f72 656d 6f76 652c  n.secret_remove,
+0002ddf0: 2068 6172 6e65 7373 2e63 6861 726d 2e72   harness.charm.r
+0002de00: 6563 6f72 645f 6576 656e 7429 0a20 2020  ecord_event).   
+0002de10: 2020 2020 2068 6172 6e65 7373 2e74 7269       harness.tri
+0002de20: 6767 6572 5f73 6563 7265 745f 7265 6d6f  gger_secret_remo
+0002de30: 7661 6c28 7365 6372 6574 2e69 642c 2031  val(secret.id, 1
+0002de40: 290a 2020 2020 2020 2020 6861 726e 6573  ).        harnes
+0002de50: 732e 7472 6967 6765 725f 7365 6372 6574  s.trigger_secret
+0002de60: 5f72 656d 6f76 616c 2873 6563 7265 742e  _removal(secret.
+0002de70: 6964 2c20 3432 2c20 6c61 6265 6c3d 276f  id, 42, label='o
+0002de80: 7665 7272 6964 6527 290a 0a20 2020 2020  verride')..     
+0002de90: 2020 2073 656c 662e 6173 7365 7274 4571     self.assertEq
+0002dea0: 7561 6c28 6c65 6e28 6861 726e 6573 732e  ual(len(harness.
+0002deb0: 6368 6172 6d2e 6576 656e 7473 292c 2032  charm.events), 2
+0002dec0: 290a 2020 2020 2020 2020 6576 656e 7420  ).        event 
+0002ded0: 3d20 6861 726e 6573 732e 6368 6172 6d2e  = harness.charm.
+0002dee0: 6576 656e 7473 5b30 5d0a 2020 2020 2020  events[0].      
+0002def0: 2020 7365 6c66 2e61 7373 6572 7449 7349    self.assertIsI
+0002df00: 6e73 7461 6e63 6528 6576 656e 742c 206f  nstance(event, o
+0002df10: 7073 2e53 6563 7265 7452 656d 6f76 6545  ps.SecretRemoveE
+0002df20: 7665 6e74 290a 2020 2020 2020 2020 7365  vent).        se
+0002df30: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
+0002df40: 7665 6e74 2e73 6563 7265 742e 6c61 6265  vent.secret.labe
+0002df50: 6c2c 2027 6c62 6c27 290a 2020 2020 2020  l, 'lbl').      
+0002df60: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002df70: 616c 2865 7665 6e74 2e72 6576 6973 696f  al(event.revisio
+0002df80: 6e2c 2031 290a 2020 2020 2020 2020 7365  n, 1).        se
+0002df90: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
+0002dfa0: 7665 6e74 2e73 6563 7265 742e 6765 745f  vent.secret.get_
+0002dfb0: 636f 6e74 656e 7428 292c 207b 2766 6f6f  content(), {'foo
+0002dfc0: 273a 2027 7827 7d29 0a20 2020 2020 2020  ': 'x'}).       
+0002dfd0: 2065 7665 6e74 203d 2068 6172 6e65 7373   event = harness
+0002dfe0: 2e63 6861 726d 2e65 7665 6e74 735b 315d  .charm.events[1]
+0002dff0: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002e000: 7365 7274 4973 496e 7374 616e 6365 2865  sertIsInstance(e
+0002e010: 7665 6e74 2c20 6f70 732e 5365 6372 6574  vent, ops.Secret
+0002e020: 5265 6d6f 7665 4576 656e 7429 0a20 2020  RemoveEvent).   
+0002e030: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002e040: 4571 7561 6c28 6576 656e 742e 7365 6372  Equal(event.secr
+0002e050: 6574 2e6c 6162 656c 2c20 276f 7665 7272  et.label, 'overr
+0002e060: 6964 6527 290a 2020 2020 2020 2020 7365  ide').        se
+0002e070: 6c66 2e61 7373 6572 7445 7175 616c 2865  lf.assertEqual(e
+0002e080: 7665 6e74 2e72 6576 6973 696f 6e2c 2034  vent.revision, 4
+0002e090: 3229 0a20 2020 2020 2020 2073 656c 662e  2).        self.
+0002e0a0: 6173 7365 7274 4571 7561 6c28 6576 656e  assertEqual(even
+0002e0b0: 742e 7365 6372 6574 2e67 6574 5f63 6f6e  t.secret.get_con
+0002e0c0: 7465 6e74 2829 2c20 7b27 666f 6f27 3a20  tent(), {'foo': 
+0002e0d0: 2778 277d 290a 0a20 2020 2020 2020 2077  'x'})..        w
+0002e0e0: 6974 6820 7365 6c66 2e61 7373 6572 7452  ith self.assertR
+0002e0f0: 6169 7365 7328 5275 6e74 696d 6545 7272  aises(RuntimeErr
+0002e100: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0002e110: 2068 6172 6e65 7373 2e74 7269 6767 6572   harness.trigger
+0002e120: 5f73 6563 7265 745f 7265 6d6f 7661 6c28  _secret_removal(
+0002e130: 276e 6f73 6563 7265 7427 2c20 3129 0a0a  'nosecret', 1)..
+0002e140: 0a63 6c61 7373 2045 7665 6e74 5265 636f  .class EventReco
+0002e150: 7264 6572 286f 7073 2e43 6861 726d 4261  rder(ops.CharmBa
+0002e160: 7365 293a 0a20 2020 2064 6566 205f 5f69  se):.    def __i
+0002e170: 6e69 745f 5f28 7365 6c66 2c20 6672 616d  nit__(self, fram
+0002e180: 6577 6f72 6b29 3a0a 2020 2020 2020 2020  ework):.        
+0002e190: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+0002e1a0: 2866 7261 6d65 776f 726b 290a 2020 2020  (framework).    
+0002e1b0: 2020 2020 7365 6c66 2e65 7665 6e74 7320      self.events 
+0002e1c0: 3d20 5b5d 0a0a 2020 2020 6465 6620 7265  = []..    def re
+0002e1d0: 636f 7264 5f65 7665 6e74 2873 656c 662c  cord_event(self,
+0002e1e0: 2065 7665 6e74 293a 0a20 2020 2020 2020   event):.       
+0002e1f0: 2073 656c 662e 6576 656e 7473 2e61 7070   self.events.app
+0002e200: 656e 6428 6576 656e 7429 0a0a 0a63 6c61  end(event)...cla
+0002e210: 7373 2054 6573 7450 6f72 7473 2875 6e69  ss TestPorts(uni
+0002e220: 7474 6573 742e 5465 7374 4361 7365 293a  ttest.TestCase):
+0002e230: 0a20 2020 2064 6566 2074 6573 745f 706f  .    def test_po
+0002e240: 7274 7328 7365 6c66 293a 0a20 2020 2020  rts(self):.     
+0002e250: 2020 2068 6172 6e65 7373 203d 206f 7073     harness = ops
+0002e260: 2e74 6573 7469 6e67 2e48 6172 6e65 7373  .testing.Harness
+0002e270: 286f 7073 2e43 6861 726d 4261 7365 2c20  (ops.CharmBase, 
+0002e280: 6d65 7461 3d27 6e61 6d65 3a20 7765 6261  meta='name: weba
+0002e290: 7070 2729 0a20 2020 2020 2020 2073 656c  pp').        sel
+0002e2a0: 662e 6164 6443 6c65 616e 7570 2868 6172  f.addCleanup(har
+0002e2b0: 6e65 7373 2e63 6c65 616e 7570 290a 2020  ness.cleanup).  
+0002e2c0: 2020 2020 2020 756e 6974 203d 2068 6172        unit = har
+0002e2d0: 6e65 7373 2e6d 6f64 656c 2e75 6e69 740a  ness.model.unit.
+0002e2e0: 0a20 2020 2020 2020 2075 6e69 742e 6f70  .        unit.op
+0002e2f0: 656e 5f70 6f72 7428 2774 6370 272c 2038  en_port('tcp', 8
+0002e300: 3038 3029 0a20 2020 2020 2020 2075 6e69  080).        uni
+0002e310: 742e 6f70 656e 5f70 6f72 7428 2775 6470  t.open_port('udp
+0002e320: 272c 2034 3030 3029 0a20 2020 2020 2020  ', 4000).       
+0002e330: 2075 6e69 742e 6f70 656e 5f70 6f72 7428   unit.open_port(
+0002e340: 2769 636d 7027 290a 0a20 2020 2020 2020  'icmp')..       
+0002e350: 2070 6f72 7473 5f73 6574 203d 2075 6e69   ports_set = uni
+0002e360: 742e 6f70 656e 6564 5f70 6f72 7473 2829  t.opened_ports()
+0002e370: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002e380: 7365 7274 4973 496e 7374 616e 6365 2870  sertIsInstance(p
+0002e390: 6f72 7473 5f73 6574 2c20 7365 7429 0a20  orts_set, set). 
+0002e3a0: 2020 2020 2020 2070 6f72 7473 203d 2073         ports = s
+0002e3b0: 6f72 7465 6428 706f 7274 735f 7365 742c  orted(ports_set,
+0002e3c0: 206b 6579 3d6c 616d 6264 6120 703a 2028   key=lambda p: (
+0002e3d0: 702e 7072 6f74 6f63 6f6c 2c20 702e 706f  p.protocol, p.po
+0002e3e0: 7274 2929 0a20 2020 2020 2020 2073 656c  rt)).        sel
+0002e3f0: 662e 6173 7365 7274 4571 7561 6c28 6c65  f.assertEqual(le
+0002e400: 6e28 706f 7274 7329 2c20 3329 0a20 2020  n(ports), 3).   
+0002e410: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002e420: 4973 496e 7374 616e 6365 2870 6f72 7473  IsInstance(ports
+0002e430: 5b30 5d2c 206f 7073 2e4f 7065 6e65 6450  [0], ops.OpenedP
+0002e440: 6f72 7429 0a20 2020 2020 2020 2073 656c  ort).        sel
+0002e450: 662e 6173 7365 7274 4571 7561 6c28 706f  f.assertEqual(po
+0002e460: 7274 735b 305d 2e70 726f 746f 636f 6c2c  rts[0].protocol,
+0002e470: 2027 6963 6d70 2729 0a20 2020 2020 2020   'icmp').       
+0002e480: 2073 656c 662e 6173 7365 7274 4973 4e6f   self.assertIsNo
+0002e490: 6e65 2870 6f72 7473 5b30 5d2e 706f 7274  ne(ports[0].port
+0002e4a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002e4b0: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+0002e4c0: 706f 7274 735b 315d 2c20 6f70 732e 4f70  ports[1], ops.Op
+0002e4d0: 656e 6564 506f 7274 290a 2020 2020 2020  enedPort).      
+0002e4e0: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002e4f0: 616c 2870 6f72 7473 5b31 5d2e 7072 6f74  al(ports[1].prot
+0002e500: 6f63 6f6c 2c20 2774 6370 2729 0a20 2020  ocol, 'tcp').   
+0002e510: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
+0002e520: 4571 7561 6c28 706f 7274 735b 315d 2e70  Equal(ports[1].p
+0002e530: 6f72 742c 2038 3038 3029 0a20 2020 2020  ort, 8080).     
+0002e540: 2020 2073 656c 662e 6173 7365 7274 4973     self.assertIs
+0002e550: 496e 7374 616e 6365 2870 6f72 7473 5b32  Instance(ports[2
+0002e560: 5d2c 206f 7073 2e4f 7065 6e65 6450 6f72  ], ops.OpenedPor
+0002e570: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0002e580: 6173 7365 7274 4571 7561 6c28 706f 7274  assertEqual(port
+0002e590: 735b 325d 2e70 726f 746f 636f 6c2c 2027  s[2].protocol, '
+0002e5a0: 7564 7027 290a 2020 2020 2020 2020 7365  udp').        se
+0002e5b0: 6c66 2e61 7373 6572 7445 7175 616c 2870  lf.assertEqual(p
+0002e5c0: 6f72 7473 5b32 5d2e 706f 7274 2c20 3430  orts[2].port, 40
+0002e5d0: 3030 290a 0a20 2020 2020 2020 2075 6e69  00)..        uni
+0002e5e0: 742e 636c 6f73 655f 706f 7274 2827 7463  t.close_port('tc
+0002e5f0: 7027 2c20 3830 3830 290a 2020 2020 2020  p', 8080).      
+0002e600: 2020 756e 6974 2e63 6c6f 7365 5f70 6f72    unit.close_por
+0002e610: 7428 2774 6370 272c 2038 3038 3029 2020  t('tcp', 8080)  
+0002e620: 2320 636c 6f73 696e 6720 7361 6d65 2070  # closing same p
+0002e630: 6f72 7420 6167 6169 6e20 6861 7320 6e6f  ort again has no
+0002e640: 2065 6666 6563 740a 2020 2020 2020 2020   effect.        
+0002e650: 756e 6974 2e63 6c6f 7365 5f70 6f72 7428  unit.close_port(
+0002e660: 2775 6470 272c 2034 3030 3029 0a0a 2020  'udp', 4000)..  
+0002e670: 2020 2020 2020 706f 7274 735f 7365 7420        ports_set 
+0002e680: 3d20 756e 6974 2e6f 7065 6e65 645f 706f  = unit.opened_po
+0002e690: 7274 7328 290a 2020 2020 2020 2020 7365  rts().        se
+0002e6a0: 6c66 2e61 7373 6572 7449 7349 6e73 7461  lf.assertIsInsta
+0002e6b0: 6e63 6528 706f 7274 735f 7365 742c 2073  nce(ports_set, s
+0002e6c0: 6574 290a 2020 2020 2020 2020 706f 7274  et).        port
+0002e6d0: 7320 3d20 736f 7274 6564 2870 6f72 7473  s = sorted(ports
+0002e6e0: 5f73 6574 2c20 6b65 793d 6c61 6d62 6461  _set, key=lambda
+0002e6f0: 2070 3a20 2870 2e70 726f 746f 636f 6c2c   p: (p.protocol,
+0002e700: 2070 2e70 6f72 7429 290a 2020 2020 2020   p.port)).      
+0002e710: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002e720: 616c 286c 656e 2870 6f72 7473 292c 2031  al(len(ports), 1
+0002e730: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002e740: 7373 6572 7449 7349 6e73 7461 6e63 6528  ssertIsInstance(
+0002e750: 706f 7274 735b 305d 2c20 6f70 732e 4f70  ports[0], ops.Op
+0002e760: 656e 6564 506f 7274 290a 2020 2020 2020  enedPort).      
+0002e770: 2020 7365 6c66 2e61 7373 6572 7445 7175    self.assertEqu
+0002e780: 616c 2870 6f72 7473 5b30 5d2e 7072 6f74  al(ports[0].prot
+0002e790: 6f63 6f6c 2c20 2769 636d 7027 290a 2020  ocol, 'icmp').  
+0002e7a0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+0002e7b0: 7449 734e 6f6e 6528 706f 7274 735b 305d  tIsNone(ports[0]
+0002e7c0: 2e70 6f72 7429 0a0a 2020 2020 2020 2020  .port)..        
+0002e7d0: 756e 6974 2e63 6c6f 7365 5f70 6f72 7428  unit.close_port(
+0002e7e0: 2769 636d 7027 290a 0a20 2020 2020 2020  'icmp')..       
+0002e7f0: 2070 6f72 7473 5f73 6574 203d 2075 6e69   ports_set = uni
+0002e800: 742e 6f70 656e 6564 5f70 6f72 7473 2829  t.opened_ports()
+0002e810: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
+0002e820: 7365 7274 4571 7561 6c28 706f 7274 735f  sertEqual(ports_
+0002e830: 7365 742c 2073 6574 2829 290a 0a20 2020  set, set())..   
+0002e840: 2064 6566 2074 6573 745f 6572 726f 7273   def test_errors
+0002e850: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0002e860: 6861 726e 6573 7320 3d20 6f70 732e 7465  harness = ops.te
+0002e870: 7374 696e 672e 4861 726e 6573 7328 6f70  sting.Harness(op
+0002e880: 732e 4368 6172 6d42 6173 652c 206d 6574  s.CharmBase, met
+0002e890: 613d 276e 616d 653a 2077 6562 6170 7027  a='name: webapp'
+0002e8a0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+0002e8b0: 6464 436c 6561 6e75 7028 6861 726e 6573  ddCleanup(harnes
+0002e8c0: 732e 636c 6561 6e75 7029 0a20 2020 2020  s.cleanup).     
+0002e8d0: 2020 2075 6e69 7420 3d20 6861 726e 6573     unit = harnes
+0002e8e0: 732e 6d6f 6465 6c2e 756e 6974 0a0a 2020  s.model.unit..  
+0002e8f0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0002e900: 6173 7365 7274 5261 6973 6573 286f 7073  assertRaises(ops
+0002e910: 2e4d 6f64 656c 4572 726f 7229 3a0a 2020  .ModelError):.  
+0002e920: 2020 2020 2020 2020 2020 756e 6974 2e6f            unit.o
+0002e930: 7065 6e5f 706f 7274 2827 6963 6d70 272c  pen_port('icmp',
+0002e940: 2038 3038 3029 2020 2320 6963 6d70 2063   8080)  # icmp c
+0002e950: 616e 6e6f 7420 6861 7665 2070 6f72 740a  annot have port.
+0002e960: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0002e970: 662e 6173 7365 7274 5261 6973 6573 286f  f.assertRaises(o
+0002e980: 7073 2e4d 6f64 656c 4572 726f 7229 3a0a  ps.ModelError):.
+0002e990: 2020 2020 2020 2020 2020 2020 756e 6974              unit
+0002e9a0: 2e6f 7065 6e5f 706f 7274 2827 6674 7027  .open_port('ftp'
+0002e9b0: 2c20 3830 3830 2920 2023 2069 6e76 616c  , 8080)  # inval
+0002e9c0: 6964 2070 726f 746f 636f 6c0a 2020 2020  id protocol.    
+0002e9d0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0002e9e0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+0002e9f0: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+0002ea00: 2020 2020 2020 2020 756e 6974 2e6f 7065          unit.ope
+0002ea10: 6e5f 706f 7274 2827 7463 7027 2920 2023  n_port('tcp')  #
+0002ea20: 2074 6370 206d 7573 7420 6861 7665 2070   tcp must have p
+0002ea30: 6f72 740a 2020 2020 2020 2020 7769 7468  ort.        with
+0002ea40: 2073 656c 662e 6173 7365 7274 5261 6973   self.assertRais
+0002ea50: 6573 286f 7073 2e4d 6f64 656c 4572 726f  es(ops.ModelErro
+0002ea60: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0002ea70: 756e 6974 2e6f 7065 6e5f 706f 7274 2827  unit.open_port('
+0002ea80: 7564 7027 2920 2023 2075 6470 206d 7573  udp')  # udp mus
+0002ea90: 7420 6861 7665 2070 6f72 740a 2020 2020  t have port.    
+0002eaa0: 2020 2020 7769 7468 2073 656c 662e 6173      with self.as
+0002eab0: 7365 7274 5261 6973 6573 286f 7073 2e4d  sertRaises(ops.M
+0002eac0: 6f64 656c 4572 726f 7229 3a0a 2020 2020  odelError):.    
+0002ead0: 2020 2020 2020 2020 756e 6974 2e6f 7065          unit.ope
+0002eae0: 6e5f 706f 7274 2827 7463 7027 2c20 3029  n_port('tcp', 0)
+0002eaf0: 2020 2320 706f 7274 206f 7574 206f 6620    # port out of 
+0002eb00: 7261 6e67 650a 2020 2020 2020 2020 7769  range.        wi
+0002eb10: 7468 2073 656c 662e 6173 7365 7274 5261  th self.assertRa
+0002eb20: 6973 6573 286f 7073 2e4d 6f64 656c 4572  ises(ops.ModelEr
+0002eb30: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0002eb40: 2020 756e 6974 2e6f 7065 6e5f 706f 7274    unit.open_port
+0002eb50: 2827 7463 7027 2c20 3635 3533 3629 2020  ('tcp', 65536)  
+0002eb60: 2320 706f 7274 206f 7574 206f 6620 7261  # port out of ra
+0002eb70: 6e67 650a                                nge.
```

